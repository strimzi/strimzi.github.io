<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Deploying and Managing Strimzi</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css">
</head>
<body id="deploying-book_str" class="book toc2 toc-left">
<div id="header">
<h1>Deploying and Managing Strimzi</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#deploy-intro_str">1. Deployment overview</a>
<ul class="sectlevel2">
<li><a href="#assembly-custom-resources-str">1.1. Strimzi custom resources</a>
<ul class="sectlevel3">
<li><a href="#con-custom-resources-example-str">1.1.1. Strimzi custom resource example</a></li>
</ul>
</li>
<li><a href="#assembly-operators-str">1.2. Strimzi operators</a>
<ul class="sectlevel3">
<li><a href="#con-operators-namespaces-str">1.2.1. Watching Strimzi resources in Kubernetes namespaces</a></li>
<li><a href="#ref-operator-cluster-rbac-resources-str">1.2.2. Managing RBAC resources</a></li>
</ul>
</li>
<li><a href="#con-kafka-bridge-concepts-str">1.3. Using the Kafka Bridge to connect with a Kafka cluster</a></li>
<li><a href="#assembly-fips-support-str">1.4. Seamless FIPS support</a></li>
<li><a href="#document-conventions-str">1.5. Document Conventions</a></li>
<li><a href="#additional_resources">1.6. Additional resources</a></li>
</ul>
</li>
<li><a href="#con-strimzi-installation-methods_str">2. Strimzi installation methods</a></li>
<li><a href="#deploy-options_str">3. What is deployed with Strimzi</a>
<ul class="sectlevel2">
<li><a href="#deploy-options-order-str">3.1. Order of deployment</a></li>
</ul>
</li>
<li><a href="#deploy-tasks-prereqs_str">4. Preparing for your Strimzi deployment</a>
<ul class="sectlevel2">
<li><a href="#deploy-prereqs-str">4.1. Deployment prerequisites</a></li>
<li><a href="#con-deploy-operator-best-practices-str">4.2. Operator deployment best practices</a></li>
<li><a href="#downloads-str">4.3. Downloading Strimzi release artifacts</a></li>
<li><a href="#container-images-str">4.4. Pushing container images to your own registry</a></li>
<li><a href="#adding-users-the-strimzi-admin-role-str">4.5. Designating Strimzi administrators</a></li>
</ul>
</li>
<li><a href="#deploy-tasks_str">5. Deploying Strimzi using installation artifacts</a>
<ul class="sectlevel2">
<li><a href="#con-deploy-paths-str">5.1. Basic deployment path</a></li>
<li><a href="#cluster-operator-str">5.2. Deploying the Cluster Operator</a>
<ul class="sectlevel3">
<li><a href="#con-cluster-operator-watch-options-str">5.2.1. Specifying the namespaces the Cluster Operator watches</a></li>
<li><a href="#deploying-cluster-operator-str">5.2.2. Deploying the Cluster Operator to watch a single namespace</a></li>
<li><a href="#deploying-cluster-operator-to-watch-multiple-namespaces-str">5.2.3. Deploying the Cluster Operator to watch multiple namespaces</a></li>
<li><a href="#deploying-cluster-operator-to-watch-whole-cluster-str">5.2.4. Deploying the Cluster Operator to watch all namespaces</a></li>
</ul>
</li>
<li><a href="#kafka-cluster-str">5.3. Deploying Kafka</a>
<ul class="sectlevel3">
<li><a href="#deploying-kafka-node-pools-str">5.3.1. Deploying a Kafka cluster with node pools</a></li>
<li><a href="#deploying-kafka-cluster-str">5.3.2. Deploying a ZooKeeper-based Kafka cluster without node pools</a></li>
<li><a href="#deploying-the-topic-operator-using-the-cluster-operator-str">5.3.3. Deploying the Topic Operator using the Cluster Operator</a></li>
<li><a href="#deploying-the-user-operator-using-the-cluster-operator-str">5.3.4. Deploying the User Operator using the Cluster Operator</a></li>
<li><a href="#ref-list-of-kafka-cluster-resources-str">5.3.5. List of Kafka cluster resources</a></li>
</ul>
</li>
<li><a href="#kafka-connect-str">5.4. Deploying Kafka Connect</a>
<ul class="sectlevel3">
<li><a href="#deploying-kafka-connect-str">5.4.1. Deploying Kafka Connect to your Kubernetes cluster</a></li>
<li><a href="#ref-list-of-kafka-connect-resources-str">5.4.2. List of Kafka Connect cluster resources</a></li>
</ul>
</li>
<li><a href="#using-kafka-connect-with-plug-ins-str">5.5. Adding Kafka Connect connectors</a>
<ul class="sectlevel3">
<li><a href="#creating-new-image-using-kafka-connect-build-str">5.5.1. Building a new container image with connector plugins automatically</a></li>
<li><a href="#creating-new-image-from-base-str">5.5.2. Building a new container image with connector plugins from the Kafka Connect base image</a></li>
<li><a href="#proc-deploying-kafkaconnector-str">5.5.3. Deploying KafkaConnector resources</a></li>
<li><a href="#con-exposing-kafka-connect-api-str">5.5.4. Exposing the Kafka Connect API</a></li>
<li><a href="#con-securing-kafka-connect-api-str">5.5.5. Limiting access to the Kafka Connect API</a></li>
<li><a href="#con-switching-api-to-kafka-connector-str">5.5.6. Switching from using the Kafka Connect API to using KafkaConnector custom resources</a></li>
</ul>
</li>
<li><a href="#kafka-mirror-maker-str">5.6. Deploying Kafka MirrorMaker</a>
<ul class="sectlevel3">
<li><a href="#deploying-kafka-mirror-maker-str">5.6.1. Deploying Kafka MirrorMaker to your Kubernetes cluster</a></li>
<li><a href="#ref-list-of-kafka-mirrormaker2-resources-str">5.6.2. List of Kafka MirrorMaker 2 cluster resources</a></li>
<li><a href="#ref-list-of-kafka-mirror-maker-resources-str">5.6.3. List of Kafka MirrorMaker cluster resources</a></li>
</ul>
</li>
<li><a href="#kafka-bridge-str">5.7. Deploying Kafka Bridge</a>
<ul class="sectlevel3">
<li><a href="#deploying-kafka-bridge-str">5.7.1. Deploying Kafka Bridge to your Kubernetes cluster</a></li>
<li><a href="#proc-exposing-kafka-bridge-service-local-machine-str">5.7.2. Exposing the Kafka Bridge service to your local machine</a></li>
<li><a href="#con-accessing-kafka-bridge-from-outside-str">5.7.3. Accessing the Kafka Bridge outside of Kubernetes</a></li>
<li><a href="#ref-list-of-kafka-bridge-resources-str">5.7.4. List of Kafka Bridge cluster resources</a></li>
</ul>
</li>
<li><a href="#deploy-standalone-operators_str">5.8. Alternative standalone deployment options for Strimzi operators</a>
<ul class="sectlevel3">
<li><a href="#deploying-the-topic-operator-standalone-str">5.8.1. Deploying the standalone Topic Operator</a></li>
<li><a href="#deploying-the-user-operator-standalone-str">5.8.2. Deploying the standalone User Operator</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#deploying-strimzi-from-operator-hub-str">6. Deploying Strimzi from OperatorHub.io</a></li>
<li><a href="#deploying-cluster-operator-helm-chart-str">7. Deploying Strimzi using Helm</a></li>
<li><a href="#ref-operator-cluster-feature-gates-str">8. Enabling Strimzi feature gates</a>
<ul class="sectlevel2">
<li><a href="#controlplanelistener_feature_gate">8.1. ControlPlaneListener feature gate</a></li>
<li><a href="#serviceaccountpatching_feature_gate">8.2. ServiceAccountPatching feature gate</a></li>
<li><a href="#ref-operator-use-strimzi-pod-sets-feature-gate-str">8.3. UseStrimziPodSets feature gate</a></li>
<li><a href="#ref-operator-stable-connect-identities-feature-gate-str">8.4. StableConnectIdentities feature gate</a></li>
<li><a href="#ref-operator-use-kraft-feature-gate-str">8.5. (Preview) UseKRaft feature gate</a></li>
<li><a href="#ref-operator-kafka-node-pools-feature-gate-str">8.6. KafkaNodePools feature gate</a></li>
<li><a href="#ref-operator-unidirectional-topic-operator-feature-gate-str">8.7. UnidirectionalTopicOperator feature gate</a></li>
<li><a href="#ref-operator-cluster-feature-gate-releases-str">8.8. Feature gate releases</a></li>
</ul>
</li>
<li><a href="#overview-str">9. Configuring a deployment</a>
<ul class="sectlevel2">
<li><a href="#config-examples-str">9.1. Using example configuration files</a></li>
<li><a href="#con-config-kafka-str">9.2. Configuring Kafka</a>
<ul class="sectlevel3">
<li><a href="#proc-setting-broker-limits-str">9.2.1. Setting limits on brokers using the Kafka Static Quota plugin</a></li>
<li><a href="#con-zookeeper-default-config-str">9.2.2. Default ZooKeeper configuration values</a></li>
</ul>
</li>
<li><a href="#config-node-pools-str">9.3. Configuring node pools</a>
<ul class="sectlevel3">
<li><a href="#proc-managing-node-pools-ids-str">9.3.1. Assigning IDs to node pools for scaling operations</a></li>
<li><a href="#proc-scaling-up-node-pools-str">9.3.2. Adding nodes to a node pool</a></li>
<li><a href="#proc-scaling-down-node-pools-str">9.3.3. Removing nodes from a node pool</a></li>
<li><a href="#proc-moving-node-pools-str">9.3.4. Moving nodes between node pools</a></li>
<li><a href="#proc-managing-storage-node-pools-str">9.3.5. Managing storage using node pools</a></li>
<li><a href="#proc-managing-storage-affinity-node-pools-str">9.3.6. Managing storage affinity using node pools</a></li>
<li><a href="#proc-migrating-clusters-node-pools-str">9.3.7. Migrating existing Kafka clusters to use Kafka node pools</a></li>
</ul>
</li>
<li><a href="#ref-kafka-entity-operator-str">9.4. Configuring the Entity Operator</a>
<ul class="sectlevel3">
<li><a href="#topic-operator-str">9.4.1. Configuring the Topic Operator</a></li>
<li><a href="#user-operator-str">9.4.2. Configuring the User Operator</a></li>
</ul>
</li>
<li><a href="#ref-operator-cluster-str">9.5. Configuring the Cluster Operator</a>
<ul class="sectlevel3">
<li><a href="#ref-operator-cluster-network-policy-str">9.5.1. Restricting access to the Cluster Operator using network policy</a></li>
<li><a href="#ref-operator-cluster-periodic-reconciliation-str">9.5.2. Configuring periodic reconciliation by the Cluster Operator</a></li>
<li><a href="#assembly-using-multiple-cluster-operator-replicas-str">9.5.3. Running multiple Cluster Operator replicas with leader election</a></li>
<li><a href="#proc-configuring-proxy-config-cluster-operator-str">9.5.4. Configuring Cluster Operator HTTP proxy settings</a></li>
<li><a href="#proc-disabling-fips-mode-cluster-operator-str">9.5.5. Disabling FIPS mode using Cluster Operator configuration</a></li>
</ul>
</li>
<li><a href="#con-kafka-connect-config-str">9.6. Configuring Kafka Connect</a>
<ul class="sectlevel3">
<li><a href="#con-config-kafka-connect-multiple-instances-str">9.6.1. Configuring Kafka Connect for multiple instances</a></li>
<li><a href="#proc-configuring-kafka-connect-user-authorization-str">9.6.2. Configuring Kafka Connect user authorization</a></li>
<li><a href="#proc-manual-stop-pause-connector-str">9.6.3. Manually stopping or pausing Kafka Connect connectors</a></li>
<li><a href="#proc-manual-restart-connector-str">9.6.4. Manually restarting Kafka Connect connectors</a></li>
<li><a href="#proc-manual-restart-connector-task-str">9.6.5. Manually restarting Kafka Connect connector tasks</a></li>
</ul>
</li>
<li><a href="#con-config-mirrormaker2-str">9.7. Configuring Kafka MirrorMaker 2</a>
<ul class="sectlevel3">
<li><a href="#con-overview-mm2-str">9.7.1. Configuring active/active or active/passive modes</a></li>
<li><a href="#con-config-mm2-multiple-instances-str">9.7.2. Configuring MirrorMaker 2 for multiple instances</a></li>
<li><a href="#con-config-mirrormaker2-connectors-str">9.7.3. Configuring MirrorMaker 2 connectors</a></li>
<li><a href="#con-mirrormaker-producers-consumers-str">9.7.4. Configuring MirrorMaker 2 connector producers and consumers</a></li>
<li><a href="#con-mirrormaker-tasks-max-str">9.7.5. Specifying a maximum number of data replication tasks</a></li>
<li><a href="#con-mirrormaker-acls-str">9.7.6. Synchronizing ACL rules for remote topics</a></li>
<li><a href="#proc-config-mirrormaker2-securing-connection-str">9.7.7. Securing a Kafka MirrorMaker 2 deployment</a></li>
<li><a href="#proc-manual-stop-pause-mirrormaker2-connector-str">9.7.8. Manually stopping or pausing MirrorMaker 2 connectors</a></li>
<li><a href="#proc-manual-restart-mirrormaker2-connector-str">9.7.9. Manually restarting MirrorMaker 2 connectors</a></li>
<li><a href="#proc-manual-restart-mirrormaker2-connector-task-str">9.7.10. Manually restarting MirrorMaker 2 connector tasks</a></li>
</ul>
</li>
<li><a href="#con-config-mirrormaker-str">9.8. Configuring Kafka MirrorMaker (deprecated)</a></li>
<li><a href="#con-config-kafka-bridge-str">9.9. Configuring the Kafka Bridge</a></li>
<li><a href="#assembly-storage-str">9.10. Configuring Kafka and ZooKeeper storage</a>
<ul class="sectlevel3">
<li><a href="#considerations-for-data-storage-str">9.10.1. Data storage considerations</a></li>
<li><a href="#ref-ephemeral-storage-str">9.10.2. Ephemeral storage</a></li>
<li><a href="#ref-persistent-storage-str">9.10.3. Persistent storage</a></li>
<li><a href="#proc-resizing-persistent-volumes-str">9.10.4. Resizing persistent volumes</a></li>
<li><a href="#ref-jbod-storage-str">9.10.5. JBOD storage</a></li>
<li><a href="#proc-adding-volumes-to-jbod-storage-str">9.10.6. Adding volumes to JBOD storage</a></li>
<li><a href="#proc-removing-volumes-from-jbod-storage-str">9.10.7. Removing volumes from JBOD storage</a></li>
</ul>
</li>
<li><a href="#config-resources-str">9.11. Configuring CPU and memory resource limits and requests</a></li>
<li><a href="#assembly-scheduling-str">9.12. Configuring pod scheduling</a>
<ul class="sectlevel3">
<li><a href="#affinity-str">9.12.1. Specifying affinity, tolerations, and topology spread constraints</a></li>
<li><a href="#configuring-pod-anti-affinity-to-schedule-each-kafka-broker-on-a-different-worker-node-str">9.12.2. Configuring pod anti-affinity to schedule each Kafka broker on a different worker node</a></li>
<li><a href="#configuring-pod-anti-affinity-in-kafka-components-str">9.12.3. Configuring pod anti-affinity in Kafka components</a></li>
<li><a href="#proc-configuring-node-affinity-str">9.12.4. Configuring node affinity in Kafka components</a></li>
<li><a href="#proc-dedicated-nodes-str">9.12.5. Setting up dedicated nodes and scheduling pods on them</a></li>
</ul>
</li>
<li><a href="#external-logging_str">9.13. Configuring logging levels</a>
<ul class="sectlevel3">
<li><a href="#logging_options_for_kafka_components_and_operators">9.13.1. Logging options for Kafka components and operators</a></li>
<li><a href="#creating-configmap_str">9.13.2. Creating a ConfigMap for logging</a></li>
<li><a href="#ref-operator-cluster-logging-configmap-str">9.13.3. Configuring Cluster Operator logging</a></li>
<li><a href="#creating-logging-filters_str">9.13.4. Adding logging filters to Strimzi operators</a></li>
</ul>
</li>
<li><a href="#configuration-points-configmaps-str">9.14. Using ConfigMaps to add configuration</a>
<ul class="sectlevel3">
<li><a href="#naming_custom_configmaps">9.14.1. Naming custom ConfigMaps</a></li>
</ul>
</li>
<li><a href="#assembly-loading-config-with-providers-str">9.15. Loading configuration values from external sources</a>
<ul class="sectlevel3">
<li><a href="#con-loading-config-from-env-vars-str">9.15.1. Enabling configuration providers</a></li>
<li><a href="#proc-loading-config-from-config-map-str">9.15.2. Loading configuration values from secrets or config maps</a></li>
<li><a href="#proc-loading-config-from-env-vars-str">9.15.3. Loading configuration values from environment variables</a></li>
<li><a href="#proc-loading-config-from-file-str">9.15.4. Loading configuration values from a file within a directory</a></li>
<li><a href="#proc-loading-config-from-files-str">9.15.5. Loading configuration values from multiple files within a directory</a></li>
</ul>
</li>
<li><a href="#assembly-customizing-kubernetes-resources-str">9.16. Customizing Kubernetes resources</a>
<ul class="sectlevel3">
<li><a href="#con-customizing-image-pull-policy-str">9.16.1. Customizing the image pull policy</a></li>
<li><a href="#con-applying-termination-grace-period-str">9.16.2. Applying a termination grace period</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#using-the-topic-operator-str">10. Using the Topic Operator to manage Kafka topics</a>
<ul class="sectlevel2">
<li><a href="#ref-operator-topic-str">10.1. Topic management modes</a>
<ul class="sectlevel3">
<li><a href="#unidirectional_topic_management">10.1.1. Unidirectional topic management</a></li>
<li><a href="#bidirectional_topic_management">10.1.2. Bidirectional topic management</a></li>
</ul>
</li>
<li><a href="#con-operator-topic-names-str">10.2. Topic naming conventions</a></li>
<li><a href="#con-application-topic-handling-str">10.3. Handling changes to topics</a>
<ul class="sectlevel3">
<li><a href="#topic_store_for_bidirectional_topic_management">10.3.1. Topic store for bidirectional topic management</a></li>
<li><a href="#migrating_topic_metadata_from_zookeeper_to_the_topic_store">10.3.2. Migrating topic metadata from ZooKeeper to the topic store</a></li>
<li><a href="#downgrading_to_a_strimzi_version_that_uses_zookeeper_to_store_topic_metadata">10.3.3. Downgrading to a Strimzi version that uses ZooKeeper to store topic metadata</a></li>
<li><a href="#automatic_creation_of_topics">10.3.4. Automatic creation of topics</a></li>
</ul>
</li>
<li><a href="#proc-configuring-kafka-topic-str">10.4. Configuring Kafka topics</a></li>
<li><a href="#ref-topic-replication-str">10.5. Configuring topics for replication and number of partitions</a></li>
<li><a href="#proc-converting-managed-topics-str">10.6. Managing KafkaTopic resources without impacting Kafka topics</a></li>
<li><a href="#proc-converting-non-managed-topics-str">10.7. Enabling topic management for existing Kafka topics</a></li>
<li><a href="#con-deleting-managed-topics-str">10.8. Deleting managed topics</a></li>
<li><a href="#proc-changing-topic-operator-mode-str">10.9. Switching between Topic Operator modes</a></li>
<li><a href="#con-removing-topic-finalizers-str">10.10. Removing finalizers on topics</a></li>
<li><a href="#con-disabling-topic-deletion-str">10.11. Considerations when disabling topic deletion</a></li>
<li><a href="#con-tuning-topic-request-batches-str">10.12. Tuning request batches for topic operations</a></li>
</ul>
</li>
<li><a href="#assembly-using-the-user-operator-str">11. Using the User Operator to manage Kafka users</a>
<ul class="sectlevel2">
<li><a href="#proc-configuring-kafka-user-str">11.1. Configuring Kafka users</a></li>
</ul>
</li>
<li><a href="#deploy-client-access-str">12. Setting up client access to a Kafka cluster</a>
<ul class="sectlevel2">
<li><a href="#deploying-example-clients-str">12.1. Deploying example clients</a></li>
<li><a href="#configuration-points-listeners-str">12.2. Configuring listeners to connect to Kafka brokers</a></li>
<li><a href="#con-configuration-points-listener-names-str">12.3. Listener naming conventions</a></li>
<li><a href="#setup-external-clients-str">12.4. Setting up client access to a Kafka cluster using listeners</a></li>
<li><a href="#proc-accessing-kafka-using-nodeports-str">12.5. Accessing Kafka using node ports</a></li>
<li><a href="#proc-accessing-kafka-using-loadbalancers-str">12.6. Accessing Kafka using loadbalancers</a></li>
<li><a href="#proc-accessing-kafka-using-ingress-str">12.7. Accessing Kafka using an Ingress NGINX Controller for Kubernetes</a></li>
<li><a href="#proc-accessing-kafka-using-routes-str">12.8. Accessing Kafka using OpenShift routes</a></li>
</ul>
</li>
<li><a href="#assembly-securing-access-str">13. Managing secure access to Kafka</a>
<ul class="sectlevel2">
<li><a href="#assembly-securing-kafka-brokers-str">13.1. Security options for Kafka</a>
<ul class="sectlevel3">
<li><a href="#con-securing-kafka-authentication-str">13.1.1. Listener authentication</a></li>
<li><a href="#con-securing-kafka-authorization-str">13.1.2. Kafka authorization</a></li>
</ul>
</li>
<li><a href="#assembly-securing-kafka-clients-str">13.2. Security options for Kafka clients</a>
<ul class="sectlevel3">
<li><a href="#con-securing-client-labels-str">13.2.1. Identifying a Kafka cluster for user handling</a></li>
<li><a href="#con-securing-client-authentication-str">13.2.2. User authentication</a></li>
<li><a href="#con-securing-client-authorization-str">13.2.3. User authorization</a></li>
</ul>
</li>
<li><a href="#assembly-securing-kafka-str">13.3. Securing access to Kafka brokers</a>
<ul class="sectlevel3">
<li><a href="#proc-securing-kafka-str">13.3.1. Securing Kafka brokers</a></li>
<li><a href="#proc-configuring-secure-kafka-user-str">13.3.2. Securing user access to Kafka</a></li>
<li><a href="#proc-restricting-access-to-listeners-using-network-policies-str">13.3.3. Restricting access to Kafka listeners using network policies</a></li>
<li><a href="#proc-installing-certs-per-listener-str">13.3.4. Providing your own Kafka listener certificates for TLS encryption</a></li>
<li><a href="#ref-alternative-subjects-certs-for-listeners-str">13.3.5. Alternative subjects in server certificates for Kafka listeners</a></li>
</ul>
</li>
<li><a href="#assembly-oauth-authentication_str">13.4. Using OAuth 2.0 token-based authentication</a>
<ul class="sectlevel3">
<li><a href="#con-oauth-authentication-flow-str">13.4.1. OAuth 2.0 authentication mechanisms</a></li>
<li><a href="#con-oauth-authentication-broker-str">13.4.2. OAuth 2.0 Kafka broker configuration</a></li>
<li><a href="#str">13.4.3. Session re-authentication for Kafka brokers</a></li>
<li><a href="#con-oauth-authentication-client-str">13.4.4. OAuth 2.0 Kafka client configuration</a></li>
<li><a href="#con-oauth-authentication-client-options-str">13.4.5. OAuth 2.0 client authentication flows</a></li>
<li><a href="#con-oauth-strimzi-config-str">13.4.6. Configuring OAuth 2.0 authentication</a></li>
<li><a href="#con-oauth-server-examples-str">13.4.7. Authorization server examples</a></li>
</ul>
</li>
<li><a href="#assembly-oauth-authorization_str">13.5. Using OAuth 2.0 token-based authorization</a>
<ul class="sectlevel3">
<li><a href="#con-oauth-authorization-mechanism_str">13.5.1. OAuth 2.0 authorization mechanism</a></li>
<li><a href="#proc-oauth-authorization-broker-config-str">13.5.2. Configuring OAuth 2.0 authorization support</a></li>
<li><a href="#assembly-managing-policies-permissions-keycloak_str">13.5.3. Managing policies and permissions in Keycloak Authorization Services</a></li>
<li><a href="#proc-oauth-authorization-keycloak-example_str">13.5.4. Trying Keycloak Authorization Services</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#security-str">14. Managing TLS certificates</a>
<ul class="sectlevel2">
<li><a href="#certificate-authorities-str">14.1. Internal cluster CA and clients CA</a></li>
<li><a href="#certificates-and-secrets-str">14.2. Secrets generated by the operators</a>
<ul class="sectlevel3">
<li><a href="#certificates-and-secrets-formats-str">14.2.1. TLS authentication using keys and certificates in PEM or PKCS #12 format</a></li>
<li><a href="#con-certificates-str">14.2.2. Secrets generated by the Cluster Operator</a></li>
<li><a href="#cluster_ca_secrets">14.2.3. Cluster CA secrets</a></li>
<li><a href="#clients_ca_secrets">14.2.4. Clients CA secrets</a></li>
<li><a href="#user_secrets_generated_by_the_user_operator">14.2.5. User secrets generated by the User Operator</a></li>
<li><a href="#adding_labels_and_annotations_to_cluster_ca_secrets">14.2.6. Adding labels and annotations to cluster CA secrets</a></li>
<li><a href="#disabling_ownerreference_in_the_ca_secrets">14.2.7. Disabling <code>ownerReference</code> in the CA secrets</a></li>
</ul>
</li>
<li><a href="#con-certificate-renewal-str">14.3. Certificate renewal and validity periods</a>
<ul class="sectlevel3">
<li><a href="#renewal_process_with_automatically_generated_ca_certificates">14.3.1. Renewal process with automatically generated CA certificates</a></li>
<li><a href="#client_certificate_renewal">14.3.2. Client certificate renewal</a></li>
<li><a href="#proc-renewing-ca-certs-manually-str">14.3.3. Manually renewing Cluster Operator-managed CA certificates</a></li>
<li><a href="#proc-recovering-expired-ca-certs-str">14.3.4. Manually recovering from expired Cluster Operator-managed CA certificates</a></li>
<li><a href="#proc-replacing-private-keys-str">14.3.5. Replacing private keys used by Cluster Operator-managed CA certificates</a></li>
</ul>
</li>
<li><a href="#configuring-internal-clients-to-trust-cluster-ca-str">14.4. Configuring internal clients to trust the cluster CA</a></li>
<li><a href="#configuring-external-clients-to-trust-cluster-ca-str">14.5. Configuring external clients to trust the cluster CA</a></li>
<li><a href="#security-using-your-own-certificates-str">14.6. Using your own CA certificates and private keys</a>
<ul class="sectlevel3">
<li><a href="#installing-your-own-ca-certificates-str">14.6.1. Installing your own CA certificates and private keys</a></li>
<li><a href="#renewing-your-own-ca-certificates-str">14.6.2. Renewing your own CA certificates</a></li>
<li><a href="#proc-replacing-your-own-private-keys-str">14.6.3. Renewing or replacing CA certificates and private keys with your own</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#assembly-security-providers-str">15. Applying security context to Strimzi pods and containers</a>
<ul class="sectlevel2">
<li><a href="#con-config-security-providers-str">15.1. How to configure security context</a>
<ul class="sectlevel3">
<li><a href="#template_configuration_for_security_context">15.1.1. Template configuration for security context</a></li>
<li><a href="#baseline_provider_for_pod_security">15.1.2. Baseline Provider for pod security</a></li>
<li><a href="#restricted_provider_for_pod_security">15.1.3. Restricted Provider for pod security</a></li>
</ul>
</li>
<li><a href="#proc-config-restricted-security-providers-str">15.2. Enabling the Restricted Provider for the Cluster Operator</a></li>
<li><a href="#con-config-custom-security-providers-str">15.3. Implementing a custom pod security provider</a></li>
<li><a href="#con-config-openshift-security-providers-str">15.4. Handling of security context by Kubernetes platform</a></li>
</ul>
</li>
<li><a href="#con-scaling-kafka-clusters-str">16. Scaling clusters by adding or removing brokers</a>
<ul class="sectlevel2">
<li><a href="#con-skipping-scale-down-checks-str">16.1. Skipping checks on scale-down operations</a></li>
</ul>
</li>
<li><a href="#cruise-control-concepts-str">17. Rebalancing clusters using Cruise Control</a>
<ul class="sectlevel2">
<li><a href="#con-cruise-control-overview-str">17.1. Cruise Control components and features</a></li>
<li><a href="#con-optimization-goals-str">17.2. Optimization goals overview</a>
<ul class="sectlevel3">
<li><a href="#goals_order_of_priority">17.2.1. Goals order of priority</a></li>
<li><a href="#goals_configuration_in_strimzi_custom_resources">17.2.2. Goals configuration in Strimzi custom resources</a></li>
<li><a href="#hard-soft-goals">17.2.3. Hard and soft optimization goals</a></li>
<li><a href="#main-goals">17.2.4. Main optimization goals</a></li>
<li><a href="#default-goals">17.2.5. Default optimization goals</a></li>
<li><a href="#user-provided-goals">17.2.6. User-provided optimization goals</a></li>
</ul>
</li>
<li><a href="#con-optimization-proposals-str">17.3. Optimization proposals overview</a>
<ul class="sectlevel3">
<li><a href="#con-optimization-proposals-modes-str">17.3.1. Rebalancing modes</a></li>
<li><a href="#contents-optimization-proposals">17.3.2. The results of an optimization proposal</a></li>
<li><a href="#manually_approving_or_rejecting_an_optimization_proposal">17.3.3. Manually approving or rejecting an optimization proposal</a></li>
<li><a href="#automatically_approving_an_optimization_proposal">17.3.4. Automatically approving an optimization proposal</a></li>
<li><a href="#optimization_proposal_summary_properties">17.3.5. Optimization proposal summary properties</a></li>
<li><a href="#broker_load_properties">17.3.6. Broker load properties</a></li>
<li><a href="#cached_optimization_proposal">17.3.7. Cached optimization proposal</a></li>
</ul>
</li>
<li><a href="#con-rebalance-str">17.4. Rebalance performance tuning overview</a>
<ul class="sectlevel3">
<li><a href="#partition_reassignment_commands">17.4.1. Partition reassignment commands</a></li>
<li><a href="#replica_movement_strategies">17.4.2. Replica movement strategies</a></li>
<li><a href="#intra_broker_disk_balancing">17.4.3. Intra-broker disk balancing</a></li>
<li><a href="#rebalance_tuning_options">17.4.4. Rebalance tuning options</a></li>
</ul>
</li>
<li><a href="#proc-configuring-deploying-cruise-control-str">17.5. Configuring and deploying Cruise Control with Kafka</a></li>
<li><a href="#proc-generating-optimization-proposals-str">17.6. Generating optimization proposals</a></li>
<li><a href="#proc-approving-optimization-proposal-str">17.7. Approving an optimization proposal</a></li>
<li><a href="#proc-stopping-cluster-rebalance-str">17.8. Stopping a cluster rebalance</a></li>
<li><a href="#proc-fixing-problems-with-kafkarebalance-str">17.9. Fixing problems with a <code>KafkaRebalance</code> resource</a></li>
</ul>
</li>
<li><a href="#assembly-reassign-tool-str">18. Using the partition reassignment tool</a>
<ul class="sectlevel2">
<li><a href="#con-partition-reassignment-str">18.1. Partition reassignment tool overview</a>
<ul class="sectlevel3">
<li><a href="#generating_a_partition_reassignment_plan">18.1.1. Generating a partition reassignment plan</a></li>
<li><a href="#specifying_topics_in_a_partition_reassignment_json_file">18.1.2. Specifying topics in a partition reassignment JSON file</a></li>
<li><a href="#reassigning_partitions_between_jbod_volumes">18.1.3. Reassigning partitions between JBOD volumes</a></li>
<li><a href="#throttling_partition_reassignment">18.1.4. Throttling partition reassignment</a></li>
</ul>
</li>
<li><a href="#proc-generating-reassignment-json-files-str">18.2. Generating a reassignment JSON file to reassign partitions</a></li>
<li><a href="#proc-scaling-up-a-kafka-cluster-str">18.3. Reassigning partitions after adding brokers</a></li>
<li><a href="#proc-scaling-down-a-kafka-cluster-str">18.4. Reassigning partitions before removing brokers</a></li>
<li><a href="#proc-changing-topic-replicas-str">18.5. Changing the replication factor of topics</a></li>
</ul>
</li>
<li><a href="#assembly-metrics-str">19. Introducing metrics</a>
<ul class="sectlevel2">
<li><a href="#con-metrics-kafka-exporter-lag-str">19.1. Monitoring consumer lag with Kafka Exporter</a></li>
<li><a href="#con-metrics-cruise-control-str">19.2. Monitoring Cruise Control operations</a>
<ul class="sectlevel3">
<li><a href="#monitoring_balancedness_scores">19.2.1. Monitoring balancedness scores</a></li>
<li><a href="#setting_up_alerts_for_anomaly_detection">19.2.2. Setting up alerts for anomaly detection</a></li>
</ul>
</li>
<li><a href="#assembly-metrics-config-files-str">19.3. Example metrics files</a>
<ul class="sectlevel3">
<li><a href="#ref-metrics-prometheus-metrics-config-str">19.3.1. Example Prometheus metrics configuration</a></li>
<li><a href="#ref-metrics-alertmanager-examples-str">19.3.2. Example Prometheus rules for alert notifications</a></li>
<li><a href="#ref-metrics-dashboards-str">19.3.3. Example Grafana dashboards</a></li>
</ul>
</li>
<li><a href="#assembly-metrics-setup-str">19.4. Using Prometheus with Strimzi</a>
<ul class="sectlevel3">
<li><a href="#proc-metrics-kafka-deploy-options-str">19.4.1. Enabling Prometheus metrics through configuration</a></li>
<li><a href="#assembly-metrics-prometheus-str">19.4.2. Setting up Prometheus</a></li>
<li><a href="#proc-metrics-deploying-prometheus-alertmanager-str">19.4.3. Deploying Alertmanager</a></li>
</ul>
</li>
<li><a href="#proc-metrics-grafana-dashboard-str">19.5. Enabling the example Grafana dashboards</a></li>
</ul>
</li>
<li><a href="#assembly-distributed-tracing-str">20. Introducing distributed tracing</a>
<ul class="sectlevel2">
<li><a href="#con-overview-tracing-str">20.1. Tracing options</a></li>
<li><a href="#ref-tracing-environment-variables-str">20.2. Environment variables for tracing</a></li>
<li><a href="#assembly-distributed-tracing-procedures-str">20.3. Setting up distributed tracing</a>
<ul class="sectlevel3">
<li><a href="#prerequisites">20.3.1. Prerequisites</a></li>
<li><a href="#proc-enabling-tracing-in-connect-mirror-maker-bridge-resources-str">20.3.2. Enabling tracing in MirrorMaker, Kafka Connect, and Kafka Bridge resources</a></li>
<li><a href="#proc-configuring-tracers-kafka-clients-str">20.3.3. Initializing tracing for Kafka clients</a></li>
<li><a href="#proc-instrumenting-producers-consumers-for-tracing-str">20.3.4. Instrumenting producers and consumers for tracing</a></li>
<li><a href="#proc-instrumenting-kafka-streams-with-tracers-str">20.3.5. Instrumenting Kafka Streams applications for tracing</a></li>
<li><a href="#proc-enabling-tracing-type-str">20.3.6. Introducing a different OpenTelemetry tracing system</a></li>
<li><a href="#ref-tracing-span-names-str">20.3.7. Custom span names</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#assembly-upgrade-str">21. Upgrading Strimzi</a>
<ul class="sectlevel2">
<li><a href="#con-upgrade-sequence-str">21.1. Required upgrade sequence</a></li>
<li><a href="#con-upgrade-paths-str">21.2. Strimzi upgrade paths</a>
<ul class="sectlevel3">
<li><a href="#con-upgrade-paths-kafka-versions-str">21.2.1. Support for Kafka versions when upgrading</a></li>
<li><a href="#con-upgrade-paths-earlier-versions-str">21.2.2. Upgrading from a Strimzi version earlier than 0.22</a></li>
<li><a href="#con-versions-and-images-str">21.2.3. Kafka version and image mappings</a></li>
</ul>
</li>
<li><a href="#con-strategies-for-upgrading-clients-str">21.3. Strategies for upgrading clients</a></li>
<li><a href="#con-upgrade-cluster-str">21.4. Upgrading Kubernetes with minimal downtime</a>
<ul class="sectlevel3">
<li><a href="#rolling_pods_using_the_strimzi_drain_cleaner">21.4.1. Rolling pods using the Strimzi Drain Cleaner</a></li>
<li><a href="#rolling_pods_manually_while_keeping_topics_available">21.4.2. Rolling pods manually while keeping topics available</a></li>
</ul>
</li>
<li><a href="#assembly-upgrade-cluster-operator-str">21.5. Upgrading the Cluster Operator</a>
<ul class="sectlevel3">
<li><a href="#proc-upgrading-the-co-str">21.5.1. Upgrading the Cluster Operator using installation files</a></li>
<li><a href="#upgrading_the_cluster_operator_using_the_operatorhub">21.5.2. Upgrading the Cluster Operator using the OperatorHub</a></li>
<li><a href="#upgrading_the_cluster_operator_using_a_helm_chart">21.5.3. Upgrading the Cluster Operator using a Helm chart</a></li>
<li><a href="#migrating_to_unidirectional_topic_management">21.5.4. Migrating to unidirectional topic management</a></li>
<li><a href="#con-upgrade-cluster-operator-unsupported-kafka-str">21.5.5. Upgrading the Cluster Operator returns Kafka version error</a></li>
</ul>
</li>
<li><a href="#proc-upgrade-kafka-kraft-str">21.6. Upgrading KRaft-based Kafka clusters and client applications</a></li>
<li><a href="#assembly-upgrade-zookeeper-str">21.7. Upgrading Kafka when using ZooKeeper</a>
<ul class="sectlevel3">
<li><a href="#ref-kafka-versions-str">21.7.1. Updating Kafka versions</a></li>
<li><a href="#con-upgrade-older-clients-str">21.7.2. Upgrading clients with older message formats</a></li>
<li><a href="#proc-upgrade-kafka-zookeeper-str">21.7.3. Upgrading ZooKeeper-based Kafka clusters and client applications</a></li>
</ul>
</li>
<li><a href="#con-upgrade-status-str">21.8. Checking the status of an upgrade</a></li>
<li><a href="#proc-reenabling-FIPS-mode-str">21.9. Switching to FIPS mode when upgrading Strimzi</a></li>
</ul>
</li>
<li><a href="#assembly-downgrade-str">22. Downgrading Strimzi</a>
<ul class="sectlevel2">
<li><a href="#proc-downgrade-cluster-operator-str">22.1. Downgrading the Cluster Operator to a previous version</a></li>
<li><a href="#proc-downgrade-kafka-kraft-str">22.2. Downgrading KRaft-based Kafka clusters and client applications</a></li>
<li><a href="#assembly-downgrade-kafka-versions-str">22.3. Downgrading Kafka when using ZooKeeper</a>
<ul class="sectlevel3">
<li><a href="#con-target-downgrade-version-str">22.3.1. Kafka version compatibility for downgrades</a></li>
<li><a href="#proc-downgrade-kafka-zookeeper-str">22.3.2. Downgrading ZooKeeper-based Kafka clusters and client applications</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#assembly-deploy-restart-events-str">23. Finding information on Kafka restarts</a>
<ul class="sectlevel2">
<li><a href="#ref-operator-restart-events-reasons-str">23.1. Reasons for a restart event</a></li>
<li><a href="#ref-operator-restart-events-fields-str">23.2. Restart event filters</a></li>
<li><a href="#proc-operator-restart-events-str">23.3. Checking Kafka restarts</a></li>
</ul>
</li>
<li><a href="#assembly-tuning-config-str">24. Tuning Kafka configuration</a>
<ul class="sectlevel2">
<li><a href="#tools_that_help_with_tuning">24.1. Tools that help with tuning</a></li>
<li><a href="#con-managed-broker-config-properties-str">24.2. Managed broker configurations</a></li>
<li><a href="#con-broker-config-properties-str">24.3. Kafka broker configuration tuning</a>
<ul class="sectlevel3">
<li><a href="#basic_broker_configuration">24.3.1. Basic broker configuration</a></li>
<li><a href="#replicating_topics_for_high_availability">24.3.2. Replicating topics for high availability</a></li>
<li><a href="#internal_topic_settings_for_transactions_and_commits">24.3.3. Internal topic settings for transactions and commits</a></li>
<li><a href="#improving_request_handling_throughput_by_increasing_io_threads">24.3.4. Improving request handling throughput by increasing I/O threads</a></li>
<li><a href="#increasing_bandwidth_for_high_latency_connections">24.3.5. Increasing bandwidth for high latency connections</a></li>
<li><a href="#managing_kafka_logs_with_delete_and_compact_policies">24.3.6. Managing Kafka logs with delete and compact policies</a></li>
<li><a href="#managing_efficient_disk_utilization_for_compaction">24.3.7. Managing efficient disk utilization for compaction</a></li>
<li><a href="#handling_large_message_sizes">24.3.8. Handling large message sizes</a></li>
<li><a href="#controlling_the_log_flush_of_message_data">24.3.9. Controlling the log flush of message data</a></li>
<li><a href="#partition_rebalancing_for_availability">24.3.10. Partition rebalancing for availability</a></li>
<li><a href="#con-broker-config-properties-unclean-str">24.3.11. Unclean leader election</a></li>
<li><a href="#avoiding_unnecessary_consumer_group_rebalances">24.3.12. Avoiding unnecessary consumer group rebalances</a></li>
</ul>
</li>
<li><a href="#con-producer-config-properties-str">24.4. Kafka producer configuration tuning</a>
<ul class="sectlevel3">
<li><a href="#basic_producer_configuration">24.4.1. Basic producer configuration</a></li>
<li><a href="#data_durability">24.4.2. Data durability</a></li>
<li><a href="#ordered_delivery">24.4.3. Ordered delivery</a></li>
<li><a href="#reliability_guarantees">24.4.4. Reliability guarantees</a></li>
<li><a href="#con-producer-config-properties-throughput-str">24.4.5. Optimizing producers for throughput and latency</a></li>
</ul>
</li>
<li><a href="#con-consumer-config-properties-str">24.5. Kafka consumer configuration tuning</a>
<ul class="sectlevel3">
<li><a href="#basic_consumer_configuration">24.5.1. Basic consumer configuration</a></li>
<li><a href="#scaling_data_consumption_using_consumer_groups">24.5.2. Scaling data consumption using consumer groups</a></li>
<li><a href="#message_ordering_guarantees">24.5.3. Message ordering guarantees</a></li>
<li><a href="#con-consumer-config-properties-throughput-str">24.5.4. Optimizing consumers for throughput and latency</a></li>
<li><a href="#avoiding_data_loss_or_duplication_when_committing_offsets">24.5.5. Avoiding data loss or duplication when committing offsets</a></li>
<li><a href="#recovering_from_failure_to_avoid_data_loss">24.5.6. Recovering from failure to avoid data loss</a></li>
<li><a href="#managing_offset_policy">24.5.7. Managing offset policy</a></li>
<li><a href="#minimizing_the_impact_of_rebalances">24.5.8. Minimizing the impact of rebalances</a></li>
</ul>
</li>
<li><a href="#con-high-volume-config-properties-str">24.6. Handling high volumes of messages</a>
<ul class="sectlevel3">
<li><a href="#configuring_kafka_connect_for_high_volume_messages">24.6.1. Configuring Kafka Connect for high-volume messages</a></li>
<li><a href="#configuring_mirrormaker_2_for_high_volume_messages">24.6.2. Configuring MirrorMaker 2 for high-volume messages</a></li>
<li><a href="#checking_the_mirrormaker_2_message_flow">24.6.3. Checking the MirrorMaker 2 message flow</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#management-tasks-str">25. Managing Strimzi</a>
<ul class="sectlevel2">
<li><a href="#working-with-resources-str">25.1. Working with custom resources</a>
<ul class="sectlevel3">
<li><a href="#con-custom-resources-info-str">25.1.1. Performing <code>kubectl</code> operations on custom resources</a></li>
<li><a href="#con-custom-resources-status-str">25.1.2. Strimzi custom resource status information</a></li>
<li><a href="#proc-accessing-resource-status-str">25.1.3. Finding the status of a custom resource</a></li>
</ul>
</li>
<li><a href="#proc-add-service-discovery-str">25.2. Discovering services using labels and annotations</a>
<ul class="sectlevel3">
<li><a href="#returning_connection_details_on_services">25.2.1. Returning connection details on services</a></li>
</ul>
</li>
<li><a href="#proc-connnecting-to-zookeeper-str">25.3. Connecting to ZooKeeper from a terminal</a></li>
<li><a href="#proc-pausing-reconciliation-str">25.4. Pausing reconciliation of custom resources</a></li>
<li><a href="#assembly-maintenance-time-windows-str">25.5. Maintenance time windows for rolling updates</a>
<ul class="sectlevel3">
<li><a href="#con-maintenance-time-windows-overview-str">25.5.1. Maintenance time windows overview</a></li>
<li><a href="#con-maintenance-time-window-definition-str">25.5.2. Maintenance time window definition</a></li>
<li><a href="#proc-configuring-maintenance-time-windows-str">25.5.3. Configuring a maintenance time window</a></li>
</ul>
</li>
<li><a href="#assembly-drain-cleaner-str">25.6. Evicting pods with the Strimzi Drain Cleaner</a>
<ul class="sectlevel3">
<li><a href="#drain-cleaner-prereqs-str">25.6.1. Downloading the Strimzi Drain Cleaner deployment files</a></li>
<li><a href="#proc-drain-cleaner-deploying-str">25.6.2. Deploying the Strimzi Drain Cleaner using installation files</a></li>
<li><a href="#deploying-drain-cleaner-helm-chart-str">25.6.3. Deploying the Strimzi Drain Cleaner using Helm</a></li>
<li><a href="#proc-drain-cleaner-using-str">25.6.4. Using the Strimzi Drain Cleaner</a></li>
<li><a href="#proc-drain-cleaner-certs-str">25.6.5. Adding or renewing the TLS certificates used by the Strimzi Drain Cleaner</a></li>
<li><a href="#proc-drain-cleaner-certs-renewing-str">25.6.6. Watching the TLS certificates used by the Strimzi Drain Cleaner</a></li>
</ul>
</li>
<li><a href="#proc-manual-delete-pod-pvc-kafka-str">25.7. Deleting Kafka nodes using annotations</a></li>
<li><a href="#proc-manual-delete-pod-pvc-zookeeper-str">25.8. Deleting ZooKeeper nodes using annotations</a></li>
<li><a href="#assembly-rolling-updates-str">25.9. Starting rolling updates of Kafka and other operands using annotations</a>
<ul class="sectlevel3">
<li><a href="#proc-manual-rolling-update-strimzipodset-str">25.9.1. Performing a rolling update using a pod management annotation</a></li>
<li><a href="#proc-manual-rolling-update-pods-str">25.9.2. Performing a rolling update using a pod annotation</a></li>
</ul>
</li>
<li><a href="#cluster-recovery-str">25.10. Recovering a cluster from persistent volumes</a>
<ul class="sectlevel3">
<li><a href="#namespace-deletion_str">25.10.1. Recovery from namespace deletion</a></li>
<li><a href="#cluster-loss_str">25.10.2. Recovery from loss of a Kubernetes cluster</a></li>
<li><a href="#cluster-recovery-volume_str">25.10.3. Recovering a deleted cluster from persistent volumes</a></li>
</ul>
</li>
<li><a href="#assembly-uninstalling-str">25.11. Uninstalling Strimzi</a>
<ul class="sectlevel3">
<li><a href="#uninstalling-str">25.11.1. Uninstalling Strimzi using the CLI</a></li>
<li><a href="#uninstalling-operator-hub-str">25.11.2. Uninstalling Strimzi from OperatorHub.io</a></li>
</ul>
</li>
<li><a href="#con-cluster-operator-faqs-str">25.12. Frequently asked questions</a>
<ul class="sectlevel3">
<li><a href="#questions_related_to_the_cluster_operator">25.12.1. Questions related to the Cluster Operator</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="deploy-intro_str"><a class="link" href="#deploy-intro_str">1. Deployment overview</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Strimzi simplifies the process of running <a href="https://kafka.apache.org/" target="_blank" rel="noopener">Apache Kafka</a> in a Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>This guide provides instructions for deploying and managing Strimzi.
Deployment options and steps are covered using the example installation files included with Strimzi.
While the guide highlights important configuration considerations, it does not cover all available options.
For a deeper understanding of the Kafka component configuration options, refer to the <a href="./configuring.html" target="_blank" rel="noopener">Strimzi Custom Resource API Reference</a>.</p>
</div>
<div class="paragraph">
<p>In addition to deployment instructions, the guide offers pre- and post-deployment guidance.
It covers setting up and securing client access to your Kafka cluster.
Furthermore, it explores additional deployment options such as metrics integration, distributed tracing, and cluster management tools like Cruise Control and the Strimzi Drain Cleaner.
You&#8217;ll also find recommendations on managing Strimzi and fine-tuning Kafka configuration for optimal performance.</p>
</div>
<div class="paragraph">
<p>Upgrade instructions are provided for both Strimzi and Kafka, to help keep your deployment up to date.</p>
</div>
<div class="paragraph">
<p>Strimzi is designed to be compatible with all types of Kubernetes clusters, irrespective of their distribution.
Whether your deployment involves public or private clouds, or if you are setting up a local development environment, the instructions in this guide are applicable in all cases.</p>
</div>
<div class="sect2">
<h3 id="assembly-custom-resources-str"><a class="link" href="#assembly-custom-resources-str">1.1. Strimzi custom resources</a></h3>
<div class="paragraph _abstract">
<p>Deployment of Kafka components to a Kubernetes cluster using Strimzi is highly configurable through the application of custom resources.
These custom resources are created as instances of APIs added by Custom Resource Definitions (CRDs) to extend Kubernetes resources.</p>
</div>
<div class="paragraph">
<p>CRDs act as configuration instructions to describe the custom resources in a Kubernetes cluster,
and are provided with Strimzi for each Kafka component used in a deployment, as well as users and topics.
CRDs and custom resources are defined as YAML files.
Example YAML files are provided with the Strimzi distribution.</p>
</div>
<div class="paragraph">
<p>CRDs also allow Strimzi resources to benefit from native Kubernetes features like CLI accessibility and configuration validation.</p>
</div>
<div class="sect3">
<h4 id="con-custom-resources-example-str"><a class="link" href="#con-custom-resources-example-str">1.1.1. Strimzi custom resource example</a></h4>
<div class="paragraph _abstract">
<p>CRDs require a one-time installation in a cluster to define the schemas used to instantiate and manage Strimzi-specific resources.</p>
</div>
<div class="paragraph">
<p>After a new custom resource type is added to your cluster by installing a CRD, you can create instances of the resource based on its specification.</p>
</div>
<div class="paragraph">
<p>Depending on the cluster setup, installation typically requires cluster admin privileges.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Access to manage custom resources is limited to Strimzi administrators. For more information, see <a href="#adding-users-the-strimzi-admin-role-str">Designating Strimzi administrators</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A CRD defines a new <code>kind</code> of resource, such as <code>kind:Kafka</code>, within a Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>The Kubernetes API server allows custom resources to be created based on the <code>kind</code> and understands from the CRD how to validate and store the custom resource when it is added to the Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>Each Strimzi-specific custom resource conforms to the schema defined by the CRD for the resource&#8217;s <code>kind</code>.
The custom resources for Strimzi components have common configuration properties, which are defined under <code>spec</code>.</p>
</div>
<div class="paragraph">
<p>To understand the relationship between a CRD and a custom resource, let&#8217;s look at a sample of the CRD for a Kafka topic.</p>
</div>
<div class="listingblock">
<div class="title">Kafka topic CRD</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: CustomResourceDefinition
metadata: <b class="conum">(1)</b>
  name: kafkatopics.kafka.strimzi.io
  labels:
    app: strimzi
spec: <b class="conum">(2)</b>
  group: kafka.strimzi.io
  versions:
    v1beta2
  scope: Namespaced
  names:
    # ...
    singular: kafkatopic
    plural: kafkatopics
    shortNames:
    - kt <b class="conum">(3)</b>
  additionalPrinterColumns: <b class="conum">(4)</b>
      # ...
  subresources:
    status: {} <b class="conum">(5)</b>
  validation: <b class="conum">(6)</b>
    openAPIV3Schema:
      properties:
        spec:
          type: object
          properties:
            partitions:
              type: integer
              minimum: 1
            replicas:
              type: integer
              minimum: 1
              maximum: 32767
      # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The metadata for the topic CRD, its name and a label to identify the CRD.</p>
</li>
<li>
<p>The specification for this CRD, including the group (domain) name, the plural name and the supported schema version, which are used in the URL to access the API of the topic. The other names are used to identify instance resources in the CLI. For example, <code>kubectl get kafkatopic my-topic</code> or <code>kubectl get kafkatopics</code>.</p>
</li>
<li>
<p>The shortname can be used in CLI commands. For example, <code>kubectl get kt</code> can be used as an abbreviation instead of <code>kubectl get kafkatopic</code>.</p>
</li>
<li>
<p>The information presented when using a <code>get</code> command on the custom resource.</p>
</li>
<li>
<p>The current status of the CRD as described in the <a href="./configuring.html#type-Kafka-reference" target="_blank" rel="noopener">schema reference</a> for the resource.</p>
</li>
<li>
<p>openAPIV3Schema validation provides validation for the creation of topic custom resources. For example, a topic requires at least one partition and one replica.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You can identify the CRD YAML files supplied with the Strimzi installation files, because the file names contain an index number followed by ‘Crd’.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is a corresponding example of a <code>KafkaTopic</code> custom resource.</p>
</div>
<div class="listingblock">
<div class="title">Kafka topic custom resource</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic <b class="conum">(1)</b>
metadata:
  name: my-topic
  labels:
    strimzi.io/cluster: my-cluster <b class="conum">(2)</b>
spec: <b class="conum">(3)</b>
  partitions: 1
  replicas: 1
  config:
    retention.ms: 7200000
    segment.bytes: 1073741824
status:
  conditions: <b class="conum">(4)</b>
    lastTransitionTime: "2019-08-20T11:37:00.706Z"
    status: "True"
    type: Ready
  observedGeneration: 1
  / ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>kind</code> and <code>apiVersion</code> identify the CRD of which the custom resource is an instance.</p>
</li>
<li>
<p>A label, applicable only to <code>KafkaTopic</code> and <code>KafkaUser</code> resources, that defines the name of the Kafka cluster (which is same as the name of the <code>Kafka</code> resource) to which a topic or user belongs.</p>
</li>
<li>
<p>The spec shows the number of partitions and replicas for the topic as well as the configuration parameters for the topic itself. In this example, the retention period for a message to remain in the topic and the segment file size for the log are specified.</p>
</li>
<li>
<p>Status conditions for the <code>KafkaTopic</code> resource. The <code>type</code> condition changed to <code>Ready</code> at the <code>lastTransitionTime</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Custom resources can be applied to a cluster through the platform CLI.
When the custom resource is created, it uses the same validation as the built-in resources of the Kubernetes API.</p>
</div>
<div class="paragraph">
<p>After a <code>KafkaTopic</code> custom resource is created, the Topic Operator is notified and corresponding Kafka topics are created in Strimzi.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/" target="_blank" rel="noopener">Extend the Kubernetes API with CustomResourceDefinitions</a></p>
</li>
<li>
<p><a href="#config-examples-str">Example configuration files provided with Strimzi</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-operators-str"><a class="link" href="#assembly-operators-str">1.2. Strimzi operators</a></h3>
<div class="paragraph _abstract">
<p>Strimzi operators are purpose-built with specialist operational knowledge to effectively manage Kafka on Kubernetes.
Each operator performs a distinct function.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Cluster Operator</dt>
<dd>
<p>The Cluster Operator handles the deployment and management of Apache Kafka clusters on Kubernetes.
It automates the setup of Kafka brokers, and other Kafka components and resources.</p>
</dd>
<dt class="hdlist1">Topic Operator</dt>
<dd>
<p>The Topic Operator manages the creation, configuration, and deletion of topics within Kafka clusters.</p>
</dd>
<dt class="hdlist1">User Operator</dt>
<dd>
<p>The User Operator manages Kafka users that require access to Kafka brokers.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>When you deploy Strimzi, you first deploy the Cluster Operator.
The Cluster Operator is then ready to handle the deployment of Kafka.
You can also deploy the Topic Operator and User Operator using the Cluster Operator (recommended) or as standalone operators.
You would use a standalone operator with a Kafka cluster that is not managed by the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>The Topic Operator and User Operator are part of the Entity Operator.
The Cluster Operator can deploy one or both operators based on the Entity Operator configuration.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>To deploy the standalone operators, you need to set environment variables to connect to a Kafka cluster.
These environment variables do not need to be set if you are deploying the operators using the Cluster Operator as they will be set by the Cluster Operator.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="con-operators-namespaces-str"><a class="link" href="#con-operators-namespaces-str">1.2.1. Watching Strimzi resources in Kubernetes namespaces</a></h4>
<div class="paragraph _abstract">
<p>Operators watch and manage Strimzi resources in Kubernetes namespaces.
The Cluster Operator can watch a single namespace, multiple namespaces, or all namespaces in a Kubernetes cluster.
The Topic Operator and User Operator can watch a single namespace.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Cluster Operator watches for <code>Kafka</code> resources</p>
</li>
<li>
<p>The Topic Operator watches for <code>KafkaTopic</code> resources</p>
</li>
<li>
<p>The User Operator watches for <code>KafkaUser</code> resources</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Topic Operator and the User Operator can only watch a single Kafka cluster in a namespace.
And they can only be connected to a single Kafka cluster.</p>
</div>
<div class="paragraph">
<p>If multiple Topic Operators watch the same namespace, name collisions and topic deletion can occur.
This is because each Kafka cluster uses Kafka topics that have the same name (such as <code>__consumer_offsets</code>).
Make sure that only one Topic Operator watches a given namespace.</p>
</div>
<div class="paragraph">
<p>When using multiple User Operators with a single namespace, a user with a given username can exist in more than one Kafka cluster.</p>
</div>
<div class="paragraph">
<p>If you deploy the Topic Operator and User Operator using the Cluster Operator, they watch the Kafka cluster deployed by the Cluster Operator by default.
You can also specify a namespace using <code>watchedNamespace</code> in the operator configuration.</p>
</div>
<div class="paragraph">
<p>For a standalone deployment of each operator, you specify a namespace and connection to the Kafka cluster to watch in the configuration.</p>
</div>
</div>
<div class="sect3">
<h4 id="ref-operator-cluster-rbac-resources-str"><a class="link" href="#ref-operator-cluster-rbac-resources-str">1.2.2. Managing RBAC resources</a></h4>
<div class="paragraph _abstract">
<p>The Cluster Operator creates and manages role-based access control (RBAC) resources for Strimzi components that need access to Kubernetes resources.</p>
</div>
<div class="paragraph">
<p>For the Cluster Operator to function, it needs permission within the Kubernetes cluster to interact with Kafka resources, such as <code>Kafka</code> and <code>KafkaConnect</code>, as well as managed resources like <code>ConfigMap</code>, <code>Pod</code>, <code>Deployment</code>, and <code>Service</code>.</p>
</div>
<div class="paragraph">
<p>Permission is specified through the following Kubernetes RBAC resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ServiceAccount</code></p>
</li>
<li>
<p><code>Role</code> and <code>ClusterRole</code></p>
</li>
<li>
<p><code>RoleBinding</code> and <code>ClusterRoleBinding</code></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="delegated-privileges-str"><a class="link" href="#delegated-privileges-str">Delegating privileges to Strimzi components</a></h5>
<div class="paragraph">
<p>The Cluster Operator runs under a service account called <code>strimzi-cluster-operator</code>.
It is assigned cluster roles that give it permission to create the RBAC resources for Strimzi components.
Role bindings associate the cluster roles with the service account.</p>
</div>
<div class="paragraph">
<p>Kubernetes prevents components operating under one <code>ServiceAccount</code> from granting another <code>ServiceAccount</code> privileges that the granting <code>ServiceAccount</code> does not have.
Because the Cluster Operator creates the <code>RoleBinding</code> and <code>ClusterRoleBinding</code> RBAC resources needed by the resources it manages, it requires a role that gives it the same privileges.</p>
</div>
<div class="paragraph">
<p>The following sections describe the RBAC resources required by the Cluster Operator.</p>
</div>
</div>
<div class="sect4">
<h5 id="clusterrole_resources"><a class="link" href="#clusterrole_resources"><code>ClusterRole</code> resources</a></h5>
<div class="paragraph">
<p>The Cluster Operator uses <code>ClusterRole</code> resources to provide the necessary access to resources.
Depending on the Kubernetes cluster setup, a cluster administrator might be needed to create the cluster roles.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Cluster administrator rights are only needed for the creation of <code>ClusterRole</code> resources.
The Cluster Operator will not run under a cluster admin account.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The RBAC resources follow the <em>principle of least privilege</em> and contain only those privileges needed by the Cluster Operator to operate the cluster of the Kafka component.</p>
</div>
<div class="paragraph">
<p>All cluster roles are required by the Cluster Operator in order to delegate privileges.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. <code>ClusterRole</code> resources</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-cluster-operator-namespaced</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access rights for namespace-scoped resources used by the Cluster Operator to deploy and manage the operands.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-cluster-operator-global</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access rights for cluster-scoped resources used by the Cluster Operator to deploy and manage the operands.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-cluster-operator-leader-election</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access rights used by the Cluster Operator for leader election.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-cluster-operator-watched</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access rights used by the Cluster Operator to watch and manage the Strimzi custom resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-kafka-broker</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access rights to allow Kafka brokers to get the topology labels from Kubernetes worker nodes when rack-awareness is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-entity-operator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access rights used by the Topic and User Operators to manage Kafka users and topics.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-kafka-client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access rights to allow Kafka Connect, MirrorMaker (1 and 2), and Kafka Bridge to get the topology labels from Kubernetes worker nodes when rack-awareness is used.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="clusterrolebinding_resources"><a class="link" href="#clusterrolebinding_resources"><code>ClusterRoleBinding</code> resources</a></h5>
<div class="paragraph">
<p>The Cluster Operator uses <code>ClusterRoleBinding</code> and <code>RoleBinding</code> resources to associate its <code>ClusterRole</code> with its <code>ServiceAccount</code>.
Cluster role bindings are required by cluster roles containing cluster-scoped resources.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. <code>ClusterRoleBinding</code> resources</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-cluster-operator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grants the Cluster Operator the rights from the <code>strimzi-cluster-operator-global</code> cluster role.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-cluster-operator-kafka-broker-delegation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grants the Cluster Operator the rights from the <code>strimzi-entity-operator</code> cluster role.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-cluster-operator-kafka-client-delegation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grants the Cluster Operator the rights from the <code>strimzi-kafka-client</code> cluster role.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. <code>RoleBinding</code> resources</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-cluster-operator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grants the Cluster Operator the rights from the <code>strimzi-cluster-operator-namespaced</code> cluster role.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-cluster-operator-leader-election</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grants the Cluster Operator the rights from the <code>strimzi-cluster-operator-leader-election</code> cluster role.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-cluster-operator-watched</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grants the Cluster Operator the rights from the <code>strimzi-cluster-operator-watched</code> cluster role.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-cluster-operator-entity-operator-delegation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grants the Cluster Operator the rights from the <code>strimzi-cluster-operator-entity-operator-delegation</code> cluster role.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="serviceaccount_resources"><a class="link" href="#serviceaccount_resources"><code>ServiceAccount</code> resources</a></h5>
<div class="paragraph">
<p>The Cluster Operator runs using the <code>strimzi-cluster-operator</code> <code>ServiceAccount</code>.
This service account grants it the privileges it requires to manage the operands.
The Cluster Operator creates additional <code>ClusterRoleBinding</code> and <code>RoleBinding</code> resources to delegate some of these RBAC rights to the operands.</p>
</div>
<div class="paragraph">
<p>Each of the operands uses its own service account created by the Cluster Operator.
This allows the Cluster Operator to follow the principle of least privilege and give the operands only the access rights that are really need.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. <code>ServiceAccount</code> resources</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Used by</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;cluster_name&gt;-zookeeper</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ZooKeeper pods</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;cluster_name&gt;-kafka</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka broker pods</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;cluster_name&gt;-entity-operator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entity Operator</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;cluster_name&gt;-cruise-control</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cruise Control pods</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;cluster_name&gt;-kafka-exporter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Exporter pods</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;cluster_name&gt;-connect</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Connect pods</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;cluster_name&gt;-mirror-maker</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MirrorMaker pods</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;cluster_name&gt;-mirrormaker2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MirrorMaker 2 pods</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;cluster_name&gt;-bridge</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Bridge pods</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-kafka-bridge-concepts-str"><a class="link" href="#con-kafka-bridge-concepts-str">1.3. Using the Kafka Bridge to connect with a Kafka cluster</a></h3>
<div class="paragraph _abstract">
<p>You can use the Strimzi Kafka Bridge API to create and manage consumers and send and receive records over HTTP rather than the native Kafka protocol.</p>
</div>
<div class="paragraph">
<p>When you set up the Kafka Bridge you configure HTTP access to the Kafka cluster.
You can then use the Kafka Bridge to produce and consume messages from the cluster, as well as performing other operations through its REST interface.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For information on installing and using the Kafka Bridge, see <a href="https://strimzi.io/docs/bridge/latest/" target="_blank" rel="noopener">Using the Strimzi Kafka Bridge</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="assembly-fips-support-str"><a class="link" href="#assembly-fips-support-str">1.4. Seamless FIPS support</a></h3>
<div class="paragraph _abstract">
<p>Federal Information Processing Standards (FIPS) are standards for computer security and interoperability.
When running Strimzi on a FIPS-enabled Kubernetes cluster, the OpenJDK used in Strimzi container images automatically switches to FIPS mode.
From version 0.33, Strimzi can run on FIPS-enabled Kubernetes clusters without any changes or special configuration.
It uses only the FIPS-compliant security libraries from the OpenJDK.</p>
</div>
<div class="paragraph">
<div class="title">Minimum password length</div>
<p>When running in the FIPS mode, SCRAM-SHA-512 passwords need to be at least 32 characters long.
From Strimzi 0.33, the default password length in Strimzi User Operator is set to 32 characters as well.
If you have a Kafka cluster with custom configuration that uses a password length that is less than 32 characters, you need to update your configuration.
If you have any users with passwords shorter than 32 characters, you need to regenerate a password with the required length.
You can do that, for example, by deleting the user secret and waiting for the User Operator to create a new password with the appropriate length.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
If you are using FIPS-enabled Kubernetes clusters, you may experience higher memory consumption compared to regular Kubernetes clusters.
To avoid any issues, we suggest increasing the memory request to at least 512Mi.
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#proc-disabling-fips-mode-cluster-operator-str">Disabling FIPS mode using Cluster Operator configuration</a></p>
</li>
<li>
<p><a href="https://www.nist.gov/standardsgov/compliance-faqs-federal-information-processing-standards-fips" target="_blank" rel="noopener">What are Federal Information Processing Standards (FIPS)</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="document-conventions-str"><a class="link" href="#document-conventions-str">1.5. Document Conventions</a></h3>
<div class="paragraph">
<div class="title">User-replaced values</div>
<p>User-replaced values, also known as <em>replaceables</em>, are shown in with angle brackets (&lt; &gt;).
Underscores ( _ ) are used for multi-word values.
If the value refers to code or commands, <code>monospace</code> is also used.</p>
</div>
<div class="paragraph">
<p>For example, the following code shows that <code><em>&lt;my_namespace&gt;</em></code> must be replaced by the correct namespace name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i 's/namespace: .*/namespace: &lt;my_namespace&gt;/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
</div>
<div class="sect2 _additional-resources">
<h3 id="additional_resources"><a class="link" href="#additional_resources">1.6. Additional resources</a></h3>
<div class="ulist">
<ul>
<li>
<p><a href="./overview.html" target="_blank" rel="noopener">Strimzi Overview</a></p>
</li>
<li>
<p><a href="./configuring.html" target="_blank" rel="noopener">Strimzi Custom Resource API Reference</a></p>
</li>
<li>
<p><a href="https://strimzi.io/docs/bridge/latest/" target="_blank" rel="noopener">Using the Strimzi Kafka Bridge</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="con-strimzi-installation-methods_str"><a class="link" href="#con-strimzi-installation-methods_str">2. Strimzi installation methods</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>You can install Strimzi on Kubernetes 1.21 and later in three ways.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Installation method</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#deploy-tasks_str">Installation artifacts (YAML files)</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Download the release artifacts from the <a href="https://github.com/strimzi/strimzi-kafka-operator/releases" target="_blank" rel="noopener">GitHub releases page</a>.</p>
</div>
<div class="paragraph">
<p>Download the <code>strimzi-<em>&lt;version&gt;</em>.zip</code> or <code>strimzi-<em>&lt;version&gt;</em>.tar.gz</code> archive file.
The archive file contains installation artifacts and example configuration files.</p>
</div>
<div class="paragraph">
<p>Deploy the YAML installation artifacts to your Kubernetes cluster using <code>kubectl</code>.
You start by deploying the Cluster Operator from <code>install/cluster-operator</code> to a single namespace, multiple namespaces, or all namespaces.</p>
</div>
<div class="paragraph">
<p>You can also use the <code>install/</code> artifacts to deploy the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Strimi administrator roles (<code>strimzi-admin</code>)</p>
</li>
<li>
<p>A standalone Topic Operator (<code>topic-operator</code>)</p>
</li>
<li>
<p>A standalone User Operator (<code>user-operator</code>)</p>
</li>
<li>
<p>Strimzi Drain Cleaner (<code>drain-cleaner</code>)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#deploying-strimzi-from-operator-hub-str">OperatorHub.io</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use the <strong>Strimzi Kafka</strong> operator in the OperatorHub.io to deploy the Cluster Operator. You then deploy Strimzi components using custom resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#deploying-cluster-operator-helm-chart-str">Helm chart</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use a Helm chart to deploy the Cluster Operator. You then deploy Strimzi components using custom resources.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For the greatest flexibility, choose the installation artifacts method.
The OperatorHub.io method provides a standard configuration and allows you to take advantage of automatic updates.
Helm charts provide a convenient way to manage the installation of applications.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-options_str"><a class="link" href="#deploy-options_str">3. What is deployed with Strimzi</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Apache Kafka components are provided for deployment to Kubernetes with the Strimzi distribution.
The Kafka components are generally run as clusters for availability.</p>
</div>
<div class="paragraph">
<p>A typical deployment incorporating Kafka components might include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Kafka</strong> cluster of broker nodes</p>
</li>
<li>
<p><strong>ZooKeeper</strong> cluster of replicated ZooKeeper instances</p>
</li>
<li>
<p><strong>Kafka Connect</strong> cluster for external data connections</p>
</li>
<li>
<p><strong>Kafka MirrorMaker</strong> cluster to mirror the Kafka cluster in a secondary cluster</p>
</li>
<li>
<p><strong>Kafka Exporter</strong> to extract additional Kafka metrics data for monitoring</p>
</li>
<li>
<p><strong>Kafka Bridge</strong> to make HTTP-based requests to the Kafka cluster</p>
</li>
<li>
<p><strong>Cruise Control</strong> to rebalance topic partitions across broker nodes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Not all of these components are mandatory, though you need Kafka and ZooKeeper as a minimum.
Some components can be deployed without Kafka, such as MirrorMaker or Kafka Connect.</p>
</div>
<div class="sect2">
<h3 id="deploy-options-order-str"><a class="link" href="#deploy-options-order-str">3.1. Order of deployment</a></h3>
<div class="paragraph _abstract">
<p>The required order of deployment to a Kubernetes cluster is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Deploy the Cluster Operator to manage your Kafka cluster</p>
</li>
<li>
<p>Deploy the Kafka cluster with the ZooKeeper cluster, and include the Topic Operator and User Operator in the deployment</p>
</li>
<li>
<p>Optionally deploy:</p>
<div class="ulist">
<ul>
<li>
<p>The Topic Operator and User Operator standalone if you did not deploy them with the Kafka cluster</p>
</li>
<li>
<p>Kafka Connect</p>
</li>
<li>
<p>Kafka MirrorMaker</p>
</li>
<li>
<p>Kafka Bridge</p>
</li>
<li>
<p>Components for the monitoring of metrics</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Cluster Operator creates Kubernetes resources for the components,
such as <code>Deployment</code>, <code>Service</code>, and <code>Pod</code> resources.
The names of the Kubernetes resources are appended with the name specified for a component when it&#8217;s deployed.
For example, a Kafka cluster named <code>my-kafka-cluster</code> has a service named <code>my-kafka-cluster-kafka</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-tasks-prereqs_str"><a class="link" href="#deploy-tasks-prereqs_str">4. Preparing for your Strimzi deployment</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Prepare for a deployment of Strimzi by completing any necessary pre-deployment tasks.
Take the necessary preparatory steps according to your specific requirements, such as the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#deploy-prereqs-str">Ensuring you have the necessary prerequisites before deploying Strimzi</a></p>
</li>
<li>
<p><a href="#downloads-str">Downloading the Strimzi release artifacts to facilitate your deployment</a></p>
</li>
<li>
<p><a href="#container-images-str">Pushing the Strimzi container images into your own registry (if required)</a></p>
</li>
<li>
<p><a href="#adding-users-the-strimzi-admin-role-str">Setting up admin roles to enable configuration of custom resources used in the deployment</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
To run the commands in this guide, your cluster user must have the rights to manage role-based access control (RBAC) and CRDs.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="deploy-prereqs-str"><a class="link" href="#deploy-prereqs-str">4.1. Deployment prerequisites</a></h3>
<div class="paragraph">
<p>To deploy Strimzi, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Kubernetes 1.21 and later cluster.</p>
</li>
<li>
<p>The <code>kubectl</code> command-line tool is installed and configured to connect to the running cluster.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information on the tools available for running Kubernetes, see <a href="https://kubernetes.io/docs/tasks/tools/" target="_blank" rel="noopener">Install Tools</a> in the Kubernetes documentation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Strimzi supports some features that are specific to OpenShift,
where such integration benefits OpenShift users and there is no equivalent implementation using standard Kubernetes.
</td>
</tr>
</table>
</div>
<h4 id="oc_and_kubectl_commands" class="discrete"><code>oc</code> and <code>kubectl</code> commands</h4>
<div class="paragraph">
<p>The <code>oc</code> command functions as an alternative to <code>kubectl</code>.
In almost all cases the example <code>kubectl</code> commands used in this guide can be done using <code>oc</code> simply by replacing the command name (options and arguments remain the same).</p>
</div>
<div class="paragraph">
<p>In other words, instead of using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>your-file</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>when using OpenShift you can use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc apply -f <em>your-file</em></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
As an exception to this general rule, <code>oc</code> uses <code>oc adm</code> subcommands for <em>cluster management</em> functionality,
whereas <code>kubectl</code> does not make this distinction.
For example, the <code>oc</code> equivalent of <code>kubectl taint</code> is <code>oc adm taint</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="con-deploy-operator-best-practices-str"><a class="link" href="#con-deploy-operator-best-practices-str">4.2. Operator deployment best practices</a></h3>
<div class="paragraph _abstract">
<p>Potential issues can arise from installing more than one Strimzi operator in the same Kubernetes cluster, especially when using different versions.
Each Strimzi operator manages a set of resources in a Kubernetes cluster.
When you install multiple Strimzi operators, they may attempt to manage the same resources concurrently.
This can lead to conflicts and unpredictable behavior within your cluster.
Conflicts can still occur even if you deploy Strimzi operators in different namespaces within the same Kubernetes cluster.
Although namespaces provide some degree of resource isolation, certain resources managed by the Strimzi operator, such as Custom Resource Definitions (CRDs) and roles, have a cluster-wide scope.</p>
</div>
<div class="paragraph">
<p>Additionally, installing multiple operators with different versions can result in compatibility issues between the operators and the Kafka clusters they manage.
Different versions of Strimzi operators may introduce changes, bug fixes, or improvements that are not backward-compatible.</p>
</div>
<div class="paragraph">
<p>To avoid the issues associated with installing multiple Strimzi operators in a Kubernetes cluster, the following guidelines are recommended:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Install the Strimzi operator in a separate namespace from the Kafka cluster and other Kafka components it manages, to ensure clear separation of resources and configurations.</p>
</li>
<li>
<p>Use a single Strimzi operator to manage all your Kafka instances within a Kubernetes cluster.</p>
</li>
<li>
<p>Update the Strimzi operator and the supported Kafka version as often as possible to reflect the latest features and enhancements.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By following these best practices and ensuring consistent updates for a single Strimzi operator, you can enhance the stability of managing Kafka instances in a Kubernetes cluster.
This approach also enables you to make the most of Strimzi&#8217;s latest features and capabilities.</p>
</div>
</div>
<div class="sect2">
<h3 id="downloads-str"><a class="link" href="#downloads-str">4.3. Downloading Strimzi release artifacts</a></h3>
<div class="paragraph _abstract">
<p>To use deployment files to install Strimzi, download and extract the files from the <a href="https://github.com/strimzi/strimzi-kafka-operator/releases" target="_blank" rel="noopener">GitHub releases page</a>.</p>
</div>
<div class="paragraph">
<p>Strimzi release artifacts include sample YAML files to help you deploy the components of Strimzi to Kubernetes, perform common operations,
and configure your Kafka cluster.</p>
</div>
<div class="paragraph">
<p>Use <code>kubectl</code> to deploy the Cluster Operator from the <code>install/cluster-operator</code> folder of the downloaded ZIP file.
For more information about deploying and configuring the Cluster Operator, see <a href="#cluster-operator-str">Deploying the Cluster Operator</a>.</p>
</div>
<div class="paragraph">
<p>In addition, if you want to use standalone installations of the Topic and User Operators with a Kafka cluster that is not managed by the Strimzi Cluster Operator, you can deploy them from the <code>install/topic-operator</code> and <code>install/user-operator</code> folders.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Strimzi container images are also available through the <a href="https://quay.io/organization/strimzi" target="_blank" rel="noopener">Container Registry</a>.
However, we recommend that you use the YAML files provided to deploy Strimzi.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="container-images-str"><a class="link" href="#container-images-str">4.4. Pushing container images to your own registry</a></h3>
<div class="paragraph">
<p>Container images for Strimzi are available in the <a href="https://quay.io/organization/strimzi" target="_blank" rel="noopener">Container Registry</a>.
The installation YAML files provided by Strimzi will pull the images directly from the <a href="https://quay.io/organization/strimzi" target="_blank" rel="noopener">Container Registry</a>.</p>
</div>
<div class="paragraph">
<p>If you do not have access to the <a href="https://quay.io/organization/strimzi" target="_blank" rel="noopener">Container Registry</a> or want to use your own container repository:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pull <strong>all</strong> container images listed here</p>
</li>
<li>
<p>Push them into your own registry</p>
</li>
<li>
<p>Update the image names in the YAML files used in deployment</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Each Kafka version supported for the release has a separate image.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Container image</th>
<th class="tableblock halign-left valign-top">Namespace/Repository</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>quay.io/strimzi/kafka:0.39.0-kafka-3.5.0</p>
</li>
<li>
<p>quay.io/strimzi/kafka:0.39.0-kafka-3.5.1</p>
</li>
<li>
<p>quay.io/strimzi/kafka:0.39.0-kafka-3.5.2</p>
</li>
<li>
<p>quay.io/strimzi/kafka:0.39.0-kafka-3.6.0</p>
</li>
<li>
<p>quay.io/strimzi/kafka:0.39.0-kafka-3.6.1</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Strimzi image for running Kafka, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kafka Broker</p>
</li>
<li>
<p>Kafka Connect</p>
</li>
<li>
<p>Kafka MirrorMaker</p>
</li>
<li>
<p>ZooKeeper</p>
</li>
<li>
<p>TLS Sidecars</p>
</li>
<li>
<p>Cruise Control</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operator</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>quay.io/strimzi/operator:0.39.0</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Strimzi image for running the operators:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cluster Operator</p>
</li>
<li>
<p>Topic Operator</p>
</li>
<li>
<p>User Operator</p>
</li>
<li>
<p>Kafka Initializer</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Bridge</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>quay.io/strimzi/kafka-bridge:0.27.0</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Strimzi image for running the Strimzi kafka Bridge</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Strimzi Drain Cleaner</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>quay.io/strimzi/drain-cleaner:1.0.1</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Strimzi image for running the Strimzi Drain Cleaner</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="adding-users-the-strimzi-admin-role-str"><a class="link" href="#adding-users-the-strimzi-admin-role-str">4.5. Designating Strimzi administrators</a></h3>
<div class="paragraph">
<p>Strimzi provides custom resources for configuration of your deployment.
By default, permission to view, create, edit, and delete these resources is limited to Kubernetes cluster administrators.
Strimzi provides two cluster roles that you can use to assign these rights to other users:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>strimzi-view</code> allows users to view and list Strimzi resources.</p>
</li>
<li>
<p><code>strimzi-admin</code> allows users to also create, edit or delete Strimzi resources.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you install these roles, they will automatically aggregate (add) these rights to the default Kubernetes cluster roles.
<code>strimzi-view</code> aggregates to the <code>view</code> role, and <code>strimzi-admin</code> aggregates to the <code>edit</code> and <code>admin</code> roles.
Because of the aggregation, you might not need to assign these roles to users who already have similar rights.</p>
</div>
<div class="paragraph">
<p>The following procedure shows how to assign a <code>strimzi-admin</code> role that allows non-cluster administrators to manage Strimzi resources.</p>
</div>
<div class="paragraph">
<p>A system administrator can designate Strimzi administrators after the Cluster Operator is deployed.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Strimzi Custom Resource Definitions (CRDs) and role-based access control (RBAC) resources to manage the CRDs have been <a href="#cluster-operator-str">deployed with the Cluster Operator</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create the <code>strimzi-view</code> and <code>strimzi-admin</code> cluster roles in Kubernetes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/strimzi-admin</code></pre>
</div>
</div>
</li>
<li>
<p>If needed, assign the roles that provide access rights to users that require them.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create clusterrolebinding strimzi-admin --clusterrole=strimzi-admin --user=<em>user1</em> --user=<em>user2</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-tasks_str"><a class="link" href="#deploy-tasks_str">5. Deploying Strimzi using installation artifacts</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Having <a href="#deploy-tasks-prereqs_str">prepared your environment for a deployment of Strimzi</a>, you can deploy Strimzi to a Kubernetes cluster.
Use the installation files provided with the release artifacts.</p>
</div>
<div class="paragraph">
<p>You can deploy Strimzi 0.39.0 on Kubernetes 1.21 and later.</p>
</div>
<div class="paragraph">
<p>The steps to deploy Strimzi using the installation files are as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#cluster-operator-str">Deploy the Cluster Operator</a></p>
</li>
<li>
<p>Use the Cluster Operator to deploy the following:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><a href="#kafka-cluster-str">Kafka cluster</a></p>
</li>
<li>
<p><a href="#deploying-the-topic-operator-using-the-cluster-operator-str">Topic Operator</a></p>
</li>
<li>
<p><a href="#deploying-the-user-operator-using-the-cluster-operator-str">User Operator</a></p>
</li>
</ol>
</div>
</li>
<li>
<p>Optionally, deploy the following Kafka components according to your requirements:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#kafka-connect-str">Kafka Connect</a></p>
</li>
<li>
<p><a href="#kafka-mirror-maker-str">Kafka MirrorMaker</a></p>
</li>
<li>
<p><a href="#kafka-bridge-str">Kafka Bridge</a></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
To run the commands in this guide, a Kubernetes user must have the rights to manage role-based access control (RBAC) and CRDs.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="con-deploy-paths-str"><a class="link" href="#con-deploy-paths-str">5.1. Basic deployment path</a></h3>
<div class="paragraph _abstract">
<p>You can set up a deployment where Strimzi manages a single Kafka cluster in the same namespace.
You might use this configuration for development or testing.
Or you can use Strimzi in a production environment to manage a number of Kafka clusters in different namespaces.</p>
</div>
<div class="paragraph">
<p>The first step for any deployment of Strimzi is to install the Cluster Operator using the <code>install/cluster-operator</code> files.</p>
</div>
<div class="paragraph">
<p>A single command applies all the installation files in the <code>cluster-operator</code> folder: <code>kubectl apply -f ./install/cluster-operator</code>.</p>
</div>
<div class="paragraph">
<p>The command sets up everything you need to be able to create and manage a Kafka deployment, including the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cluster Operator (<code>Deployment</code>, <code>ConfigMap</code>)</p>
</li>
<li>
<p>Strimzi CRDs (<code>CustomResourceDefinition</code>)</p>
</li>
<li>
<p>RBAC resources (<code>ClusterRole</code>, <code>ClusterRoleBinding</code>, <code>RoleBinding</code>)</p>
</li>
<li>
<p>Service account (<code>ServiceAccount</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The basic deployment path is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#downloads-str">Download the release artifacts</a></p>
</li>
<li>
<p>Create a Kubernetes namespace in which to deploy the Cluster Operator</p>
</li>
<li>
<p><a href="#cluster-operator-str">Deploy the Cluster Operator</a></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Update the <code>install/cluster-operator</code> files to use the namespace created for the Cluster Operator</p>
</li>
<li>
<p>Install the Cluster Operator to watch one, multiple, or all namespaces</p>
</li>
</ol>
</div>
</li>
<li>
<p><a href="#kafka-cluster-str">Create a Kafka cluster</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>After which, you can deploy other Kafka components and set up monitoring of your deployment.</p>
</div>
</div>
<div class="sect2">
<h3 id="cluster-operator-str"><a class="link" href="#cluster-operator-str">5.2. Deploying the Cluster Operator</a></h3>
<div class="paragraph _abstract">
<p>The Cluster Operator is responsible for deploying and managing Kafka clusters within a Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>When the Cluster Operator is running, it starts to watch for updates of Kafka resources.</p>
</div>
<div class="paragraph">
<p>By default, a single replica of the Cluster Operator is deployed.
You can add replicas with leader election so that additional Cluster Operators are on standby in case of disruption.
For more information, see <a href="#assembly-using-multiple-cluster-operator-replicas-str">Running multiple Cluster Operator replicas with leader election</a>.</p>
</div>
<div class="sect3">
<h4 id="con-cluster-operator-watch-options-str"><a class="link" href="#con-cluster-operator-watch-options-str">5.2.1. Specifying the namespaces the Cluster Operator watches</a></h4>
<div class="paragraph _abstract">
<p>The Cluster Operator watches for updates in the namespaces where the Kafka resources are deployed.
When you deploy the Cluster Operator, you specify which namespaces to watch in the Kubernetes cluster.
You can specify the following namespaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">A single selected namespace</a> (the same namespace containing the Cluster Operator)</p>
</li>
<li>
<p><a href="#deploying-cluster-operator-to-watch-multiple-namespaces-str">Multiple selected namespaces</a></p>
</li>
<li>
<p><a href="#deploying-cluster-operator-to-watch-whole-cluster-str">All namespaces in the cluster</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Watching multiple selected namespaces has the most impact on performance due to increased processing overhead.
To optimize performance for namespace monitoring, it is generally recommended to either watch a single namespace or monitor the entire cluster.
Watching a single namespace allows for focused monitoring of namespace-specific resources, while monitoring all namespaces provides a comprehensive view of the cluster&#8217;s resources across all namespaces.</p>
</div>
<div class="paragraph">
<p>The Cluster Operator watches for changes to the following resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Kafka</code> for the Kafka cluster.</p>
</li>
<li>
<p><code>KafkaConnect</code> for the Kafka Connect cluster.</p>
</li>
<li>
<p><code>KafkaConnector</code> for creating and managing connectors in a Kafka Connect cluster.</p>
</li>
<li>
<p><code>KafkaMirrorMaker</code> for the Kafka MirrorMaker instance.</p>
</li>
<li>
<p><code>KafkaMirrorMaker2</code> for the Kafka MirrorMaker 2 instance.</p>
</li>
<li>
<p><code>KafkaBridge</code> for the Kafka Bridge instance.</p>
</li>
<li>
<p><code>KafkaRebalance</code> for the Cruise Control optimization requests.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When one of these resources is created in the Kubernetes cluster, the operator gets the cluster description from the resource and starts creating a new cluster for the resource by creating the necessary Kubernetes resources, such as Deployments, Pods, Services and ConfigMaps.</p>
</div>
<div class="paragraph">
<p>Each time a Kafka resource is updated, the operator performs corresponding updates on the Kubernetes resources that make up the cluster for the resource.</p>
</div>
<div class="paragraph">
<p>Resources are either patched or deleted, and then recreated in order to make the cluster for the resource reflect the desired state of the cluster.
This operation might cause a rolling update that might lead to service disruption.</p>
</div>
<div class="paragraph">
<p>When a resource is deleted, the operator undeploys the cluster and deletes all related Kubernetes resources.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
While the Cluster Operator can watch one, multiple, or all namespaces in a Kubernetes cluster,
the Topic Operator and User Operator watch for <code>KafkaTopic</code> and <code>KafkaUser</code> resources in a single namespace.
For more information, see <a href="#con-operators-namespaces-str">Watching Strimzi resources in Kubernetes namespaces</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="deploying-cluster-operator-str"><a class="link" href="#deploying-cluster-operator-str">5.2.2. Deploying the Cluster Operator to watch a single namespace</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy the Cluster Operator to watch Strimzi resources in a single namespace in your Kubernetes cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You need an account with permission to create and manage <code>CustomResourceDefinition</code> and RBAC (<code>ClusterRole</code>, and <code>RoleBinding</code>) resources.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the Strimzi installation files to use the namespace the Cluster Operator is going to be installed into.</p>
<div class="paragraph">
<p>For example, in this procedure the Cluster Operator is installed into the namespace <code>my-cluster-operator-namespace</code>.</p>
</div>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i '' 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the Cluster Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/cluster-operator -n my-cluster-operator-namespace</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments -n my-cluster-operator-namespace</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the deployment name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                      READY  UP-TO-DATE  AVAILABLE
strimzi-cluster-operator  1/1    1           1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>AVAILABLE</code> output shows <code>1</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="deploying-cluster-operator-to-watch-multiple-namespaces-str"><a class="link" href="#deploying-cluster-operator-to-watch-multiple-namespaces-str">5.2.3. Deploying the Cluster Operator to watch multiple namespaces</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy the Cluster Operator to watch Strimzi resources across multiple namespaces in your Kubernetes cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You need an account with permission to create and manage <code>CustomResourceDefinition</code> and RBAC (<code>ClusterRole</code>, and <code>RoleBinding</code>) resources.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the Strimzi installation files to use the namespace the Cluster Operator is going to be installed into.</p>
<div class="paragraph">
<p>For example, in this procedure the Cluster Operator is installed into the namespace <code>my-cluster-operator-namespace</code>.</p>
</div>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i '' 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code> file
to add a list of all the namespaces the Cluster Operator will watch to the <code>STRIMZI_NAMESPACE</code> environment variable.</p>
<div class="paragraph">
<p>For example, in this  procedure the Cluster Operator will watch the namespaces <code>watched-namespace-1</code>, <code>watched-namespace-2</code>, <code>watched-namespace-3</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
spec:
  # ...
  template:
    spec:
      serviceAccountName: strimzi-cluster-operator
      containers:
      - name: strimzi-cluster-operator
        image: quay.io/strimzi/operator:0.39.0
        imagePullPolicy: IfNotPresent
        env:
        - name: STRIMZI_NAMESPACE
          value: watched-namespace-1,watched-namespace-2,watched-namespace-3</code></pre>
</div>
</div>
</li>
<li>
<p>For each namespace listed, install the <code>RoleBindings</code>.</p>
<div class="paragraph">
<p>In this example, we replace <code><em>watched-namespace</em></code> in these commands with the namespaces listed in the previous step,
repeating them for <code>watched-namespace-1</code>, <code>watched-namespace-2</code>, <code>watched-namespace-3</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/cluster-operator/020-RoleBinding-strimzi-cluster-operator.yaml -n <em>&lt;watched_namespace&gt;</em>
kubectl create -f install/cluster-operator/023-RoleBinding-strimzi-cluster-operator.yaml -n <em>&lt;watched_namespace&gt;</em>
kubectl create -f install/cluster-operator/031-RoleBinding-strimzi-cluster-operator-entity-operator-delegation.yaml -n <em>&lt;watched_namespace&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the Cluster Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/cluster-operator -n my-cluster-operator-namespace</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments -n my-cluster-operator-namespace</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the deployment name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                      READY  UP-TO-DATE  AVAILABLE
strimzi-cluster-operator  1/1    1           1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>AVAILABLE</code> output shows <code>1</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="deploying-cluster-operator-to-watch-whole-cluster-str"><a class="link" href="#deploying-cluster-operator-to-watch-whole-cluster-str">5.2.4. Deploying the Cluster Operator to watch all namespaces</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy the Cluster Operator to watch Strimzi resources across all namespaces in your Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>When running in this mode, the Cluster Operator automatically manages clusters in any new namespaces that are created.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You need an account with permission to create and manage <code>CustomResourceDefinition</code> and RBAC (<code>ClusterRole</code>, and <code>RoleBinding</code>) resources.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the Strimzi installation files to use the namespace the Cluster Operator is going to be installed into.</p>
<div class="paragraph">
<p>For example, in this procedure the Cluster Operator is installed into the namespace <code>my-cluster-operator-namespace</code>.</p>
</div>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i '' 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code> file to set the value of the <code>STRIMZI_NAMESPACE</code> environment variable to <code>*</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
spec:
  # ...
  template:
    spec:
      # ...
      serviceAccountName: strimzi-cluster-operator
      containers:
      - name: strimzi-cluster-operator
        image: quay.io/strimzi/operator:0.39.0
        imagePullPolicy: IfNotPresent
        env:
        - name: STRIMZI_NAMESPACE
          value: "*"
        # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Create <code>ClusterRoleBindings</code> that grant cluster-wide access for all namespaces to the Cluster Operator.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create clusterrolebinding strimzi-cluster-operator-namespaced --clusterrole=strimzi-cluster-operator-namespaced --serviceaccount my-cluster-operator-namespace:strimzi-cluster-operator
kubectl create clusterrolebinding strimzi-cluster-operator-watched --clusterrole=strimzi-cluster-operator-watched --serviceaccount my-cluster-operator-namespace:strimzi-cluster-operator
kubectl create clusterrolebinding strimzi-cluster-operator-entity-operator-delegation --clusterrole=strimzi-entity-operator --serviceaccount my-cluster-operator-namespace:strimzi-cluster-operator</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the Cluster Operator to your Kubernetes cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/cluster-operator -n my-cluster-operator-namespace</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments -n my-cluster-operator-namespace</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the deployment name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                      READY  UP-TO-DATE  AVAILABLE
strimzi-cluster-operator  1/1    1           1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>AVAILABLE</code> output shows <code>1</code>.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kafka-cluster-str"><a class="link" href="#kafka-cluster-str">5.3. Deploying Kafka</a></h3>
<div class="paragraph _abstract">
<p>To be able to manage a Kafka cluster with the Cluster Operator, you must deploy it as a <code>Kafka</code> resource.
Strimzi provides example deployment files to do this.
You can use these files to deploy the Topic Operator and User Operator at the same time.</p>
</div>
<div class="paragraph">
<p>After you have deployed the Cluster Operator, use a <code>Kafka</code> resource to deploy the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Kafka cluster that uses KRaft or ZooKeeper:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#deploying-kafka-node-pools-str">KRaft-based or ZooKeeper-based Kafka cluster with node pools</a></p>
</li>
<li>
<p><a href="#deploying-kafka-cluster-str">ZooKeeper-based Kafka cluster without node pools</a></p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#deploying-the-topic-operator-using-the-cluster-operator-str">Topic Operator</a></p>
</li>
<li>
<p><a href="#deploying-the-user-operator-using-the-cluster-operator-str">User Operator</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Node pools provide configuration for a set of Kafka nodes.
By using node pools, nodes can have different configuration within the same Kafka cluster.</p>
</div>
<div class="paragraph">
<p>If you haven&#8217;t deployed a Kafka cluster as a <code>Kafka</code> resource, you can&#8217;t use the Cluster Operator to manage it.
This applies, for example, to a Kafka cluster running outside of Kubernetes.
However, you can use the Topic Operator and User Operator with a Kafka cluster that is <strong>not managed</strong> by Strimzi, by <a href="#deploy-standalone-operators_str">deploying them as standalone components</a>.
You can also deploy and use other Kafka components with a Kafka cluster not managed by Strimzi.</p>
</div>
<div class="sect3">
<h4 id="deploying-kafka-node-pools-str"><a class="link" href="#deploying-kafka-node-pools-str">5.3.1. Deploying a Kafka cluster with node pools</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy Kafka with node pools to your Kubernetes cluster using the Cluster Operator.
Node pools represent a distinct group of Kafka nodes within a Kafka cluster that share the same configuration.
For each Kafka node in the node pool, any configuration not defined in node pool is inherited from the cluster configuration in the <code>kafka</code> resource.</p>
</div>
<div class="paragraph">
<p>The deployment uses a YAML file to provide the specification to create a <code>KafkaNodePool</code> resource.
You can use node pools with Kafka clusters that use KRaft (Kafka Raft metadata) mode or ZooKeeper for cluster management.
To deploy a Kafka cluster in KRaft mode, you must use the <code>KafkaNodePool</code> resources.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<strong>KRaft mode is not ready for production in Apache Kafka or in Strimzi.</strong>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Strimzi provides the following <a href="#config-examples-str">example files</a> that you can use to create a Kafka cluster that uses node pools:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>kafka-with-dual-role-kraft-nodes.yaml</code></dt>
<dd>
<p>Deploys a Kafka cluster with one pool of KRaft nodes that share the broker and controller roles.</p>
</dd>
<dt class="hdlist1"><code>kafka-with-kraft.yaml</code></dt>
<dd>
<p>Deploys a persistent Kafka cluster with one pool of controller nodes and one pool of broker nodes.</p>
</dd>
<dt class="hdlist1"><code>kafka-with-kraft-ephemeral.yaml</code></dt>
<dd>
<p>Deploys an ephemeral Kafka cluster with one pool of controller nodes and one pool of broker nodes.</p>
</dd>
<dt class="hdlist1"><code>kafka.yaml</code></dt>
<dd>
<p>Deploys ZooKeeper with 3 nodes, and 2 different pools of Kafka brokers. Each of the pools has 3 brokers. The pools in the example use different storage configuration.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You can perform the steps outlined here to deploy a new Kafka cluster with <code>KafkaNodePool</code> resources or <a href="#proc-migrating-clusters-node-pools-str">migrate your existing Kafka cluster</a>.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>If you want to use KRaft, enable the <code>UseKRaft</code> feature gate from the command line:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl set env deployment/strimzi-cluster-operator STRIMZI_FEATURE_GATES="+UseKRaft"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or by editing the Cluster Operator <code>Deployment</code> and updating the <code>STRIMZI_FEATURE_GATES</code> environment variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">env
  - name: STRIMZI_FEATURE_GATES
    value: +UseKRaft</code></pre>
</div>
</div>
<div class="paragraph">
<p>This updates the Cluster Operator.</p>
</div>
</li>
<li>
<p>Deploy a Kafka cluster with node pools</p>
<div class="ulist">
<ul>
<li>
<p>To deploy a Kafka cluster in KRaft mode with a  single node pool that uses dual-role nodes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/kafka/nodepools/kafka-with-dual-role-kraft-nodes.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>To deploy a persistent Kafka cluster in KRaft mode with separate node pools for broker and controller nodes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/kafka/nodepools/kafka-with-kraft.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>To deploy an ephemeral Kafka cluster in KRaft mode with separate node pools for broker and controller nodes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/kafka/nodepools/kafka-with-kraft-ephemeral.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>To deploy a Kafka cluster and ZooKeeper cluster with two node pools of three brokers:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/kafka/nodepools/kafka.yaml</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods -n <em>&lt;my_cluster_operator_namespace&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the node pool names and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                        READY  STATUS   RESTARTS
my-cluster-entity-operator  3/3    Running  0
my-cluster-pool-a-0         1/1    Running  0
my-cluster-pool-a-1         1/1    Running  0
my-cluster-pool-a-4         1/1    Running  0</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>my-cluster</code> is the name of the Kafka cluster.</p>
</li>
<li>
<p><code>pool-a</code> is the name of the node pool.</p>
<div class="paragraph">
<p>A sequential index number starting with <code>0</code> identifies each Kafka pod created.
If you are using ZooKeeper, you&#8217;ll also see the ZooKeeper pods.</p>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>STATUS</code> displays as <code>Running</code>.</p>
</div>
<div class="paragraph">
<p>Information on the deployment is also shown in the status of the <code>KafkaNodePool</code> resource, including a list of IDs for nodes in the pool.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Node IDs are assigned sequentially starting at 0 (zero) across all node pools within a cluster. This means that node IDs might not run sequentially within a specific node pool. If there are gaps in the sequence of node IDs across the cluster, the next node to be added is assigned an ID that fills the gap. When scaling down, the node with the highest node ID within a pool is removed.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph _additional-resources">
<div class="title">Additional resources</div>
<p><a href="#config-node-pools-str">Node pool configuration</a></p>
</div>
</div>
<div class="sect3">
<h4 id="deploying-kafka-cluster-str"><a class="link" href="#deploying-kafka-cluster-str">5.3.2. Deploying a ZooKeeper-based Kafka cluster without node pools</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy a ZooKeeper-based Kafka cluster to your Kubernetes cluster using the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>The deployment uses a YAML file to provide the specification to create a <code>Kafka</code> resource.</p>
</div>
<div class="paragraph">
<p>Strimzi provides the following <a href="#config-examples-str">example files</a> to create a Kafka cluster that uses ZooKeeper for cluster management:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>kafka-persistent.yaml</code></dt>
<dd>
<p>Deploys a persistent cluster with three ZooKeeper and three Kafka nodes.</p>
</dd>
<dt class="hdlist1"><code>kafka-jbod.yaml</code></dt>
<dd>
<p>Deploys a persistent cluster with three ZooKeeper and three Kafka nodes (each using multiple persistent volumes).</p>
</dd>
<dt class="hdlist1"><code>kafka-persistent-single.yaml</code></dt>
<dd>
<p>Deploys a persistent cluster with a single ZooKeeper node and a single Kafka node.</p>
</dd>
<dt class="hdlist1"><code>kafka-ephemeral.yaml</code></dt>
<dd>
<p>Deploys an ephemeral cluster with three ZooKeeper and three Kafka nodes.</p>
</dd>
<dt class="hdlist1"><code>kafka-ephemeral-single.yaml</code></dt>
<dd>
<p>Deploys an ephemeral cluster with three ZooKeeper nodes and a single Kafka node.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In this procedure, we use the examples for an <em>ephemeral</em> and <em>persistent</em> Kafka cluster deployment.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Ephemeral cluster</dt>
<dd>
<p>In general, an ephemeral (or temporary) Kafka cluster is suitable for development and testing purposes, not for production. This deployment uses <code>emptyDir</code> volumes for storing broker information (for ZooKeeper) and topics or partitions (for Kafka). Using an <code>emptyDir</code> volume means that its content is strictly related to the pod life cycle and is deleted when the pod goes down.</p>
</dd>
<dt class="hdlist1">Persistent cluster</dt>
<dd>
<p>A persistent Kafka cluster uses persistent volumes to store ZooKeeper and Kafka data. A <code>PersistentVolume</code> is acquired using a <code>PersistentVolumeClaim</code> to make it independent of the actual type of the <code>PersistentVolume</code>. The <code>PersistentVolumeClaim</code> can use a <code>StorageClass</code> to trigger automatic volume provisioning.
When no <code>StorageClass</code> is specified, Kubernetes will try to use the default <code>StorageClass</code>.</p>
<div class="paragraph">
<p>The following examples show some common types of persistent volumes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If your Kubernetes cluster runs on Amazon AWS, Kubernetes can provision Amazon EBS volumes</p>
</li>
<li>
<p>If your Kubernetes cluster runs on Microsoft Azure, Kubernetes can provision Azure Disk Storage volumes</p>
</li>
<li>
<p>If your Kubernetes cluster runs on Google Cloud, Kubernetes can provision Persistent Disk volumes</p>
</li>
<li>
<p>If your Kubernetes cluster runs on bare metal, Kubernetes can provision local persistent volumes</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The example YAML files specify the latest supported Kafka version, and configuration for its supported log message format version and inter-broker protocol version.
The <code>inter.broker.protocol.version</code> property for the Kafka <code>config</code> must be the version supported by the specified Kafka version (<code>spec.kafka.version</code>).
The property represents the version of Kafka protocol used in a Kafka cluster.</p>
</div>
<div class="paragraph">
<p>From Kafka 3.0.0, when the <code>inter.broker.protocol.version</code> is set to <code>3.0</code> or higher, the <code>log.message.format.version</code> option is ignored and doesn&#8217;t need to be set.</p>
</div>
<div class="paragraph">
<p>The example clusters are named <code>my-cluster</code> by default.
The cluster name is defined by the name of the resource and cannot be changed after the cluster has been deployed.
To change the cluster name before you deploy the cluster, edit the <code>Kafka.metadata.name</code> property of the <code>Kafka</code> resource in the relevant YAML file.</p>
</div>
<div class="listingblock">
<div class="title">Default cluster name and specified Kafka versions</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    version: 3.6.1
    #...
    config:
      #...
      log.message.format.version: "3.6"
      inter.broker.protocol.version: "3.6"
  # ...</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy a ZooKeeper-based Kafka cluster.</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>To deploy an ephemeral cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/kafka/kafka-ephemeral.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>To deploy a persistent cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/kafka/kafka-persistent.yaml</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods -n <em>&lt;my_cluster_operator_namespace&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the pod names and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                        READY   STATUS    RESTARTS
my-cluster-entity-operator  3/3     Running   0
my-cluster-kafka-0          1/1     Running   0
my-cluster-kafka-1          1/1     Running   0
my-cluster-kafka-2          1/1     Running   0
my-cluster-zookeeper-0      1/1     Running   0
my-cluster-zookeeper-1      1/1     Running   0
my-cluster-zookeeper-2      1/1     Running   0</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>my-cluster</code> is the name of the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>A sequential index number starting with <code>0</code> identifies each Kafka and ZooKeeper pod created.</p>
</div>
<div class="paragraph">
<p>With the default deployment, you create an Entity Operator cluster, 3 Kafka pods, and 3 ZooKeeper pods.</p>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>STATUS</code> displays as <code>Running</code>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph _additional-resources">
<div class="title">Additional resources</div>
<p><a href="#con-config-kafka-str">Kafka cluster configuration</a></p>
</div>
</div>
<div class="sect3">
<h4 id="deploying-the-topic-operator-using-the-cluster-operator-str"><a class="link" href="#deploying-the-topic-operator-using-the-cluster-operator-str">5.3.3. Deploying the Topic Operator using the Cluster Operator</a></h4>
<div class="paragraph _abstract">
<p>This procedure describes how to deploy the Topic Operator using the Cluster Operator.
The Topic Operator can be deployed for use in either bidirectional mode or unidirectional mode.
To learn more about bidirectional and unidirectional topic management, see <a href="#ref-operator-topic-str">Topic management modes</a>.</p>
</div>
<div class="paragraph">
<p>You configure the <code>entityOperator</code> property of the <code>Kafka</code> resource to include the <code>topicOperator</code>.
By default, the Topic Operator watches for <code>KafkaTopic</code> resources in the namespace of the Kafka cluster deployed by the Cluster Operator.
You can also specify a namespace using <code>watchedNamespace</code> in the Topic Operator <code>spec</code>.
A single Topic Operator can watch a single namespace.
One namespace should be watched by only one Topic Operator.</p>
</div>
<div class="paragraph">
<p>If you use Strimzi to deploy multiple Kafka clusters into the same namespace, enable the Topic Operator for only one Kafka cluster or use the <code>watchedNamespace</code> property to configure the Topic Operators to watch other namespaces.</p>
</div>
<div class="paragraph">
<p>If you want to use the Topic Operator with a Kafka cluster that is not managed by Strimzi,
you must <a href="#deploying-the-topic-operator-standalone-str">deploy the Topic Operator as a standalone component</a>.</p>
</div>
<div class="paragraph">
<p>For more information about configuring the <code>entityOperator</code> and <code>topicOperator</code> properties,
see <a href="#ref-kafka-entity-operator-str">Configuring the Entity Operator</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <code>entityOperator</code> properties of the <code>Kafka</code> resource to include <code>topicOperator</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  #...
  entityOperator:
    <strong>topicOperator: {}</strong>
    userOperator: {}</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the Topic Operator <code>spec</code> using the properties described in the <a href="./configuring.html#type-EntityTopicOperatorSpec-reference" target="_blank" rel="noopener"><code>EntityTopicOperatorSpec</code> schema reference</a>.</p>
<div class="paragraph">
<p>Use an empty object (<code>{}</code>) if you want all properties to use their default values.</p>
</div>
</li>
<li>
<p>Create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods -n <em>&lt;my_cluster_operator_namespace&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the pod name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                        READY   STATUS    RESTARTS
my-cluster-entity-operator  3/3     Running   0
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>my-cluster</code> is the name of the Kafka cluster.</p>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>STATUS</code> displays as <code>Running</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="deploying-the-user-operator-using-the-cluster-operator-str"><a class="link" href="#deploying-the-user-operator-using-the-cluster-operator-str">5.3.4. Deploying the User Operator using the Cluster Operator</a></h4>
<div class="paragraph _abstract">
<p>This procedure describes how to deploy the User Operator using the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>You configure the <code>entityOperator</code> property of the <code>Kafka</code> resource to include the <code>userOperator</code>.
By default, the User Operator watches for <code>KafkaUser</code> resources in the namespace of the Kafka cluster deployment.
You can also specify a namespace using <code>watchedNamespace</code> in the User Operator <code>spec</code>.
A single User Operator can watch a single namespace.
One namespace should be watched by only one User Operator.</p>
</div>
<div class="paragraph">
<p>If you want to use the User Operator with a Kafka cluster that is not managed by Strimzi,
you must <a href="#deploying-the-user-operator-standalone-str">deploy the User Operator as a standalone component</a>.</p>
</div>
<div class="paragraph">
<p>For more information about configuring the <code>entityOperator</code> and <code>userOperator</code> properties, see <a href="#ref-kafka-entity-operator-str">Configuring the Entity Operator</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <code>entityOperator</code> properties of the <code>Kafka</code> resource to include <code>userOperator</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  #...
  entityOperator:
    topicOperator: {}
    <strong>userOperator: {}</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Configure the User Operator <code>spec</code> using the properties described in <a href="./configuring.html#type-EntityUserOperatorSpec-reference" target="_blank" rel="noopener"><code>EntityUserOperatorSpec</code> schema reference</a>.</p>
<div class="paragraph">
<p>Use an empty object (<code>{}</code>) if you want all properties to use their default values.</p>
</div>
</li>
<li>
<p>Create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods -n <em>&lt;my_cluster_operator_namespace&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the pod name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                        READY   STATUS    RESTARTS
my-cluster-entity-operator  3/3     Running   0
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>my-cluster</code> is the name of the Kafka cluster.</p>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>STATUS</code> displays as <code>Running</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="ref-list-of-kafka-cluster-resources-str"><a class="link" href="#ref-list-of-kafka-cluster-resources-str">5.3.5. List of Kafka cluster resources</a></h4>
<div class="paragraph">
<p>The following resources are created by the Cluster Operator in the Kubernetes cluster.</p>
</div>
<div class="dlist">
<div class="title">Shared resources</div>
<dl>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-cluster-ca</code></dt>
<dd>
<p>Secret with the Cluster CA private key used to encrypt the cluster communication.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-cluster-ca-cert</code></dt>
<dd>
<p>Secret with the Cluster CA public key. This key can be used to verify the identity of the Kafka brokers.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-clients-ca</code></dt>
<dd>
<p>Secret with the Clients CA private key used to sign user certificates</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-clients-ca-cert</code></dt>
<dd>
<p>Secret with the Clients CA public key. This key can be used to verify the identity of the Kafka users.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-cluster-operator-certs</code></dt>
<dd>
<p>Secret with Cluster operators keys for communication with Kafka and ZooKeeper.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">ZooKeeper nodes</div>
<dl>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-zookeeper</code></dt>
<dd>
<p>Name given to the following ZooKeeper resources:</p>
<div class="ulist">
<ul>
<li>
<p>StrimziPodSet for managing the ZooKeeper node pods.</p>
</li>
<li>
<p>Service account used by the ZooKeeper nodes.</p>
</li>
<li>
<p>PodDisruptionBudget configured for the ZooKeeper nodes.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-zookeeper-&lt;pod_id&gt;</code></dt>
<dd>
<p>Pods created by the StrimziPodSet.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-zookeeper-nodes</code></dt>
<dd>
<p>Headless Service needed to have DNS resolve the ZooKeeper pods IP addresses directly.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-zookeeper-client</code></dt>
<dd>
<p>Service used by Kafka brokers to connect to ZooKeeper nodes as clients.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-zookeeper-config</code></dt>
<dd>
<p>ConfigMap that contains the ZooKeeper ancillary configuration, and is mounted as a volume by the ZooKeeper node pods.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-zookeeper-nodes</code></dt>
<dd>
<p>Secret with ZooKeeper node keys.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-network-policy-zookeeper</code></dt>
<dd>
<p>Network policy managing access to the ZooKeeper services.</p>
</dd>
<dt class="hdlist1"><code>data-&lt;kafka_cluster_name&gt;-zookeeper-&lt;pod_id&gt;</code></dt>
<dd>
<p>Persistent Volume Claim for the volume used for storing data for a specific ZooKeeper node. This resource will be created only if persistent storage is selected for provisioning persistent volumes to store data.</p>
</dd>
</dl>
</div>
<div class="dlist">
<div class="title">Kafka brokers</div>
<dl>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-kafka</code></dt>
<dd>
<p>Name given to the following Kafka resources:</p>
<div class="ulist">
<ul>
<li>
<p>StrimziPodSet for managing the Kafka broker pods.</p>
</li>
<li>
<p>Service account used by the Kafka pods.</p>
</li>
<li>
<p>PodDisruptionBudget configured for the Kafka brokers.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-kafka-&lt;pod_id&gt;</code></dt>
<dd>
<p>Name given to the following Kafka resources:</p>
<div class="ulist">
<ul>
<li>
<p>Pods created by the StrimziPodSet.</p>
</li>
<li>
<p>ConfigMaps with Kafka broker configuration.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-kafka-brokers</code></dt>
<dd>
<p>Service needed to have DNS resolve the Kafka broker pods IP addresses directly.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-kafka-bootstrap</code></dt>
<dd>
<p>Service can be used as bootstrap servers for Kafka clients connecting from within the Kubernetes cluster.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-kafka-external-bootstrap</code></dt>
<dd>
<p>Bootstrap service for clients connecting from outside the Kubernetes cluster. This resource is created only when an external listener is enabled. The old service name will be used for backwards compatibility when the listener name is <code>external</code> and port is <code>9094</code>.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-kafka-&lt;pod_id&gt;</code></dt>
<dd>
<p>Service used to route traffic from outside the Kubernetes cluster to individual pods. This resource is created only when an external listener is enabled. The old service name will be used for backwards compatibility when the listener name is <code>external</code> and port is <code>9094</code>.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-kafka-external-bootstrap</code></dt>
<dd>
<p>Bootstrap route for clients connecting from outside the Kubernetes cluster. This resource is created only when an external listener is enabled and set to type <code>route</code>. The old route name will be used for backwards compatibility when the listener name is <code>external</code> and port is <code>9094</code>.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-kafka-&lt;pod_id&gt;</code></dt>
<dd>
<p>Route for traffic from outside the Kubernetes cluster to individual pods. This resource is created only when an external listener is enabled and set to type <code>route</code>. The old route name will be used for backwards compatibility when the listener name is <code>external</code> and port is <code>9094</code>.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-kafka-&lt;listener_name&gt;-bootstrap</code></dt>
<dd>
<p>Bootstrap service for clients connecting from outside the Kubernetes cluster. This resource is created only when an external listener is enabled. The new service name will be used for all other external listeners.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-kafka-&lt;listener_name&gt;-&lt;pod_id&gt;</code></dt>
<dd>
<p>Service used to route traffic from outside the Kubernetes cluster to individual pods. This resource is created only when an external listener is enabled. The new service name will be used for all other external listeners.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-kafka-&lt;listener_name&gt;-bootstrap</code></dt>
<dd>
<p>Bootstrap route for clients connecting from outside the Kubernetes cluster. This resource is created only when an external listener is enabled and set to type <code>route</code>. The new route name will be used for all other external listeners.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-kafka-&lt;listener_name&gt;-&lt;pod_id&gt;</code></dt>
<dd>
<p>Route for traffic from outside the Kubernetes cluster to individual pods. This resource is created only when an external listener is enabled and set to type <code>route</code>. The new route name will be used for all other external listeners.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-kafka-config</code></dt>
<dd>
<p>ConfigMap containing the Kafka ancillary configuration, which is mounted as a volume by the broker pods when the <code>UseStrimziPodSets</code> feature gate is disabled.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-kafka-brokers</code></dt>
<dd>
<p>Secret with Kafka broker keys.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-network-policy-kafka</code></dt>
<dd>
<p>Network policy managing access to the Kafka services.</p>
</dd>
<dt class="hdlist1"><code>strimzi-<em>namespace-name</em>-&lt;kafka_cluster_name&gt;-kafka-init</code></dt>
<dd>
<p>Cluster role binding used by the Kafka brokers.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-jmx</code></dt>
<dd>
<p>Secret with JMX username and password used to secure the Kafka broker port. This resource is created only when JMX is enabled in Kafka.</p>
</dd>
<dt class="hdlist1"><code>data-&lt;kafka_cluster_name&gt;-kafka-&lt;pod_id&gt;</code></dt>
<dd>
<p>Persistent Volume Claim for the volume used for storing data for a specific Kafka broker. This resource is created only if persistent storage is selected for provisioning persistent volumes to store data.</p>
</dd>
<dt class="hdlist1"><code>data-&lt;id&gt;-&lt;kafka_cluster_name&gt;-kafka-&lt;pod_id&gt;</code></dt>
<dd>
<p>Persistent Volume Claim for the volume <code>id</code> used for storing data for a specific Kafka broker. This resource is created only if persistent storage is selected for JBOD volumes when provisioning persistent volumes to store data.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<div class="title">Kafka node pools</div>
<p>If you are using Kafka node pools, the resources created apply to the nodes managed in the node pools whether they are operating as brokers, controllers, or both.
The naming convention includes the name of the Kafka cluster and the node pool: <code>&lt;kafka_cluster_name&gt;-&lt;pool_name&gt;</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-&lt;pool_name&gt;</code></dt>
<dd>
<p>Name given to the StrimziPodSet for managing the Kafka node pool.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-&lt;pool_name&gt;-&lt;pod_id&gt;</code></dt>
<dd>
<p>Name given to the following Kafka node pool resources:</p>
<div class="ulist">
<ul>
<li>
<p>Pods created by the StrimziPodSet.</p>
</li>
<li>
<p>ConfigMaps with Kafka node configuration.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>data-&lt;kafka_cluster_name&gt;-&lt;pool_name&gt;-&lt;pod_id&gt;</code></dt>
<dd>
<p>Persistent Volume Claim for the volume used for storing data for a specific node. This resource is created only if persistent storage is selected for provisioning persistent volumes to store data.</p>
</dd>
<dt class="hdlist1"><code>data-&lt;id&gt;-&lt;kafka_cluster_name&gt;-&lt;pool_name&gt;-&lt;pod_id&gt;</code></dt>
<dd>
<p>Persistent Volume Claim for the volume <code>id</code> used for storing data for a specific node. This resource is created only if persistent storage is selected for JBOD volumes when provisioning persistent volumes to store data.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<div class="title">Entity Operator</div>
<p>These resources are only created if the Entity Operator is deployed using the Cluster Operator.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-entity-operator</code></dt>
<dd>
<p>Name given to the following Entity Operator resources:</p>
<div class="ulist">
<ul>
<li>
<p>Deployment with Topic and User Operators.</p>
</li>
<li>
<p>Service account used by the Entity Operator.</p>
</li>
<li>
<p>Network policy managing access to the Entity Operator metrics.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-entity-operator-&lt;random_string&gt;</code></dt>
<dd>
<p>Pod created by the Entity Operator deployment.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-entity-topic-operator-config</code></dt>
<dd>
<p>ConfigMap with ancillary configuration for Topic Operators.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-entity-user-operator-config</code></dt>
<dd>
<p>ConfigMap with ancillary configuration for User Operators.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-entity-topic-operator-certs</code></dt>
<dd>
<p>Secret with Topic Operator keys for communication with Kafka and ZooKeeper.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-entity-user-operator-certs</code></dt>
<dd>
<p>Secret with User Operator keys for communication with Kafka and ZooKeeper.</p>
</dd>
<dt class="hdlist1"><code>strimzi-&lt;kafka_cluster_name&gt;-entity-topic-operator</code></dt>
<dd>
<p>Role binding used by the Entity Topic Operator.</p>
</dd>
<dt class="hdlist1"><code>strimzi-&lt;kafka_cluster_name&gt;-entity-user-operator</code></dt>
<dd>
<p>Role binding used by the Entity User Operator.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<div class="title">Kafka Exporter</div>
<p>These resources are only created if the Kafka Exporter is deployed using the Cluster Operator.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-kafka-exporter</code></dt>
<dd>
<p>Name given to the following Kafka Exporter resources:</p>
<div class="ulist">
<ul>
<li>
<p>Deployment with Kafka Exporter.</p>
</li>
<li>
<p>Service used to collect consumer lag metrics.</p>
</li>
<li>
<p>Service account used by the Kafka Exporter.</p>
</li>
<li>
<p>Network policy managing access to the Kafka Exporter metrics.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-kafka-exporter-&lt;random_string&gt;</code></dt>
<dd>
<p>Pod created by the Kafka Exporter deployment.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<div class="title">Cruise Control</div>
<p>These resources are only created if Cruise Control was deployed using the Cluster Operator.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-cruise-control</code></dt>
<dd>
<p>Name given to the following Cruise Control resources:</p>
<div class="ulist">
<ul>
<li>
<p>Deployment with Cruise Control.</p>
</li>
<li>
<p>Service used to communicate with Cruise Control.</p>
</li>
<li>
<p>Service account used by the Cruise Control.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-cruise-control-&lt;random_string&gt;</code></dt>
<dd>
<p>Pod created by the Cruise Control deployment.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-cruise-control-config</code></dt>
<dd>
<p>ConfigMap that contains the Cruise Control ancillary configuration, and is mounted as a volume by the Cruise Control pods.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-cruise-control-certs</code></dt>
<dd>
<p>Secret with Cruise Control keys for communication with Kafka and ZooKeeper.</p>
</dd>
<dt class="hdlist1"><code>&lt;kafka_cluster_name&gt;-network-policy-cruise-control</code></dt>
<dd>
<p>Network policy managing access to the Cruise Control service.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kafka-connect-str"><a class="link" href="#kafka-connect-str">5.4. Deploying Kafka Connect</a></h3>
<div class="paragraph _abstract">
<p><a href="https://kafka.apache.org/documentation/#connect" target="_blank" rel="noopener">Kafka Connect</a> is an integration toolkit for streaming data between Kafka brokers and other systems using connector plugins.
Kafka Connect provides a framework for integrating Kafka with an external data source or target, such as a database or messaging system, for import or export of data using connectors.
Connectors are plugins that provide the connection configuration needed.</p>
</div>
<div class="paragraph">
<p>In Strimzi, Kafka Connect is deployed in distributed mode.
Kafka Connect can also work in standalone mode, but this is not supported by Strimzi.</p>
</div>
<div class="paragraph">
<p>Using the concept of <em>connectors</em>, Kafka Connect provides a framework for moving large amounts of data into and out of your Kafka cluster while maintaining scalability and reliability.</p>
</div>
<div class="paragraph">
<p>The Cluster Operator manages Kafka Connect clusters deployed using the <code>KafkaConnect</code> resource and connectors created using the <code>KafkaConnector</code> resource.</p>
</div>
<div class="paragraph">
<p>In order to use Kafka Connect, you need to do the following.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#deploying-kafka-connect-str">Deploy a Kafka Connect cluster</a></p>
</li>
<li>
<p><a href="#using-kafka-connect-with-plug-ins-str">Add connectors to integrate with other systems</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The term <em>connector</em> is used interchangeably to mean a connector instance running within a Kafka Connect cluster, or a connector class.
In this guide, the term <em>connector</em> is used when the meaning is clear from the context.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="deploying-kafka-connect-str"><a class="link" href="#deploying-kafka-connect-str">5.4.1. Deploying Kafka Connect to your Kubernetes cluster</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy a Kafka Connect cluster to your Kubernetes cluster using the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>A Kafka Connect cluster deployment is implemented with a configurable number of nodes (also called <em>workers</em>) that distribute the workload of connectors as <em>tasks</em> so that the message flow is highly scalable and reliable.</p>
</div>
<div class="paragraph">
<p>The deployment uses a YAML file to provide the specification to create a <code>KafkaConnect</code> resource.</p>
</div>
<div class="paragraph">
<p>Strimzi provides <a href="#config-examples-str">example configuration files</a>.
In this procedure, we use the following example file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/connect/kafka-connect.yaml</code></p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
If deploying Kafka Connect clusters to run in parallel, each instance must use unique names for internal Kafka Connect topics.
To do this, <a href="#con-config-kafka-connect-multiple-instances-str">configure each Kafka Connect instance to replace the defaults</a>.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
<li>
<p><a href="#deploying-kafka-cluster-str">Running Kafka cluster.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy Kafka Connect to your Kubernetes cluster.
Use the <code>examples/connect/kafka-connect.yaml</code> file to deploy Kafka Connect.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/connect/kafka-connect.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods -n <em>&lt;my_cluster_operator_namespace&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the deployment name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                                 READY  STATUS   RESTARTS
my-connect-cluster-connect-&lt;pod_id&gt;  1/1    Running  0</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>my-connect-cluster</code> is the name of the Kafka Connect cluster.</p>
</div>
<div class="paragraph">
<p>A pod ID identifies each pod created.</p>
</div>
<div class="paragraph">
<p>With the default deployment, you create a single Kafka Connect pod.</p>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>STATUS</code> displays as <code>Running</code>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph _additional-resources">
<div class="title">Additional resources</div>
<p><a href="#con-kafka-connect-config-str">Kafka Connect cluster configuration</a></p>
</div>
</div>
<div class="sect3">
<h4 id="ref-list-of-kafka-connect-resources-str"><a class="link" href="#ref-list-of-kafka-connect-resources-str">5.4.2. List of Kafka Connect cluster resources</a></h4>
<div class="paragraph">
<p>The following resources are created by the Cluster Operator in the Kubernetes cluster:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">&lt;connect_cluster_name&gt;-connect</dt>
<dd>
<p>Name given to the following Kafka Connect resources:</p>
<div class="ulist">
<ul>
<li>
<p>StrimziPodSet that creates the Kafka Connect worker node pods.</p>
</li>
<li>
<p>Headless service that provides stable DNS names to the Kafka Connect pods.</p>
</li>
<li>
<p>Service account used by the Kafka Connect pods.</p>
</li>
<li>
<p>Pod disruption budget configured for the Kafka Connect worker nodes.</p>
</li>
<li>
<p>Network policy managing access to the Kafka Connect REST API.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">&lt;connect_cluster_name&gt;-connect-&lt;pod_id&gt;</dt>
<dd>
<p>Pods created by the Kafka Connect StrimziPodSet.</p>
</dd>
<dt class="hdlist1">&lt;connect_cluster_name&gt;-connect-api</dt>
<dd>
<p>Service which exposes the REST interface for managing the Kafka Connect cluster.</p>
</dd>
<dt class="hdlist1">&lt;connect_cluster_name&gt;-connect-config</dt>
<dd>
<p>ConfigMap which contains the Kafka Connect ancillary configuration and is mounted as a volume by the Kafka Connect pods.</p>
</dd>
<dt class="hdlist1">strimzi-&lt;namespace-name&gt;-&lt;connect_cluster_name&gt;-connect-init</dt>
<dd>
<p>Cluster role binding used by the Kafka Connect cluster.</p>
</dd>
<dt class="hdlist1">&lt;connect_cluster_name&gt;-connect-build</dt>
<dd>
<p>Pod used to build a new container image with additional connector plugins (only when Kafka Connect Build feature is used).</p>
</dd>
<dt class="hdlist1">&lt;connect_cluster_name&gt;-connect-dockerfile</dt>
<dd>
<p>ConfigMap with the Dockerfile generated to build the new container image with additional connector plugins (only when the Kafka Connect build feature is used).</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-kafka-connect-with-plug-ins-str"><a class="link" href="#using-kafka-connect-with-plug-ins-str">5.5. Adding Kafka Connect connectors</a></h3>
<div class="paragraph _abstract">
<p>Kafka Connect uses connectors to integrate with other systems to stream data.
A connector is an instance of a Kafka <code>Connector</code> class, which can be one of the following type:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Source connector</dt>
<dd>
<p>A source connector is a runtime entity that fetches data from an external system and feeds it to Kafka as messages.</p>
</dd>
<dt class="hdlist1">Sink connector</dt>
<dd>
<p>A sink connector is a runtime entity that fetches messages from Kafka topics and feeds them to an external system.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Kafka Connect uses a plugin architecture to provide the implementation artifacts for connectors.
Plugins allow connections to other systems and provide additional configuration to manipulate data.
Plugins include connectors and other components, such as data converters and transforms.
A connector operates with a specific type of external system.
Each connector defines a schema for its configuration.
You supply the configuration to Kafka Connect to create a connector instance within Kafka Connect.
Connector instances then define a set of tasks for moving data between systems.</p>
</div>
<div class="paragraph">
<p>Add connector plugins to Kafka Connect in one of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#creating-new-image-using-kafka-connect-build-str">Configure Kafka Connect to build a new container image with plugins automatically</a></p>
</li>
<li>
<p><a href="#creating-new-image-from-base-str">Create a Docker image from the base Kafka Connect image</a> (manually or using continuous integration)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After plugins have been added to the container image, you can start, stop, and manage connector instances in the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-deploying-kafkaconnector-str">Using Strimzi’s <code>KafkaConnector</code> custom resource</a></p>
</li>
<li>
<p><a href="#con-exposing-kafka-connect-api-str">Using the Kafka Connect API</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can also create new connector instances using these options.</p>
</div>
<div class="sect3">
<h4 id="creating-new-image-using-kafka-connect-build-str"><a class="link" href="#creating-new-image-using-kafka-connect-build-str">5.5.1. Building a new container image with connector plugins automatically</a></h4>
<div class="paragraph _abstract">
<p>Configure Kafka Connect so that Strimzi automatically builds a new container image with additional connectors.
You define the connector plugins using the <code>.spec.build.plugins</code> property of the <code>KafkaConnect</code> custom resource.
Strimzi will automatically download and add the connector plugins into a new container image.
The container is pushed into the container repository specified in <code>.spec.build.output</code> and automatically used in the Kafka Connect deployment.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
<li>
<p>A container registry.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You need to provide your own container registry where images can be pushed to, stored, and pulled from.
Strimzi supports private container registries as well as public registries such as <a href="https://quay.io/" target="_blank" rel="noopener">Quay</a> or <a href="https://hub.docker.com//" target="_blank" rel="noopener">Docker Hub</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure the <code>KafkaConnect</code> custom resource by specifying the container registry in <code>.spec.build.output</code>, and additional connectors in <code>.spec.build.plugins</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect-cluster
spec: # <b class="conum">(1)</b>
  #...
  build:
    output: # <b class="conum">(2)</b>
      type: docker
      image: my-registry.io/my-org/my-connect-cluster:latest
      pushSecret: my-registry-credentials
    plugins: # <b class="conum">(3)</b>
      - name: connector-1
        artifacts:
          - type: tgz
            url: &lt;url_to_download_connector_1_artifact&gt;
            sha512sum: &lt;SHA-512_checksum_of_connector_1_artifact&gt;
      - name: connector-2
        artifacts:
          - type: jar
            url: &lt;url_to_download_connector_2_artifact&gt;
            sha512sum: &lt;SHA-512_checksum_of_connector_2_artifact&gt;
  #...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><a href="./configuring.html#type-KafkaConnectSpec-reference" target="_blank" rel="noopener">The specification for the Kafka Connect cluster</a>.</p>
</li>
<li>
<p>(Required) Configuration of the container registry where new images are pushed.</p>
</li>
<li>
<p>(Required) List of connector plugins and their artifacts to add to the new container image. Each plugin must be configured with at least one <code>artifact</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ kubectl apply -f &lt;kafka_connect_configuration_file&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the new container image to build, and for the Kafka Connect cluster to be deployed.</p>
</li>
<li>
<p>Use the Kafka Connect REST API or <code>KafkaConnector</code> custom resources to use the connector plugins you added.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./configuring.html#type-Build-reference" target="_blank" rel="noopener">Kafka Connect <code>Build</code> schema reference</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="creating-new-image-from-base-str"><a class="link" href="#creating-new-image-from-base-str">5.5.2. Building a new container image with connector plugins from the Kafka Connect base image</a></h4>
<div class="paragraph _abstract">
<p>Create a custom Docker image with connector plugins from the Kafka Connect base image.
Add the custom image to the <code>/opt/kafka/plugins</code> directory.</p>
</div>
<div class="paragraph">
<p>You can use the Kafka container image on <a href="https://quay.io/organization/strimzi" target="_blank" rel="noopener">Container Registry</a> as a base image for creating your own custom image with additional connector plugins.</p>
</div>
<div class="paragraph">
<p>At startup, the Strimzi version of Kafka Connect loads any third-party connector plugins contained in the <code>/opt/kafka/plugins</code> directory.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a new <code>Dockerfile</code> using <code>quay.io/strimzi/kafka:0.39.0-kafka-3.6.1</code> as the base image:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">FROM quay.io/strimzi/kafka:0.39.0-kafka-3.6.1
USER root:root
COPY ./<em>my-plugins</em>/ /opt/kafka/plugins/
USER 1001</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example plugins file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ tree ./<em>my-plugins</em>/
./<em>my-plugins</em>/
├── debezium-connector-mongodb
│   ├── bson-&lt;version&gt;.jar
│   ├── CHANGELOG.md
│   ├── CONTRIBUTE.md
│   ├── COPYRIGHT.txt
│   ├── debezium-connector-mongodb-&lt;version&gt;.jar
│   ├── debezium-core-&lt;version&gt;.jar
│   ├── LICENSE.txt
│   ├── mongodb-driver-core-&lt;version&gt;.jar
│   ├── README.md
│   └── # ...
├── debezium-connector-mysql
│   ├── CHANGELOG.md
│   ├── CONTRIBUTE.md
│   ├── COPYRIGHT.txt
│   ├── debezium-connector-mysql-&lt;version&gt;.jar
│   ├── debezium-core-&lt;version&gt;.jar
│   ├── LICENSE.txt
│   ├── mysql-binlog-connector-java-&lt;version&gt;.jar
│   ├── mysql-connector-java-&lt;version&gt;.jar
│   ├── README.md
│   └── # ...
└── debezium-connector-postgres
    ├── CHANGELOG.md
    ├── CONTRIBUTE.md
    ├── COPYRIGHT.txt
    ├── debezium-connector-postgres-&lt;version&gt;.jar
    ├── debezium-core-&lt;version&gt;.jar
    ├── LICENSE.txt
    ├── postgresql-&lt;version&gt;.jar
    ├── protobuf-java-&lt;version&gt;.jar
    ├── README.md
    └── # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The COPY command points to the plugin files to copy to the container image.</p>
</div>
<div class="paragraph">
<p>This example adds plugins for Debezium connectors (MongoDB, MySQL, and PostgreSQL), though not all files are listed for brevity. Debezium running in Kafka Connect looks the same as any other Kafka Connect task.</p>
</div>
</li>
<li>
<p>Build the container image.</p>
</li>
<li>
<p>Push your custom image to your container registry.</p>
</li>
<li>
<p>Point to the new container image.</p>
<div class="paragraph">
<p>You can point to the image in one of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Edit the <code>KafkaConnect.spec.image</code> property of the <code>KafkaConnect</code> custom resource.</p>
<div class="paragraph">
<p>If set, this property overrides the <code>STRIMZI_KAFKA_CONNECT_IMAGES</code> environment variable in the Cluster Operator.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect-cluster
spec: <b class="conum">(1)</b>
  #...
  image: my-new-container-image <b class="conum">(2)</b>
  config: <b class="conum">(3)</b>
    #...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><a href="./configuring.html#type-KafkaConnectSpec-reference" target="_blank" rel="noopener">The specification for the Kafka Connect cluster</a>.</p>
</li>
<li>
<p>The docker image for Kafka Connect pods.</p>
</li>
<li>
<p>Configuration of the Kafka Connect <em>workers</em> (not connectors).</p>
</li>
</ol>
</div>
</li>
<li>
<p>Edit the <code>STRIMZI_KAFKA_CONNECT_IMAGES</code> environment variable in the <code>install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code> file to point to the new container image, and then reinstall the Cluster Operator.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./configuring.html#con-common-configuration-images-reference" target="_blank" rel="noopener">Container image configuration and the <code>KafkaConnect.spec.image property</code></a></p>
</li>
<li>
<p><a href="#ref-operator-cluster-str">Cluster Operator configuration and the <code>STRIMZI_KAFKA_CONNECT_IMAGES</code> variable</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="proc-deploying-kafkaconnector-str"><a class="link" href="#proc-deploying-kafkaconnector-str">5.5.3. Deploying KafkaConnector resources</a></h4>
<div class="paragraph _abstract">
<p>Deploy <code>KafkaConnector</code> resources to manage connectors.
The <code>KafkaConnector</code> custom resource offers a Kubernetes-native approach to management of connectors by the Cluster Operator.
You don&#8217;t need to send HTTP requests to manage connectors, as with the Kafka Connect REST API.
You manage a running connector instance by updating its corresponding <code>KafkaConnector</code> resource, and then applying the updates.
The Cluster Operator updates the configurations of the running connector instances.
You remove a connector by deleting its corresponding <code>KafkaConnector</code>.</p>
</div>
<div class="paragraph">
<p><code>KafkaConnector</code> resources must be deployed to the same namespace as the Kafka Connect cluster they link to.</p>
</div>
<div class="paragraph">
<p>In the configuration shown in this procedure, the <code>autoRestart</code> feature is enabled (<code>enabled: true</code>) for automatic restarts of failed connectors and tasks.
You can also annotate the <code>KafkaConnector</code> resource to <a href="#proc-manual-restart-connector-str">restart a connector</a> or <a href="#proc-manual-restart-connector-task-str">restart a connector task</a> manually.</p>
</div>
<div class="paragraph">
<div class="title">Example connectors</div>
<p>You can use your own connectors or try the examples provided by Strimzi.
Up until Apache Kafka 3.1.0, example file connector plugins were included with Apache Kafka.
Starting from the 3.1.1 and 3.2.0 releases of Apache Kafka, the examples need to be <a href="#using-kafka-connect-with-plug-ins-str">added to the plugin path as any other connector</a>.</p>
</div>
<div class="paragraph">
<p>Strimzi provides an <a href="#config-examples-str">example <code>KafkaConnector</code> configuration file</a> (<code>examples/connect/source-connector.yaml</code>) for the example file connector plugins, which creates the following connector instances as <code>KafkaConnector</code> resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>FileStreamSourceConnector</code> instance that reads each line from the Kafka license file (the source) and writes the data as messages to a single Kafka topic.</p>
</li>
<li>
<p>A <code>FileStreamSinkConnector</code> instance that reads messages from the Kafka topic and writes the messages to a temporary file (the sink).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We use the example file to create connectors in this procedure.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The example connectors are not intended for use in a production environment.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kafka Connect deployment</p>
</li>
<li>
<p>The Cluster Operator is running</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the <code>FileStreamSourceConnector</code> and <code>FileStreamSinkConnector</code> plugins to Kafka Connect in one of the following ways:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#creating-new-image-using-kafka-connect-build-str">Configure Kafka Connect to build a new container image with plugins automatically</a></p>
</li>
<li>
<p><a href="#creating-new-image-from-base-str">Create a Docker image from the base Kafka Connect image</a> (manually or using continuous integration)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Set the <code>strimzi.io/use-connector-resources annotation</code> to <code>true</code> in the Kafka Connect configuration.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect-cluster
  annotations:
    strimzi.io/use-connector-resources: "true"
spec:
    # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the <code>KafkaConnector</code> resources enabled, the Cluster Operator watches for them.</p>
</div>
</li>
<li>
<p>Edit the <code>examples/connect/source-connector.yaml</code> file:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example KafkaConnector source connector configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: my-source-connector  # <b class="conum">(1)</b>
  labels:
    strimzi.io/cluster: my-connect-cluster # <b class="conum">(2)</b>
spec:
  class: org.apache.kafka.connect.file.FileStreamSourceConnector # <b class="conum">(3)</b>
  tasksMax: 2 # <b class="conum">(4)</b>
  autoRestart: # <b class="conum">(5)</b>
    enabled: true
  config: # <b class="conum">(6)</b>
    file: "/opt/kafka/LICENSE" # <b class="conum">(7)</b>
    topic: my-topic # <b class="conum">(8)</b>
    # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Name of the <code>KafkaConnector</code> resource, which is used as the name of the connector. Use any name that is valid for a Kubernetes resource.</p>
</li>
<li>
<p>Name of the Kafka Connect cluster to create the connector instance in. Connectors must be deployed to the same namespace as the Kafka Connect cluster they link to.</p>
</li>
<li>
<p>Full name of the connector class. This should be present in the image being used by the Kafka Connect cluster.</p>
</li>
<li>
<p>Maximum number of Kafka Connect tasks that the connector can create.</p>
</li>
<li>
<p>Enables automatic restarts of failed connectors and tasks. By default, the number of restarts is indefinite, but you can set a maximum on the number of automatic restarts using the <code>maxRestarts</code> property.</p>
</li>
<li>
<p><a href="./deploying.html#kafkaconnector-configs" target="_blank" rel="noopener">Connector configuration</a> as key-value pairs.</p>
</li>
<li>
<p>Location of the external data file. In this example, we&#8217;re configuring the <code>FileStreamSourceConnector</code> to read from the <code>/opt/kafka/LICENSE</code> file.</p>
</li>
<li>
<p>Kafka topic to publish the source data to.</p>
</li>
</ol>
</div>
</div>
</div>
</li>
<li>
<p>Create the source <code>KafkaConnector</code> in your Kubernetes cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/connect/source-connector.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Create an <code>examples/connect/sink-connector.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">touch examples/connect/sink-connector.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Paste the following YAML into the <code>sink-connector.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: my-sink-connector
  labels:
    strimzi.io/cluster: my-connect
spec:
  class: org.apache.kafka.connect.file.FileStreamSinkConnector # <b class="conum">(1)</b>
  tasksMax: 2
  config: # <b class="conum">(2)</b>
    file: "/tmp/my-file" # <b class="conum">(3)</b>
    topics: my-topic # <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Full name or alias of the connector class. This should be present in the image being used by the Kafka Connect cluster.</p>
</li>
<li>
<p><a href="#kafkaconnector-configs">Connector configuration</a> as key-value pairs.</p>
</li>
<li>
<p>Temporary file to publish the source data to.</p>
</li>
<li>
<p>Kafka topic to read the source data from.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create the sink <code>KafkaConnector</code> in your Kubernetes cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/connect/sink-connector.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Check that the connector resources were created:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kctr --selector strimzi.io/cluster=&lt;my_connect_cluster&gt; -o name

my-source-connector
my-sink-connector</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace &lt;my_connect_cluster&gt; with the name of your Kafka Connect cluster.</p>
</div>
</li>
<li>
<p>In the container, execute <code>kafka-console-consumer.sh</code> to read the messages that were written to the topic by the source connector:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl exec &lt;my_kafka_cluster&gt;-kafka-0 -i -t -- bin/kafka-console-consumer.sh --bootstrap-server &lt;my_kafka_cluster&gt;-kafka-bootstrap.<em>NAMESPACE</em>.svc:9092 --topic my-topic --from-beginning</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace &lt;my_kafka_cluster&gt; with the name of your Kafka cluster.</p>
</div>
</li>
</ol>
</div>
<h5 id="kafkaconnector-configs" class="discrete">Source and sink connector configuration options</h5>
<div class="paragraph">
<p>The connector configuration is defined in the <code>spec.config</code> property of the <code>KafkaConnector</code> resource.</p>
</div>
<div class="paragraph">
<p>The <code>FileStreamSourceConnector</code> and <code>FileStreamSinkConnector</code> classes support the same configuration options as the Kafka Connect REST API.
Other connectors support different configuration options.</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 5. Configuration options for the <code>FileStreamSource</code> connector class</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>file</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Source file to write messages to. If not specified, the standard input is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>topic</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Kafka topic to publish data to.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 6. Configuration options for <code>FileStreamSinkConnector</code> class</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>file</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Destination file to write messages to. If not specified, the standard output is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>topics</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One or more Kafka topics to read data from.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>topics.regex</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A regular expression matching one or more Kafka topics to read data from.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="con-exposing-kafka-connect-api-str"><a class="link" href="#con-exposing-kafka-connect-api-str">5.5.4. Exposing the Kafka Connect API</a></h4>
<div class="paragraph _abstract">
<p>Use the Kafka Connect REST API as an alternative to using <code>KafkaConnector</code> resources to manage connectors.
The Kafka Connect REST API is available as a service running on <code><em>&lt;connect_cluster_name&gt;</em>-connect-api:8083</code>, where <em>&lt;connect_cluster_name&gt;</em> is the name of your Kafka Connect cluster.
The service is created when you create a Kafka Connect instance.</p>
</div>
<div class="paragraph">
<p>The operations supported by the Kafka Connect REST API are described in the <a href="https://kafka.apache.org/documentation#connect_rest" target="_blank" rel="noopener">Apache Kafka Connect API documentation</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>strimzi.io/use-connector-resources</code> annotation enables KafkaConnectors.
If you applied the annotation to your <code>KafkaConnect</code> resource configuration, you need to remove it to use the Kafka Connect API.
Otherwise, manual changes made directly using the Kafka Connect REST API are reverted by the Cluster Operator.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can add the connector configuration as a JSON object.</p>
</div>
<div class="listingblock">
<div class="title">Example curl request to add connector configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-curl hljs" data-lang="curl">curl -X POST \
  http://my-connect-cluster-connect-api:8083/connectors \
  -H 'Content-Type: application/json' \
  -d '{ "name": "my-source-connector",
    "config":
    {
      "connector.class":"org.apache.kafka.connect.file.FileStreamSourceConnector",
      "file": "/opt/kafka/LICENSE",
      "topic":"my-topic",
      "tasksMax": "4",
      "type": "source"
    }
}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The API is only accessible within the Kubernetes cluster.
If you want to make the Kafka Connect API accessible to applications running outside of the Kubernetes cluster, you can expose it manually by creating one of the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>LoadBalancer</code> or <code>NodePort</code> type services</p>
</li>
<li>
<p><code>Ingress</code> resources (Kubernetes only)</p>
</li>
<li>
<p>OpenShift routes (OpenShift only)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The connection is insecure, so allow external access advisedly.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you decide to create services, use the labels from the <code>selector</code> of the <code><em>&lt;connect_cluster_name&gt;</em>-connect-api</code> service to configure the pods to which the service will route the traffic:</p>
</div>
<div class="listingblock">
<div class="title">Selector configuration for the service</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
selector:
  strimzi.io/cluster: my-connect-cluster <b class="conum">(1)</b>
  strimzi.io/kind: KafkaConnect
  strimzi.io/name: my-connect-cluster-connect <b class="conum">(2)</b>
#...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Name of the Kafka Connect custom resource in your Kubernetes cluster.</p>
</li>
<li>
<p>Name of the Kafka Connect deployment created by the Cluster Operator.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You must also create a <code>NetworkPolicy</code> that allows HTTP requests from external clients.</p>
</div>
<div class="listingblock">
<div class="title">Example NetworkPolicy to allow requests to the Kafka Connect API</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: my-custom-connect-network-policy
spec:
  ingress:
  - from:
    - podSelector: <b class="conum">(1)</b>
        matchLabels:
          app: my-connector-manager
    ports:
    - port: 8083
      protocol: TCP
  podSelector:
    matchLabels:
      strimzi.io/cluster: my-connect-cluster
      strimzi.io/kind: KafkaConnect
      strimzi.io/name: my-connect-cluster-connect
  policyTypes:
  - Ingress</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The label of the pod that is allowed to connect to the API.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To add the connector configuration outside the cluster, use the URL of the resource that exposes the API in the curl command.</p>
</div>
</div>
<div class="sect3">
<h4 id="con-securing-kafka-connect-api-str"><a class="link" href="#con-securing-kafka-connect-api-str">5.5.5. Limiting access to the Kafka Connect API</a></h4>
<div class="paragraph _abstract">
<p>It is crucial to restrict access to the Kafka Connect API only to trusted users to prevent unauthorized actions and potential security issues.
The Kafka Connect API provides extensive capabilities for altering connector configurations, which makes it all the more important to take security precautions.
Someone with access to the Kafka Connect API could potentially obtain sensitive information that an administrator may assume is secure.</p>
</div>
<div class="paragraph">
<p>The Kafka Connect REST API can be accessed by anyone who has authenticated access to the Kubernetes cluster and knows the endpoint URL, which includes the hostname/IP address and port number.</p>
</div>
<div class="paragraph">
<p>For example, suppose an organization uses a Kafka Connect cluster and connectors to stream sensitive data from a customer database to a central database.
The administrator uses a configuration provider plugin to store sensitive information related to connecting to the customer database and the central database, such as database connection details and authentication credentials.
The configuration provider protects this sensitive information from being exposed to unauthorized users.
However, someone who has access to the Kafka Connect API can still obtain access to the customer database without the consent of the administrator.
They can do this by setting up a fake database and configuring a connector to connect to it.
They then modify the connector configuration to point to the customer database, but instead of sending the data to the central database, they send it to the fake database.
By configuring the connector to connect to the fake database, the login details and credentials for connecting to the customer database are intercepted, even though they are stored securely in the configuration provider.</p>
</div>
<div class="paragraph">
<p>If you are using the <code>KafkaConnector</code> custom resources, then by default the Kubernetes RBAC rules permit only Kubernetes cluster administrators to make changes to connectors.
You can also <a href="#adding-users-the-strimzi-admin-role-str">designate non-cluster administrators to manage Strimzi resources</a>.
With <code>KafkaConnector</code> resources enabled in your Kafka Connect configuration, changes made directly using the Kafka Connect REST API are reverted by the Cluster Operator.
If you are not using the <code>KafkaConnector</code> resource, the default RBAC rules do not limit access to the Kafka Connect API.
If you want to limit direct access to the Kafka Connect REST API using Kubernetes RBAC, you need to enable and use the <code>KafkaConnector</code> resources.</p>
</div>
<div class="paragraph">
<p>For improved security, we recommend configuring the following properties for the Kafka Connect API:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>org.apache.kafka.disallowed.login.modules</code></dt>
<dd>
<p>(Kafka 3.4 or later) Set the <code>org.apache.kafka.disallowed.login.modules</code> Java system property to prevent the use of insecure login modules.
For example, specifying <code>com.sun.security.auth.module.JndiLoginModule</code> prevents the use of the Kafka <code>JndiLoginModule</code>.</p>
<div class="listingblock">
<div class="title">Example configuration for disallowing login modules</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect-cluster
  annotations:
    strimzi.io/use-connector-resources: "true"
spec:
  # ...
  jvmOptions:
    javaSystemProperties:
      - name: org.apache.kafka.disallowed.login.modules
        value: com.sun.security.auth.module.JndiLoginModule, org.apache.kafka.common.security.kerberos.KerberosLoginModule
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Only allow trusted login modules and follow the latest advice from Kafka for the version you are using.
As a best practice, you should explicitly disallow insecure login modules in your Kafka Connect configuration by using the <code>org.apache.kafka.disallowed.login.modules</code> system property.</p>
</div>
</dd>
<dt class="hdlist1"><code>connector.client.config.override.policy</code></dt>
<dd>
<p>Set the <code>connector.client.config.override.policy</code> property to <code>None</code> to prevent connector configurations from overriding the Kafka Connect configuration and the consumers and producers it uses.</p>
<div class="listingblock">
<div class="title">Example configuration to specify connector override policy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect-cluster
  annotations:
    strimzi.io/use-connector-resources: "true"
spec:
  # ...
  config:
    connector.client.config.override.policy: None
# ...</code></pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="con-switching-api-to-kafka-connector-str"><a class="link" href="#con-switching-api-to-kafka-connector-str">5.5.6. Switching from using the Kafka Connect API to using KafkaConnector custom resources</a></h4>
<div class="paragraph _abstract">
<p>You can switch from using the Kafka Connect API to using <code>KafkaConnector</code> custom resources to manage your connectors.
To make the switch, do the following in the order shown:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Deploy <code>KafkaConnector</code> resources with the configuration to create your connector instances.</p>
</li>
<li>
<p>Enable <code>KafkaConnector</code> resources in your Kafka Connect configuration by setting the <code>strimzi.io/use-connector-resources</code> annotation to <code>true</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you enable <code>KafkaConnector</code> resources before creating them, you delete all connectors.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To switch from using <code>KafkaConnector</code> resources to using the Kafka Connect API, first remove the annotation that enables the <code>KafkaConnector</code> resources from your Kafka Connect configuration.
Otherwise, manual changes made directly using the Kafka Connect REST API are reverted by the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>When making the switch, <a href="#con-custom-resources-status-str">check the status of the <code>KafkaConnect</code> resource</a>.
The value of <code>metadata.generation</code> (the current version of the deployment) must match <code>status.observedGeneration</code> (the latest reconciliation of the resource).
When the Kafka Connect cluster is <code>Ready</code>, you can delete the <code>KafkaConnector</code> resources.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kafka-mirror-maker-str"><a class="link" href="#kafka-mirror-maker-str">5.6. Deploying Kafka MirrorMaker</a></h3>
<div class="paragraph _abstract">
<p>Kafka MirrorMaker replicates data between two or more Kafka clusters, within or across data centers.
This process is called mirroring to avoid confusion with the concept of Kafka partition replication.
MirrorMaker consumes messages from a source cluster and republishes those messages to a target cluster.</p>
</div>
<div class="paragraph">
<p>Data replication across clusters supports scenarios that require the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Recovery of data in the event of a system failure</p>
</li>
<li>
<p>Consolidation of data from multiple source clusters for centralized analysis</p>
</li>
<li>
<p>Restriction of data access to a specific cluster</p>
</li>
<li>
<p>Provision of data at a specific location to improve latency</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="deploying-kafka-mirror-maker-str"><a class="link" href="#deploying-kafka-mirror-maker-str">5.6.1. Deploying Kafka MirrorMaker to your Kubernetes cluster</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy a Kafka MirrorMaker cluster to your Kubernetes cluster using the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>The deployment uses a YAML file to provide the specification to create a <code>KafkaMirrorMaker</code> or <code>KafkaMirrorMaker2</code> resource depending on the version of MirrorMaker deployed.
MirrorMaker 2 is based on Kafka Connect and uses its configuration properties.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Kafka MirrorMaker 1 (referred to as just <em>MirrorMaker</em> in the documentation) has been deprecated in Apache Kafka 3.0.0 and will be removed in Apache Kafka 4.0.0.
As a result, the <code>KafkaMirrorMaker</code> custom resource which is used to deploy Kafka MirrorMaker 1 has been deprecated in Strimzi as well.
The <code>KafkaMirrorMaker</code> resource will be removed from Strimzi when we adopt Apache Kafka 4.0.0.
As a replacement, use the <code>KafkaMirrorMaker2</code> custom resource with the <a href="#unidirectional_replication_activepassive"><code>IdentityReplicationPolicy</code></a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Strimzi provides <a href="#config-examples-str">example configuration files</a>.
In this procedure, we use the following example files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/mirror-maker/kafka-mirror-maker.yaml</code></p>
</li>
<li>
<p><code>examples/mirror-maker/kafka-mirror-maker-2.yaml</code></p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
If deploying MirrorMaker 2 clusters to run in parallel, using the same target Kafka cluster, each instance must use unique names for internal Kafka Connect topics.
To do this, <a href="#con-config-mm2-multiple-instances-str">configure each MirrorMaker 2 instance to replace the defaults</a>.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy Kafka MirrorMaker to your Kubernetes cluster:</p>
<div class="paragraph">
<p>For MirrorMaker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/mirror-maker/kafka-mirror-maker.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>For MirrorMaker 2:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/mirror-maker/kafka-mirror-maker-2.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods -n <em>&lt;my_cluster_operator_namespace&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the deployment name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                                    READY  STATUS   RESTARTS
my-mirror-maker-mirror-maker-&lt;pod_id&gt;   1/1    Running  1
my-mm2-cluster-mirrormaker2-&lt;pod_id&gt;    1/1    Running  1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>my-mirror-maker</code> is the name of the Kafka MirrorMaker cluster.
<code>my-mm2-cluster</code> is the name of the Kafka MirrorMaker 2 cluster.</p>
</div>
<div class="paragraph">
<p>A pod ID identifies each pod created.</p>
</div>
<div class="paragraph">
<p>With the default deployment, you install a single MirrorMaker or MirrorMaker 2 pod.</p>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>STATUS</code> displays as <code>Running</code>.</p>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#con-config-mirrormaker-str">Kafka MirrorMaker cluster configuration</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="ref-list-of-kafka-mirrormaker2-resources-str"><a class="link" href="#ref-list-of-kafka-mirrormaker2-resources-str">5.6.2. List of Kafka MirrorMaker 2 cluster resources</a></h4>
<div class="paragraph">
<p>The following resources are created by the Cluster Operator in the Kubernetes cluster:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">&lt;mirrormaker2_cluster_name&gt;-mirrormaker2</dt>
<dd>
<p>Name given to the following MirrorMaker 2 resources:</p>
<div class="ulist">
<ul>
<li>
<p>StrimziPodSet that creates the MirrorMaker 2 worker node pods.</p>
</li>
<li>
<p>Headless service that provides stable DNS names to the MirrorMaker 2 pods.</p>
</li>
<li>
<p>Service account used by the MirrorMaker 2 pods.</p>
</li>
<li>
<p>Pod disruption budget configured for the MirrorMaker 2 worker nodes.</p>
</li>
<li>
<p>Network Policy managing access to the MirrorMaker 2 REST API.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">&lt;mirrormaker2_cluster_name&gt;-mirrormaker2-&lt;pod_id&gt;</dt>
<dd>
<p>Pods created by the MirrorMaker 2 StrimziPodSet.</p>
</dd>
<dt class="hdlist1">&lt;mirrormaker2_cluster_name&gt;-mirrormaker2-api</dt>
<dd>
<p>Service which exposes the REST interface for managing the MirrorMaker 2 cluster.</p>
</dd>
<dt class="hdlist1">&lt;mirrormaker2_cluster_name&gt;-mirrormaker2-config</dt>
<dd>
<p>ConfigMap which contains the MirrorMaker 2 ancillary configuration and is mounted as a volume by the MirrorMaker 2 pods.</p>
</dd>
<dt class="hdlist1">strimzi-&lt;namespace-name&gt;-&lt;mirrormaker2_cluster_name&gt;-mirrormaker2-init</dt>
<dd>
<p>Cluster role binding used by the MirrorMaker 2 cluster.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="ref-list-of-kafka-mirror-maker-resources-str"><a class="link" href="#ref-list-of-kafka-mirror-maker-resources-str">5.6.3. List of Kafka MirrorMaker cluster resources</a></h4>
<div class="paragraph">
<p>The following resources are created by the Cluster Operator in the Kubernetes cluster:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">&lt;mirrormaker_cluster_name&gt;-mirror-maker</dt>
<dd>
<p>Name given to the following MirrorMaker resources:</p>
<div class="ulist">
<ul>
<li>
<p>Deployment which is responsible for creating the MirrorMaker pods.</p>
</li>
<li>
<p>Service account used by the MirrorMaker nodes.</p>
</li>
<li>
<p>Pod Disruption Budget configured for the MirrorMaker worker nodes.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">&lt;mirrormaker_cluster_name&gt;-mirror-maker-config</dt>
<dd>
<p>ConfigMap which contains ancillary configuration for MirrorMaker, and is mounted as a volume by the MirrorMaker pods.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kafka-bridge-str"><a class="link" href="#kafka-bridge-str">5.7. Deploying Kafka Bridge</a></h3>
<div class="paragraph _abstract">
<p>Kafka Bridge provides an API for integrating HTTP-based clients with a Kafka cluster.</p>
</div>
<div class="sect3">
<h4 id="deploying-kafka-bridge-str"><a class="link" href="#deploying-kafka-bridge-str">5.7.1. Deploying Kafka Bridge to your Kubernetes cluster</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy a Kafka Bridge cluster to your Kubernetes cluster using the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>The deployment uses a YAML file to provide the specification to create a <code>KafkaBridge</code> resource.</p>
</div>
<div class="paragraph">
<p>Strimzi provides <a href="#config-examples-str">example configuration files</a>.
In this procedure, we use the following example file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/bridge/kafka-bridge.yaml</code></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy Kafka Bridge to your Kubernetes cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/bridge/kafka-bridge.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods -n <em>&lt;my_cluster_operator_namespace&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the deployment name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                       READY  STATUS   RESTARTS
my-bridge-bridge-&lt;pod_id&gt;  1/1    Running  0</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>my-bridge</code> is the name of the Kafka Bridge cluster.</p>
</div>
<div class="paragraph">
<p>A pod ID identifies each pod created.</p>
</div>
<div class="paragraph">
<p>With the default deployment, you install a single Kafka Bridge pod.</p>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>STATUS</code> displays as <code>Running</code>.</p>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#con-config-kafka-bridge-str">Kafka Bridge cluster configuration</a></p>
</li>
<li>
<p><a href="https://strimzi.io/docs/bridge/latest/" target="_blank" rel="noopener">Using the Strimzi Kafka Bridge</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="proc-exposing-kafka-bridge-service-local-machine-str"><a class="link" href="#proc-exposing-kafka-bridge-service-local-machine-str">5.7.2. Exposing the Kafka Bridge service to your local machine</a></h4>
<div class="paragraph _abstract">
<p>Use port forwarding to expose the Strimzi Kafka Bridge service to your local machine on <a href="http://localhost:8080" class="bare">http://localhost:8080</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Port forwarding is only suitable for development and testing purposes.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>List the names of the pods in your Kubernetes cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods -o name

pod/kafka-consumer
# ...
pod/my-bridge-bridge-&lt;pod_id&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Connect to the Kafka Bridge pod on port <code>8080</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl port-forward pod/my-bridge-bridge-&lt;pod_id&gt; 8080:8080 &amp;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If port 8080 on your local machine is already in use, use an alternative HTTP port, such as <code>8008</code>.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>API requests are now forwarded from port 8080 on your local machine to port 8080 in the Kafka Bridge pod.</p>
</div>
</div>
<div class="sect3">
<h4 id="con-accessing-kafka-bridge-from-outside-str"><a class="link" href="#con-accessing-kafka-bridge-from-outside-str">5.7.3. Accessing the Kafka Bridge outside of Kubernetes</a></h4>
<div class="paragraph">
<p>After deployment, the Strimzi Kafka Bridge can only be accessed by applications running in the same Kubernetes cluster.
These applications use the <code><em>&lt;kafka_bridge_name&gt;</em>-bridge-service</code> service to access the API.</p>
</div>
<div class="paragraph">
<p>If you want to make the Kafka Bridge accessible to applications running outside of the Kubernetes cluster, you can expose it manually by creating one of the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>LoadBalancer</code> or <code>NodePort</code> type services</p>
</li>
<li>
<p><code>Ingress</code> resources (Kubernetes only)</p>
</li>
<li>
<p>OpenShift routes (OpenShift only)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you decide to create Services, use the labels from the <code>selector</code> of the <code><em>&lt;kafka_bridge_name&gt;</em>-bridge-service</code> service to configure the pods to which the service will route the traffic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  # ...
  selector:
    strimzi.io/cluster: kafka-bridge-name <b class="conum">(1)</b>
    strimzi.io/kind: KafkaBridge
  #...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Name of the Kafka Bridge custom resource in your Kubernetes cluster.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="ref-list-of-kafka-bridge-resources-str"><a class="link" href="#ref-list-of-kafka-bridge-resources-str">5.7.4. List of Kafka Bridge cluster resources</a></h4>
<div class="paragraph">
<p>The following resources are created by the Cluster Operator in the Kubernetes cluster:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">&lt;bridge_cluster_name&gt;-bridge</dt>
<dd>
<p>Deployment which is in charge to create the Kafka Bridge worker node pods.</p>
</dd>
<dt class="hdlist1">&lt;bridge_cluster_name&gt;-bridge-service</dt>
<dd>
<p>Service which exposes the REST interface of the Kafka Bridge cluster.</p>
</dd>
<dt class="hdlist1">&lt;bridge_cluster_name&gt;-bridge-config</dt>
<dd>
<p>ConfigMap which contains the Kafka Bridge ancillary configuration and is mounted as a volume by the Kafka broker pods.</p>
</dd>
<dt class="hdlist1">&lt;bridge_cluster_name&gt;-bridge</dt>
<dd>
<p>Pod Disruption Budget configured for the Kafka Bridge worker nodes.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="deploy-standalone-operators_str"><a class="link" href="#deploy-standalone-operators_str">5.8. Alternative standalone deployment options for Strimzi operators</a></h3>
<div class="paragraph _abstract">
<p>You can perform a standalone deployment of the Topic Operator and User Operator.
Consider a standalone deployment of these operators if you are using a Kafka cluster that is not managed by the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>You deploy the operators to Kubernetes.
Kafka can be running outside of Kubernetes.
For example, you might be using a Kafka as a managed service.
You adjust the deployment configuration for the standalone operator to match the address of your Kafka cluster.</p>
</div>
<div class="sect3">
<h4 id="deploying-the-topic-operator-standalone-str"><a class="link" href="#deploying-the-topic-operator-standalone-str">5.8.1. Deploying the standalone Topic Operator</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy the Topic Operator in unidirectional mode as a standalone component for topic management.
You can use a standalone Topic Operator with a Kafka cluster that is not managed by the Cluster Operator.
Unidirectional topic management maintains topics solely through <code>KafkaTopic</code> resources.
For more information on unidirectional topic management, see <a href="#ref-operator-topic-str">Topic management modes</a>.
Alternate configuration is also shown for deploying the Topic Operator in bidirectional mode.</p>
</div>
<div class="paragraph">
<p>Standalone deployment files are provided with Strimzi.
Use the <code>05-Deployment-strimzi-topic-operator.yaml</code> deployment file to deploy the Topic Operator.
Add or set the environment variables needed to make a connection to a Kafka cluster.</p>
</div>
<div class="paragraph">
<p>The Topic Operator watches for <code>KafkaTopic</code> resources in a single namespace.
You specify the namespace to watch, and the connection to the Kafka cluster, in the Topic Operator configuration.
A single Topic Operator can watch a single namespace.
One namespace should be watched by only one Topic Operator.
If you want to use more than one Topic Operator, configure each of them to watch different namespaces.
In this way, you can use Topic Operators with multiple Kafka clusters.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You are running a Kafka cluster for the Topic Operator to connect to.</p>
<div class="paragraph">
<p>As long as the standalone Topic Operator is correctly configured for connection,
the Kafka cluster can be running on a bare-metal environment, a virtual machine, or as a managed cloud application service.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <code>env</code> properties in the <code>install/topic-operator/05-Deployment-strimzi-topic-operator.yaml</code> standalone deployment file.</p>
<div class="listingblock">
<div class="title">Example standalone Topic Operator deployment configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: apps/v1
kind: Deployment
metadata:
  name: strimzi-topic-operator
  labels:
    app: strimzi
spec:
  # ...
  template:
    # ...
    spec:
      # ...
      containers:
        - name: strimzi-topic-operator
          # ...
          env:
            - name: STRIMZI_NAMESPACE # <b class="conum">(1)</b>
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: STRIMZI_KAFKA_BOOTSTRAP_SERVERS # <b class="conum">(2)</b>
              value: my-kafka-bootstrap-address:9092
            - name: STRIMZI_RESOURCE_LABELS # <b class="conum">(3)</b>
              value: "strimzi.io/cluster=my-cluster"
            - name: STRIMZI_FULL_RECONCILIATION_INTERVAL_MS # <b class="conum">(4)</b>
              value: "120000"
            - name: STRIMZI_LOG_LEVEL # <b class="conum">(5)</b>
              value: INFO
            - name: STRIMZI_TLS_ENABLED # <b class="conum">(6)</b>
              value: "false"
            - name: STRIMZI_JAVA_OPTS # <b class="conum">(7)</b>
              value: "-Xmx=512M -Xms=256M"
            - name: STRIMZI_JAVA_SYSTEM_PROPERTIES # <b class="conum">(8)</b>
              value: "-Djavax.net.debug=verbose -DpropertyName=value"
            - name: STRIMZI_PUBLIC_CA # <b class="conum">(9)</b>
              value: "false"
            - name: STRIMZI_TLS_AUTH_ENABLED # <b class="conum">(10)</b>
              value: "false"
            - name: STRIMZI_SASL_ENABLED # <b class="conum">(11)</b>
              value: "false"
            - name: STRIMZI_SASL_USERNAME # <b class="conum">(12)</b>
              value: "admin"
            - name: STRIMZI_SASL_PASSWORD # <b class="conum">(13)</b>
              value: "password"
            - name: STRIMZI_SASL_MECHANISM # <b class="conum">(14)</b>
              value: "scram-sha-512"
            - name: STRIMZI_SECURITY_PROTOCOL # <b class="conum">(15)</b>
              value: "SSL"
            - name: STRIMZI_USE_FINALIZERS
              value: "false" # <b class="conum">(16)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Kubernetes namespace for the Topic Operator to watch for <code>KafkaTopic</code> resources. Specify the namespace of the Kafka cluster.</p>
</li>
<li>
<p>The host and port pair of the bootstrap broker address to discover and connect to all brokers in the Kafka cluster.
Use a comma-separated list to specify two or three broker addresses in case a server is down.</p>
</li>
<li>
<p>The label to identify the <code>KafkaTopic</code> resources managed by the Topic Operator.
This does not have to be the name of the Kafka cluster.
It can be the label assigned to the <code>KafkaTopic</code> resource.
If you deploy more than one Topic Operator, the labels must be unique for each.
That is, the operators cannot manage the same resources.</p>
</li>
<li>
<p>The interval between periodic reconciliations, in milliseconds.
The default is <code>120000</code> (2 minutes).</p>
</li>
<li>
<p>The level for printing logging messages.
You can set the level to <code>ERROR</code>, <code>WARNING</code>, <code>INFO</code>, <code>DEBUG</code>, or <code>TRACE</code>.</p>
</li>
<li>
<p>Enables TLS support for encrypted communication with the Kafka brokers.</p>
</li>
<li>
<p>(Optional) The Java options used by the JVM running the Topic Operator.</p>
</li>
<li>
<p>(Optional) The debugging (<code>-D</code>) options set for the Topic Operator.</p>
</li>
<li>
<p>(Optional) Skips the generation of trust store certificates if TLS is enabled through <code>STRIMZI_TLS_ENABLED</code>. If this environment variable is enabled, the brokers must use a public trusted certificate authority for their TLS certificates.
The default is <code>false</code>.</p>
</li>
<li>
<p>(Optional) Generates key store certificates for mTLS authentication. Setting this to <code>false</code> disables client authentication with mTLS to the Kafka brokers.
The default is <code>true</code>.</p>
</li>
<li>
<p>(Optional) Enables SASL support for client authentication when connecting to Kafka brokers.
The default is <code>false</code>.</p>
</li>
<li>
<p>(Optional) The SASL username for client authentication.
Mandatory only if SASL is enabled through <code>STRIMZI_SASL_ENABLED</code>.</p>
</li>
<li>
<p>(Optional) The SASL password for client authentication.
Mandatory only if SASL is enabled through <code>STRIMZI_SASL_ENABLED</code>.</p>
</li>
<li>
<p>(Optional) The SASL mechanism for client authentication.
Mandatory only if SASL is enabled through <code>STRIMZI_SASL_ENABLED</code>.
You can set the value to <code>plain</code>, <code>scram-sha-256</code>, or <code>scram-sha-512</code>.</p>
</li>
<li>
<p>(Optional) The security protocol used for communication with Kafka brokers.
The default value is "PLAINTEXT".
You can set the value to <code>PLAINTEXT</code>, <code>SSL</code>, <code>SASL_PLAINTEXT</code>, or <code>SASL_SSL</code>.</p>
</li>
<li>
<p>Set <code>STRIMZI_USE_FINALIZERS</code> to <code>false</code> if you do not want to use finalizers to control <a href="#con-deleting-managed-topics-str">topic deletion</a>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If you want to connect to Kafka brokers that are using certificates from a public certificate authority, set <code>STRIMZI_PUBLIC_CA</code> to <code>true</code>. Set this property to <code>true</code>, for example, if you are using Amazon AWS MSK service.</p>
</li>
<li>
<p>If you enabled mTLS with the <code>STRIMZI_TLS_ENABLED</code> environment variable, specify the keystore and truststore used to authenticate connection to the Kafka cluster.</p>
<div class="listingblock">
<div class="title">Example mTLS configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># ....
env:
  - name: STRIMZI_TRUSTSTORE_LOCATION # <b class="conum">(1)</b>
    value: "/path/to/truststore.p12"
  - name: STRIMZI_TRUSTSTORE_PASSWORD # <b class="conum">(2)</b>
    value: "<em>TRUSTSTORE-PASSWORD</em>"
  - name: STRIMZI_KEYSTORE_LOCATION # <b class="conum">(3)</b>
    value: "/path/to/keystore.p12"
  - name: STRIMZI_KEYSTORE_PASSWORD # <b class="conum">(4)</b>
    value: "<em>KEYSTORE-PASSWORD</em>"
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The truststore contains the public keys of the Certificate Authorities used to sign the Kafka and ZooKeeper server certificates.</p>
</li>
<li>
<p>The password for accessing the truststore.</p>
</li>
<li>
<p>The keystore contains the private key for mTLS authentication.</p>
</li>
<li>
<p>The password for accessing the keystore.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Apply the changes to the <code>Deployment</code> configuration to deploy the Topic Operator.</p>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the deployment name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                    READY  UP-TO-DATE  AVAILABLE
strimzi-topic-operator  1/1    1           1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>AVAILABLE</code> output shows <code>1</code>.</p>
</div>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="deploying_the_standalone_topic_operator_for_bidirectional_topic_management"><a class="link" href="#deploying_the_standalone_topic_operator_for_bidirectional_topic_management">Deploying the standalone Topic Operator for bidirectional topic management</a></h5>
<div class="paragraph">
<p>Bidirectional topic management requires ZooKeeper for cluster management, and maintains topics through <code>KafkaTopic</code> resources and within the Kafka cluster.
If you want to switch to using the Topic Operator in this mode, follow these steps to deploy the standalone Topic Operator.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
As the feature gate enabling the Topic Operator to run in unidirectional mode progresses to General Availability, bidirectional mode will be phased out. This transition is aimed at enhancing the user experience, particularly in supporting Kafka in KRaft mode.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Undeploy the current standalone Topic Operator.</p>
<div class="paragraph">
<p>Retain the <code>KafkaTopic</code> resources, which are picked up by the Topic Operator when it is deployed again.</p>
</div>
</li>
<li>
<p>Edit the <code>Deployment</code> configuration for the standalone Topic Operator to include ZooKeeper-related environment variables:</p>
<div class="ulist">
<ul>
<li>
<p><code>STRIMZI_ZOOKEEPER_CONNECT</code></p>
</li>
<li>
<p><code>STRIMZI_ZOOKEEPER_SESSION_TIMEOUT_MS</code></p>
</li>
<li>
<p><code>TC_ZK_CONNECTION_TIMEOUT_MS</code></p>
</li>
<li>
<p><code>STRIMZI_USE_ZOOKEEPER_TOPIC_STORE</code></p>
<div class="paragraph">
<p>It is the presence or absence of the ZooKeeper variables that defines whether the bidirectional Topic Operator is used.
Unidirectional topic management does not use ZooKeeper.
If ZooKeeper environment variables are not present, the unidirectional Topic Operator is used.
Otherwise, the bidirectional Topic Operator is used.</p>
</div>
<div class="paragraph">
<p>Other environment variables that are not used in unidirectional mode can be added if required:</p>
</div>
</li>
<li>
<p><code>STRIMZI_REASSIGN_THROTTLE</code></p>
</li>
<li>
<p><code>STRIMZI_REASSIGN_VERIFY_INTERVAL_MS</code></p>
</li>
<li>
<p><code>STRIMZI_TOPIC_METADATA_MAX_ATTEMPTS</code></p>
</li>
<li>
<p><code>STRIMZI_TOPICS_PATH</code></p>
</li>
<li>
<p><code>STRIMZI_STORE_TOPIC</code></p>
</li>
<li>
<p><code>STRIMZI_STORE_NAME</code></p>
</li>
<li>
<p><code>STRIMZI_APPLICATION_ID</code></p>
</li>
<li>
<p><code>STRIMZI_STALE_RESULT_TIMEOUT_MS</code></p>
<div class="listingblock">
<div class="title">Example standalone Topic Operator deployment configuration for bidirectional topic management</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: apps/v1
kind: Deployment
metadata:
  name: strimzi-topic-operator
  labels:
    app: strimzi
spec:
  # ...
  template:
    # ...
    spec:
      # ...
      containers:
        - name: strimzi-topic-operator
          # ...
          env:
            - name: STRIMZI_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: STRIMZI_KAFKA_BOOTSTRAP_SERVERS
              value: my-kafka-bootstrap-address:9092
            - name: STRIMZI_RESOURCE_LABELS
              value: "strimzi.io/cluster=my-cluster"
            - name: STRIMZI_ZOOKEEPER_CONNECT # <b class="conum">(1)</b>
              value: my-cluster-zookeeper-client:2181
            - name: STRIMZI_ZOOKEEPER_SESSION_TIMEOUT_MS # <b class="conum">(2)</b>
              value: "18000"
            - name: STRIMZI_TOPIC_METADATA_MAX_ATTEMPTS # <b class="conum">(3)</b>
              value: "6"
            - name: STRIMZI_FULL_RECONCILIATION_INTERVAL_MS
              value: "120000"
            - name: STRIMZI_LOG_LEVEL
              value: INFO
            - name: STRIMZI_TLS_ENABLED
              value: "false"
            - name: STRIMZI_JAVA_OPTS
              value: "-Xmx=512M -Xms=256M"
            - name: STRIMZI_JAVA_SYSTEM_PROPERTIES
              value: "-Djavax.net.debug=verbose -DpropertyName=value"
            - name: STRIMZI_PUBLIC_CA
              value: "false"
            - name: STRIMZI_TLS_AUTH_ENABLED
              value: "false"
            - name: STRIMZI_SASL_ENABLED
              value: "false"
            - name: STRIMZI_SASL_USERNAME
              value: "admin"
            - name: STRIMZI_SASL_PASSWORD
              value: "password"
            - name: STRIMZI_SASL_MECHANISM
              value: "scram-sha-512"
            - name: STRIMZI_SECURITY_PROTOCOL
              value: "SSL"</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>(ZooKeeper) The host and port pair of the address to connect to the ZooKeeper cluster.
This must be the same ZooKeeper cluster that your Kafka cluster is using.</p>
</li>
<li>
<p>(ZooKeeper) The ZooKeeper session timeout, in milliseconds.
The default is <code>18000</code> (18 seconds).</p>
</li>
<li>
<p>The number of attempts at getting topic metadata from Kafka.
The time between each attempt is defined as an exponential backoff.
Consider increasing this value when topic creation takes more time due to the number of partitions or replicas.
The default is <code>6</code> attempts.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Apply the changes to the <code>Deployment</code> configuration to deploy the Topic Operator.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="deploying-the-user-operator-standalone-str"><a class="link" href="#deploying-the-user-operator-standalone-str">5.8.2. Deploying the standalone User Operator</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy the User Operator as a standalone component for user management.
You can use a standalone User Operator with a Kafka cluster that is not managed by the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>A standalone deployment can operate with any Kafka cluster.</p>
</div>
<div class="paragraph">
<p>Standalone deployment files are provided with Strimzi.
Use the <code>05-Deployment-strimzi-user-operator.yaml</code> deployment file to deploy the User Operator.
Add or set the environment variables needed to make a connection to a Kafka cluster.</p>
</div>
<div class="paragraph">
<p>The User Operator watches for <code>KafkaUser</code> resources in a single namespace.
You specify the namespace to watch, and the connection to the Kafka cluster, in the User Operator configuration.
A single User Operator can watch a single namespace.
One namespace should be watched by only one User Operator.
If you want to use more than one User Operator, configure each of them to watch different namespaces.
In this way, you can use the User Operator with multiple Kafka clusters.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You are running a Kafka cluster for the User Operator to connect to.</p>
<div class="paragraph">
<p>As long as the standalone User Operator is correctly configured for connection,
the Kafka cluster can be running on a bare-metal environment, a virtual machine, or as a managed cloud application service.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the following <code>env</code> properties in the <code>install/user-operator/05-Deployment-strimzi-user-operator.yaml</code> standalone deployment file.</p>
<div class="listingblock">
<div class="title">Example standalone User Operator deployment configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: apps/v1
kind: Deployment
metadata:
  name: strimzi-user-operator
  labels:
    app: strimzi
spec:
  # ...
  template:
    # ...
    spec:
      # ...
      containers:
        - name: strimzi-user-operator
          # ...
          env:
            - name: STRIMZI_NAMESPACE <b class="conum">(1)</b>
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: STRIMZI_KAFKA_BOOTSTRAP_SERVERS <b class="conum">(2)</b>
              value: my-kafka-bootstrap-address:9092
            - name: STRIMZI_CA_CERT_NAME <b class="conum">(3)</b>
              value: my-cluster-clients-ca-cert
            - name: STRIMZI_CA_KEY_NAME <b class="conum">(4)</b>
              value: my-cluster-clients-ca
            - name: STRIMZI_LABELS <b class="conum">(5)</b>
              value: "strimzi.io/cluster=my-cluster"
            - name: STRIMZI_FULL_RECONCILIATION_INTERVAL_MS <b class="conum">(6)</b>
              value: "120000"
            - name: STRIMZI_WORK_QUEUE_SIZE <b class="conum">(7)</b>
              value: 10000
            - name: STRIMZI_CONTROLLER_THREAD_POOL_SIZE <b class="conum">(8)</b>
              value: 10
            - name: STRIMZI_USER_OPERATIONS_THREAD_POOL_SIZE <b class="conum">(9)</b>
              value: 4
            - name: STRIMZI_LOG_LEVEL <b class="conum">(10)</b>
              value: INFO
            - name: STRIMZI_GC_LOG_ENABLED <b class="conum">(11)</b>
              value: "true"
            - name: STRIMZI_CA_VALIDITY <b class="conum">(12)</b>
              value: "365"
            - name: STRIMZI_CA_RENEWAL <b class="conum">(13)</b>
              value: "30"
            - name: STRIMZI_JAVA_OPTS <b class="conum">(14)</b>
              value: "-Xmx=512M -Xms=256M"
            - name: STRIMZI_JAVA_SYSTEM_PROPERTIES <b class="conum">(15)</b>
              value: "-Djavax.net.debug=verbose -DpropertyName=value"
            - name: STRIMZI_SECRET_PREFIX <b class="conum">(16)</b>
              value: "kafka-"
            - name: STRIMZI_ACLS_ADMIN_API_SUPPORTED <b class="conum">(17)</b>
              value: "true"
            - name: STRIMZI_MAINTENANCE_TIME_WINDOWS <b class="conum">(18)</b>
              value: '* * 8-10 * * ?;* * 14-15 * * ?'
            - name: STRIMZI_KAFKA_ADMIN_CLIENT_CONFIGURATION <b class="conum">(19)</b>
              value: |
                default.api.timeout.ms=120000
                request.timeout.ms=60000</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Kubernetes namespace for the User Operator to watch for <code>KafkaUser</code> resources. Only one namespace can be specified.</p>
</li>
<li>
<p>The host and port pair of the bootstrap broker address to discover and connect to all brokers in the Kafka cluster.
Use a comma-separated list to specify two or three broker addresses in case a server is down.</p>
</li>
<li>
<p>The Kubernetes <code>Secret</code> that contains the public key (<code>ca.crt</code>) value of the CA (certificate authority) that signs new user certificates for mTLS authentication.</p>
</li>
<li>
<p>The Kubernetes <code>Secret</code> that contains the private key (<code>ca.key</code>) value of the CA that signs new user certificates for mTLS authentication.</p>
</li>
<li>
<p>The label to identify the <code>KafkaUser</code> resources managed by the User Operator.
This does not have to be the name of the Kafka cluster.
It can be the label assigned to the <code>KafkaUser</code> resource.
If you deploy more than one User Operator, the labels must be unique for each.
That is, the operators cannot manage the same resources.</p>
</li>
<li>
<p>The interval between periodic reconciliations, in milliseconds.
The default is <code>120000</code> (2 minutes).</p>
</li>
<li>
<p>The size of the controller event queue.
The size of the queue should be at least as big as the maximal amount of users you expect the User Operator to operate.
The default is <code>1024</code>.</p>
</li>
<li>
<p>The size of the worker pool for reconciling the users.
Bigger pool might require more resources, but it will also handle more <code>KafkaUser</code> resources
The default is <code>50</code>.</p>
</li>
<li>
<p>The size of the worker pool for Kafka Admin API and Kubernetes operations.
Bigger pool might require more resources, but it will also handle more <code>KafkaUser</code> resources
The default is <code>4</code>.</p>
</li>
<li>
<p>The level for printing logging messages.
You can set the level to <code>ERROR</code>, <code>WARNING</code>, <code>INFO</code>, <code>DEBUG</code>, or <code>TRACE</code>.</p>
</li>
<li>
<p>Enables garbage collection (GC) logging.
The default is <code>true</code>.</p>
</li>
<li>
<p>The validity period for the CA.
The default is <code>365</code> days.</p>
</li>
<li>
<p>The renewal period for the CA. The renewal period is measured backwards from the expiry date of the current certificate.
The default is <code>30</code> days to initiate certificate renewal before the old certificates expire.</p>
</li>
<li>
<p>(Optional) The Java options used by the JVM running the User Operator</p>
</li>
<li>
<p>(Optional) The debugging (<code>-D</code>) options set for the User Operator</p>
</li>
<li>
<p>(Optional) Prefix for the names of Kubernetes secrets created by the User Operator.</p>
</li>
<li>
<p>(Optional) Indicates whether the Kafka cluster supports management of authorization ACL rules using the Kafka Admin API.
When set to <code>false</code>, the User Operator will reject all resources with <code>simple</code> authorization ACL rules.
This helps to avoid unnecessary exceptions in the Kafka cluster logs.
The default is <code>true</code>.</p>
</li>
<li>
<p>(Optional) Semi-colon separated list of Cron Expressions defining the maintenance time windows during which the expiring user certificates will be renewed.</p>
</li>
<li>
<p>(Optional) Configuration options for configuring the Kafka Admin client used by the User Operator in the properties format.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If you are using mTLS to connect to the Kafka cluster, specify the secrets used to authenticate connection.
Otherwise, go to the next step.</p>
<div class="listingblock">
<div class="title">Example mTLS configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># ....
env:
  - name: STRIMZI_CLUSTER_CA_CERT_SECRET_NAME <b class="conum">(1)</b>
    value: my-cluster-cluster-ca-cert
  - name: STRIMZI_EO_KEY_SECRET_NAME <b class="conum">(2)</b>
    value: my-cluster-entity-operator-certs
# ..."</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Kubernetes <code>Secret</code> that contains the public key (<code>ca.crt</code>) value of the CA that signs Kafka broker certificates.</p>
</li>
<li>
<p>The Kubernetes <code>Secret</code> that contains the certificate public key (<code>entity-operator.crt</code>) and private key (<code>entity-operator.key</code>) that is used for mTLS authentication against the Kafka cluster.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Deploy the User Operator.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/user-operator</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the deployment name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                   READY  UP-TO-DATE  AVAILABLE
strimzi-user-operator  1/1    1           1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>AVAILABLE</code> output shows <code>1</code>.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying-strimzi-from-operator-hub-str"><a class="link" href="#deploying-strimzi-from-operator-hub-str">6. Deploying Strimzi from OperatorHub.io</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>OperatorHub.io is a catalog of Kubernetes operators sourced from multiple providers.
It offers you an alternative way to install a stable version of Strimzi.</p>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/operator-framework/operator-lifecycle-manager" target="_blank" rel="noopener">Operator Lifecycle Manager</a> is used for the installation and management of all operators published on OperatorHub.io.
<a href="https://github.com/operator-framework/operator-lifecycle-manager" target="_blank" rel="noopener">Operator Lifecycle Manager</a> is a prerequisite for installing the Strimzi Kafka operator</p>
</div>
<div class="paragraph">
<p>To install Strimzi, locate <em>Strimzi</em> from <a href="https://operatorhub.io/operator/strimzi-kafka-operator" target="_blank" rel="noopener">OperatorHub.io</a>, and follow the instructions provided to deploy the Cluster Operator.
After you have deployed the Cluster Operator, you can deploy Strimzi components using custom resources.
For example, you can deploy the <code>Kafka</code> custom resource, and the installed Cluster Operator will create a Kafka cluster.</p>
</div>
<div class="paragraph">
<p>Upgrades between versions might include manual steps.
Always read the release notes before upgrading.</p>
</div>
<div class="paragraph">
<p>For information on upgrades, see <a href="#assembly-upgrade-str">Upgrading Strimzi</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Make sure you use the appropriate update channel.
Installing Strimzi from the default <em>stable</em> channel is generally safe.
However, we do not recommend enabling <em>automatic</em> OLM updates on the stable channel.
An automatic upgrade will skip any necessary steps prior to upgrade.
For example, to upgrade from 0.22 or earlier
you must first <a href="#con-upgrade-paths-earlier-versions-str">update custom resources to support the <code>v1beta2</code> API version</a>.
Use automatic upgrades only on version-specific channels.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying-cluster-operator-helm-chart-str"><a class="link" href="#deploying-cluster-operator-helm-chart-str">7. Deploying Strimzi using Helm</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p><a href="https://helm.sh/">Helm</a> charts are used to package, configure, and deploy Kubernetes resources.
Strimzi provides a Helm chart to deploy the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>After you have deployed the Cluster Operator this way, you can deploy Strimzi components using custom resources.
For example, you can deploy the <code>Kafka</code> custom resource, and the installed Cluster Operator will create a Kafka cluster.</p>
</div>
<div class="paragraph">
<p>For information on upgrades, see <a href="#assembly-upgrade-str">Upgrading Strimzi</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Helm client must be installed on a local machine.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Install the Strimzi Cluster Operator using the Helm command line tool:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">helm install strimzi-cluster-operator oci://quay.io/strimzi-helm/strimzi-kafka-operator</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can use parameter values to install a specific version of the Cluster Operator or specify any changes to the default configuration.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration that installs a specific version of the Cluster Operator and changes the number of replicas</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">helm install strimzi-cluster-operator --set replicas=2 --version 0.35.0 oci://quay.io/strimzi-helm/strimzi-kafka-operator</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the Cluster Operator has been deployed successfully using the Helm command line tool:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">helm ls</code></pre>
</div>
</div>
</li>
<li>
<p><a href="#deploying-kafka-cluster-str">Deploy Kafka</a> and other Kafka components using custom resources.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ref-operator-cluster-feature-gates-str"><a class="link" href="#ref-operator-cluster-feature-gates-str">8. Enabling Strimzi feature gates</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Strimzi operators use feature gates to enable or disable specific features and functions.
By enabling a feature gate, you alter the behavior of the corresponding operator, thereby introducing the feature to your Strimzi deployment.</p>
</div>
<div class="paragraph">
<p>A feature gate might be enabled or disabled by default, depending on its level of maturity.</p>
</div>
<div class="paragraph">
<p>To modify a feature gate&#8217;s default state, use the <code>STRIMZI_FEATURE_GATES</code> environment variable in the operator&#8217;s configuration.
You can modify multiple feature gates using this single environment variable.
Specify a comma-separated list of feature gate names and prefixes.
A <code>+</code> prefix enables the feature gate and a <code>-</code> prefix  disables it.</p>
</div>
<div class="listingblock">
<div class="title">Example feature gate configuration that enables <code>FeatureGate1</code> and disables <code>FeatureGate2</code></div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: STRIMZI_FEATURE_GATES
    value: +FeatureGate1,-FeatureGate2</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="controlplanelistener_feature_gate"><a class="link" href="#controlplanelistener_feature_gate">8.1. ControlPlaneListener feature gate</a></h3>
<div class="paragraph">
<p>The <code>ControlPlaneListener</code> feature gate has moved to GA, which means it is now permanently enabled and cannot be disabled.
With <code>ControlPlaneListener</code> enabled, the connections between the Kafka controller and brokers use an internal <em>control plane listener</em> on port 9090.
Replication of data between brokers, as well as internal connections from Strimzi operators, Cruise Control, or the Kafka Exporter use the <em>replication listener</em> on port 9091.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
With the <code>ControlPlaneListener</code> feature gate permanently enabled, it is no longer possible to upgrade or downgrade directly between Strimzi 0.22 and earlier and Strimzi 0.32 and newer.
You have to first upgrade or downgrade through one of the Strimzi versions in-between, disable the <code>ControlPlaneListener</code> feature gate, and then downgrade or upgrade (with the feature gate enabled) to the target version.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="serviceaccountpatching_feature_gate"><a class="link" href="#serviceaccountpatching_feature_gate">8.2. ServiceAccountPatching feature gate</a></h3>
<div class="paragraph">
<p>The <code>ServiceAccountPatching</code> feature gate has moved to GA, which means it is now permanently enabled and cannot be disabled.
With <code>ServiceAccountPatching</code> enabled, the Cluster Operator always reconciles service accounts and updates them when needed.
For example, when you change service account labels or annotations using the <code>template</code> property of a custom resource, the operator automatically updates them on the existing service account resources.</p>
</div>
</div>
<div class="sect2">
<h3 id="ref-operator-use-strimzi-pod-sets-feature-gate-str"><a class="link" href="#ref-operator-use-strimzi-pod-sets-feature-gate-str">8.3. UseStrimziPodSets feature gate</a></h3>
<div class="paragraph">
<p>The <code>UseStrimziPodSets</code> feature gate has moved to GA, which means it is now permanently enabled and cannot be disabled.
Support for <code>StatefulSets</code> has been removed and Strimzi is now always using <code>StrimziPodSets</code> to manage Kafka and ZooKeeper pods.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
With the <code>UseStrimziPodSets</code> feature gate permanently enabled, it is no longer possible to downgrade directly from Strimzi 0.35 and newer to Strimzi 0.27 or earlier.
You have to first downgrade through one of the Strimzi versions in-between, disable the <code>UseStrimziPodSets</code> feature gate, and then downgrade to Strimzi 0.27 or earlier.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ref-operator-stable-connect-identities-feature-gate-str"><a class="link" href="#ref-operator-stable-connect-identities-feature-gate-str">8.4. StableConnectIdentities feature gate</a></h3>
<div class="paragraph">
<p>The <code>StableConnectIdentities</code> feature gate has moved to GA, which means it is now permanently enabled and cannot be disabled.
The <code>StrimziPodSet</code> resources are now always used to manage Kafka Connect and Kafka MirrorMaker 2 pods instead of using Kubernetes <code>Deployment</code> resources.
<code>StrimziPodSet</code> resources give the pods stable names and stable addresses, which do not change during rolling upgrades.
This helps to minimize the number of rebalances of connector tasks.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
With the <code>StableConnectIdentities</code> feature gate permanently enabled, it is no longer possible to downgrade directly from Strimzi 0.39 and newer to Strimzi 0.33 or earlier.
You have to first downgrade through one of the Strimzi versions in-between, disable the <code>StableConnectIdentities</code> feature gate, and then downgrade to Strimzi 0.33 or earlier.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ref-operator-use-kraft-feature-gate-str"><a class="link" href="#ref-operator-use-kraft-feature-gate-str">8.5. (Preview) UseKRaft feature gate</a></h3>
<div class="paragraph">
<p>The <code>UseKRaft</code> feature gate has a default state of <em>disabled</em>.</p>
</div>
<div class="paragraph">
<p>The <code>UseKRaft</code> feature gate deploys the Kafka cluster in the KRaft (Kafka Raft metadata) mode without ZooKeeper.
ZooKeeper and KRaft are mechanisms used to manage metadata and coordinate operations in Kafka clusters.
KRaft mode eliminates the need for an external coordination service like ZooKeeper.
In KRaft mode, Kafka nodes take on the roles of brokers, controllers, or both.
They collectively manage the metadata, which is replicated across partitions.
Controllers are responsible for coordinating operations and maintaining the cluster&#8217;s state.</p>
</div>
<div class="paragraph">
<p>This feature gate is currently intended only for development and testing.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<strong>KRaft mode is not ready for production in Apache Kafka or in Strimzi.</strong>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enabling the <code>UseKRaft</code> feature gate requires the <code>KafkaNodePools</code> feature gate to be enabled as well.
To deploy a Kafka cluster in KRaft mode, you must use the <code>KafkaNodePool</code> resources.
For more details and examples, see <a href="#deploying-kafka-node-pools-str">Deploying a Kafka cluster with node pools</a>.
The <code>Kafka</code> custom resource using KRaft mode must also have the annotation <code>strimzi.io/kraft: enabled</code>.</p>
</div>
<div class="paragraph">
<p>When the <code>UseKRaft</code> feature gate is enabled and such annotation is set, the Kafka cluster is deployed without ZooKeeper.
<strong>The <code>.spec.zookeeper</code> properties in the <code>Kafka</code> custom resource are ignored, but still need to be present.</strong>
The <code>UseKRaft</code> feature gate provides an API that configures Kafka cluster nodes and their roles.
The API is still in development and is expected to change before the KRaft mode is production-ready.</p>
</div>
<div class="paragraph">
<p>Currently, the KRaft mode in Strimzi has the following major limitations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Moving from Kafka clusters with ZooKeeper to KRaft clusters or the other way around is not supported.</p>
</li>
<li>
<p>Controller-only nodes cannot undergo rolling updates or be updated individually.</p>
</li>
<li>
<p>Upgrades and downgrades of Apache Kafka versions or the Strimzi operator are not supported.
Users might need to delete the cluster, upgrade the operator and deploy a new Kafka cluster.</p>
</li>
<li>
<p>Only the <em>Unidirectional</em> Topic Operator is supported in KRaft mode.
The <em>Bidirectional</em> Topic Operator is not supported and when the <code>UnidirectionalTopicOperator</code> feature gate is not enabled, the <code>spec.entityOperator.topicOperator</code> property <strong>must be removed</strong> from the <code>Kafka</code> custom resource.</p>
</li>
<li>
<p>JBOD storage is not supported.
The <code>type: jbod</code> storage can be used, but the JBOD array can contain only one disk.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Enabling the UseKRaft feature gate</div>
<p>To enable the <code>UseKRaft</code> feature gate, specify <code>+UseKRaft</code> in the <code>STRIMZI_FEATURE_GATES</code> environment variable in the Cluster Operator configuration.
The <code>Kafka</code> custom resource using KRaft mode must also have the annotation <code>strimzi.io/kraft: enabled</code>.
If this annotation is set to <code>disabled</code> or any other value, or if it is missing, the operator handles the <code>Kafka</code> custom resource as if it is using ZooKeeper for cluster management.</p>
</div>
</div>
<div class="sect2">
<h3 id="ref-operator-kafka-node-pools-feature-gate-str"><a class="link" href="#ref-operator-kafka-node-pools-feature-gate-str">8.6. KafkaNodePools feature gate</a></h3>
<div class="paragraph">
<p>The <code>KafkaNodePools</code> feature gate has a default state of <em>enabled</em>.</p>
</div>
<div class="paragraph">
<p>The <code>KafkaNodePools</code> feature gate introduces a new <code>KafkaNodePool</code> custom resource that enables the configuration of different <em>pools</em> of Apache Kafka nodes.</p>
</div>
<div class="paragraph">
<p>A node pool refers to a distinct group of Kafka nodes within a Kafka cluster.
Each pool has its own unique configuration, which includes mandatory settings such as the number of replicas, storage configuration, and a list of assigned roles.
You can assign the <em>controller</em> role, <em>broker</em> role, or both roles to all nodes in the pool in the <code>.spec.roles</code> field.
When used with a ZooKeeper-based Apache Kafka cluster, it must be set to the <code>broker</code> role.
When used with the <code>UseKRaft</code> feature gate, it can be set to <code>broker</code>, <code>controller</code>, or both.</p>
</div>
<div class="paragraph">
<p>In addition, a node pool can have its own configuration of resource requests and limits, Java JVM options, and resource templates.
Configuration options not set in the <code>KafkaNodePool</code> resource are inherited from the <code>Kafka</code> custom resource.</p>
</div>
<div class="paragraph">
<p>The <code>KafkaNodePool</code> resources use a <code>strimzi.io/cluster</code> label to indicate to which Kafka cluster they belong.
The label must be set to the name of the <code>Kafka</code> custom resource.</p>
</div>
<div class="paragraph">
<p>Examples of the <code>KafkaNodePool</code> resources can be found in the <a href="#config-examples-str">example configuration files</a> provided by Strimzi.</p>
</div>
<div class="paragraph">
<div class="title">Disabling the KafkaNodePools feature gate</div>
<p>To disable the <code>KafkaNodePools</code> feature gate, specify <code>-KafkaNodePools</code> in the <code>STRIMZI_FEATURE_GATES</code> environment variable in the Cluster Operator configuration.
The <code>Kafka</code> custom resource using the node pools must also have the annotation <code>strimzi.io/node-pools: enabled</code>.</p>
</div>
<div class="paragraph">
<div class="title">Downgrading from KafkaNodePools</div>
<p>If your cluster already uses <code>KafkaNodePool</code> custom resources, and you wish to downgrade to an older version of Strimzi that does not support them or with the <code>KafkaNodePools</code> feature gate disabled, you must first migrate from <code>KafkaNodePool</code> custom resources to managing Kafka nodes using only <code>Kafka</code> custom resources.</p>
</div>
</div>
<div class="sect2">
<h3 id="ref-operator-unidirectional-topic-operator-feature-gate-str"><a class="link" href="#ref-operator-unidirectional-topic-operator-feature-gate-str">8.7. UnidirectionalTopicOperator feature gate</a></h3>
<div class="paragraph">
<p>The <code>UnidirectionalTopicOperator</code> feature gate has a default state of <em>enabled</em>.</p>
</div>
<div class="paragraph">
<p>The <code>UnidirectionalTopicOperator</code> feature gate introduces a unidirectional topic management mode for creating Kafka topics using the <code>KafkaTopic</code> resource.
Unidirectional mode is compatible with using KRaft for cluster management.
With unidirectional mode, you create Kafka topics using the <code>KafkaTopic</code> resource, which are then managed by the Topic Operator.
Any configuration changes to a topic outside the <code>KafkaTopic</code> resource are reverted.
For more information on topic management, see <a href="#ref-operator-topic-str">Topic management modes</a>.</p>
</div>
<div class="paragraph">
<div class="title">Disabling the <code>UnidirectionalTopicOperator</code> feature gate</div>
<p>To disable the <code>UnidirectionalTopicOperator</code> feature gate, specify <code>-UnidirectionalTopicOperator</code> in the <code>STRIMZI_FEATURE_GATES</code> environment variable in the Cluster Operator configuration.</p>
</div>
</div>
<div class="sect2">
<h3 id="ref-operator-cluster-feature-gate-releases-str"><a class="link" href="#ref-operator-cluster-feature-gate-releases-str">8.8. Feature gate releases</a></h3>
<div class="paragraph _abstract">
<p>Feature gates have three stages of maturity:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Alpha — typically disabled by default</p>
</li>
<li>
<p>Beta — typically enabled by default</p>
</li>
<li>
<p>General Availability (GA) — typically always enabled</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Alpha stage features might be experimental or unstable, subject to change, or not sufficiently tested for production use.
Beta stage features are well tested and their functionality is not likely to change.
GA stage features are stable and should not change in the future.
Alpha and beta stage features are removed if they do not prove to be useful.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>ControlPlaneListener</code> feature gate moved to GA stage in Strimzi 0.32. It is now permanently enabled and cannot be disabled.</p>
</li>
<li>
<p>The <code>ServiceAccountPatching</code> feature gate moved to GA stage in Strimzi 0.30. It is now permanently enabled and cannot be disabled.</p>
</li>
<li>
<p>The <code>UseStrimziPodSets</code> feature gate moved to GA stage in Strimzi 0.35 and the support for StatefulSets is completely removed. It is now permanently enabled and cannot be disabled.</p>
</li>
<li>
<p>The <code>StableConnectIdentities</code> feature gate moved to GA stage in Strimzi 0.39.
It is now permanently enabled and cannot be disabled.</p>
</li>
<li>
<p>The <code>UseKRaft</code> feature gate is available for development only and does not currently have a planned release for moving to the beta phase.</p>
</li>
<li>
<p>The <code>KafkaNodePools</code> feature gate is in beta stage and is enabled by default.
It is expected to move to GA phase and be always enabled from Strimzi 0.41.</p>
</li>
<li>
<p>The <code>UnidirectionalTopicOperator</code> feature gate is in beta stage and is enabled by default.
It is expected to move to GA phase and be always enabled from Strimzi 0.41.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Feature gates might be removed when they reach GA. This means that the feature was incorporated into the Strimzi core features and can no longer be disabled.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 7. Feature gates and the Strimzi versions when they moved to alpha, beta, or GA</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Feature gate</th>
<th class="tableblock halign-left valign-top">Alpha</th>
<th class="tableblock halign-left valign-top">Beta</th>
<th class="tableblock halign-left valign-top">GA</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ControlPlaneListener</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.23</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.32</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ServiceAccountPatching</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.30</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UseStrimziPodSets</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.35</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UseKRaft</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.29</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StableConnectIdentities</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.34</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.37</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.39</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaNodePools</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.36</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.39</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.41 (planned)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UnidirectionalTopicOperator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.36</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.39</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.41 (planned)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If a feature gate is enabled, you may need to disable it before upgrading or downgrading from a specific Strimzi version (or first upgrade / downgrade to a version of Strimzi where it can be disabled).
The following table shows which feature gates you need to disable when upgrading or downgrading Strimzi versions.</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 8. Feature gates to disable when upgrading or downgrading Strimzi</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Disable Feature gate</th>
<th class="tableblock halign-left valign-top">Upgrading from Strimzi version</th>
<th class="tableblock halign-left valign-top">Downgrading to Strimzi version</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ControlPlaneListener</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.22 and earlier</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.22 and earlier</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UseStrimziPodSets</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.27 and earlier</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StableConnectIdentities</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.33 and earlier</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overview-str"><a class="link" href="#overview-str">9. Configuring a deployment</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Configure and manage a Strimzi deployment to your precise needs using Strimzi custom resources.
Strimzi provides example custom resources with each release, allowing you to configure and create instances of supported Kafka components.
Fine-tune your deployment by configuring custom resources to include additional features according to your specific requirements.
For specific areas of configuration, namely metrics, logging, and external configuration for Kafka Connect connectors, you can also use <code>ConfigMap</code> resources.
By using a <code>ConfigMap</code> resource to incorporate configuration, you centralize maintenance.
You can also use configuration providers to load configuration from external sources, which we recommend for supplying the credentials for Kafka Connect connector configuration.</p>
</div>
<div class="paragraph">
<p>Use custom resources to configure and create instances of the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kafka clusters</p>
</li>
<li>
<p>Kafka Connect clusters</p>
</li>
<li>
<p>Kafka MirrorMaker</p>
</li>
<li>
<p>Kafka Bridge</p>
</li>
<li>
<p>Cruise Control</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can also use custom resource configuration to manage your instances or modify your deployment to introduce additional features.
This might include configuration that supports the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Specifying node pools</p>
</li>
<li>
<p>Securing client access to Kafka brokers</p>
</li>
<li>
<p>Accessing Kafka brokers from outside the cluster</p>
</li>
<li>
<p>Creating topics</p>
</li>
<li>
<p>Creating users (clients)</p>
</li>
<li>
<p>Controlling feature gates</p>
</li>
<li>
<p>Changing logging frequency</p>
</li>
<li>
<p>Allocating resource limits and requests</p>
</li>
<li>
<p>Introducing features, such as Strimzi Drain Cleaner, Cruise Control, or distributed tracing.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <a href="./configuring.html" target="_blank" rel="noopener">Strimzi Custom Resource API Reference</a> describes the properties you can use in your configuration.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Labels applied to a custom resource are also applied to the Kubernetes resources making up its cluster.
This provides a convenient mechanism for resources to be labeled as required.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Applying changes to a custom resource configuration file</div>
<p>You add configuration to a custom resource using <code>spec</code> properties.
After adding the configuration, you can use <code>kubectl</code> to apply the changes to a custom resource configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f &lt;kafka_configuration_file&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="config-examples-str"><a class="link" href="#config-examples-str">9.1. Using example configuration files</a></h3>
<div class="paragraph _abstract">
<p>Further enhance your deployment by incorporating additional supported configuration.
Example configuration files are provided with the downloadable release artifacts from the <a href="https://github.com/strimzi/strimzi-kafka-operator/releases" target="_blank" rel="noopener">GitHub releases page</a>.
You can also access the example files directly from the
<a href="https://github.com/strimzi/strimzi-kafka-operator/tree/0.39.0/examples/" target="_blank" rel="noopener"><code>examples</code> directory</a>.</p>
</div>
<div class="paragraph">
<p>The example files include only the essential properties and values for custom resources by default.
You can download and apply the examples using the <code>kubectl</code> command-line tool.
The examples can serve as a starting point when building your own Kafka component configuration for deployment.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you installed Strimzi using the Operator, you can still download the example files and use them to upload configuration.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The release artifacts include an <code>examples</code> directory that contains the configuration examples.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration files provided with Strimzi</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">examples
├── user <b class="conum">(1)</b>
├── topic <b class="conum">(2)</b>
├── security <b class="conum">(3)</b>
│   ├── tls-auth
│   ├── scram-sha-512-auth
│   └── keycloak-authorization
├── mirror-maker <b class="conum">(4)</b>
├── metrics <b class="conum">(5)</b>
├── kafka <b class="conum">(6)</b>
│   └── nodepools <b class="conum">(7)</b>
├── cruise-control <b class="conum">(8)</b>
├── connect <b class="conum">(9)</b>
└── bridge <b class="conum">(10)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>KafkaUser</code> custom resource configuration, which is managed by the User Operator.</p>
</li>
<li>
<p><code>KafkaTopic</code> custom resource configuration, which is managed by Topic Operator.</p>
</li>
<li>
<p>Authentication and authorization configuration for Kafka components. Includes example configuration for TLS and SCRAM-SHA-512 authentication. The Keycloak example includes <code>Kafka</code> custom resource configuration and a Keycloak realm specification. You can use the example to try Keycloak authorization services. There is also an example with enabled <code>oauth</code> authentication and <code>keycloak</code> authorization metrics.</p>
</li>
<li>
<p><code>Kafka</code> custom resource configuration for a deployment of Mirror Maker. Includes example configuration for replication policy and synchronization frequency.</p>
</li>
<li>
<p><a href="#assembly-metrics-config-files-str">Metrics configuration</a>, including Prometheus installation and Grafana dashboard files.</p>
</li>
<li>
<p><code>Kafka</code> custom resource configuration for a deployment of Kafka. Includes example configuration for an ephemeral or persistent single or multi-node deployment.</p>
</li>
<li>
<p><code>KafkaNodePool</code> configuration for Kafka nodes in a Kafka cluster. Includes example configuration for nodes in clusters that use KRaft (Kafka Raft metadata) mode or ZooKeeper.</p>
</li>
<li>
<p><code>Kafka</code> custom resource with a deployment configuration for Cruise Control. Includes <code>KafkaRebalance</code> custom resources to generate optimization proposals from Cruise Control, with example configurations to use the default or user optimization goals.</p>
</li>
<li>
<p><code>KafkaConnect</code> and <code>KafkaConnector</code> custom resource configuration for a deployment of Kafka Connect. Includes example configurations for a single or multi-node deployment.</p>
</li>
<li>
<p><code>KafkaBridge</code> custom resource configuration for a deployment of Kafka Bridge.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="con-config-kafka-str"><a class="link" href="#con-config-kafka-str">9.2. Configuring Kafka</a></h3>
<div class="paragraph _abstract">
<p>Update the <code>spec</code> properties of the <code>Kafka</code> custom resource to configure your Kafka deployment.</p>
</div>
<div class="paragraph">
<p>As well as configuring Kafka, you can add configuration for ZooKeeper and the Strimzi Operators.
Common configuration properties, such as logging and healthchecks, are configured independently for each component.</p>
</div>
<div class="paragraph">
<p>Configuration options that are particularly important include the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Resource requests (CPU / Memory)</p>
</li>
<li>
<p>JVM options for maximum and minimum memory allocation</p>
</li>
<li>
<p>Listeners for connecting clients to Kafka brokers (and authentication of clients)</p>
</li>
<li>
<p>Authentication</p>
</li>
<li>
<p>Storage</p>
</li>
<li>
<p>Rack awareness</p>
</li>
<li>
<p>Metrics</p>
</li>
<li>
<p>Cruise Control for cluster rebalancing</p>
</li>
<li>
<p>Metadata version for KRaft-based Kafka clusters</p>
</li>
<li>
<p>Inter-broker protocol version for ZooKeeper-based Kafka clusters</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>.spec.kafka.metadataVersion</code> property or the <code>inter.broker.protocol.version</code> property in <code>config</code> must be a version supported by the specified Kafka version (<code>spec.kafka.version</code>).
The property represents the Kafka metadata or inter-broker protocol version used in a Kafka cluster.
If either of these properties is not set in the configuration, the Cluster Operator updates the version to the default for the Kafka version used.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The oldest supported metadata version is 3.3.
Using a metadata version that is older than the Kafka version might cause some features to be disabled.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For a deeper understanding of the Kafka cluster configuration options, refer to the <a href="./configuring.html" target="_blank" rel="noopener">Strimzi Custom Resource API Reference</a>.</p>
</div>
<div class="paragraph">
<div class="title">Managing TLS certificates</div>
<p>When deploying Kafka, the Cluster Operator automatically sets up and renews TLS certificates to enable encryption and authentication within your cluster.
If required, you can manually renew the cluster and clients CA certificates before their renewal period starts.
You can also replace the keys used by the cluster and clients CA certificates.
For more information, see <a href="#proc-renewing-ca-certs-manually-str">Renewing CA certificates manually</a> and <a href="#proc-replacing-private-keys-str">Replacing private keys</a>.</p>
</div>
<div class="listingblock">
<div class="title">Example <code>Kafka</code> custom resource configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    replicas: 3 # <b class="conum">(1)</b>
    version: 3.6.1 # <b class="conum">(2)</b>
    logging: # <b class="conum">(3)</b>
      type: inline
      loggers:
        kafka.root.logger.level: INFO
    resources: # <b class="conum">(4)</b>
      requests:
        memory: 64Gi
        cpu: "8"
      limits:
        memory: 64Gi
        cpu: "12"
    readinessProbe: # <b class="conum">(5)</b>
      initialDelaySeconds: 15
      timeoutSeconds: 5
    livenessProbe:
      initialDelaySeconds: 15
      timeoutSeconds: 5
    jvmOptions: # <b class="conum">(6)</b>
      -Xms: 8192m
      -Xmx: 8192m
    image: my-org/my-image:latest # <b class="conum">(7)</b>
    listeners: # <b class="conum">(8)</b>
      - name: plain # <b class="conum">(9)</b>
        port: 9092 # <b class="conum">(10)</b>
        type: internal # <b class="conum">(11)</b>
        tls: false # <b class="conum">(12)</b>
        configuration:
          useServiceDnsDomain: true # <b class="conum">(13)</b>
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication: # <b class="conum">(14)</b>
          type: tls
      - name: external1 # <b class="conum">(15)</b>
        port: 9094
        type: route
        tls: true
        configuration:
          brokerCertChainAndKey: # <b class="conum">(16)</b>
            secretName: my-secret
            certificate: my-certificate.crt
            key: my-key.key
    authorization: # <b class="conum">(17)</b>
      type: simple
    config: # <b class="conum">(18)</b>
      auto.create.topics.enable: "false"
      offsets.topic.replication.factor: 3
      transaction.state.log.replication.factor: 3
      transaction.state.log.min.isr: 2
      default.replication.factor: 3
      min.insync.replicas: 2
      inter.broker.protocol.version: "3.6"
    storage: # <b class="conum">(19)</b>
      type: persistent-claim # <b class="conum">(20)</b>
      size: 10000Gi
    rack: # <b class="conum">(21)</b>
      topologyKey: topology.kubernetes.io/zone
    metricsConfig: # <b class="conum">(22)</b>
      type: jmxPrometheusExporter
      valueFrom:
        configMapKeyRef: # <b class="conum">(23)</b>
          name: my-config-map
          key: my-key
    # ...
  zookeeper: # <b class="conum">(24)</b>
    replicas: 3 # <b class="conum">(25)</b>
    logging: # <b class="conum">(26)</b>
      type: inline
      loggers:
        zookeeper.root.logger: INFO
    resources:
      requests:
        memory: 8Gi
        cpu: "2"
      limits:
        memory: 8Gi
        cpu: "2"
    jvmOptions:
      -Xms: 4096m
      -Xmx: 4096m
    storage:
      type: persistent-claim
      size: 1000Gi
    metricsConfig:
      # ...
  entityOperator: # <b class="conum">(27)</b>
    tlsSidecar: # <b class="conum">(28)</b>
      resources:
        requests:
          cpu: 200m
          memory: 64Mi
        limits:
          cpu: 500m
          memory: 128Mi
    topicOperator:
      watchedNamespace: my-topic-namespace
      reconciliationIntervalSeconds: 60
      logging: # <b class="conum">(29)</b>
        type: inline
        loggers:
          rootLogger.level: INFO
      resources:
        requests:
          memory: 512Mi
          cpu: "1"
        limits:
          memory: 512Mi
          cpu: "1"
    userOperator:
      watchedNamespace: my-topic-namespace
      reconciliationIntervalSeconds: 60
      logging: # <b class="conum">(30)</b>
        type: inline
        loggers:
          rootLogger.level: INFO
      resources:
        requests:
          memory: 512Mi
          cpu: "1"
        limits:
          memory: 512Mi
          cpu: "1"
  kafkaExporter: # <b class="conum">(31)</b>
    # ...
  cruiseControl: # <b class="conum">(32)</b>
    # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The number of replica nodes.</p>
</li>
<li>
<p>Kafka version, which can be changed to a supported version by following the upgrade procedure.</p>
</li>
<li>
<p>Kafka loggers and log levels added directly (<code>inline</code>) or indirectly (<code>external</code>) through a ConfigMap. A custom Log4j configuration must be placed under the <code>log4j.properties</code> key in the ConfigMap. For the Kafka <code>kafka.root.logger.level</code> logger, you can set the log level to INFO, ERROR, WARN, TRACE, DEBUG, FATAL or OFF.</p>
</li>
<li>
<p>Requests for reservation of supported resources, currently <code>cpu</code> and <code>memory</code>, and limits to specify the maximum resources that can be consumed.</p>
</li>
<li>
<p>Healthchecks to know when to restart a container (liveness) and when a container can accept traffic (readiness).</p>
</li>
<li>
<p>JVM configuration options to optimize performance for the Virtual Machine (VM) running Kafka.</p>
</li>
<li>
<p>ADVANCED OPTION: Container image configuration, which is recommended only in special situations.</p>
</li>
<li>
<p>Listeners configure how clients connect to the Kafka cluster via bootstrap addresses. Listeners are configured as <em>internal</em> or <em>external</em> listeners for connection from inside or outside the Kubernetes cluster.</p>
</li>
<li>
<p>Name to identify the listener. Must be unique within the Kafka cluster.</p>
</li>
<li>
<p>Port number used by the listener inside Kafka. The port number has to be unique within a given Kafka cluster. Allowed port numbers are 9092 and higher with the exception of ports 9404 and 9999, which are already used for Prometheus and JMX. Depending on the listener type, the port number might not be the same as the port number that connects Kafka clients.</p>
</li>
<li>
<p>Listener type specified as <code>internal</code> or <code>cluster-ip</code> (to expose Kafka using per-broker <code>ClusterIP</code> services), or for external listeners, as <code>route</code> (OpenShift only), <code>loadbalancer</code>, <code>nodeport</code> or <code>ingress</code> (Kubernetes only).</p>
</li>
<li>
<p>Enables TLS encryption for each listener. Default is <code>false</code>. TLS encryption has to be enabled, by setting it to <code>true</code>, for <code>route</code> and <code>ingress</code> type listeners.</p>
</li>
<li>
<p>Defines whether the fully-qualified DNS names including the cluster service suffix (usually <code>.cluster.local</code>) are assigned.</p>
</li>
<li>
<p>Listener authentication mechanism specified as mTLS, SCRAM-SHA-512, or token-based OAuth 2.0.</p>
</li>
<li>
<p>External listener configuration specifies how the Kafka cluster is exposed outside Kubernetes, such as through a <code>route</code>, <code>loadbalancer</code> or <code>nodeport</code>.</p>
</li>
<li>
<p>Optional configuration for a Kafka listener certificate managed by an external CA (certificate authority). The <code>brokerCertChainAndKey</code> specifies a <code>Secret</code> that contains a server certificate and a private key. You can configure Kafka listener certificates on any listener with enabled TLS encryption.</p>
</li>
<li>
<p>Authorization enables simple, OAUTH 2.0, or OPA authorization on the Kafka broker. Simple authorization uses the <code>AclAuthorizer</code> and <code>StandardAuthorizer</code> Kafka plugins.</p>
</li>
<li>
<p>Broker configuration. Standard Apache Kafka configuration may be provided, restricted to those properties not managed directly by Strimzi.</p>
</li>
<li>
<p>Storage size for persistent volumes may be increased and additional volumes may be added to JBOD storage.</p>
</li>
<li>
<p>Persistent storage has additional configuration options, such as a storage <code>id</code> and <code>class</code> for dynamic volume provisioning.</p>
</li>
<li>
<p>Rack awareness configuration to spread replicas across different racks, data centers, or availability zones. The <code>topologyKey</code> must match a node label containing the rack ID. The example used in this configuration specifies a zone using the standard <code><a href="https://kubernetes.io/docs/reference/labels-annotations-taints/#topologykubernetesiozone" target="_blank" rel="noopener">topology.kubernetes.io/zone</a></code> label.</p>
</li>
<li>
<p>Prometheus metrics enabled. In this example, metrics are configured for the Prometheus JMX Exporter (the default metrics exporter).</p>
</li>
<li>
<p>Rules for exporting metrics in Prometheus format to a Grafana dashboard through the Prometheus JMX Exporter, which are enabled by referencing a ConfigMap containing configuration for the Prometheus JMX exporter. You can enable metrics without further configuration using a reference to a ConfigMap containing an empty file under <code>metricsConfig.valueFrom.configMapKeyRef.key</code>.</p>
</li>
<li>
<p>ZooKeeper-specific configuration, which contains properties similar to the Kafka configuration.</p>
</li>
<li>
<p>The number of ZooKeeper nodes. ZooKeeper clusters or ensembles usually run with an odd number of nodes, typically three, five, or seven. The majority of nodes must be available in order to maintain an effective quorum.
If the ZooKeeper cluster loses its quorum, it will stop responding to clients and the Kafka brokers will stop working.
Having a stable and highly available ZooKeeper cluster is crucial for Strimzi.</p>
</li>
<li>
<p>ZooKeeper loggers and log levels.</p>
</li>
<li>
<p>Entity Operator configuration, which specifies the configuration for the Topic Operator and User Operator.</p>
</li>
<li>
<p>Entity Operator TLS sidecar configuration. Entity Operator uses the TLS sidecar for secure communication with ZooKeeper.</p>
</li>
<li>
<p>Specified Topic Operator loggers and log levels. This example uses <code>inline</code> logging.</p>
</li>
<li>
<p>Specified User Operator loggers and log levels.</p>
</li>
<li>
<p>Kafka Exporter configuration. Kafka Exporter is an optional component for extracting metrics data from Kafka brokers, in particular consumer lag data. For Kafka Exporter to be able to work properly, consumer groups need to be in use.</p>
</li>
<li>
<p>Optional configuration for Cruise Control, which is used to rebalance the Kafka cluster.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="proc-setting-broker-limits-str"><a class="link" href="#proc-setting-broker-limits-str">9.2.1. Setting limits on brokers using the Kafka Static Quota plugin</a></h4>
<div class="paragraph _abstract">
<p>Use the <em>Kafka Static Quota</em> plugin to set throughput and storage limits on brokers in your Kafka cluster.
You enable the plugin and set limits by configuring the <code>Kafka</code> resource.
You can set a byte-rate threshold and storage quotas to put limits on the clients interacting with your brokers.</p>
</div>
<div class="paragraph">
<p>You can set byte-rate thresholds for producer and consumer bandwidth.
The total limit is distributed across all clients accessing the broker.
For example, you can set a byte-rate threshold of 40 MBps for producers.
If two producers are running, they are each limited to a throughput of 20 MBps.</p>
</div>
<div class="paragraph">
<p>Storage quotas throttle Kafka disk storage limits between a soft limit and hard limit.
The limits apply to all available disk space.
Producers are slowed gradually between the soft and hard limit.
The limits prevent disks filling up too quickly and exceeding their capacity.
Full disks can lead to issues that are hard to rectify.
The hard limit is the maximum storage limit.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
For JBOD storage, the limit applies across all disks.
If a broker is using two 1 TB disks and the quota is 1.1 TB, one disk might fill and the other disk will be almost empty.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator that manages the Kafka cluster is running.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the plugin properties to the <code>config</code> of the <code>Kafka</code> resource.</p>
<div class="paragraph">
<p>The plugin properties are shown in this example configuration.</p>
</div>
<div class="listingblock">
<div class="title">Example Kafka Static Quota plugin configuration</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
    config:
      client.quota.callback.class: io.strimzi.kafka.quotas.StaticQuotaCallback <b class="conum">(1)</b>
      client.quota.callback.static.produce: 1000000 <b class="conum">(2)</b>
      client.quota.callback.static.fetch: 1000000 <b class="conum">(3)</b>
      client.quota.callback.static.storage.soft: 400000000000 <b class="conum">(4)</b>
      client.quota.callback.static.storage.hard: 500000000000 <b class="conum">(5)</b>
      client.quota.callback.static.storage.check-interval: 5 <b class="conum">(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Loads the Kafka Static Quota plugin.</p>
</li>
<li>
<p>Sets the producer byte-rate threshold. 1 MBps in this example.</p>
</li>
<li>
<p>Sets the consumer byte-rate threshold. 1 MBps in this example.</p>
</li>
<li>
<p>Sets the lower soft limit for storage. 400 GB in this example.</p>
</li>
<li>
<p>Sets the higher hard limit for storage. 500 GB in this example.</p>
</li>
<li>
<p>Sets the interval in seconds between checks on storage. 5 seconds in this example. You can set this to 0 to disable the check.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Update the resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./configuring.html#type-KafkaUserQuotas-reference" target="_blank" rel="noopener"><code>KafkaUserQuotas</code> schema reference</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="con-zookeeper-default-config-str"><a class="link" href="#con-zookeeper-default-config-str">9.2.2. Default ZooKeeper configuration values</a></h4>
<div class="paragraph _abstract">
<p>When deploying ZooKeeper with Strimzi, some of the default configuration set by Strimzi differs from the standard ZooKeeper defaults.
This is because Strimzi sets a number of ZooKeeper properties with values that are optimized for running ZooKeeper within a Kubernetes environment.</p>
</div>
<div class="paragraph">
<p>The default configuration for key ZooKeeper properties in Strimzi is as follows:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Default ZooKeeper Properties in Strimzi</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 16.6666%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tickTime</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>2000</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The length of a single tick in milliseconds, which determines the length of a session timeout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>initLimit</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>5</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of ticks that a follower is allowed to fall behind the leader in a ZooKeeper cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>syncLimit</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>2</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of ticks that a follower is allowed to be out of sync with the leader in a ZooKeeper cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>autopurge.purgeInterval</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>1</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the <code>autopurge</code> feature and sets the time interval in hours for purging the server-side ZooKeeper transaction log.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>admin.enableServer</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>false</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flag to disable the ZooKeeper admin server. The admin server is not used by Strimzi.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Modifying these default values as <code>zookeeper.config</code> in the <code>Kafka</code> custom resource may impact the behavior and performance of your ZooKeeper cluster.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="config-node-pools-str"><a class="link" href="#config-node-pools-str">9.3. Configuring node pools</a></h3>
<div class="paragraph _abstract">
<p>Update the <code>spec</code> properties of the <code>KafkaNodePool</code> custom resource to configure a node pool deployment.</p>
</div>
<div class="paragraph">
<p>A node pool refers to a distinct group of Kafka nodes within a Kafka cluster.
Each pool has its own unique configuration, which includes mandatory settings for the number of replicas, roles, and storage allocation.</p>
</div>
<div class="paragraph">
<p>Optionally, you can also specify values for the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>resources</code> to specify memory and cpu requests and limits</p>
</li>
<li>
<p><code>template</code> to specify custom configuration for pods and other Kubernetes resources</p>
</li>
<li>
<p><code>jvmOptions</code> to specify custom JVM configuration for heap size, runtime and other options</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>Kafka</code> resource represents the configuration for all nodes in the Kafka cluster.
The <code>KafkaNodePool</code> resource represents the configuration for nodes only in the node pool.
If a configuration property is not specified in <code>KafkaNodePool</code>, it is inherited from the <code>Kafka</code> resource.
Configuration specified in the <code>KafkaNodePool</code> resource takes precedence if set in both resources.
For example, if both the node pool and Kafka configuration includes <code>jvmOptions</code>, the values specified in the node pool configuration are used.
When <code>-Xmx: 1024m</code> is set in <code>KafkaNodePool.spec.jvmOptions</code> and <code>-Xms: 512m</code> is set in <code>Kafka.spec.kafka.jvmOptions</code>, the node uses the value from its node pool configuration.</p>
</div>
<div class="paragraph">
<p>Properties from <code>Kafka</code> and <code>KafkaNodePool</code> schemas are not combined.
To clarify, if <code>KafkaNodePool.spec.template</code> includes only <code>podSet.metadata.labels</code>, and <code>Kafka.spec.kafka.template</code> includes <code>podSet.metadata.annotations</code> and <code>pod.metadata.labels</code>, the template values from the Kafka configuration are ignored since there is a template value in the node pool configuration.</p>
</div>
<div class="paragraph">
<p>Node pools can be used with Kafka clusters that operate in KRaft mode (using Kafka Raft metadata) or use ZooKeeper for cluster management.
If you are using KRaft mode, you can specify roles for all nodes in the node pool to operate as brokers, controllers, or both.
If you are using ZooKeeper, nodes must be set as brokers only.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<strong>KRaft mode is not ready for production in Apache Kafka or in Strimzi.</strong>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For a deeper understanding of the node pool configuration options, refer to the <a href="./configuring.html" target="_blank" rel="noopener">Strimzi Custom Resource API Reference</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Currently, replica and storage configuration properties in the <code>KafkaNodePool</code> resource must also be present in the <code>Kafka</code> resource. The configuration in the <code>Kafka</code> resource is ignored when node pools are used. Similarly, ZooKeeper configuration properties must also be present in the <code>Kafka</code> resource when using KRaft mode. These properties are also ignored.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example configuration for a node pool in a cluster using KRaft mode</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaNodePool
metadata:
  name: kraft-dual-role # <b class="conum">(1)</b>
  labels:
    strimzi.io/cluster: my-cluster # <b class="conum">(2)</b>
spec:
  replicas: 3 # <b class="conum">(3)</b>
  roles: # <b class="conum">(4)</b>
    - controller
    - broker
  storage: # <b class="conum">(5)</b>
    type: jbod
    volumes:
      - id: 0
        type: persistent-claim
        size: 100Gi
        deleteClaim: false
  resources: # <b class="conum">(6)</b>
      requests:
        memory: 64Gi
        cpu: "8"
      limits:
        memory: 64Gi
        cpu: "12"</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Unique name for the node pool.</p>
</li>
<li>
<p>The Kafka cluster the node pool belongs to. A node pool can only belong to a single cluster.</p>
</li>
<li>
<p>Number of replicas for the nodes.</p>
</li>
<li>
<p>Roles for the nodes in the node pool. In this example, the nodes have dual roles as controllers and brokers.</p>
</li>
<li>
<p>Storage specification for the nodes.</p>
</li>
<li>
<p>Requests for reservation of supported resources, currently <code>cpu</code> and <code>memory</code>, and limits to specify the maximum resources that can be consumed.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The configuration for the <code>Kafka</code> resource must be suitable for KRaft mode. Currently, KRaft mode has <a href="#ref-operator-use-kraft-feature-gate-str">a number of limitations</a>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example configuration for a node pool in a cluster using ZooKeeper</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaNodePool
metadata:
  name: pool-a
  labels:
    strimzi.io/cluster: my-cluster
spec:
  replicas: 3
  roles:
    - broker # <b class="conum">(1)</b>
  storage:
    type: jbod
    volumes:
      - id: 0
        type: persistent-claim
        size: 100Gi
        deleteClaim: false
  resources:
      requests:
        memory: 64Gi
        cpu: "8"
      limits:
        memory: 64Gi
        cpu: "12"</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Roles for the nodes in the node pool, which can only be <code>broker</code> when using Kafka with ZooKeeper.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="proc-managing-node-pools-ids-str"><a class="link" href="#proc-managing-node-pools-ids-str">9.3.1. Assigning IDs to node pools for scaling operations</a></h4>
<div class="paragraph _abstract">
<p>This procedure describes how to use annotations for advanced node ID handling by the Cluster Operator when performing scaling operations on node pools.
You specify the node IDs to use, rather than the Cluster Operator using the next ID in sequence.
Management of node IDs in this way gives greater control.</p>
</div>
<div class="paragraph">
<p>To add a range of IDs, you assign the following annotations to the <code>KafkaNodePool</code> resource:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>strimzi.io/next-node-ids</code> to add a range of IDs that are used for new brokers</p>
</li>
<li>
<p><code>strimzi.io/remove-node-ids</code> to add a range of IDs for removing existing brokers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can specify an array of individual node IDs, ID ranges, or a combination of both.
For example, you can specify the following range of IDs: <code>[0, 1, 2, 10-20, 30]</code> for scaling up the Kafka node pool.
This format allows you to specify a combination of individual node IDs (<code>0</code>, <code>1</code>, <code>2</code>, <code>30</code>) as well as a range of IDs (<code>10-20</code>).</p>
</div>
<div class="paragraph">
<p>In a typical scenario, you might specify a range of IDs for scaling up and a single node ID to remove a specific node when scaling down.</p>
</div>
<div class="paragraph">
<p>In this procedure, we add the scaling annotations to node pools as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>pool-a</code> is assigned a range of IDs for scaling up</p>
</li>
<li>
<p><code>pool-b</code> is assigned a range of IDs for scaling down</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>During the scaling operation, IDs are used as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Scale up picks up the lowest available ID in the range for the new node.</p>
</li>
<li>
<p>Scale down removes the node with the highest available ID in the range.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If there are gaps in the sequence of node IDs assigned in the node pool, the next node to be added is assigned an ID that fills the gap.</p>
</div>
<div class="paragraph">
<p>The annotations don&#8217;t need to be updated after every scaling operation.
Any unused IDs are still valid for the next scaling event.</p>
</div>
<div class="paragraph">
<p>The Cluster Operator allows you to specify a range of IDs in either ascending or descending order, so you can define them in the order the nodes are scaled.
For example, when scaling up, you can specify a range such as <code>[1000-1999]</code>, and the new nodes are assigned the next lowest IDs: <code>1000</code>, <code>1001</code>, <code>1002</code>, <code>1003</code>, and so on.
Conversely, when scaling down, you can specify a range like <code>[1999-1000]</code>, ensuring that nodes with the next highest IDs are removed: <code>1003</code>, <code>1002</code>, <code>1001</code>, <code>1000</code>, and so on.</p>
</div>
<div class="paragraph">
<p>If you don&#8217;t specify an ID range using the annotations, the Cluster Operator follows its default behavior for handling IDs during scaling operations.
Node IDs start at 0 (zero) and run sequentially across the Kafka cluster.
The next lowest ID is assigned to a new node.
Gaps to node IDs are filled across the cluster.
This means that they might not run sequentially within a node pool.
The default behavior for scaling up is to add the next lowest available node ID across the cluster; and for scaling down, it is to remove the node in the node pool with the highest available node ID.
The default approach is also applied if the assigned range of IDs is misformatted, the scaling up range runs out of IDs, or the scaling down range does not apply to any in-use nodes.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
<li>
<p>(Optional) Use the <code>reserved.broker-max.id</code> configuration property to extend the allowable range for node IDs within your node pools.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, Apache Kafka restricts node IDs to numbers ranging from 0 to 999.
To use node ID values greater than 999, add the <code>reserved.broker-max.id</code> configuration property to the <code>Kafka</code> custom resource and specify the required maximum node ID value.</p>
</div>
<div class="paragraph">
<p>In this example, the maximum node ID is set at 10000.
Node IDs can then be assigned up to that value.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration for the maximum node ID number</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    config:
      reserved.broker.max.id: 10000
  # ...</code></pre>
</div>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Annotate the node pool with the IDs to use when scaling up or scaling down, as shown in the following examples.</p>
<div class="paragraph">
<p>IDs for scaling up are assigned to node pool <code>pool-a</code>:</p>
</div>
<div class="listingblock">
<div class="title">Assigning IDs for scaling up</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate kafkanodepool pool-a strimzi.io/next-node-ids="[0,1,2,10-20,30]"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The lowest available ID from this range is used when adding a node to <code>pool-a</code>.</p>
</div>
<div class="paragraph">
<p>IDs for scaling down are assigned to node pool <code>pool-b</code>:</p>
</div>
<div class="listingblock">
<div class="title">Assigning IDs for scaling down</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate kafkanodepool pool-b strimzi.io/remove-node-ids="[60-50,9,8,7]"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The highest available ID from this range is removed when scaling down <code>pool-b</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you want to remove a specific node, you can assign a single node ID to the scaling down annotation: <code>kubectl annotate kafkanodepool pool-b strimzi.io/remove-node-ids="[3]"</code>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>You can now scale the node pool.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>For more information, see the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-scaling-up-node-pools-str">Adding nodes to a node pool</a></p>
</li>
<li>
<p><a href="#proc-scaling-down-node-pools-str">Removing nodes from a node pool</a></p>
</li>
<li>
<p><a href="#proc-moving-node-pools-str">Moving nodes between node pools</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>On reconciliation, a warning is given if the annotations are misformatted.</p>
</div>
</li>
<li>
<p>After you have performed the scaling operation, you can remove the annotation if it&#8217;s no longer needed.</p>
<div class="listingblock">
<div class="title">Removing the annotation for scaling up</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate kafkanodepool pool-a strimzi.io/next-node-ids-</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Removing the annotation for  scaling down</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate kafkanodepool pool-b strimzi.io/remove-node-ids-</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-scaling-up-node-pools-str"><a class="link" href="#proc-scaling-up-node-pools-str">9.3.2. Adding nodes to a node pool</a></h4>
<div class="paragraph _abstract">
<p>This procedure describes how to scale up a node pool to add new nodes.</p>
</div>
<div class="paragraph">
<p>In this procedure, we start with three nodes for node pool <code>pool-a</code>:</p>
</div>
<div class="listingblock">
<div class="title">Kafka nodes in the node pool</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                 READY  STATUS   RESTARTS
my-cluster-pool-a-0  1/1    Running  0
my-cluster-pool-a-1  1/1    Running  0
my-cluster-pool-a-2  1/1    Running  0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Node IDs are appended to the name of the node on creation.
We add node <code>my-cluster-pool-a-3</code>, which has a node ID of <code>3</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
During this process, the ID of the node that holds the partition replicas changes. Consider any dependencies that reference the node ID.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
<li>
<p><a href="#proc-configuring-deploying-cruise-control-str">Cruise Control is deployed with Kafka.</a></p>
</li>
<li>
<p>(Optional) For scale up operations, <a href="#proc-managing-node-pools-ids-str">you can specify the node IDs to use in the operation</a>.</p>
<div class="paragraph">
<p>If you have assigned a range of node IDs for the operation, the ID of the node being added is determined by the sequence of nodes given.
If you have assigned a single node ID, a node is added with the specified ID.
Otherwise, the lowest available node ID across the cluster is used.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a new node in the node pool.</p>
<div class="paragraph">
<p>For example, node pool <code>pool-a</code> has three replicas. We add a node by increasing the number of replicas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl scale kafkanodepool pool-a --replicas=4</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment and wait for the pods in the node pool to be created and have a status of <code>READY</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods -n &lt;my_cluster_operator_namespace&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows four Kafka nodes in the node pool</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                 READY  STATUS   RESTARTS
my-cluster-pool-a-0  1/1    Running  0
my-cluster-pool-a-1  1/1    Running  0
my-cluster-pool-a-2  1/1    Running  0
my-cluster-pool-a-3  1/1    Running  0</code></pre>
</div>
</div>
</li>
<li>
<p>Reassign the partitions after increasing the number of nodes in the node pool.</p>
<div class="paragraph">
<p>After scaling up a node pool, you can use the Cruise Control <code>add-brokers</code> mode to move partition replicas from existing brokers to the newly added brokers.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-scaling-down-node-pools-str"><a class="link" href="#proc-scaling-down-node-pools-str">9.3.3. Removing nodes from a node pool</a></h4>
<div class="paragraph _abstract">
<p>This procedure describes how to scale down a node pool to remove nodes.</p>
</div>
<div class="paragraph">
<p>In this procedure, we start with four nodes for node pool <code>pool-a</code>:</p>
</div>
<div class="listingblock">
<div class="title">Kafka nodes in the node pool</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                 READY  STATUS   RESTARTS
my-cluster-pool-a-0  1/1    Running  0
my-cluster-pool-a-1  1/1    Running  0
my-cluster-pool-a-2  1/1    Running  0
my-cluster-pool-a-3  1/1    Running  0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Node IDs are appended to the name of the node on creation.
We remove node <code>my-cluster-pool-a-3</code>, which has a node ID of <code>3</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
During this process, the ID of the node that holds the partition replicas changes. Consider any dependencies that reference the node ID.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
<li>
<p><a href="#proc-configuring-deploying-cruise-control-str">Cruise Control is deployed with Kafka.</a></p>
</li>
<li>
<p>(Optional) For scale down operations, <a href="#proc-managing-node-pools-ids-str">you can specify the node IDs to use in the operation</a>.</p>
<div class="paragraph">
<p>If you have assigned a range of node IDs for the operation, the ID of the node being removed is determined by the sequence of nodes given.
If you have assigned a single node ID, the node with the specified ID is removed.
Otherwise, the node with the highest available ID in the node pool is removed.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Reassign the partitions before decreasing the number of nodes in the node pool.</p>
<div class="paragraph">
<p>Before scaling down a node pool, you can use the Cruise Control <code>remove-brokers</code> mode to move partition replicas off the brokers that are going to be removed.</p>
</div>
</li>
<li>
<p>After the reassignment process is complete, and the node being removed has no live partitions, reduce the number of Kafka nodes in the node pool.</p>
<div class="paragraph">
<p>For example, node pool <code>pool-a</code> has four replicas. We remove a node by decreasing the number of replicas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl scale kafkanodepool pool-a --replicas=3</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows three Kafka nodes in the node pool</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                       READY  STATUS   RESTARTS
my-cluster-pool-b-kafka-0  1/1    Running  0
my-cluster-pool-b-kafka-1  1/1    Running  0
my-cluster-pool-b-kafka-2  1/1    Running  0</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-moving-node-pools-str"><a class="link" href="#proc-moving-node-pools-str">9.3.4. Moving nodes between node pools</a></h4>
<div class="paragraph _abstract">
<p>This procedure describes how to move nodes between source and target Kafka node pools without downtime.
You create a new node on the target node pool and reassign partitions to move data from the old node on the source node pool.
When the replicas on the new node are in-sync, you can delete the old node.</p>
</div>
<div class="paragraph">
<p>In this procedure, we start with two node pools:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>pool-a</code> with three replicas is the target node pool</p>
</li>
<li>
<p><code>pool-b</code> with four replicas is the source node pool</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We scale up <code>pool-a</code>, and reassign partitions and scale down <code>pool-b</code>, which results in the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>pool-a</code> with four replicas</p>
</li>
<li>
<p><code>pool-b</code> with three replicas</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
During this process, the ID of the node that holds the partition replicas changes. Consider any dependencies that reference the node ID.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
<li>
<p><a href="#proc-configuring-deploying-cruise-control-str">Cruise Control is deployed with Kafka.</a></p>
</li>
<li>
<p>(Optional) For scale up and scale down operations, <a href="#proc-managing-node-pools-ids-str">you can specify the range of node IDs to use</a>.</p>
<div class="paragraph">
<p>If you have assigned node IDs for the operation, the ID of the node being added or removed is determined by the sequence of nodes given.
Otherwise, the lowest available node ID across the cluster is used when adding nodes; and the node with the highest available ID in the node pool is removed.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a new node in the target node pool.</p>
<div class="paragraph">
<p>For example, node pool <code>pool-a</code> has three replicas. We add a node by increasing the number of replicas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl scale kafkanodepool pool-a --replicas=4</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment and wait for the pods in the node pool to be created and have a status of <code>READY</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods -n &lt;my_cluster_operator_namespace&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows four Kafka nodes in the target node pool</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                 READY  STATUS   RESTARTS
my-cluster-pool-a-0  1/1    Running  0
my-cluster-pool-a-1  1/1    Running  0
my-cluster-pool-a-4  1/1    Running  0
my-cluster-pool-a-5  1/1    Running  0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Node IDs are appended to the name of the node on creation.
We add node <code>my-cluster-pool-a-5</code>, which has a node ID of <code>5</code>.</p>
</div>
</li>
<li>
<p>Reassign the partitions from the old node to the new node.</p>
<div class="paragraph">
<p>Before scaling down the source node pool, you can use the Cruise Control <code>remove-brokers</code> mode to move partition replicas off the brokers that are going to be removed.</p>
</div>
</li>
<li>
<p>After the reassignment process is complete, reduce the number of Kafka nodes in the source node pool.</p>
<div class="paragraph">
<p>For example, node pool <code>pool-b</code> has four replicas. We remove a node by decreasing the number of replicas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl scale kafkanodepool pool-b --replicas=3</code></pre>
</div>
</div>
<div class="paragraph">
<p>The node with the highest ID within a pool is removed.</p>
</div>
<div class="listingblock">
<div class="title">Output shows three Kafka nodes in the source node pool</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                       READY  STATUS   RESTARTS
my-cluster-pool-b-kafka-2  1/1    Running  0
my-cluster-pool-b-kafka-3  1/1    Running  0
my-cluster-pool-b-kafka-6  1/1    Running  0</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-managing-storage-node-pools-str"><a class="link" href="#proc-managing-storage-node-pools-str">9.3.5. Managing storage using node pools</a></h4>
<div class="paragraph _abstract">
<p>Storage management in Strimzi is usually straightforward, and requires little change when set up, but there might be situations where you need to modify your storage configurations.
Node pools simplify this process, because you can set up separate node pools that specify your new storage requirements.</p>
</div>
<div class="paragraph">
<p>In this procedure we create and manage storage for a node pool called <code>pool-a</code> containing three nodes.
We show how to change the storage class (<code>volumes.class</code>) that defines the type of persistent storage it uses.
You can use the same steps to change the storage size (<code>volumes.size</code>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
We strongly recommend using block storage. Strimzi is only tested for use with block storage.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
<li>
<p><a href="#proc-configuring-deploying-cruise-control-str">Cruise Control is deployed with Kafka.</a></p>
</li>
<li>
<p>For storage that uses persistent volume claims for dynamic volume allocation, storage classes are defined and available in the Kubernetes cluster that correspond to the storage solutions you need.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create the node pool with its own storage settings.</p>
<div class="paragraph">
<p>For example, node pool <code>pool-a</code> uses JBOD storage with persistent volumes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaNodePool
metadata:
  name: pool-a
  labels:
    strimzi.io/cluster: my-cluster
spec:
  replicas: 3
  storage:
    type: jbod
    volumes:
      - id: 0
        type: persistent-claim
        size: 500Gi
        class: gp2-ebs
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nodes in <code>pool-a</code> are configured to use Amazon EBS (Elastic Block Store) GP2 volumes.</p>
</div>
</li>
<li>
<p>Apply the node pool configuration for <code>pool-a</code>.</p>
</li>
<li>
<p>Check the status of the deployment and wait for the pods in <code>pool-a</code> to be created and have a status of <code>READY</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods -n &lt;my_cluster_operator_namespace&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows three Kafka nodes in the node pool</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                 READY  STATUS   RESTARTS
my-cluster-pool-a-0  1/1    Running  0
my-cluster-pool-a-1  1/1    Running  0
my-cluster-pool-a-2  1/1    Running  0</code></pre>
</div>
</div>
</li>
<li>
<p>To migrate to a new storage class, create a new node pool with the required storage configuration:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaNodePool
metadata:
  name: pool-b
  labels:
    strimzi.io/cluster: my-cluster
spec:
  roles:
    - broker
  replicas: 3
  storage:
    type: jbod
    volumes:
      - id: 0
        type: persistent-claim
        size: 1Ti
        class: gp3-ebs
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nodes in <code>pool-b</code> are configured to use Amazon EBS (Elastic Block Store) GP3 volumes.</p>
</div>
</li>
<li>
<p>Apply the node pool configuration for <code>pool-b</code>.</p>
</li>
<li>
<p>Check the status of the deployment and wait for the pods in <code>pool-b</code> to be created and have a status of <code>READY</code>.</p>
</li>
<li>
<p>Reassign the partitions from <code>pool-a</code> to <code>pool-b</code>.</p>
<div class="paragraph">
<p>When migrating to a new storage configuration, you can use the Cruise Control <code>remove-brokers</code> mode to move partition replicas off the brokers that are going to be removed.</p>
</div>
</li>
<li>
<p>After the reassignment process is complete, delete the old node pool:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl delete kafkanodepool pool-a</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-managing-storage-affinity-node-pools-str"><a class="link" href="#proc-managing-storage-affinity-node-pools-str">9.3.6. Managing storage affinity using node pools</a></h4>
<div class="paragraph _abstract">
<p>In situations where storage resources, such as local persistent volumes, are constrained to specific worker nodes, or availability zones, configuring storage affinity helps to schedule pods to use the right nodes.</p>
</div>
<div class="paragraph">
<p>Node pools allow you to configure affinity independently.
In this procedure, we create and manage storage affinity for two availability zones: <code>zone-1</code> and <code>zone-2</code>.</p>
</div>
<div class="paragraph">
<p>You can configure node pools for separate availability zones, but use the same storage class.
We define an <code>all-zones</code> persistent storage class representing the storage resources available in each zone.</p>
</div>
<div class="paragraph">
<p>We also use the <code>.spec.template.pod</code> properties to configure the node affinity and schedule Kafka pods on <code>zone-1</code> and <code>zone-2</code> worker nodes.</p>
</div>
<div class="paragraph">
<p>The storage class and affinity is specified in node pools representing the nodes in each availability zone:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>pool-zone-1</code></p>
</li>
<li>
<p><code>pool-zone-2</code>.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
<li>
<p>If you are not familiar with the concepts of affinity, see the <a href="https://kubernetes.io/docs/concepts/configuration/assign-pod-node/" target="_blank" rel="noopener">Kubernetes node and pod affinity documentation</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Define the storage class for use with each availability zone:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: all-zones
provisioner: kubernetes.io/my-storage
parameters:
  type: ssd
volumeBindingMode: WaitForFirstConsumer</code></pre>
</div>
</div>
</li>
<li>
<p>Create node pools representing the two availability zones, specifying the <code>all-zones</code> storage class and the affinity for each zone:</p>
<div class="listingblock">
<div class="title">Node pool configuration for zone-1</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaNodePool
metadata:
  name: pool-zone-1
  labels:
    strimzi.io/cluster: my-cluster
spec:
  replicas: 3
  storage:
    type: jbod
    volumes:
      - id: 0
        type: persistent-claim
        size: 500Gi
        class: all-zones
  template:
    pod:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                - key: topology.kubernetes.io/zone
                  operator: In
                  values:
                  - zone-1
  # ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Node pool configuration for zone-2</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaNodePool
metadata:
  name: pool-zone-2
  labels:
    strimzi.io/cluster: my-cluster
spec:
  replicas: 4
  storage:
    type: jbod
    volumes:
      - id: 0
        type: persistent-claim
        size: 500Gi
        class: all-zones
  template:
    pod:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                - key: topology.kubernetes.io/zone
                  operator: In
                  values:
                  - zone-2
  # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the node pool configuration.</p>
</li>
<li>
<p>Check the status of the deployment and wait for the pods in the node pools to be created and have a status of <code>READY</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods -n &lt;my_cluster_operator_namespace&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows 3 Kafka nodes in <code>pool-zone-1</code> and 4 Kafka nodes in <code>pool-zone-2</code>:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                       READY  STATUS   RESTARTS
my-cluster-pool-zone-1-kafka-0  1/1    Running  0
my-cluster-pool-zone-1-kafka-1  1/1    Running  0
my-cluster-pool-zone-1-kafka-2  1/1    Running  0
my-cluster-pool-zone-2-kafka-3  1/1    Running  0
my-cluster-pool-zone-2-kafka-4  1/1    Running  0
my-cluster-pool-zone-2-kafka-5  1/1    Running  0
my-cluster-pool-zone-2-kafka-6  1/1    Running  0</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-migrating-clusters-node-pools-str"><a class="link" href="#proc-migrating-clusters-node-pools-str">9.3.7. Migrating existing Kafka clusters to use Kafka node pools</a></h4>
<div class="paragraph _abstract">
<p>This procedure describes how to migrate existing Kafka clusters to use Kafka node pools.
After you have updated the Kafka cluster, you can use the node pools to manage the configuration of nodes within each pool.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Currently, replica and storage configuration in the <code>KafkaNodePool</code> resource must also be present in the <code>Kafka</code> resource. The configuration is ignored when node pools are being used.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a new <code>KafkaNodePool</code> resource.</p>
<div class="openblock">
<div class="content">
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Name the resource <code>kafka</code>.</p>
</li>
<li>
<p>Point a <code>strimzi.io/cluster</code> label to your existing <code>Kafka</code> resource.</p>
</li>
<li>
<p>Set the replica count and storage configuration to match your current Kafka cluster.</p>
</li>
<li>
<p>Set the roles to <code>broker</code>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Example configuration for a node pool used in migrating a Kafka cluster</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaNodePool
metadata:
  name: kafka
  labels:
    strimzi.io/cluster: my-cluster
spec:
  replicas: 3
  roles:
    - broker
  storage:
    type: jbod
    volumes:
      - id: 0
        type: persistent-claim
        size: 100Gi
        deleteClaim: false</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
To migrate a cluster while preserving its data along with the names of its nodes and resources, the node pool name must be <code>kafka</code>, and the <code>strimzi.io/cluster</code> label must use the name of the Kafka resource.
Otherwise, nodes and resources are created with new names, including the persistent volume storage used by the nodes.
Consequently, your previous data may not be available.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Apply the <code>KafkaNodePool</code> resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f &lt;node_pool_configuration_file&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>By applying this resource, you switch Kafka to using node pools.</p>
</div>
<div class="paragraph">
<p>There is no change or rolling update and resources are identical to how they were before.</p>
</div>
</li>
<li>
<p>Enable support for node pools in the <code>Kafka</code> resource using the <code>strimzi.io/node-pools: enabled</code> annotation.</p>
<div class="listingblock">
<div class="title">Example configuration for a node pool in a cluster using ZooKeeper</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
  annotations:
    strimzi.io/node-pools: enabled
spec:
  kafka:
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the <code>Kafka</code> resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f &lt;kafka_configuration_file&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is no change or rolling update.
The resources remain identical to how they were before.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ref-kafka-entity-operator-str"><a class="link" href="#ref-kafka-entity-operator-str">9.4. Configuring the Entity Operator</a></h3>
<div class="paragraph _abstract">
<p>Use the <code>entityOperator</code> property in <code>Kafka.spec</code> to configure the Entity Operator.
The Entity Operator is responsible for managing Kafka-related entities in a running Kafka cluster. It comprises the following operators:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Topic Operator to manage Kafka topics</p>
</li>
<li>
<p>User Operator to manage Kafka users</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By configuring the <code>Kafka</code> resource, the Cluster Operator can deploy the Entity Operator, including one or both operators.
Once deployed, the operators are automatically configured to handle the topics and users of the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>Each operator can only monitor a single namespace.
For more information, see <a href="#con-operators-namespaces-str">Watching Strimzi resources in Kubernetes namespaces</a>.</p>
</div>
<div class="paragraph">
<p>The <code>entityOperator</code> property supports several sub-properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>tlsSidecar</code></p>
</li>
<li>
<p><code>topicOperator</code></p>
</li>
<li>
<p><code>userOperator</code></p>
</li>
<li>
<p><code>template</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>tlsSidecar</code> property contains the configuration of the TLS sidecar container, which is used to communicate with ZooKeeper.</p>
</div>
<div class="paragraph">
<p>The <code>template</code> property contains the configuration of the Entity Operator pod, such as labels, annotations, affinity, and tolerations.
For more information on configuring templates, see <a href="#assembly-customizing-kubernetes-resources-str">Customizing Kubernetes resources</a>.</p>
</div>
<div class="paragraph">
<p>The <code>topicOperator</code> property contains the configuration of the Topic Operator.
When this option is missing, the Entity Operator is deployed without the Topic Operator.</p>
</div>
<div class="paragraph">
<p>The <code>userOperator</code> property contains the configuration of the User Operator.
When this option is missing, the Entity Operator is deployed without the User Operator.</p>
</div>
<div class="paragraph">
<p>For more information on the properties used to configure the Entity Operator, see the <a href="./configuring.html#type-EntityOperatorSpec-reference" target="_blank" rel="noopener"><code>EntityOperatorSpec</code> schema reference</a>.</p>
</div>
<div class="listingblock">
<div class="title">Example of basic configuration enabling both operators</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
  zookeeper:
    # ...
  entityOperator:
    topicOperator: {}
    userOperator: {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If an empty object (<code>{}</code>) is used for the <code>topicOperator</code> and <code>userOperator</code>, all properties use their default values.</p>
</div>
<div class="paragraph">
<p>When both <code>topicOperator</code> and <code>userOperator</code> properties are missing, the Entity Operator is not deployed.</p>
</div>
<div class="sect3">
<h4 id="topic-operator-str"><a class="link" href="#topic-operator-str">9.4.1. Configuring the Topic Operator</a></h4>
<div class="paragraph _abstract">
<p>Use <code>topicOperator</code> properties in <code>Kafka.spec.entityOperator</code> to configure the Topic Operator.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using unidirectional topic management, which is enabled by default, the following properties are not used and are ignored: <code>Kafka.spec.entityOperator.topicOperator.zookeeperSessionTimeoutSeconds</code> and <code>Kafka.spec.entityOperator.topicOperator.topicMetadataMaxAttempts</code>.
For more information on unidirectional topic management, refer to <a href="#ref-operator-topic-str">Topic management modes</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following properties are supported:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>watchedNamespace</code></dt>
<dd>
<p>The Kubernetes namespace in which the Topic Operator watches for <code>KafkaTopic</code> resources.
Default is the namespace where the Kafka cluster is deployed.</p>
</dd>
<dt class="hdlist1"><code>reconciliationIntervalSeconds</code></dt>
<dd>
<p>The interval between periodic reconciliations in seconds.
Default <code>120</code>.</p>
</dd>
<dt class="hdlist1"><code>zookeeperSessionTimeoutSeconds</code></dt>
<dd>
<p>The ZooKeeper session timeout in seconds.
Default <code>18</code>.</p>
</dd>
<dt class="hdlist1"><code>topicMetadataMaxAttempts</code></dt>
<dd>
<p>The number of attempts at getting topic metadata from Kafka.
The time between each attempt is defined as an exponential back-off.
Consider increasing this value when topic creation might take more time due to the number of partitions or replicas.
Default <code>6</code>.</p>
</dd>
<dt class="hdlist1"><code>image</code></dt>
<dd>
<p>The <code>image</code> property can be used to configure the container image which is used.
To learn more, refer to the information provided on <a href="./configuring.html#con-common-configuration-images-reference" target="_blank" rel="noopener">configuring the <code>image</code> property`</a>.</p>
</dd>
<dt class="hdlist1"><code>resources</code></dt>
<dd>
<p>The <code>resources</code> property configures the amount of resources allocated to the Topic Operator.
You can specify requests and limits for <code>memory</code> and <code>cpu</code> resources.
The requests should be enough to ensure a stable performance of the operator.</p>
</dd>
<dt class="hdlist1"><code>logging</code></dt>
<dd>
<p>The <code>logging</code> property configures the logging of the Topic Operator.
To learn more, refer to the information provided on <a href="./configuring.html#property-topic-operator-logging-reference" target="_blank" rel="noopener">Topic Operator logging</a>.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Example Topic Operator configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
  zookeeper:
    # ...
  entityOperator:
    # ...
    topicOperator:
      watchedNamespace: my-topic-namespace
      reconciliationIntervalSeconds: 60
      resources:
        requests:
          cpu: "1"
          memory: 500Mi
        limits:
          cpu: "1"
          memory: 500Mi
    # ...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="user-operator-str"><a class="link" href="#user-operator-str">9.4.2. Configuring the User Operator</a></h4>
<div class="paragraph _abstract">
<p>Use <code>userOperator</code> properties in <code>Kafka.spec.entityOperator</code> to configure the User Operator.
The following properties are supported:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>watchedNamespace</code></dt>
<dd>
<p>The Kubernetes namespace in which the User Operator watches for <code>KafkaUser</code> resources.
Default is the namespace where the Kafka cluster is deployed.</p>
</dd>
<dt class="hdlist1"><code>reconciliationIntervalSeconds</code></dt>
<dd>
<p>The interval between periodic reconciliations in seconds.
Default <code>120</code>.</p>
</dd>
<dt class="hdlist1"><code>image</code></dt>
<dd>
<p>The <code>image</code> property can be used to configure the container image which will be used.
To learn more, refer to the information provided on <a href="./configuring.html#con-common-configuration-images-reference" target="_blank" rel="noopener">configuring the <code>image</code> property`</a>.</p>
</dd>
<dt class="hdlist1"><code>resources</code></dt>
<dd>
<p>The <code>resources</code> property configures the amount of resources allocated to the User Operator.
You can specify requests and limits for <code>memory</code> and <code>cpu</code> resources.
The requests should be enough to ensure a stable performance of the operator.</p>
</dd>
<dt class="hdlist1"><code>logging</code></dt>
<dd>
<p>The <code>logging</code> property configures the logging of the User Operator.
To learn more, refer to the information provided on <a href="./configuring.html#property-user-operator-logging-reference" target="_blank" rel="noopener">User Operator logging</a>.</p>
</dd>
<dt class="hdlist1"><code>secretPrefix</code></dt>
<dd>
<p>The <code>secretPrefix</code> property adds a prefix to the name of all Secrets created from the KafkaUser resource. For example, <code>secretPrefix: kafka-</code> would prefix all Secret names with <code>kafka-</code>. So a KafkaUser named <code>my-user</code> would create a Secret named <code>kafka-my-user</code>.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Example User Operator configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
  zookeeper:
    # ...
  entityOperator:
    # ...
    userOperator:
      watchedNamespace: my-user-namespace
      reconciliationIntervalSeconds: 60
      resources:
        requests:
          cpu: "1"
          memory: 500Mi
        limits:
          cpu: "1"
          memory: 500Mi
    # ...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ref-operator-cluster-str"><a class="link" href="#ref-operator-cluster-str">9.5. Configuring the Cluster Operator</a></h3>
<div class="paragraph _abstract">
<p>Use environment variables to configure the Cluster Operator.
Specify the environment variables for the container image of the Cluster Operator in its <code>Deployment</code> configuration file.
You can use the following environment variables to configure the Cluster Operator.
If you are running Cluster Operator replicas in standby mode, there are additional <a href="#con-configuring-cluster-operator-leader-election-str">environment variables for enabling leader election</a>.</p>
</div>
<div class="paragraph">
<p>Kafka, Kafka Connect, and Kafka MirrorMaker support multiple versions.
Use their <code>STRIMZI_&lt;COMPONENT_NAME&gt;_IMAGES</code> environment variables to configure the default container images used for each version.
The configuration provides a mapping between a version and an image.
The required syntax is whitespace or comma-separated <code>&lt;version&gt; = &lt;image&gt;</code> pairs, which determine the image to use for a given version.
For example, 3.6.1=quay.io/strimzi/kafka:0.39.0-kafka-3.6.1.
Theses default images are overridden if <code>image</code> property values are specified in the configuration of a component.
For more information on <code>image</code> configuration of components, see the <a href="./configuring.html#con-common-configuration-images-reference" target="_blank" rel="noopener">Strimzi Custom Resource API Reference</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>Deployment</code> configuration file provided with the Strimzi release artifacts is <code>install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code>.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>STRIMZI_NAMESPACE</code></dt>
<dd>
<p>A comma-separated list of namespaces that the operator operates in.
When not set, set to empty string, or set to <code>*</code>, the Cluster Operator operates in all namespaces.</p>
<div class="paragraph">
<p>The Cluster Operator deployment might use the downward API to set this automatically to the namespace the Cluster Operator is deployed in.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration for Cluster Operator namespaces</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: STRIMZI_NAMESPACE
    valueFrom:
      fieldRef:
        fieldPath: metadata.namespace</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1"><code>STRIMZI_FULL_RECONCILIATION_INTERVAL_MS</code></dt>
<dd>
<p>Optional, default is 120000 ms.
The interval between <a href="#ref-operator-cluster-periodic-reconciliation-str">periodic reconciliations</a>, in milliseconds.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_OPERATION_TIMEOUT_MS</code></dt>
<dd>
<p>Optional, default 300000 ms.
The timeout for internal operations, in milliseconds. Increase this value when using Strimzi on clusters where regular Kubernetes operations take longer than usual (due to factors such as prolonged download times for container images, for example).</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_ZOOKEEPER_ADMIN_SESSION_TIMEOUT_MS</code></dt>
<dd>
<p>Optional, default 10000 ms.
The session timeout for the Cluster Operator&#8217;s ZooKeeper admin client, in milliseconds.
Increase the value if ZooKeeper requests from the Cluster Operator are regularly failing due to timeout issues.
There is a maximum allowed session time set on the ZooKeeper server side via the <code>maxSessionTimeout</code> config.
By default, the maximum session timeout value is 20 times the default <code>tickTime</code> (whose default is 2000) at 40000 ms.
If you require a higher timeout, change the <code>maxSessionTimeout</code> ZooKeeper server configuration value.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_OPERATIONS_THREAD_POOL_SIZE</code></dt>
<dd>
<p>Optional, default 10.
The worker thread pool size, which is used for various asynchronous and blocking operations that are run by the Cluster Operator.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_OPERATOR_NAME</code></dt>
<dd>
<p>Optional, defaults to the pod&#8217;s hostname.
The operator name identifies the Strimzi instance when <a href="#proc-operator-restart-events-str">emitting Kubernetes events</a>.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_OPERATOR_NAMESPACE</code></dt>
<dd>
<p>The name of the namespace where the Cluster Operator is running.
Do not configure this variable manually. Use the downward API.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: STRIMZI_OPERATOR_NAMESPACE
    valueFrom:
      fieldRef:
        fieldPath: metadata.namespace</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1"><code>STRIMZI_OPERATOR_NAMESPACE_LABELS</code></dt>
<dd>
<p>Optional.
The labels of the namespace where the Strimzi Cluster Operator is running.
Use namespace labels to configure the namespace selector in <a href="#ref-operator-cluster-network-policy-str">network policies</a>.
Network policies allow the Strimzi Cluster Operator access only to the operands from the namespace with these labels.
When not set, the namespace selector in network policies is configured to allow access to the Cluster Operator from any namespace in the Kubernetes cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: STRIMZI_OPERATOR_NAMESPACE_LABELS
    value: label1=value1,label2=value2</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1"><code>STRIMZI_LABELS_EXCLUSION_PATTERN</code></dt>
<dd>
<p>Optional, default regex pattern is <code>^app.kubernetes.io/(?!part-of).*</code>.
The regex exclusion pattern used to filter labels propagation from the main custom resource to its subresources.
The labels exclusion filter is not applied to labels in template sections such as <code>spec.kafka.template.pod.metadata.labels</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: STRIMZI_LABELS_EXCLUSION_PATTERN
    value: "^key1.*"</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1"><code>STRIMZI_CUSTOM_&lt;COMPONENT_NAME&gt;_LABELS</code></dt>
<dd>
<p>Optional.
One or more custom labels to apply to all the pods created by the <code>{COMPONENT_NAME}</code> custom resource.
The Cluster Operator labels the pods when the custom resource is created or is next reconciled.</p>
<div class="paragraph">
<p>Labels can be applied to the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>KAFKA</code></p>
</li>
<li>
<p><code>KAFKA_CONNECT</code></p>
</li>
<li>
<p><code>KAFKA_CONNECT_BUILD</code></p>
</li>
<li>
<p><code>ZOOKEEPER</code></p>
</li>
<li>
<p><code>ENTITY_OPERATOR</code></p>
</li>
<li>
<p><code>KAFKA_MIRROR_MAKER2</code></p>
</li>
<li>
<p><code>KAFKA_MIRROR_MAKER</code></p>
</li>
<li>
<p><code>CRUISE_CONTROL</code></p>
</li>
<li>
<p><code>KAFKA_BRIDGE</code></p>
</li>
<li>
<p><code>KAFKA_EXPORTER</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>STRIMZI_CUSTOM_RESOURCE_SELECTOR</code></dt>
<dd>
<p>Optional.
The label selector to filter the custom resources handled by the Cluster Operator.
The operator will operate only on those custom resources that have the specified labels set.
Resources without these labels will not be seen by the operator.
The label selector applies to <code>Kafka</code>, <code>KafkaConnect</code>, <code>KafkaBridge</code>, <code>KafkaMirrorMaker</code>, and <code>KafkaMirrorMaker2</code> resources.
<code>KafkaRebalance</code> and <code>KafkaConnector</code> resources are operated only when their corresponding Kafka and Kafka Connect clusters have the matching labels.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: STRIMZI_CUSTOM_RESOURCE_SELECTOR
    value: label1=value1,label2=value2</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1"><code>STRIMZI_KAFKA_IMAGES</code></dt>
<dd>
<p>Required.
The mapping from the Kafka version to the corresponding image containing a Kafka broker for that version.
For example <code>3.5.1=quay.io/strimzi/kafka:0.39.0-kafka-3.5.1, 3.6.1=quay.io/strimzi/kafka:0.39.0-kafka-3.6.1</code>.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_KAFKA_CONNECT_IMAGES</code></dt>
<dd>
<p>Required.
The mapping from the Kafka version to the corresponding image of Kafka Connect for that version.
For example <code>3.5.1=quay.io/strimzi/kafka:0.39.0-kafka-3.5.1, 3.6.1=quay.io/strimzi/kafka:0.39.0-kafka-3.6.1</code>.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_KAFKA_MIRROR_MAKER2_IMAGES</code></dt>
<dd>
<p>Required.
The mapping from the Kafka version to the corresponding image of MirrorMaker 2 for that version.
For example <code>3.5.1=quay.io/strimzi/kafka:0.39.0-kafka-3.5.1, 3.6.1=quay.io/strimzi/kafka:0.39.0-kafka-3.6.1</code>.</p>
</dd>
<dt class="hdlist1">(Deprecated) <code>STRIMZI_KAFKA_MIRROR_MAKER_IMAGES</code></dt>
<dd>
<p>Required.
The mapping from the Kafka version to the corresponding image of MirrorMaker for that version.
For example <code>3.5.1=quay.io/strimzi/kafka:0.39.0-kafka-3.5.1, 3.6.1=quay.io/strimzi/kafka:0.39.0-kafka-3.6.1</code>.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_DEFAULT_TOPIC_OPERATOR_IMAGE</code></dt>
<dd>
<p>Optional.
The default is <code>quay.io/strimzi/operator:0.39.0</code>.
The image name to use as the default when deploying the Topic Operator
if no image is specified as the <code>Kafka.spec.entityOperator.topicOperator.image</code> in the <code>Kafka</code> resource.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_DEFAULT_USER_OPERATOR_IMAGE</code></dt>
<dd>
<p>Optional.
The default is <code>quay.io/strimzi/operator:0.39.0</code>.
The image name to use as the default when deploying the User Operator
if no image is specified as the <code>Kafka.spec.entityOperator.userOperator.image</code> in the <code>Kafka</code> resource.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_DEFAULT_TLS_SIDECAR_ENTITY_OPERATOR_IMAGE</code></dt>
<dd>
<p>Optional.
The default is <code>quay.io/strimzi/kafka:0.39.0-kafka-3.6.1</code>.
The image name to use as the default when deploying the sidecar container for the Entity Operator if no image is specified as the <code>Kafka.spec.entityOperator.tlsSidecar.image</code> in the <code>Kafka</code> resource.
The sidecar provides TLS support.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_DEFAULT_KAFKA_EXPORTER_IMAGE</code></dt>
<dd>
<p>Optional.
The default is <code>quay.io/strimzi/kafka:0.39.0-kafka-3.6.1</code>.
The image name to use as the default when deploying the Kafka Exporter if no image is specified as the <code>Kafka.spec.kafkaExporter.image</code> in the <code>Kafka</code> resource.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_DEFAULT_CRUISE_CONTROL_IMAGE</code></dt>
<dd>
<p>Optional.
The default is <code>quay.io/strimzi/kafka:0.39.0-kafka-3.6.1</code>.
The image name to use as the default when deploying Cruise Control if no image is specified as the <code>Kafka.spec.cruiseControl.image</code> in the <code>Kafka</code> resource.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_DEFAULT_KAFKA_BRIDGE_IMAGE</code></dt>
<dd>
<p>Optional.
The default is <code>quay.io/strimzi/kafka-bridge:0.27.0</code>.
The image name to use as the default when deploying the Kafka Bridge if no image is specified as the <code>Kafka.spec.kafkaBridge.image</code> in the <code>Kafka</code> resource.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_DEFAULT_KAFKA_INIT_IMAGE</code></dt>
<dd>
<p>Optional.
The default is <code>quay.io/strimzi/operator:0.39.0</code>.
The image name to use as the default for the Kafka initializer container if no image is specified in the <code>brokerRackInitImage</code> of the <code>Kafka</code> resource or the <code>clientRackInitImage</code> of the Kafka Connect resource.
The init container is started before the Kafka cluster for initial configuration work, such as rack support.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_IMAGE_PULL_POLICY</code></dt>
<dd>
<p>Optional.
The <code>ImagePullPolicy</code> that is applied to containers in all pods managed by the Cluster Operator.
The valid values are <code>Always</code>, <code>IfNotPresent</code>, and <code>Never</code>.
If not specified, the Kubernetes defaults are used.
Changing the policy will result in a rolling update of all your Kafka, Kafka Connect, and Kafka MirrorMaker clusters.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_IMAGE_PULL_SECRETS</code></dt>
<dd>
<p>Optional.
A comma-separated list of <code>Secret</code> names.
The secrets referenced here contain the credentials to the container registries where the container images are pulled from.
The secrets are specified in the <code>imagePullSecrets</code> property for all pods created by the Cluster Operator.
Changing this list results in a rolling update of all your Kafka, Kafka Connect, and Kafka MirrorMaker clusters.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_KUBERNETES_VERSION</code></dt>
<dd>
<p>Optional.
Overrides the Kubernetes version information detected from the API server.</p>
<div class="listingblock">
<div class="title">Example configuration for Kubernetes version override</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: STRIMZI_KUBERNETES_VERSION
    value: |
           major=1
           minor=16
           gitVersion=v1.16.2
           gitCommit=c97fe5036ef3df2967d086711e6c0c405941e14b
           gitTreeState=clean
           buildDate=2019-10-15T19:09:08Z
           goVersion=go1.12.10
           compiler=gc
           platform=linux/amd64</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1"><code>KUBERNETES_SERVICE_DNS_DOMAIN</code></dt>
<dd>
<p>Optional.
Overrides the default Kubernetes DNS domain name suffix.</p>
<div class="paragraph">
<p>By default, services assigned in the Kubernetes cluster have a DNS domain name that uses the default suffix <code>cluster.local</code>.</p>
</div>
<div class="paragraph">
<p>For example, for broker <em>kafka-0</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"><em>&lt;cluster-name&gt;</em>-kafka-0.<em>&lt;cluster-name&gt;</em>-kafka-brokers.<em>&lt;namespace&gt;</em>.svc.<em>cluster.local</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The DNS domain name is added to the Kafka broker certificates used for hostname verification.</p>
</div>
<div class="paragraph">
<p>If you are using a different DNS domain name suffix in your cluster, change the <code>KUBERNETES_SERVICE_DNS_DOMAIN</code> environment variable from the default to the one you are using in order to establish a connection with the Kafka brokers.</p>
</div>
</dd>
<dt class="hdlist1"><code>STRIMZI_CONNECT_BUILD_TIMEOUT_MS</code></dt>
<dd>
<p>Optional, default 300000 ms.
The timeout for building new Kafka Connect images with additional connectors, in milliseconds.
Consider increasing this value when using Strimzi to build container images containing many connectors or using a slow container registry.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_NETWORK_POLICY_GENERATION</code></dt>
<dd>
<p>Optional, default <code>true</code>.
Network policy for resources.
Network policies allow connections between Kafka components.</p>
<div class="paragraph">
<p>Set this environment variable to <code>false</code> to disable network policy generation. You might do this, for example, if you want to use custom network policies. Custom network policies allow more control over maintaining the connections between components.</p>
</div>
</dd>
<dt class="hdlist1"><code>STRIMZI_DNS_CACHE_TTL</code></dt>
<dd>
<p>Optional, default <code>30</code>.
Number of seconds to cache successful name lookups in local DNS resolver. Any negative value means cache forever. Zero means do not cache, which can be useful for avoiding connection errors due to long caching policies being applied.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_POD_SET_RECONCILIATION_ONLY</code></dt>
<dd>
<p>Optional, default <code>false</code>.
When set to <code>true</code>, the Cluster Operator reconciles only the <code>StrimziPodSet</code> resources and any changes to the other custom resources (<code>Kafka</code>, <code>KafkaConnect</code>, and so on) are ignored.
This mode is useful for ensuring that your pods are recreated if needed, but no other changes happen to the clusters.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_FEATURE_GATES</code></dt>
<dd>
<p>Optional.
Enables or disables the features and functionality controlled by <a href="#ref-operator-cluster-feature-gates-str">feature gates</a>.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_POD_SECURITY_PROVIDER_CLASS</code></dt>
<dd>
<p>Optional.
Configuration for the pluggable <code>PodSecurityProvider</code> class, which can be used to provide the security context configuration for Pods and containers.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="ref-operator-cluster-network-policy-str"><a class="link" href="#ref-operator-cluster-network-policy-str">9.5.1. Restricting access to the Cluster Operator using network policy</a></h4>
<div class="paragraph">
<p>Use the <code>STRIMZI_OPERATOR_NAMESPACE_LABELS</code> environment variable to establish network policy for the Cluster Operator using namespace labels.</p>
</div>
<div class="paragraph">
<p>The Cluster Operator can run in the same namespace as the resources it manages, or in a separate namespace.
By default, the <code>STRIMZI_OPERATOR_NAMESPACE</code> environment variable is configured to use the downward API to find the namespace the Cluster Operator is running in.
If the Cluster Operator is running in the same namespace as the resources, only local access is required and allowed by Strimzi.</p>
</div>
<div class="paragraph">
<p>If the Cluster Operator is running in a separate namespace to the resources it manages, any namespace in the Kubernetes cluster is allowed access to the Cluster Operator unless network policy is configured.
By adding namespace labels, access to the Cluster Operator is restricted to the namespaces specified.</p>
</div>
<div class="listingblock">
<div class="title">Network policy configured for the Cluster Operator deployment</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">#...
env:
  # ...
  - name: STRIMZI_OPERATOR_NAMESPACE_LABELS
    value: label1=value1,label2=value2
  #...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ref-operator-cluster-periodic-reconciliation-str"><a class="link" href="#ref-operator-cluster-periodic-reconciliation-str">9.5.2. Configuring periodic reconciliation by the Cluster Operator</a></h4>
<div class="paragraph">
<p>Use the <code>STRIMZI_FULL_RECONCILIATION_INTERVAL_MS</code> variable to set the time interval for periodic reconciliations by the Cluster Operator.
Replace its value with the required interval in milliseconds.</p>
</div>
<div class="listingblock">
<div class="title">Reconciliation period configured for the Cluster Operator deployment</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">#...
env:
  # ...
  - name: STRIMZI_FULL_RECONCILIATION_INTERVAL_MS
    value: "120000"
  #...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Cluster Operator reacts to all notifications about applicable cluster resources received from the Kubernetes cluster.
If the operator is not running, or if a notification is not received for any reason, resources will get out of sync with the state of the running Kubernetes cluster.
In order to handle failovers properly, a periodic reconciliation process is executed by the Cluster Operator so that it can compare the state of the resources with the current cluster deployments in order to have a consistent state across all of them.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/#the-downward-api" target="_blank" rel="noopener">Downward API</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="assembly-using-multiple-cluster-operator-replicas-str"><a class="link" href="#assembly-using-multiple-cluster-operator-replicas-str">9.5.3. Running multiple Cluster Operator replicas with leader election</a></h4>
<div class="paragraph _abstract">
<p>The default Cluster Operator configuration enables leader election to run multiple parallel replicas of the Cluster Operator.
One replica is elected as the active leader and operates the deployed resources.
The other replicas run in standby mode.
When the leader stops or fails, one of the standby replicas is elected as the new leader and starts operating the deployed resources.</p>
</div>
<div class="paragraph">
<p>By default, Strimzi runs with a single Cluster Operator replica that is always the leader replica.
When a single Cluster Operator replica stops or fails, Kubernetes starts a new replica.</p>
</div>
<div class="paragraph">
<p>Running the Cluster Operator with multiple replicas is not essential.
But it&#8217;s useful to have replicas on standby in case of large-scale disruptions caused by major failure.
For example, suppose multiple worker nodes or an entire availability zone fails.
This failure might cause the Cluster Operator pod and many Kafka pods to go down at the same time.
If subsequent pod scheduling causes congestion through lack of resources, this can delay operations when running a single Cluster Operator.</p>
</div>
<div class="sect4">
<h5 id="con-configuring-cluster-operator-leader-election-str"><a class="link" href="#con-configuring-cluster-operator-leader-election-str">Enabling leader election for Cluster Operator replicas</a></h5>
<div class="paragraph _abstract">
<p>Configure leader election environment variables when running additional Cluster Operator replicas.
The following environment variables are supported:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>STRIMZI_LEADER_ELECTION_ENABLED</code></dt>
<dd>
<p>Optional, disabled (<code>false</code>) by default.
Enables or disables leader election, which allows additional Cluster Operator replicas to run on standby.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Leader election is disabled by default.
It is only enabled when applying this environment variable on installation.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>STRIMZI_LEADER_ELECTION_LEASE_NAME</code></dt>
<dd>
<p>Required when leader election is enabled.
The name of the Kubernetes <code>Lease</code> resource that is used for the leader election.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_LEADER_ELECTION_LEASE_NAMESPACE</code></dt>
<dd>
<p>Required when leader election is enabled.
The namespace where the Kubernetes <code>Lease</code> resource used for leader election is created.
You can use the downward API to configure it to the namespace where the Cluster Operator is deployed.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: STRIMZI_LEADER_ELECTION_LEASE_NAMESPACE
    valueFrom:
      fieldRef:
        fieldPath: metadata.namespace</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1"><code>STRIMZI_LEADER_ELECTION_IDENTITY</code></dt>
<dd>
<p>Required when leader election is enabled.
Configures the identity of a given Cluster Operator instance used during the leader election.
The identity must be unique for each operator instance.
You can use the downward API to configure it to the name of the pod where the Cluster Operator is deployed.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: STRIMZI_LEADER_ELECTION_IDENTITY
    valueFrom:
      fieldRef:
        fieldPath: metadata.name</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1"><code>STRIMZI_LEADER_ELECTION_LEASE_DURATION_MS</code></dt>
<dd>
<p>Optional, default 15000 ms.
Specifies the duration the acquired lease is valid.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_LEADER_ELECTION_RENEW_DEADLINE_MS</code></dt>
<dd>
<p>Optional, default 10000 ms.
Specifies the period the leader should try to maintain leadership.</p>
</dd>
<dt class="hdlist1"><code>STRIMZI_LEADER_ELECTION_RETRY_PERIOD_MS</code></dt>
<dd>
<p>Optional, default 2000 ms.
Specifies the frequency of updates to the lease lock by the leader.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="assembly-configuring-proxy-config-cluster-operator-str"><a class="link" href="#assembly-configuring-proxy-config-cluster-operator-str">Configuring Cluster Operator replicas</a></h5>
<div class="paragraph _abstract">
<p>To run additional Cluster Operator replicas in standby mode, you will need to increase the number of replicas and enable leader election.
To configure leader election, use the leader election environment variables.</p>
</div>
<div class="paragraph">
<p>To make the required changes, configure the following Cluster Operator installation files located in <code>install/cluster-operator/</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>060-Deployment-strimzi-cluster-operator.yaml</p>
</li>
<li>
<p>022-ClusterRole-strimzi-cluster-operator-role.yaml</p>
</li>
<li>
<p>022-RoleBinding-strimzi-cluster-operator.yaml</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Leader election has its own <code>ClusterRole</code> and <code>RoleBinding</code> RBAC resources that target the namespace where the Cluster Operator is running, rather than the namespace it is watching.</p>
</div>
<div class="paragraph">
<p>The default deployment configuration creates a <code>Lease</code> resource called <code>strimzi-cluster-operator</code> in the same namespace as the Cluster Operator.
The Cluster Operator uses leases to manage leader election.
The RBAC resources provide the permissions to use the <code>Lease</code> resource.
If you use a different <code>Lease</code> name or namespace, update the <code>ClusterRole</code> and <code>RoleBinding</code> files accordingly.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You need an account with permission to create and manage <code>CustomResourceDefinition</code> and RBAC (<code>ClusterRole</code>, and <code>RoleBinding</code>) resources.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Edit the <code>Deployment</code> resource that is used to deploy the Cluster Operator, which is defined in the <code>060-Deployment-strimzi-cluster-operator.yaml</code> file.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Change the <code>replicas</code> property from the default (1) to a value that matches the required number of replicas.</p>
<div class="listingblock">
<div class="title">Increasing the number of Cluster Operator replicas</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: strimzi-cluster-operator
  labels:
    app: strimzi
spec:
  replicas: 3</code></pre>
</div>
</div>
</li>
<li>
<p>Check that the leader election <code>env</code> properties are set.</p>
<div class="paragraph">
<p>If they are not set, configure them.</p>
</div>
<div class="paragraph">
<p>To enable leader election, <code>STRIMZI_LEADER_ELECTION_ENABLED</code> must be set to <code>true</code> (default).</p>
</div>
<div class="paragraph">
<p>In this example, the name of the lease is changed to <code>my-strimzi-cluster-operator</code>.</p>
</div>
<div class="listingblock">
<div class="title">Configuring leader election environment variables for the Cluster Operator</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml"># ...
spec
  containers:
    - name: strimzi-cluster-operator
      # ...
      env:
        - name: STRIMZI_LEADER_ELECTION_ENABLED
          value: "true"
        - name: STRIMZI_LEADER_ELECTION_LEASE_NAME
          value: "my-strimzi-cluster-operator"
        - name: STRIMZI_LEADER_ELECTION_LEASE_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
        - name: STRIMZI_LEADER_ELECTION_IDENTITY
            valueFrom:
              fieldRef:
                fieldPath: metadata.name</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a description of the available environment variables, see <a href="#con-configuring-cluster-operator-leader-election-str">Enabling leader election for Cluster Operator replicas</a>.</p>
</div>
<div class="paragraph">
<p>If you specified a different name or namespace for the <code>Lease</code> resource used in leader election, update the RBAC resources.</p>
</div>
</li>
<li>
<p>(optional) Edit the <code>ClusterRole</code> resource in the <code>022-ClusterRole-strimzi-cluster-operator-role.yaml</code> file.</p>
<div class="paragraph">
<p>Update <code>resourceNames</code> with the name of the <code>Lease</code> resource.</p>
</div>
<div class="listingblock">
<div class="title">Updating the ClusterRole references to the lease</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: strimzi-cluster-operator-leader-election
  labels:
    app: strimzi
rules:
  - apiGroups:
      - coordination.k8s.io
    resourceNames:
      - my-strimzi-cluster-operator
# ...</code></pre>
</div>
</div>
</li>
<li>
<p>(optional) Edit the <code>RoleBinding</code> resource in the <code>022-RoleBinding-strimzi-cluster-operator.yaml</code> file.</p>
<div class="paragraph">
<p>Update <code>subjects.name</code> and <code>subjects.namespace</code> with the name of the <code>Lease</code> resource and the namespace where it was created.</p>
</div>
<div class="listingblock">
<div class="title">Updating the RoleBinding references to the lease</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: strimzi-cluster-operator-leader-election
  labels:
    app: strimzi
subjects:
  - kind: ServiceAccount
    name: my-strimzi-cluster-operator
    namespace: myproject
# ...</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the Cluster Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/cluster-operator -n myproject</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments -n myproject</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the deployment name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                      READY  UP-TO-DATE  AVAILABLE
strimzi-cluster-operator  3/3    3           3</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>AVAILABLE</code> output shows the correct number of replicas.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="proc-configuring-proxy-config-cluster-operator-str"><a class="link" href="#proc-configuring-proxy-config-cluster-operator-str">9.5.4. Configuring Cluster Operator HTTP proxy settings</a></h4>
<div class="paragraph _abstract">
<p>If you are running a Kafka cluster behind a HTTP proxy, you can still pass data in and out of the cluster.
For example, you can run Kafka Connect with connectors that push and pull data from outside the proxy.
Or you can use a proxy to connect with an authorization server.</p>
</div>
<div class="paragraph">
<p>Configure the Cluster Operator deployment to specify the proxy environment variables.
The Cluster Operator accepts standard proxy configuration (<code>HTTP_PROXY</code>, <code>HTTPS_PROXY</code> and <code>NO_PROXY</code>) as environment variables.
The proxy settings are applied to all Strimzi containers.</p>
</div>
<div class="paragraph">
<p>The format for a proxy address is http://&lt;ip_address&gt;:&lt;port_number&gt;.
To set up a proxy with a name and password, the format is http://&lt;username&gt;:&lt;password&gt;@&lt;ip-address&gt;:&lt;port_number&gt;.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You need an account with permission to create and manage <code>CustomResourceDefinition</code> and RBAC (<code>ClusterRole</code>, and <code>RoleBinding</code>) resources.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To add proxy environment variables to the Cluster Operator, update its <code>Deployment</code> configuration (<code>install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code>).</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example proxy configuration for the Cluster Operator</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
spec:
  # ...
  template:
    spec:
      serviceAccountName: strimzi-cluster-operator
      containers:
        # ...
        env:
        # ...
        - name: "HTTP_PROXY"
          value: "http://proxy.com" <b class="conum">(1)</b>
        - name: "HTTPS_PROXY"
          value: "https://proxy.com" <b class="conum">(2)</b>
        - name: "NO_PROXY"
          value: "internal.com, other.domain.com" <b class="conum">(3)</b>
  # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Address of the proxy server.</p>
</li>
<li>
<p>Secure address of the proxy server.</p>
</li>
<li>
<p>Addresses for servers that are accessed directly as exceptions to the proxy server. The URLs are comma-separated.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>Alternatively, edit the <code>Deployment</code> directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit deployment strimzi-cluster-operator</code></pre>
</div>
</div>
</li>
<li>
<p>If you updated the YAML file instead of editing the <code>Deployment</code> directly, apply the changes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./configuring.html#property-hostaliases-config-reference" target="_blank" rel="noopener">Host aliases</a></p>
</li>
<li>
<p><a href="#adding-users-the-strimzi-admin-role-str">Designating Strimzi administrators</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="proc-disabling-fips-mode-cluster-operator-str"><a class="link" href="#proc-disabling-fips-mode-cluster-operator-str">9.5.5. Disabling FIPS mode using Cluster Operator configuration</a></h4>
<div class="paragraph _abstract">
<p>Strimzi automatically switches to FIPS mode when running on a FIPS-enabled Kubernetes cluster.
Disable FIPS mode by setting the <code>FIPS_MODE</code> environment variable to <code>disabled</code> in the deployment configuration for the Cluster Operator.
With FIPS mode disabled, Strimzi automatically disables FIPS in the OpenJDK for all components.
With FIPS mode disabled, Strimzi is not FIPS compliant.
The Strimzi operators, as well as all operands, run in the same way as if they were running on an Kubernetes cluster without FIPS enabled.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To disable the FIPS mode in the Cluster Operator, update its <code>Deployment</code> configuration (<code>install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code>) and add the <code>FIPS_MODE</code> environment variable.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example FIPS configuration for the Cluster Operator</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
spec:
  # ...
  template:
    spec:
      serviceAccountName: strimzi-cluster-operator
      containers:
        # ...
        env:
        # ...
        - name: "FIPS_MODE"
          value: "disabled" # <b class="conum">(1)</b>
  # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Disables the FIPS mode.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>Alternatively, edit the <code>Deployment</code> directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit deployment strimzi-cluster-operator</code></pre>
</div>
</div>
</li>
<li>
<p>If you updated the YAML file instead of editing the <code>Deployment</code> directly, apply the changes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-kafka-connect-config-str"><a class="link" href="#con-kafka-connect-config-str">9.6. Configuring Kafka Connect</a></h3>
<div class="paragraph _abstract">
<p>Update the <code>spec</code> properties of the <code>KafkaConnect</code> custom resource to configure your Kafka Connect deployment.</p>
</div>
<div class="paragraph">
<p>Use Kafka Connect to set up external data connections to your Kafka cluster.
Use the properties of the <code>KafkaConnect</code> resource to configure your Kafka Connect deployment.</p>
</div>
<div class="paragraph">
<p>For a deeper understanding of the Kafka Connect cluster configuration options, refer to the <a href="./configuring.html" target="_blank" rel="noopener">Strimzi Custom Resource API Reference</a>.</p>
</div>
<div class="paragraph">
<div class="title">KafkaConnector configuration</div>
<p><code>KafkaConnector</code> resources allow you to create and manage connector instances for Kafka Connect in a Kubernetes-native way.</p>
</div>
<div class="paragraph">
<p>In your Kafka Connect configuration, you enable KafkaConnectors for a Kafka Connect cluster by adding the <code>strimzi.io/use-connector-resources</code> annotation.
You can also add a <code>build</code> configuration so that Strimzi automatically builds a container image with the connector plugins you require for your data connections.
External configuration for Kafka Connect connectors is specified through the <code>externalConfiguration</code> property.</p>
</div>
<div class="paragraph">
<p>To manage connectors, you can use use <code>KafkaConnector</code> custom resources or the Kafka Connect REST API.
<code>KafkaConnector</code> resources must be deployed to the same namespace as the Kafka Connect cluster they link to.
For more information on using these methods to create, reconfigure, or delete connectors, see <a href="#using-kafka-connect-with-plug-ins-str">Adding connectors</a>.</p>
</div>
<div class="paragraph">
<p>Connector configuration is passed to Kafka Connect as part of an HTTP request and stored within Kafka itself.
ConfigMaps and Secrets are standard Kubernetes resources used for storing configurations and confidential data.
You can use ConfigMaps and Secrets to configure certain elements of a connector.
You can then reference the configuration values in HTTP REST commands, which keeps the configuration separate and more secure, if needed.
This method applies especially to confidential data, such as usernames, passwords, or certificates.</p>
</div>
<div class="paragraph">
<div class="title">Handling high volumes of messages</div>
<p>You can tune the configuration to handle high volumes of messages.
For more information, see <a href="#con-high-volume-config-properties-str">Handling high volumes of messages</a>.</p>
</div>
<div class="listingblock">
<div class="title">Example <code>KafkaConnect</code> custom resource configuration</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect # <b class="conum">(1)</b>
metadata:
  name: my-connect-cluster
  annotations:
    strimzi.io/use-connector-resources: "true" # <b class="conum">(2)</b>
spec:
  replicas: 3 # <b class="conum">(3)</b>
  authentication: # <b class="conum">(4)</b>
    type: tls
    certificateAndKey:
      certificate: source.crt
      key: source.key
      secretName: my-user-source
  bootstrapServers: my-cluster-kafka-bootstrap:9092 # <b class="conum">(5)</b>
  tls: # <b class="conum">(6)</b>
    trustedCertificates:
      - secretName: my-cluster-cluster-cert
        certificate: ca.crt
      - secretName: my-cluster-cluster-cert
        certificate: ca2.crt
  config: # <b class="conum">(7)</b>
    group.id: my-connect-cluster
    offset.storage.topic: my-connect-cluster-offsets
    config.storage.topic: my-connect-cluster-configs
    status.storage.topic: my-connect-cluster-status
    key.converter: org.apache.kafka.connect.json.JsonConverter
    value.converter: org.apache.kafka.connect.json.JsonConverter
    key.converter.schemas.enable: true
    value.converter.schemas.enable: true
    config.storage.replication.factor: 3
    offset.storage.replication.factor: 3
    status.storage.replication.factor: 3
  build: # <b class="conum">(8)</b>
    output: # <b class="conum">(9)</b>
      type: docker
      image: my-registry.io/my-org/my-connect-cluster:latest
      pushSecret: my-registry-credentials
    plugins: # <b class="conum">(10)</b>
      - name: connector-1
        artifacts:
          - type: tgz
            url: &lt;url_to_download_connector_1_artifact&gt;
            sha512sum: &lt;SHA-512_checksum_of_connector_1_artifact&gt;
      - name: connector-2
        artifacts:
          - type: jar
            url: &lt;url_to_download_connector_2_artifact&gt;
            sha512sum: &lt;SHA-512_checksum_of_connector_2_artifact&gt;
  externalConfiguration: # <b class="conum">(11)</b>
    env:
      - name: AWS_ACCESS_KEY_ID
        valueFrom:
          secretKeyRef:
            name: aws-creds
            key: awsAccessKey
      - name: AWS_SECRET_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: aws-creds
            key: awsSecretAccessKey
  resources: # <b class="conum">(12)</b>
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "2"
      memory: 2Gi
  logging: # <b class="conum">(13)</b>
    type: inline
    loggers:
      log4j.rootLogger: INFO
  readinessProbe: # <b class="conum">(14)</b>
    initialDelaySeconds: 15
    timeoutSeconds: 5
  livenessProbe:
    initialDelaySeconds: 15
    timeoutSeconds: 5
  metricsConfig: # <b class="conum">(15)</b>
    type: jmxPrometheusExporter
    valueFrom:
      configMapKeyRef:
        name: my-config-map
        key: my-key
  jvmOptions: # <b class="conum">(16)</b>
    "-Xmx": "1g"
    "-Xms": "1g"
  image: my-org/my-image:latest # <b class="conum">(17)</b>
  rack:
    topologyKey: topology.kubernetes.io/zone # <b class="conum">(18)</b>
  template: # <b class="conum">(19)</b>
    pod:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: application
                    operator: In
                    values:
                      - postgresql
                      - mongodb
              topologyKey: "kubernetes.io/hostname"
    connectContainer: # <b class="conum">(20)</b>
      env:
        - name: OTEL_SERVICE_NAME
          value: my-otel-service
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "http://otlp-host:4317"
  tracing:
    type: opentelemetry # <b class="conum">(21)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Use <code>KafkaConnect</code>.</p>
</li>
<li>
<p>Enables KafkaConnectors for the Kafka Connect cluster.</p>
</li>
<li>
<p>The number of replica nodes for the workers that run tasks.</p>
</li>
<li>
<p>Authentication for the Kafka Connect cluster, specified as mTLS, token-based OAuth, SASL-based SCRAM-SHA-256/SCRAM-SHA-512, or PLAIN.
By default, Kafka Connect connects to Kafka brokers using a plain text connection.</p>
</li>
<li>
<p>Bootstrap server for connection to the Kafka cluster.</p>
</li>
<li>
<p>TLS encryption with key names under which TLS certificates are stored in X.509 format for the cluster. If certificates are stored in the same secret, it can be listed multiple times.</p>
</li>
<li>
<p>Kafka Connect configuration of workers (not connectors).
Standard Apache Kafka configuration may be provided, restricted to those properties not managed directly by Strimzi.</p>
</li>
<li>
<p>Build configuration properties for building a container image with connector plugins automatically.</p>
</li>
<li>
<p>(Required) Configuration of the container registry where new images are pushed.</p>
</li>
<li>
<p>(Required) List of connector plugins and their artifacts to add to the new container image. Each plugin must be configured with at least one <code>artifact</code>.</p>
</li>
<li>
<p>External configuration for connectors using environment variables, as shown here, or volumes.
You can also use configuration provider plugins to load configuration values from external sources.</p>
</li>
<li>
<p>Requests for reservation of supported resources, currently <code>cpu</code> and <code>memory</code>, and limits to specify the maximum resources that can be consumed.</p>
</li>
<li>
<p>Specified Kafka Connect loggers and log levels added directly (<code>inline</code>) or indirectly (<code>external</code>) through a ConfigMap. A custom Log4j configuration must be placed under the <code>log4j.properties</code> or <code>log4j2.properties</code> key in the ConfigMap. For the Kafka Connect <code>log4j.rootLogger</code> logger, you can set the log level to INFO, ERROR, WARN, TRACE, DEBUG, FATAL or OFF.</p>
</li>
<li>
<p>Healthchecks to know when to restart a container (liveness) and when a container can accept traffic (readiness).</p>
</li>
<li>
<p>Prometheus metrics, which are enabled by referencing a ConfigMap containing configuration for the Prometheus JMX exporter in this example. You can enable metrics without further configuration using a reference to a ConfigMap containing an empty file under <code>metricsConfig.valueFrom.configMapKeyRef.key</code>.</p>
</li>
<li>
<p>JVM configuration options to optimize performance for the Virtual Machine (VM) running Kafka Connect.</p>
</li>
<li>
<p>ADVANCED OPTION: Container image configuration, which is recommended only in special situations.</p>
</li>
<li>
<p>SPECIALIZED OPTION: Rack awareness configuration for the deployment. This is a specialized option intended for a deployment within the same location, not across regions. Use this option if you want connectors to consume from the closest replica rather than the leader replica. In certain cases, consuming from the closest replica can improve network utilization or reduce costs . The <code>topologyKey</code> must match a node label containing the rack ID. The example used in this configuration specifies a zone using the standard <code><a href="https://kubernetes.io/docs/reference/labels-annotations-taints/#topologykubernetesiozone" target="_blank" rel="noopener">topology.kubernetes.io/zone</a></code> label. To consume from the closest replica, enable the <code>RackAwareReplicaSelector</code>  in the Kafka broker configuration.</p>
</li>
<li>
<p>Template customization. Here a pod is scheduled with anti-affinity, so the pod is not scheduled on nodes with the same hostname.</p>
</li>
<li>
<p>Environment variables are set for distributed tracing.</p>
</li>
<li>
<p>Distributed tracing is enabled by using OpenTelemetry.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="con-config-kafka-connect-multiple-instances-str"><a class="link" href="#con-config-kafka-connect-multiple-instances-str">9.6.1. Configuring Kafka Connect for multiple instances</a></h4>
<div class="paragraph _abstract">
<p>By default, Strimzi configures the group ID and names of the internal topics used by Kafka Connect.
When running multiple instances of Kafka Connect, you must change these default settings using the following <code>config</code> properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect
spec:
  config:
    group.id: my-connect-cluster # <b class="conum">(1)</b>
    offset.storage.topic: my-connect-cluster-offsets # <b class="conum">(2)</b>
    config.storage.topic: my-connect-cluster-configs # <b class="conum">(3)</b>
    status.storage.topic: my-connect-cluster-status # <b class="conum">(4)</b>
    # ...
  # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Kafka Connect cluster group ID within Kafka.</p>
</li>
<li>
<p>Kafka topic that stores connector offsets.</p>
</li>
<li>
<p>Kafka topic that stores connector and task status configurations.</p>
</li>
<li>
<p>Kafka topic that stores connector and task status updates.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Values for the three topics must be the same for all instances with the same <code>group.id</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Unless you modify these default settings, each instance connecting to the same Kafka cluster is deployed with the same values.
In practice, this means all instances form a cluster and use the same internal topics.</p>
</div>
<div class="paragraph">
<p>Multiple instances attempting to use the same internal topics will cause unexpected errors, so you must change the values of these properties for each instance.</p>
</div>
</div>
<div class="sect3">
<h4 id="proc-configuring-kafka-connect-user-authorization-str"><a class="link" href="#proc-configuring-kafka-connect-user-authorization-str">9.6.2. Configuring Kafka Connect user authorization</a></h4>
<div class="paragraph _abstract">
<p>When using authorization in Kafka, a Kafka Connect user requires read/write access to the cluster group and internal topics of Kafka Connect.
This procedure outlines how access is granted using <code>simple</code> authorization and ACLs.</p>
</div>
<div class="paragraph">
<p>Properties for the Kafka Connect cluster group ID and internal topics are configured by Strimzi by default.
Alternatively, you can define them explicitly in the <code>spec</code> of the <code>KafkaConnect</code> resource.
This is useful when <a href="#con-config-kafka-connect-multiple-instances-str">configuring Kafka Connect for multiple instances</a>, as the values for the group ID and topics must differ when running multiple Kafka Connect instances.</p>
</div>
<div class="paragraph">
<p>Simple authorization uses ACL rules managed by the Kafka <code>AclAuthorizer</code> and <code>StandardAuthorizer</code> plugins to ensure appropriate access levels.
For more information on configuring a <code>KafkaUser</code> resource to use simple authorization, see the <a href="./configuring.html#type-AclRule-reference" target="_blank" rel="noopener"><code>AclRule</code> schema reference</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kubernetes cluster</p>
</li>
<li>
<p>A running Cluster Operator</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <code>authorization</code> property in the <code>KafkaUser</code> resource to provide access rights to the user.</p>
<div class="paragraph">
<p>Access rights are configured for the Kafka Connect topics and cluster group using <code>literal</code> name values.
The following table shows the default names configured for the topics and cluster group ID.</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 10. Names for the access rights configuration</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>offset.storage.topic</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>connect-cluster-offsets</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>status.storage.topic</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>connect-cluster-status</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>config.storage.topic</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>connect-cluster-configs</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>group</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>connect-cluster</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In this example configuration, the default names are used to specify access rights.
If you are using different names for a Kafka Connect instance, use those names in the ACLs configuration.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration for simple authorization</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster
spec:
  # ...
  authorization:
    type: simple
    acls:
      # access to offset.storage.topic
      - resource:
          type: topic
          name: connect-cluster-offsets
          patternType: literal
        operations:
          - Create
          - Describe
          - Read
          - Write
        host: "*"
      # access to status.storage.topic
      - resource:
          type: topic
          name: connect-cluster-status
          patternType: literal
        operations:
          - Create
          - Describe
          - Read
          - Write
        host: "*"
      # access to config.storage.topic
      - resource:
          type: topic
          name: connect-cluster-configs
          patternType: literal
        operations:
          - Create
          - Describe
          - Read
          - Write
        host: "*"
      # cluster group
      - resource:
          type: group
          name: connect-cluster
          patternType: literal
        operations:
          - Read
        host: "*"</code></pre>
</div>
</div>
</li>
<li>
<p>Create or update the resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>KAFKA-USER-CONFIG-FILE</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-manual-stop-pause-connector-str"><a class="link" href="#proc-manual-stop-pause-connector-str">9.6.3. Manually stopping or pausing Kafka Connect connectors</a></h4>
<div class="paragraph _abstract">
<p>If you are using <code>KafkaConnector</code> resources to configure connectors, use the <code>state</code> configuration to either stop or pause a connector.
In contrast to the paused state, where the connector and tasks remain instantiated, stopping a connector retains only the configuration, with no active processes.
Stopping a connector from running may be more suitable for longer durations than just pausing.
While a paused connector is quicker to resume, a stopped connector has the advantages of freeing up memory and resources.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>state</code> configuration replaces the (deprecated) <code>pause</code> configuration in the <code>KafkaConnectorSpec</code> schema, which allows pauses on connectors.
If you were previously using the <code>pause</code> configuration to pause connectors, we encourage you to transition to using the <code>state</code> configuration only to avoid conflicts.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is running.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Find the name of the <code>KafkaConnector</code> custom resource that controls the connector you want to pause or stop:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get KafkaConnector</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>KafkaConnector</code> resource to stop or pause the connector.</p>
<div class="listingblock">
<div class="title">Example configuration for stopping a Kafka Connect connector</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: my-source-connector
  labels:
    strimzi.io/cluster: my-connect-cluster
spec:
  class: org.apache.kafka.connect.file.FileStreamSourceConnector
  tasksMax: 2
  config:
    file: "/opt/kafka/LICENSE"
    topic: my-topic
  state: stopped
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Change the <code>state</code> configuration to <code>stopped</code> or <code>paused</code>.
The default state for the connector when this property is not set is <code>running</code>.</p>
</div>
</li>
<li>
<p>Apply the changes to the <code>KafkaConnector</code> configuration.</p>
<div class="paragraph">
<p>You can resume the connector by changing <code>state</code> to <code>running</code> or removing the configuration.</p>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Alternatively, you can <a href="#con-exposing-kafka-connect-api-str">expose the Kafka Connect API</a> and use the <code>stop</code> and <code>pause</code> endpoints to stop a connector from running.
For example, <code>PUT /connectors/&lt;connector_name&gt;/stop</code>.
You can then use the <code>resume</code> endpoint to restart it.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="proc-manual-restart-connector-str"><a class="link" href="#proc-manual-restart-connector-str">9.6.4. Manually restarting Kafka Connect connectors</a></h4>
<div class="paragraph _abstract">
<p>If you are using <code>KafkaConnector</code> resources to manage connectors, use the <code>strimzi.io/restart</code> annotation to manually trigger a restart of a connector.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is running.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Find the name of the <code>KafkaConnector</code> custom resource that controls the Kafka connector you want to restart:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get KafkaConnector</code></pre>
</div>
</div>
</li>
<li>
<p>Restart the connector by annotating the <code>KafkaConnector</code> resource in Kubernetes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate KafkaConnector &lt;kafka_connector_name&gt; strimzi.io/restart=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>restart</code> annotation is set to <code>true</code>.</p>
</div>
</li>
<li>
<p>Wait for the next reconciliation to occur (every two minutes by default).</p>
<div class="paragraph">
<p>The Kafka connector is restarted, as long as the annotation was detected by the reconciliation process.
When Kafka Connect accepts the restart request, the annotation is removed from the <code>KafkaConnector</code> custom resource.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-manual-restart-connector-task-str"><a class="link" href="#proc-manual-restart-connector-task-str">9.6.5. Manually restarting Kafka Connect connector tasks</a></h4>
<div class="paragraph _abstract">
<p>If you are using <code>KafkaConnector</code> resources to manage connectors, use the <code>strimzi.io/restart-task</code> annotation to manually trigger a restart of a connector task.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is running.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Find the name of the <code>KafkaConnector</code> custom resource that controls the Kafka connector task you want to restart:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get KafkaConnector</code></pre>
</div>
</div>
</li>
<li>
<p>Find the ID of the task to be restarted from the <code>KafkaConnector</code> custom resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl describe KafkaConnector &lt;kafka_connector_name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Task IDs are non-negative integers, starting from 0.</p>
</div>
</li>
<li>
<p>Use the ID to restart the connector task by annotating the <code>KafkaConnector</code> resource in Kubernetes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate KafkaConnector &lt;kafka_connector_name&gt; strimzi.io/restart-task=0</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, task <code>0</code> is restarted.</p>
</div>
</li>
<li>
<p>Wait for the next reconciliation to occur (every two minutes by default).</p>
<div class="paragraph">
<p>The Kafka connector task is restarted, as long as the annotation was detected by the reconciliation process.
When Kafka Connect accepts the restart request, the annotation is removed from the <code>KafkaConnector</code> custom resource.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-config-mirrormaker2-str"><a class="link" href="#con-config-mirrormaker2-str">9.7. Configuring Kafka MirrorMaker 2</a></h3>
<div class="paragraph _abstract">
<p>Update the <code>spec</code> properties of the <code>KafkaMirrorMaker2</code> custom resource to configure your MirrorMaker 2 deployment.
MirrorMaker 2 uses source cluster configuration for data consumption and target cluster configuration for data output.</p>
</div>
<div class="paragraph">
<p>MirrorMaker 2 is based on the Kafka Connect framework, <em>connectors</em> managing the transfer of data between clusters.</p>
</div>
<div class="paragraph">
<p>You configure MirrorMaker 2 to define the Kafka Connect deployment, including the connection details of the source and target clusters, and then run a set of MirrorMaker 2 connectors to make the connection.</p>
</div>
<div class="paragraph">
<p>MirrorMaker 2 supports topic configuration synchronization between the source and target clusters.
You specify source topics in the MirrorMaker 2 configuration.
MirrorMaker 2 monitors the source topics.
MirrorMaker 2 detects and propagates changes to the source topics to the remote topics.
Changes might include automatically creating missing topics and partitions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In most cases you write to local topics and read from remote topics. Though write operations are not prevented on remote topics, they should be avoided.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The configuration must specify:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each Kafka cluster</p>
</li>
<li>
<p>Connection information for each cluster, including authentication</p>
</li>
<li>
<p>The replication flow and direction</p>
<div class="ulist">
<ul>
<li>
<p>Cluster to cluster</p>
</li>
<li>
<p>Topic to topic</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For a deeper understanding of the Kafka MirrorMaker 2 cluster configuration options, refer to the <a href="./configuring.html" target="_blank" rel="noopener">Strimzi Custom Resource API Reference</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
MirrorMaker 2 resource configuration differs from the previous version of MirrorMaker, which is now deprecated.
There is currently no legacy support, so any resources must be manually converted into the new format.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Default configuration</div>
<p>MirrorMaker 2 provides default configuration values for properties such as replication factors.
A minimal configuration, with defaults left unchanged, would be something like this example:</p>
</div>
<div class="listingblock">
<div class="title">Minimal configuration for MirrorMaker 2</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker2
metadata:
  name: my-mirror-maker2
spec:
  version: 3.6.1
  connectCluster: "my-cluster-target"
  clusters:
  - alias: "my-cluster-source"
    bootstrapServers: my-cluster-source-kafka-bootstrap:9092
  - alias: "my-cluster-target"
    bootstrapServers: my-cluster-target-kafka-bootstrap:9092
  mirrors:
  - sourceCluster: "my-cluster-source"
    targetCluster: "my-cluster-target"
    sourceConnector: {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can configure access control for source and target clusters using mTLS or SASL authentication.
This procedure shows a configuration that uses TLS encryption and mTLS authentication for the source and target cluster.</p>
</div>
<div class="paragraph">
<p>You can specify the topics and consumer groups you wish to replicate from a source cluster in the <code>KafkaMirrorMaker2</code> resource.
You use the <code>topicsPattern</code> and <code>groupsPattern</code> properties to do this.
You can provide a list of names or use a regular expression.
By default, all topics and consumer groups are replicated if you do not set the <code>topicsPattern</code> and <code>groupsPattern</code> properties.
You can also replicate all topics and consumer groups by using <code>".*"</code> as a regular expression.
However, try to specify only the topics and consumer groups you need to avoid causing any unnecessary extra load on the cluster.</p>
</div>
<div class="paragraph">
<div class="title">Handling high volumes of messages</div>
<p>You can tune the configuration to handle high volumes of messages.
For more information, see <a href="#con-high-volume-config-properties-str">Handling high volumes of messages</a>.</p>
</div>
<div class="listingblock">
<div class="title">Example <code>KafkaMirrorMaker2</code> custom resource configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker2
metadata:
  name: my-mirror-maker2
spec:
  version: 3.6.1 # <b class="conum">(1)</b>
  replicas: 3 # <b class="conum">(2)</b>
  connectCluster: "my-cluster-target" # <b class="conum">(3)</b>
  clusters: # <b class="conum">(4)</b>
  - alias: "my-cluster-source" # <b class="conum">(5)</b>
    authentication: # <b class="conum">(6)</b>
      certificateAndKey:
        certificate: source.crt
        key: source.key
        secretName: my-user-source
      type: tls
    bootstrapServers: my-cluster-source-kafka-bootstrap:9092 # <b class="conum">(7)</b>
    tls: # <b class="conum">(8)</b>
      trustedCertificates:
      - certificate: ca.crt
        secretName: my-cluster-source-cluster-ca-cert
  - alias: "my-cluster-target" # <b class="conum">(9)</b>
    authentication: # <b class="conum">(10)</b>
      certificateAndKey:
        certificate: target.crt
        key: target.key
        secretName: my-user-target
      type: tls
    bootstrapServers: my-cluster-target-kafka-bootstrap:9092 # <b class="conum">(11)</b>
    config: # <b class="conum">(12)</b>
      config.storage.replication.factor: 1
      offset.storage.replication.factor: 1
      status.storage.replication.factor: 1
    tls: # <b class="conum">(13)</b>
      trustedCertificates:
      - certificate: ca.crt
        secretName: my-cluster-target-cluster-ca-cert
  mirrors: # <b class="conum">(14)</b>
  - sourceCluster: "my-cluster-source" # <b class="conum">(15)</b>
    targetCluster: "my-cluster-target" # <b class="conum">(16)</b>
    sourceConnector: # <b class="conum">(17)</b>
      tasksMax: 10 # <b class="conum">(18)</b>
      autoRestart: # <b class="conum">(19)</b>
        enabled: true
      config
        replication.factor: 1 # <b class="conum">(20)</b>
        offset-syncs.topic.replication.factor: 1 # <b class="conum">(21)</b>
        sync.topic.acls.enabled: "false" # <b class="conum">(22)</b>
        refresh.topics.interval.seconds: 60 # <b class="conum">(23)</b>
        replication.policy.class: "org.apache.kafka.connect.mirror.IdentityReplicationPolicy" # <b class="conum">(24)</b>
    heartbeatConnector: # <b class="conum">(25)</b>
      autoRestart:
        enabled: true
      config:
        heartbeats.topic.replication.factor: 1 # <b class="conum">(26)</b>
        replication.policy.class: "org.apache.kafka.connect.mirror.IdentityReplicationPolicy"
    checkpointConnector: # <b class="conum">(27)</b>
      autoRestart:
        enabled: true
      config:
        checkpoints.topic.replication.factor: 1 # <b class="conum">(28)</b>
        refresh.groups.interval.seconds: 600 # <b class="conum">(29)</b>
        sync.group.offsets.enabled: true # <b class="conum">(30)</b>
        sync.group.offsets.interval.seconds: 60 # <b class="conum">(31)</b>
        emit.checkpoints.interval.seconds: 60 # <b class="conum">(32)</b>
        replication.policy.class: "org.apache.kafka.connect.mirror.IdentityReplicationPolicy"
    topicsPattern: "topic1|topic2|topic3" # <b class="conum">(33)</b>
    groupsPattern: "group1|group2|group3" # <b class="conum">(34)</b>
  resources: # <b class="conum">(35)</b>
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "2"
      memory: 2Gi
  logging: # <b class="conum">(36)</b>
    type: inline
    loggers:
      connect.root.logger.level: INFO
  readinessProbe: # <b class="conum">(37)</b>
    initialDelaySeconds: 15
    timeoutSeconds: 5
  livenessProbe:
    initialDelaySeconds: 15
    timeoutSeconds: 5
  jvmOptions: # <b class="conum">(38)</b>
    "-Xmx": "1g"
    "-Xms": "1g"
  image: my-org/my-image:latest # <b class="conum">(39)</b>
  rack:
    topologyKey: topology.kubernetes.io/zone # <b class="conum">(40)</b>
  template: # <b class="conum">(41)</b>
    pod:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: application
                    operator: In
                    values:
                      - postgresql
                      - mongodb
              topologyKey: "kubernetes.io/hostname"
    connectContainer: # <b class="conum">(42)</b>
      env:
        - name: OTEL_SERVICE_NAME
          value: my-otel-service
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "http://otlp-host:4317"
  tracing:
    type: opentelemetry # <b class="conum">(43)</b>
  externalConfiguration: # <b class="conum">(44)</b>
    env:
      - name: AWS_ACCESS_KEY_ID
        valueFrom:
          secretKeyRef:
            name: aws-creds
            key: awsAccessKey
      - name: AWS_SECRET_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: aws-creds
            key: awsSecretAccessKey</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Kafka Connect and MirrorMaker 2 version, which will always be the same.</p>
</li>
<li>
<p>The number of replica nodes for the workers that run tasks.</p>
</li>
<li>
<p>Kafka cluster alias for Kafka Connect, which must specify the <strong>target</strong> Kafka cluster. The Kafka cluster is used by Kafka Connect for its internal topics.</p>
</li>
<li>
<p>Specification for the Kafka clusters being synchronized.</p>
</li>
<li>
<p>Cluster alias for the source Kafka cluster.</p>
</li>
<li>
<p>Authentication for the source cluster, specified as mTLS, token-based OAuth, SASL-based SCRAM-SHA-256/SCRAM-SHA-512, or PLAIN.</p>
</li>
<li>
<p>Bootstrap server for connection to the source Kafka cluster.</p>
</li>
<li>
<p>TLS encryption with key names under which TLS certificates are stored in X.509 format for the source Kafka cluster. If certificates are stored in the same secret, it can be listed multiple times.</p>
</li>
<li>
<p>Cluster alias for the target Kafka cluster.</p>
</li>
<li>
<p>Authentication for the target Kafka cluster is configured in the same way as for the source Kafka cluster.</p>
</li>
<li>
<p>Bootstrap server for connection to the target Kafka cluster.</p>
</li>
<li>
<p>Kafka Connect configuration.
Standard Apache Kafka configuration may be provided, restricted to those properties not managed directly by Strimzi.</p>
</li>
<li>
<p>TLS encryption for the target Kafka cluster is configured in the same way as for the source Kafka cluster.</p>
</li>
<li>
<p>MirrorMaker 2 connectors.</p>
</li>
<li>
<p>Cluster alias for the source cluster used by the MirrorMaker 2 connectors.</p>
</li>
<li>
<p>Cluster alias for the target cluster used by the MirrorMaker 2 connectors.</p>
</li>
<li>
<p>Configuration for the <code>MirrorSourceConnector</code> that creates remote topics. The <code>config</code> overrides the default configuration options.</p>
</li>
<li>
<p>The maximum number of tasks that the connector may create. Tasks handle the data replication and run in parallel. If the infrastructure supports the processing overhead, increasing this value can improve throughput. Kafka Connect distributes the tasks between members of the cluster. If there are more tasks than workers, workers are assigned multiple tasks. For sink connectors, aim to have one task for each topic partition consumed. For source connectors, the number of tasks that can run in parallel may also depend on the external system. The connector creates fewer than the maximum number of tasks if it cannot achieve the parallelism.</p>
</li>
<li>
<p>Enables automatic restarts of failed connectors and tasks. By default, the number of restarts is indefinite, but you can set a maximum on the number of automatic restarts using the <code>maxRestarts</code> property.</p>
</li>
<li>
<p>Replication factor for mirrored topics created at the target cluster.</p>
</li>
<li>
<p>Replication factor for the <code>MirrorSourceConnector</code> <code>offset-syncs</code> internal topic that maps the offsets of the source and target clusters.</p>
</li>
<li>
<p>When ACL rules synchronization is enabled, ACLs are applied to synchronized topics. The default is <code>true</code>. This feature is not compatible with the User Operator. If you are using the User Operator, set this property to <code>false</code>.</p>
</li>
<li>
<p>Optional setting to change the frequency of checks for new topics. The default is for a check every 10 minutes.</p>
</li>
<li>
<p>Adds a policy that overrides the automatic renaming of remote topics. Instead of prepending the name with the name of the source cluster, the topic retains its original name. This optional setting is useful for active/passive backups and data migration. The property must be specified for all connectors. For bidirectional (active/active) replication, use the <code>DefaultReplicationPolicy</code> class to automatically rename remote topics and specify the <code>replication.policy.separator</code> property for all connectors to add a custom separator.</p>
</li>
<li>
<p>Configuration for the <code>MirrorHeartbeatConnector</code> that performs connectivity checks. The <code>config</code> overrides the default configuration options.</p>
</li>
<li>
<p>Replication factor for the heartbeat topic created at the target cluster.</p>
</li>
<li>
<p>Configuration for the <code>MirrorCheckpointConnector</code> that tracks offsets. The <code>config</code> overrides the default configuration options.</p>
</li>
<li>
<p>Replication factor for the checkpoints topic created at the target cluster.</p>
</li>
<li>
<p>Optional setting to change the frequency of checks for new consumer groups. The default is for a check every 10 minutes.</p>
</li>
<li>
<p>Optional setting to synchronize consumer group offsets, which is useful for recovery in an active/passive configuration. Synchronization is not enabled by default.</p>
</li>
<li>
<p>If the synchronization of consumer group offsets is enabled, you can adjust the frequency of the synchronization.</p>
</li>
<li>
<p>Adjusts the frequency of checks for offset tracking. If you change the frequency of offset synchronization, you might also need to adjust the frequency of these checks.</p>
</li>
<li>
<p>Topic replication from the source cluster defined as a comma-separated list or regular expression pattern. The source connector replicates the specified topics. The checkpoint connector tracks offsets for the specified topics. Here we request three topics by name.</p>
</li>
<li>
<p>Consumer group replication from the source cluster defined as a comma-separated list or regular expression pattern. The checkpoint connector replicates the specified consumer groups. Here we request three consumer groups by name.</p>
</li>
<li>
<p>Requests for reservation of supported resources, currently <code>cpu</code> and <code>memory</code>, and limits to specify the maximum resources that can be consumed.</p>
</li>
<li>
<p>Specified Kafka Connect loggers and log levels added directly (<code>inline</code>) or indirectly (<code>external</code>) through a ConfigMap. A custom Log4j configuration must be placed under the <code>log4j.properties</code> or <code>log4j2.properties</code> key in the ConfigMap. For the Kafka Connect <code>log4j.rootLogger</code> logger, you can set the log level to INFO, ERROR, WARN, TRACE, DEBUG, FATAL or OFF.</p>
</li>
<li>
<p>Healthchecks to know when to restart a container (liveness) and when a container can accept traffic (readiness).</p>
</li>
<li>
<p>JVM configuration options to optimize performance for the Virtual Machine (VM) running Kafka MirrorMaker.</p>
</li>
<li>
<p>ADVANCED OPTION: Container image configuration, which is recommended only in special situations.</p>
</li>
<li>
<p>SPECIALIZED OPTION: Rack awareness configuration for the deployment. This is a specialized option intended for a deployment within the same location, not across regions. Use this option if you want connectors to consume from the closest replica rather than the leader replica. In certain cases, consuming from the closest replica can improve network utilization or reduce costs . The <code>topologyKey</code> must match a node label containing the rack ID. The example used in this configuration specifies a zone using the standard <code><a href="https://kubernetes.io/docs/reference/labels-annotations-taints/#topologykubernetesiozone" target="_blank" rel="noopener">topology.kubernetes.io/zone</a></code> label. To consume from the closest replica, enable the <code>RackAwareReplicaSelector</code>  in the Kafka broker configuration.</p>
</li>
<li>
<p>Template customization. Here a pod is scheduled with anti-affinity, so the pod is not scheduled on nodes with the same hostname.</p>
</li>
<li>
<p>Environment variables are set for distributed tracing.</p>
</li>
<li>
<p>Distributed tracing is enabled by using OpenTelemetry.</p>
</li>
<li>
<p>External configuration for a Kubernetes Secret mounted to Kafka MirrorMaker as an environment variable.
You can also use configuration provider plugins to load configuration values from external sources.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="con-overview-mm2-str"><a class="link" href="#con-overview-mm2-str">9.7.1. Configuring active/active or active/passive modes</a></h4>
<div class="paragraph _abstract">
<p>You can use MirrorMaker 2 in <em>active/passive</em> or <em>active/active</em> cluster configurations.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">active/active cluster configuration</dt>
<dd>
<p>An active/active configuration has two active clusters replicating data bidirectionally. Applications can use either cluster. Each cluster can provide the same data. In this way,  you can make the same data available in different geographical locations. As consumer groups are active in both clusters, consumer offsets for replicated topics are not synchronized back to the source cluster.</p>
</dd>
<dt class="hdlist1">active/passive cluster configuration</dt>
<dd>
<p>An active/passive configuration has an active cluster replicating data to a passive cluster. The passive cluster remains on standby. You might use the passive cluster for data recovery in the event of system failure.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The expectation is that producers and consumers connect to active clusters only.
A MirrorMaker 2 cluster is required at each target destination.</p>
</div>
<div class="sect4">
<h5 id="bidirectional_replication_activeactive"><a class="link" href="#bidirectional_replication_activeactive">Bidirectional replication (active/active)</a></h5>
<div class="paragraph">
<p>The MirrorMaker 2 architecture supports bidirectional replication in an <em>active/active</em> cluster configuration.</p>
</div>
<div class="paragraph">
<p>Each cluster replicates the data of the other cluster using the concept of <em>source</em> and <em>remote</em> topics.
As the same topics are stored in each cluster, remote topics are automatically renamed by MirrorMaker 2 to represent the source cluster.
The name of the originating cluster is prepended to the name of the topic.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/mirrormaker-renaming.png" alt="MirrorMaker 2 bidirectional architecture">
</div>
<div class="title">Figure 1. Topic renaming</div>
</div>
<div class="paragraph">
<p>By flagging the originating cluster, topics are not replicated back to that cluster.</p>
</div>
<div class="paragraph">
<p>The concept of replication through <em>remote</em> topics is useful when configuring an architecture that requires data aggregation.
Consumers can subscribe to source and remote topics within the same cluster, without the need for a separate aggregation cluster.</p>
</div>
</div>
<div class="sect4">
<h5 id="unidirectional_replication_activepassive"><a class="link" href="#unidirectional_replication_activepassive">Unidirectional replication (active/passive)</a></h5>
<div class="paragraph">
<p>The MirrorMaker 2 architecture supports unidirectional replication in an <em>active/passive</em> cluster configuration.</p>
</div>
<div class="paragraph">
<p>You can use an <em>active/passive</em> cluster configuration to make backups or migrate data to another cluster.
In this situation, you might not want automatic renaming of remote topics.</p>
</div>
<div class="paragraph">
<p>You can override automatic renaming by adding <code>IdentityReplicationPolicy</code> to the source connector configuration.
With this configuration applied, topics retain their original names.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="con-config-mm2-multiple-instances-str"><a class="link" href="#con-config-mm2-multiple-instances-str">9.7.2. Configuring MirrorMaker 2 for multiple instances</a></h4>
<div class="paragraph _abstract">
<p>By default, Strimzi configures the group ID and names of the internal topics used by the Kafka Connect framework that MirrorMaker 2 runs on.
When running multiple instances of MirrorMaker 2, and they share the same <code>connectCluster</code> value, you must change these default settings using the following <code>config</code> properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker2
metadata:
  name: my-mirror-maker2
spec:
  connectCluster: "my-cluster-target"
  clusters:
  - alias: "my-cluster-target"
    config:
      group.id: my-connect-cluster # <b class="conum">(1)</b>
      offset.storage.topic: my-connect-cluster-offsets # <b class="conum">(2)</b>
      config.storage.topic: my-connect-cluster-configs # <b class="conum">(3)</b>
      status.storage.topic: my-connect-cluster-status # <b class="conum">(4)</b>
      # ...
    # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Kafka Connect cluster group ID within Kafka.</p>
</li>
<li>
<p>Kafka topic that stores connector offsets.</p>
</li>
<li>
<p>Kafka topic that stores connector and task status configurations.</p>
</li>
<li>
<p>Kafka topic that stores connector and task status updates.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Values for the three topics must be the same for all instances with the same <code>group.id</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>connectCluster</code> setting specifies the alias of the target Kafka cluster used by Kafka Connect for its internal topics.
As a result, modifications to the <code>connectCluster</code>, group ID, and internal topic naming configuration are specific to the target Kafka cluster.
You don&#8217;t need to make changes if two MirrorMaker 2 instances are using the same source Kafka cluster or in an active-active mode where each MirrorMaker 2 instance has a different <code>connectCluster</code> setting and target cluster.</p>
</div>
<div class="paragraph">
<p>However, if multiple MirrorMaker 2 instances share the same <code>connectCluster</code>, each instance connecting to the same target Kafka cluster is deployed with the same values.
In practice, this means all instances form a cluster and use the same internal topics.</p>
</div>
<div class="paragraph">
<p>Multiple instances attempting to use the same internal topics will cause unexpected errors, so you must change the values of these properties for each instance.</p>
</div>
</div>
<div class="sect3">
<h4 id="con-config-mirrormaker2-connectors-str"><a class="link" href="#con-config-mirrormaker2-connectors-str">9.7.3. Configuring MirrorMaker 2 connectors</a></h4>
<div class="paragraph _abstract">
<p>Use MirrorMaker 2 connector configuration for the internal connectors that orchestrate the synchronization of data between Kafka clusters.</p>
</div>
<div class="paragraph">
<p>MirrorMaker 2 consists of the following connectors:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>MirrorSourceConnector</code></dt>
<dd>
<p>The source connector replicates topics from a source cluster to a target cluster. It also replicates ACLs and is necessary for the <code>MirrorCheckpointConnector</code> to run.</p>
</dd>
<dt class="hdlist1"><code>MirrorCheckpointConnector</code></dt>
<dd>
<p>The checkpoint connector periodically tracks offsets. If enabled, it also synchronizes consumer group offsets between the source and target cluster.</p>
</dd>
<dt class="hdlist1"><code>MirrorHeartbeatConnector</code></dt>
<dd>
<p>The heartbeat connector periodically checks connectivity between the source and target cluster.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The following table describes connector properties and the connectors you configure to use them.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. MirrorMaker 2 connector configuration properties</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">sourceConnector</th>
<th class="tableblock halign-left valign-top">checkpointConnector</th>
<th class="tableblock halign-left valign-top">heartbeatConnector</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">admin.timeout.ms</dt>
<dd>
<p>Timeout for admin tasks, such as detecting new topics. Default is <code>60000</code> (1 minute).</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">replication.policy.class</dt>
<dd>
<p>Policy to define the remote topic naming convention. Default is <code>org.apache.kafka.connect.mirror.DefaultReplicationPolicy</code>.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">replication.policy.separator</dt>
<dd>
<p>The separator used for topic naming in the target cluster. By default, the separator is set to a dot (.).
Separator configuration is only applicable to the <code>DefaultReplicationPolicy</code> replication policy class, which defines remote topic names.
The <code>IdentityReplicationPolicy</code> class does not use the property as topics retain their original names.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">consumer.poll.timeout.ms</dt>
<dd>
<p>Timeout when polling the source cluster. Default is <code>1000</code> (1 second).</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">offset-syncs.topic.location</dt>
<dd>
<p>The location of the <code>offset-syncs</code> topic, which can be the <code>source</code> (default) or <code>target</code> cluster.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">topic.filter.class</dt>
<dd>
<p>Topic filter to select the topics to replicate. Default is <code>org.apache.kafka.connect.mirror.DefaultTopicFilter</code>.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">config.property.filter.class</dt>
<dd>
<p>Topic filter to select the topic configuration properties to replicate. Default is <code>org.apache.kafka.connect.mirror.DefaultConfigPropertyFilter</code>.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">config.properties.exclude</dt>
<dd>
<p>Topic configuration properties that should not be replicated. Supports comma-separated property names and regular expressions.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">offset.lag.max</dt>
<dd>
<p>Maximum allowable (out-of-sync) offset lag before a remote partition is synchronized. Default is <code>100</code>.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">offset-syncs.topic.replication.factor</dt>
<dd>
<p>Replication factor for the internal <code>offset-syncs</code> topic. Default is <code>3</code>.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">refresh.topics.enabled</dt>
<dd>
<p>Enables check for new topics and partitions. Default is <code>true</code>.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">refresh.topics.interval.seconds</dt>
<dd>
<p>Frequency of topic refresh. Default is <code>600</code> (10 minutes). By default, a check for new topics in the source cluster is made every 10 minutes.
You can change the frequency by adding <code>refresh.topics.interval.seconds</code> to the source connector configuration.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">replication.factor</dt>
<dd>
<p>The replication factor for new topics. Default is <code>2</code>.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">sync.topic.acls.enabled</dt>
<dd>
<p>Enables synchronization of ACLs from the source cluster. Default is <code>true</code>. For more information, see <a href="#con-mirrormaker-acls-str">Synchronizing ACL rules for remote topics</a>.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">sync.topic.acls.interval.seconds</dt>
<dd>
<p>Frequency of ACL synchronization. Default is <code>600</code> (10 minutes).</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">sync.topic.configs.enabled</dt>
<dd>
<p>Enables synchronization of topic configuration from the source cluster. Default is <code>true</code>.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">sync.topic.configs.interval.seconds</dt>
<dd>
<p>Frequency of topic configuration synchronization. Default <code>600</code> (10 minutes).</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">checkpoints.topic.replication.factor</dt>
<dd>
<p>Replication factor for the internal <code>checkpoints</code> topic. Default is <code>3</code>.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">emit.checkpoints.enabled</dt>
<dd>
<p>Enables synchronization of consumer offsets to the target cluster. Default is <code>true</code>.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">emit.checkpoints.interval.seconds</dt>
<dd>
<p>Frequency of consumer offset synchronization. Default is <code>60</code> (1 minute).</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">group.filter.class</dt>
<dd>
<p>Group filter to select the consumer groups to replicate. Default is <code>org.apache.kafka.connect.mirror.DefaultGroupFilter</code>.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">refresh.groups.enabled</dt>
<dd>
<p>Enables check for new consumer groups. Default is <code>true</code>.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">refresh.groups.interval.seconds</dt>
<dd>
<p>Frequency of consumer group refresh. Default is <code>600</code> (10 minutes).</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">sync.group.offsets.enabled</dt>
<dd>
<p>Enables synchronization of consumer group offsets to the target cluster <code>__consumer_offsets</code> topic. Default is <code>false</code>.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">sync.group.offsets.interval.seconds</dt>
<dd>
<p>Frequency of consumer group offset synchronization. Default is <code>60</code> (1 minute).</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">emit.heartbeats.enabled</dt>
<dd>
<p>Enables connectivity checks on the target cluster. Default is <code>true</code>.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">emit.heartbeats.interval.seconds</dt>
<dd>
<p>Frequency of connectivity checks. Default is <code>1</code> (1 second).</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="dlist">
<dl>
<dt class="hdlist1">heartbeats.topic.replication.factor</dt>
<dd>
<p>Replication factor for the internal <code>heartbeats</code> topic. Default is <code>3</code>.</p>
</dd>
</dl>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">✓</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="changing_the_location_of_the_consumer_group_offsets_topic"><a class="link" href="#changing_the_location_of_the_consumer_group_offsets_topic">Changing the location of the consumer group offsets topic</a></h5>
<div class="paragraph">
<p>MirrorMaker 2 tracks offsets for consumer groups using internal topics.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>offset-syncs</code> topic</dt>
<dd>
<p>The <code>offset-syncs</code> topic maps the source and target offsets for replicated topic partitions from record metadata.</p>
</dd>
<dt class="hdlist1"><code>checkpoints</code> topic</dt>
<dd>
<p>The <code>checkpoints</code> topic maps the last committed offset in the source and target cluster for replicated topic partitions in each consumer group.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>As they are used internally by MirrorMaker 2, you do not interact directly with these topics.</p>
</div>
<div class="paragraph">
<p><code>MirrorCheckpointConnector</code> emits <em>checkpoints</em> for offset tracking.
Offsets for the <code>checkpoints</code> topic are tracked at predetermined intervals through configuration.
Both topics enable replication to be fully restored from the correct offset position on failover.</p>
</div>
<div class="paragraph">
<p>The location of the <code>offset-syncs</code> topic is the <code>source</code> cluster by default.
You can use the <code>offset-syncs.topic.location</code> connector configuration to change this to the <code>target</code> cluster.
You need read/write access to the cluster that contains the topic.
Using the target cluster as the location of the <code>offset-syncs</code> topic allows you to use MirrorMaker 2 even if you have only read access to the source cluster.</p>
</div>
</div>
<div class="sect4">
<h5 id="synchronizing_consumer_group_offsets"><a class="link" href="#synchronizing_consumer_group_offsets">Synchronizing consumer group offsets</a></h5>
<div class="paragraph">
<p>The <code>__consumer_offsets</code> topic stores information on committed offsets for each consumer group.
Offset synchronization periodically transfers the consumer offsets for the consumer groups of a source cluster into the consumer offsets topic of a target cluster.</p>
</div>
<div class="paragraph">
<p>Offset synchronization is particularly useful in an <em>active/passive</em> configuration.
If the active cluster goes down, consumer applications can switch to the passive (standby) cluster and pick up from the last transferred offset position.</p>
</div>
<div class="paragraph">
<p>To use topic offset synchronization, enable the synchronization by adding <code>sync.group.offsets.enabled</code> to the checkpoint connector configuration, and setting the property to <code>true</code>.
Synchronization is disabled by default.</p>
</div>
<div class="paragraph">
<p>When using the <code>IdentityReplicationPolicy</code> in the source connector, it also has to be configured in the checkpoint connector configuration.
This ensures that the mirrored consumer offsets will be applied for the correct topics.</p>
</div>
<div class="paragraph">
<p>Consumer offsets are only synchronized for consumer groups that are not active in the target cluster.
If the consumer groups are in the target cluster, the synchronization cannot be performed and an <code>UNKNOWN_MEMBER_ID</code> error is returned.</p>
</div>
<div class="paragraph">
<p>If enabled, the synchronization of offsets from the source cluster is made periodically.
You can change the frequency by adding <code>sync.group.offsets.interval.seconds</code> and <code>emit.checkpoints.interval.seconds</code> to the checkpoint connector configuration.
The properties specify the frequency in seconds that the consumer group offsets are synchronized, and the frequency of checkpoints emitted for offset tracking.
The default for both properties is 60 seconds.
You can also change the frequency of checks for new consumer groups using the <code>refresh.groups.interval.seconds</code> property, which is performed every 10 minutes by default.</p>
</div>
<div class="paragraph">
<p>Because the synchronization is time-based, any switchover by consumers to a passive cluster will likely result in some duplication of messages.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you have an application written in Java, you can use the <code>RemoteClusterUtils.java</code> utility to synchronize offsets through the application. The utility fetches remote offsets for a consumer group from the <code>checkpoints</code> topic.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="deciding_when_to_use_the_heartbeat_connector"><a class="link" href="#deciding_when_to_use_the_heartbeat_connector">Deciding when to use the heartbeat connector</a></h5>
<div class="paragraph">
<p>The heartbeat connector emits heartbeats to check connectivity between source and target Kafka clusters.
An internal <code>heartbeat</code> topic is replicated from the source cluster, which means that the heartbeat connector must be connected to the source cluster.
The <code>heartbeat</code> topic is located on the target cluster, which allows it to do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Identify all source clusters it is mirroring data from</p>
</li>
<li>
<p>Verify the liveness and latency of the mirroring process</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This helps to make sure that the process is not stuck or has stopped for any reason.
While the heartbeat connector can be a valuable tool for monitoring the mirroring processes between Kafka clusters, it&#8217;s not always necessary to use it.
For example, if your deployment has low network latency or a small number of topics, you might prefer to monitor the mirroring process using log messages or other monitoring tools.
If you decide not to use the heartbeat connector, simply omit it from your MirrorMaker 2 configuration.</p>
</div>
</div>
<div class="sect4">
<h5 id="aligning_the_configuration_of_mirrormaker_2_connectors"><a class="link" href="#aligning_the_configuration_of_mirrormaker_2_connectors">Aligning the configuration of MirrorMaker 2 connectors</a></h5>
<div class="paragraph">
<p>To ensure that MirrorMaker 2 connectors work properly, make sure to align certain configuration settings across connectors.
Specifically, ensure that the following properties have the same value across all applicable connectors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>replication.policy.class</code></p>
</li>
<li>
<p><code>replication.policy.separator</code></p>
</li>
<li>
<p><code>offset-syncs.topic.location</code></p>
</li>
<li>
<p><code>topic.filter.class</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, the value for <code>replication.policy.class</code> must be the same for the source, checkpoint, and heartbeat connectors.
Mismatched or missing settings cause issues with data replication or offset syncing, so it&#8217;s essential to keep all relevant connectors configured with the same settings.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="con-mirrormaker-producers-consumers-str"><a class="link" href="#con-mirrormaker-producers-consumers-str">9.7.4. Configuring MirrorMaker 2 connector producers and consumers</a></h4>
<div class="paragraph _abstract">
<p>MirrorMaker 2 connectors use internal producers and consumers.
If needed, you can configure these producers and consumers to override the default settings.</p>
</div>
<div class="paragraph">
<p>For example, you can increase the <code>batch.size</code> for the source producer that sends topics to the target Kafka cluster to better accommodate large volumes of messages.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Producer and consumer configuration options depend on the MirrorMaker 2 implementation, and may be subject to change.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following tables describe the producers and consumers for each of the connectors and where you can add configuration.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. Source connector producers and consumers</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Configuration</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Producer</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sends topic messages to the target Kafka cluster. Consider tuning the configuration of this producer when it is handling large volumes of data.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mirrors.sourceConnector.config: producer.override.*</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Producer</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Writes to the <code>offset-syncs</code> topic, which maps the source and target offsets for replicated topic partitions.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mirrors.sourceConnector.config: producer.*</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Consumer</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Retrieves topic messages from the source Kafka cluster.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mirrors.sourceConnector.config: consumer.*</code></p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 13. Checkpoint connector producers and consumers</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Configuration</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Producer</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Emits consumer offset checkpoints.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mirrors.checkpointConnector.config: producer.override.*</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Consumer</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Loads the <code>offset-syncs</code> topic.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mirrors.checkpointConnector.config: consumer.*</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You can set <code>offset-syncs.topic.location</code> to <code>target</code> to use the target Kafka cluster as the location of the <code>offset-syncs</code> topic.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 14. Heartbeat connector producer</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Configuration</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Producer</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Emits heartbeats.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mirrors.heartbeatConnector.config: producer.override.*</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following example shows how you configure the producers and consumers.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration for connector producers and consumers</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker2
metadata:
  name: my-mirror-maker2
spec:
  version: 3.6.1
  # ...
  mirrors:
  - sourceCluster: "my-cluster-source"
    targetCluster: "my-cluster-target"
    sourceConnector:
      tasksMax: 5
      config:
        producer.override.batch.size: 327680
        producer.override.linger.ms: 100
        producer.request.timeout.ms: 30000
        consumer.fetch.max.bytes: 52428800
        # ...
    checkpointConnector:
      config:
        producer.override.request.timeout.ms: 30000
        consumer.max.poll.interval.ms: 300000
        # ...
    heartbeatConnector:
      config:
        producer.override.request.timeout.ms: 30000
        # ...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="con-mirrormaker-tasks-max-str"><a class="link" href="#con-mirrormaker-tasks-max-str">9.7.5. Specifying a maximum number of data replication tasks</a></h4>
<div class="paragraph _abstract">
<p>Connectors create the tasks that are responsible for moving data in and out of Kafka.
Each connector comprises one or more tasks that are distributed across a group of worker pods that run the tasks.
Increasing the number of tasks can help with performance issues when replicating a large number of partitions or synchronizing the offsets of a large number of consumer groups.</p>
</div>
<div class="paragraph">
<p>Tasks run in parallel.
Workers are assigned one or more tasks.
A single task is handled by one worker pod, so you don&#8217;t need more worker pods than tasks.
If there are more tasks than workers, workers handle multiple tasks.</p>
</div>
<div class="paragraph">
<p>You can specify the maximum number of connector tasks in your MirrorMaker configuration using the <code>tasksMax</code> property.
Without specifying a maximum number of tasks, the default setting is a single task.</p>
</div>
<div class="paragraph">
<p>The heartbeat connector always uses a single task.</p>
</div>
<div class="paragraph">
<p>The number of tasks that are started for the source and checkpoint connectors is the lower value between the maximum number of possible tasks and the value for <code>tasksMax</code>.
For the source connector, the maximum number of tasks possible is one for each partition being replicated from the source cluster.
For the checkpoint connector, the maximum number of tasks possible is one for each consumer group being replicated from the source cluster.
When setting a maximum number of tasks, consider the number of partitions and the hardware resources that support the process.</p>
</div>
<div class="paragraph">
<p>If the infrastructure supports the processing overhead, increasing the number of tasks can improve throughput and latency.
For example, adding more tasks reduces the time taken to poll the source cluster when there is a high number of partitions or consumer groups.</p>
</div>
<div class="paragraph">
<p>Increasing the number of tasks for the source connector is useful when you have a large number of partitions.</p>
</div>
<div class="listingblock">
<div class="title">Increasing the number of tasks for the source connector</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker2
metadata:
  name: my-mirror-maker2
spec:
  # ...
  mirrors:
  - sourceCluster: "my-cluster-source"
    targetCluster: "my-cluster-target"
    sourceConnector:
      tasksMax: 10
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Increasing the number of tasks for the checkpoint connector is useful when you have a large number of consumer groups.</p>
</div>
<div class="listingblock">
<div class="title">Increasing the number of tasks for the checkpoint connector</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker2
metadata:
  name: my-mirror-maker2
spec:
  # ...
  mirrors:
  - sourceCluster: "my-cluster-source"
    targetCluster: "my-cluster-target"
    checkpointConnector:
      tasksMax: 10
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, MirrorMaker 2 checks for new consumer groups every 10 minutes.
You can adjust the <code>refresh.groups.interval.seconds</code> configuration to change the frequency.
Take care when adjusting lower.
More frequent checks can have a negative impact on performance.</p>
</div>
<div class="sect4">
<h5 id="checking_connector_task_operations"><a class="link" href="#checking_connector_task_operations">Checking connector task operations</a></h5>
<div class="paragraph">
<p>If you are using Prometheus and Grafana to monitor your deployment, you can check MirrorMaker 2 performance.
The example MirrorMaker 2 Grafana dashboard provided with Strimzi shows the following metrics related to tasks and latency.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The number of tasks</p>
</li>
<li>
<p>Replication latency</p>
</li>
<li>
<p>Offset synchronization latency</p>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#assembly-metrics-str">Introducing metrics</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="con-mirrormaker-acls-str"><a class="link" href="#con-mirrormaker-acls-str">9.7.6. Synchronizing ACL rules for remote topics</a></h4>
<div class="paragraph _abstract">
<p>When using MirrorMaker 2 with Strimzi, it is possible to synchronize ACL rules for remote topics.
However, this feature is only available if you are not using the User Operator.</p>
</div>
<div class="paragraph">
<p>If you are using <code>type: simple</code> authorization without the User Operator, the ACL rules that manage access to brokers also apply to remote topics.
This means that users who have read access to a source topic can also read its remote equivalent.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
OAuth 2.0 authorization does not support access to remote topics in this way.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="proc-config-mirrormaker2-securing-connection-str"><a class="link" href="#proc-config-mirrormaker2-securing-connection-str">9.7.7. Securing a Kafka MirrorMaker 2 deployment</a></h4>
<div class="paragraph _abstract">
<p>This procedure describes in outline the configuration required to secure a MirrorMaker 2 deployment.</p>
</div>
<div class="paragraph">
<p>You need separate configuration for the source Kafka cluster and the target Kafka cluster.
You also need separate user configuration to provide the credentials required for MirrorMaker to connect to the source and target Kafka clusters.</p>
</div>
<div class="paragraph">
<p>For the Kafka clusters, you specify internal listeners for secure connections within a Kubernetes cluster and external listeners for connections outside the Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>You can configure authentication and authorization mechanisms.
The security options implemented for the source and target Kafka clusters must be compatible with the security options implemented for MirrorMaker 2.</p>
</div>
<div class="paragraph">
<p>After you have created the cluster and user authentication credentials, you specify them in your MirrorMaker configuration for secure connections.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In this procedure, the certificates generated by the Cluster Operator are used, but you can replace them by <a href="#installing-your-own-ca-certificates-str">installing your own certificates</a>.
You can also configure your listener to <a href="#proc-installing-certs-per-listener-str">use a Kafka listener certificate managed by an external CA (certificate authority)</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Before you start</div>
<p>Before starting this procedure, take a look at the <a href="#config-examples-str">example configuration files</a> provided by Strimzi.
They include examples for securing a deployment of MirrorMaker 2 using mTLS or SCRAM-SHA-512 authentication.
The examples specify internal listeners for connecting within a Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>The examples also provide the configuration for full authorization, including the ACLs that allow user operations on the source and target Kafka clusters.</p>
</div>
<div class="paragraph">
<p>When configuring user access to source and target Kafka clusters, ACLs must grant access rights to internal MirrorMaker 2 connectors and read/write access to the cluster group and internal topics used by the underlying Kafka Connect framework in the target cluster.
If you&#8217;ve renamed the cluster group or internal topics, such as when <a href="#con-config-mm2-multiple-instances-str">configuring MirrorMaker 2 for multiple instances</a>, use those names in the ACLs configuration.</p>
</div>
<div class="paragraph">
<p>Simple authorization uses ACL rules managed by the Kafka <code>AclAuthorizer</code> and <code>StandardAuthorizer</code> plugins to ensure appropriate access levels.
For more information on configuring a <code>KafkaUser</code> resource to use simple authorization, see the <a href="./configuring.html#type-AclRule-reference" target="_blank" rel="noopener"><code>AclRule</code> schema reference</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Strimzi is running</p>
</li>
<li>
<p>Separate namespaces for source and target clusters</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The procedure assumes that the source and target Kafka clusters are installed to separate namespaces.
If you want to use the Topic Operator, you&#8217;ll need to do this.
The Topic Operator only watches a single cluster in a specified namespace.</p>
</div>
<div class="paragraph">
<p>By separating the clusters into namespaces, you will need to copy the cluster secrets so they can be accessed outside the namespace.
You need to reference the secrets in the MirrorMaker configuration.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure two <code>Kafka</code> resources, one to secure the source Kafka cluster and one to secure the target Kafka cluster.</p>
<div class="paragraph">
<p>You can add listener configuration for authentication and enable authorization.</p>
</div>
<div class="paragraph">
<p>In this example, an internal listener is configured for a Kafka cluster with TLS encryption and mTLS authentication.
Kafka <code>simple</code> authorization is enabled.</p>
</div>
<div class="listingblock">
<div class="title">Example source Kafka cluster configuration with TLS encryption and mTLS authentication</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-source-cluster
spec:
  kafka:
    version: 3.6.1
    replicas: 1
    listeners:
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: tls
    authorization:
      type: simple
    config:
      offsets.topic.replication.factor: 1
      transaction.state.log.replication.factor: 1
      transaction.state.log.min.isr: 1
      default.replication.factor: 1
      min.insync.replicas: 1
      inter.broker.protocol.version: "3.6"
    storage:
      type: jbod
      volumes:
      - id: 0
        type: persistent-claim
        size: 100Gi
        deleteClaim: false
  zookeeper:
    replicas: 1
    storage:
      type: persistent-claim
      size: 100Gi
      deleteClaim: false
  entityOperator:
    topicOperator: {}
    userOperator: {}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example target Kafka cluster configuration with TLS encryption and mTLS authentication</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-target-cluster
spec:
  kafka:
    version: 3.6.1
    replicas: 1
    listeners:
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: tls
    authorization:
      type: simple
    config:
      offsets.topic.replication.factor: 1
      transaction.state.log.replication.factor: 1
      transaction.state.log.min.isr: 1
      default.replication.factor: 1
      min.insync.replicas: 1
      inter.broker.protocol.version: "3.6"
    storage:
      type: jbod
      volumes:
        - id: 0
          type: persistent-claim
          size: 100Gi
          deleteClaim: false
  zookeeper:
    replicas: 1
    storage:
      type: persistent-claim
      size: 100Gi
      deleteClaim: false
  entityOperator:
    topicOperator: {}
    userOperator: {}</code></pre>
</div>
</div>
</li>
<li>
<p>Create or update the <code>Kafka</code> resources in separate namespaces.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em> -n <em>&lt;namespace&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Cluster Operator creates the listeners and sets up the cluster and client certificate authority (CA) certificates to enable authentication within the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>The certificates are created in the secret <code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code>.</p>
</div>
</li>
<li>
<p>Configure two <code>KafkaUser</code> resources, one for a user of the source Kafka cluster and one for a user of the target Kafka cluster.</p>
<div class="openblock">
<div class="content">
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Configure the same authentication and authorization types as the corresponding source and target Kafka cluster.
For example, if you used <code>tls</code> authentication and the <code>simple</code> authorization type in the <code>Kafka</code> configuration for the source Kafka cluster, use the same in the <code>KafkaUser</code> configuration.</p>
</li>
<li>
<p>Configure the ACLs needed by MirrorMaker 2 to allow operations on the source and target Kafka clusters.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Example source user configuration for mTLS authentication</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-source-user
  labels:
    strimzi.io/cluster: my-source-cluster
spec:
  authentication:
    type: tls
  authorization:
    type: simple
    acls:
      # MirrorSourceConnector
      - resource: # Not needed if offset-syncs.topic.location=target
          type: topic
          name: mm2-offset-syncs.my-target-cluster.internal
        operations:
          - Create
          - DescribeConfigs
          - Read
          - Write
      - resource: # Needed for every topic which is mirrored
          type: topic
          name: "*"
        operations:
          - DescribeConfigs
          - Read
      # MirrorCheckpointConnector
      - resource:
          type: cluster
        operations:
          - Describe
      - resource: # Needed for every group for which offsets are synced
          type: group
          name: "*"
        operations:
          - Describe
      - resource: # Not needed if offset-syncs.topic.location=target
          type: topic
          name: mm2-offset-syncs.my-target-cluster.internal
        operations:
          - Read</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example target user configuration for mTLS authentication</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-target-user
  labels:
    strimzi.io/cluster: my-target-cluster
spec:
  authentication:
    type: tls
  authorization:
    type: simple
    acls:
      # cluster group
      - resource:
          type: group
          name: mirrormaker2-cluster
        operations:
          - Read
      # access to config.storage.topic
      - resource:
          type: topic
          name: mirrormaker2-cluster-configs
        operations:
          - Create
          - Describe
          - DescribeConfigs
          - Read
          - Write
      # access to status.storage.topic
      - resource:
          type: topic
          name: mirrormaker2-cluster-status
        operations:
          - Create
          - Describe
          - DescribeConfigs
          - Read
          - Write
      # access to offset.storage.topic
      - resource:
          type: topic
          name: mirrormaker2-cluster-offsets
        operations:
          - Create
          - Describe
          - DescribeConfigs
          - Read
          - Write
      # MirrorSourceConnector
      - resource: # Needed for every topic which is mirrored
          type: topic
          name: "*"
        operations:
          - Create
          - Alter
          - AlterConfigs
          - Write
      # MirrorCheckpointConnector
      - resource:
          type: cluster
        operations:
          - Describe
      - resource:
          type: topic
          name: my-source-cluster.checkpoints.internal
        operations:
          - Create
          - Describe
          - Read
          - Write
      - resource: # Needed for every group for which the offset is synced
          type: group
          name: "*"
        operations:
          - Read
          - Describe
      # MirrorHeartbeatConnector
      - resource:
          type: topic
          name: heartbeats
        operations:
          - Create
          - Describe
          - Write</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You can use a certificate issued outside the User Operator by setting <code>type</code> to <code>tls-external</code>.
For more information, see the <a href="./configuring.html#type-KafkaUserSpec-reference" target="_blank" rel="noopener"><code>KafkaUserSpec</code> schema reference</a>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create or update a <code>KafkaUser</code> resource in each of the namespaces you created for the source and target Kafka clusters.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_user_configuration_file&gt;</em> -n <em>&lt;namespace&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The User Operator creates the users representing the client (MirrorMaker), and the security credentials used for client authentication, based on the chosen authentication type.</p>
</div>
<div class="paragraph">
<p>The User Operator creates a new secret with the same name as the <code>KafkaUser</code> resource.
The secret contains a private and public key for mTLS authentication.
The public key is contained in a user certificate, which is signed by the clients CA.</p>
</div>
</li>
<li>
<p>Configure a <code>KafkaMirrorMaker2</code> resource with the authentication details to connect to the source and target Kafka clusters.</p>
<div class="listingblock">
<div class="title">Example MirrorMaker 2 configuration with TLS encryption and mTLS authentication</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker2
metadata:
  name: my-mirror-maker-2
spec:
  version: 3.6.1
  replicas: 1
  connectCluster: "my-target-cluster"
  clusters:
    - alias: "my-source-cluster"
      bootstrapServers: my-source-cluster-kafka-bootstrap:9093
      tls: # <b class="conum">(1)</b>
        trustedCertificates:
          - secretName: my-source-cluster-cluster-ca-cert
            certificate: ca.crt
      authentication: # <b class="conum">(2)</b>
        type: tls
        certificateAndKey:
          secretName: my-source-user
          certificate: user.crt
          key: user.key
    - alias: "my-target-cluster"
      bootstrapServers: my-target-cluster-kafka-bootstrap:9093
      tls: # <b class="conum">(3)</b>
        trustedCertificates:
          - secretName: my-target-cluster-cluster-ca-cert
            certificate: ca.crt
      authentication: # <b class="conum">(4)</b>
        type: tls
        certificateAndKey:
          secretName: my-target-user
          certificate: user.crt
          key: user.key
      config:
        # -1 means it will use the default replication factor configured in the broker
        config.storage.replication.factor: -1
        offset.storage.replication.factor: -1
        status.storage.replication.factor: -1
  mirrors:
    - sourceCluster: "my-source-cluster"
      targetCluster: "my-target-cluster"
      sourceConnector:
        config:
          replication.factor: 1
          offset-syncs.topic.replication.factor: 1
          sync.topic.acls.enabled: "false"
      heartbeatConnector:
        config:
          heartbeats.topic.replication.factor: 1
      checkpointConnector:
        config:
          checkpoints.topic.replication.factor: 1
          sync.group.offsets.enabled: "true"
      topicsPattern: "topic1|topic2|topic3"
      groupsPattern: "group1|group2|group3"</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The TLS certificates for the source Kafka cluster. If they are in a separate namespace, copy the cluster secrets from the namespace of the Kafka cluster.</p>
</li>
<li>
<p>The user authentication for accessing the source Kafka cluster using the TLS mechanism.</p>
</li>
<li>
<p>The TLS certificates for the target Kafka cluster.</p>
</li>
<li>
<p>The user authentication for accessing the target Kafka cluster.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create or update the <code>KafkaMirrorMaker2</code> resource in the same namespace as the target Kafka cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;mirrormaker2_configuration_file&gt;</em> -n <em>&lt;namespace_of_target_cluster&gt;</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-manual-stop-pause-mirrormaker2-connector-str"><a class="link" href="#proc-manual-stop-pause-mirrormaker2-connector-str">9.7.8. Manually stopping or pausing MirrorMaker 2 connectors</a></h4>
<div class="paragraph _abstract">
<p>If you are using <code>KafkaMirrorMaker2</code> resources to configure internal MirrorMaker connectors, use the <code>state</code> configuration to either stop or pause a connector.
In contrast to the paused state, where the connector and tasks remain instantiated, stopping a connector retains only the configuration, with no active processes.
Stopping a connector from running may be more suitable for longer durations than just pausing.
While a paused connector is quicker to resume, a stopped connector has the advantages of freeing up memory and resources.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>state</code> configuration replaces the (deprecated) <code>pause</code> configuration in the <code>KafkaMirrorMaker2ConnectorSpec</code> schema, which allows pauses on connectors.
If you were previously using the <code>pause</code> configuration to pause connectors, we encourage you to transition to using the <code>state</code> configuration only to avoid conflicts.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is running.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Find the name of the <code>KafkaMirrorMaker2</code> custom resource that controls the MirrorMaker 2 connector you want to pause or stop:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get KafkaMirrorMaker2</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>KafkaMirrorMaker2</code> resource to stop or pause the connector.</p>
<div class="listingblock">
<div class="title">Example configuration for stopping a MirrorMaker 2 connector</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker2
metadata:
  name: my-mirror-maker2
spec:
  version: 3.6.1
  replicas: 3
  connectCluster: "my-cluster-target"
  clusters:
    # ...
  mirrors:
  - sourceCluster: "my-cluster-source"
    targetCluster: "my-cluster-target"
    sourceConnector:
      tasksMax: 10
      autoRestart:
        enabled: true
      state: stopped
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Change the <code>state</code> configuration to <code>stopped</code> or <code>paused</code>.
The default state for the connector when this property is not set is <code>running</code>.</p>
</div>
</li>
<li>
<p>Apply the changes to the <code>KafkaMirrorMaker2</code> configuration.</p>
<div class="paragraph">
<p>You can resume the connector by changing <code>state</code> to <code>running</code> or removing the configuration.</p>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Alternatively, you can <a href="#con-exposing-kafka-connect-api-str">expose the Kafka Connect API</a> and use the <code>stop</code> and <code>pause</code> endpoints to stop a connector from running.
For example, <code>PUT /connectors/&lt;connector_name&gt;/stop</code>.
You can then use the <code>resume</code> endpoint to restart it.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="proc-manual-restart-mirrormaker2-connector-str"><a class="link" href="#proc-manual-restart-mirrormaker2-connector-str">9.7.9. Manually restarting MirrorMaker 2 connectors</a></h4>
<div class="paragraph _abstract">
<p>Use the <code>strimzi.io/restart-connector</code> annotation to manually trigger a restart of a MirrorMaker 2 connector.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is running.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Find the name of the <code>KafkaMirrorMaker2</code> custom resource that controls the Kafka MirrorMaker 2 connector you want to restart:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get KafkaMirrorMaker2</code></pre>
</div>
</div>
</li>
<li>
<p>Find the name of the Kafka MirrorMaker 2 connector to be restarted from the <code>KafkaMirrorMaker2</code> custom resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl describe KafkaMirrorMaker2 &lt;mirrormaker_cluster_name&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Use the name of the connector to restart the connector by annotating the <code>KafkaMirrorMaker2</code> resource in Kubernetes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate KafkaMirrorMaker2 &lt;mirrormaker_cluster_name&gt; "strimzi.io/restart-connector=&lt;mirrormaker_connector_name&gt;"</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, connector <code>my-connector</code> in the <code>my-mirror-maker-2</code> cluster is restarted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate KafkaMirrorMaker2 my-mirror-maker-2 "strimzi.io/restart-connector=my-connector"</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the next reconciliation to occur (every two minutes by default).</p>
<div class="paragraph">
<p>The MirrorMaker 2 connector is restarted, as long as the annotation was detected by the reconciliation process.
When MirrorMaker 2 accepts the request, the annotation is removed from the <code>KafkaMirrorMaker2</code> custom resource.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-manual-restart-mirrormaker2-connector-task-str"><a class="link" href="#proc-manual-restart-mirrormaker2-connector-task-str">9.7.10. Manually restarting MirrorMaker 2 connector tasks</a></h4>
<div class="paragraph _abstract">
<p>Use the <code>strimzi.io/restart-connector-task</code> annotation to manually trigger a restart of a MirrorMaker 2 connector.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is running.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Find the name of the <code>KafkaMirrorMaker2</code> custom resource that controls the MirrorMaker 2 connector task you want to restart:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get KafkaMirrorMaker2</code></pre>
</div>
</div>
</li>
<li>
<p>Find the name of the connector and the ID of the task to be restarted from the <code>KafkaMirrorMaker2</code> custom resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl describe KafkaMirrorMaker2 &lt;mirrormaker_cluster_name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Task IDs are non-negative integers, starting from 0.</p>
</div>
</li>
<li>
<p>Use the name and ID to restart the connector task by annotating the <code>KafkaMirrorMaker2</code> resource in Kubernetes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate KafkaMirrorMaker2 &lt;mirrormaker_cluster_name&gt; "strimzi.io/restart-connector-task=&lt;mirrormaker_connector_name&gt;:&lt;task_id&gt;"</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, task <code>0</code> for connector <code>my-connector</code> in the <code>my-mirror-maker-2</code> cluster is restarted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate KafkaMirrorMaker2 my-mirror-maker-2 "strimzi.io/restart-connector-task=my-connector:0"</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the next reconciliation to occur (every two minutes by default).</p>
<div class="paragraph">
<p>The MirrorMaker 2 connector task is restarted, as long as the annotation was detected by the reconciliation process.
When MirrorMaker 2 accepts the request, the annotation is removed from the <code>KafkaMirrorMaker2</code> custom resource.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-config-mirrormaker-str"><a class="link" href="#con-config-mirrormaker-str">9.8. Configuring Kafka MirrorMaker (deprecated)</a></h3>
<div class="paragraph _abstract">
<p>Update the <code>spec</code> properties of the <code>KafkaMirrorMaker</code> custom resource to configure your Kafka MirrorMaker deployment.</p>
</div>
<div class="paragraph">
<p>You can configure access control for producers and consumers using TLS or SASL authentication.
This procedure shows a configuration that uses TLS encryption and mTLS authentication on the consumer and producer side.</p>
</div>
<div class="paragraph">
<p>For a deeper understanding of the Kafka MirrorMaker cluster configuration options, refer to the <a href="./configuring.html" target="_blank" rel="noopener">Strimzi Custom Resource API Reference</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Kafka MirrorMaker 1 (referred to as just <em>MirrorMaker</em> in the documentation) has been deprecated in Apache Kafka 3.0.0 and will be removed in Apache Kafka 4.0.0.
As a result, the <code>KafkaMirrorMaker</code> custom resource which is used to deploy Kafka MirrorMaker 1 has been deprecated in Strimzi as well.
The <code>KafkaMirrorMaker</code> resource will be removed from Strimzi when we adopt Apache Kafka 4.0.0.
As a replacement, use the <code>KafkaMirrorMaker2</code> custom resource with the <a href="#unidirectional_replication_activepassive"><code>IdentityReplicationPolicy</code></a>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example <code>KafkaMirrorMaker</code> custom resource configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker
metadata:
  name: my-mirror-maker
spec:
  replicas: 3 # <b class="conum">(1)</b>
  consumer:
    bootstrapServers: my-source-cluster-kafka-bootstrap:9092 # <b class="conum">(2)</b>
    groupId: "my-group" # <b class="conum">(3)</b>
    numStreams: 2 # <b class="conum">(4)</b>
    offsetCommitInterval: 120000 # <b class="conum">(5)</b>
    tls: # <b class="conum">(6)</b>
      trustedCertificates:
      - secretName: my-source-cluster-ca-cert
        certificate: ca.crt
    authentication: # <b class="conum">(7)</b>
      type: tls
      certificateAndKey:
        secretName: my-source-secret
        certificate: public.crt
        key: private.key
    config: # <b class="conum">(8)</b>
      max.poll.records: 100
      receive.buffer.bytes: 32768
  producer:
    bootstrapServers: my-target-cluster-kafka-bootstrap:9092
    abortOnSendFailure: false # <b class="conum">(9)</b>
    tls:
      trustedCertificates:
      - secretName: my-target-cluster-ca-cert
        certificate: ca.crt
    authentication:
      type: tls
      certificateAndKey:
        secretName: my-target-secret
        certificate: public.crt
        key: private.key
    config:
      compression.type: gzip
      batch.size: 8192
  include: "my-topic|other-topic" # <b class="conum">(10)</b>
  resources: # <b class="conum">(11)</b>
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "2"
      memory: 2Gi
  logging: # <b class="conum">(12)</b>
    type: inline
    loggers:
      mirrormaker.root.logger: INFO
  readinessProbe: # <b class="conum">(13)</b>
    initialDelaySeconds: 15
    timeoutSeconds: 5
  livenessProbe:
    initialDelaySeconds: 15
    timeoutSeconds: 5
  metricsConfig: # <b class="conum">(14)</b>
   type: jmxPrometheusExporter
   valueFrom:
     configMapKeyRef:
       name: my-config-map
       key: my-key
  jvmOptions: # <b class="conum">(15)</b>
    "-Xmx": "1g"
    "-Xms": "1g"
  image: my-org/my-image:latest # <b class="conum">(16)</b>
  template: # <b class="conum">(17)</b>
    pod:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: application
                    operator: In
                    values:
                      - postgresql
                      - mongodb
              topologyKey: "kubernetes.io/hostname"
    mirrorMakerContainer: # <b class="conum">(18)</b>
      env:
        - name: OTEL_SERVICE_NAME
          value: my-otel-service
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "http://otlp-host:4317"
  tracing: # <b class="conum">(19)</b>
    type: opentelemetry</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The number of replica nodes.</p>
</li>
<li>
<p>Bootstrap servers for consumer and producer.</p>
</li>
<li>
<p>Group ID for the consumer.</p>
</li>
<li>
<p>The number of consumer streams.</p>
</li>
<li>
<p>The offset auto-commit interval in milliseconds.</p>
</li>
<li>
<p>TLS encryption with key names under which TLS certificates are stored in X.509 format for consumer or producer. If certificates are stored in the same secret, it can be listed multiple times.</p>
</li>
<li>
<p>Authentication for consumer or producer, specified as mTLS, token-based OAuth, SASL-based SCRAM-SHA-256/SCRAM-SHA-512, or PLAIN.</p>
</li>
<li>
<p>Kafka configuration options for consumer and producer.</p>
</li>
<li>
<p>If the <code>abortOnSendFailure</code> property is set to <code>true</code>, Kafka MirrorMaker will exit and the container will restart following a send failure for a message.</p>
</li>
<li>
<p>A list of included topics mirrored from source to target Kafka cluster.</p>
</li>
<li>
<p>Requests for reservation of supported resources, currently <code>cpu</code> and <code>memory</code>, and limits to specify the maximum resources that can be consumed.</p>
</li>
<li>
<p>Specified loggers and log levels added directly (<code>inline</code>) or indirectly (<code>external</code>) through a ConfigMap. A custom Log4j configuration must be placed under the <code>log4j.properties</code> or <code>log4j2.properties</code> key in the ConfigMap. MirrorMaker has a single logger called <code>mirrormaker.root.logger</code>. You can set the log level to INFO, ERROR, WARN, TRACE, DEBUG, FATAL or OFF.</p>
</li>
<li>
<p>Healthchecks to know when to restart a container (liveness) and when a container can accept traffic (readiness).</p>
</li>
<li>
<p>Prometheus metrics, which are enabled by referencing a ConfigMap containing configuration for the Prometheus JMX exporter in this example. You can enable metrics without further configuration using a reference to a ConfigMap containing an empty file under <code>metricsConfig.valueFrom.configMapKeyRef.key</code>.</p>
</li>
<li>
<p>JVM configuration options to optimize performance for the Virtual Machine (VM) running Kafka MirrorMaker.</p>
</li>
<li>
<p>ADVANCED OPTION: Container image configuration, which is recommended only in special situations.</p>
</li>
<li>
<p>Template customization. Here a pod is scheduled with anti-affinity, so the pod is not scheduled on nodes with the same hostname.</p>
</li>
<li>
<p>Environment variables are set for distributed tracing.</p>
</li>
<li>
<p>Distributed tracing is enabled by using OpenTelemetry.</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
With the <code>abortOnSendFailure</code> property set to <code>false</code>, the producer attempts to send the next message in a topic. The original message might be lost, as there is no attempt to resend a failed message.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="con-config-kafka-bridge-str"><a class="link" href="#con-config-kafka-bridge-str">9.9. Configuring the Kafka Bridge</a></h3>
<div class="paragraph _abstract">
<p>Update the <code>spec</code> properties of the <code>KafkaBridge</code> custom resource to configure your Kafka Bridge deployment.</p>
</div>
<div class="paragraph">
<p>In order to prevent issues arising when client consumer requests are processed by different Kafka Bridge instances, address-based routing must be employed to ensure that requests are routed to the right Kafka Bridge instance.
Additionally, each independent Kafka Bridge instance must have a replica.
A Kafka Bridge instance has its own state which is not shared with another instances.</p>
</div>
<div class="paragraph">
<p>For a deeper understanding of the Kafka Bridge cluster configuration options, refer to the <a href="./configuring.html" target="_blank" rel="noopener">Strimzi Custom Resource API Reference</a>.</p>
</div>
<div class="listingblock">
<div class="title">Example <code>KafkaBridge</code> custom resource configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaBridge
metadata:
  name: my-bridge
spec:
  replicas: 3 # <b class="conum">(1)</b>
  bootstrapServers: <em>&lt;cluster_name&gt;</em>-cluster-kafka-bootstrap:9092 # <b class="conum">(2)</b>
  tls: # <b class="conum">(3)</b>
    trustedCertificates:
      - secretName: my-cluster-cluster-cert
        certificate: ca.crt
      - secretName: my-cluster-cluster-cert
        certificate: ca2.crt
  authentication: # <b class="conum">(4)</b>
    type: tls
    certificateAndKey:
      secretName: my-secret
      certificate: public.crt
      key: private.key
  http: # <b class="conum">(5)</b>
    port: 8080
    cors: # <b class="conum">(6)</b>
      allowedOrigins: "https://strimzi.io"
      allowedMethods: "GET,POST,PUT,DELETE,OPTIONS,PATCH"
  consumer: # <b class="conum">(7)</b>
    config:
      auto.offset.reset: earliest
  producer: # <b class="conum">(8)</b>
    config:
      delivery.timeout.ms: 300000
  resources: # <b class="conum">(9)</b>
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "2"
      memory: 2Gi
  logging: # <b class="conum">(10)</b>
    type: inline
    loggers:
      logger.bridge.level: INFO
      # enabling DEBUG just for send operation
      logger.send.name: "http.openapi.operation.send"
      logger.send.level: DEBUG
  jvmOptions: # <b class="conum">(11)</b>
    "-Xmx": "1g"
    "-Xms": "1g"
  readinessProbe: # <b class="conum">(12)</b>
    initialDelaySeconds: 15
    timeoutSeconds: 5
  livenessProbe:
    initialDelaySeconds: 15
    timeoutSeconds: 5
  image: my-org/my-image:latest # <b class="conum">(13)</b>
  template: # <b class="conum">(14)</b>
    pod:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: application
                    operator: In
                    values:
                      - postgresql
                      - mongodb
              topologyKey: "kubernetes.io/hostname"
    bridgeContainer: # <b class="conum">(15)</b>
      env:
        - name: OTEL_SERVICE_NAME
          value: my-otel-service
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "http://otlp-host:4317"
  tracing:
    type: opentelemetry # <b class="conum">(16)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The number of replica nodes.</p>
</li>
<li>
<p>Bootstrap server for connection to the target Kafka cluster. Use the name of the Kafka cluster as the <em>&lt;cluster_name&gt;</em>.</p>
</li>
<li>
<p>TLS encryption with key names under which TLS certificates are stored in X.509 format for the source Kafka cluster. If certificates are stored in the same secret, it can be listed multiple times.</p>
</li>
<li>
<p>Authentication for the Kafka Bridge cluster, specified as mTLS, token-based OAuth, SASL-based SCRAM-SHA-256/SCRAM-SHA-512, or PLAIN.
By default, the Kafka Bridge connects to Kafka brokers without authentication.</p>
</li>
<li>
<p>HTTP access to Kafka brokers.</p>
</li>
<li>
<p>CORS access specifying selected resources and access methods. Additional HTTP headers in requests describe the origins that are permitted access to the Kafka cluster.</p>
</li>
<li>
<p>Consumer configuration options.</p>
</li>
<li>
<p>Producer configuration options.</p>
</li>
<li>
<p>Requests for reservation of supported resources, currently <code>cpu</code> and <code>memory</code>, and limits to specify the maximum resources that can be consumed.</p>
</li>
<li>
<p>Specified Kafka Bridge loggers and log levels added directly (<code>inline</code>) or indirectly (<code>external</code>) through a ConfigMap. A custom Log4j configuration must be placed under the <code>log4j.properties</code> or <code>log4j2.properties</code> key in the ConfigMap. For the Kafka Bridge loggers, you can set the log level to INFO, ERROR, WARN, TRACE, DEBUG, FATAL or OFF.</p>
</li>
<li>
<p>JVM configuration options to optimize performance for the Virtual Machine (VM) running the Kafka Bridge.</p>
</li>
<li>
<p>Healthchecks to know when to restart a container (liveness) and when a container can accept traffic (readiness).</p>
</li>
<li>
<p>Optional: Container image configuration, which is recommended only in special situations.</p>
</li>
<li>
<p>Template customization. Here a pod is scheduled with anti-affinity, so the pod is not scheduled on nodes with the same hostname.</p>
</li>
<li>
<p>Environment variables are set for distributed tracing.</p>
</li>
<li>
<p>Distributed tracing is enabled by using OpenTelemetry.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://strimzi.io/docs/bridge/latest/" target="_blank" rel="noopener">Using the Strimzi Kafka Bridge</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="assembly-storage-str"><a class="link" href="#assembly-storage-str">9.10. Configuring Kafka and ZooKeeper storage</a></h3>
<div class="paragraph _abstract">
<p>Strimzi provides flexibility in configuring the data storage options of Kafka and ZooKeeper.</p>
</div>
<div class="paragraph">
<p>The supported storage types are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ephemeral (Recommended for development only)</p>
</li>
<li>
<p>Persistent</p>
</li>
<li>
<p>JBOD (Kafka only; not available for ZooKeeper)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To configure storage, you specify <code>storage</code> properties in the custom resource of the component.
The storage type is set using the <code>storage.type</code> property.</p>
</div>
<div class="paragraph">
<p>You can also use the preview of the node pools feature for advanced storage management of the Kafka cluster.
You can specify storage configuration unique to each node pool used in the cluster.
The same storage properties available to the <code>Kafka</code> resource are also available to the <code>KafkaNodePool</code> pool resource.</p>
</div>
<div class="paragraph">
<p>The storage-related schema references provide more information on the storage configuration properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./configuring.html#type-EphemeralStorage-reference" target="_blank" rel="noopener"><code>EphemeralStorage</code> schema reference</a></p>
</li>
<li>
<p><a href="./configuring.html#type-PersistentClaimStorage-reference" target="_blank" rel="noopener"><code>PersistentClaimStorage</code> schema reference</a></p>
</li>
<li>
<p><a href="./configuring.html#type-JbodStorage-reference" target="_blank" rel="noopener"><code>JbodStorage</code> schema reference</a></p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The storage type cannot be changed after a Kafka cluster is deployed.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="considerations-for-data-storage-str"><a class="link" href="#considerations-for-data-storage-str">9.10.1. Data storage considerations</a></h4>
<div class="paragraph _abstract">
<p>For Strimzi to work well, an efficient data storage infrastructure is essential.
We strongly recommend using block storage.
Strimzi is only tested for use with block storage.
File storage, such as NFS, is not tested and there is no guarantee it will work.</p>
</div>
<div class="paragraph">
<p>Choose one of the following options for your block storage:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A cloud-based block storage solution, such as <a href="https://aws.amazon.com/ebs/" target="_blank" rel="noopener">Amazon Elastic Block Store (EBS)</a></p>
</li>
<li>
<p>Persistent storage using <a href="https://kubernetes.io/docs/concepts/storage/volumes/#local" target="_blank" rel="noopener">local persistent volumes</a></p>
</li>
<li>
<p>Storage Area Network (SAN) volumes accessed by a protocol such as <em>Fibre Channel</em> or <em>iSCSI</em></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Strimzi does not require Kubernetes raw block volumes.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="file_systems"><a class="link" href="#file_systems">File systems</a></h5>
<div class="paragraph">
<p>Kafka uses a file system for storing messages.
Strimzi is compatible with the XFS and ext4 file systems, which are commonly used with Kafka.
Consider the underlying architecture and requirements of your deployment when choosing and setting up your file system.</p>
</div>
<div class="paragraph">
<p>For more information, refer to <a href="https://kafka.apache.org/documentation/#filesystems" target="_blank" rel="noopener">Filesystem Selection</a> in the Kafka documentation.</p>
</div>
</div>
<div class="sect4">
<h5 id="disk_usage"><a class="link" href="#disk_usage">Disk usage</a></h5>
<div class="paragraph">
<p>Use separate disks for Apache Kafka and ZooKeeper.</p>
</div>
<div class="paragraph">
<p>Solid-state drives (SSDs), though not essential, can improve the performance of Kafka in large clusters where data is sent to and received from multiple topics asynchronously.
SSDs are particularly effective with ZooKeeper, which requires fast, low latency data access.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You do not need to provision replicated storage because Kafka and ZooKeeper both have built-in data replication.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ref-ephemeral-storage-str"><a class="link" href="#ref-ephemeral-storage-str">9.10.2. Ephemeral storage</a></h4>
<div class="paragraph _abstract">
<p>Ephemeral data storage is transient.
All pods on a node share a local ephemeral storage space.
Data is retained for as long as the pod that uses it is running.
The data is lost when a pod is deleted.
Although a pod can recover data in a highly available environment.</p>
</div>
<div class="paragraph">
<p>Because of its transient nature, ephemeral storage is only recommended for development and testing.</p>
</div>
<div class="paragraph">
<p>Ephemeral storage uses <code><a href="https://kubernetes.io/docs/concepts/storage/volumes/#emptydir" target="_blank" rel="noopener">emptyDir</a></code> volumes to store data.
An <code>emptyDir</code> volume is created when a pod is assigned to a node.
You can set the total amount of storage for the <code>emptyDir</code> using the <code>sizeLimit</code> property .</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Ephemeral storage is not suitable for single-node ZooKeeper clusters or Kafka topics with a replication factor of 1.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To use ephemeral storage, you set the storage type configuration in the <code>Kafka</code> or <code>ZooKeeper</code> resource to <code>ephemeral</code>.
If you are using the preview of the node pools feature, you can also specify <code>ephemeral</code> in the storage configuration of individual node pools.</p>
</div>
<div class="listingblock">
<div class="title">Example ephemeral storage configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    storage:
      type: ephemeral
    # ...
  zookeeper:
    storage:
      type: ephemeral
    # ...</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="mount_path_of_kafka_log_directories"><a class="link" href="#mount_path_of_kafka_log_directories">Mount path of Kafka log directories</a></h5>
<div class="paragraph">
<p>The ephemeral volume is used by Kafka brokers as log directories mounted into the following path:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">/var/lib/kafka/data/kafka-log<em>IDX</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code><em>IDX</em></code> is the Kafka broker pod index. For example <code>/var/lib/kafka/data/kafka-log0</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ref-persistent-storage-str"><a class="link" href="#ref-persistent-storage-str">9.10.3. Persistent storage</a></h4>
<div class="paragraph _abstract">
<p>Persistent data storage retains data in the event of system disruption.
For pods that use persistent data storage, data is persisted across pod failures and restarts.
Because of its permanent nature, persistent storage is recommended for production environments.</p>
</div>
<div class="paragraph">
<p>To use persistent storage in Strimzi, you specify <code>persistent-claim</code> in the storage configuration of the <code>Kafka</code> or <code>ZooKeeper</code> resources.
If you are using the preview of the node pools feature, you can also specify <code>persistent-claim</code> in the storage configuration of individual node pools.</p>
</div>
<div class="paragraph">
<p>You configure the resource so that pods use <a href="https://kubernetes.io/docs/concepts/storage/dynamic-provisioning/" target="_blank" rel="noopener">Persistent Volume Claims</a> (PVCs) to make storage requests on persistent volumes (PVs).
PVs represent storage volumes that are created on demand and are independent of the pods that use them.
The PVC requests the amount of storage required when a pod is being created.
The underlying storage infrastructure of the PV does not need to be understood.
If a PV matches the storage criteria, the PVC is bound to the PV.</p>
</div>
<div class="paragraph">
<p>You have two options for specifying the storage type:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>storage.type: persistent-claim</code></dt>
<dd>
<p>If you choose <code>persistent-claim</code> as the storage type, a single persistent storage volume is defined.</p>
</dd>
<dt class="hdlist1"><code>storage.type: jbod</code></dt>
<dd>
<p>When you select <code>jbod</code> as the storage type, you have the flexibility to define an array of persistent storage volumes using unique IDs.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In a production environment, it is recommended to configure the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For Kafka or node pools, set <code>storage.type</code> to <code>jbod</code> with one or more persistent volumes.</p>
</li>
<li>
<p>For ZooKeeper, set <code>storage.type</code> as <code>persistent-claim</code> for a single persistent volume.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Persistent storage also has the following configuration options:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>id</code> (optional)</dt>
<dd>
<p>A storage identification number. This option is mandatory for storage volumes defined in a JBOD storage declaration.
Default is <code>0</code>.</p>
</dd>
<dt class="hdlist1"><code>size</code> (required)</dt>
<dd>
<p>The size of the persistent volume claim, for example, "1000Gi".</p>
</dd>
<dt class="hdlist1"><code>class</code> (optional)</dt>
<dd>
<p>PVCs can request different types of persistent storage by specifying a <a href="https://kubernetes.io/docs/concepts/storage/storage-classes/" target="_blank" rel="noopener">StorageClass</a>.
Storage classes define storage profiles and dynamically provision PVs based on that profile.
If a storage class is not specified, the storage class marked as default in the Kubernetes cluster is used.
Persistent storage options might include SAN storage types or <a href="https://kubernetes.io/docs/concepts/storage/volumes/#local" target="_blank" rel="noopener">local persistent volumes</a>.</p>
</dd>
<dt class="hdlist1"><code>selector</code> (optional)</dt>
<dd>
<p>Configuration to specify a specific PV.
Provides key:value pairs representing the labels of the volume selected.</p>
</dd>
<dt class="hdlist1"><code>deleteClaim</code> (optional)</dt>
<dd>
<p>Boolean value to specify whether the PVC is deleted when the cluster is uninstalled.
Default is <code>false</code>.</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Increasing the size of persistent volumes in an existing Strimzi cluster is only supported in Kubernetes versions that support persistent volume resizing. The persistent volume to be resized must use a storage class that supports volume expansion.
For other versions of Kubernetes and storage classes that do not support volume expansion, you must decide the necessary storage size before deploying the cluster.
Decreasing the size of existing persistent volumes is not possible.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example persistent storage configuration for Kafka and ZooKeeper</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    storage:
      type: jbod
      volumes:
      - id: 0
        type: persistent-claim
        size: 100Gi
        deleteClaim: false
      - id: 1
        type: persistent-claim
        size: 100Gi
        deleteClaim: false
      - id: 2
        type: persistent-claim
        size: 100Gi
        deleteClaim: false
    # ...
  zookeeper:
    storage:
      type: persistent-claim
      size: 1000Gi
    # ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example persistent storage configuration with specific storage class</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
storage:
  type: persistent-claim
  size: 500Gi
  class: my-storage-class
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use a <code>selector</code> to specify a labeled persistent volume that provides certain features, such as an SSD.</p>
</div>
<div class="listingblock">
<div class="title">Example persistent storage configuration with selector</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
storage:
  type: persistent-claim
  size: 1Gi
  selector:
    hdd-type: ssd
  deleteClaim: true
# ...</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="storage_class_overrides"><a class="link" href="#storage_class_overrides">Storage class overrides</a></h5>
<div class="paragraph">
<p>Instead of using the default storage class, you can specify a different storage class for one or more Kafka or ZooKeeper nodes.
This is useful, for example, when storage classes are restricted to different availability zones or data centers.
You can use the <code>overrides</code> field for this purpose.</p>
</div>
<div class="paragraph">
<p>In this example, the default storage class is named <code>my-storage-class</code>:</p>
</div>
<div class="listingblock">
<div class="title">Example storage configuration with class overrides</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  labels:
    app: my-cluster
  name: my-cluster
  namespace: myproject
spec:
  # ...
  kafka:
    replicas: 3
    storage:
      type: jbod
      volumes:
      - id: 0
        type: persistent-claim
        size: 100Gi
        deleteClaim: false
        class: my-storage-class
        overrides:
        - broker: 0
          class: my-storage-class-zone-1a
        - broker: 1
          class: my-storage-class-zone-1b
        - broker: 2
          class: my-storage-class-zone-1c
      # ...
  # ...
  zookeeper:
    replicas: 3
    storage:
      deleteClaim: true
      size: 100Gi
      type: persistent-claim
      class: my-storage-class
      overrides:
        - broker: 0
          class: my-storage-class-zone-1a
        - broker: 1
          class: my-storage-class-zone-1b
        - broker: 2
          class: my-storage-class-zone-1c
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a result of the configured <code>overrides</code> property, the volumes use the following storage classes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The persistent volumes of ZooKeeper node 0 use <code>my-storage-class-zone-1a</code>.</p>
</li>
<li>
<p>The persistent volumes of ZooKeeper node 1 use <code>my-storage-class-zone-1b</code>.</p>
</li>
<li>
<p>The persistent volumes of ZooKeeper node 2 use <code>my-storage-class-zone-1c</code>.</p>
</li>
<li>
<p>The persistent volumes of Kafka broker 0 use <code>my-storage-class-zone-1a</code>.</p>
</li>
<li>
<p>The persistent volumes of Kafka broker 1 use <code>my-storage-class-zone-1b</code>.</p>
</li>
<li>
<p>The persistent volumes of Kafka broker 2 use <code>my-storage-class-zone-1c</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>overrides</code> property is currently used only to override the storage <code>class</code>.
Overrides for other storage configuration properties is not currently supported.</p>
</div>
</div>
<div class="sect4">
<h5 id="ref-persistent-storage-pvc-str"><a class="link" href="#ref-persistent-storage-pvc-str">PVC resources for persistent storage</a></h5>
<div class="paragraph">
<p>When persistent storage is used, it creates PVCs with the following names:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>data-<em>cluster-name</em>-kafka-<em>idx</em></code></dt>
<dd>
<p>PVC for the volume used for storing data for the Kafka broker pod <code><em>idx</em></code>.</p>
</dd>
<dt class="hdlist1"><code>data-<em>cluster-name</em>-zookeeper-<em>idx</em></code></dt>
<dd>
<p>PVC for the volume used for storing data for the ZooKeeper node pod <code><em>idx</em></code>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="mount_path_of_kafka_log_directories_2"><a class="link" href="#mount_path_of_kafka_log_directories_2">Mount path of Kafka log directories</a></h5>
<div class="paragraph">
<p>The persistent volume is used by the Kafka brokers as log directories mounted into the following path:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">/var/lib/kafka/data/kafka-log<em>IDX</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code><em>IDX</em></code> is the Kafka broker pod index. For example <code>/var/lib/kafka/data/kafka-log0</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="proc-resizing-persistent-volumes-str"><a class="link" href="#proc-resizing-persistent-volumes-str">9.10.4. Resizing persistent volumes</a></h4>
<div class="paragraph _abstract">
<p>Persistent volumes used by a cluster can be resized without any risk of data loss, as long as the storage infrastructure supports it.
Following a configuration update to change the size of the storage, Strimzi instructs the storage infrastructure to make the change.
Storage expansion is supported in Strimzi clusters that use persistent-claim volumes.</p>
</div>
<div class="paragraph">
<p>Storage reduction is only possible when using multiple disks per broker.
You can remove a disk after moving all partitions on the disk to other volumes within the same broker (intra-broker) or to other brokers within the same cluster (intra-cluster).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
You cannot decrease the size of persistent volumes because it is not currently supported in Kubernetes.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kubernetes cluster with support for volume resizing.</p>
</li>
<li>
<p>The Cluster Operator is running.</p>
</li>
<li>
<p>A Kafka cluster using persistent volumes created using a storage class that supports volume expansion.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <code>Kafka</code> resource for your cluster.</p>
<div class="paragraph">
<p>Change the <code>size</code> property to increase the size of the persistent volume allocated to a Kafka cluster, a ZooKeeper cluster, or both.</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>For Kafka clusters, update the <code>size</code> property under <code>spec.kafka.storage</code>.</p>
</li>
<li>
<p>For ZooKeeper clusters, update the <code>size</code> property under <code>spec.zookeeper.storage</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Kafka configuration to increase the volume size to <code>2000Gi</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
    storage:
      type: persistent-claim
      size: 2000Gi
      class: my-storage-class
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>Kubernetes increases the capacity of the selected persistent volumes in response to a request from the Cluster Operator.
When the resizing is complete, the Cluster Operator restarts all pods that use the resized persistent volumes.
This happens automatically.</p>
</div>
</li>
<li>
<p>Verify that the storage capacity has increased for the relevant pods on the cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pv</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Kafka broker pods with increased storage</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME               CAPACITY   CLAIM
pvc-0ca459ce-...   2000Gi     my-project/data-my-cluster-kafka-2
pvc-6e1810be-...   2000Gi     my-project/data-my-cluster-kafka-0
pvc-82dc78c9-...   2000Gi     my-project/data-my-cluster-kafka-1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output shows the names of each PVC associated with a broker pod.</p>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For more information about resizing persistent volumes in Kubernetes, see <a href="https://kubernetes.io/blog/2018/07/12/resizing-persistent-volumes-using-kubernetes/" target="_blank" rel="noopener">Resizing Persistent Volumes using Kubernetes</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="ref-jbod-storage-str"><a class="link" href="#ref-jbod-storage-str">9.10.5. JBOD storage</a></h4>
<div class="paragraph _abstract">
<p>JBOD storage allows you to configure your Kafka cluster to use multiple disks or volumes.
This approach provides increased data storage capacity for Kafka brokers, and can lead to performance improvements.
A JBOD configuration is defined by one or more volumes, each of which can be either <a href="#ref-ephemeral-storage-str">ephemeral</a> or <a href="#ref-persistent-storage-str">persistent</a>.
The rules and constraints for JBOD volume declarations are the same as those for ephemeral and persistent storage.
For example, you cannot decrease the size of a persistent storage volume after it has been provisioned, nor can you change the value of <code>sizeLimit</code> when the type is <code>ephemeral</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
JBOD storage is supported for <strong>Kafka only</strong>, not for ZooKeeper.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To use JBOD storage, you set the storage type configuration in the <code>Kafka</code> resource to <code>jbod</code>.
If you are using the preview of the node pools feature, you can also specify <code>jbod</code> in the storage configuration of individual node pools.</p>
</div>
<div class="paragraph">
<p>The <code>volumes</code> property allows you to describe the disks that make up your JBOD storage array or configuration.</p>
</div>
<div class="listingblock">
<div class="title">Example JBOD storage configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    storage:
      type: jbod
      volumes:
      - id: 0
        type: persistent-claim
        size: 100Gi
        deleteClaim: false
      - id: 1
        type: persistent-claim
        size: 100Gi
        deleteClaim: false
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The IDs cannot be changed once the JBOD volumes are created.
You can add or remove volumes from the JBOD configuration.</p>
</div>
<div class="sect4">
<h5 id="ref-jbod-storage-pvc-str"><a class="link" href="#ref-jbod-storage-pvc-str">PVC resource for JBOD storage</a></h5>
<div class="paragraph">
<p>When persistent storage is used to declare JBOD volumes, it creates a PVC with the following name:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>data-<em>id</em>-<em>cluster-name</em>-kafka-<em>idx</em></code></dt>
<dd>
<p>PVC for the volume used for storing data for the Kafka broker pod <code><em>idx</em></code>.
The <code><em>id</em></code> is the ID of the volume used for storing data for Kafka broker pod.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="mount_path_of_kafka_log_directories_3"><a class="link" href="#mount_path_of_kafka_log_directories_3">Mount path of Kafka log directories</a></h5>
<div class="paragraph">
<p>The JBOD volumes are used by Kafka brokers as log directories mounted into the following path:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">/var/lib/kafka/data-<em>id</em>/kafka-log<em>idx</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code><em>id</em></code> is the ID of the volume used for storing data for Kafka broker pod <code><em>idx</em></code>. For example <code>/var/lib/kafka/data-0/kafka-log0</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="proc-adding-volumes-to-jbod-storage-str"><a class="link" href="#proc-adding-volumes-to-jbod-storage-str">9.10.6. Adding volumes to JBOD storage</a></h4>
<div class="paragraph">
<p>This procedure describes how to add volumes to a Kafka cluster configured to use JBOD storage.
It cannot be applied to Kafka clusters configured to use any other storage type.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
When adding a new volume under an <code>id</code> which was already used in the past and removed, you have to make sure that the previously used <code>PersistentVolumeClaims</code> have been deleted.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kubernetes cluster</p>
</li>
<li>
<p>A running Cluster Operator</p>
</li>
<li>
<p>A Kafka cluster with JBOD storage</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <code>spec.kafka.storage.volumes</code> property in the <code>Kafka</code> resource.
Add the new volumes to the <code>volumes</code> array.
For example, add the new volume with id <code>2</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
    storage:
      type: jbod
      volumes:
      - id: 0
        type: persistent-claim
        size: 100Gi
        deleteClaim: false
      - id: 1
        type: persistent-claim
        size: 100Gi
        deleteClaim: false
      - id: 2
        type: persistent-claim
        size: 100Gi
        deleteClaim: false
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>Create new topics or reassign existing partitions to the new disks.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Cruise Control is an effective tool for reassigning partitions.
To perform an intra-broker disk balance, you set <code>rebalanceDisk</code> to <code>true</code> under the <code>KafkaRebalance.spec</code>.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-removing-volumes-from-jbod-storage-str"><a class="link" href="#proc-removing-volumes-from-jbod-storage-str">9.10.7. Removing volumes from JBOD storage</a></h4>
<div class="paragraph">
<p>This procedure describes how to remove volumes from Kafka cluster configured to use JBOD storage.
It cannot be applied to Kafka clusters configured to use any other storage type.
The JBOD storage always has to contain at least one volume.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
To avoid data loss, you have to move all partitions before removing the volumes.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kubernetes cluster</p>
</li>
<li>
<p>A running Cluster Operator</p>
</li>
<li>
<p>A Kafka cluster with JBOD storage with two or more volumes</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Reassign all partitions from the disks which are you going to remove.
Any data in partitions still assigned to the disks which are going to be removed might be lost.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You can use the <code>kafka-reassign-partitions.sh</code> tool to reassign the partitions.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Edit the <code>spec.kafka.storage.volumes</code> property in the <code>Kafka</code> resource.
Remove one or more volumes from the <code>volumes</code> array.
For example, remove the volumes with ids <code>1</code> and <code>2</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
    storage:
      type: jbod
      volumes:
      - id: 0
        type: persistent-claim
        size: 100Gi
        deleteClaim: false
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="config-resources-str"><a class="link" href="#config-resources-str">9.11. Configuring CPU and memory resource limits and requests</a></h3>
<div class="paragraph _abstract">
<p>By default, the Strimzi Cluster Operator does not specify CPU and memory resource requests and limits for its deployed operands.
Ensuring an adequate allocation of resources is crucial for maintaining stability and achieving optimal performance in Kafka.
The ideal resource allocation depends on your specific requirements and use cases.</p>
</div>
<div class="paragraph">
<p>It is recommended to configure CPU and memory resources for each container by <a href="./configuring.html#con-common-configuration-resources-reference" target="_blank" rel="noopener">setting appropriate requests and limits</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="assembly-scheduling-str"><a class="link" href="#assembly-scheduling-str">9.12. Configuring pod scheduling</a></h3>
<div class="paragraph _abstract">
<p>To avoid performance degradation caused by resource conflicts between applications scheduled on the same Kubernetes node, you can schedule Kafka pods separately from critical workloads.
This can be achieved by either selecting specific nodes or dedicating a set of nodes exclusively for Kafka.</p>
</div>
<div class="sect3">
<h4 id="affinity-str"><a class="link" href="#affinity-str">9.12.1. Specifying affinity, tolerations, and topology spread constraints</a></h4>
<div class="paragraph">
<p>Use affinity, tolerations and topology spread constraints to schedule the pods of kafka resources onto nodes.
Affinity, tolerations and topology spread constraints are configured using the <code>affinity</code>, <code>tolerations</code>, and <code>topologySpreadConstraint</code> properties in following resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Kafka.spec.kafka.template.pod</code></p>
</li>
<li>
<p><code>Kafka.spec.zookeeper.template.pod</code></p>
</li>
<li>
<p><code>Kafka.spec.entityOperator.template.pod</code></p>
</li>
<li>
<p><code>KafkaConnect.spec.template.pod</code></p>
</li>
<li>
<p><code>KafkaBridge.spec.template.pod</code></p>
</li>
<li>
<p><code>KafkaMirrorMaker.spec.template.pod</code></p>
</li>
<li>
<p><code>KafkaMirrorMaker2.spec.template.pod</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The format of the <code>affinity</code>, <code>tolerations</code>, and <code>topologySpreadConstraint</code> properties follows the Kubernetes specification.
The affinity configuration can include different types of affinity:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pod affinity and anti-affinity</p>
</li>
<li>
<p>Node affinity</p>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://kubernetes.io/docs/concepts/configuration/assign-pod-node/" target="_blank" rel="noopener">Kubernetes node and pod affinity documentation</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/" target="_blank" rel="noopener">Kubernetes taints and tolerations</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/" target="_blank" rel="noopener">Kubernetes Topology Spread Constraints</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="con-scheduling-based-on-other-pods-str"><a class="link" href="#con-scheduling-based-on-other-pods-str">Use pod anti-affinity to avoid critical applications sharing nodes</a></h5>
<div class="paragraph">
<p>Use pod anti-affinity to ensure that critical applications are never scheduled on the same disk.
When running a Kafka cluster, it is recommended to use pod anti-affinity to ensure that the Kafka brokers do not share nodes with other workloads, such as databases.</p>
</div>
</div>
<div class="sect4">
<h5 id="con-scheduling-to-specific-nodes-str"><a class="link" href="#con-scheduling-to-specific-nodes-str">Use node affinity to schedule workloads onto specific nodes</a></h5>
<div class="paragraph">
<p>The Kubernetes cluster usually consists of many different types of worker nodes.
Some are optimized for CPU heavy workloads, some for memory, while other might be optimized for storage (fast local SSDs) or network.
Using different nodes helps to optimize both costs and performance.
To achieve the best possible performance, it is important to allow scheduling of Strimzi components to use the right nodes.</p>
</div>
<div class="paragraph">
<p>Kubernetes uses node affinity to schedule workloads onto specific nodes.
Node affinity allows you to create a scheduling constraint for the node on which the pod will be scheduled.
The constraint is specified as a label selector.
You can specify the label using either the built-in node label like <code>beta.kubernetes.io/instance-type</code> or custom labels to select the right node.</p>
</div>
</div>
<div class="sect4">
<h5 id="con-dedicated-nodes-str"><a class="link" href="#con-dedicated-nodes-str">Use node affinity and tolerations for dedicated nodes</a></h5>
<div class="paragraph">
<p>Use taints to create dedicated nodes, then schedule Kafka pods on the dedicated nodes by configuring node affinity and tolerations.</p>
</div>
<div class="paragraph">
<p>Cluster administrators can mark selected Kubernetes nodes as tainted.
Nodes with taints are excluded from regular scheduling and normal pods will not be scheduled to run on them.
Only services which can tolerate the taint set on the node can be scheduled on it.
The only other services running on such nodes will be system services such as log collectors or software defined networks.</p>
</div>
<div class="paragraph">
<p>Running Kafka and its components on dedicated nodes can have many advantages.
There will be no other applications running on the same nodes which could cause disturbance or consume the resources needed for Kafka.
That can lead to improved performance and stability.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuring-pod-anti-affinity-to-schedule-each-kafka-broker-on-a-different-worker-node-str"><a class="link" href="#configuring-pod-anti-affinity-to-schedule-each-kafka-broker-on-a-different-worker-node-str">9.12.2. Configuring pod anti-affinity to schedule each Kafka broker on a different worker node</a></h4>
<div class="paragraph">
<p>Many Kafka brokers or ZooKeeper nodes can run on the same Kubernetes worker node.
If the worker node fails, they will all become unavailable at the same time.
To improve reliability, you can use <code>podAntiAffinity</code> configuration to schedule each Kafka broker or ZooKeeper node on a different Kubernetes worker node.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kubernetes cluster</p>
</li>
<li>
<p>A running Cluster Operator</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <code>affinity</code> property in the resource specifying the cluster deployment.
To make sure that no worker nodes are shared by Kafka brokers or ZooKeeper nodes, use the <code>strimzi.io/name</code> label.
Set the <code>topologyKey</code> to <code>kubernetes.io/hostname</code> to specify that the selected pods are not scheduled on nodes with the same hostname.
This will still allow the same worker node to be shared by a single Kafka broker and a single ZooKeeper node.
For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  kafka:
    # ...
    template:
      pod:
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: strimzi.io/name
                      operator: In
                      values:
                        - <em>CLUSTER-NAME</em>-kafka
                topologyKey: "kubernetes.io/hostname"
    # ...
  zookeeper:
    # ...
    template:
      pod:
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: strimzi.io/name
                      operator: In
                      values:
                        - <em>CLUSTER-NAME</em>-zookeeper
                topologyKey: "kubernetes.io/hostname"
    # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code><em>CLUSTER-NAME</em></code> is the name of your Kafka custom resource.</p>
</div>
</li>
<li>
<p>If you even want to make sure that a Kafka broker and ZooKeeper node do not share the same worker node, use the <code>strimzi.io/cluster</code> label.
For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  kafka:
    # ...
    template:
      pod:
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: strimzi.io/cluster
                      operator: In
                      values:
                        - <em>CLUSTER-NAME</em>
                topologyKey: "kubernetes.io/hostname"
    # ...
  zookeeper:
    # ...
    template:
      pod:
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: strimzi.io/cluster
                      operator: In
                      values:
                        - <em>CLUSTER-NAME</em>
                topologyKey: "kubernetes.io/hostname"
    # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code><em>CLUSTER-NAME</em></code> is the name of your Kafka custom resource.</p>
</div>
</li>
<li>
<p>Create or update the resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="configuring-pod-anti-affinity-in-kafka-components-str"><a class="link" href="#configuring-pod-anti-affinity-in-kafka-components-str">9.12.3. Configuring pod anti-affinity in Kafka components</a></h4>
<div class="paragraph">
<p>Pod anti-affinity configuration helps with the stability and performance of Kafka brokers. By using <code>podAntiAffinity</code>, Kubernetes will not schedule Kafka brokers on the same nodes as other workloads.
Typically, you want to avoid Kafka running on the same worker node as other network or storage intensive applications such as databases, storage or other messaging platforms.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kubernetes cluster</p>
</li>
<li>
<p>A running Cluster Operator</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <code>affinity</code> property in the resource specifying the cluster deployment.
Use labels to specify the pods which should not be scheduled on the same nodes.
The <code>topologyKey</code> should be set to <code>kubernetes.io/hostname</code> to specify that the selected pods should not be scheduled on nodes with the same hostname.
For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  kafka:
    # ...
    template:
      pod:
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: application
                      operator: In
                      values:
                        - postgresql
                        - mongodb
                topologyKey: "kubernetes.io/hostname"
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Create or update the resource.</p>
<div class="paragraph">
<p>This can be done using <code>kubectl apply</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-configuring-node-affinity-str"><a class="link" href="#proc-configuring-node-affinity-str">9.12.4. Configuring node affinity in Kafka components</a></h4>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kubernetes cluster</p>
</li>
<li>
<p>A running Cluster Operator</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Label the nodes where Strimzi components should be scheduled.</p>
<div class="paragraph">
<p>This can be done using <code>kubectl label</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl label node <em>NAME-OF-NODE</em> node-type=fast-network</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, some of the existing labels might be reused.</p>
</div>
</li>
<li>
<p>Edit the <code>affinity</code> property in the resource specifying the cluster deployment.
For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  kafka:
    # ...
    template:
      pod:
        affinity:
          nodeAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              nodeSelectorTerms:
                - matchExpressions:
                  - key: node-type
                    operator: In
                    values:
                    - fast-network
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Create or update the resource.</p>
<div class="paragraph">
<p>This can be done using <code>kubectl apply</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-dedicated-nodes-str"><a class="link" href="#proc-dedicated-nodes-str">9.12.5. Setting up dedicated nodes and scheduling pods on them</a></h4>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kubernetes cluster</p>
</li>
<li>
<p>A running Cluster Operator</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Select the nodes which should be used as dedicated.</p>
</li>
<li>
<p>Make sure there are no workloads scheduled on these nodes.</p>
</li>
<li>
<p>Set the taints on the selected nodes:</p>
<div class="paragraph">
<p>This can be done using <code>kubectl taint</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl taint node <em>NAME-OF-NODE</em> dedicated=Kafka:NoSchedule</code></pre>
</div>
</div>
</li>
<li>
<p>Additionally, add a label to the selected nodes as well.</p>
<div class="paragraph">
<p>This can be done using <code>kubectl label</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl label node <em>NAME-OF-NODE</em> dedicated=Kafka</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>affinity</code> and <code>tolerations</code> properties in the resource specifying the cluster deployment.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  kafka:
    # ...
    template:
      pod:
        tolerations:
          - key: "dedicated"
            operator: "Equal"
            value: "Kafka"
            effect: "NoSchedule"
        affinity:
          nodeAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              nodeSelectorTerms:
              - matchExpressions:
                - key: dedicated
                  operator: In
                  values:
                  - Kafka
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Create or update the resource.</p>
<div class="paragraph">
<p>This can be done using <code>kubectl apply</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="external-logging_str"><a class="link" href="#external-logging_str">9.13. Configuring logging levels</a></h3>
<div class="paragraph _abstract">
<p>Configure logging levels in the custom resources of Kafka components and Strimzi operators.
You can specify the logging levels directly in the <code>spec.logging</code> property of the custom resource.
Or you can define the logging properties in a ConfigMap that&#8217;s referenced in the custom resource using the <code>configMapKeyRef</code> property.</p>
</div>
<div class="paragraph">
<p>The advantages of using a ConfigMap are that the logging properties are maintained in one place and are accessible to more than one resource.
You can also reuse the ConfigMap for more than one resource.
If you are using a ConfigMap to specify loggers for Strimzi Operators, you can also append the logging specification to add filters.</p>
</div>
<div class="paragraph">
<p>You specify a logging <code>type</code> in your logging specification:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>inline</code> when specifying logging levels directly</p>
</li>
<li>
<p><code>external</code> when referencing a ConfigMap</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example <code>inline</code> logging configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">spec:
  # ...
  logging:
    type: inline
    loggers:
      kafka.root.logger.level: INFO</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example <code>external</code> logging configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">spec:
  # ...
  logging:
    type: external
    valueFrom:
      configMapKeyRef:
        name: my-config-map
        key: my-config-map-key</code></pre>
</div>
</div>
<div class="paragraph">
<p>Values for the <code>name</code> and <code>key</code> of the ConfigMap are mandatory.
Default logging is used if the <code>name</code> or <code>key</code> is not set.</p>
</div>
<div class="sect3">
<h4 id="logging_options_for_kafka_components_and_operators"><a class="link" href="#logging_options_for_kafka_components_and_operators">9.13.1. Logging options for Kafka components and operators</a></h4>
<div class="paragraph">
<p>For more information on configuring logging for specific Kafka components or operators, see the following sections.</p>
</div>
<div class="ulist">
<div class="title">Kafka component logging</div>
<ul>
<li>
<p><a href="./configuring.html#property-kafka-logging-reference" target="_blank" rel="noopener">Kafka logging</a></p>
</li>
<li>
<p><a href="./configuring.html#property-zookeeper-logging-reference" target="_blank" rel="noopener">ZooKeeper logging</a></p>
</li>
<li>
<p><a href="./configuring.html#property-kafka-connect-logging-reference" target="_blank" rel="noopener">Kafka Connect and MirrorMaker 2 logging</a></p>
</li>
<li>
<p><a href="./configuring.html#property-mm-loggers-reference" target="_blank" rel="noopener">MirrorMaker logging</a></p>
</li>
<li>
<p><a href="./configuring.html#property-kafka-bridge-logging-reference" target="_blank" rel="noopener">Kafka Bridge logging</a></p>
</li>
<li>
<p><a href="./configuring.html#property-cruise-control-logging-reference" target="_blank" rel="noopener">Cruise Control logging</a></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Operator logging</div>
<ul>
<li>
<p><a href="#ref-operator-cluster-logging-configmap-str">Cluster Operator logging</a></p>
</li>
<li>
<p><a href="./configuring.html#property-topic-operator-logging-reference" target="_blank" rel="noopener">Topic Operator logging</a></p>
</li>
<li>
<p><a href="./configuring.html#property-user-operator-logging-reference" target="_blank" rel="noopener">User Operator logging</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="creating-configmap_str"><a class="link" href="#creating-configmap_str">9.13.2. Creating a ConfigMap for logging</a></h4>
<div class="paragraph _abstract">
<p>To use a ConfigMap to define logging properties, you create the ConfigMap and then reference it as part of the logging definition in the <code>spec</code> of a resource.</p>
</div>
<div class="paragraph">
<p>The ConfigMap must contain the appropriate logging configuration.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>log4j.properties</code> for Kafka components, ZooKeeper, and the Kafka Bridge</p>
</li>
<li>
<p><code>log4j2.properties</code> for the Topic Operator and User Operator</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The configuration must be placed under these properties.</p>
</div>
<div class="paragraph">
<p>In this procedure a ConfigMap defines a root logger for a Kafka resource.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create the ConfigMap.</p>
<div class="paragraph">
<p>You can create the ConfigMap as a YAML file or from a properties file.</p>
</div>
<div class="paragraph">
<p>ConfigMap example with a root logger definition for Kafka:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: ConfigMap
apiVersion: v1
metadata:
  name: logging-configmap
data:
  log4j.properties:
    kafka.root.logger.level="INFO"</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are using a properties file, specify the file at the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create configmap logging-configmap --from-file=log4j.properties</code></pre>
</div>
</div>
<div class="paragraph">
<p>The properties file defines the logging configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text"># Define the logger
kafka.root.logger.level="INFO"
# ...</code></pre>
</div>
</div>
</li>
<li>
<p>Define <em>external</em> logging in the <code>spec</code> of the resource, setting the <code>logging.valueFrom.configMapKeyRef.name</code> to the name of the ConfigMap and <code>logging.valueFrom.configMapKeyRef.key</code> to the key in this ConfigMap.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">spec:
  # ...
  logging:
    type: external
    valueFrom:
      configMapKeyRef:
        name: logging-configmap
        key: log4j.properties</code></pre>
</div>
</div>
</li>
<li>
<p>Create or update the resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="ref-operator-cluster-logging-configmap-str"><a class="link" href="#ref-operator-cluster-logging-configmap-str">9.13.3. Configuring Cluster Operator logging</a></h4>
<div class="paragraph _abstract">
<p>Cluster Operator logging is configured through a <code>ConfigMap</code> named <code>strimzi-cluster-operator</code>.
A <code>ConfigMap</code> containing logging configuration is created when installing the Cluster Operator.
This <code>ConfigMap</code> is described in the file <code>install/cluster-operator/050-ConfigMap-strimzi-cluster-operator.yaml</code>.
You configure Cluster Operator logging by changing the <code>data.log4j2.properties</code> values in this <code>ConfigMap</code>.</p>
</div>
<div class="paragraph">
<p>To update the logging configuration, you can edit the <code>050-ConfigMap-strimzi-cluster-operator.yaml</code> file and then run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f <em>install/cluster-operator/050-ConfigMap-strimzi-cluster-operator.yaml</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, edit the <code>ConfigMap</code> directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit configmap strimzi-cluster-operator</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this ConfigMap, you can control various aspects of logging, including the root logger level, log output format, and log levels for different components.
The <code>monitorInterval</code> setting, determines how often the logging configuration is reloaded.
You can also control the logging levels for the Kafka <code>AdminClient</code>, ZooKeeper <code>ZKTrustManager</code>, Netty, and the OkHttp client.
Netty is a framework used in Strimzi for network communication, and OkHttp is a library used for making HTTP requests.</p>
</div>
<div class="paragraph">
<p>If the <code>ConfigMap</code> is missing when the Cluster Operator is deployed, the default logging values are used.</p>
</div>
<div class="paragraph">
<p>If the <code>ConfigMap</code> is accidentally deleted after the Cluster Operator is deployed, the most recently loaded logging configuration is used.
Create a new <code>ConfigMap</code> to load a new logging configuration.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Do not remove the <code>monitorInterval</code> option from the <code>ConfigMap</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="creating-logging-filters_str"><a class="link" href="#creating-logging-filters_str">9.13.4. Adding logging filters to Strimzi operators</a></h4>
<div class="paragraph _abstract">
<p>If you are using a ConfigMap to configure the (log4j2) logging levels for Strimzi operators,
you can also define logging filters to limit what&#8217;s returned in the log.</p>
</div>
<div class="paragraph">
<p>Logging filters are useful when you have a large number of logging messages.
Suppose you set the log level for the logger as DEBUG (<code>rootLogger.level="DEBUG"</code>).
Logging filters reduce the number of logs returned for the logger at that level, so you can focus on a specific resource.
When the filter is set, only log messages matching the filter are logged.</p>
</div>
<div class="paragraph">
<p>Filters use <em>markers</em> to specify what to include in the log.
You specify a kind, namespace and name for the marker.
For example, if a Kafka cluster is failing, you can isolate the logs by specifying the kind as <code>Kafka</code>, and use the namespace and name of the failing cluster.</p>
</div>
<div class="paragraph">
<p>This example shows a marker filter for a Kafka cluster named <code>my-kafka-cluster</code>.</p>
</div>
<div class="listingblock">
<div class="title">Basic logging filter configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">rootLogger.level="INFO"
appender.console.filter.filter1.type=MarkerFilter <b class="conum">(1)</b>
appender.console.filter.filter1.onMatch=ACCEPT <b class="conum">(2)</b>
appender.console.filter.filter1.onMismatch=DENY <b class="conum">(3)</b>
appender.console.filter.filter1.marker=Kafka(my-namespace/my-kafka-cluster) <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>MarkerFilter</code> type compares a specified marker for filtering.</p>
</li>
<li>
<p>The <code>onMatch</code> property accepts the log if the marker matches.</p>
</li>
<li>
<p>The <code>onMismatch</code> property rejects the log if the marker does not match.</p>
</li>
<li>
<p>The marker used for filtering is in the format <em>KIND(NAMESPACE/NAME-OF-RESOURCE)</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can create one or more filters.
Here, the log is filtered for two Kafka clusters.</p>
</div>
<div class="listingblock">
<div class="title">Multiple logging filter configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">appender.console.filter.filter1.type=MarkerFilter
appender.console.filter.filter1.onMatch=ACCEPT
appender.console.filter.filter1.onMismatch=DENY
appender.console.filter.filter1.marker=Kafka(my-namespace/my-kafka-cluster-1)
appender.console.filter.filter2.type=MarkerFilter
appender.console.filter.filter2.onMatch=ACCEPT
appender.console.filter.filter2.onMismatch=DENY
appender.console.filter.filter2.marker=Kafka(my-namespace/my-kafka-cluster-2)</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Adding filters to the Cluster Operator</div>
<p>To add filters to the Cluster Operator, update its logging ConfigMap YAML file (<code>install/cluster-operator/050-ConfigMap-strimzi-cluster-operator.yaml</code>).</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Update the <code>050-ConfigMap-strimzi-cluster-operator.yaml</code> file to add the filter properties to the ConfigMap.</p>
<div class="paragraph">
<p>In this example, the filter properties return logs only for the <code>my-kafka-cluster</code> Kafka cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: ConfigMap
apiVersion: v1
metadata:
  name: strimzi-cluster-operator
data:
  log4j2.properties:
    #...
    appender.console.filter.filter1.type=MarkerFilter
    appender.console.filter.filter1.onMatch=ACCEPT
    appender.console.filter.filter1.onMismatch=DENY
    appender.console.filter.filter1.marker=Kafka(my-namespace/my-kafka-cluster)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, edit the <code>ConfigMap</code> directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit configmap strimzi-cluster-operator</code></pre>
</div>
</div>
</li>
<li>
<p>If you updated the YAML file instead of editing the <code>ConfigMap</code> directly, apply the changes by deploying the ConfigMap:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/cluster-operator/050-ConfigMap-strimzi-cluster-operator.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Adding filters to the Topic Operator or User Operator</div>
<p>To add filters to the Topic Operator or User Operator, create or edit a logging ConfigMap.</p>
</div>
<div class="paragraph">
<p>In this procedure a logging ConfigMap is created with filters for the Topic Operator.
The same approach is used for the User Operator.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create the ConfigMap.</p>
<div class="paragraph">
<p>You can create the ConfigMap as a YAML file or from a properties file.</p>
</div>
<div class="paragraph">
<p>In this example, the filter properties return logs only for the <code>my-topic</code> topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: ConfigMap
apiVersion: v1
metadata:
  name: logging-configmap
data:
  log4j2.properties:
    rootLogger.level="INFO"
    appender.console.filter.filter1.type=MarkerFilter
    appender.console.filter.filter1.onMatch=ACCEPT
    appender.console.filter.filter1.onMismatch=DENY
    appender.console.filter.filter1.marker=KafkaTopic(my-namespace/my-topic)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are using a properties file, specify the file at the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create configmap logging-configmap --from-file=log4j2.properties</code></pre>
</div>
</div>
<div class="paragraph">
<p>The properties file defines the logging configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text"># Define the logger
rootLogger.level="INFO"
# Set the filters
appender.console.filter.filter1.type=MarkerFilter
appender.console.filter.filter1.onMatch=ACCEPT
appender.console.filter.filter1.onMismatch=DENY
appender.console.filter.filter1.marker=KafkaTopic(my-namespace/my-topic)
# ...</code></pre>
</div>
</div>
</li>
<li>
<p>Define <em>external</em> logging in the <code>spec</code> of the resource, setting the <code>logging.valueFrom.configMapKeyRef.name</code> to the name of the ConfigMap and <code>logging.valueFrom.configMapKeyRef.key</code> to the key in this ConfigMap.</p>
<div class="paragraph">
<p>For the Topic Operator, logging is specified in the <code>topicOperator</code> configuration of the <code>Kafka</code> resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">spec:
  # ...
  entityOperator:
    topicOperator:
      logging:
        type: external
        valueFrom:
          configMapKeyRef:
            name: logging-configmap
            key: log4j2.properties</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the changes by deploying the Cluster Operator:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">create -f install/cluster-operator -n my-cluster-operator-namespace</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#con-config-kafka-str">Configuring Kafka</a></p>
</li>
<li>
<p><a href="#ref-operator-cluster-logging-configmap-str">Cluster Operator logging</a></p>
</li>
<li>
<p><a href="./configuring.html#property-topic-operator-logging-reference" target="_blank" rel="noopener">Topic Operator logging</a></p>
</li>
<li>
<p><a href="./configuring.html#property-user-operator-logging-reference" target="_blank" rel="noopener">User Operator logging</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-points-configmaps-str"><a class="link" href="#configuration-points-configmaps-str">9.14. Using ConfigMaps to add configuration</a></h3>
<div class="paragraph _abstract">
<p>Add specific configuration to your Strimzi deployment using <code>ConfigMap</code> resources.
ConfigMaps use key-value pairs to store non-confidential data.
Configuration data added to ConfigMaps is maintained in one place and can be reused amongst components.</p>
</div>
<div class="paragraph">
<p>ConfigMaps can only store the following types of configuration data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Logging configuration</p>
</li>
<li>
<p>Metrics configuration</p>
</li>
<li>
<p>External configuration for Kafka Connect connectors</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can&#8217;t use ConfigMaps for other areas of configuration.</p>
</div>
<div class="paragraph">
<p>When you configure a component, you can add a reference to a ConfigMap using the <code>configMapKeyRef</code> property.</p>
</div>
<div class="paragraph">
<p>For example, you can use <code>configMapKeyRef</code> to reference a ConfigMap that provides configuration for logging.
You might use a ConfigMap to pass a Log4j configuration file.
You add the reference to the <code>logging</code> configuration.</p>
</div>
<div class="listingblock">
<div class="title">Example ConfigMap for logging</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">spec:
  # ...
  logging:
    type: external
    valueFrom:
      configMapKeyRef:
        name: my-config-map
        key: my-config-map-key</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use a ConfigMap for metrics configuration, you add a reference to the <code>metricsConfig</code> configuration of the component in the same way.</p>
</div>
<div class="paragraph">
<p><code>ExternalConfiguration</code> properties make data from a ConfigMap (or Secret) mounted to a pod available as environment variables or volumes.
You can use external configuration data for the connectors used by Kafka Connect.
The data might be related to an external data source, providing the values needed for the connector to communicate with that data source.</p>
</div>
<div class="paragraph">
<p>For example, you can use the <code>configMapKeyRef</code> property to pass configuration data from a ConfigMap as an environment variable.</p>
</div>
<div class="listingblock">
<div class="title">Example ConfigMap providing environment variable values</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect
spec:
  # ...
  externalConfiguration:
    env:
      - name: MY_ENVIRONMENT_VARIABLE
        valueFrom:
          configMapKeyRef:
            name: my-config-map
            key: my-key</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are using ConfigMaps that are managed externally, use configuration providers to load the data in the ConfigMaps.</p>
</div>
<div class="sect3">
<h4 id="naming_custom_configmaps"><a class="link" href="#naming_custom_configmaps">9.14.1. Naming custom ConfigMaps</a></h4>
<div class="paragraph">
<p>Strimzi <a href="#ref-list-of-kafka-cluster-resources-str">creates its own ConfigMaps and other resources</a> when it is deployed to Kubernetes.
The ConfigMaps contain data necessary for running components.
The ConfigMaps created by Strimzi must not be edited.</p>
</div>
<div class="paragraph">
<p>Make sure that any custom ConfigMaps you create do not have the same name as these default ConfigMaps. If they have the same name, they will be overwritten. For example, if your ConfigMap has the same name as the ConfigMap for the Kafka cluster, it will be overwritten when there is an update to the Kafka cluster.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#ref-list-of-kafka-cluster-resources-str">List of Kafka cluster resources</a> (including ConfigMaps)</p>
</li>
<li>
<p><a href="#external-logging_str">Logging configuration</a></p>
</li>
<li>
<p><a href="./configuring.html#con-common-configuration-prometheus-reference" target="_blank" rel="noopener"><code>metricsConfig</code></a></p>
</li>
<li>
<p><a href="./configuring.html#type-ExternalConfiguration-reference" target="_blank" rel="noopener"><code>ExternalConfiguration</code> schema reference</a></p>
</li>
<li>
<p><a href="#assembly-loading-config-with-providers-str">Loading configuration values from external sources</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-loading-config-with-providers-str"><a class="link" href="#assembly-loading-config-with-providers-str">9.15. Loading configuration values from external sources</a></h3>
<div class="paragraph _abstract">
<p>Use configuration providers to load configuration data from external sources.
The providers operate independently of Strimzi.
You can use them to load configuration data for all Kafka components, including producers and consumers.
You reference the external source in the configuration of the component and provide access rights.
The provider loads data without needing to restart the Kafka component or extracting files, even when referencing a new external source.
For example, use providers to supply the credentials for the Kafka Connect connector configuration.
The configuration must include any access rights to the external source.</p>
</div>
<div class="sect3">
<h4 id="con-loading-config-from-env-vars-str"><a class="link" href="#con-loading-config-from-env-vars-str">9.15.1. Enabling configuration providers</a></h4>
<div class="paragraph _abstract">
<p>You can enable one or more configuration providers using the <code>config.providers</code> properties in the <code>spec</code> configuration of a component.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration to enable a configuration provider</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect
  annotations:
    strimzi.io/use-connector-resources: "true"
spec:
  # ...
  config:
    # ...
    config.providers: env
    config.providers.env.class: org.apache.kafka.common.config.provider.EnvVarConfigProvider
  # ...</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">KubernetesSecretConfigProvider</dt>
<dd>
<p>Loads configuration data from Kubernetes secrets.
You specify the name of the secret and the key within the secret where the configuration data is stored.
This provider is useful for storing sensitive configuration data like passwords or other user credentials.</p>
</dd>
<dt class="hdlist1">KubernetesConfigMapConfigProvider</dt>
<dd>
<p>Loads configuration data from Kubernetes config maps.
You specify the name of the config map and the key within the config map where the configuration data is stored.
This provider is useful for storing non-sensitive configuration data.</p>
</dd>
<dt class="hdlist1">EnvVarConfigProvider</dt>
<dd>
<p>Loads configuration data from environment variables.
You specify the name of the environment variable where the configuration data is stored.
This provider is useful for configuring applications running in containers, for example, to load certificates or JAAS configuration from environment variables mapped from secrets.</p>
</dd>
<dt class="hdlist1">FileConfigProvider</dt>
<dd>
<p>Loads configuration data from a file.
You specify the path to the file where the configuration data is stored.
This provider is useful for loading configuration data from files that are mounted into containers.</p>
</dd>
<dt class="hdlist1">DirectoryConfigProvider</dt>
<dd>
<p>Loads configuration data from files within a directory.
You specify the path to the directory where the configuration files are stored.
This provider is useful for loading multiple configuration files and for organizing configuration data into separate files.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To use <code>KubernetesSecretConfigProvider</code> and <code>KubernetesConfigMapConfigProvider</code>, which are part of the Kubernetes Configuration Provider plugin, you must set up access rights to the namespace that contains the configuration file.</p>
</div>
<div class="paragraph">
<p>You can use the other providers without setting up access rights.
You can supply connector configuration for Kafka Connect or MirrorMaker 2 in this way by doing the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mount config maps or secrets into the Kafka Connect pod as environment variables or volumes</p>
</li>
<li>
<p>Enable <code>EnvVarConfigProvider</code>, <code>FileConfigProvider</code>, or <code>DirectoryConfigProvider</code> in the Kafka Connect or MirrorMaker 2 configuration</p>
</li>
<li>
<p>Pass connector configuration using the <code>externalConfiguration</code> property in the <code>spec</code> of the <code>KafkaConnect</code> or <code>KafkaMirrorMaker2</code> resource</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using providers help prevent the passing of restricted information through the Kafka Connect REST interface.
You can use this approach in the following scenarios:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mounting environment variables with the values a connector uses to connect and communicate with a data source</p>
</li>
<li>
<p>Mounting a properties file with values that are used to configure Kafka Connect connectors</p>
</li>
<li>
<p>Mounting files in a directory that contains values for the TLS truststore and keystore used by a connector</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
A restart is required when using a new <code>Secret</code> or <code>ConfigMap</code> for a connector, which can disrupt other connectors.
</td>
</tr>
</table>
</div>
<div class="paragraph _additional-resources">
<div class="title">Additional resources</div>
<p><a href="./configuring.html#type-ExternalConfiguration-reference" target="_blank" rel="noopener"><code>ExternalConfiguration</code> schema reference</a></p>
</div>
</div>
<div class="sect3">
<h4 id="proc-loading-config-from-config-map-str"><a class="link" href="#proc-loading-config-from-config-map-str">9.15.2. Loading configuration values from secrets or config maps</a></h4>
<div class="paragraph _abstract">
<p>Use the <code>KubernetesSecretConfigProvider</code> to provide configuration properties from a secret or the <code>KubernetesConfigMapConfigProvider</code> to provide configuration properties from a config map.</p>
</div>
<div class="paragraph">
<p>In this procedure, a config map provides configuration properties for a connector.
The properties are specified as key values of the config map.
The config map is mounted into the Kafka Connect pod as a volume.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kafka cluster is running.</p>
</li>
<li>
<p>The Cluster Operator is running.</p>
</li>
<li>
<p>You have a config map containing the connector configuration.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example config map with connector properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: my-connector-configuration
data:
  option1: value1
  option2: value2</code></pre>
</div>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure the <code>KafkaConnect</code> resource.</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Enable the <code>KubernetesConfigMapConfigProvider</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>The specification shown here can support loading values from config maps and secrets.</p>
</div>
<div class="listingblock">
<div class="title">Example Kafka Connect configuration to use config maps and secrets</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect
  annotations:
    strimzi.io/use-connector-resources: "true"
spec:
  # ...
  config:
    # ...
    config.providers: secrets,configmaps # <b class="conum">(1)</b>
    config.providers.configmaps.class: io.strimzi.kafka.KubernetesConfigMapConfigProvider # <b class="conum">(2)</b>
    config.providers.secrets.class: io.strimzi.kafka.KubernetesSecretConfigProvider # <b class="conum">(3)</b>
  # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The alias for the configuration provider is used to define other configuration parameters.
The provider parameters use the alias from <code>config.providers</code>, taking the form <code>config.providers.${alias}.class</code>.</p>
</li>
<li>
<p><code>KubernetesConfigMapConfigProvider</code> provides values from config maps.</p>
</li>
<li>
<p><code>KubernetesSecretConfigProvider</code> provides values from secrets.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create or update the resource to enable the provider.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f &lt;kafka_connect_configuration_file&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Create a role that permits access to the values in the external config map.</p>
<div class="listingblock">
<div class="title">Example role to access values from a config map</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: connector-configuration-role
rules:
- apiGroups: [""]
  resources: ["configmaps"]
  resourceNames: ["my-connector-configuration"]
  verbs: ["get"]
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rule gives the role permission to access the <code>my-connector-configuration</code> config map.</p>
</div>
</li>
<li>
<p>Create a role binding to permit access to the namespace that contains the config map.</p>
<div class="listingblock">
<div class="title">Example role binding to access the namespace that contains the config map</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: connector-configuration-role-binding
subjects:
- kind: ServiceAccount
  name: my-connect-connect
  namespace: my-project
roleRef:
  kind: Role
  name: connector-configuration-role
  apiGroup: rbac.authorization.k8s.io
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The role binding gives the role permission to access the <code>my-project</code> namespace.</p>
</div>
<div class="paragraph">
<p>The service account must be the same one used by the Kafka Connect deployment.
The service account name format is <code>&lt;cluster_name&gt;-connect</code>, where <code>&lt;cluster_name&gt;</code> is the name of the <code>KafkaConnect</code> custom resource.</p>
</div>
</li>
<li>
<p>Reference the config map in the connector configuration.</p>
<div class="listingblock">
<div class="title">Example connector configuration referencing the config map</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: my-connector
  labels:
    strimzi.io/cluster: my-connect
spec:
  # ...
  config:
    option: ${configmaps:my-project/my-connector-configuration:option1}
    # ...
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The placeholder structure is <code>configmaps:&lt;path_and_file_name&gt;:&lt;property&gt;</code>.
<code>KubernetesConfigMapConfigProvider</code> reads and extracts the <code>option1</code> property value from the external config map.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-loading-config-from-env-vars-str"><a class="link" href="#proc-loading-config-from-env-vars-str">9.15.3. Loading configuration values from environment variables</a></h4>
<div class="paragraph _abstract">
<p>Use the <code>EnvVarConfigProvider</code> to provide configuration properties as environment variables.
Environment variables can contain values from config maps or secrets.</p>
</div>
<div class="paragraph">
<p>In this procedure, environment variables provide configuration properties for a connector to communicate with Amazon AWS.
The connector must be able to read the <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code>.
The values of the environment variables are derived from a secret mounted into the Kafka Connect pod.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The names of user-defined environment variables cannot start with <code>KAFKA_</code> or <code>STRIMZI_</code>.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kafka cluster is running.</p>
</li>
<li>
<p>The Cluster Operator is running.</p>
</li>
<li>
<p>You have a secret containing the connector configuration.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example secret with values for environment variables</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: aws-creds
type: Opaque
data:
  awsAccessKey: QUtJQVhYWFhYWFhYWFhYWFg=
  awsSecretAccessKey: Ylhsd1lYTnpkMjl5WkE=</code></pre>
</div>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure the <code>KafkaConnect</code> resource.</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Enable the <code>EnvVarConfigProvider</code></p>
</li>
<li>
<p>Specify the environment variables using the <code>externalConfiguration</code> property.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Example Kafka Connect configuration to use external environment variables</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect
  annotations:
    strimzi.io/use-connector-resources: "true"
spec:
  # ...
  config:
    # ...
    config.providers: env # <b class="conum">(1)</b>
    config.providers.env.class: org.apache.kafka.common.config.provider.EnvVarConfigProvider # <b class="conum">(2)</b>
  # ...
  externalConfiguration:
    env:
      - name: AWS_ACCESS_KEY_ID # <b class="conum">(3)</b>
        valueFrom:
          secretKeyRef:
            name: aws-creds # <b class="conum">(4)</b>
            key: awsAccessKey # <b class="conum">(5)</b>
      - name: AWS_SECRET_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: aws-creds
            key: awsSecretAccessKey
  # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The alias for the configuration provider is used to define other configuration parameters.
The provider parameters use the alias from <code>config.providers</code>, taking the form <code>config.providers.${alias}.class</code>.</p>
</li>
<li>
<p><code>EnvVarConfigProvider</code> provides values from environment variables.</p>
</li>
<li>
<p>The environment variable takes a value from the secret.</p>
</li>
<li>
<p>The name of the secret containing the environment variable.</p>
</li>
<li>
<p>The name of the key stored in the secret.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>secretKeyRef</code> property references keys in a secret.
If you are using a config map instead of a secret, use the <code>configMapKeyRef</code> property.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create or update the resource to enable the provider.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f &lt;kafka_connect_configuration_file&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Reference the environment variable in the connector configuration.</p>
<div class="listingblock">
<div class="title">Example connector configuration referencing the environment variable</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: my-connector
  labels:
    strimzi.io/cluster: my-connect
spec:
  # ...
  config:
    option: ${env:AWS_ACCESS_KEY_ID}
    option: ${env:AWS_SECRET_ACCESS_KEY}
    # ...
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The placeholder structure is <code>env:&lt;environment_variable_name&gt;</code>.
<code>EnvVarConfigProvider</code> reads and extracts the environment variable values from the mounted secret.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-loading-config-from-file-str"><a class="link" href="#proc-loading-config-from-file-str">9.15.4. Loading configuration values from a file within a directory</a></h4>
<div class="paragraph _abstract">
<p>Use the <code>FileConfigProvider</code> to provide configuration properties from a file within a directory.
Files can be config maps or secrets.</p>
</div>
<div class="paragraph">
<p>In this procedure, a file provides configuration properties for a connector.
A database name and password are specified as properties of a secret.
The secret is mounted to the Kafka Connect pod as a volume.
Volumes are mounted on the path <code>/opt/kafka/external-configuration/&lt;volume-name&gt;</code>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kafka cluster is running.</p>
</li>
<li>
<p>The Cluster Operator is running.</p>
</li>
<li>
<p>You have a secret containing the connector configuration.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example secret with database properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: mysecret
type: Opaque
stringData:
  connector.properties: |- # <b class="conum">(1)</b>
    dbUsername: my-username # <b class="conum">(2)</b>
    dbPassword: my-password</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The connector configuration in properties file format.</p>
</li>
<li>
<p>Database username and password properties used in the configuration.</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure the <code>KafkaConnect</code> resource.</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Enable the <code>FileConfigProvider</code></p>
</li>
<li>
<p>Specify the file using the <code>externalConfiguration</code> property.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Example Kafka Connect configuration to use an external property file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect
spec:
  # ...
  config:
    config.providers: file # <b class="conum">(1)</b>
    config.providers.file.class: org.apache.kafka.common.config.provider.FileConfigProvider # <b class="conum">(2)</b>
  #...
  externalConfiguration:
    volumes:
      - name: connector-config # <b class="conum">(3)</b>
        secret:
          secretName: mysecret # <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The alias for the configuration provider is used to define other configuration parameters.</p>
</li>
<li>
<p><code>FileConfigProvider</code> provides values from properties files.
The parameter uses the alias from <code>config.providers</code>, taking the form <code>config.providers.${alias}.class</code>.</p>
</li>
<li>
<p>The name of the volume containing the secret.</p>
</li>
<li>
<p>The name of the secret.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create or update the resource to enable the provider.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f &lt;kafka_connect_configuration_file&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Reference the file properties in the connector configuration as placeholders.</p>
<div class="listingblock">
<div class="title">Example connector configuration referencing the file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: my-source-connector
  labels:
    strimzi.io/cluster: my-connect-cluster
spec:
  class: io.debezium.connector.mysql.MySqlConnector
  tasksMax: 2
  config:
    database.hostname: 192.168.99.1
    database.port: "3306"
    database.user: "${file:/opt/kafka/external-configuration/connector-config/mysecret:dbUsername}"
    database.password: "${file:/opt/kafka/external-configuration/connector-config/mysecret:dbPassword}"
    database.server.id: "184054"
    #...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The placeholder structure is <code>file:&lt;path_and_file_name&gt;:&lt;property&gt;</code>.
<code>FileConfigProvider</code> reads and extracts the database username and password property values from the mounted secret.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-loading-config-from-files-str"><a class="link" href="#proc-loading-config-from-files-str">9.15.5. Loading configuration values from multiple files within a directory</a></h4>
<div class="paragraph _abstract">
<p>Use the <code>DirectoryConfigProvider</code> to provide configuration properties from multiple files within a directory.
Files can be config maps or secrets.</p>
</div>
<div class="paragraph">
<p>In this procedure, a secret provides the TLS keystore and truststore user credentials for a connector.
The credentials are in separate files.
The secrets are mounted into the Kafka Connect pod as volumes.
Volumes are mounted on the path <code>/opt/kafka/external-configuration/&lt;volume-name&gt;</code>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kafka cluster is running.</p>
</li>
<li>
<p>The Cluster Operator is running.</p>
</li>
<li>
<p>You have a secret containing the user credentials.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example secret with user credentials</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: my-user
  labels:
    strimzi.io/kind: KafkaUser
    strimzi.io/cluster: my-cluster
type: Opaque
data:
  ca.crt: <em>&lt;public_key&gt;</em> # Public key of the clients CA
  user.crt: <em>&lt;user_certificate&gt;</em> # Public key of the user
  user.key: <em>&lt;user_private_key&gt;</em> # Private key of the user
  user.p12: <em>&lt;store&gt;</em> # PKCS #12 store for user certificates and keys
  user.password: <em>&lt;password_for_store&gt;</em> # Protects the PKCS #12 store</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>my-user</code> secret provides the keystore credentials (<code>user.crt</code> and <code>user.key</code>) for the connector.</p>
</div>
<div class="paragraph">
<p>The <code>&lt;cluster_name&gt;-cluster-ca-cert</code> secret generated when deploying the Kafka cluster provides the cluster CA certificate as truststore credentials (<code>ca.crt</code>).</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure the <code>KafkaConnect</code> resource.</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Enable the <code>DirectoryConfigProvider</code></p>
</li>
<li>
<p>Specify the files using the <code>externalConfiguration</code> property.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Example Kafka Connect configuration to use external property files</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect
spec:
  # ...
  config:
    config.providers: directory # <b class="conum">(1)</b>
    config.providers.directory.class: org.apache.kafka.common.config.provider.DirectoryConfigProvider # <b class="conum">(2)</b>
  #...
  externalConfiguration:
    volumes: # <b class="conum">(3)</b>
      - name: cluster-ca # <b class="conum">(4)</b>
        secret:
          secretName: my-cluster-cluster-ca-cert # <b class="conum">(5)</b>
      - name: my-user
        secret:
          secretName: my-user # <b class="conum">(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The alias for the configuration provider is used to define other configuration parameters.</p>
</li>
<li>
<p><code>DirectoryConfigProvider</code> provides values from files in a directory. The parameter uses the alias from <code>config.providers</code>, taking the form <code>config.providers.${alias}.class</code>.</p>
</li>
<li>
<p>The names of the volumes containing the secrets.</p>
</li>
<li>
<p>The name of the secret for the cluster CA certificate to supply truststore configuration.</p>
</li>
<li>
<p>The name of the secret for the user to supply keystore configuration.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create or update the resource to enable the provider.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f &lt;kafka_connect_configuration_file&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Reference the file properties in the connector configuration as placeholders.</p>
<div class="listingblock">
<div class="title">Example connector configuration referencing the files</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: my-source-connector
  labels:
    strimzi.io/cluster: my-connect-cluster
spec:
  class: io.debezium.connector.mysql.MySqlConnector
  tasksMax: 2
  config:
    # ...
    database.history.producer.security.protocol: SSL
    database.history.producer.ssl.truststore.type: PEM
    database.history.producer.ssl.truststore.certificates: "${directory:/opt/kafka/external-configuration/cluster-ca:ca.crt}"
    database.history.producer.ssl.keystore.type: PEM
    database.history.producer.ssl.keystore.certificate.chain: "${directory:/opt/kafka/external-configuration/my-user:user.crt}"
    database.history.producer.ssl.keystore.key: "${directory:/opt/kafka/external-configuration/my-user:user.key}"
    #...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The placeholder structure is <code>directory:&lt;path&gt;:&lt;file_name&gt;</code>.
<code>DirectoryConfigProvider</code> reads and extracts the credentials from the mounted secrets.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-customizing-kubernetes-resources-str"><a class="link" href="#assembly-customizing-kubernetes-resources-str">9.16. Customizing Kubernetes resources</a></h3>
<div class="paragraph _abstract">
<p>A Strimzi deployment creates Kubernetes resources, such as <code>Deployment</code>, <code>Pod</code>, and <code>Service</code> resources.
These resources are managed by Strimzi operators.
Only the operator that is responsible for managing a particular Kubernetes resource can change that resource.
If you try to manually change an operator-managed Kubernetes resource, the operator will revert your changes back.</p>
</div>
<div class="paragraph">
<p>Changing an operator-managed Kubernetes resource can be useful if you want to perform certain tasks, such as the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Adding custom labels or annotations that control how <code>Pods</code> are treated by Istio or other services</p>
</li>
<li>
<p>Managing how <code>Loadbalancer</code>-type Services are created by the cluster</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To make the changes to a Kubernetes resource, you can use the <code>template</code> property within the <code>spec</code> section of various Strimzi custom resources.</p>
</div>
<div class="paragraph">
<p>Here is a list of the custom resources where you can apply the changes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Kafka.spec.kafka</code></p>
</li>
<li>
<p><code>Kafka.spec.zookeeper</code></p>
</li>
<li>
<p><code>Kafka.spec.entityOperator</code></p>
</li>
<li>
<p><code>Kafka.spec.kafkaExporter</code></p>
</li>
<li>
<p><code>Kafka.spec.cruiseControl</code></p>
</li>
<li>
<p><code>KafkaNodePool.spec</code></p>
</li>
<li>
<p><code>KafkaConnect.spec</code></p>
</li>
<li>
<p><code>KafkaMirrorMaker.spec</code></p>
</li>
<li>
<p><code>KafkaMirrorMaker2.spec</code></p>
</li>
<li>
<p><code>KafkaBridge.spec</code></p>
</li>
<li>
<p><code>KafkaUser.spec</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about these properties, see the <a href="./configuring.html" target="_blank" rel="noopener">Strimzi Custom Resource API Reference</a>.</p>
</div>
<div class="paragraph">
<p>The Strimzi Custom Resource API Reference provides more details about the customizable fields.</p>
</div>
<div class="paragraph">
<p>In the following example, the <code>template</code> property is used to modify the labels in a Kafka broker&#8217;s pod.</p>
</div>
<div class="listingblock">
<div class="title">Example template customization</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
  labels:
    app: my-cluster
spec:
  kafka:
    # ...
    template:
      pod:
        metadata:
          labels:
            mylabel: myvalue
    # ...</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="con-customizing-image-pull-policy-str"><a class="link" href="#con-customizing-image-pull-policy-str">9.16.1. Customizing the image pull policy</a></h4>
<div class="paragraph">
<p>Strimzi allows you to customize the image pull policy for containers in all pods deployed by the Cluster Operator.
The image pull policy is configured using the environment variable <code>STRIMZI_IMAGE_PULL_POLICY</code> in the Cluster Operator deployment.
The <code>STRIMZI_IMAGE_PULL_POLICY</code> environment variable can be set to three different values:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>Always</code></dt>
<dd>
<p>Container images are pulled from the registry every time the pod is started or restarted.</p>
</dd>
<dt class="hdlist1"><code>IfNotPresent</code></dt>
<dd>
<p>Container images are pulled from the registry only when they were not pulled before.</p>
</dd>
<dt class="hdlist1"><code>Never</code></dt>
<dd>
<p>Container images are never pulled from the registry.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Currently, the image pull policy can only be customized for all Kafka, Kafka Connect, and Kafka MirrorMaker clusters at once.
Changing the policy will result in a rolling update of all your Kafka, Kafka Connect, and Kafka MirrorMaker clusters.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://kubernetes.io/docs/concepts/containers/images/#updating-images" target="_blank" rel="noopener">Disruptions</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="con-applying-termination-grace-period-str"><a class="link" href="#con-applying-termination-grace-period-str">9.16.2. Applying a termination grace period</a></h4>
<div class="paragraph _abstract">
<p>Apply a termination grace period to give a Kafka cluster enough time to shut down cleanly.</p>
</div>
<div class="paragraph">
<p>Specify the time using the <code>terminationGracePeriodSeconds</code> property.
Add the property to the <code>template.pod</code> configuration of the <code>Kafka</code> custom resource.</p>
</div>
<div class="paragraph">
<p>The time you add will depend on the size of your Kafka cluster.
The Kubernetes default for the termination grace period is 30 seconds.
If you observe that your clusters are not shutting down cleanly, you can increase the termination grace period.</p>
</div>
<div class="paragraph">
<p>A termination grace period is applied every time a pod is restarted.
The period begins when Kubernetes sends a <em>term</em> (termination) signal to the processes running in the pod.
The period should reflect the amount of time required to transfer the processes of the terminating pod to another pod before they are stopped.
After the period ends, a <em>kill</em> signal stops any processes still running in the pod.</p>
</div>
<div class="paragraph">
<p>The following example adds a termination grace period of 120 seconds to the <code>Kafka</code> custom resource.
You can also specify the configuration in the custom resources of other Kafka components.</p>
</div>
<div class="listingblock">
<div class="title">Example termination grace period configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
    template:
      pod:
        terminationGracePeriodSeconds: 120
        # ...
    # ...</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-the-topic-operator-str"><a class="link" href="#using-the-topic-operator-str">10. Using the Topic Operator to manage Kafka topics</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>The <code>KafkaTopic</code> resource configures topics, including partition and replication factor settings.
When you create, modify, or delete a topic using <code>KafkaTopic</code>, the Topic Operator ensures that these changes are reflected in the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>For more information on the <code>KafkaTopic</code> resource, see the <a href="./configuring.html#type-KafkaTopic-reference" target="_blank" rel="noopener"><code>KafkaTopic</code> schema reference</a>.</p>
</div>
<div class="sect2">
<h3 id="ref-operator-topic-str"><a class="link" href="#ref-operator-topic-str">10.1. Topic management modes</a></h3>
<div class="paragraph _abstract">
<p>The <code>KafkaTopic</code> resource is responsible for managing a single topic within a Kafka cluster. The Topic Operator provides two modes for managing <code>KafkaTopic</code> resources and Kafka topics:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Unidirectional mode (default)</dt>
<dd>
<p>Unidirectional mode does not require ZooKeeper for cluster management. It is compatible with using Strimzi in KRaft mode.</p>
</dd>
<dt class="hdlist1">Bidirectional mode</dt>
<dd>
<p>Bidirectional mode requires ZooKeeper for cluster management. It is not compatible with using Strimzi in KRaft mode.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
As the feature gate enabling the Topic Operator to run in unidirectional mode progresses to General Availability, bidirectional mode will be phased out. This transition is aimed at enhancing the user experience, particularly in supporting Kafka in KRaft mode.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="unidirectional_topic_management"><a class="link" href="#unidirectional_topic_management">10.1.1. Unidirectional topic management</a></h4>
<div class="paragraph">
<p>In unidirectional mode, the Topic Operator operates as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When a <code>KafkaTopic</code> is created, deleted, or changed, the Topic Operator performs the corresponding operation on the Kafka topic.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If a topic is created, deleted, or modified directly within the Kafka cluster, without the presence of a corresponding <code>KafkaTopic</code> resource, the Topic Operator does not manage that topic.
The Topic Operator will only manage Kafka topics associated with <code>KafkaTopic</code> resources and does not interfere with topics managed independently within the Kafka cluster.
If a <code>KafkaTopic</code> does exist for a Kafka topic, any configuration changes made outside the resource are reverted.</p>
</div>
<div class="paragraph">
<p>The Topic Operator can detect cases where where multiple <code>KafkaTopic</code> resources are attempting to manage a Kafka topic using the same <code>.spec.topicName</code>.
Only the oldest resource is reconciled, while the other resources fail with a resource conflict error.</p>
</div>
</div>
<div class="sect3">
<h4 id="bidirectional_topic_management"><a class="link" href="#bidirectional_topic_management">10.1.2. Bidirectional topic management</a></h4>
<div class="paragraph">
<p>In bidirectional mode, the Topic Operator operates as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When a <code>KafkaTopic</code> is created, deleted, or changed, the Topic Operator performs the corresponding operation on the Kafka topic.</p>
</li>
<li>
<p>Similarly, when a topic is created, deleted, or changed within the Kafka cluster, the Topic Operator performs the corresponding operation on the <code>KafkaTopic</code> resource.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Try to stick to one method of managing topics, either through the <code>KafkaTopic</code> resources or directly in Kafka.
Avoid routinely switching between both methods for a given topic.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-operator-topic-names-str"><a class="link" href="#con-operator-topic-names-str">10.2. Topic naming conventions</a></h3>
<div class="paragraph">
<p>A <code>KafkaTopic</code> resource includes a name for the topic and a label that identifies the name of the Kafka cluster it belongs to.</p>
</div>
<div class="listingblock">
<div class="title">Label identifying a Kafka cluster for topic handling</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: topic-name-1
  labels:
    strimzi.io/cluster: my-cluster
spec:
  topicName: topic-name-1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The label provides the cluster name of the <code>Kafka</code> resource.
The Topic Operator uses the label as a mechanism for determining which <code>KafkaTopic</code> resources to manage.
If the label does not match the Kafka cluster, the Topic Operator cannot see the <code>KafkaTopic</code>, and the topic is not created.</p>
</div>
<div class="paragraph">
<p>Kafka and Kubernetes have their own naming validation rules, and a Kafka topic name might not be a valid resource name in Kubernetes.
If possible, try and stick to a naming convention that works for both.</p>
</div>
<div class="paragraph">
<p>Consider the following guidelines:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use topic names that reflect the nature of the topic</p>
</li>
<li>
<p>Be concise and keep the name under 63 characters</p>
</li>
<li>
<p>Use all lower case and hyphens</p>
</li>
<li>
<p>Avoid special characters, spaces or symbols</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>KafkaTopic</code> resource allows you to specify the Kafka topic name using the <code>metadata.name</code> field.
However, if the desired Kafka topic name is not a valid Kubernetes resource name, you can use the <code>spec.topicName</code> property to specify the actual name.
The <code>spec.topicName</code> field is optional, and when it&#8217;s absent, the Kafka topic name defaults to the <code>metadata.name</code> of the topic.
When a topic is created, the topic name cannot be changed later.</p>
</div>
<div class="listingblock">
<div class="title">Example of supplying a valid Kafka topic name</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: my-topic-1 # <b class="conum">(1)</b>
spec:
  topicName: My.Topic.1 # <b class="conum">(2)</b>
  # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>A valid topic name that works in Kubernetes.</p>
</li>
<li>
<p>A Kafka topic name that uses upper case and periods, which are invalid in Kubernetes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If more than one <code>KafkaTopic</code> resource refers to the same Kafka topic, the resource that was created first is considered to be the one managing the topic.
The status of the newer resources is updated to indicate a conflict, and their <code>Ready</code> status is changed to <code>False</code>.</p>
</div>
<div class="paragraph">
<p>If a Kafka client application, such as Kafka Streams, automatically creates topics with invalid Kubernetes resource names, the Topic Operator generates a valid <code>metadata.name</code> when used in bidirectional mode.
It replaces invalid characters and appends a hash to the name.
However, this behavior does not apply in unidirectional mode.</p>
</div>
<div class="listingblock">
<div class="title">Example of replacing an invalid topic name</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: my-topic---c55e57fe2546a33f9e603caf57165db4072e827e
  # ...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
For more information on the requirements for identifiers and names in a cluster, refer to the Kubernetes documentation <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/names" target="_blank" rel="noopener">Object Names and IDs</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="con-application-topic-handling-str"><a class="link" href="#con-application-topic-handling-str">10.3. Handling changes to topics</a></h3>
<div class="paragraph _abstract">
<p>How the Topic Operator handles changes to topics depends on the <a href="#ref-operator-topic-str">mode of topic management</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For unidirectional topic management, configuration changes only go in one direction: from the <code>KafkaTopic</code> resource to the Kafka topic. Any changes to a Kafka topic managed outside the <code>KafkaTopic</code> resource are reverted.</p>
</li>
<li>
<p>For bidirectional topic management, configuration changes are synchronized between the Kafka topic and the <code>KafkaTopic</code> resource in both directions. Incompatible changes prioritize the Kafka configuration, and the <code>KafkaTopic</code> resource is adjusted accordingly.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="topic_store_for_bidirectional_topic_management"><a class="link" href="#topic_store_for_bidirectional_topic_management">10.3.1. Topic store for bidirectional topic management</a></h4>
<div class="paragraph">
<p>For bidirectional topic management, the Topic Operator is capable of handling changes to topics when there is no single source of truth.
The <code>KafkaTopic</code> resource and the Kafka topic can undergo independent modifications, where real-time observation of changes may not always be feasible, particularly when the Topic Operator is not operational.
To handle this, the Topic Operator maintains a topic store that stores topic configuration information about each topic.
It compares the state of the Kafka cluster and Kubernetes with the topic store to determine the necessary changes for synchronization.
This evaluation takes place during startup and at regular intervals while the Topic Operator is active.</p>
</div>
<div class="paragraph">
<p>For example, if the Topic Operator is inactive, and a new <code>KafkaTopic</code> named <em>my-topic</em> is created, upon restart, the Topic Operator recognizes the absence of <em>my-topic</em> in the topic store.
It recognizes that the <code>KafkaTopic</code> was created after its last operation.
Consequently, the Topic Operator generates the corresponding Kafka topic and saves the metadata in the topic store.</p>
</div>
<div class="paragraph">
<p>The topic store enables the Topic Operator to manage situations where the topic configuration is altered in both Kafka topics and <code>KafkaTopic</code> resources, as long as the changes are compatible.
When Kafka topic configuration is updated or changes are made to the <code>KafkaTopic</code> custom resource, the topic store is updated after reconciling with the Kafka cluster, as long as the changes are compatible.</p>
</div>
<div class="paragraph">
<p>The <em>topic store</em> is based on the Kafka Streams key-value mechanism, which uses Kafka topics to persist the state.
Topic metadata is cached in-memory and accessed locally within the Topic Operator.
Updates from operations applied to the local in-memory cache are persisted to a backup topic store on disk.
The topic store is continually synchronized with updates from Kafka topics or Kubernetes <code>KafkaTopic</code> custom resources.
Operations are handled rapidly with the topic store set up this way,
but should the in-memory cache crash it is automatically repopulated from the persistent storage.</p>
</div>
<div class="paragraph">
<p>Internal topics support the handling of topic metadata in the topic store.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>__strimzi_store_topic</code></dt>
<dd>
<p>Input topic for storing the topic metadata</p>
</dd>
<dt class="hdlist1"><code>__strimzi-topic-operator-kstreams-topic-store-changelog</code></dt>
<dd>
<p>Retains a log of compacted topic store values</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Do not delete these topics, as they are essential to the running of the Topic Operator.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="migrating_topic_metadata_from_zookeeper_to_the_topic_store"><a class="link" href="#migrating_topic_metadata_from_zookeeper_to_the_topic_store">10.3.2. Migrating topic metadata from ZooKeeper to the topic store</a></h4>
<div class="paragraph">
<p>In previous releases of Strimzi, topic metadata was stored in ZooKeeper.
The topic store removes this requirement, bringing the metadata into the Kafka cluster, and under the control of the Topic Operator.</p>
</div>
<div class="paragraph">
<p>When upgrading to Strimzi 0.39.0, the transition to Topic Operator control of the topic store is seamless.
Metadata is found and migrated from ZooKeeper, and the old store is deleted.</p>
</div>
</div>
<div class="sect3">
<h4 id="downgrading_to_a_strimzi_version_that_uses_zookeeper_to_store_topic_metadata"><a class="link" href="#downgrading_to_a_strimzi_version_that_uses_zookeeper_to_store_topic_metadata">10.3.3. Downgrading to a Strimzi version that uses ZooKeeper to store topic metadata</a></h4>
<div class="paragraph">
<p>If you are reverting back to a version of Strimzi earlier than 0.22, which uses ZooKeeper for the storage of topic metadata,
you still downgrade your Cluster Operator to the previous version,
then downgrade Kafka brokers and client applications to the previous Kafka version as standard.</p>
</div>
<div class="paragraph">
<p>However, you must also delete the topics that were created for the topic store using a <code>kafka-topics</code> command, specifying the bootstrap address of the Kafka cluster.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl run kafka-admin -ti --image=quay.io/strimzi/kafka:0.39.0-kafka-3.6.1 --rm=true --restart=Never -- ./bin/kafka-topics.sh --bootstrap-server localhost:9092 --topic __strimzi-topic-operator-kstreams-topic-store-changelog --delete &amp;&amp; ./bin/kafka-topics.sh --bootstrap-server localhost:9092 --topic __strimzi_store_topic --delete</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command must correspond to the type of listener and authentication used to access the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>The Topic Operator will reconstruct the ZooKeeper topic metadata from the state of the topics in Kafka.</p>
</div>
</div>
<div class="sect3">
<h4 id="automatic_creation_of_topics"><a class="link" href="#automatic_creation_of_topics">10.3.4. Automatic creation of topics</a></h4>
<div class="paragraph">
<p>Applications can trigger the automatic creation of topics in the Kafka cluster.
By default, the Kafka broker configuration <code>auto.create.topics.enable</code> is set to <code>true</code>, allowing the broker to create topics automatically when an application attempts to produce or consume from a non-existing topic.
Applications might also use the Kafka <code>AdminClient</code> to automatically create topics.
When an application is deployed along with its <code>KafkaTopic</code> resources, it is possible that automatic topic creation in the cluster happens before the Topic Operator can react to the <code>KafkaTopic</code>.</p>
</div>
<div class="paragraph">
<p>For bidirectional topic management, the Topic Operator synchronizes the changes between the topics and <code>KafkaTopic</code> resources.</p>
</div>
<div class="paragraph">
<p>If you are using unidirectional topic management, this can mean that the topics created for an application deployment are initially created with default topic configuration.
If the Topic Operator attempts to reconfigure the topics based on <code>KafkaTopic</code> resource specifications included with the application deployment, the operation might fail because the required change to the configuration is not allowed.
For example, if the change means lowering the number of topic partitions.
For this reason, it is recommended to disable <code>auto.create.topics.enable</code> in the Kafka cluster configuration when using unidirectional topic management.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="proc-configuring-kafka-topic-str"><a class="link" href="#proc-configuring-kafka-topic-str">10.4. Configuring Kafka topics</a></h3>
<div class="paragraph _abstract">
<p>Use the properties of the <code>KafkaTopic</code> resource to configure Kafka topics.
Changes made to topic configuration in the <code>KafkaTopic</code> are propagated to Kafka.</p>
</div>
<div class="paragraph">
<p>You can use <code>kubectl apply</code> to create or modify topics, and <code>kubectl delete</code> to delete existing topics.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>kubectl apply -f &lt;topic_config_file&gt;</code></p>
</li>
<li>
<p><code>kubectl delete KafkaTopic &lt;topic_name&gt;</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To be able to delete topics, <code>delete.topic.enable</code> must be set to <code>true</code> (default) in the <code>spec.kafka.config</code> of the Kafka resource.</p>
</div>
<div class="paragraph">
<p>This procedure shows how to create a topic with 10 partitions and 2 replicas.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The procedure is the same for the unidirectional and bidirectional modes of topic management.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Before you begin</div>
<p>The KafkaTopic resource does not allow the following changes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Renaming the topic defined in <code>spec.topicName</code>. A mismatch between <code>spec.topicName</code> and <code>status.topicName</code> will be detected.</p>
</li>
<li>
<p>Decreasing the number of partitions using <code>spec.partitions</code> (not supported by Kafka).</p>
</li>
<li>
<p>Modifying the number of replicas specified in <code>spec.replicas</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Increasing <code>spec.partitions</code> for topics with keys will alter the partitioning of records, which can cause issues, especially when the topic uses semantic partitioning.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A running Kafka cluster configured with a Kafka broker listener using mTLS authentication and TLS encryption.</p>
</li>
<li>
<p>A running Topic Operator (typically deployed with the Entity Operator).</p>
</li>
<li>
<p>For deleting a topic, <code>delete.topic.enable=true</code> (default) in the <code>spec.kafka.config</code> of the <code>Kafka</code> resource.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure the <code>KafkaTopic</code> resource.</p>
<div class="listingblock">
<div class="title">Example Kafka topic configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: my-topic-1
  labels:
    strimzi.io/cluster: my-cluster
spec:
  partitions: 10
  replicas: 2</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
When modifying a topic, you can get the current version of the resource using <code>kubectl get kafkatopic my-topic-1 -o yaml</code>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create the <code>KafkaTopic</code> resource in Kubernetes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;topic_config_file&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the ready status of the topic to change to <code>True</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafkatopics -o wide -w -n <em>&lt;namespace&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Kafka topic status</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME         CLUSTER     PARTITIONS  REPLICATION FACTOR READY
my-topic-1   my-cluster  10          3                  True
my-topic-2   my-cluster  10          3
my-topic-3   my-cluster  10          3                  True</code></pre>
</div>
</div>
<div class="paragraph">
<p>Topic creation is successful when the <code>READY</code> output shows <code>True</code>.</p>
</div>
</li>
<li>
<p>If the <code>READY</code> column stays blank, get more details on the status from the resource YAML or from the Topic Operator logs.</p>
<div class="paragraph">
<p>Status messages provide details on the reason for the current status.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get kafkatopics my-topic-2 -o yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Details on a topic with a <code>NotReady</code> status</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># ...
status:
  conditions:
  - lastTransitionTime: "2022-06-13T10:14:43.351550Z"
    message: Number of partitions cannot be decreased
    reason: PartitionDecreaseException
    status: "True"
    type: NotReady</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the reason the topic is not ready is because the original number of partitions was reduced in the <code>KafkaTopic</code> configuration.
Kafka does not support this.</p>
</div>
<div class="paragraph">
<p>After resetting the topic configuration, the status shows the topic is ready.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafkatopics my-topic-2 -o wide -w -n <em>&lt;namespace&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Status update of the topic</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME         CLUSTER     PARTITIONS  REPLICATION FACTOR READY
my-topic-2   my-cluster  10          3                  True</code></pre>
</div>
</div>
<div class="paragraph">
<p>Fetching the details shows no messages</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafkatopics my-topic-2 -o yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Details on a topic with a <code>READY</code> status</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># ...
status:
  conditions:
  - lastTransitionTime: '2022-06-13T10:15:03.761084Z'
    status: 'True'
    type: Ready</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="ref-topic-replication-str"><a class="link" href="#ref-topic-replication-str">10.5. Configuring topics for replication and number of partitions</a></h3>
<div class="paragraph">
<p>The recommended configuration for topics managed by the Topic Operator is a topic replication factor of 3, and a minimum of 2 in-sync replicas.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: my-topic
  labels:
    strimzi.io/cluster: my-cluster
spec:
  partitions: 10 # <b class="conum">(1)</b>
  replicas: 3 # <b class="conum">(2)</b>
  config:
    min.insync.replicas: 2 # <b class="conum">(3)</b>
  #...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The number of partitions for the topic.</p>
</li>
<li>
<p>The number of replica topic partitions. Currently, this cannot be changed in the <code>KafkaTopic</code> resource, but it can be changed using the <code>kafka-reassign-partitions.sh</code> tool.</p>
</li>
<li>
<p>The minimum number of replica partitions that a message must be successfully written to, or an exception is raised.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In-sync replicas are used in conjunction with the <code>acks</code> configuration for producer applications.
The <code>acks</code> configuration determines the number of follower partitions a message must be replicated to before the message is acknowledged as successfully received.
The bidirectional Topic Operator runs with <code>acks=all</code> for its internal topics whereby messages must be acknowledged by all in-sync replicas.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When scaling Kafka clusters by adding or removing brokers, replication factor configuration is not changed and replicas are not reassigned automatically.
However, you can use the <code>kafka-reassign-partitions.sh</code> tool to change the replication factor, and manually reassign replicas to brokers.</p>
</div>
<div class="paragraph">
<p>Alternatively, though the integration of Cruise Control for Strimzi cannot change the replication factor for topics,
the optimization proposals it generates for rebalancing Kafka include commands that transfer partition replicas and change partition leadership.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#assembly-downgrade-str">Downgrading Strimzi</a></p>
</li>
<li>
<p><a href="#con-partition-reassignment-str">Partition reassignment tool overview</a></p>
</li>
<li>
<p><a href="#cruise-control-concepts-str">Rebalancing clusters using Cruise Control</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="proc-converting-managed-topics-str"><a class="link" href="#proc-converting-managed-topics-str">10.6. Managing KafkaTopic resources without impacting Kafka topics</a></h3>
<div class="paragraph _abstract">
<p>This procedure describes how to convert Kafka topics that are currently managed through the <code>KafkaTopic</code> resource into non-managed topics.
This capability can be useful in various scenarios.
For instance, you might want to update the <code>metadata.name</code> of a <code>KafkaTopic</code> resource.
You can only do that by deleting the original <code>KafkaTopic</code> resource and recreating a new one.</p>
</div>
<div class="paragraph">
<p>By annotating a <code>KafkaTopic</code> resource with <code>strimzi.io/managed=false</code>, you indicate that the Topic Operator should no longer manage that particular topic.
This allows you to retain the Kafka topic while making changes to the resource&#8217;s configuration or other administrative tasks.</p>
</div>
<div class="paragraph">
<p>You can perform this task if you are using unidirectional topic management.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Annotate the <code>KafkaTopic</code> resource in Kubernetes, setting <code>strimzi.io/managed</code> to <code>false</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate kafkatopic my-topic-1 strimzi.io/managed=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>Specify the <code>metadata.name</code> of the topic in your <code>KafkaTopic</code> resource, which is <code>my-topic-1</code> in this example.</p>
</div>
</li>
<li>
<p>Check the status of the <code>KafkaTopic</code> resource to make sure the request was successful:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get kafkatopics my-topic-1 -o yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example topic with a <code>Ready</code> status</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  generation: 124
  name: my-topic-1
  finalizer:
    strimzi.io/topic-operator
  labels:
    strimzi.io/cluster: my-cluster
spec:
  partitions: 10
  replicas: 2

# ...
status:
  observedGeneration: 124 # <b class="conum">(1)</b>
  topicName: my-topic-1
  conditions:
  - type: Ready
    status: True
    lastTransitionTime: 20230301T103000Z</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Successful reconciliation of the resource means the topic is no longer managed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The value of <code>metadata.generation</code> (the current version of the deployment) must <code>match status.observedGeneration</code> (the latest reconciliation of the resource).</p>
</div>
</li>
<li>
<p>You can now make changes to the <code>KafkaTopic</code> resource without it affecting the Kafka topic it was managing.</p>
<div class="paragraph">
<p>For example, to change the <code>metadata.name</code>, do as follows:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Delete the original <code>KafkTopic</code> resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl delete kafkatopic &lt;kafka_topic_name&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Recreate the <code>KafkTopic</code> resource with a different <code>metadata.name</code>, but use <code>spec.topicName</code> to refer to the same topic that was managed by the original</p>
</li>
</ol>
</div>
</li>
<li>
<p>If you haven&#8217;t deleted the original <code>KafkaTopic</code> resource, and you wish to resume management of the Kafka topic again, set the <code>strimzi.io/managed</code> annotation to <code>true</code> or remove the annotation.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="proc-converting-non-managed-topics-str"><a class="link" href="#proc-converting-non-managed-topics-str">10.7. Enabling topic management for existing Kafka topics</a></h3>
<div class="paragraph _abstract">
<p>This procedure describes how to enable topic management for topics that are not currently managed through the <code>KafkaTopic</code> resource.
You do this by creating a matching <code>KafkaTopic</code> resource.</p>
</div>
<div class="paragraph">
<p>You can perform this task if you are using unidirectional topic management.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>KafkaTopic</code> resource with a <code>metadata.name</code> that is the same as the Kafka topic.</p>
<div class="paragraph">
<p>Or use <code>spec.topicName</code> if the name of the topic in Kafka would not be a legal Kubernetes resource name.</p>
</div>
<div class="listingblock">
<div class="title">Example Kafka topic configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: my-topic-1
  labels:
    strimzi.io/cluster: my-cluster
spec:
  partitions: 10
  replicas: 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the Kafka topic is named <code>my-topic-1</code>.</p>
</div>
<div class="paragraph">
<p>The Topic Operator checks whether the topic is managed by another <code>KafkaTopic</code> resource.
If it is, the older resource takes precedence and a resource conflict error is returned in the status of the new resource.</p>
</div>
</li>
<li>
<p>Apply the <code>KafkaTopic</code> resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f &lt;topic_configuration_file&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the operator to update the topic in Kafka.</p>
<div class="paragraph">
<p>The operator updates the Kafka topic with the <code>spec</code> of the <code>KafkaTopic</code> that has the same name.</p>
</div>
</li>
<li>
<p>Check the status of the <code>KafkaTopic</code> resource to make sure the request was successful:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get kafkatopics my-topic-1 -o yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example topic with a <code>Ready</code> status</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  generation: 1
  name: my-topic-1
  labels:
    strimzi.io/cluster: my-cluster
spec:
  partitions: 10
  replicas: 2
# ...
status:
  observedGeneration: 1 # <b class="conum">(1)</b>
  topicName: my-topic-1
  conditions:
  - type: Ready
    status: True
    lastTransitionTime: 20230301T103000Z</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Successful reconciliation of the resource means the topic is now managed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The value of <code>metadata.generation</code> (the current version of the deployment) must <code>match status.observedGeneration</code> (the latest reconciliation of the resource).</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="con-deleting-managed-topics-str"><a class="link" href="#con-deleting-managed-topics-str">10.8. Deleting managed topics</a></h3>
<div class="paragraph _abstract">
<p>Unidirectional topic management supports the deletion of topics managed through the <code>KafkaTopic</code> resource with or without Kubernetes finalizers.
This is determined by the <code>STRIMZI_USE_FINALIZERS</code> Topic Operator environment variable.
By default, this is set to <code>true</code>, though it can be set to <code>false</code> in the Topic Operator <code>env</code> configuration if you do not want the Topic Operator to add finalizers.</p>
</div>
<div class="paragraph">
<p>Finalizers ensure orderly and controlled deletion of <code>KafkaTopic</code> resources.
A finalizer for the Topic Operator is added to the metadata of the <code>KafkaTopic</code> resource:</p>
</div>
<div class="listingblock">
<div class="title">Finalizer to control topic deletion</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  generation: 1
  name: my-topic-1
  finalizers:
    - strimzi.io/topic-operator
  labels:
    strimzi.io/cluster: my-cluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the finalizer is added for topic <code>my-topic-1</code>.
The finalizer prevents the topic from being fully deleted until the finalization process is complete.
If you then delete the topic using <code>kubectl delete kafkatopic my-topic-1</code>, a timestamp is added to the metadata:</p>
</div>
<div class="listingblock">
<div class="title">Finalizer timestamp on deletion</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  generation: 1
  name: my-topic-1
  finalizers:
    - strimzi.io/topic-operator
  labels:
    strimzi.io/cluster: my-cluster
  deletionTimestamp: 20230301T000000.000</code></pre>
</div>
</div>
<div class="paragraph">
<p>The resource is still present.
If the deletion fails, it is shown in the status of the resource.</p>
</div>
<div class="paragraph">
<p>When the finalization tasks are successfully executed, the finalizer is removed from the metadata, and the resource is fully deleted.</p>
</div>
<div class="paragraph">
<p>Finalizers also serve to prevent related resources from being deleted.
If the unidirectional Topic Operator is not running, it won&#8217;t be able to remove its finalizer from the <code>metadata.finalizers</code>.
And any attempt to directly delete the <code>KafkaTopic</code> resources or the namespace will fail or timeout, leaving the namespace in a stuck terminating state.
If this happens, you can bypass the finalization process by <a href="#con-removing-topic-finalizers-str">removing the finalizers on topics</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="proc-changing-topic-operator-mode-str"><a class="link" href="#proc-changing-topic-operator-mode-str">10.9. Switching between Topic Operator modes</a></h3>
<div class="paragraph _abstract">
<p>You can switch between topic management modes when upgrading or downgrading Strimzi, or when using the same version of Strimzi, as long as the mode is supported for that version.</p>
</div>
<div class="olist arabic">
<div class="title">Switching from bidirectional to unidirectional topic management mode</div>
<ol class="arabic">
<li>
<p><a href="#ref-operator-unidirectional-topic-operator-feature-gate-str">Enable the <code>UnidirectionalTopicOperator</code> feature gate</a>.</p>
<div class="paragraph">
<p>The Cluster Operator deploys the Entity Operator with the Topic Operator in unidirectional topic management mode.</p>
</div>
</li>
<li>
<p>The internal topics that support the Topic Operator running in bidirectional topic management mode are no longer required, so you can delete the <code>KafkaTopic</code> resources to manage them:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl delete $(kubectl get kt -n &lt;namespace_name&gt; -o name | grep strimzi-store-topic) \
  &amp;&amp; kubectl delete $(kubectl get kt -n &lt;namespace_name&gt; -o name | grep strimzi-topic-operator)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command deletes the internal topics, which have names starting <code>strimzi-store-topic</code> and <code>strimzi-topic-operator</code>.</p>
</div>
</li>
<li>
<p>The internal topics for storing consumer offsets and transaction states must be retained in Kafka. So, you must first discontinue their management by the Topic Operator before deleting the <code>KafkaTopic</code> resources.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Discontinue management of the topics:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate $(kubectl get kt -n &lt;namespace_name&gt; -o name | grep consumer-offsets) strimzi.io/managed="false" \
  &amp;&amp; kubectl annotate $(kubectl get kt -n &lt;namespace_name&gt; -o name | grep transaction-state) strimzi.io/managed="false"</code></pre>
</div>
</div>
<div class="paragraph">
<p>By annotating the <code>KafkaTopic</code> resources with <code>strimzi.io/managed="false"</code>, you indicate that the Topic Operator should no longer manage those topics.
In this case, we are adding the annotation to resources for managing the internal topics with names starting <code>consumer-offsets</code> and <code>transaction-state</code>.</p>
</div>
</li>
<li>
<p>When their management is discontinued, delete the <code>KafkaTopic</code> resources (without deleting the topics inside Kafka):</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl delete $(kubectl get kt -n &lt;namespace_name&gt; -o name | grep consumer-offsets) \
  &amp;&amp; kubectl delete $(kubectl get kt -n &lt;namespace_name&gt; -o name | grep transaction-state)</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Switching from unidirectional to bidirectional topic management mode</div>
<ol class="arabic">
<li>
<p><a href="#ref-operator-unidirectional-topic-operator-feature-gate-str">Disable the <code>UnidirectionalTopicOperator</code> feature gate</a>.</p>
<div class="paragraph">
<p>The Cluster Operator deploys the Entity Operator with the Topic Operator in bidirectional topic management mode.</p>
</div>
<div class="paragraph">
<p>The internal topics required by the Topic Operator running in bidirectional topic management mode are created.</p>
</div>
</li>
<li>
<p>Check whether finalizers are being used to control topic deletion.
If <code>KafkaTopic</code> resources are using finalizers, ensure that you do one of the following after making the switch:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#con-removing-topic-finalizers-str">Remove all finalizers from topics</a>.</p>
</li>
<li>
<p>Disable the finalizers by setting the <code>STRIMZI_USE_FINALIZERS</code> environment variable to <code>false</code> in the Topic Operator <code>env</code> configuration.</p>
<div class="paragraph">
<p>Use the same configuration for a Topic Operator running in a Strimzi-managed cluster or as a standalone deployment.</p>
</div>
<div class="listingblock">
<div class="title">Disabling topic finalizers in a Strimzi-managed cluster</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: {KafkaApiVersion}
kind: Kafka
metadata:
  name: my-cluster
spec:
  # ...
  entityOperator:
    topicOperator: {}
    userOperator: {}
    template:
      topicOperatorContainer:
        env:
          - name: STRIMZI_USE_FINALIZERS
            value: "false"
# ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Disabling topic finalizers in a standalone deployment</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: apps/v1
kind: Deployment
metadata:
  name: strimzi-topic-operator
spec:
  template:
    spec:
      containers:
        - name: STRIMZI_USE_FINALIZERS
          value: "false"
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Topic Operator does not use finalizers in bidirectional mode.
If they are retained after making the switch from unidirectional mode, you won&#8217;t be able to delete <code>KafkaTopic</code> and related resources.</p>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>After switching between between Topic Operator modes, try creating a topic to make sure the operator is running correctly.
For more information, see <a href="#proc-configuring-kafka-topic-str">Configuring Kafka topics</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="con-removing-topic-finalizers-str"><a class="link" href="#con-removing-topic-finalizers-str">10.10. Removing finalizers on topics</a></h3>
<div class="paragraph _abstract">
<p>If the unidirectional Topic Operator is not running, and you want to bypass the finalization process when deleting managed topics, you have to remove the finalizers.
You can do this manually by editing the resources directly or by using a command.</p>
</div>
<div class="paragraph">
<p>To remove finalizers on all topics, use the following command:</p>
</div>
<div class="listingblock">
<div class="title">Removing finalizers on topics</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kt -o=json | jq '.items[].metadata.finalizers = null' | kubectl apply -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command uses the <code>jq</code> tool to modify the <code>KafkaTopic</code> (<code>kt</code>) resources by setting the finalizers to <code>null</code>.
You can also use the command for a specific topic:</p>
</div>
<div class="listingblock">
<div class="title">Removing a finalizer on a specific topic</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kt &lt;topic_name&gt; -o=json | jq '.metadata.finalizers = null' | kubectl apply -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>After running the command, you can go ahead and delete the topics.
Alternatively, if the topics were already being deleted but were blocked due to outstanding finalizers then their deletion should complete.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Be careful when removing finalizers, as any cleanup operations associated with the finalization process are not performed if the Topic Operator is not running.
For example, if you remove the finalizer from a <code>KafkaTopic</code> resource and subsequently delete the resource, the related Kafka topic won&#8217;t be deleted.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="con-disabling-topic-deletion-str"><a class="link" href="#con-disabling-topic-deletion-str">10.11. Considerations when disabling topic deletion</a></h3>
<div class="paragraph _abstract">
<p>When the <code>delete.topic.enable</code> configuration in Kafka is set to <code>false</code>, topics cannot be deleted.
This might be required in certain scenarios, but it introduces a consideration when using the Topic Operator in unidirectional mode.</p>
</div>
<div class="paragraph">
<p>As topics cannot be deleted, finalizers added to the metadata of a <code>KafkaTopic</code> resource to control topic deletion are never removed by the Topic Operator (though they can be <a href="#con-removing-topic-finalizers-str">removed manually</a>).
Similarly, any Custom Resource Definitions (CRDs) or namespaces associated with topics cannot be deleted.</p>
</div>
<div class="paragraph">
<p>Before configuring <code>delete.topic.enable=false</code>, assess these implications to ensure it aligns with your specific requirements.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
To avoid using finalizers, you can set the <code>STRIMZI_USE_FINALIZERS</code> Topic Operator environment variable to <code>false</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="con-tuning-topic-request-batches-str"><a class="link" href="#con-tuning-topic-request-batches-str">10.12. Tuning request batches for topic operations</a></h3>
<div class="paragraph">
<p>In unidirectional mode, the Topic Operator uses the request batching capabilities of the Kafka Admin API for operations on topic resources.
You can fine-tune the batching mechanism using the following operator configuration properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>STRIMZI_MAX_QUEUE_SIZE</code> to set the maximum size of the topic event queue.
The default value is 1024.</p>
</li>
<li>
<p><code>STRIMZI_MAX_BATCH_SIZE</code> to set the maximum number of topic events allowed in a single batch.
The default value is 100.</p>
</li>
<li>
<p><code>MAX_BATCH_LINGER_MS</code> to specify the maximum time to wait for a batch to accumulate items before processing.
The default is 100 milliseconds.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the maximum size of the request batching queue is exceeded, the Topic Operator shuts down and is restarted.
To prevent frequent restarts, consider adjusting the <code>STRIMZI_MAX_QUEUE_SIZE</code> property to accommodate the typical load.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-using-the-user-operator-str"><a class="link" href="#assembly-using-the-user-operator-str">11. Using the User Operator to manage Kafka users</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>When you create, modify or delete a user using the <code>KafkaUser</code> resource,
the User Operator ensures that these changes are reflected in the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>For more information on the <code>KafkaUser</code> resource, see the <a href="./configuring.html#type-KafkaUser-reference" target="_blank" rel="noopener"><code>KafkaUser</code> schema reference</a>.</p>
</div>
<div class="sect2">
<h3 id="proc-configuring-kafka-user-str"><a class="link" href="#proc-configuring-kafka-user-str">11.1. Configuring Kafka users</a></h3>
<div class="paragraph _abstract">
<p>Use the properties of the <code>KafkaUser</code> resource to configure Kafka users.</p>
</div>
<div class="paragraph">
<p>You can use <code>kubectl apply</code> to create or modify users, and <code>kubectl delete</code> to delete existing users.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>kubectl apply -f <em>&lt;user_config_file&gt;</em></code></p>
</li>
<li>
<p><code>kubectl delete KafkaUser <em>&lt;user_name&gt;</em></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Users represent Kafka clients.
When you configure Kafka users, you enable the user authentication and authorization mechanisms required by clients to access Kafka.
The mechanism used must match the equivalent <code>Kafka</code> configuration.
For more information on using <code>Kafka</code> and <code>KafkaUser</code> resources to secure access to Kafka brokers, see <a href="#assembly-securing-kafka-str">Securing access to Kafka brokers</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A running Kafka cluster configured with a Kafka broker listener using mTLS authentication and TLS encryption.</p>
</li>
<li>
<p>A running User Operator (typically deployed with the Entity Operator).</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure the <code>KafkaUser</code> resource.</p>
<div class="paragraph">
<p>This example specifies mTLS authentication and simple authorization using ACLs.</p>
</div>
<div class="listingblock">
<div class="title">Example Kafka user configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user-1
  labels:
    strimzi.io/cluster: my-cluster
spec:
  authentication:
    type: tls
  authorization:
    type: simple
    acls:
      # Example consumer Acls for topic my-topic using consumer group my-group
      - resource:
          type: topic
          name: my-topic
          patternType: literal
        operations:
          - Describe
          - Read
        host: "*"
      - resource:
          type: group
          name: my-group
          patternType: literal
        operations:
          - Read
        host: "*"
      # Example Producer Acls for topic my-topic
      - resource:
          type: topic
          name: my-topic
          patternType: literal
        operations:
          - Create
          - Describe
          - Write
        host: "*"</code></pre>
</div>
</div>
</li>
<li>
<p>Create the <code>KafkaUser</code> resource in Kubernetes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;user_config_file&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the ready status of the user to change to <code>True</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafkausers -o wide -w -n <em>&lt;namespace&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Kafka user status</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME       CLUSTER     AUTHENTICATION  AUTHORIZATION READY
my-user-1  my-cluster  tls             simple        True
my-user-2  my-cluster  tls             simple
my-user-3  my-cluster  tls             simple        True</code></pre>
</div>
</div>
<div class="paragraph">
<p>User creation is successful when the <code>READY</code> output shows <code>True</code>.</p>
</div>
</li>
<li>
<p>If the <code>READY</code> column stays blank, get more details on the status from the resource YAML or User Operator logs.</p>
<div class="paragraph">
<p>Messages provide details on the reason for the current status.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafkausers my-user-2 -o yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Details on a user with a <code>NotReady</code> status</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># ...
status:
  conditions:
  - lastTransitionTime: "2022-06-10T10:07:37.238065Z"
    message: Simple authorization ACL rules are configured but not supported in the
      Kafka cluster configuration.
    reason: InvalidResourceException
    status: "True"
    type: NotReady</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the reason the user is not ready is because simple authorization is not enabled in the <code>Kafka</code> configuration.</p>
</div>
<div class="listingblock">
<div class="title">Kafka configuration for simple authorization</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  apiVersion: kafka.strimzi.io/v1beta2
  kind: Kafka
  metadata:
    name: my-cluster
  spec:
    kafka:
      # ...
      authorization:
        type: simple</code></pre>
</div>
</div>
<div class="paragraph">
<p>After updating the Kafka configuration, the status shows the user is ready.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafkausers my-user-2 -o wide -w -n <em>&lt;namespace&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Status update of the user</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME       CLUSTER     AUTHENTICATION  AUTHORIZATION READY
my-user-2  my-cluster  tls             simple        True</code></pre>
</div>
</div>
<div class="paragraph">
<p>Fetching the details shows no messages.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafkausers my-user-2 -o yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Details on a user with a <code>READY</code> status</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># ...
status:
  conditions:
  - lastTransitionTime: "2022-06-10T10:33:40.166846Z"
    status: "True"
    type: Ready</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-client-access-str"><a class="link" href="#deploy-client-access-str">12. Setting up client access to a Kafka cluster</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>After you have <a href="#deploy-tasks_str">deployed Strimzi</a>, you can set up client access to your Kafka cluster.
To verify the deployment, you can deploy example producer and consumer clients.
Otherwise, create listeners that provide client access within or outside the Kubernetes cluster.</p>
</div>
<div class="sect2">
<h3 id="deploying-example-clients-str"><a class="link" href="#deploying-example-clients-str">12.1. Deploying example clients</a></h3>
<div class="paragraph _abstract">
<p>Deploy example producer and consumer clients to send and receive messages.
You can use these clients to verify a deployment of Strimzi.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Kafka cluster is available for the clients.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy a Kafka producer.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl run kafka-producer -ti --image=quay.io/strimzi/kafka:0.39.0-kafka-3.6.1 --rm=true --restart=Never -- bin/kafka-console-producer.sh --bootstrap-server <em>cluster-name</em>-kafka-bootstrap:9092 --topic <em>my-topic</em></code></pre>
</div>
</div>
</li>
<li>
<p>Type a message into the console where the producer is running.</p>
</li>
<li>
<p>Press <em>Enter</em> to send the message.</p>
</li>
<li>
<p>Deploy a Kafka consumer.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl run kafka-consumer -ti --image=quay.io/strimzi/kafka:0.39.0-kafka-3.6.1 --rm=true --restart=Never -- bin/kafka-console-consumer.sh --bootstrap-server <em>cluster-name</em>-kafka-bootstrap:9092 --topic <em>my-topic</em> --from-beginning</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that you see the incoming messages in the consumer console.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="configuration-points-listeners-str"><a class="link" href="#configuration-points-listeners-str">12.2. Configuring listeners to connect to Kafka brokers</a></h3>
<div class="paragraph _abstract">
<p>Use listeners for client connection to Kafka brokers.
Strimzi provides a generic <code>GenericKafkaListener</code> schema with properties to configure listeners through the <code>Kafka</code> resource.
The <code>GenericKafkaListener</code> provides a flexible approach to listener configuration.
You can specify properties to configure <em>internal</em> listeners for connecting within the Kubernetes cluster or <em>external</em> listeners for connecting outside the Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>Specify a connection <code>type</code> to expose Kafka in the listener configuration.
The type chosen depends on your requirements, and your environment and infrastructure.
The following listener types are supported:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Internal listeners</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>internal</code> to connect within the same Kubernetes cluster</p>
</li>
<li>
<p><code>cluster-ip</code> to expose Kafka using per-broker <code>ClusterIP</code> services</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">External listeners</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>nodeport</code> to use ports on Kubernetes nodes</p>
</li>
<li>
<p><code>loadbalancer</code> to use loadbalancer services</p>
</li>
<li>
<p><code>ingress</code> to use Kubernetes <code>Ingress</code> and the <a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener">Ingress NGINX Controller for Kubernetes</a> (Kubernetes only)</p>
</li>
<li>
<p><code>route</code> to use OpenShift <code>Route</code> and the default HAProxy router (OpenShift only)</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Do not use <code>ingress</code> on OpenShift, use the <code>route</code> type instead. The Ingress NGINX Controller is only intended for use on Kubernetes. The <code>route</code> type is only supported on OpenShift.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An <code>internal</code> type listener configuration uses a headless service and the DNS names given to the broker pods.
You might want to join your Kubernetes network to an outside network.
In which case, you can configure an <code>internal</code> type listener (using the <code>useServiceDnsDomain</code> property) so that the Kubernetes service DNS domain (typically <code>.cluster.local</code>) is not used.
You can also configure a <code>cluster-ip</code> type of listener that exposes a Kafka cluster based on per-broker <code>ClusterIP</code> services.
This is a useful option when you can&#8217;t route through the headless service or you wish to incorporate a custom access mechanism.
For example, you might use this listener when building your own type of external listener for a specific Ingress controller or the Kubernetes Gateway API.</p>
</div>
<div class="paragraph">
<p>External listeners handle access to a Kafka cluster from networks that require different authentication mechanisms.
You can configure external listeners for client access outside a Kubernetes environment using a specified connection mechanism, such as a loadbalancer or route.
For example, loadbalancers might not be suitable for certain infrastructure, such as bare metal, where node ports provide a better option.</p>
</div>
<div class="paragraph">
<p>Each listener is defined as an array in the <code>Kafka</code> resource.</p>
</div>
<div class="listingblock">
<div class="title">Example listener configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
    listeners:
      - name: plain
        port: 9092
        type: internal
        tls: false
        configuration:
          useServiceDnsDomain: true
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: tls
      - name: external1
        port: 9094
        type: route
        tls: true
        configuration:
          brokerCertChainAndKey:
            secretName: my-secret
            certificate: my-certificate.crt
            key: my-key.key
    # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can configure as many listeners as required, as long as their names and ports are unique.
You can also configure listeners for secure connection using authentication.</p>
</div>
<div class="paragraph">
<p>If you want to know more about the pros and cons of each connection type, refer to <a href="https://strimzi.io/2019/04/17/accessing-kafka-part-1.html" target="_blank" rel="noopener">Accessing Apache Kafka in Strimzi</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you scale your Kafka cluster while using external listeners, it might trigger a rolling update of all Kafka brokers. This depends on the configuration.
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./configuring.html#type-GenericKafkaListener-reference"><code>GenericKafkaListener</code> schema reference</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="con-configuration-points-listener-names-str"><a class="link" href="#con-configuration-points-listener-names-str">12.3. Listener naming conventions</a></h3>
<div class="paragraph _abstract">
<p>From the listener configuration, the resulting listener bootstrap and per-broker service names are structured according to the following naming conventions:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 15. Listener naming conventions</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Listener type</th>
<th class="tableblock halign-left valign-top">Bootstrap service name</th>
<th class="tableblock halign-left valign-top">Per-Broker service name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>internal</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;cluster_name&gt;-kafka-bootstrap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Not applicable</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>loadbalancer</code><br>
  <code>nodeport</code><br>
  <code>ingress</code><br>
  <code>route</code><br>
  <code>cluster-ip</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;cluster_name&gt;-kafka-&lt;listener-name&gt;-bootstrap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;cluster_name&gt;-kafka-&lt;listener-name&gt;-&lt;idx&gt;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For example, <code>my-cluster-kafka-bootstrap</code>, <code>my-cluster-kafka-external1-bootstrap</code>, and <code>my-cluster-kafka-external1-0</code>.
The names are assigned to the services, routes, load balancers, and ingresses created through the listener configuration.</p>
</div>
<div class="paragraph">
<p>You can use certain backwards compatible names and port numbers to transition listeners initially configured under the retired <code>KafkaListeners</code> schema.
The resulting external listener naming convention varies slightly.
These specific combinations of listener name and port configuration values are backwards compatible:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 16. Backwards compatible listener name and port combinations</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 33.3333%;">
<col style="width: 33.3335%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Listener name</th>
<th class="tableblock halign-left valign-top">Port</th>
<th class="tableblock halign-left valign-top">Bootstrap service name</th>
<th class="tableblock halign-left valign-top">Per-Broker service name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>plain</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>9092</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;cluster_name&gt;-kafka-bootstrap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Not applicable</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>tls</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>9093</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;cluster-name&gt;-kafka-bootstrap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Not applicable</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>external</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>9094</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;cluster_name&gt;-kafka-bootstrap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;cluster_name&gt;-kafka-bootstrap-&lt;idx&gt;</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="setup-external-clients-str"><a class="link" href="#setup-external-clients-str">12.4. Setting up client access to a Kafka cluster using listeners</a></h3>
<div class="paragraph _abstract">
<p>Using the address of the Kafka cluster, you can provide access to a client in the same Kubernetes cluster; or provide external access to a client on a different Kubernetes namespace or outside Kubernetes entirely.
This procedure shows how to configure client access to a Kafka cluster from outside Kubernetes or from another Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>A Kafka listener provides access to the Kafka cluster.
Client access is secured using the following configuration:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>An external listener is configured for the Kafka cluster, with TLS encryption and mTLS authentication, and Kafka <code>simple</code> authorization enabled.</p>
</li>
<li>
<p>A <code>KafkaUser</code> is created for the client, with mTLS authentication, and Access Control Lists (ACLs) defined for <code>simple</code> authorization.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can configure your listener to use mutual <code>tls</code>, <code>scram-sha-512</code>, or <code>oauth</code> authentication.
mTLS always uses encryption, but encryption is also recommended when using SCRAM-SHA-512 and OAuth 2.0 authentication.</p>
</div>
<div class="paragraph">
<p>You can configure <code>simple</code>, <code>oauth</code>, <code>opa</code>, or <code>custom</code> authorization for Kafka brokers.
When enabled, authorization is applied to all enabled listeners.</p>
</div>
<div class="paragraph">
<p>When you configure the <code>KafkaUser</code> authentication and authorization mechanisms, ensure they match the equivalent Kafka configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>KafkaUser.spec.authentication</code> matches <code>Kafka.spec.kafka.listeners[*].authentication</code></p>
</li>
<li>
<p><code>KafkaUser.spec.authorization</code> matches <code>Kafka.spec.kafka.authorization</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You should have at least one listener supporting the authentication you want to use for the <code>KafkaUser</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Authentication between Kafka users and Kafka brokers depends on the authentication settings for each.
For example, it is not possible to authenticate a user with mTLS if it is not also enabled in the Kafka configuration.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Strimzi operators automate the configuration process and create the certificates required for authentication:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Cluster Operator creates the listeners and sets up the cluster and client certificate authority (CA) certificates to enable authentication with the Kafka cluster.</p>
</li>
<li>
<p>The User Operator creates the user representing the client and the security credentials used for client authentication, based on the chosen authentication type.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You add the certificates to your client configuration.</p>
</div>
<div class="paragraph">
<p>In this procedure, the CA certificates generated by the Cluster Operator are used, but you can replace them by <a href="#installing-your-own-ca-certificates-str">installing your own certificates</a>.
You can also configure your listener to <a href="#proc-installing-certs-per-listener-str">use a Kafka listener certificate managed by an external CA (certificate authority)</a>.</p>
</div>
<div class="paragraph">
<p>Certificates are available in PEM (.crt) and PKCS #12 (.p12) formats.
This procedure uses PEM certificates.
Use PEM certificates with clients that use certificates in X.509 format.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
For internal clients in the same Kubernetes cluster and namespace, you can mount the cluster CA certificate in the pod specification.
For more information, see <a href="#configuring-internal-clients-to-trust-cluster-ca-str">Configuring internal clients to trust the cluster CA</a>.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Kafka cluster is available for connection by a client running outside the Kubernetes cluster</p>
</li>
<li>
<p>The Cluster Operator and User Operator are running in the cluster</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure the Kafka cluster with a Kafka listener.</p>
<div class="ulist">
<ul>
<li>
<p>Define the authentication required to access the Kafka broker through the listener.</p>
</li>
<li>
<p>Enable authorization on the Kafka broker.</p>
<div class="listingblock">
<div class="title">Example listener configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
  namespace: myproject
spec:
  kafka:
    # ...
    listeners: # <b class="conum">(1)</b>
    - name: external1 # <b class="conum">(2)</b>
      port: 9094 # <b class="conum">(3)</b>
      type: <em>&lt;listener_type&gt;</em> # <b class="conum">(4)</b>
      tls: true # <b class="conum">(5)</b>
      authentication:
        type: tls # <b class="conum">(6)</b>
      configuration: # <b class="conum">(7)</b>
        #...
    authorization: # <b class="conum">(8)</b>
      type: simple
      superUsers:
        - super-user-name # <b class="conum">(9)</b>
  # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Configuration options for enabling external listeners are described in the <a href="./configuring.html#type-GenericKafkaListener-reference" target="_blank" rel="noopener">Generic Kafka listener schema reference</a>.</p>
</li>
<li>
<p>Name to identify the listener. Must be unique within the Kafka cluster.</p>
</li>
<li>
<p>Port number used by the listener inside Kafka. The port number has to be unique within a given Kafka cluster. Allowed port numbers are 9092 and higher with the exception of ports 9404 and 9999, which are already used for Prometheus and JMX. Depending on the listener type, the port number might not be the same as the port number that connects Kafka clients.</p>
</li>
<li>
<p>External listener type specified as <code>route</code> (OpenShift only), <code>loadbalancer</code>, <code>nodeport</code> or <code>ingress</code> (Kubernetes only). An internal listener is specified as <code>internal</code> or <code>cluster-ip</code>.</p>
</li>
<li>
<p>Required. TLS encryption on the listener. For <code>route</code> and <code>ingress</code> type listeners it must be set to <code>true</code>. For mTLS authentication, also use the <code>authentication</code> property.</p>
</li>
<li>
<p>Client authentication mechanism on the listener. For server and client authentication using mTLS, you specify <code>tls: true</code> and <code>authentication.type: tls</code>.</p>
</li>
<li>
<p>(Optional) Depending on the requirements of the listener type, you can specify additional <a href="./configuring.html#type-GenericKafkaListenerConfiguration-reference" target="_blank" rel="noopener">listener configuration</a>.</p>
</li>
<li>
<p>Authorization specified as <code>simple</code>, which uses the <code>AclAuthorizer</code> and <code>StandardAuthorizer</code> Kafka plugins.</p>
</li>
<li>
<p>(Optional) Super users can access all brokers regardless of any access restrictions defined in ACLs.</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
An OpenShift route address comprises the Kafka cluster name, the listener name, the project name, and the domain of the router.
For example, <code>my-cluster-kafka-external1-bootstrap-my-project.domain.com</code> (&lt;cluster_name&gt;-kafka-&lt;listener_name&gt;-bootstrap-&lt;namespace&gt;.&lt;domain&gt;).
Each DNS label (between periods &#8220;.&#8221;) must not exceed 63 characters, and the total length of the address must not exceed 255 characters.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Create or update the <code>Kafka</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Kafka cluster is configured with a Kafka broker listener using mTLS authentication.</p>
</div>
<div class="paragraph">
<p>A service is created for each Kafka broker pod.</p>
</div>
<div class="paragraph">
<p>A service is created to serve as the <em>bootstrap address</em> for connection to the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>A service is also created as the <em>external bootstrap address</em> for external connection to the Kafka cluster using <code>nodeport</code> listeners.</p>
</div>
<div class="paragraph">
<p>The cluster CA certificate to verify the identity of the kafka brokers is also created in the secret <code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you scale your Kafka cluster while using external listeners, it might trigger a rolling update of all Kafka brokers. This depends on the configuration.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Retrieve the bootstrap address you can use to access the Kafka cluster from the status of the <code>Kafka</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafka <em>&lt;kafka_cluster_name&gt;</em> -o=jsonpath='{.status.listeners[?(@.name=="<em>&lt;listener_name&gt;</em>")].bootstrapServers}{"\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafka my-cluster -o=jsonpath='{.status.listeners[?(@.name=="external")].bootstrapServers}{"\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the bootstrap address in your Kafka client to connect to the Kafka cluster.</p>
</div>
</li>
<li>
<p>Create or modify a user representing the client that requires access to the Kafka cluster.</p>
<div class="ulist">
<ul>
<li>
<p>Specify the same authentication type as the <code>Kafka</code> listener.</p>
</li>
<li>
<p>Specify the authorization ACLs for <code>simple</code> authorization.</p>
<div class="listingblock">
<div class="title">Example user configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster # <b class="conum">(1)</b>
spec:
  authentication:
    type: tls # <b class="conum">(2)</b>
  authorization:
    type: simple
    acls: # <b class="conum">(3)</b>
      - resource:
          type: topic
          name: my-topic
          patternType: literal
        operations:
          - Describe
          - Read
      - resource:
          type: group
          name: my-group
          patternType: literal
        operations:
          - Read</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The label must match the label of the Kafka cluster.</p>
</li>
<li>
<p>Authentication specified as mutual <code>tls</code>.</p>
</li>
<li>
<p>Simple authorization requires an accompanying list of ACL rules to apply to the user.
The rules define the operations allowed on Kafka resources based on the <em>username</em> (<code>my-user</code>).</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Create or modify the <code>KafkaUser</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>USER-CONFIG-FILE</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The user is created, as well as a secret with the same name as the <code>KafkaUser</code> resource.
The secret contains a public and private key for mTLS authentication.</p>
</div>
<div class="listingblock">
<div class="title">Example secret</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: my-user
  labels:
    strimzi.io/kind: KafkaUser
    strimzi.io/cluster: my-cluster
type: Opaque
data:
  ca.crt: <em>&lt;public_key&gt;</em> # Public key of the clients CA
  user.crt: <em>&lt;user_certificate&gt;</em> # Public key of the user
  user.key: <em>&lt;user_private_key&gt;</em> # Private key of the user
  user.p12: <em>&lt;store&gt;</em> # PKCS #12 store for user certificates and keys
  user.password: <em>&lt;password_for_store&gt;</em> # Protects the PKCS #12 store</code></pre>
</div>
</div>
</li>
<li>
<p>Extract the cluster CA certificate from the <code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code> secret of the Kafka cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>&lt;cluster_name&gt;</em>-cluster-ca-cert -o jsonpath='{.data.ca\.crt}' | base64 -d &gt; ca.crt</code></pre>
</div>
</div>
</li>
<li>
<p>Extract the user CA certificate from the <code><em>&lt;user_name&gt;</em></code> secret.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>&lt;user_name&gt;</em> -o jsonpath='{.data.user\.crt}' | base64 -d &gt; user.crt</code></pre>
</div>
</div>
</li>
<li>
<p>Extract the private key of the user from the <code><em>&lt;user_name&gt;</em></code> secret.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>&lt;user_name&gt;</em> -o jsonpath='{.data.user\.key}' | base64 -d &gt; user.key</code></pre>
</div>
</div>
</li>
<li>
<p>Configure your client with the bootstrap address hostname and port for connecting to the Kafka cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env">props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "<em>&lt;hostname&gt;:&lt;port&gt;</em>");</code></pre>
</div>
</div>
</li>
<li>
<p>Configure your client with the truststore credentials to verify the identity of the Kafka cluster.</p>
<div class="paragraph">
<p>Specify the public cluster CA certificate.</p>
</div>
<div class="listingblock">
<div class="title">Example truststore configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env">props.put(CommonClientConfigs.SECURITY_PROTOCOL_CONFIG, "SSL");
props.put(SslConfigs.SSL_TRUSTSTORE_TYPE_CONFIG, "PEM");
props.put(SslConfigs.SSL_TRUSTSTORE_CERTIFICATES_CONFIG, "<em>&lt;ca.crt_file_content&gt;</em>");</code></pre>
</div>
</div>
<div class="paragraph">
<p>SSL is the specified security protocol for mTLS authentication.
Specify <code>SASL_SSL</code> for SCRAM-SHA-512 authentication over TLS.
PEM is the file format of the truststore.</p>
</div>
</li>
<li>
<p>Configure your client with the keystore credentials to verify the user when connecting to the Kafka cluster.</p>
<div class="paragraph">
<p>Specify the public certificate and private key.</p>
</div>
<div class="listingblock">
<div class="title">Example keystore configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env">props.put(CommonClientConfigs.SECURITY_PROTOCOL_CONFIG, "SSL");
props.put(SslConfigs.SSL_KEYSTORE_TYPE_CONFIG, "PEM");
props.put(SslConfigs.SSL_KEYSTORE_CERTIFICATE_CHAIN_CONFIG, "<em>&lt;user.crt_file_content&gt;</em>");
props.put(SslConfigs.SSL_KEYSTORE_KEY_CONFIG, "<em>&lt;user.key_file_content&gt;</em>");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the keystore certificate and the private key directly to the configuration.
Add as a single-line format.
Between the <code>BEGIN CERTIFICATE</code> and <code>END CERTIFICATE</code> delimiters, start with a newline character (<code>\n</code>).
End each line from the original certificate with <code>\n</code> too.</p>
</div>
<div class="listingblock">
<div class="title">Example keystore configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env">props.put(SslConfigs.SSL_KEYSTORE_CERTIFICATE_CHAIN_CONFIG, "-----BEGIN CERTIFICATE----- \n<em>&lt;user_certificate_content_line_1&gt;</em>\n<em>&lt;user_certificate_content_line_n&gt;</em>\n-----END CERTIFICATE---");
props.put(SslConfigs.SSL_KEYSTORE_KEY_CONFIG, "----BEGIN PRIVATE KEY-----\n<em>&lt;user_key_content_line_1&gt;</em>\n<em>&lt;user_key_content_line_n&gt;</em>\n-----END PRIVATE KEY-----");</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#con-securing-kafka-authentication-str">Listener authentication</a></p>
</li>
<li>
<p><a href="#con-securing-kafka-authorization-str">Kafka authorization</a></p>
</li>
<li>
<p>If you are using an authorization server, you can use token-based authentication and authorization:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#assembly-oauth-authentication_str">Using OAuth 2.0 token-based authentication</a></p>
</li>
<li>
<p><a href="#assembly-oauth-authorization_str">Using OAuth 2.0 token-based authorization</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="proc-accessing-kafka-using-nodeports-str"><a class="link" href="#proc-accessing-kafka-using-nodeports-str">12.5. Accessing Kafka using node ports</a></h3>
<div class="paragraph _abstract">
<p>Use node ports to access a Strimzi Kafka cluster from an external client outside the Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>To connect to a broker, you specify a hostname and port number for the Kafka bootstrap address, as well as the certificate used for TLS encryption.</p>
</div>
<div class="paragraph">
<p>The procedure shows basic <code>nodeport</code> listener configuration.
You can use listener properties to enable TLS encryption (<code>tls</code>) and specify a client authentication mechanism (<code>authentication</code>).
Add additional configuration using <code>configuration</code> properties.
For example, you can use the following configuration properties with <code>nodeport</code> listeners:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>preferredNodePortAddressType</code></dt>
<dd>
<p>Specifies the first address type that&#8217;s checked as the node address.</p>
</dd>
<dt class="hdlist1"><code>externalTrafficPolicy</code></dt>
<dd>
<p>Specifies whether the service routes external traffic to node-local or cluster-wide endpoints.</p>
</dd>
<dt class="hdlist1"><code>nodePort</code></dt>
<dd>
<p>Overrides the assigned node port numbers for the bootstrap and broker services.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For more information on listener configuration, see the <a href="./configuring.html#type-GenericKafkaListener-reference" target="_blank" rel="noopener"><code>GenericKafkaListener</code> schema reference</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A running Cluster Operator</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this procedure, the Kafka cluster name is <code>my-cluster</code>.
The name of the listener is <code>external4</code>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure a <code>Kafka</code> resource with an external listener set to the <code>nodeport</code> type.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  labels:
    app: my-cluster
  name: my-cluster
  namespace: myproject
spec:
  kafka:
    # ...
    listeners:
      - name: external4
        port: 9094
        type: nodeport
        tls: true
        authentication:
          type: tls
        # ...
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Create or update the resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>A cluster CA certificate to verify the identity of the kafka brokers is created in the secret <code>my-cluster-cluster-ca-cert</code>.</p>
</div>
<div class="paragraph">
<p><code>NodePort</code> type services are created for each Kafka broker, as well as an external bootstrap service.</p>
</div>
<div class="listingblock">
<div class="title">Node port services created for the bootstrap and brokers</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                                  TYPE      CLUSTER-IP      PORT(S)
my-cluster-kafka-external4-0          NodePort  172.30.55.13    9094:31789/TCP
my-cluster-kafka-external4-1          NodePort  172.30.250.248  9094:30028/TCP
my-cluster-kafka-external4-2          NodePort  172.30.115.81   9094:32650/TCP
my-cluster-kafka-external4-bootstrap  NodePort  172.30.30.23    9094:32650/TCP</code></pre>
</div>
</div>
<div class="paragraph">
<p>The bootstrap address used for client connection is propagated to the <code>status</code> of the <code>Kafka</code> resource.</p>
</div>
<div class="listingblock">
<div class="title">Example status for the bootstrap address</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">status:
  clusterId: Y_RJQDGKRXmNF7fEcWldJQ
  conditions:
    - lastTransitionTime: '2023-01-31T14:59:37.113630Z'
      status: 'True'
      type: Ready
  kafkaVersion: 3.6.1
  listeners:
    # ...
    - addresses:
        - host: ip-10-0-224-199.us-west-2.compute.internal
          port: 32650
      bootstrapServers: 'ip-10-0-224-199.us-west-2.compute.internal:32650'
      certificates:
        - |
          -----BEGIN CERTIFICATE-----

          -----END CERTIFICATE-----
      name: external4
  observedGeneration: 2
  operatorLastSuccessfulVersion: 0.39.0
 # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Retrieve the bootstrap address you can use to access the Kafka cluster from the status of the <code>Kafka</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafka my-cluster -o=jsonpath='{.status.listeners[?(@.name=="external4")].bootstrapServers}{"\n"}'

ip-10-0-224-199.us-west-2.compute.internal:32650</code></pre>
</div>
</div>
</li>
<li>
<p>Extract the cluster CA certificate.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret my-cluster-cluster-ca-cert -o jsonpath='{.data.ca\.crt}' | base64 -d &gt; ca.crt</code></pre>
</div>
</div>
</li>
<li>
<p>Configure your client to connect to the brokers.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Specify the bootstrap host and port in your Kafka client as the bootstrap address to connect to the Kafka cluster. For example, <code>ip-10-0-224-199.us-west-2.compute.internal:32650</code>.</p>
</li>
<li>
<p>Add the extracted certificate to the truststore of your Kafka client to configure a TLS connection.</p>
<div class="paragraph">
<p>If you enabled a client authentication mechanism, you will also need to configure it in your client.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using your own listener certificates, check whether you need to add the CA certificate to the client&#8217;s truststore configuration.
If it is a public (external) CA, you usually won&#8217;t need to add it.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="proc-accessing-kafka-using-loadbalancers-str"><a class="link" href="#proc-accessing-kafka-using-loadbalancers-str">12.6. Accessing Kafka using loadbalancers</a></h3>
<div class="paragraph _abstract">
<p>Use loadbalancers to access a Strimzi Kafka cluster from an external client outside the Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>To connect to a broker, you specify a hostname and port number for the Kafka bootstrap address, as well as the certificate used for TLS encryption.</p>
</div>
<div class="paragraph">
<p>The procedure shows basic <code>loadbalancer</code> listener configuration.
You can use listener properties to enable TLS encryption (<code>tls</code>) and specify a client authentication mechanism (<code>authentication</code>).
Add additional configuration using <code>configuration</code> properties.
For example, you can use the following configuration properties with <code>loadbalancer</code> listeners:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>loadBalancerSourceRanges</code></dt>
<dd>
<p>Restricts traffic to a specified list of CIDR (Classless Inter-Domain Routing) ranges.</p>
</dd>
<dt class="hdlist1"><code>externalTrafficPolicy</code></dt>
<dd>
<p>Specifies whether the service routes external traffic to node-local or cluster-wide endpoints.</p>
</dd>
<dt class="hdlist1"><code>loadBalancerIP</code></dt>
<dd>
<p>Requests a specific IP address when creating a loadbalancer.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For more information on listener configuration, see the <a href="./configuring.html#type-GenericKafkaListener-reference" target="_blank" rel="noopener"><code>GenericKafkaListener</code> schema reference</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A running Cluster Operator</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this procedure, the Kafka cluster name is <code>my-cluster</code>.
The name of the listener is <code>external3</code>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure a <code>Kafka</code> resource with an external listener set to the <code>loadbalancer</code> type.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  labels:
    app: my-cluster
  name: my-cluster
  namespace: myproject
spec:
  kafka:
    # ...
    listeners:
      - name: external3
        port: 9094
        type: loadbalancer
        tls: true
        authentication:
          type: tls
        # ...
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Create or update the resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>A cluster CA certificate to verify the identity of the kafka brokers is also created in the secret <code>my-cluster-cluster-ca-cert</code>.</p>
</div>
<div class="paragraph">
<p><code>loadbalancer</code> type services and loadbalancers are created for each Kafka broker, as well as an external bootstrap service.</p>
</div>
<div class="listingblock">
<div class="title">Loadbalancer services and loadbalancers created for the bootstraps and brokers</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                                  TYPE            CLUSTER-IP      PORT(S)
my-cluster-kafka-external3-0          LoadBalancer    172.30.204.234  9094:30011/TCP
my-cluster-kafka-external3-1          LoadBalancer    172.30.164.89   9094:32544/TCP
my-cluster-kafka-external3-2          LoadBalancer    172.30.73.151   9094:32504/TCP
my-cluster-kafka-external3-bootstrap  LoadBalancer    172.30.30.228   9094:30371/TCP

NAME                                  EXTERNAL-IP (loadbalancer)
my-cluster-kafka-external3-0          a8a519e464b924000b6c0f0a05e19f0d-1132975133.us-west-2.elb.amazonaws.com
my-cluster-kafka-external3-1          ab6adc22b556343afb0db5ea05d07347-611832211.us-west-2.elb.amazonaws.com
my-cluster-kafka-external3-2          a9173e8ccb1914778aeb17eca98713c0-777597560.us-west-2.elb.amazonaws.com
my-cluster-kafka-external3-bootstrap  a8d4a6fb363bf447fb6e475fc3040176-36312313.us-west-2.elb.amazonaws.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>The bootstrap address used for client connection is propagated to the <code>status</code> of the <code>Kafka</code> resource.</p>
</div>
<div class="listingblock">
<div class="title">Example status for the bootstrap address</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">status:
  clusterId: Y_RJQDGKRXmNF7fEcWldJQ
  conditions:
    - lastTransitionTime: '2023-01-31T14:59:37.113630Z'
      status: 'True'
      type: Ready
  kafkaVersion: 3.6.1
  listeners:
    # ...
    - addresses:
        - host: &gt;-
            a8d4a6fb363bf447fb6e475fc3040176-36312313.us-west-2.elb.amazonaws.com
          port: 9094
      bootstrapServers: &gt;-
        a8d4a6fb363bf447fb6e475fc3040176-36312313.us-west-2.elb.amazonaws.com:9094
      certificates:
        - |
          -----BEGIN CERTIFICATE-----

          -----END CERTIFICATE-----
      name: external3
  observedGeneration: 2
  operatorLastSuccessfulVersion: 0.39.0
 # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The DNS addresses used for client connection are propagated to the <code>status</code> of each loadbalancer service.</p>
</div>
<div class="listingblock">
<div class="title">Example status for the bootstrap loadbalancer</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">status:
  loadBalancer:
    ingress:
      - hostname: &gt;-
          a8d4a6fb363bf447fb6e475fc3040176-36312313.us-west-2.elb.amazonaws.com
 # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Retrieve the bootstrap address you can use to access the Kafka cluster from the status of the <code>Kafka</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafka my-cluster -o=jsonpath='{.status.listeners[?(@.name=="external3")].bootstrapServers}{"\n"}'

a8d4a6fb363bf447fb6e475fc3040176-36312313.us-west-2.elb.amazonaws.com:9094</code></pre>
</div>
</div>
</li>
<li>
<p>Extract the cluster CA certificate.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret my-cluster-cluster-ca-cert -o jsonpath='{.data.ca\.crt}' | base64 -d &gt; ca.crt</code></pre>
</div>
</div>
</li>
<li>
<p>Configure your client to connect to the brokers.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Specify the bootstrap host and port in your Kafka client as the bootstrap address to connect to the Kafka cluster. For example, <code>a8d4a6fb363bf447fb6e475fc3040176-36312313.us-west-2.elb.amazonaws.com:9094</code>.</p>
</li>
<li>
<p>Add the extracted certificate to the truststore of your Kafka client to configure a TLS connection.</p>
<div class="paragraph">
<p>If you enabled a client authentication mechanism, you will also need to configure it in your client.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using your own listener certificates, check whether you need to add the CA certificate to the client&#8217;s truststore configuration.
If it is a public (external) CA, you usually won&#8217;t need to add it.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="proc-accessing-kafka-using-ingress-str"><a class="link" href="#proc-accessing-kafka-using-ingress-str">12.7. Accessing Kafka using an Ingress NGINX Controller for Kubernetes</a></h3>
<div class="paragraph _abstract">
<p>Use an <a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener">Ingress NGINX Controller for Kubernetes</a> to access a Strimzi Kafka cluster from clients outside the Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>To be able to use an Ingress NGINX Controller for Kubernetes, add configuration for an <code>ingress</code> type listener in the <code>Kafka</code> custom resource.
When applied, the configuration creates a dedicated ingress and service for an external bootstrap and each broker in the cluster.
Clients connect to the bootstrap ingress, which routes them through the bootstrap service to connect to a broker.
Per-broker connections are then established using DNS names, which route traffic from the client to the broker through the broker-specific ingresses and services.</p>
</div>
<div class="paragraph">
<p>To connect to a broker, you specify a hostname for the ingress bootstrap address, as well as the certificate used for TLS encryption.
For access using an ingress, the port used in the Kafka client is typically 443.</p>
</div>
<div class="paragraph">
<p>The procedure shows basic <code>ingress</code> listener configuration.
TLS encryption (<code>tls</code>) must be enabled.
You can also specify a client authentication mechanism (<code>authentication</code>).
Add additional configuration using <code>configuration</code> properties.
For example, you can use the <code>class</code> configuration property with <code>ingress</code> listeners to specify the ingress controller used.</p>
</div>
<div class="paragraph">
<p>For more information on listener configuration, see the <a href="./configuring.html#type-GenericKafkaListener-reference" target="_blank" rel="noopener"><code>GenericKafkaListener</code> schema reference</a>.</p>
</div>
<div class="paragraph">
<div class="title">TLS passthrough</div>
<p>Make sure that you enable TLS passthrough in your Ingress NGINX Controller for Kubernetes deployment.
Kafka uses a binary protocol over TCP, but the Ingress NGINX Controller for Kubernetes is designed to work with a HTTP protocol.
To be able to route TCP traffic through ingresses, Strimzi uses TLS passthrough with Server Name Indication (SNI).</p>
</div>
<div class="paragraph">
<p>SNI helps with identifying and passing connection to Kafka brokers.
In passthrough mode, TLS encryption is always used.
Because the connection passes to the brokers, the listeners use the TLS certificates signed by the internal cluster CA and not the ingress certificates.
To configure listeners to use your own listener certificates, <a href="#proc-installing-certs-per-listener-str">use the <code>brokerCertChainAndKey</code> property</a>.</p>
</div>
<div class="paragraph">
<p>For more information about enabling TLS passthrough, see the <a href="https://kubernetes.github.io/ingress-nginx/user-guide/tls/#ssl-passthrough">TLS passthrough documentation</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>An Ingress NGINX Controller for Kubernetes is running with TLS passthrough enabled</p>
</li>
<li>
<p>A running Cluster Operator</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this procedure, the Kafka cluster name is <code>my-cluster</code>.
The name of the listener is <code>external2</code>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure a <code>Kafka</code> resource with an external listener set to the <code>ingress</code> type.</p>
<div class="paragraph">
<p>Specify an ingress hostname for the bootstrap service and each of the Kafka brokers in the Kafka cluster.
Add any hostname to the <code>bootstrap</code> and <code>broker-&lt;index&gt;</code> prefixes that identify the bootstrap and brokers.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  labels:
    app: my-cluster
  name: my-cluster
  namespace: myproject
spec:
  kafka:
    # ...
    listeners:
      - name: external2
        port: 9094
        type: ingress
        tls: true # <b class="conum">(1)</b>
        authentication:
          type: tls
        configuration:
          bootstrap:
            host: bootstrap.myingress.com
          brokers:
          - broker: 0
            host: broker-0.myingress.com
          - broker: 1
            host: broker-1.myingress.com
          - broker: 2
            host: broker-2.myingress.com
          class: nginx  # <b class="conum">(2)</b>
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>For <code>ingress</code> type listeners, TLS encryption must be enabled (<code>true</code>).</p>
</li>
<li>
<p>(Optional) Class that specifies the ingress controller to use. You might need to add a class if you have not set up a default and a class name is missing in the ingresses created.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create or update the resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>A cluster CA certificate to verify the identity of the kafka brokers is created in the secret <code>my-cluster-cluster-ca-cert</code>.</p>
</div>
<div class="paragraph">
<p><code>ClusterIP</code> type services are created for each Kafka broker, as well as an external bootstrap service.</p>
</div>
<div class="paragraph">
<p>An <code>ingress</code> is also created for each service, with a DNS address to expose them using the Ingress NGINX Controller for Kubernetes.</p>
</div>
<div class="listingblock">
<div class="title">Ingresses created for the bootstrap and brokers</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                                  CLASS  HOSTS                    ADDRESS       PORTS
my-cluster-kafka-external2-0          nginx  broker-0.myingress.com   192.168.49.2  80,443
my-cluster-kafka-external2-1          nginx  broker-1.myingress.com   192.168.49.2  80,443
my-cluster-kafka-external2-2          nginx  broker-2.myingress.com   192.168.49.2  80,443
my-cluster-kafka-external2-bootstrap  nginx  bootstrap.myingress.com  192.168.49.2  80,443</code></pre>
</div>
</div>
<div class="paragraph">
<p>The DNS addresses used for client connection are propagated to the <code>status</code> of each ingress.</p>
</div>
<div class="listingblock">
<div class="title">Status for the bootstrap ingress</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">status:
  loadBalancer:
    ingress:
    - ip: 192.168.49.2
 # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Use a target broker to check the client-server TLS connection on port 443 using the OpenSSL <code>s_client</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">openssl s_client -connect broker-0.myingress.com:443 -servername broker-0.myingress.com -showcerts</code></pre>
</div>
</div>
<div class="paragraph">
<p>The server name is the SNI for passing the connection to the broker.</p>
</div>
<div class="paragraph">
<p>If the connection is successful, the certificates for the broker are returned.</p>
</div>
<div class="listingblock">
<div class="title">Certificates for the broker</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Certificate chain
 0 s:O = io.strimzi, CN = my-cluster-kafka
   i:O = io.strimzi, CN = cluster-ca v0</code></pre>
</div>
</div>
</li>
<li>
<p>Extract the cluster CA certificate.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret my-cluster-cluster-ca-cert -o jsonpath='{.data.ca\.crt}' | base64 -d &gt; ca.crt</code></pre>
</div>
</div>
</li>
<li>
<p>Configure your client to connect to the brokers.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Specify the bootstrap host (from the listener <code>configuration</code>) and port 443 in your Kafka client as the bootstrap address to connect to the Kafka cluster. For example, <code>bootstrap.myingress.com:443</code>.</p>
</li>
<li>
<p>Add the extracted certificate to the truststore of your Kafka client to configure a TLS connection.</p>
<div class="paragraph">
<p>If you enabled a client authentication mechanism, you will also need to configure it in your client.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using your own listener certificates, check whether you need to add the CA certificate to the client&#8217;s truststore configuration.
If it is a public (external) CA, you usually won&#8217;t need to add it.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="proc-accessing-kafka-using-routes-str"><a class="link" href="#proc-accessing-kafka-using-routes-str">12.8. Accessing Kafka using OpenShift routes</a></h3>
<div class="paragraph _abstract">
<p>Use OpenShift routes to access a Strimzi Kafka cluster from clients outside the OpenShift cluster.</p>
</div>
<div class="paragraph">
<p>To be able to use routes, add configuration for a <code>route</code> type listener in the <code>Kafka</code> custom resource.
When applied, the configuration creates a dedicated route and service for an external bootstrap and each broker in the cluster.
Clients connect to the bootstrap route, which routes them through the bootstrap service to connect to a broker.
Per-broker connections are then established using DNS names, which route traffic from the client to the broker through the broker-specific routes and services.</p>
</div>
<div class="paragraph">
<p>To connect to a broker, you specify a hostname for the route bootstrap address, as well as the certificate used for TLS encryption.
For access using routes, the port is always 443.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
An OpenShift route address comprises the Kafka cluster name, the listener name, the project name, and the domain of the router.
For example, <code>my-cluster-kafka-external1-bootstrap-my-project.domain.com</code> (&lt;cluster_name&gt;-kafka-&lt;listener_name&gt;-bootstrap-&lt;namespace&gt;.&lt;domain&gt;).
Each DNS label (between periods &#8220;.&#8221;) must not exceed 63 characters, and the total length of the address must not exceed 255 characters.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The procedure shows basic listener configuration.
TLS encryption (<code>tls</code>) must be enabled.
You can also specify a client authentication mechanism (<code>authentication</code>).
Add additional configuration using <code>configuration</code> properties.
For example, you can use the <code>host</code> configuration property with <code>route</code> listeners to specify the hostnames used by the bootstrap and per-broker services.</p>
</div>
<div class="paragraph">
<p>For more information on listener configuration, see the <a href="./configuring.html#type-GenericKafkaListener-reference" target="_blank" rel="noopener"><code>GenericKafkaListener</code> schema reference</a>.</p>
</div>
<div class="paragraph">
<div class="title">TLS passthrough</div>
<p>TLS passthrough is enabled for routes created by Strimzi.
Kafka uses a binary protocol over TCP, but routes are designed to work with a HTTP protocol.
To be able to route TCP traffic through routes, Strimzi uses TLS passthrough with Server Name Indication (SNI).</p>
</div>
<div class="paragraph">
<p>SNI helps with identifying and passing connection to Kafka brokers.
In passthrough mode, TLS encryption is always used.
Because the connection passes to the brokers, the listeners use TLS certificates signed by the internal cluster CA and not the ingress certificates.
To configure listeners to use your own listener certificates, <a href="#proc-installing-certs-per-listener-str">use the <code>brokerCertChainAndKey</code> property</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A running Cluster Operator</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this procedure, the Kafka cluster name is <code>my-cluster</code>.
The name of the listener is <code>external1</code>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure a <code>Kafka</code> resource with an external listener set to the <code>route</code> type.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  labels:
    app: my-cluster
  name: my-cluster
  namespace: myproject
spec:
  kafka:
    # ...
    listeners:
      - name: external1
        port: 9094
        type: route
        tls: true # <b class="conum">(1)</b>
        authentication:
          type: tls
        # ...
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>For <code>route</code> type listeners, TLS encryption must be enabled (<code>true</code>).</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create or update the resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>A cluster CA certificate to verify the identity of the kafka brokers is created in the secret <code>my-cluster-cluster-ca-cert</code>.</p>
</div>
<div class="paragraph">
<p><code>ClusterIP</code> type services are created for each Kafka broker, as well as an external bootstrap service.</p>
</div>
<div class="paragraph">
<p>A <code>route</code> is also created for each service, with a DNS address (host/port) to expose them using the default OpenShift HAProxy router.</p>
</div>
<div class="paragraph">
<p>The routes are preconfigured with TLS passthrough.</p>
</div>
<div class="listingblock">
<div class="title">Routes created for the bootstraps and brokers</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                                  HOST/PORT                                                  SERVICES                              PORT  TERMINATION
my-cluster-kafka-external1-0          my-cluster-kafka-external1-0-my-project.router.com         my-cluster-kafka-external1-0          9094  passthrough
my-cluster-kafka-external1-1          my-cluster-kafka-external1-1-my-project.router.com         my-cluster-kafka-external1-1          9094  passthrough
my-cluster-kafka-external1-2          my-cluster-kafka-external1-2-my-project.router.com         my-cluster-kafka-external1-2          9094  passthrough
my-cluster-kafka-external1-bootstrap  my-cluster-kafka-external1-bootstrap-my-project.router.com my-cluster-kafka-external1-bootstrap  9094  passthrough</code></pre>
</div>
</div>
<div class="paragraph">
<p>The DNS addresses used for client connection are propagated to the <code>status</code> of each route.</p>
</div>
<div class="listingblock">
<div class="title">Example status for the bootstrap route</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">status:
  ingress:
    - host: &gt;-
        my-cluster-kafka-external1-bootstrap-my-project.router.com
 # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Use a target broker to check the client-server TLS connection on port 443 using the OpenSSL <code>s_client</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">openssl s_client -connect my-cluster-kafka-external1-0-my-project.router.com:443 -servername my-cluster-kafka-external1-0-my-project.router.com -showcerts</code></pre>
</div>
</div>
<div class="paragraph">
<p>The server name is the Server Name Indication (SNI) for passing the connection to the broker.</p>
</div>
<div class="paragraph">
<p>If the connection is successful, the certificates for the broker are returned.</p>
</div>
<div class="listingblock">
<div class="title">Certificates for the broker</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Certificate chain
 0 s:O = io.strimzi, CN = my-cluster-kafka
   i:O = io.strimzi, CN = cluster-ca v0</code></pre>
</div>
</div>
</li>
<li>
<p>Retrieve the address of the bootstrap service from the status of the <code>Kafka</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafka my-cluster -o=jsonpath='{.status.listeners[?(@.name=="external1")].bootstrapServers}{"\n"}'

my-cluster-kafka-external1-bootstrap-my-project.router.com:443</code></pre>
</div>
</div>
<div class="paragraph">
<p>The address comprises the Kafka cluster name, the listener name, the project name and the domain of the router (<code>router.com</code> in this example).</p>
</div>
</li>
<li>
<p>Extract the cluster CA certificate.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret my-cluster-cluster-ca-cert -o jsonpath='{.data.ca\.crt}' | base64 -d &gt; ca.crt</code></pre>
</div>
</div>
</li>
<li>
<p>Configure your client to connect to the brokers.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Specify the address for the bootstrap service and port 443 in your Kafka client as the bootstrap address to connect to the Kafka cluster.</p>
</li>
<li>
<p>Add the extracted certificate to the truststore of your Kafka client to configure a TLS connection.</p>
<div class="paragraph">
<p>If you enabled a client authentication mechanism, you will also need to configure it in your client.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using your own listener certificates, check whether you need to add the CA certificate to the client&#8217;s truststore configuration.
If it is a public (external) CA, you usually won&#8217;t need to add it.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-securing-access-str"><a class="link" href="#assembly-securing-access-str">13. Managing secure access to Kafka</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Secure your Kafka cluster by managing the access a client has to Kafka brokers.
Specify configuration options to secure Kafka brokers and clients</p>
</div>
<div class="paragraph">
<p>A secure connection between Kafka brokers and clients can encompass the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Encryption for data exchange</p>
</li>
<li>
<p>Authentication to prove identity</p>
</li>
<li>
<p>Authorization to allow or decline actions executed by users</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The authentication and authorization mechanisms specified for a client must match those specified for the Kafka brokers.
Strimzi operators automate the configuration process and create the certificates required for authentication.
The Cluster Operator automatically sets up TLS certificates for data encryption and authentication within your cluster.</p>
</div>
<div class="sect2">
<h3 id="assembly-securing-kafka-brokers-str"><a class="link" href="#assembly-securing-kafka-brokers-str">13.1. Security options for Kafka</a></h3>
<div class="paragraph">
<p>Use the <code>Kafka</code> resource to configure the mechanisms used for Kafka authentication and authorization.</p>
</div>
<div class="sect3">
<h4 id="con-securing-kafka-authentication-str"><a class="link" href="#con-securing-kafka-authentication-str">13.1.1. Listener authentication</a></h4>
<div class="paragraph _abstract">
<p>Configure client authentication for Kafka brokers when creating listeners.
Specify the listener authentication type using the <code>Kafka.spec.kafka.listeners.authentication</code> property in the <code>Kafka</code> resource.</p>
</div>
<div class="paragraph">
<p>For clients inside the Kubernetes cluster, you can create <code>plain</code> (without encryption) or <code>tls</code> <em>internal</em> listeners.
The <code>internal</code> listener type use a headless service and the DNS names given to the broker pods.
As an alternative to the headless service, you can also create a <code>cluster-ip</code> type of internal listener to expose Kafka using per-broker <code>ClusterIP</code> services.
For clients outside the Kubernetes cluster, you create <em>external</em> listeners and specify a connection mechanism,
which can be <code>nodeport</code>, <code>loadbalancer</code>, <code>ingress</code> (Kubernetes only), or <code>route</code> (OpenShift only).</p>
</div>
<div class="paragraph">
<p>For more information on the configuration options for connecting an external client, see <a href="#deploy-client-access-str">Setting up client access to a Kafka cluster</a>.</p>
</div>
<div class="paragraph">
<p>Supported authentication options:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>mTLS authentication (only on the listeners with TLS enabled encryption)</p>
</li>
<li>
<p>SCRAM-SHA-512 authentication</p>
</li>
<li>
<p><a href="#assembly-oauth-authentication_str">OAuth 2.0 token-based authentication</a></p>
</li>
<li>
<p><a href="./configuring.html#type-KafkaListenerAuthenticationCustom-reference" target="_blank" rel="noopener">Custom authentication</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The authentication option you choose depends on how you wish to authenticate client access to Kafka brokers.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Try exploring the standard authentication options before using custom authentication. Custom authentication allows for any type of Kafka-supported authentication. It can provide more flexibility, but also adds complexity.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="images/listener-config-options.png" alt="options for listener authentication configuration">
</div>
<div class="title">Figure 2. Kafka listener authentication options</div>
</div>
<div class="paragraph">
<p>The listener <code>authentication</code> property is used to specify an authentication mechanism specific to that listener.</p>
</div>
<div class="paragraph">
<p>If no <code>authentication</code> property is specified then the listener does not authenticate clients which connect through that listener.
The listener will accept all connections without authentication.</p>
</div>
<div class="paragraph">
<p>Authentication must be configured when using the User Operator to manage <code>KafkaUsers</code>.</p>
</div>
<div class="paragraph">
<p>The following example shows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>plain</code> listener configured for SCRAM-SHA-512 authentication</p>
</li>
<li>
<p>A <code>tls</code> listener with mTLS authentication</p>
</li>
<li>
<p>An <code>external</code> listener with mTLS authentication</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each listener is configured with a unique name and port within a Kafka cluster.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
When configuring listeners for client access to brokers, you can use port 9092 or higher (9093, 9094, and so on), but with a few exceptions.
The listeners cannot be configured to use the ports reserved for interbroker communication (9090 and 9091), Prometheus metrics (9404), and JMX (Java Management Extensions) monitoring (9999).
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example listener authentication configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
  namespace: myproject
spec:
  kafka:
    # ...
    listeners:
      - name: plain
        port: 9092
        type: internal
        tls: true
        authentication:
          type: scram-sha-512
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: tls
      - name: external3
        port: 9094
        type: loadbalancer
        tls: true
        authentication:
          type: tls
# ...</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="con-mutual-tls-authentication-str"><a class="link" href="#con-mutual-tls-authentication-str">mTLS authentication</a></h5>
<div class="paragraph">
<p>mTLS authentication is always used for the communication between Kafka brokers and ZooKeeper pods.</p>
</div>
<div class="paragraph">
<p>Strimzi can configure Kafka to use TLS (Transport Layer Security) to provide encrypted communication between Kafka brokers and clients either with or without mutual authentication.
For mutual, or two-way, authentication, both the server and the client present certificates.
When you configure mTLS authentication, the broker authenticates the client (client authentication) and the client authenticates the broker (server authentication).</p>
</div>
<div class="paragraph">
<p>mTLS listener configuration in the <code>Kafka</code> resource requires the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>tls: true</code> to specify TLS encryption and server authentication</p>
</li>
<li>
<p><code>authentication.type: tls</code> to specify the client authentication</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When a Kafka cluster is created by the Cluster Operator, it creates a new secret with the name <code>&lt;cluster_name&gt;-cluster-ca-cert</code>.
The secret contains a CA certificate.
The CA certificate is in <a href="#certificates-and-secrets-formats-str">PEM and PKCS #12 format</a>.
To verify a Kafka cluster, add the CA certificate to the truststore in your client configuration.
To verify a client, add a user certificate and key to the keystore in your client configuration.
For more information on configuring a client for mTLS, see <a href="#con-securing-client-authentication-str">User authentication</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TLS authentication is more commonly one-way, with one party authenticating the identity of another.
For example, when HTTPS is used between a web browser and a web server, the browser obtains proof of the identity of the web server.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="con-scram-sha-authentication-str"><a class="link" href="#con-scram-sha-authentication-str">SCRAM-SHA-512 authentication</a></h5>
<div class="paragraph">
<p>SCRAM (Salted Challenge Response Authentication Mechanism) is an authentication protocol that can establish mutual authentication using passwords.
Strimzi can configure Kafka to use SASL (Simple Authentication and Security Layer) SCRAM-SHA-512 to provide authentication on both unencrypted and encrypted client connections.</p>
</div>
<div class="paragraph">
<p>When SCRAM-SHA-512 authentication is used with a TLS connection, the TLS protocol provides the encryption, but is not used for authentication.</p>
</div>
<div class="paragraph">
<p>The following properties of SCRAM make it safe to use SCRAM-SHA-512 even on unencrypted connections:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The passwords are not sent in the clear over the communication channel.
Instead the client and the server are each challenged by the other to offer proof that they know the password of the authenticating user.</p>
</li>
<li>
<p>The server and client each generate a new challenge for each authentication exchange.
This means that the exchange is resilient against replay attacks.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When <code>KafkaUser.spec.authentication.type</code> is configured with <code>scram-sha-512</code> the User Operator will generate a random 12-character password consisting of upper and lowercase ASCII letters and numbers.</p>
</div>
</div>
<div class="sect4">
<h5 id="assembly-kafka-broker-listener-network-policies-str"><a class="link" href="#assembly-kafka-broker-listener-network-policies-str">Network policies</a></h5>
<div class="paragraph">
<p>By default, Strimzi automatically creates a <code>NetworkPolicy</code> resource for every listener that is enabled on a Kafka broker.
This <code>NetworkPolicy</code> allows applications to connect to listeners in all namespaces.
Use network policies as part of the listener configuration.</p>
</div>
<div class="paragraph">
<p>If you want to restrict access to a listener at the network level to only selected applications or namespaces, use the <code>networkPolicyPeers</code> property.
Each listener can have a different <a href="./configuring.html#configuration-listener-network-policy-reference"><code>networkPolicyPeers</code> configuration</a>.
For more information on network policy peers, refer to the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#networkpolicypeer-v1-networking-k8s-io" target="_blank" rel="noopener">NetworkPolicyPeer API reference</a>.</p>
</div>
<div class="paragraph">
<p>If you want to use custom network policies, you can set the <code>STRIMZI_NETWORK_POLICY_GENERATION</code> environment variable to <code>false</code> in the Cluster Operator configuration.
For more information, see <a href="#ref-operator-cluster-str">Configuring the Cluster Operator</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Your configuration of Kubernetes must support ingress <code>NetworkPolicies</code> in order to use network policies in Strimzi.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="providing_listener_certificates"><a class="link" href="#providing_listener_certificates">Providing listener certificates</a></h5>
<div class="paragraph">
<p>You can provide your own server certificates, called <em>Kafka listener certificates</em>, for TLS listeners or external listeners which have TLS encryption enabled.
For more information, see <a href="#proc-installing-certs-per-listener-str">Providing your own Kafka listener certificates for TLS encryption</a>.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./configuring.html#type-GenericKafkaListener-reference"><code>GenericKafkaListener</code> schema reference</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="con-securing-kafka-authorization-str"><a class="link" href="#con-securing-kafka-authorization-str">13.1.2. Kafka authorization</a></h4>
<div class="paragraph _abstract">
<p>Configure authorization for Kafka brokers using the <code>Kafka.spec.kafka.authorization</code> property in the <code>Kafka</code> resource.
If the <code>authorization</code> property is missing, no authorization is enabled and clients have no restrictions.
When enabled, authorization is applied to all enabled listeners.
The authorization method is defined in the <code>type</code> field.</p>
</div>
<div class="paragraph">
<p>Supported authorization options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./configuring.html#type-KafkaAuthorizationSimple-reference">Simple authorization</a></p>
</li>
<li>
<p><a href="#assembly-oauth-authorization_str">OAuth 2.0 authorization</a> (if you are using OAuth 2.0 token based authentication)</p>
</li>
<li>
<p><a href="./configuring.html#type-KafkaAuthorizationOpa-reference">Open Policy Agent (OPA) authorization</a></p>
</li>
<li>
<p><a href="./configuring.html#type-KafkaAuthorizationCustom-reference">Custom authorization</a></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/kafka-authorization-config-options.png" alt="options for kafka authorization configuration">
</div>
<div class="title">Figure 3. Kafka cluster authorization options</div>
</div>
<div class="sect4">
<h5 id="super_users"><a class="link" href="#super_users">Super users</a></h5>
<div class="paragraph">
<p>Super users can access all resources in your Kafka cluster regardless of any access restrictions,
and are supported by all authorization mechanisms.</p>
</div>
<div class="paragraph">
<p>To designate super users for a Kafka cluster, add a list of user principals to the <code>superUsers</code> property.
If a user uses mTLS authentication, the username is the common name from the TLS certificate subject prefixed with <code>CN=</code>.
If you are not using the User Operator and using your own certificates for mTLS, the username is the full certificate subject.
A full certificate subject can have the following fields: <code>CN=user,OU=my_ou,O=my_org,L=my_location,ST=my_state,C=my_country_code</code>.
Omit any fields that are not present.</p>
</div>
<div class="listingblock">
<div class="title">An example configuration with super users</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
  namespace: myproject
spec:
  kafka:
    # ...
    authorization:
      type: simple
      superUsers:
        - CN=client_1
        - user_2
        - CN=client_3
        - CN=client_4,OU=my_ou,O=my_org,L=my_location,ST=my_state,C=US
        - CN=client_5,OU=my_ou,O=my_org,C=GB
        - CN=client_6,O=my_org
    # ...</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-securing-kafka-clients-str"><a class="link" href="#assembly-securing-kafka-clients-str">13.2. Security options for Kafka clients</a></h3>
<div class="paragraph _abstract">
<p>Use the <code>KafkaUser</code> resource to configure the authentication mechanism, authorization mechanism, and access rights for Kafka clients.
In terms of configuring security, clients are represented as users.</p>
</div>
<div class="paragraph">
<p>You can authenticate and authorize user access to Kafka brokers.
Authentication permits access, and authorization constrains the access to permissible actions.</p>
</div>
<div class="paragraph">
<p>You can also create <em>super users</em> that have unconstrained access to Kafka brokers.</p>
</div>
<div class="paragraph">
<p>The authentication and authorization mechanisms must match the <a href="#proc-securing-kafka-str">specification for the listener used to access the Kafka brokers</a>.</p>
</div>
<div class="paragraph">
<p>For more information on configuring a <code>KafkaUser</code> resource to access Kafka brokers securely, see <a href="#setup-external-clients-str">Setting up client access to a Kafka cluster using listeners</a>.</p>
</div>
<div class="sect3">
<h4 id="con-securing-client-labels-str"><a class="link" href="#con-securing-client-labels-str">13.2.1. Identifying a Kafka cluster for user handling</a></h4>
<div class="paragraph">
<p>A <code>KafkaUser</code> resource includes a label that defines the appropriate name of the Kafka cluster (derived from the name of the <code>Kafka</code> resource) to which it belongs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>The label is used by the User Operator to identify the <code>KafkaUser</code> resource and create a new user, and also in subsequent handling of the user.</p>
</div>
<div class="paragraph">
<p>If the label does not match the Kafka cluster, the User Operator cannot identify the <code>KafkaUser</code> and the user is not created.</p>
</div>
<div class="paragraph">
<p>If the status of the <code>KafkaUser</code> resource remains empty, check your label.</p>
</div>
</div>
<div class="sect3">
<h4 id="con-securing-client-authentication-str"><a class="link" href="#con-securing-client-authentication-str">13.2.2. User authentication</a></h4>
<div class="paragraph _abstract">
<p>Use the <code>KafkaUser</code> custom resource to configure authentication credentials for users (clients) that require access to a Kafka cluster.
Configure the credentials using the <code>authentication</code> property in <code>KafkaUser.spec</code>.
By specifying a <code>type</code>, you control what credentials are generated.</p>
</div>
<div class="paragraph">
<p>Supported authentication types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>tls</code> for mTLS authentication</p>
</li>
<li>
<p><code>tls-external</code> for mTLS authentication using external certificates</p>
</li>
<li>
<p><code>scram-sha-512</code> for SCRAM-SHA-512 authentication</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If <code>tls</code> or <code>scram-sha-512</code> is specified, the User Operator creates authentication credentials when it creates the user.
If <code>tls-external</code> is specified, the user still uses mTLS, but no authentication credentials are created.
Use this option when you&#8217;re providing your own certificates.
When no authentication type is specified, the User Operator does not create the user or its credentials.</p>
</div>
<div class="paragraph">
<p>You can use <code>tls-external</code> to authenticate with mTLS using a certificate issued outside the User Operator.
The User Operator does not generate a TLS certificate or a secret.
You can still manage ACL rules and quotas through the User Operator in the same way as when you&#8217;re using the <code>tls</code> mechanism.
This means that you use the <code>CN=<em>USER-NAME</em></code> format when specifying ACL rules and quotas.
<em>USER-NAME</em> is the common name given in a TLS certificate.</p>
</div>
<div class="sect4">
<h5 id="mtls_authentication"><a class="link" href="#mtls_authentication">mTLS authentication</a></h5>
<div class="paragraph">
<p>To use mTLS authentication, you set the <code>type</code> field in the <code>KafkaUser</code> resource to <code>tls</code>.</p>
</div>
<div class="listingblock">
<div class="title">Example user with mTLS authentication enabled</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster
spec:
  authentication:
    type: tls
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The authentication type must match the equivalent configuration for the <code>Kafka</code> listener used to access the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>When the user is created by the User Operator, it creates a new secret with the same name as the <code>KafkaUser</code> resource.
The secret contains a private and public key for mTLS.
The public key is contained in a user certificate, which is signed by a clients CA (certificate authority) when it is created.
All keys are in X.509 format.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using the clients CA generated by the Cluster Operator, the user certificates generated by the User Operator are also renewed when the clients CA is renewed by the Cluster Operator.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The user secret <a href="#certificates-and-secrets-formats-str">provides keys and certificates in PEM and PKCS #12 formats</a>.</p>
</div>
<div class="listingblock">
<div class="title">Example secret with user credentials</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: my-user
  labels:
    strimzi.io/kind: KafkaUser
    strimzi.io/cluster: my-cluster
type: Opaque
data:
  ca.crt: <em>&lt;public_key&gt;</em> # Public key of the clients CA
  user.crt: <em>&lt;user_certificate&gt;</em> # Public key of the user
  user.key: <em>&lt;user_private_key&gt;</em> # Private key of the user
  user.p12: <em>&lt;store&gt;</em> # PKCS #12 store for user certificates and keys
  user.password: <em>&lt;password_for_store&gt;</em> # Protects the PKCS #12 store</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you configure a client, you specify the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Truststore</strong> properties for the public cluster CA certificate to verify the identity of the Kafka cluster</p>
</li>
<li>
<p><strong>Keystore</strong> properties for the user authentication credentials to verify the client</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The configuration depends on the file format (PEM or PKCS #12).
This example uses PKCS #12 stores, and the passwords required to access the credentials in the stores.</p>
</div>
<div class="listingblock">
<div class="title">Example client configuration using mTLS in PKCS #12 format</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">bootstrap.servers=<em>&lt;kafka_cluster_name&gt;</em>-kafka-bootstrap:9093 # <b class="conum">(1)</b>
security.protocol=SSL # <b class="conum">(2)</b>
ssl.truststore.location=/tmp/ca.p12 # <b class="conum">(3)</b>
ssl.truststore.password=<em>&lt;truststore_password&gt;</em> # <b class="conum">(4)</b>
ssl.keystore.location=/tmp/user.p12 # <b class="conum">(5)</b>
ssl.keystore.password=<em>&lt;keystore_password&gt;</em> # <b class="conum">(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The bootstrap server address to connect to the Kafka cluster.</p>
</li>
<li>
<p>The security protocol option when using TLS for encryption.</p>
</li>
<li>
<p>The truststore location contains the public key certificate (<code>ca.p12</code>) for the Kafka cluster. A cluster CA certificate and password is generated by the Cluster Operator in the <code>&lt;cluster_name&gt;-cluster-ca-cert</code> secret when the Kafka cluster is created.</p>
</li>
<li>
<p>The password (<code>ca.password</code>) for accessing the truststore.</p>
</li>
<li>
<p>The keystore location contains the public key certificate (<code>user.p12</code>) for the Kafka user.</p>
</li>
<li>
<p>The password (<code>user.password</code>) for accessing the keystore.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="mtls_authentication_using_a_certificate_issued_outside_the_user_operator"><a class="link" href="#mtls_authentication_using_a_certificate_issued_outside_the_user_operator">mTLS authentication using a certificate issued outside the User Operator</a></h5>
<div class="paragraph">
<p>To use mTLS authentication using a certificate issued outside the User Operator, you set the <code>type</code> field in the <code>KafkaUser</code> resource to <code>tls-external</code>.
A secret and credentials are not created for the user.</p>
</div>
<div class="listingblock">
<div class="title">Example user with mTLS authentication that uses a certificate issued outside the User Operator</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster
spec:
  authentication:
    type: tls-external
  # ...</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scram_sha_512_authentication"><a class="link" href="#scram_sha_512_authentication">SCRAM-SHA-512 authentication</a></h5>
<div class="paragraph">
<p>To use the SCRAM-SHA-512 authentication mechanism, you set the <code>type</code> field in the <code>KafkaUser</code> resource to <code>scram-sha-512</code>.</p>
</div>
<div class="listingblock">
<div class="title">Example user with SCRAM-SHA-512 authentication enabled</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster
spec:
  authentication:
    type: scram-sha-512
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the user is created by the User Operator, it creates a new secret with the same name as the <code>KafkaUser</code> resource.
The secret contains the generated password in the <code>password</code> key, which is encoded with base64.
In order to use the password, it must be decoded.</p>
</div>
<div class="listingblock">
<div class="title">Example secret with user credentials</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: my-user
  labels:
    strimzi.io/kind: KafkaUser
    strimzi.io/cluster: my-cluster
type: Opaque
data:
  password: Z2VuZXJhdGVkcGFzc3dvcmQ= <b class="conum">(1)</b>
  sasl.jaas.config: b3JnLmFwYWNoZS5rYWZrYS5jb21tb24uc2VjdXJpdHkuc2NyYW0uU2NyYW1Mb2dpbk1vZHVsZSByZXF1aXJlZCB1c2VybmFtZT0ibXktdXNlciIgcGFzc3dvcmQ9ImdlbmVyYXRlZHBhc3N3b3JkIjsK <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The generated password, base64 encoded.</p>
</li>
<li>
<p>The JAAS configuration string for SASL SCRAM-SHA-512 authentication, base64 encoded.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Decoding the generated password:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>echo "Z2VuZXJhdGVkcGFzc3dvcmQ=" | base64 --decode</pre>
</div>
</div>
<div class="sect5">
<h6 id="custom_password_configuration"><a class="link" href="#custom_password_configuration">Custom password configuration</a></h6>
<div class="paragraph">
<p>When a user is created, Strimzi generates a random password.
You can use your own password instead of the one generated by Strimzi. To do so, create a secret with the password and reference it in the <code>KafkaUser</code> resource.</p>
</div>
<div class="listingblock">
<div class="title">Example user with a password set for SCRAM-SHA-512 authentication</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster
spec:
  authentication:
    type: scram-sha-512
    password:
      valueFrom:
        secretKeyRef:
          name: my-secret <b class="conum">(1)</b>
          key: my-password <b class="conum">(2)</b>
  # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The name of the secret containing the predefined password.</p>
</li>
<li>
<p>The key for the password stored inside the secret.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="con-securing-client-authorization-str"><a class="link" href="#con-securing-client-authorization-str">13.2.3. User authorization</a></h4>
<div class="paragraph _abstract">
<p>Use the <code>KafkaUser</code> custom resource to configure authorization rules for users (clients) that require access to a Kafka cluster.
Configure the rules using the <code>authorization</code> property in <code>KafkaUser.spec</code>.
By specifying a <code>type</code>, you control what rules are used.</p>
</div>
<div class="paragraph">
<p>To use simple authorization, you set the <code>type</code> property to <code>simple</code> in <code>KafkaUser.spec.authorization</code>.
The simple authorization uses the Kafka Admin API to manage the ACL rules inside your Kafka cluster.
Whether ACL management in the User Operator is enabled or not depends on your authorization configuration in the Kafka cluster.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For simple authorization, ACL management is always enabled.</p>
</li>
<li>
<p>For OPA authorization, ACL management is always disabled.
Authorization rules are configured in the OPA server.</p>
</li>
<li>
<p>For Keycloak authorization, you can manage the ACL rules directly in Keycloak.
You can also delegate authorization to the simple authorizer as a fallback option in the configuration.
When delegation to the simple authorizer is enabled, the User Operator will enable management of ACL rules as well.</p>
</li>
<li>
<p>For custom authorization using a custom authorization plugin, use the <code>supportsAdminApi</code> property in the <code>.spec.kafka.authorization</code> configuration of the <code>Kafka</code> custom resource to enable or disable the support.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Authorization is cluster-wide.
The authorization type must match the equivalent configuration in the <code>Kafka</code> custom resource.</p>
</div>
<div class="paragraph">
<p>If ACL management is not enabled, Strimzi rejects a resource if it contains any ACL rules.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re using a standalone deployment of the User Operator, ACL management is enabled by default.
You can disable it using the <code>STRIMZI_ACLS_ADMIN_API_SUPPORTED</code> environment variable.</p>
</div>
<div class="paragraph">
<p>If no authorization is specified, the User Operator does not provision any access rights for the user.
Whether such a <code>KafkaUser</code> can still access resources depends on the authorizer being used.
For example, for <code>simple</code> authorization, this is determined by the <code>allow.everyone.if.no.acl.found</code> configuration in the Kafka cluster.</p>
</div>
<div class="sect4">
<h5 id="acl_rules"><a class="link" href="#acl_rules">ACL rules</a></h5>
<div class="paragraph">
<p><code>simple</code> authorization uses ACL rules to manage access to Kafka brokers.</p>
</div>
<div class="paragraph">
<p>ACL rules grant access rights to the user, which you specify in the <code>acls</code> property.</p>
</div>
<div class="paragraph">
<p>For more information about the <code>AclRule</code> object, see the <a href="./configuring.html#type-AclRule-reference" target="_blank" rel="noopener"><code>AclRule</code> schema reference</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="super_user_access_to_kafka_brokers"><a class="link" href="#super_user_access_to_kafka_brokers">Super user access to Kafka brokers</a></h5>
<div class="paragraph">
<p>If a user is added to a list of super users in a Kafka broker configuration,
the user is allowed unlimited access to the cluster regardless of any authorization constraints defined in ACLs in <code>KafkaUser</code>.</p>
</div>
<div class="paragraph">
<p>For more information on configuring super user access to brokers, see <a href="#con-securing-kafka-authorization-str">Kafka authorization</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="user_quotas"><a class="link" href="#user_quotas">User quotas</a></h5>
<div class="paragraph">
<p>You can configure the <code>spec</code> for the <code>KafkaUser</code> resource to enforce quotas so that a user does not exceed a configured level of access to Kafka brokers.
You can set size-based network usage and time-based CPU utilization thresholds.
You can also add a partition mutation quota to control the rate at which requests to change partitions are accepted for user requests.</p>
</div>
<div class="listingblock">
<div class="title">An example <code>KafkaUser</code> with user quotas</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster
spec:
  # ...
  quotas:
    producerByteRate: 1048576 <b class="conum">(1)</b>
    consumerByteRate: 2097152 <b class="conum">(2)</b>
    requestPercentage: 55 <b class="conum">(3)</b>
    controllerMutationRate: 10 <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Byte-per-second quota on the amount of data the user can push to a Kafka broker</p>
</li>
<li>
<p>Byte-per-second quota on the amount of data the user can fetch from a Kafka broker</p>
</li>
<li>
<p>CPU utilization limit as a percentage of time for a client group</p>
</li>
<li>
<p>Number of concurrent partition creation and deletion operations (mutations) allowed per second</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For more information on these properties, see the <a href="./configuring.html#type-KafkaUserQuotas-reference" target="_blank" rel="noopener"><code>KafkaUserQuotas</code> schema reference</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-securing-kafka-str"><a class="link" href="#assembly-securing-kafka-str">13.3. Securing access to Kafka brokers</a></h3>
<div class="paragraph _abstract">
<p>To establish secure access to Kafka brokers, you configure and apply:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>Kafka</code> resource to:</p>
<div class="ulist">
<ul>
<li>
<p>Create listeners with a specified authentication type</p>
</li>
<li>
<p>Configure authorization for the whole Kafka cluster</p>
</li>
</ul>
</div>
</li>
<li>
<p>A <code>KafkaUser</code> resource to access the Kafka brokers securely through the listeners</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Configure the <code>Kafka</code> resource to set up:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Listener authentication</p>
</li>
<li>
<p>Network policies that restrict access to Kafka listeners</p>
</li>
<li>
<p>Kafka authorization</p>
</li>
<li>
<p>Super users for unconstrained access to brokers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Authentication is configured independently for each listener.
Authorization is always configured for the whole Kafka cluster.</p>
</div>
<div class="paragraph">
<p>The Cluster Operator creates the listeners and sets up the cluster and client certificate authority (CA) certificates to enable authentication within the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>You can replace the certificates generated by the Cluster Operator by <a href="#installing-your-own-ca-certificates-str">installing your own certificates</a>.</p>
</div>
<div class="paragraph">
<p>You can also provide your own server certificates and private keys for any listener with TLS encryption enabled.
These user-provided certificates are called <em>Kafka listener certificates</em>.
Providing Kafka listener certificates allows you to leverage existing security infrastructure, such as your organization&#8217;s private CA or a public CA.
Kafka clients will need to trust the CA which was used to sign the listener certificate.
You must manually renew Kafka listener certificates when needed.
Certificates are available in PKCS #12 format (.p12) and PEM (.crt) formats.</p>
</div>
<div class="paragraph">
<p>Use <code>KafkaUser</code> to enable the authentication and authorization mechanisms that a specific client uses to access Kafka.</p>
</div>
<div class="paragraph">
<p>Configure the <code>KafkaUser</code> resource to set up:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Authentication to match the enabled listener authentication</p>
</li>
<li>
<p>Authorization to match the enabled Kafka authorization</p>
</li>
<li>
<p>Quotas to control the use of resources by clients</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The User Operator creates the user representing the client and the security credentials used for client authentication, based on the chosen authentication type.</p>
</div>
<div class="paragraph">
<p>Refer to the schema reference for more information on access configuration properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./configuring.html#type-Kafka-reference" target="_blank" rel="noopener"><code>Kafka</code> schema reference</a></p>
</li>
<li>
<p><a href="./configuring.html#type-KafkaUser-reference" target="_blank" rel="noopener"><code>KafkaUser</code> schema reference</a></p>
</li>
<li>
<p><a href="./configuring.html#type-GenericKafkaListener-reference" target="_blank" rel="noopener"><code>GenericKafkaListener</code> schema reference</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="proc-securing-kafka-str"><a class="link" href="#proc-securing-kafka-str">13.3.1. Securing Kafka brokers</a></h4>
<div class="paragraph">
<p>This procedure shows the steps involved in securing Kafka brokers when running Strimzi.</p>
</div>
<div class="paragraph">
<p>The security implemented for Kafka brokers must be compatible with the security implemented for the clients requiring access.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Kafka.spec.kafka.listeners[*].authentication</code> matches <code>KafkaUser.spec.authentication</code></p>
</li>
<li>
<p><code>Kafka.spec.kafka.authorization</code> matches <code>KafkaUser.spec.authorization</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The steps show the configuration for simple authorization and a listener using mTLS authentication.
For more information on listener configuration, see the <a href="./configuring.html#type-GenericKafkaListener-reference"><code>GenericKafkaListener</code> schema reference</a>.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can use SCRAM-SHA or OAuth 2.0 for <a href="#con-securing-kafka-authentication-str">listener authentication</a>,
and OAuth 2.0 or OPA for <a href="#con-securing-kafka-authorization-str">Kafka authorization</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure the <code>Kafka</code> resource.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Configure the <code>authorization</code> property for authorization.</p>
</li>
<li>
<p>Configure the <code>listeners</code> property to create a listener with authentication.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  kafka:
    # ...
    authorization: <b class="conum">(1)</b>
      type: simple
      superUsers: <b class="conum">(2)</b>
        - CN=client_1
        - user_2
        - CN=client_3
    listeners:
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: tls <b class="conum">(3)</b>
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Authorization <a href="#con-securing-kafka-authorization-str">enables <code>simple</code> authorization on the Kafka broker using the <code>AclAuthorizer</code> and <code>StandardAuthorizer</code> Kafka plugins</a>.</p>
</li>
<li>
<p>List of user principals with unlimited access to Kafka. <em>CN</em> is the common name from the client certificate when mTLS authentication is used.</p>
</li>
<li>
<p>Listener authentication mechanisms may be configured for each listener, and <a href="#assembly-securing-kafka-brokers-str">specified as mTLS, SCRAM-SHA-512, or token-based OAuth 2.0</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you are configuring an external listener, the configuration is dependent on the chosen connection mechanism.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Create or update the <code>Kafka</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Kafka cluster is configured with a Kafka broker listener using mTLS authentication.</p>
</div>
<div class="paragraph">
<p>A service is created for each Kafka broker pod.</p>
</div>
<div class="paragraph">
<p>A service is created to serve as the <em>bootstrap address</em> for connection to the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>The cluster CA certificate to verify the identity of the kafka brokers is also created in the secret <code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-configuring-secure-kafka-user-str"><a class="link" href="#proc-configuring-secure-kafka-user-str">13.3.2. Securing user access to Kafka</a></h4>
<div class="paragraph _abstract">
<p>Create or modify a <code>KafkaUser</code> to represent a client that requires secure access to the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>When you configure the <code>KafkaUser</code> authentication and authorization mechanisms, ensure they match the equivalent <code>Kafka</code> configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>KafkaUser.spec.authentication</code> matches <code>Kafka.spec.kafka.listeners[*].authentication</code></p>
</li>
<li>
<p><code>KafkaUser.spec.authorization</code> matches <code>Kafka.spec.kafka.authorization</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This procedure shows how a user is created with mTLS authentication.
You can also create a user with SCRAM-SHA authentication.</p>
</div>
<div class="paragraph">
<p>The authentication required depends on the <a href="#con-securing-kafka-authentication-str">type of authentication configured for the Kafka broker listener</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Authentication between Kafka users and Kafka brokers depends on the authentication settings for each.
For example, it is not possible to authenticate a user with mTLS if it is not also enabled in the Kafka configuration.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A running Kafka cluster <a href="#con-mutual-tls-authentication-str">configured with a Kafka broker listener using mTLS authentication and TLS encryption</a>.</p>
</li>
<li>
<p>A running User Operator (typically deployed with the Entity Operator).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The authentication type in <code>KafkaUser</code> should match the authentication configured in <code>Kafka</code> brokers.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure the <code>KafkaUser</code> resource.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster
spec:
  authentication: <b class="conum">(1)</b>
    type: tls
  authorization:
    type: simple <b class="conum">(2)</b>
    acls:
      - resource:
          type: topic
          name: my-topic
          patternType: literal
        operations:
          - Describe
          - Read
      - resource:
          type: group
          name: my-group
          patternType: literal
        operations:
          - Read</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>User authentication mechanism, defined as mutual <code>tls</code> or <code>scram-sha-512</code>.</p>
</li>
<li>
<p>Simple authorization, which requires an accompanying list of ACL rules.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create or update the <code>KafkaUser</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;user_config_file&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The user is created, as well as a Secret with the same name as the <code>KafkaUser</code> resource.
The Secret contains a private and public key for mTLS authentication.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>For information on configuring a Kafka client with properties for secure connection to Kafka brokers, see <a href="#setup-external-clients-str">Setting up client access to a Kafka cluster using listeners</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="proc-restricting-access-to-listeners-using-network-policies-str"><a class="link" href="#proc-restricting-access-to-listeners-using-network-policies-str">13.3.3. Restricting access to Kafka listeners using network policies</a></h4>
<div class="paragraph _abstract">
<p>You can restrict access to a listener to only selected applications by using the <code>networkPolicyPeers</code> property.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kubernetes cluster with support for Ingress NetworkPolicies.</p>
</li>
<li>
<p>The Cluster Operator is running.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open the <code>Kafka</code> resource.</p>
</li>
<li>
<p>In the <code>networkPolicyPeers</code> property, define the application pods or namespaces that will be allowed to access the Kafka cluster.</p>
<div class="paragraph">
<p>For example, to configure a <code>tls</code> listener to allow connections only from application pods with the label <code>app</code> set to <code>kafka-client</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  kafka:
    # ...
    listeners:
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: tls
        networkPolicyPeers:
          - podSelector:
              matchLabels:
                app: kafka-client
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Create or update the resource.</p>
<div class="paragraph">
<p>Use <code>kubectl apply</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>your-file</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./configuring.html#configuration-listener-network-policy-reference" target="_blank" rel="noopener"><code>networkPolicyPeers</code> configuration</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#networkpolicypeer-v1-networking-k8s-io" target="_blank" rel="noopener">NetworkPolicyPeer API reference</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="proc-installing-certs-per-listener-str"><a class="link" href="#proc-installing-certs-per-listener-str">13.3.4. Providing your own Kafka listener certificates for TLS encryption</a></h4>
<div class="paragraph _abstract">
<p>Listeners provide client access to Kafka brokers.
Configure listeners in the <code>Kafka</code> resource, including the configuration required for client access using TLS.</p>
</div>
<div class="paragraph">
<p>By default, the listeners use certificates signed by the internal CA (certificate authority) certificates generated by Strimzi.
A CA certificate is generated by the Cluster Operator when it creates a Kafka cluster.
When you configure a client for TLS, you add the CA certificate to its truststore configuration to verify the Kafka cluster.
You can also <a href="#installing-your-own-ca-certificates-str">install and use your own CA certificates</a>.
Or you can configure a listener using <code>brokerCertChainAndKey</code> properties and use a custom server certificate.</p>
</div>
<div class="paragraph">
<p>The <code>brokerCertChainAndKey</code> properties allow you to access Kafka brokers using your own custom certificates at the listener-level.
You create a secret with your own private key and server certificate, then specify the key and certificate in the listener&#8217;s <code>brokerCertChainAndKey</code> configuration.
You can use a certificate signed by a public (external) CA or a private CA.
If signed by a public CA, you usually won&#8217;t need to add it to a client&#8217;s truststore configuration.
Custom certificates are not managed by Strimzi, so you need to renew them manually.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Listener certificates are used for TLS encryption and server authentication only.
They are not used for TLS client authentication.
If you want to use your own certificate for TLS client authentication as well, you must <a href="#installing-your-own-ca-certificates-str">install and use your own clients CA</a>.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is running.</p>
</li>
<li>
<p>Each listener requires the following:</p>
<div class="ulist">
<ul>
<li>
<p>A compatible server certificate signed by an external CA. (Provide an X.509 certificate in PEM format.)</p>
<div class="paragraph">
<p>You can use one listener certificate for multiple listeners.</p>
</div>
</li>
<li>
<p>Subject Alternative Names (SANs) are specified in the certificate for each listener.
For more information, see <a href="#ref-alternative-subjects-certs-for-listeners-str">Alternative subjects in server certificates for Kafka listeners</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you are not using a self-signed certificate, you can provide a certificate that includes the whole CA chain in the certificate.</p>
</div>
<div class="paragraph">
<p>You can only use the <code>brokerCertChainAndKey</code> properties if TLS encryption (<code>tls: true</code>) is configured for the listener.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Strimzi does not support the use of encrypted private keys for TLS. The private key stored in the secret must be unencrypted for this to work.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>Secret</code> containing your private key and server certificate:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create secret generic <em>my-secret</em> --from-file=<em>my-listener-key.key</em> --from-file=<em>my-listener-certificate.crt</em></code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>Kafka</code> resource for your cluster.</p>
<div class="paragraph">
<p>Configure the listener to use your <code>Secret</code>, certificate file, and private key file in the <code>configuration.brokerCertChainAndKey</code> property.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration for a <code>loadbalancer</code> external listener with TLS encryption enabled</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
listeners:
  - name: plain
    port: 9092
    type: internal
    tls: false
  - name: external3
    port: 9094
    type: loadbalancer
    tls: true
    configuration:
      brokerCertChainAndKey:
        secretName: my-secret
        certificate: my-listener-certificate.crt
        key: my-listener-key.key
# ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example configuration for a TLS listener</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
listeners:
  - name: plain
    port: 9092
    type: internal
    tls: false
  - name: tls
    port: 9093
    type: internal
    tls: true
    configuration:
      brokerCertChainAndKey:
        secretName: my-secret
        certificate: my-listener-certificate.crt
        key: my-listener-key.key
# ...</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the new configuration to create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>kafka.yaml</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Cluster Operator starts a rolling update of the Kafka cluster, which updates the configuration of the listeners.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
A rolling update is also started if you update a Kafka listener certificate in a <code>Secret</code> that is already used by a listener.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="ref-alternative-subjects-certs-for-listeners-str"><a class="link" href="#ref-alternative-subjects-certs-for-listeners-str">13.3.5. Alternative subjects in server certificates for Kafka listeners</a></h4>
<div class="paragraph _abstract">
<p>In order to use TLS hostname verification with your own <a href="#proc-installing-certs-per-listener-str">Kafka listener certificates</a>, you must use the correct Subject Alternative Names (SANs) for each listener. The certificate SANs must specify hostnames for the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All of the Kafka brokers in your cluster</p>
</li>
<li>
<p>The Kafka cluster bootstrap service</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use wildcard certificates if they are supported by your CA.</p>
</div>
<div class="sect4">
<h5 id="examples_of_sans_for_internal_listeners"><a class="link" href="#examples_of_sans_for_internal_listeners">Examples of SANs for internal listeners</a></h5>
<div class="paragraph">
<p>Use the following examples to help you specify hostnames of the SANs in your certificates for your internal listeners.</p>
</div>
<div class="paragraph">
<p>Replace <code>&lt;cluster-name&gt;</code> with the name of the Kafka cluster and <code>&lt;namespace&gt;</code> with the Kubernetes namespace where the cluster is running.</p>
</div>
<div class="listingblock">
<div class="title">Wildcards example for a <code>type: internal</code> listener</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">//Kafka brokers
*.<em>&lt;cluster-name&gt;</em>-kafka-brokers
*.<em>&lt;cluster-name&gt;</em>-kafka-brokers.<em>&lt;namespace&gt;</em>.svc

// Bootstrap service
<em>&lt;cluster-name&gt;</em>-kafka-bootstrap
<em>&lt;cluster-name&gt;</em>-kafka-bootstrap.<em>&lt;namespace&gt;</em>.svc</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Non-wildcards example for a <code>type: internal</code> listener</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">// Kafka brokers
<em>&lt;cluster-name&gt;</em>-kafka-0.<em>&lt;cluster-name&gt;</em>-kafka-brokers
<em>&lt;cluster-name&gt;</em>-kafka-0.<em>&lt;cluster-name&gt;</em>-kafka-brokers.<em>&lt;namespace&gt;</em>.svc
<em>&lt;cluster-name&gt;</em>-kafka-1.<em>&lt;cluster-name&gt;</em>-kafka-brokers
<em>&lt;cluster-name&gt;</em>-kafka-1.<em>&lt;cluster-name&gt;</em>-kafka-brokers.<em>&lt;namespace&gt;</em>.svc
# ...

// Bootstrap service
<em>&lt;cluster-name&gt;</em>-kafka-bootstrap
<em>&lt;cluster-name&gt;</em>-kafka-bootstrap.<em>&lt;namespace&gt;</em>.svc</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Non-wildcards example for a <code>type: cluster-ip</code> listener</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">// Kafka brokers
<em>&lt;cluster-name&gt;</em>-kafka-<em>&lt;listener-name&gt;</em>-0
<em>&lt;cluster-name&gt;</em>-kafka-<em>&lt;listener-name&gt;</em>-0.<em>&lt;namespace&gt;</em>.svc
<em>&lt;cluster-name&gt;</em>-kafka-<em>&lt;listener-name&gt;</em>-1
<em>&lt;cluster-name&gt;</em>-kafka-<em>&lt;listener-name&gt;</em>-1.<em>&lt;namespace&gt;</em>.svc
# ...

// Bootstrap service
<em>&lt;cluster-name&gt;</em>-kafka-<em>&lt;listener-name&gt;</em>-bootstrap
<em>&lt;cluster-name&gt;</em>-kafka-<em>&lt;listener-name&gt;</em>-bootstrap.<em>&lt;namespace&gt;</em>.svc</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="examples_of_sans_for_external_listeners"><a class="link" href="#examples_of_sans_for_external_listeners">Examples of SANs for external listeners</a></h5>
<div class="paragraph">
<p>For external listeners which have TLS encryption enabled, the hostnames you need to specify in certificates depends on the external listener <code>type</code>.</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 17. SANs for each type of external listener</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">External listener type</th>
<th class="tableblock halign-left valign-top">In the SANs, specify&#8230;&#8203;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>ingress</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Addresses of all Kafka broker <code>Ingress</code> resources and the address of the bootstrap <code>Ingress</code>.</p>
<p class="tableblock">You can use a matching wildcard name.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>route</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Addresses of all Kafka broker <code>Routes</code> and the address of the bootstrap <code>Route</code>.</p>
<p class="tableblock">You can use a matching wildcard name.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>loadbalancer</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Addresses of all Kafka broker <code>loadbalancers</code> and the bootstrap <code>loadbalancer</code> address.</p>
<p class="tableblock">You can use a matching wildcard name.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>nodeport</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Addresses of all Kubernetes worker nodes that the Kafka broker pods might be scheduled to.</p>
<p class="tableblock">You can use a matching wildcard name.</p></td>
</tr>
</tbody>
</table>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#proc-installing-certs-per-listener-str">Providing your own Kafka listener certificates for TLS encryption</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-oauth-authentication_str"><a class="link" href="#assembly-oauth-authentication_str">13.4. Using OAuth 2.0 token-based authentication</a></h3>
<div class="paragraph _abstract">
<p>Strimzi supports the use of <a href="https://oauth.net/2/" target="_blank" rel="noopener">OAuth 2.0 authentication</a> using the <em>OAUTHBEARER</em> and <em>PLAIN</em> mechanisms.</p>
</div>
<div class="paragraph">
<p>OAuth 2.0 enables standardized token-based authentication and authorization between applications, using a central authorization server to issue tokens that grant limited access to resources.</p>
</div>
<div class="paragraph">
<p>Kafka brokers and clients both need to be configured to use OAuth 2.0.
You can configure OAuth 2.0 authentication, then <a href="#assembly-oauth-authorization_str">OAuth 2.0 authorization</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>OAuth 2.0 authentication can be used in conjunction with <a href="#con-securing-kafka-authorization-str">Kafka authorization</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Using OAuth 2.0 authentication, application clients can access resources on application servers (called <em>resource servers</em>) without exposing account credentials.</p>
</div>
<div class="paragraph">
<p>The application client passes an access token as a means of authenticating, which application servers can also use to determine the level of access to grant.
The authorization server handles the granting of access and inquiries about access.</p>
</div>
<div class="paragraph">
<p>In the context of Strimzi:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kafka brokers act as OAuth 2.0 resource servers</p>
</li>
<li>
<p>Kafka clients act as OAuth 2.0 application clients</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Kafka clients authenticate to Kafka brokers.
The brokers and clients communicate with the OAuth 2.0 authorization server, as necessary, to obtain or validate access tokens.</p>
</div>
<div class="paragraph">
<p>For a deployment of Strimzi, OAuth 2.0 integration provides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Server-side OAuth 2.0 support for Kafka brokers</p>
</li>
<li>
<p>Client-side OAuth 2.0 support for Kafka MirrorMaker, Kafka Connect, and the Kafka Bridge</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="con-oauth-authentication-flow-str"><a class="link" href="#con-oauth-authentication-flow-str">13.4.1. OAuth 2.0 authentication mechanisms</a></h4>
<div class="paragraph _abstract">
<p>Strimzi supports the OAUTHBEARER and PLAIN mechanisms for OAuth 2.0 authentication.
Both mechanisms allow Kafka clients to establish authenticated sessions with Kafka brokers.
The authentication flow between clients, the authorization server, and Kafka brokers is different for each mechanism.</p>
</div>
<div class="paragraph">
<p>We recommend that you configure clients to use OAUTHBEARER whenever possible.
OAUTHBEARER provides a higher level of security than PLAIN because client credentials are <em>never</em> shared with Kafka brokers.
Consider using PLAIN only with Kafka clients that do not support OAUTHBEARER.</p>
</div>
<div class="paragraph">
<p>You configure Kafka broker listeners to use OAuth 2.0 authentication for connecting clients.
If necessary, you can use the OAUTHBEARER and PLAIN mechanisms on the same <code>oauth</code> listener.
The properties to support each mechanism must be explicitly specified in the <code>oauth</code> listener configuration.</p>
</div>
<div class="paragraph">
<div class="title">OAUTHBEARER overview</div>
<p>OAUTHBEARER is automatically enabled in the <code>oauth</code> listener configuration for the Kafka broker.
You can set the <code>enableOauthBearer</code> property to <code>true</code>, though this is not required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  # ...
  authentication:
    type: oauth
    # ...
    enableOauthBearer: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Many Kafka client tools use libraries that provide basic support for OAUTHBEARER at the protocol level.
To support application development, Strimzi provides an <em>OAuth callback handler</em> for the upstream Kafka Client Java libraries (but not for other libraries).
Therefore, you do not need to write your own callback handlers.
An application client can use the callback handler to provide the access token.
Clients written in other languages, such as Go, must use custom code to connect to the authorization server and obtain the access token.</p>
</div>
<div class="paragraph">
<p>With OAUTHBEARER, the client initiates a session with the Kafka broker for credentials exchange, where credentials take the form of a bearer token provided by the callback handler.
Using the callbacks, you can configure token provision in one of three ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Client ID and Secret (by using the <em>OAuth 2.0 client credentials</em> mechanism)</p>
</li>
<li>
<p>A long-lived access token, obtained manually at configuration time</p>
</li>
<li>
<p>A long-lived refresh token, obtained manually at configuration time</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>OAUTHBEARER authentication can only be used by Kafka clients that support the OAUTHBEARER mechanism at the protocol level.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">PLAIN overview</div>
<p>To use PLAIN, you must enable it in the <code>oauth</code> listener configuration for the Kafka broker.</p>
</div>
<div class="paragraph">
<p>In the following example, PLAIN is enabled in addition to OAUTHBEARER, which is enabled by default.
If you want to use PLAIN only, you can disable OAUTHBEARER by setting <code>enableOauthBearer</code> to <code>false</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  # ...
  authentication:
    type: oauth
    # ...
    enablePlain: true
    tokenEndpointUri: https://<em>OAUTH-SERVER-ADDRESS</em>/auth/realms/external/protocol/openid-connect/token</code></pre>
</div>
</div>
<div class="paragraph">
<p>PLAIN is a simple authentication mechanism used by all Kafka client tools.
To enable PLAIN to be used with OAuth 2.0 authentication, Strimzi provides <em>OAuth 2.0 over PLAIN</em> server-side callbacks.</p>
</div>
<div class="paragraph">
<p>With the Strimzi implementation of PLAIN, the client credentials are not stored in ZooKeeper.
Instead, client credentials are handled centrally behind a compliant authorization server, similar to when OAUTHBEARER authentication is used.</p>
</div>
<div class="paragraph">
<p>When used with the OAuth 2.0 over PLAIN callbacks, Kafka clients authenticate with Kafka brokers using either of the following methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Client ID and secret (by using the OAuth 2.0 client credentials mechanism)</p>
</li>
<li>
<p>A long-lived access token, obtained manually at configuration time</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For both methods, the client must provide the PLAIN <code>username</code> and <code>password</code> properties to pass credentials to the Kafka broker.
The client uses these properties to pass a client ID and secret or username and access token.</p>
</div>
<div class="paragraph">
<p>Client IDs and secrets are used to obtain access tokens.</p>
</div>
<div class="paragraph">
<p>Access tokens are passed as <code>password</code> property values.
You pass the access token with or without an <code>$accessToken:</code> prefix.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you configure a token endpoint (<code>tokenEndpointUri</code>) in the listener configuration, you need the prefix.</p>
</li>
<li>
<p>If you don&#8217;t configure a token endpoint (<code>tokenEndpointUri</code>) in the listener configuration, you don&#8217;t need the prefix.
The Kafka broker interprets the password as a raw access token.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the <code>password</code> is set as the access token, the <code>username</code> must be set to the same principal name that the Kafka broker obtains from the access token.
You can specify username extraction options in your listener using the <code>userNameClaim</code>, <code>fallbackUserNameClaim</code>, <code>fallbackUsernamePrefix</code>, and <code>userInfoEndpointUri</code> properties.
The username extraction process also depends on your authorization server; in particular, how it maps client IDs to account names.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>OAuth over PLAIN does not support <code>password grant</code> mechanism. You can only 'proxy' through SASL PLAIN mechanism the <code>client credentials</code> (clientId + secret) or the access token as described above.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#proc-oauth-authentication-broker-config-str">Configuring OAuth 2.0 support for Kafka brokers</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="con-oauth-authentication-broker-str"><a class="link" href="#con-oauth-authentication-broker-str">13.4.2. OAuth 2.0 Kafka broker configuration</a></h4>
<div class="paragraph">
<p>Kafka broker configuration for OAuth 2.0 involves:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creating the OAuth 2.0 client in the authorization server</p>
</li>
<li>
<p>Configuring OAuth 2.0 authentication in the Kafka custom resource</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In relation to the authorization server, Kafka brokers and Kafka clients are both regarded as OAuth 2.0 clients.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="oauth_2_0_client_configuration_on_an_authorization_server"><a class="link" href="#oauth_2_0_client_configuration_on_an_authorization_server">OAuth 2.0 client configuration on an authorization server</a></h5>
<div class="paragraph">
<p>To configure a Kafka broker to validate the token received during session initiation,
the recommended approach is to create an OAuth 2.0 <em>client</em> definition in an authorization server, configured as <em>confidential</em>, with the following client credentials enabled:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Client ID of <code>kafka</code> (for example)</p>
</li>
<li>
<p>Client ID and Secret as the authentication mechanism</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You only need to use a client ID and secret when using a non-public introspection endpoint of the authorization server.
The credentials are not typically required when using public authorization server endpoints, as with fast local JWT token validation.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="oauth_2_0_authentication_configuration_in_the_kafka_cluster"><a class="link" href="#oauth_2_0_authentication_configuration_in_the_kafka_cluster">OAuth 2.0 authentication configuration in the Kafka cluster</a></h5>
<div class="paragraph">
<p>To use OAuth 2.0 authentication in the Kafka cluster, you specify, for example, a <code>tls</code> listener configuration for your Kafka cluster custom resource with the authentication method <code>oauth</code>:</p>
</div>
<div class="listingblock">
<div class="title">Assigining the authentication method type for OAuth 2.0</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  kafka:
    # ...
    listeners:
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: <strong>oauth</strong>
      #...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can configure OAuth 2.0 authentication in your listeners.
We recommend using OAuth 2.0 authentication together with TLS encryption (<code>tls: true</code>).
Without encryption, the connection is vulnerable to network eavesdropping and unauthorized access through token theft.</p>
</div>
<div class="paragraph">
<p>You configure an <code>external</code> listener with <code>type: oauth</code> for a secure transport layer to communicate with the client.</p>
</div>
<div class="listingblock">
<div class="title">Using OAuth 2.0 with an external listener</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
listeners:
  - name: external3
    port: 9094
    type: loadbalancer
    tls: true
    authentication:
      type: <strong>oauth</strong>
    #...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>tls</code> property is <em>false</em> by default, so it must be enabled.</p>
</div>
<div class="paragraph">
<p>When you have defined the type of authentication as OAuth 2.0, you add configuration based on the type of validation, either as <a href="#con-oauth-authentication-broker-fast-local">fast local JWT validation</a> or <a href="#con-oauth-authentication-broker-intro-local">token validation using an introspection endpoint</a>.</p>
</div>
<div class="paragraph">
<p>The procedure to configure OAuth 2.0 for listeners, with descriptions and examples, is described in <a href="#proc-oauth-authentication-broker-config-str">Configuring OAuth 2.0 support for Kafka brokers</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="con-oauth-authentication-broker-fast-local"><a class="link" href="#con-oauth-authentication-broker-fast-local">Fast local JWT token validation configuration</a></h5>
<div class="paragraph">
<p>Fast local JWT token validation checks a JWT token signature locally.</p>
</div>
<div class="paragraph">
<p>The local check ensures that a token:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Conforms to type by containing a (<em>typ</em>) claim value of <code>Bearer</code> for an access token</p>
</li>
<li>
<p>Is valid (not expired)</p>
</li>
<li>
<p>Has an issuer that matches a <code>validIssuerURI</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You specify a <code>validIssuerURI</code> attribute when you configure the listener, so that any tokens not issued by the authorization server are rejected.</p>
</div>
<div class="paragraph">
<p>The authorization server does not need to be contacted during fast local JWT token validation.
You activate fast local JWT token validation by specifying a <code>jwksEndpointUri</code> attribute, the endpoint exposed by the OAuth 2.0 authorization server.
The endpoint contains the public keys used to validate signed JWT tokens, which are sent as credentials by Kafka clients.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
All communication with the authorization server should be performed using TLS encryption.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can configure a certificate truststore as a Kubernetes Secret in your Strimzi project namespace, and use a <code>tlsTrustedCertificates</code> attribute to point to the Kubernetes Secret containing the truststore file.</p>
</div>
<div class="paragraph">
<p>You might want to configure a <code>userNameClaim</code> to properly extract a username from the JWT token.
If required, you can use a JsonPath expression like <code>"['user.info'].['user.id']"</code> to retrieve the username from nested JSON attributes within a token.</p>
</div>
<div class="paragraph">
<p>If you want to use Kafka ACL authorization, you need to identify the user by their username during authentication.
(The <code>sub</code> claim in JWT tokens is typically a unique ID, not a username.)</p>
</div>
<div class="listingblock">
<div class="title">Example configuration for fast local JWT token validation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  kafka:
    #...
    listeners:
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: <strong>oauth</strong>
          validIssuerUri: &lt;https://&lt;auth_server_address&gt;/auth/realms/tls&gt;
          jwksEndpointUri: &lt;https://&lt;auth_server_address&gt;/auth/realms/tls/protocol/openid-connect/certs&gt;
          userNameClaim: preferred_username
          maxSecondsWithoutReauthentication: 3600
          tlsTrustedCertificates:
          - secretName: oauth-server-cert
            certificate: ca.crt
    #...</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="con-oauth-authentication-broker-intro-local"><a class="link" href="#con-oauth-authentication-broker-intro-local">OAuth 2.0 introspection endpoint configuration</a></h5>
<div class="paragraph">
<p>Token validation using an OAuth 2.0 introspection endpoint treats a received access token as opaque.
The Kafka broker sends an access token to the introspection endpoint, which responds with the token information necessary for validation.
Importantly, it returns up-to-date information if the specific access token is valid, and also information about when the token expires.</p>
</div>
<div class="paragraph">
<p>To configure OAuth 2.0 introspection-based validation, you specify an <code>introspectionEndpointUri</code> attribute rather than the <code>jwksEndpointUri</code> attribute specified for fast local JWT token validation.
Depending on the authorization server, you typically have to specify a <code>clientId</code> and <code>clientSecret</code>, because the introspection endpoint is usually protected.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration for an introspection endpoint</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  kafka:
    listeners:
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: <strong>oauth</strong>
          clientId: kafka-broker
          clientSecret:
            secretName: my-cluster-oauth
            key: clientSecret
          validIssuerUri: &lt;https://&lt;auth_server_-_address&gt;/auth/realms/tls&gt;
          introspectionEndpointUri: &lt;https://&lt;auth_server_address&gt;/auth/realms/tls/protocol/openid-connect/token/introspect&gt;
          userNameClaim: preferred_username
          maxSecondsWithoutReauthentication: 3600
          tlsTrustedCertificates:
          - secretName: oauth-server-cert
            certificate: ca.crt</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="str"><a class="link" href="#str">13.4.3. Session re-authentication for Kafka brokers</a></h4>
<div class="paragraph">
<p>You can configure <code>oauth</code> listeners to use Kafka <em>session re-authentication</em> for OAuth 2.0 sessions between Kafka clients and Kafka brokers.
This mechanism enforces the expiry of an authenticated session between the client and the broker after a defined period of time.
When a session expires, the client immediately starts a new session by reusing the existing connection rather than dropping it.</p>
</div>
<div class="paragraph">
<p>Session re-authentication is disabled by default.
To enable it, you set a time value for <code>maxSecondsWithoutReauthentication</code> in the <code>oauth</code> listener configuration.
The same property is used to configure session re-authentication for OAUTHBEARER and PLAIN authentication.
For an example configuration, see <a href="#proc-oauth-authentication-broker-config-str">Configuring OAuth 2.0 support for Kafka brokers</a>.</p>
</div>
<div class="paragraph">
<p>Session re-authentication must be supported by the Kafka client libraries used by the client.</p>
</div>
<div class="paragraph">
<p>Session re-authentication can be used with <em>fast local JWT</em> or <em>introspection endpoint</em> token validation.</p>
</div>
<div class="paragraph">
<div class="title">Client re-authentication</div>
<p>When the broker&#8217;s authenticated session expires, the client must re-authenticate to the existing session by sending a new, valid access token to the broker, without dropping the connection.</p>
</div>
<div class="paragraph">
<p>If token validation is successful, a new client session is started using the existing connection.
If the client fails to re-authenticate, the broker will close the connection if further attempts are made to send or receive messages.
Java clients that use Kafka client library 2.2 or later automatically re-authenticate if the re-authentication mechanism is enabled on the broker.</p>
</div>
<div class="paragraph">
<p>Session re-authentication also applies to refresh tokens, if used.
When the session expires, the client refreshes the access token by using its refresh token.
The client then uses the new access token to re-authenticate to the existing session.</p>
</div>
<div class="paragraph">
<div class="title">Session expiry for OAUTHBEARER and PLAIN</div>
<p>When session re-authentication is configured, session expiry works differently for OAUTHBEARER and PLAIN authentication.</p>
</div>
<div class="paragraph">
<p>For OAUTHBEARER and PLAIN, using the client ID and secret method:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The broker&#8217;s authenticated session will expire at the configured <code>maxSecondsWithoutReauthentication</code>.</p>
</li>
<li>
<p>The session will expire earlier if the access token expires before the configured time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For PLAIN using the long-lived access token method:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The broker&#8217;s authenticated session will expire at the configured <code>maxSecondsWithoutReauthentication</code>.</p>
</li>
<li>
<p>Re-authentication will fail if the access token expires before the configured time.
Although session re-authentication is attempted, PLAIN has no mechanism for refreshing tokens.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If <code>maxSecondsWithoutReauthentication</code> is <em>not</em> configured, OAUTHBEARER and PLAIN clients can remain connected to brokers indefinitely, without needing to re-authenticate.
Authenticated sessions do not end with access token expiry.
However, this can be considered when configuring authorization, for example, by using <code>keycloak</code> authorization or installing a custom authorizer.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#con-oauth-authentication-broker-str">OAuth 2.0 Kafka broker configuration</a></p>
</li>
<li>
<p><a href="#proc-oauth-authentication-broker-config-str">Configuring OAuth 2.0 support for Kafka brokers</a></p>
</li>
<li>
<p><a href="./configuring.html#type-KafkaListenerAuthenticationOAuth-reference" target="_blank" rel="noopener"><code>KafkaListenerAuthenticationOAuth</code> schema reference</a></p>
</li>
<li>
<p><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-368%3A+Allow+SASL+Connections+to+Periodically+Re-Authenticate" target="_blank" rel="noopener">KIP-368</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="con-oauth-authentication-client-str"><a class="link" href="#con-oauth-authentication-client-str">13.4.4. OAuth 2.0 Kafka client configuration</a></h4>
<div class="paragraph">
<p>A Kafka client is configured with either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The credentials required to obtain a valid access token from an authorization server (client ID and Secret)</p>
</li>
<li>
<p>A valid long-lived access token or refresh token, obtained using tools provided by an authorization server</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The only information ever sent to the Kafka broker is an access token.
The credentials used to authenticate with the authorization server to obtain the access token are never sent to the broker.</p>
</div>
<div class="paragraph">
<p>When a client obtains an access token, no further communication with the authorization server is needed.</p>
</div>
<div class="paragraph">
<p>The simplest mechanism is authentication with a client ID and Secret.
Using a long-lived access token, or a long-lived refresh token, adds more complexity because there is an additional dependency on authorization server tools.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using long-lived access tokens, you may need to configure the client in the authorization server to increase the maximum lifetime of the token.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the Kafka client is not configured with an access token directly, the client exchanges credentials for an access token during Kafka session initiation by contacting the authorization server.
The Kafka client exchanges either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Client ID and Secret</p>
</li>
<li>
<p>Client ID, refresh token, and (optionally) a secret</p>
</li>
<li>
<p>Username and password, with client ID and (optionally) a secret</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="con-oauth-authentication-client-options-str"><a class="link" href="#con-oauth-authentication-client-options-str">13.4.5. OAuth 2.0 client authentication flows</a></h4>
<div class="paragraph _abstract">
<p>OAuth 2.0 authentication flows depend on the underlying Kafka client and Kafka broker configuration.
The flows must also be supported by the authorization server used.</p>
</div>
<div class="paragraph">
<p>The Kafka broker listener configuration determines how clients authenticate using an access token.
The client can pass a client ID and secret to request an access token.</p>
</div>
<div class="paragraph">
<p>If a listener is configured to use PLAIN authentication, the client can authenticate with a client ID and secret or username and access token.
These values are passed as the <code>username</code> and <code>password</code> properties of the PLAIN mechanism.</p>
</div>
<div class="paragraph">
<p>Listener configuration supports the following token validation options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can use fast local token validation based on JWT signature checking and local token introspection, without contacting an authorization server.
The authorization server provides a JWKS endpoint with public certificates that are used to validate signatures on the tokens.</p>
</li>
<li>
<p>You can use a call to a token introspection endpoint provided by an authorization server.
Each time a new Kafka broker connection is established, the broker passes the access token received from the client to the authorization server.
The Kafka broker checks the response to confirm whether or not the token is valid.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
An authorization server might only allow the use of opaque access tokens, which means that local token validation is not possible.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Kafka client credentials can also be configured for the following types of authentication:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Direct local access using a previously generated long-lived access token</p>
</li>
<li>
<p>Contact with the authorization server for a new access token to be issued (using a client ID and a secret, or a refresh token, or a username and a password)</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="example_client_authentication_flows_using_the_sasl_oauthbearer_mechanism"><a class="link" href="#example_client_authentication_flows_using_the_sasl_oauthbearer_mechanism">Example client authentication flows using the SASL OAUTHBEARER mechanism</a></h5>
<div class="paragraph">
<p>You can use the following communication flows for Kafka authentication using the SASL OAUTHBEARER mechanism.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#oauth-introspection-endpoint-str">Client using client ID and secret, with broker delegating validation to authorization server</a></p>
</li>
<li>
<p><a href="#oauth-jwt-str">Client using client ID and secret, with broker performing fast local token validation</a></p>
</li>
<li>
<p><a href="#oauth-token-endpoint-str">Client using long-lived access token, with broker delegating validation to authorization server</a></p>
</li>
<li>
<p><a href="#oauth-token-jwt-str">Client using long-lived access token, with broker performing fast local validation</a></p>
</li>
</ul>
</div>
<div id="oauth-introspection-endpoint-str" class="paragraph">
<div class="title">Client using client ID and secret, with broker delegating validation to authorization server</div>
<p><span class="image"><img src="images/oauth-introspection-endpoint.png" alt="Client using client ID and secret with broker delegating validation to authorization server"></span></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Kafka client requests an access token from the authorization server using a client ID and secret, and optionally a refresh token. Alternatively, the client may authenticate using a username and a password.</p>
</li>
<li>
<p>The authorization server generates a new access token.</p>
</li>
<li>
<p>The Kafka client authenticates with the Kafka broker using the SASL OAUTHBEARER mechanism to pass the access token.</p>
</li>
<li>
<p>The Kafka broker validates the access token by calling a token introspection endpoint on the authorization server using its own client ID and secret.</p>
</li>
<li>
<p>A Kafka client session is established if the token is valid.</p>
</li>
</ol>
</div>
<div id="oauth-jwt-str" class="paragraph">
<div class="title">Client using client ID and secret, with broker performing fast local token validation</div>
<p><span class="image"><img src="images/oauth-jwt-signature.png" alt="Client using client ID and secret with broker performing fast local token validation"></span></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Kafka client authenticates with the authorization server from the token endpoint, using a client ID and secret, and optionally a refresh token. Alternatively, the client may authenticate using a username and a password.</p>
</li>
<li>
<p>The authorization server generates a new access token.</p>
</li>
<li>
<p>The Kafka client authenticates with the Kafka broker using the SASL OAUTHBEARER mechanism to pass the access token.</p>
</li>
<li>
<p>The Kafka broker validates the access token locally using a JWT token signature check, and local token introspection.</p>
</li>
</ol>
</div>
<div id="oauth-token-endpoint-str" class="paragraph">
<div class="title">Client using long-lived access token, with broker delegating validation to authorization server</div>
<p><span class="image"><img src="images/oauth-introspection-endpoint-long-token.png" alt="Client using long-lived access token with broker delegating validation to authorization server"></span></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Kafka client authenticates with the Kafka broker using the SASL OAUTHBEARER mechanism to pass the long-lived access token.</p>
</li>
<li>
<p>The Kafka broker validates the access token by calling a token introspection endpoint on the authorization server, using its own client ID and secret.</p>
</li>
<li>
<p>A Kafka client session is established if the token is valid.</p>
</li>
</ol>
</div>
<div id="oauth-token-jwt-str" class="paragraph">
<div class="title">Client using long-lived access token, with broker performing fast local validation</div>
<p><span class="image"><img src="images/oauth-jwt-signature-token.png" alt="Client using long-lived access token with broker performing fast local validation"></span></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Kafka client authenticates with the Kafka broker using the SASL OAUTHBEARER mechanism to pass the long-lived access token.</p>
</li>
<li>
<p>The Kafka broker validates the access token locally using a JWT token signature check and local token introspection.</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Fast local JWT token signature validation is suitable only for short-lived tokens as there is no check with the authorization server if a token has been revoked.
Token expiration is written into the token, but revocation can happen at any time, so cannot be accounted for without contacting the authorization server.
Any issued token would be considered valid until it expires.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="example_client_authentication_flows_using_the_sasl_plain_mechanism"><a class="link" href="#example_client_authentication_flows_using_the_sasl_plain_mechanism">Example client authentication flows using the SASL PLAIN mechanism</a></h5>
<div class="paragraph">
<p>You can use the following communication flows for Kafka authentication using the OAuth PLAIN mechanism.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#oauth-plain-client-id-str">Client using a client ID and secret, with the broker obtaining the access token for the client</a></p>
</li>
<li>
<p><a href="#oauth-plain-access-token-str">Client using a long-lived access token without a client ID and secret</a></p>
</li>
</ul>
</div>
<div id="oauth-plain-client-id-str" class="paragraph">
<div class="title">Client using a client ID and secret, with the broker obtaining the access token for the client</div>
<p><span class="image"><img src="images/oauth-plain-client-id.png" alt="Client using a client ID and secret with the broker obtaining the access token for the client"></span></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Kafka client passes a <code>clientId</code> as a username and a <code>secret</code> as a password.</p>
</li>
<li>
<p>The Kafka broker uses a token endpoint to pass the <code>clientId</code> and <code>secret</code> to the authorization server.</p>
</li>
<li>
<p>The authorization server returns a fresh access token or an error if the client credentials are not valid.</p>
</li>
<li>
<p>The Kafka broker validates the token in one of the following ways:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If a token introspection endpoint is specified, the Kafka broker validates the access token by calling the endpoint on the authorization server.
A session is established if the token validation is successful.</p>
</li>
<li>
<p>If local token introspection is used, a request is not made to the authorization server.
The Kafka broker validates the access token locally using a JWT token signature check.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div id="oauth-plain-access-token-str" class="paragraph">
<div class="title">Client using a long-lived access token without a client ID and secret</div>
<p><span class="image"><img src="images/oauth-plain-access-token.png" alt="Client using a long-lived access token without a client ID and secret"></span></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Kafka client passes a username and password. The password provides the value of an access token that was obtained manually and configured before running the client.</p>
</li>
<li>
<p>The password is passed with or without an <code>$accessToken:</code> string prefix depending on whether or not the Kafka broker listener is configured with a token endpoint for authentication.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If the token endpoint is configured, the password should be prefixed by <code>$accessToken:</code> to let the broker know that the password parameter contains an access token rather than a client secret. The Kafka broker interprets the username as the account username.</p>
</li>
<li>
<p>If the token endpoint is not configured on the Kafka broker listener (enforcing a <code>no-client-credentials mode</code>), the password should provide the access token without the prefix. The Kafka broker interprets the username as the account username.
In this mode, the client doesn&#8217;t use a client ID and secret, and the <code>password</code> parameter is always interpreted as a raw access token.</p>
</li>
</ol>
</div>
</li>
<li>
<p>The Kafka broker validates the token in one of the following ways:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If a token introspection endpoint is specified, the Kafka broker validates the access token by calling the endpoint on the authorization server. A session is established if token validation is successful.</p>
</li>
<li>
<p>If local token introspection is used, there is no request made to the authorization server. Kafka broker validates the access token locally using a JWT token signature check.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="con-oauth-strimzi-config-str"><a class="link" href="#con-oauth-strimzi-config-str">13.4.6. Configuring OAuth 2.0 authentication</a></h4>
<div class="paragraph">
<p>OAuth 2.0 is used for interaction between Kafka clients and Strimzi components.</p>
</div>
<div class="paragraph">
<p>In order to use OAuth 2.0 for Strimzi, you must:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#proc-oauth-server-config-str">Configure an OAuth 2.0 authorization server for the Strimzi cluster and Kafka clients</a></p>
</li>
<li>
<p><a href="#proc-oauth-authentication-broker-config-str">Deploy or update the Kafka cluster with Kafka broker listeners configured to use OAuth 2.0</a></p>
</li>
<li>
<p><a href="#proc-oauth-client-config-str">Update your Java-based Kafka clients to use OAuth 2.0</a></p>
</li>
<li>
<p><a href="#proc-oauth-kafka-config-str">Update Kafka component clients to use OAuth 2.0</a></p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="proc-oauth-server-config-str"><a class="link" href="#proc-oauth-server-config-str">Configuring an OAuth 2.0 authorization server</a></h5>
<div class="paragraph">
<p>This procedure describes in general what you need to do to configure an authorization server for integration with Strimzi.</p>
</div>
<div class="paragraph">
<p>These instructions are not product specific.</p>
</div>
<div class="paragraph">
<p>The steps are dependent on the chosen authorization server.
Consult the product documentation for the authorization server for information on how to set up OAuth 2.0 access.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you already have an authorization server deployed, you can skip the deployment step and use your current deployment.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy the authorization server to your cluster.</p>
</li>
<li>
<p>Access the CLI or admin console for the authorization server to configure OAuth 2.0 for Strimzi.</p>
<div class="paragraph">
<p>Now prepare the authorization server to work with Strimzi.</p>
</div>
</li>
<li>
<p>Configure a <code>kafka-broker</code> client.</p>
</li>
<li>
<p>Configure clients for each Kafka client component of your application.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">What to do next</div>
<p>After deploying and configuring the authorization server, <a href="#proc-oauth-authentication-broker-config-str">configure the Kafka brokers to use OAuth 2.0</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="proc-oauth-authentication-broker-config-str"><a class="link" href="#proc-oauth-authentication-broker-config-str">Configuring OAuth 2.0 support for Kafka brokers</a></h5>
<div class="paragraph">
<p>This procedure describes how to configure Kafka brokers so that the broker listeners are enabled to use OAuth 2.0 authentication using an authorization server.</p>
</div>
<div class="paragraph">
<p>We advise use of OAuth 2.0 over an encrypted interface through through a listener with <code>tls: true</code>.
Plain listeners are not recommended.</p>
</div>
<div class="paragraph">
<p>If the authorization server is using certificates signed by the trusted CA and matching the OAuth 2.0 server hostname, TLS connection works using the default settings.
Otherwise, you may need to configure the truststore with proper certificates or disable the certificate hostname validation.</p>
</div>
<div class="paragraph">
<p>When configuring the Kafka broker you have two options for the mechanism used to validate the access token during OAuth 2.0 authentication of the newly connected Kafka client:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#example-1">Configuring fast local JWT token validation</a></p>
</li>
<li>
<p><a href="#example-2">Configuring token validation using an introspection endpoint</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Before you start</div>
<p>For more information on the configuration of OAuth 2.0 authentication for Kafka broker listeners, see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./configuring.html#type-KafkaListenerAuthenticationOAuth-reference" target="_blank" rel="noopener"><code>KafkaListenerAuthenticationOAuth</code> schema reference</a></p>
</li>
<li>
<p><a href="#con-oauth-authentication-flow-str">OAuth 2.0 authentication mechanisms</a></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Strimzi and Kafka are running</p>
</li>
<li>
<p>An OAuth 2.0 authorization server is deployed</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Update the Kafka broker configuration (<code>Kafka.spec.kafka</code>) of your <code>Kafka</code> resource in an editor.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit kafka my-cluster</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the Kafka broker <code>listeners</code> configuration.</p>
<div class="paragraph">
<p>The configuration for each type of listener does not have to be the same, as they are independent.</p>
</div>
<div class="paragraph">
<p>The examples here show the configuration options as configured for external listeners.</p>
</div>
<div class="openblock">
<div class="content">
<div id="example-1" class="listingblock">
<div class="title">Example 1: Configuring fast local JWT token validation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">#...
- name: external3
  port: 9094
  type: loadbalancer
  tls: true
  authentication:
    type: oauth # <b class="conum">(1)</b>
    validIssuerUri: https://&lt;auth_server_address&gt;/auth/realms/external # <b class="conum">(2)</b>
    jwksEndpointUri: https://&lt;auth_server_address&gt;/auth/realms/external/protocol/openid-connect/certs # <b class="conum">(3)</b>
    userNameClaim: preferred_username # <b class="conum">(4)</b>
    maxSecondsWithoutReauthentication: 3600 # <b class="conum">(5)</b>
    tlsTrustedCertificates: # <b class="conum">(6)</b>
    - secretName: oauth-server-cert
      certificate: ca.crt
    disableTlsHostnameVerification: true # <b class="conum">(7)</b>
    jwksExpirySeconds: 360 # <b class="conum">(8)</b>
    jwksRefreshSeconds: 300 # <b class="conum">(9)</b>
    jwksMinRefreshPauseSeconds: 1 # <b class="conum">(10)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Listener type set to <code>oauth</code>.</p>
</li>
<li>
<p>URI of the token issuer used for authentication.</p>
</li>
<li>
<p>URI of the JWKS certificate endpoint used for local JWT validation.</p>
</li>
<li>
<p>The token claim (or key) that contains the actual username used to identify the user. Its value depends on the authorization server. If necessary, a JsonPath expression like <code>"['user.info'].['user.id']"</code> can be used to retrieve the username from nested JSON attributes within a token.</p>
</li>
<li>
<p>(Optional) Activates the Kafka re-authentication mechanism that enforces session expiry to the same length of time as the access token. If the specified value is less than the time left for the access token to expire, then the client will have to re-authenticate before the actual token expiry. By default, the session does not expire when the access token expires, and the client does not attempt re-authentication.</p>
</li>
<li>
<p>(Optional) Trusted certificates for TLS connection to the authorization server.</p>
</li>
<li>
<p>(Optional) Disable TLS hostname verification. Default is <code>false</code>.</p>
</li>
<li>
<p>The duration the JWKS certificates are considered valid before they expire. Default is <code>360</code> seconds. If you specify a longer time, consider the risk of allowing access to revoked certificates.</p>
</li>
<li>
<p>The period between refreshes of JWKS certificates. The interval must be at least 60 seconds shorter than the expiry interval. Default is <code>300</code> seconds.</p>
</li>
<li>
<p>The minimum pause in seconds between consecutive attempts to refresh JWKS public keys. When an unknown signing key is encountered, the JWKS keys refresh is scheduled outside the regular periodic schedule with at least the specified pause since the last refresh attempt. The refreshing of keys follows the rule of exponential backoff, retrying on unsuccessful refreshes with ever increasing pause, until it reaches <code>jwksRefreshSeconds</code>. The default value is 1.</p>
</li>
</ol>
</div>
<div id="example-2" class="listingblock">
<div class="title">Example 2: Configuring token validation using an introspection endpoint</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- name: external3
  port: 9094
  type: loadbalancer
  tls: true
  authentication:
    type: oauth
    validIssuerUri: https://&lt;auth_server_address&gt;/auth/realms/external
    introspectionEndpointUri: https://&lt;auth_server_address&gt;/auth/realms/external/protocol/openid-connect/token/introspect # <b class="conum">(1)</b>
    clientId: kafka-broker # <b class="conum">(2)</b>
    clientSecret: # <b class="conum">(3)</b>
      secretName: my-cluster-oauth
      key: clientSecret
    userNameClaim: preferred_username # <b class="conum">(4)</b>
    maxSecondsWithoutReauthentication: 3600 # <b class="conum">(5)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>URI of the token introspection endpoint.</p>
</li>
<li>
<p>Client ID to identify the client.</p>
</li>
<li>
<p>Client Secret and client ID is used for authentication.</p>
</li>
<li>
<p>The token claim (or key) that contains the actual username used to identify the user. Its value depends on the authorization server. If necessary, a JsonPath expression like <code>"['user.info'].['user.id']"</code> can be used to retrieve the username from nested JSON attributes within a token.</p>
</li>
<li>
<p>(Optional) Activates the Kafka re-authentication mechanism that enforces session expiry to the same length of time as the access token. If the specified value is less than the time left for the access token to expire, then the client will have to re-authenticate before the actual token expiry. By default, the session does not expire when the access token expires, and the client does not attempt re-authentication.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Depending on how you apply OAuth 2.0 authentication, and the type of authorization server, there are additional (optional) configuration settings you can use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  # ...
  authentication:
    type: oauth
    # ...
    checkIssuer: false # <b class="conum">(1)</b>
    checkAudience: true # <b class="conum">(2)</b>
    fallbackUserNameClaim: client_id # <b class="conum">(3)</b>
    fallbackUserNamePrefix: client-account- # <b class="conum">(4)</b>
    validTokenType: bearer # <b class="conum">(5)</b>
    userInfoEndpointUri: https://&lt;auth_server_address&gt;/auth/realms/external/protocol/openid-connect/userinfo # <b class="conum">(6)</b>
    enableOauthBearer: false # <b class="conum">(7)</b>
    enablePlain: true # <b class="conum">(8)</b>
    tokenEndpointUri: https://&lt;auth_server_address&gt;/auth/realms/external/protocol/openid-connect/token # <b class="conum">(9)</b>
    customClaimCheck: "@.custom == 'custom-value'" # <b class="conum">(10)</b>
    clientAudience: audience # <b class="conum">(11)</b>
    clientScope: scope # <b class="conum">(12)</b>
    connectTimeoutSeconds: 60 # <b class="conum">(13)</b>
    readTimeoutSeconds: 60 # <b class="conum">(14)</b>
    httpRetries: 2 # <b class="conum">(15)</b>
    httpRetryPauseMs: 300 # <b class="conum">(16)</b>
    groupsClaim: "$.groups" # <b class="conum">(17)</b>
    groupsClaimDelimiter: "," # <b class="conum">(18)</b>
    includeAcceptHeader: false # <b class="conum">(19)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>If your authorization server does not provide an <code>iss</code> claim, it is not possible to perform an issuer check. In this situation, set <code>checkIssuer</code> to <code>false</code> and do not specify a <code>validIssuerUri</code>. Default is <code>true</code>.</p>
</li>
<li>
<p>If your authorization server provides an <code>aud</code> (audience) claim, and you want to enforce an audience check, set <code>checkAudience</code> to <code>true</code>. Audience checks identify the intended recipients of tokens. As a result, the Kafka broker will reject tokens that do not have its <code>clientId</code> in their <code>aud</code> claim. Default is <code>false</code>.</p>
</li>
<li>
<p>An authorization server may not provide a single attribute to identify both regular users and clients. When a client authenticates in its own name, the server might provide a <em>client ID</em>. When a user authenticates using a username and password to obtain a refresh token or an access token, the server might provide a <em>username</em> attribute in addition to a client ID. Use this fallback option to specify the username claim (attribute) to use if a primary user ID attribute is not available. If necessary, a JsonPath expression like <code>"['client.info'].['client.id']"</code> can be used to retrieve the fallback username  to retrieve the username from nested JSON attributes within a token.</p>
</li>
<li>
<p>In situations where <code>fallbackUserNameClaim</code> is applicable, it may also be necessary to prevent name collisions between the values of the username claim, and those of the fallback username claim. Consider a situation where a client called <code>producer</code> exists, but also a regular user called <code>producer</code> exists. In order to differentiate between the two, you can use this property to add a prefix to the user ID of the client.</p>
</li>
<li>
<p>(Only applicable when using <code>introspectionEndpointUri</code>) Depending on the authorization server you are using, the introspection endpoint may or may not return the <em>token type</em> attribute, or it may contain different values. You can specify a valid token type value that the response from the introspection endpoint has to contain.</p>
</li>
<li>
<p>(Only applicable when using <code>introspectionEndpointUri</code>) The authorization server may be configured or implemented in such a way to not provide any identifiable information in an Introspection Endpoint response. In order to obtain the user ID, you can configure the URI of the <code>userinfo</code> endpoint as a fallback. The <code>userNameClaim</code>, <code>fallbackUserNameClaim</code>, and <code>fallbackUserNamePrefix</code> settings are applied to the response of <code>userinfo</code> endpoint.</p>
</li>
<li>
<p>Set this to <code>false</code> to disable the OAUTHBEARER mechanism on the listener. At least one of PLAIN or OAUTHBEARER has to be enabled. Default is <code>true</code>.</p>
</li>
<li>
<p>Set to <code>true</code> to enable PLAIN authentication on the listener, which is supported for clients on all platforms.</p>
</li>
<li>
<p>Additional configuration for the PLAIN mechanism. If specified, clients can authenticate over PLAIN by passing an access token as the <code>password</code> using an <code>$accessToken:</code> prefix.
For production, always use <code>https://</code> urls.</p>
</li>
<li>
<p>Additional custom rules can be imposed on the JWT access token during validation by setting this to a JsonPath filter query. If the access token does not contain the necessary data, it is rejected. When using the <code>introspectionEndpointUri</code>, the custom check is applied to the introspection endpoint response JSON.</p>
</li>
<li>
<p>An <code>audience</code> parameter passed to the token endpoint. An <em>audience</em> is used  when obtaining an access token for inter-broker authentication. It is also used in the name of a client for OAuth 2.0 over PLAIN client authentication using a <code>clientId</code> and <code>secret</code>. This only affects the ability to obtain the token, and the content of the token, depending on the authorization server. It does not affect token validation rules by the listener.</p>
</li>
<li>
<p>A <code>scope</code> parameter passed to the token endpoint. A <em>scope</em> is used when obtaining an access token for inter-broker authentication. It is also used in the name of a client for OAuth 2.0 over PLAIN client authentication using a <code>clientId</code> and <code>secret</code>. This only affects the ability to obtain the token, and the content of the token, depending on the authorization server. It does not affect token validation rules by the listener.</p>
</li>
<li>
<p>The connect timeout in seconds when connecting to the authorization server. The default value is 60.</p>
</li>
<li>
<p>The read timeout in seconds when connecting to the authorization server. The default value is 60.</p>
</li>
<li>
<p>The maximum number of times to retry a failed HTTP request to the authorization server. The default value is <code>0</code>, meaning that no retries are performed. To use this option effectively, consider reducing the timeout times for the <code>connectTimeoutSeconds</code> and <code>readTimeoutSeconds</code> options. However, note that retries may prevent the current worker thread from being available to other requests, and if too many requests stall, it could make the Kafka broker unresponsive.</p>
</li>
<li>
<p>The time to wait before attempting another retry of a failed HTTP request to the authorization server. By default, this time is set to zero, meaning that no pause is applied. This is because many issues that cause failed requests are per-request network glitches or proxy issues that can be resolved quickly. However, if your authorization server is under stress or experiencing high traffic, you may want to set this option to a value of 100 ms or more to reduce the load on the server and increase the likelihood of successful retries.</p>
</li>
<li>
<p>A JsonPath query that is used to extract groups information from either the JWT token or the introspection endpoint response. This option is not set by default. By configuring this option, a custom authorizer can make authorization decisions based on user groups.</p>
</li>
<li>
<p>A delimiter used to parse groups information when it is returned as a single delimited string. The default value is ',' (comma).</p>
</li>
<li>
<p>Some authorization servers have issues with client sending <code>Accept: application/json</code> header. By setting <code>includeAcceptHeader: false</code> the header will not be sent. Default is <code>true</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Save and exit the editor, then wait for rolling updates to complete.</p>
</li>
<li>
<p>Check the update in the logs or by watching the pod state transitions:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl logs -f ${POD_NAME} -c ${CONTAINER_NAME}
kubectl get pod -w</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rolling update configures the brokers to use OAuth 2.0 authentication.</p>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">What to do next</div>
<ul>
<li>
<p><a href="#proc-oauth-client-config-str">Configure your Kafka clients to use OAuth 2.0</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="proc-oauth-client-config-str"><a class="link" href="#proc-oauth-client-config-str">Configuring Kafka Java clients to use OAuth 2.0</a></h5>
<div class="paragraph _abstract">
<p>Configure Kafka producer and consumer APIs to use OAuth 2.0 for interaction with Kafka brokers.
Add a callback plugin to your client <code>pom.xml</code> file, then configure your client for OAuth 2.0.</p>
</div>
<div class="paragraph">
<p>Specify the following in your client configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A SASL (Simple Authentication and Security Layer) security protocol:</p>
<div class="ulist">
<ul>
<li>
<p><code>SASL_SSL</code> for authentication over TLS encrypted connections</p>
</li>
<li>
<p><code>SASL_PLAINTEXT</code> for authentication over unencrypted connections</p>
<div class="paragraph">
<p>Use <code>SASL_SSL</code> for production and <code>SASL_PLAINTEXT</code> for local development only.
When using <code>SASL_SSL</code>, additional <code>ssl.truststore</code> configuration is needed.
The truststore configuration is required for secure connection (<code>https://</code>) to the OAuth 2.0 authorization server.
To verify the OAuth 2.0 authorization server, add the CA certificate for the authorization server to the truststore in your client configuration.
You can configure a truststore in PEM or PKCS #12 format.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>A Kafka SASL mechanism:</p>
<div class="ulist">
<ul>
<li>
<p><code>OAUTHBEARER</code> for credentials exchange using a bearer token</p>
</li>
<li>
<p><code>PLAIN</code> to pass client credentials (clientId + secret) or an access token</p>
</li>
</ul>
</div>
</li>
<li>
<p>A JAAS (Java Authentication and Authorization Service) module that implements the SASL mechanism:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule</code> implements the OAuthbearer mechanism</p>
</li>
<li>
<p><code>org.apache.kafka.common.security.plain.PlainLoginModule</code> implements the plain mechanism</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>To be able to use the OAuthbearer mechanism, you must also add the custom <code>io.strimzi.kafka.oauth.client.JaasClientOauthLoginCallbackHandler</code> class as the callback handler.
<code>JaasClientOauthLoginCallbackHandler</code> handles OAuth callbacks to the authorization server for access tokens during client login.
This enables automatic token renewal, ensuring continuous authentication without user intervention.
Additionally, it handles login credentials for clients using the OAuth 2.0 password grant method.</p>
</div>
</li>
<li>
<p>SASL authentication properties, which support the following authentication methods:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>OAuth 2.0 client credentials</p>
</li>
<li>
<p>OAuth 2.0 password grant (deprecated)</p>
</li>
<li>
<p>Access token</p>
</li>
<li>
<p>Refresh token</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Add the SASL authentication properties as JAAS configuration (<code>sasl.jaas.config</code> and <code>sasl.login.callback.handler.class</code>).
How you configure the authentication properties depends on the authentication method you are using to access the OAuth 2.0 authorization server.
In this procedure, the properties are specified in a properties file, then loaded into the client configuration.</p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You can also specify authentication properties as environment variables, or as Java system properties. For Java system properties, you can set them using <code>setProperty</code> and pass them on the command line using the <code>-D</code> option.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Strimzi and Kafka are running</p>
</li>
<li>
<p>An OAuth 2.0 authorization server is deployed and configured for OAuth access to Kafka brokers</p>
</li>
<li>
<p>Kafka brokers are configured for OAuth 2.0</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the client library with OAuth 2.0 support to the <code>pom.xml</code> file for the Kafka client:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
 &lt;groupId&gt;io.strimzi&lt;/groupId&gt;
 &lt;artifactId&gt;kafka-oauth-client&lt;/artifactId&gt;
 &lt;version&gt;0.14.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the client properties by specifying the following configuration in a properties file:</p>
<div class="ulist">
<ul>
<li>
<p>The security protocol</p>
</li>
<li>
<p>The SASL mechanism</p>
</li>
<li>
<p>The JAAS module and authentication properties according to the method being used</p>
<div class="paragraph">
<p>For example, we can add the following to a <code>client.properties</code> file:</p>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Client credentials mechanism properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">security.protocol=SASL_SSL # <b class="conum">(1)</b>
sasl.mechanism=OAUTHBEARER # <b class="conum">(2)</b>
ssl.truststore.location=/tmp/truststore.p12 <b class="conum">(3)</b>
ssl.truststore.password=$STOREPASS
ssl.truststore.type=PKCS12
sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required \
  oauth.token.endpoint.uri="&lt;token_endpoint_url&gt;" \ # <b class="conum">(4)</b>
  oauth.client.id="&lt;client_id&gt;" \ # <b class="conum">(5)</b>
  oauth.client.secret="&lt;client_secret&gt;" \ # <b class="conum">(6)</b>
  oauth.ssl.truststore.location="/tmp/oauth-truststore.p12" \ <b class="conum">(7)</b>
  oauth.ssl.truststore.password="$STOREPASS" \ <b class="conum">(8)</b>
  oauth.ssl.truststore.type="PKCS12" \ <b class="conum">(9)</b>
  oauth.scope="&lt;scope&gt;" \ # <b class="conum">(10)</b>
  oauth.audience="&lt;audience&gt;" ; # <b class="conum">(11)</b>
sasl.login.callback.handler.class=io.strimzi.kafka.oauth.client.JaasClientOauthLoginCallbackHandler</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>SASL_SSL</code> security protocol for TLS-encrypted connections. Use <code>SASL_PLAINTEXT</code> over unencrypted connections for local development only.</p>
</li>
<li>
<p>The SASL mechanism specified as <code>OAUTHBEARER</code> or <code>PLAIN</code>.</p>
</li>
<li>
<p>The truststore configuration for secure access to the Kafka cluster.</p>
</li>
<li>
<p>URI of the authorization server token endpoint.</p>
</li>
<li>
<p>Client ID, which is the name used when creating the <em>client</em> in the authorization server.</p>
</li>
<li>
<p>Client secret created when creating the <em>client</em> in the authorization server.</p>
</li>
<li>
<p>The location contains the public key certificate (<code>truststore.p12</code>) for the authorization server.</p>
</li>
<li>
<p>The password for accessing the truststore.</p>
</li>
<li>
<p>The truststore type.</p>
</li>
<li>
<p>(Optional) The <code>scope</code> for requesting the token from the token endpoint.
An authorization server may require a client to specify the scope.</p>
</li>
<li>
<p>(Optional) The <code>audience</code> for requesting the token from the token endpoint.
An authorization server may require a client to specify the audience.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Password grants mechanism properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">security.protocol=SASL_SSL
sasl.mechanism=OAUTHBEARER
ssl.truststore.location=/tmp/truststore.p12
ssl.truststore.password=$STOREPASS
ssl.truststore.type=PKCS12
sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required \
  oauth.token.endpoint.uri="&lt;token_endpoint_url&gt;" \
  oauth.client.id="&lt;client_id&gt;" \ # <b class="conum">(1)</b>
  oauth.client.secret="&lt;client_secret&gt;" \ # <b class="conum">(2)</b>
  oauth.password.grant.username="&lt;username&gt;" \ # <b class="conum">(3)</b>
  oauth.password.grant.password="&lt;password&gt;" \ # <b class="conum">(4)</b>
  oauth.ssl.truststore.location="/tmp/oauth-truststore.p12" \
  oauth.ssl.truststore.password="$STOREPASS" \
  oauth.ssl.truststore.type="PKCS12" \
  oauth.scope="&lt;scope&gt;" \
  oauth.audience="&lt;audience&gt;" ;
sasl.login.callback.handler.class=io.strimzi.kafka.oauth.client.JaasClientOauthLoginCallbackHandler</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Client ID, which is the name used when creating the <em>client</em> in the authorization server.</p>
</li>
<li>
<p>(Optional) Client secret created when creating the <em>client</em> in the authorization server.</p>
</li>
<li>
<p>Username for password grant authentication. OAuth password grant configuration (username and password) uses the OAuth 2.0 password grant method. To use password grants, create a user account for a client on your authorization server with limited permissions. The account should act like a service account. Use in environments where user accounts are required for authentication, but consider using a refresh token first.</p>
</li>
<li>
<p>Password for password grant authentication.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
SASL PLAIN does not support passing a username and password (password grants) using the OAuth 2.0 password grant method.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Access token properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">security.protocol=SASL_SSL
sasl.mechanism=OAUTHBEARER
ssl.truststore.location=/tmp/truststore.p12
ssl.truststore.password=$STOREPASS
ssl.truststore.type=PKCS12
sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required \
  oauth.token.endpoint.uri="&lt;token_endpoint_url&gt;" \
  oauth.access.token="&lt;access_token&gt;" \ # <b class="conum">(1)</b>
  oauth.ssl.truststore.location="/tmp/oauth-truststore.p12" \
  oauth.ssl.truststore.password="$STOREPASS" \
  oauth.ssl.truststore.type="PKCS12" ;
sasl.login.callback.handler.class=io.strimzi.kafka.oauth.client.JaasClientOauthLoginCallbackHandler</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Long-lived access token for Kafka clients.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Refresh token properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">security.protocol=SASL_SSL
sasl.mechanism=OAUTHBEARER
ssl.truststore.location=/tmp/truststore.p12
ssl.truststore.password=$STOREPASS
ssl.truststore.type=PKCS12
sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required \
  oauth.token.endpoint.uri="&lt;token_endpoint_url&gt;" \
  oauth.client.id="&lt;client_id&gt;" \ # <b class="conum">(1)</b>
  oauth.client.secret="&lt;client_secret&gt;" \ # <b class="conum">(2)</b>
  oauth.refresh.token="&lt;refresh_token&gt;" \ # <b class="conum">(3)</b>
  oauth.ssl.truststore.location="/tmp/oauth-truststore.p12" \
  oauth.ssl.truststore.password="$STOREPASS" \
  oauth.ssl.truststore.type="PKCS12" ;
sasl.login.callback.handler.class=io.strimzi.kafka.oauth.client.JaasClientOauthLoginCallbackHandler</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Client ID, which is the name used when creating the <em>client</em> in the authorization server.</p>
</li>
<li>
<p>(Optional) Client secret created when creating the <em>client</em> in the authorization server.</p>
</li>
<li>
<p>Long-lived refresh token for Kafka clients.</p>
</li>
</ol>
</div>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Input the client properties for OAUTH 2.0 authentication into the Java client code.</p>
<div class="listingblock">
<div class="title">Example showing input of client properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Properties props = new Properties();
try (FileReader reader = new FileReader("client.properties", StandardCharsets.UTF_8)) {
  props.load(reader);
}</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the Kafka client can access the Kafka brokers.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="proc-oauth-kafka-config-str"><a class="link" href="#proc-oauth-kafka-config-str">Configuring OAuth 2.0 for Kafka components</a></h5>
<div class="paragraph">
<p>This procedure describes how to configure Kafka components to use OAuth 2.0 authentication using an authorization server.</p>
</div>
<div class="paragraph">
<p>You can configure authentication for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kafka Connect</p>
</li>
<li>
<p>Kafka MirrorMaker</p>
</li>
<li>
<p>Kafka Bridge</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this scenario, the Kafka component and the authorization server are running in the same cluster.</p>
</div>
<div class="paragraph">
<div class="title">Before you start</div>
<p>For more information on the configuration of OAuth 2.0 authentication for Kafka components, see the <a href="./configuring.html#type-KafkaClientAuthenticationOAuth-reference" target="_blank" rel="noopener"><code>KafkaClientAuthenticationOAuth</code> schema reference</a>.
The schema reference includes examples of configuration options.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Strimzi and Kafka are running</p>
</li>
<li>
<p>An OAuth 2.0 authorization server is deployed and configured for OAuth access to Kafka brokers</p>
</li>
<li>
<p>Kafka brokers are configured for OAuth 2.0</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a client secret and mount it to the component as an environment variable.</p>
<div class="paragraph">
<p>For example, here we are creating a client <code>Secret</code> for the Kafka Bridge:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Secret
metadata:
 name: my-bridge-oauth
type: Opaque
data:
 clientSecret: MGQ1OTRmMzYtZTllZS00MDY2LWI5OGEtMTM5MzM2NjdlZjQw <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>clientSecret</code> key must be in base64 format.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create or edit the resource for the Kafka component so that OAuth 2.0 authentication is configured for the authentication property.</p>
<div class="paragraph">
<p>For OAuth 2.0 authentication, you can use the following options:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Client ID and secret</p>
</li>
<li>
<p>Client ID and refresh token</p>
</li>
<li>
<p>Access token</p>
</li>
<li>
<p>Username and password</p>
</li>
<li>
<p>TLS</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>For example, here OAuth 2.0 is assigned to the Kafka Bridge client using a client ID and secret, and TLS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaBridge
metadata:
  name: my-bridge
spec:
  # ...
  authentication:
    type: oauth <b class="conum">(1)</b>
    tokenEndpointUri: https://&lt;auth-server-address&gt;/auth/realms/master/protocol/openid-connect/token <b class="conum">(2)</b>
    clientId: kafka-bridge
    clientSecret:
      secretName: my-bridge-oauth
      key: clientSecret
    tlsTrustedCertificates: <b class="conum">(3)</b>
    - secretName: oauth-server-cert
      certificate: tls.crt</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Authentication type set to <code>oauth</code>.</p>
</li>
<li>
<p>URI of the token endpoint for authentication.</p>
</li>
<li>
<p>Trusted certificates for TLS connection to the authorization server.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Depending on how you apply OAuth 2.0 authentication, and the type of authorization server, there are additional configuration options you can use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
spec:
  # ...
  authentication:
    # ...
    disableTlsHostnameVerification: true <b class="conum">(1)</b>
    checkAccessTokenType: false <b class="conum">(2)</b>
    accessTokenIsJwt: false <b class="conum">(3)</b>
    scope: any <b class="conum">(4)</b>
    audience: kafka <b class="conum">(5)</b>
    connectTimeoutSeconds: 60 <b class="conum">(6)</b>
    readTimeoutSeconds: 60 <b class="conum">(7)</b>
    httpRetries: 2 <b class="conum">(8)</b>
    httpRetryPauseMs: 300 <b class="conum">(9)</b>
    includeAcceptHeader: false <b class="conum">(10)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>(Optional) Disable TLS hostname verification. Default is <code>false</code>.</p>
</li>
<li>
<p>If the authorization server does not return a <code>typ</code> (type) claim inside the JWT token, you can apply <code>checkAccessTokenType: false</code> to skip the token type check. Default is <code>true</code>.</p>
</li>
<li>
<p>If you are using opaque tokens, you can apply <code>accessTokenIsJwt: false</code> so that access tokens are not treated as JWT tokens.</p>
</li>
<li>
<p>(Optional) The <code>scope</code> for requesting the token from the token endpoint.
An authorization server may require a client to specify the scope.
In this case it is <code>any</code>.</p>
</li>
<li>
<p>(Optional) The <code>audience</code> for requesting the token from the token endpoint.
An authorization server may require a client to specify the audience.
In this case it is <code>kafka</code>.</p>
</li>
<li>
<p>(Optional) The connect timeout in seconds when connecting to the authorization server. The default value is 60.</p>
</li>
<li>
<p>(Optional) The read timeout in seconds when connecting to the authorization server. The default value is 60.</p>
</li>
<li>
<p>(Optional) The maximum number of times to retry a failed HTTP request to the authorization server. The default value is <code>0</code>, meaning that no retries are performed. To use this option effectively, consider reducing the timeout times for the <code>connectTimeoutSeconds</code> and <code>readTimeoutSeconds</code> options. However, note that retries may prevent the current worker thread from being available to other requests, and if too many requests stall, it could make the Kafka broker unresponsive.</p>
</li>
<li>
<p>(Optional) The time to wait before attempting another retry of a failed HTTP request to the authorization server. By default, this time is set to zero, meaning that no pause is applied. This is because many issues that cause failed requests are per-request network glitches or proxy issues that can be resolved quickly. However, if your authorization server is under stress or experiencing high traffic, you may want to set this option to a value of 100 ms or more to reduce the load on the server and increase the likelihood of successful retries.</p>
</li>
<li>
<p>(Optional) Some authorization servers have issues with client sending <code>Accept: application/json</code> header. By setting <code>includeAcceptHeader: false</code> the header will not be sent. Default is <code>true</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Apply the changes to the deployment of your Kafka resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kubectl apply -f your-file</code></pre>
</div>
</div>
</li>
<li>
<p>Check the update in the logs or by watching the pod state transitions:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kubectl logs -f ${POD_NAME} -c ${CONTAINER_NAME}
kubectl get pod -w</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rolling updates configure the component for interaction with Kafka brokers using OAuth 2.0 authentication.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="con-oauth-server-examples-str"><a class="link" href="#con-oauth-server-examples-str">13.4.7. Authorization server examples</a></h4>
<div class="paragraph">
<p>When choosing an authorization server, consider the features that best support configuration of your chosen authentication flow.</p>
</div>
<div class="paragraph">
<p>For the purposes of testing OAuth 2.0 with Strimzi, Keycloak and ORY Hydra were implemented as the OAuth 2.0 authorization server.</p>
</div>
<div class="paragraph">
<p>For more information, see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://strimzi.io/2019/10/25/kafka-authentication-using-oauth-2.0.html" target="_blank" rel="noopener">Kafka authentication using OAuth 2.0</a></p>
</li>
<li>
<p><a href="https://github.com/strimzi/strimzi-kafka-oauth/tree/0.14.0/examples" target="_blank" rel="noopener">Using Keycloak as the OAuth 2.0 authorization server</a></p>
</li>
<li>
<p><a href="https://github.com/strimzi/strimzi-kafka-oauth/tree/0.14.0/examples/docker#running-with-hydra-using-ssl-and-opaque-tokens" target="_blank" rel="noopener">Using Hydra as the OAuth 2.0 authorization server</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-oauth-authorization_str"><a class="link" href="#assembly-oauth-authorization_str">13.5. Using OAuth 2.0 token-based authorization</a></h3>
<div id="con-oauth-authorization-intro_str" class="paragraph">
<p>If you are using OAuth 2.0 with Keycloak for token-based authentication,
you can also use Keycloak to configure authorization rules to constrain client access to Kafka brokers.
Authentication establishes the identity of a user.
Authorization decides the level of access for that user.</p>
</div>
<div class="paragraph">
<p>Strimzi supports the use of OAuth 2.0 token-based authorization through Keycloak <a href="https://www.keycloak.org/docs/latest/authorization_services/index.html" target="_blank" rel="noopener">Keycloak Authorization Services</a>,
which allows you to manage security policies and permissions centrally.</p>
</div>
<div class="paragraph">
<p>Security policies and permissions defined in Keycloak are used to grant access to resources on Kafka brokers.
Users and clients are matched against policies that permit access to perform specific actions on Kafka brokers.</p>
</div>
<div class="paragraph">
<p>Kafka allows all users full access to brokers by default,
and also provides the <code>AclAuthorizer</code> and <code>StandardAuthorizer</code> plugins to configure authorization based on Access Control Lists (ACLs).
The ACL rules managed by these plugins are used to grant or deny access to resources based on the <em>username</em>, and these rules are stored within the Kafka cluster itself.
However, OAuth 2.0 token-based authorization with Keycloak offers far greater flexibility on how you wish to implement access control to Kafka brokers.
In addition, you can configure your Kafka brokers to use OAuth 2.0 authorization and ACLs.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#assembly-oauth-authentication_str">Using OAuth 2.0 token-based authentication</a></p>
</li>
<li>
<p><a href="#con-securing-kafka-authorization-str">Kafka Authorization</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/documentation.html" target="_blank" rel="noopener">Keycloak documentation</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="con-oauth-authorization-mechanism_str"><a class="link" href="#con-oauth-authorization-mechanism_str">13.5.1. OAuth 2.0 authorization mechanism</a></h4>
<div class="paragraph">
<p>OAuth 2.0 authorization in Strimzi uses Keycloak server Authorization Services REST endpoints to extend token-based authentication with Keycloak by applying defined security policies on a particular user,
and providing a list of permissions granted on different resources for that user.
Policies use roles and groups to match permissions to users.
OAuth 2.0 authorization enforces permissions locally based on the received list of grants for the user from Keycloak Authorization Services.</p>
</div>
<div class="sect4">
<h5 id="kafka_broker_custom_authorizer"><a class="link" href="#kafka_broker_custom_authorizer">Kafka broker custom authorizer</a></h5>
<div class="paragraph">
<p>A Keycloak <em>authorizer</em> (<code>KeycloakAuthorizer</code>) is provided with Strimzi.
To be able to use the Keycloak REST endpoints for Authorization Services provided by Keycloak,
you configure a custom authorizer on the Kafka broker.</p>
</div>
<div class="paragraph">
<p>The authorizer fetches a list of granted permissions from the authorization server as needed,
and enforces authorization locally on the Kafka Broker, making rapid authorization decisions for each client request.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="proc-oauth-authorization-broker-config-str"><a class="link" href="#proc-oauth-authorization-broker-config-str">13.5.2. Configuring OAuth 2.0 authorization support</a></h4>
<div class="paragraph">
<p>This procedure describes how to configure Kafka brokers to use OAuth 2.0 authorization using Keycloak Authorization Services.</p>
</div>
<div class="paragraph">
<div class="title">Before you begin</div>
<p>Consider the access you require or want to limit for certain users.
You can use a combination of Keycloak <em>groups</em>, <em>roles</em>, <em>clients</em>, and <em>users</em> to configure access in Keycloak.</p>
</div>
<div class="paragraph">
<p>Typically, groups are used to match users based on organizational departments or geographical locations.
And roles are used to match users based on their function.</p>
</div>
<div class="paragraph">
<p>With Keycloak, you can store users and groups in LDAP, whereas clients and roles cannot be stored this way.
Storage and access to user data may be a factor in how you choose to configure authorization policies.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<a href="./configuring.html#property-simple-authorization-superusers-reference" target="_blank" rel="noopener">Super users</a> always have unconstrained access to a Kafka broker regardless of the authorization implemented on the Kafka broker.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Strimzi must be configured to use OAuth 2.0 with Keycloak for <a href="#assembly-oauth-authentication_str">token-based authentication</a>.
You use the same Keycloak server endpoint when you set up authorization.</p>
</li>
<li>
<p>OAuth 2.0 authentication must be configured with the <code>maxSecondsWithoutReauthentication</code> option to enable re-authentication.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Access the Keycloak Admin Console or use the Keycloak Admin CLI to enable Authorization Services for the Kafka broker client you created when setting up OAuth 2.0 authentication.</p>
</li>
<li>
<p>Use Authorization Services to define resources, authorization scopes, policies, and permissions for the client.</p>
</li>
<li>
<p>Bind the permissions to users and clients by assigning them roles and groups.</p>
</li>
<li>
<p>Configure the Kafka brokers to use Keycloak authorization by updating the Kafka broker configuration (<code>Kafka.spec.kafka</code>) of your <code>Kafka</code> resource in an editor.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit kafka my-cluster</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the Kafka broker <code>kafka</code> configuration to use <code>keycloak</code> authorization, and to be able to access the authorization server and Authorization Services.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
    authorization:
      type: <strong>keycloak</strong> <b class="conum">(1)</b>
      tokenEndpointUri: &lt;<em>https://&lt;auth-server-address&gt;/auth/realms/external/protocol/openid-connect/token</em>&gt; <b class="conum">(2)</b>
      clientId: kafka <b class="conum">(3)</b>
      delegateToKafkaAcls: false <b class="conum">(4)</b>
      disableTlsHostnameVerification: false <b class="conum">(5)</b>
      superUsers: <b class="conum">(6)</b>
      - CN=fred
      - sam
      - CN=edward
      tlsTrustedCertificates: <b class="conum">(7)</b>
      - secretName: oauth-server-cert
        certificate: ca.crt
      grantsRefreshPeriodSeconds: 60 <b class="conum">(8)</b>
      grantsRefreshPoolSize: 5 <b class="conum">(9)</b>
      grantsMaxIdleSeconds: 300 <b class="conum">(10)</b>
      grantsGcPeriodSeconds: 300 <b class="conum">(11)</b>
      grantsAlwaysLatest: false <b class="conum">(12)</b>
      connectTimeoutSeconds: 60 <b class="conum">(13)</b>
      readTimeoutSeconds: 60 <b class="conum">(14)</b>
      httpRetries: 2 <b class="conum">(15)</b>
      enableMetrics: false <b class="conum">(16)</b>
      includeAcceptHeader: false <b class="conum">(17)</b>
    #...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Type <code>keycloak</code> enables Keycloak authorization.</p>
</li>
<li>
<p>URI of the Keycloak token endpoint. For production, always use <code>https://</code> urls.
When you configure token-based <code>oauth</code> authentication, you specify a <code>jwksEndpointUri</code> as the URI for local JWT validation.
The hostname for the <code>tokenEndpointUri</code> URI must be the same.</p>
</li>
<li>
<p>The client ID of the OAuth 2.0 client definition in Keycloak that has Authorization Services enabled. Typically, <code>kafka</code> is used as the ID.</p>
</li>
<li>
<p>(Optional) Delegate authorization to Kafka <code>AclAuthorizer</code> and <code>StandardAuthorizer</code> if access is denied by Keycloak Authorization Services policies.
Default is <code>false</code>.</p>
</li>
<li>
<p>(Optional) Disable TLS hostname verification. Default is <code>false</code>.</p>
</li>
<li>
<p>(Optional) Designated super users.</p>
</li>
<li>
<p>(Optional) Trusted certificates for TLS connection to the authorization server.</p>
</li>
<li>
<p>(Optional) The time between two consecutive grants refresh runs. That is the maximum time for active sessions to detect any permissions changes for the user on Keycloak. The default value is 60.</p>
</li>
<li>
<p>(Optional) The number of threads to use to refresh (in parallel) the grants for the active sessions. The default value is 5.</p>
</li>
<li>
<p>(Optional) The time, in seconds, after which an idle grant in the cache can be evicted. The default value is 300.</p>
</li>
<li>
<p>(Optional) The time, in seconds, between consecutive runs of a job that cleans stale grants from the cache. The default value is 300.</p>
</li>
<li>
<p>(Optional) Controls whether the latest grants are fetched for a new session. When enabled, grants are retrieved from Keycloak and cached for the user. The default value is <code>false</code>.</p>
</li>
<li>
<p>(Optional) The connect timeout in seconds when connecting to the Keycloak token endpoint. The default value is 60.</p>
</li>
<li>
<p>(Optional) The read timeout in seconds when connecting to the Keycloak token endpoint. The default value is 60.</p>
</li>
<li>
<p>(Optional) The maximum number of times to retry (without pausing) a failed HTTP request to the authorization server. The default value is <code>0</code>, meaning that no retries are performed. To use this option effectively, consider reducing the timeout times for the <code>connectTimeoutSeconds</code> and <code>readTimeoutSeconds</code> options. However, note that retries may prevent the current worker thread from being available to other requests, and if too many requests stall, it could make the Kafka broker unresponsive.</p>
</li>
<li>
<p>(Optional) Enable or disable OAuth metrics. The default value is <code>false</code>.</p>
</li>
<li>
<p>(Optional) Some authorization servers have issues with client sending <code>Accept: application/json</code> header. By setting <code>includeAcceptHeader: false</code> the header will not be sent. Default is <code>true</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Save and exit the editor, then wait for rolling updates to complete.</p>
</li>
<li>
<p>Check the update in the logs or by watching the pod state transitions:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl logs -f ${POD_NAME} -c kafka
kubectl get pod -w</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rolling update configures the brokers to use OAuth 2.0 authorization.</p>
</div>
</li>
<li>
<p>Verify the configured permissions by accessing Kafka brokers as clients or  users with specific roles, making sure they have the necessary access, or do not have the access they are not supposed to have.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="assembly-managing-policies-permissions-keycloak_str"><a class="link" href="#assembly-managing-policies-permissions-keycloak_str">13.5.3. Managing policies and permissions in Keycloak Authorization Services</a></h4>
<div class="paragraph _abstract">
<p>This section describes the authorization models used by Keycloak Authorization Services and Kafka, and defines the important concepts in each model.</p>
</div>
<div class="paragraph">
<p>To grant permissions to access Kafka, you can map Keycloak Authorization Services objects to Kafka resources by creating an <em>OAuth client specification</em> in Keycloak.
Kafka permissions are granted to user accounts or service accounts using Keycloak Authorization Services rules.</p>
</div>
<div class="paragraph">
<p><a href="#ref-example-permissions-for-kafka-operations_authz-model">Examples</a> are shown of the different user permissions required for common Kafka operations, such as creating and listing topics.</p>
</div>
<div class="sect4">
<h5 id="con-kafka-keycloak-authz-models_authz-model"><a class="link" href="#con-kafka-keycloak-authz-models_authz-model">Kafka and Keycloak authorization models overview</a></h5>
<div class="paragraph _abstract">
<p>Kafka and Keycloak Authorization Services use different authorization models.</p>
</div>
<h6 id="kafka_authorization_model" class="discrete">Kafka authorization model</h6>
<div class="paragraph">
<p>Kafka&#8217;s authorization model uses <em>resource types</em>.
When a Kafka client performs an action on a broker, the broker uses the configured <code>KeycloakAuthorizer</code> to check the client&#8217;s permissions, based on the action and resource type.</p>
</div>
<div class="paragraph">
<p>Kafka uses five resource types to control access: <code>Topic</code>, <code>Group</code>, <code>Cluster</code>, <code>TransactionalId</code>, and <code>DelegationToken</code>.
Each resource type has a set of available permissions.</p>
</div>
<div class="paragraph">
<p><strong>Topic</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Create</code></p>
</li>
<li>
<p><code>Write</code></p>
</li>
<li>
<p><code>Read</code></p>
</li>
<li>
<p><code>Delete</code></p>
</li>
<li>
<p><code>Describe</code></p>
</li>
<li>
<p><code>DescribeConfigs</code></p>
</li>
<li>
<p><code>Alter</code></p>
</li>
<li>
<p><code>AlterConfigs</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Group</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Read</code></p>
</li>
<li>
<p><code>Describe</code></p>
</li>
<li>
<p><code>Delete</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Cluster</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Create</code></p>
</li>
<li>
<p><code>Describe</code></p>
</li>
<li>
<p><code>Alter</code></p>
</li>
<li>
<p><code>DescribeConfigs</code></p>
</li>
<li>
<p><code>AlterConfigs</code></p>
</li>
<li>
<p><code>IdempotentWrite</code></p>
</li>
<li>
<p><code>ClusterAction</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>TransactionalId</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Describe</code></p>
</li>
<li>
<p><code>Write</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>DelegationToken</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Describe</code></p>
</li>
</ul>
</div>
<h6 id="keycloak_authorization_services_model" class="discrete">Keycloak Authorization Services model</h6>
<div class="paragraph">
<p>The Keycloak Authorization Services model has four concepts for defining and granting permissions: <em>resources</em>, <em>authorization scopes</em>, <em>policies</em>, and <em>permissions</em>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Resources</dt>
<dd>
<p>A resource is a set of resource definitions that are used to match resources with permitted actions.
A resource might be an individual topic, for example, or all topics with names starting with the same prefix.
A resource definition is associated with a set of available authorization scopes, which represent a set of all actions available on the resource.
Often, only a subset of these actions is actually permitted.</p>
</dd>
<dt class="hdlist1">Authorization scopes</dt>
<dd>
<p>An authorization scope is a set of all the available actions on a specific resource definition.
When you define a new resource, you add scopes from the set of all scopes.</p>
</dd>
<dt class="hdlist1">Policies</dt>
<dd>
<p>A policy is an authorization rule that uses criteria to match against a list of accounts.
Policies can match:</p>
<div class="ulist">
<ul>
<li>
<p><em>Service accounts</em> based on client ID or roles</p>
</li>
<li>
<p><em>User accounts</em> based on username, groups, or roles.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Permissions</dt>
<dd>
<p>A permission grants a subset of authorization scopes on a specific resource definition to a set of users.</p>
</dd>
</dl>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://kafka.apache.org/documentation/#security_authz_primitives">Kafka authorization model</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="con-mapping-keycloak-authz-services-to-kafka-model_authz-model"><a class="link" href="#con-mapping-keycloak-authz-services-to-kafka-model_authz-model">Map Keycloak Authorization Services to the Kafka authorization model</a></h5>
<div class="paragraph _abstract">
<p>The Kafka authorization model is used as a basis for defining the Keycloak roles and resources that will control access to Kafka.</p>
</div>
<div class="paragraph">
<p>To grant Kafka permissions to user accounts or service accounts, you first create an <em>OAuth client specification</em> in Keycloak for the Kafka broker.
You then specify Keycloak Authorization Services rules on the client.
Typically, the client id of the OAuth client that represents the broker is <code>kafka</code>.
The <a href="#proc-oauth-authorization-keycloak-example_str">example configuration files</a> provided with Strimzi use <code>kafka</code> as the OAuth client id.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you have multiple Kafka clusters, you can use a single OAuth client (<code>kafka</code>) for all of them.
This gives you a single, unified space in which to define and manage authorization rules.
However, you can also use different OAuth client ids (for example, <code>my-cluster-kafka</code> or <code>cluster-dev-kafka</code>) and define authorization rules for each cluster within each client configuration.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>kafka</code> client definition must have the <strong>Authorization Enabled</strong> option enabled in the Keycloak Admin Console.</p>
</div>
<div class="paragraph">
<p>All permissions exist within the scope of the <code>kafka</code> client. If you have different Kafka clusters configured with different OAuth client IDs, they each need a separate set of permissions even though they&#8217;re part of the same Keycloak realm.</p>
</div>
<div class="paragraph">
<p>When the Kafka client uses OAUTHBEARER authentication, the Keycloak authorizer (<code>KeycloakAuthorizer</code>) uses the access token of the current session to retrieve a list of grants from the Keycloak server.
To retrieve the grants, the authorizer evaluates the Keycloak Authorization Services policies and permissions.</p>
</div>
<div class="paragraph">
<div class="title">Authorization scopes for Kafka permissions</div>
<p>An initial Keycloak configuration usually involves uploading authorization scopes to create a list of all possible actions that can be performed on each Kafka resource type.
This step is performed once only, before defining any permissions.
You can add authorization scopes manually instead of uploading them.</p>
</div>
<div class="paragraph">
<p>Authorization scopes must contain all the possible Kafka permissions regardless of the resource type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Create</code></p>
</li>
<li>
<p><code>Write</code></p>
</li>
<li>
<p><code>Read</code></p>
</li>
<li>
<p><code>Delete</code></p>
</li>
<li>
<p><code>Describe</code></p>
</li>
<li>
<p><code>Alter</code></p>
</li>
<li>
<p><code>DescribeConfig</code></p>
</li>
<li>
<p><code>AlterConfig</code></p>
</li>
<li>
<p><code>ClusterAction</code></p>
</li>
<li>
<p><code>IdempotentWrite</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you&#8217;re certain you won&#8217;t need a permission (for example, <code>IdempotentWrite</code>), you can omit it from the list of authorization scopes.
However, that permission won&#8217;t be available to target on Kafka resources.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Resource patterns for permissions checks</div>
<p>Resource patterns are used for pattern matching against the targeted resources when performing permission checks.
The general pattern format is <code><em>RESOURCE-TYPE:PATTERN-NAME</em></code>.</p>
</div>
<div class="paragraph">
<p>The resource types mirror the Kafka authorization model.
The pattern allows for two matching options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Exact matching (when the pattern does not end with <code>*</code>)</p>
</li>
<li>
<p>Prefix matching (when the pattern ends with <code>*</code>)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example patterns for resources</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Topic:my-topic
Topic:orders-*
Group:orders-*
Cluster:*</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, the general pattern format can be prefixed by <code>kafka-cluster:<em>CLUSTER-NAME</em></code> followed by a comma, where <em>CLUSTER-NAME</em> refers to the <code>metadata.name</code> in the Kafka custom resource.</p>
</div>
<div class="listingblock">
<div class="title">Example patterns for resources with cluster prefix</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">kafka-cluster:my-cluster,Topic:*
kafka-cluster:*,Group:b_*</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the <code>kafka-cluster</code> prefix is missing, it is assumed to be <code>kafka-cluster:*</code>.</p>
</div>
<div class="paragraph">
<p>When defining a resource, you can associate it with a list of possible authorization scopes which are relevant to the resource.
Set whatever actions make sense for the targeted resource type.</p>
</div>
<div class="paragraph">
<p>Though you may add any authorization scope to any resource, only the scopes supported by the resource type are considered for access control.</p>
</div>
<div class="paragraph">
<div class="title">Policies for applying access permission</div>
<p>Policies are used to target permissions to one or more user accounts or service accounts.
Targeting can refer to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Specific user or service accounts</p>
</li>
<li>
<p>Realm roles or client roles</p>
</li>
<li>
<p>User groups</p>
</li>
<li>
<p>JavaScript rules to match a client IP address</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A policy is given a unique name and can be reused to target multiple permissions to multiple resources.</p>
</div>
<div class="paragraph">
<div class="title">Permissions to grant access</div>
<p>Use fine-grained permissions to pull together the policies, resources, and authorization scopes that grant access to users.</p>
</div>
<div class="paragraph">
<p>The name of each permission should clearly define which permissions it grants to which users.
For example, <code>Dev Team B can read from topics starting with x</code>.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For more information about how to configure permissions through Keycloak Authorization Services, see <a href="#proc-oauth-authorization-keycloak-example_str">Trying Keycloak Authorization Services</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="ref-example-permissions-for-kafka-operations_authz-model"><a class="link" href="#ref-example-permissions-for-kafka-operations_authz-model">Example permissions required for Kafka operations</a></h5>
<div class="paragraph _abstract">
<p>The following examples demonstrate the user permissions required for performing common operations on Kafka.</p>
</div>
<div class="paragraph">
<div class="title">Create a topic</div>
<p>To create a topic, the <code>Create</code> permission is required for the specific topic, or for <code>Cluster:kafka-cluster</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-topics.sh --create --topic my-topic \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">List topics</div>
<p>If a user has the <code>Describe</code> permission on a specified topic, the topic is listed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-topics.sh --list \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Display topic details</div>
<p>To display a topic&#8217;s details, <code>Describe</code> and <code>DescribeConfigs</code> permissions are required on the topic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-topics.sh --describe --topic my-topic \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Produce messages to a topic</div>
<p>To produce messages to a topic, <code>Describe</code> and <code>Write</code> permissions are required on the topic.</p>
</div>
<div class="paragraph">
<p>If the topic hasn&#8217;t been created yet, and topic auto-creation is enabled, the permissions to create a topic are required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh  --topic my-topic \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --producer.config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Consume messages from a topic</div>
<p>To consume messages from a topic, <code>Describe</code> and <code>Read</code> permissions are required on the topic.
Consuming from the topic normally relies on storing the consumer offsets in a consumer group, which requires additional <code>Describe</code> and <code>Read</code> permissions on the consumer group.</p>
</div>
<div class="paragraph">
<p>Two <code>resources</code> are needed for matching. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Topic:my-topic
Group:my-group-*</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-consumer.sh --topic my-topic --group my-group-1 --from-beginning \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --consumer.config /tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Produce messages to a topic using an idempotent producer</div>
<p>As well as the permissions for producing to a topic, an additional <code>IdempotentWrite</code> permission is required on the
<code>Cluster:kafka-cluster</code> resource.</p>
</div>
<div class="paragraph">
<p>Two <code>resources</code> are needed for matching. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Topic:my-topic
Cluster:kafka-cluster</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh  --topic my-topic \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --producer.config=/tmp/config.properties --producer-property enable.idempotence=true --request-required-acks -1</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">List consumer groups</div>
<p>When listing consumer groups, only the groups on which the user has the <code>Describe</code> permissions are returned.
Alternatively, if the user has the <code>Describe</code> permission on the <code>Cluster:kafka-cluster</code>, all the consumer groups are returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-consumer-groups.sh --list \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Display consumer group details</div>
<p>To display a consumer group&#8217;s details, the <code>Describe</code> permission is required on the group and the topics associated with the group.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-consumer-groups.sh --describe --group my-group-1 \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Change topic configuration</div>
<p>To change a topic&#8217;s configuration, the <code>Describe</code> and <code>Alter</code> permissions are required on the topic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-topics.sh --alter --topic my-topic --partitions 2 \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Display Kafka broker configuration</div>
<p>In order to use <code>kafka-configs.sh</code> to get a broker&#8217;s configuration, the <code>DescribeConfigs</code> permission is required on the
<code>Cluster:kafka-cluster</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-configs.sh --entity-type brokers --entity-name 0 --describe --all \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Change Kafka broker configuration</div>
<p>To change a Kafka broker&#8217;s configuration, <code>DescribeConfigs</code> and <code>AlterConfigs</code> permissions are required on <code>Cluster:kafka-cluster</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-configs --entity-type brokers --entity-name 0 --alter --add-config log.cleaner.threads=2 \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Delete a topic</div>
<p>To delete a topic, the <code>Describe</code> and <code>Delete</code> permissions are required on the topic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-topics.sh --delete --topic my-topic \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Select a lead partition</div>
<p>To run leader selection for topic partitions, the <code>Alter</code> permission is required on the <code>Cluster:kafka-cluster</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-leader-election.sh --topic my-topic --partition 0 --election-type PREFERRED  /
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --admin.config /tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Reassign partitions</div>
<p>To generate a partition reassignment file, <code>Describe</code> permissions are required on the topics involved.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-reassign-partitions.sh --topics-to-move-json-file /tmp/topics-to-move.json --broker-list "0,1" --generate \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config /tmp/config.properties &gt; /tmp/partition-reassignment.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>To execute the partition reassignment, <code>Describe</code> and <code>Alter</code> permissions are required on <code>Cluster:kafka-cluster</code>. Also,
<code>Describe</code> permissions are required on the topics involved.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-reassign-partitions.sh --reassignment-json-file /tmp/partition-reassignment.json --execute \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config /tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<p>To verify partition reassignment, <code>Describe</code>, and <code>AlterConfigs</code> permissions are required on <code>Cluster:kafka-cluster</code>, and on each
of the topics involved.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-reassign-partitions.sh --reassignment-json-file /tmp/partition-reassignment.json --verify \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config /tmp/config.properties</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="proc-oauth-authorization-keycloak-example_str"><a class="link" href="#proc-oauth-authorization-keycloak-example_str">13.5.4. Trying Keycloak Authorization Services</a></h4>
<div class="paragraph _abstract">
<p>This example explains how to use Keycloak Authorization Services with <code>keycloak</code> authorization.
Use Keycloak Authorization Services to enforce access restrictions on Kafka clients.
Keycloak Authorization Services use authorization scopes, policies and permissions to define and apply access control to resources.</p>
</div>
<div class="paragraph">
<p>Keycloak Authorization Services REST endpoints provide a list of granted permissions on resources for authenticated users.
The list of grants (permissions) is fetched from the Keycloak server as the first action after an authenticated session is established by the Kafka client.
The list is refreshed in the background so that changes to the grants are detected.
Grants are cached and enforced locally on the Kafka broker for each user session to provide fast authorization decisions.</p>
</div>
<div class="paragraph">
<p>Strimzi provides <a href="#config-examples-str">example configuration files</a>.
These include the following example files for setting up Keycloak:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>kafka-ephemeral-oauth-single-keycloak-authz.yaml</code></dt>
<dd>
<p>An example <code>Kafka</code> custom resource configured for OAuth 2.0 token-based authorization using Keycloak.
You can use the custom resource to deploy a Kafka cluster that uses <code>keycloak</code> authorization and token-based <code>oauth</code> authentication.</p>
</dd>
<dt class="hdlist1"><code>kafka-authz-realm.json</code></dt>
<dd>
<p>An example Keycloak realm configured with sample groups, users, roles and clients.
You can import the realm into a Keycloak instance to set up fine-grained permissions to access Kafka.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If you want to try the example with Keycloak, use these files to perform the tasks outlined in this section in the order shown.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#proc-oauth-authorization-keycloak-example-setup_str">Accessing the Keycloak Admin Console</a></p>
</li>
<li>
<p><a href="#proc-oauth-authorization-keycloak-example-deploy-kafka_str">Deploying a Kafka cluster with Keycloak authorization</a></p>
</li>
<li>
<p><a href="#proc-oauth-authorization-keycloak-example-authentication_str">Preparing TLS connectivity for a CLI Kafka client session</a></p>
</li>
<li>
<p><a href="#proc-oauth-authorization-keycloak-example-check_str">Checking authorized access to Kafka using a CLI Kafka client session</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Authentication</div>
<p>When you configure token-based <code>oauth</code> authentication, you specify a <code>jwksEndpointUri</code> as the URI for local JWT validation.
When you configure <code>keycloak</code> authorization, you specify a <code>tokenEndpointUri</code> as the URI of the Keycloak token endpoint.
The hostname for both URIs must be the same.</p>
</div>
<div class="paragraph">
<div class="title">Targeted permissions with group or role policies</div>
<p>In Keycloak, confidential clients with service accounts enabled can authenticate to the server in their own name using a client ID and a secret.
This is convenient for microservices that typically act in their own name, and not as agents of a particular user (like a web site).
Service accounts can have roles assigned like regular users.
They cannot, however, have groups assigned.
As a consequence, if you want to target permissions to microservices using service accounts, you cannot use group policies, and should instead use role policies.
Conversely, if you want to limit certain permissions only to regular user accounts where authentication with a username and password is required, you can achieve that as a side effect of using the group policies rather than the role policies.
This is what is used in this example for permissions that start with <code>ClusterManager</code>.
Performing cluster management is usually done interactively using CLI tools.
It makes sense to require the user to log in before using the resulting access token to authenticate to the Kafka broker.
In this case, the access token represents the specific user, rather than the client application.</p>
</div>
<div class="sect4">
<h5 id="proc-oauth-authorization-keycloak-example-setup_str"><a class="link" href="#proc-oauth-authorization-keycloak-example-setup_str">Accessing the Keycloak Admin Console</a></h5>
<div class="paragraph">
<p>Set up Keycloak, then connect to its Admin Console and add the preconfigured realm.
Use the example <code>kafka-authz-realm.json</code> file to import the realm.
You can check the authorization rules defined for the realm in the Admin Console.
The rules grant access to the resources on the Kafka cluster configured to use the example Keycloak realm.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A running Kubernetes cluster.</p>
</li>
<li>
<p>The Strimzi <code>examples/security/keycloak-authorization/kafka-authz-realm.json</code> file that contains the preconfigured realm.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Install the Keycloak server using the Keycloak Operator as described in <a href="https://www.keycloak.org/operator/installation" target="_blank" rel="noopener">Installing the Keycloak Operator</a> in the Keycloak documentation.</p>
</li>
<li>
<p>Wait until the Keycloak instance is running.</p>
</li>
<li>
<p>Get the external hostname to be able to access the Admin Console.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NS=sso
kubectl get ingress keycloak -n $NS</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, we assume the Keycloak server is running in the <code>sso</code> namespace.</p>
</div>
</li>
<li>
<p>Get the password for the <code>admin</code> user.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get -n $NS pod keycloak-0 -o yaml | less</code></pre>
</div>
</div>
<div class="paragraph">
<p>The password is stored as a secret, so get the configuration YAML file for the Keycloak instance to identify the name of the secret (<code>secretKeyRef.name</code>).</p>
</div>
</li>
<li>
<p>Use the name of the secret to obtain the clear text password.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">SECRET_NAME=credential-keycloak
kubectl get -n $NS secret $SECRET_NAME -o yaml | grep PASSWORD | awk '{print $2}' | base64 -D</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, we assume the name of the secret is <code>credential-keycloak</code>.</p>
</div>
</li>
<li>
<p>Log in to the Admin Console with the username <code>admin</code> and the password you obtained.</p>
<div class="paragraph">
<p>Use <code>https://<em>HOSTNAME</em></code> to access the Kubernetes <code>Ingress</code>.</p>
</div>
<div class="paragraph">
<p>You can now upload the example realm to Keycloak using the Admin Console.</p>
</div>
</li>
<li>
<p>Click <strong>Add Realm</strong> to import the example realm.</p>
</li>
<li>
<p>Add the <code>examples/security/keycloak-authorization/kafka-authz-realm.json</code> file, and then click <strong>Create</strong>.</p>
<div class="paragraph">
<p>You now have <code>kafka-authz</code> as your current realm in the Admin Console.</p>
</div>
<div class="paragraph">
<p>The default view displays the <strong>Master</strong> realm.</p>
</div>
</li>
<li>
<p>In the Keycloak Admin Console, go to <strong>Clients</strong> &gt; <strong>kafka</strong> &gt; <strong>Authorization</strong> &gt; <strong>Settings</strong> and check that <strong>Decision Strategy</strong> is set to <strong>Affirmative</strong>.</p>
<div class="paragraph">
<p>An affirmative policy means that at least one policy must be satisfied for a client to access the Kafka cluster.</p>
</div>
</li>
<li>
<p>In the Keycloak Admin Console, go to <strong>Groups</strong>, <strong>Users</strong>, <strong>Roles</strong> and <strong>Clients</strong> to view the realm configuration.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Groups</dt>
<dd>
<p><code>Groups</code> are used to create user groups and set user permissions. Groups are sets of users with a name assigned. They are used to compartmentalize users into geographical, organizational or departmental units.
Groups can be linked to an LDAP identity provider. You can make a user a member of a group through a custom LDAP server admin user interface, for example, to grant permissions on Kafka resources.</p>
</dd>
<dt class="hdlist1">Users</dt>
<dd>
<p><code>Users</code> are used to create users. For this example, <code>alice</code> and <code>bob</code> are defined. <code>alice</code> is a member of the <code>ClusterManager</code> group and <code>bob</code> is a member of <code>ClusterManager-my-cluster</code> group.
Users can be stored in an LDAP identity provider.</p>
</dd>
<dt class="hdlist1">Roles</dt>
<dd>
<p><code>Roles</code> mark users or clients as having certain permissions.
Roles are a concept analogous to groups. They are usually used to <em>tag</em> users with organizational roles and have the requisite permissions.
Roles cannot be stored in an LDAP identity provider.
If LDAP is a requirement, you can use groups instead, and add Keycloak roles to the groups so that when users are assigned a group they also get a corresponding role.</p>
</dd>
<dt class="hdlist1">Clients</dt>
<dd>
<p><code>Clients</code> can have specific configurations. For this example, <code>kafka</code>, <code>kafka-cli</code>, <code>team-a-client</code>, and <code>team-b-client</code> clients are configured.</p>
<div class="ulist">
<ul>
<li>
<p>The <code>kafka</code> client is used by Kafka brokers to perform the necessary OAuth 2.0 communication for access token validation.
This client also contains the authorization services resource definitions, policies, and authorization scopes used to perform authorization on the Kafka brokers.
The authorization configuration is defined in the <code>kafka</code> client from the <strong>Authorization</strong> tab, which becomes visible when <strong>Authorization Enabled</strong> is switched on from the <strong>Settings</strong> tab.</p>
</li>
<li>
<p>The <code>kafka-cli</code> client is a public client that is used by the Kafka command line tools when authenticating with username and password to obtain an access token or a refresh token.</p>
</li>
<li>
<p>The <code>team-a-client</code> and <code>team-b-client</code> clients are confidential clients representing services with partial access to certain Kafka topics.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</li>
<li>
<p>In the Keycloak Admin Console, go to <strong>Authorization</strong> &gt; <strong>Permissions</strong> to see the granted permissions that use the resources and policies defined for the realm.</p>
<div class="paragraph">
<p>For example, the <code>kafka</code> client has the following permissions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Dev Team A can write to topics that start with x_ on any cluster
Dev Team B can read from topics that start with x_ on any cluster
Dev Team B can update consumer group offsets that start with x_ on any cluster
ClusterManager of my-cluster Group has full access to cluster config on my-cluster
ClusterManager of my-cluster Group has full access to consumer groups on my-cluster
ClusterManager of my-cluster Group has full access to topics on my-cluster</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Dev Team A</dt>
<dd>
<p>The Dev Team A realm role can write to topics that start with <code>x_</code> on any cluster. This combines a resource called <code>Topic:x_*</code>, <code>Describe</code> and <code>Write</code> scopes, and the <code>Dev Team A</code> policy. The <code>Dev Team A</code> policy matches all users that have a realm role called <code>Dev Team A</code>.</p>
</dd>
<dt class="hdlist1">Dev Team B</dt>
<dd>
<p>The Dev Team B realm role can read from topics that start with <code>x_</code> on any cluster. This combines <code>Topic:x_*</code>, <code>Group:x_*</code> resources, <code>Describe</code> and <code>Read</code> scopes, and the <code>Dev Team B</code> policy. The <code>Dev Team B</code> policy matches all users that have a realm role called <code>Dev Team B</code>. Matching users and clients have the ability to read from topics, and update the consumed offsets for topics and consumer groups that have names starting with <code>x_</code>.</p>
</dd>
</dl>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="proc-oauth-authorization-keycloak-example-deploy-kafka_str"><a class="link" href="#proc-oauth-authorization-keycloak-example-deploy-kafka_str">Deploying a Kafka cluster with Keycloak authorization</a></h5>
<div class="paragraph">
<p>Deploy a Kafka cluster configured to connect to the Keycloak server.
Use the example <code>kafka-ephemeral-oauth-single-keycloak-authz.yaml</code> file to deploy the Kafka cluster as a <code>Kafka</code> custom resource.
The example deploys a single-node Kafka cluster with <code>keycloak</code> authorization and <code>oauth</code> authentication.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Keycloak authorization server is deployed to your Kubernetes cluster and loaded with the example realm.</p>
</li>
<li>
<p>The Cluster Operator is deployed to your Kubernetes cluster.</p>
</li>
<li>
<p>The Strimzi <code>examples/security/keycloak-authorization/kafka-ephemeral-oauth-single-keycloak-authz.yaml</code> custom resource.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Use the hostname of the Keycloak instance you deployed to prepare a truststore certificate for Kafka brokers to communicate with the Keycloak server.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">SSO_HOST=<em>SSO-HOSTNAME</em>
SSO_HOST_PORT=$SSO_HOST:443
STOREPASS=storepass

echo "Q" | openssl s_client -showcerts -connect $SSO_HOST_PORT 2&gt;/dev/null | awk ' /BEGIN CERTIFICATE/,/END CERTIFICATE/ { print $0 } ' &gt; /tmp/sso.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>The certificate is required as Kubernetes <code>Ingress</code> is used to make a secure (HTTPS) connection.</p>
</div>
<div class="paragraph">
<p>Usually there is not one single certificate, but a certificate chain. You only have to provide the top-most issuer CA, which is listed last in the <code>/tmp/sso.pem</code> file.
You can extract it manually or using the following commands:</p>
</div>
<div class="listingblock">
<div class="title">Example command to extract the top CA certificate in a certificate chain</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">split -p "-----BEGIN CERTIFICATE-----" sso.pem sso-
for f in $(ls sso-*); do mv $f $f.pem; done
cp $(ls sso-* | sort -r | head -n 1) sso-ca.crt</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
A trusted CA certificate is normally obtained from a trusted source, and not by using the <code>openssl</code> command.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Deploy the certificate to Kubernetes as a secret.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create secret generic oauth-server-cert --from-file=/tmp/sso-ca.crt -n $NS</code></pre>
</div>
</div>
</li>
<li>
<p>Set the hostname as an environment variable</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">SSO_HOST=<em>SSO-HOSTNAME</em></code></pre>
</div>
</div>
</li>
<li>
<p>Create and deploy the example Kafka cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat examples/security/keycloak-authorization/kafka-ephemeral-oauth-single-keycloak-authz.yaml | sed -E 's#\${SSO_HOST}'"#$SSO_HOST#" | kubectl create -n $NS -f -</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="proc-oauth-authorization-keycloak-example-authentication_str"><a class="link" href="#proc-oauth-authorization-keycloak-example-authentication_str">Preparing TLS connectivity for a CLI Kafka client session</a></h5>
<div class="paragraph">
<p>Create a new pod for an interactive CLI session.
Set up a truststore with a Keycloak certificate for TLS connectivity.
The truststore is to connect to Keycloak and the Kafka broker.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Keycloak authorization server is deployed to your Kubernetes cluster and loaded with the example realm.</p>
<div class="paragraph">
<p>In the Keycloak Admin Console, check the roles assigned to the clients are displayed in <strong>Clients</strong> &gt; <strong>Service Account Roles</strong>.</p>
</div>
</li>
<li>
<p>The Kafka cluster configured to connect with Keycloak is deployed to your Kubernetes cluster.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Run a new interactive pod container using the Strimzi Kafka image to connect to a running Kafka broker.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NS=sso
kubectl run -ti --restart=Never --image=quay.io/strimzi/kafka:0.39.0-kafka-3.6.1 kafka-cli -n $NS -- /bin/sh</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If <code>kubectl</code> times out waiting on the image download, subsequent attempts may result in an <em>AlreadyExists</em> error.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Attach to the pod container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl attach -ti kafka-cli -n $NS</code></pre>
</div>
</div>
</li>
<li>
<p>Use the hostname of the Keycloak instance to prepare a certificate for client connection using TLS.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">SSO_HOST=<em>SSO-HOSTNAME</em>
SSO_HOST_PORT=$SSO_HOST:443
STOREPASS=storepass

echo "Q" | openssl s_client -showcerts -connect $SSO_HOST_PORT 2&gt;/dev/null | awk ' /BEGIN CERTIFICATE/,/END CERTIFICATE/ { print $0 } ' &gt; /tmp/sso.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>Usually there is not one single certificate, but a certificate chain. You only have to provide the top-most issuer CA, which is listed last in the <code>/tmp/sso.pem</code> file.
You can extract it manually or using the following command:</p>
</div>
<div class="listingblock">
<div class="title">Example command to extract the top CA certificate in a certificate chain</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">split -p "-----BEGIN CERTIFICATE-----" sso.pem sso-
for f in $(ls sso-*); do mv $f $f.pem; done
cp $(ls sso-* | sort -r | head -n 1) sso-ca.crt</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
A trusted CA certificate is normally obtained from a trusted source, and not by using the <code>openssl</code> command.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create a truststore for TLS connection to the Kafka brokers.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">keytool -keystore /tmp/truststore.p12 -storetype pkcs12 -alias sso -storepass $STOREPASS -import -file /tmp/sso-ca.crt -noprompt</code></pre>
</div>
</div>
</li>
<li>
<p>Use the Kafka bootstrap address as the hostname of the Kafka broker and the <code>tls</code> listener port (9093) to prepare a certificate for the Kafka broker.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">KAFKA_HOST_PORT=my-cluster-kafka-bootstrap:9093
STOREPASS=storepass

echo "Q" | openssl s_client -showcerts -connect $KAFKA_HOST_PORT 2&gt;/dev/null | awk ' /BEGIN CERTIFICATE/,/END CERTIFICATE/ { print $0 } ' &gt; /tmp/my-cluster-kafka.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>The obtained <code>.pem</code> file is usually not one single certificate, but a certificate chain. You only have to provide the top-most issuer CA, which is listed last in the <code>/tmp/my-cluster-kafka.pem</code> file.
You can extract it manually or using the following command:</p>
</div>
<div class="listingblock">
<div class="title">Example command to extract the top CA certificate in a certificate chain</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">split -p "-----BEGIN CERTIFICATE-----" /tmp/my-cluster-kafka.pem kafka-
for f in $(ls kafka-*); do mv $f $f.pem; done
cp $(ls kafka-* | sort -r | head -n 1) my-cluster-kafka-ca.crt</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
A trusted CA certificate is normally obtained from a trusted source, and not by using the <code>openssl</code> command.
      For this example we assume the client is running in a pod in the same namespace where the Kafka cluster was deployed.
      If the client is accessing the Kafka cluster from outside the Kubernetes cluster, you would have to first determine the bootstrap address.
      In that case you can also get the cluster certificate directly from the Kubernetes secret, and there is no need for <code>openssl</code>.
      For more information, see <a href="#deploy-client-access-str">Setting up client access to a Kafka cluster</a>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Add the certificate for the Kafka broker to the truststore.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">keytool -keystore /tmp/truststore.p12 -storetype pkcs12 -alias my-cluster-kafka -storepass $STOREPASS -import -file /tmp/my-cluster-kafka-ca.crt -noprompt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Keep the session open to check authorized access.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="proc-oauth-authorization-keycloak-example-check_str"><a class="link" href="#proc-oauth-authorization-keycloak-example-check_str">Checking authorized access to Kafka using a CLI Kafka client session</a></h5>
<div class="paragraph">
<p>Check the authorization rules applied through the Keycloak realm using an interactive CLI session.
Apply the checks using Kafka&#8217;s example producer and consumer clients to create topics with user and service accounts that have different levels of access.</p>
</div>
<div class="paragraph">
<p>Use the <code>team-a-client</code> and <code>team-b-client</code> clients to check the authorization rules.
Use the <code>alice</code> admin user to perform additional administrative tasks on Kafka.</p>
</div>
<div class="paragraph">
<p>The Strimzi Kafka image used in this example contains Kafka producer and consumer binaries.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>ZooKeeper and Kafka are running in the Kubernetes cluster to be able to send and receive messages.</p>
</li>
<li>
<p>The <a href="#proc-oauth-authorization-keycloak-example-authentication_str">interactive CLI Kafka client session</a> is started.</p>
<div class="paragraph">
<p><a href="http://kafka.apache.org/" target="_blank" rel="noopener">Apache Kafka download</a>.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Setting up client and admin user configuration</div>
<ol class="arabic">
<li>
<p>Prepare a Kafka configuration file with authentication properties for the <code>team-a-client</code> client.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">SSO_HOST=<em>SSO-HOSTNAME</em>

cat &gt; /tmp/team-a-client.properties &lt;&lt; EOF
security.protocol=SASL_SSL
ssl.truststore.location=/tmp/truststore.p12
ssl.truststore.password=$STOREPASS
ssl.truststore.type=PKCS12
sasl.mechanism=OAUTHBEARER
sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required \
  oauth.client.id="team-a-client" \
  oauth.client.secret="team-a-client-secret" \
  oauth.ssl.truststore.location="/tmp/truststore.p12" \
  oauth.ssl.truststore.password="$STOREPASS" \
  oauth.ssl.truststore.type="PKCS12" \
  oauth.token.endpoint.uri="https://$SSO_HOST/auth/realms/kafka-authz/protocol/openid-connect/token" ;
sasl.login.callback.handler.class=io.strimzi.kafka.oauth.client.JaasClientOauthLoginCallbackHandler
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>The SASL OAUTHBEARER mechanism is used.
This mechanism requires a client ID and client secret, which means the client first connects to the Keycloak server to obtain an access token.
The client then connects to the Kafka broker and uses the access token to authenticate.</p>
</div>
</li>
<li>
<p>Prepare a Kafka configuration file with authentication properties for the <code>team-b-client</code> client.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat &gt; /tmp/team-b-client.properties &lt;&lt; EOF
security.protocol=SASL_SSL
ssl.truststore.location=/tmp/truststore.p12
ssl.truststore.password=$STOREPASS
ssl.truststore.type=PKCS12
sasl.mechanism=OAUTHBEARER
sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required \
  oauth.client.id="team-b-client" \
  oauth.client.secret="team-b-client-secret" \
  oauth.ssl.truststore.location="/tmp/truststore.p12" \
  oauth.ssl.truststore.password="$STOREPASS" \
  oauth.ssl.truststore.type="PKCS12" \
  oauth.token.endpoint.uri="https://$SSO_HOST/auth/realms/kafka-authz/protocol/openid-connect/token" ;
sasl.login.callback.handler.class=io.strimzi.kafka.oauth.client.JaasClientOauthLoginCallbackHandler
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Authenticate admin user <code>alice</code> by using <code>curl</code> and performing a password grant authentication to obtain a refresh token.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">USERNAME=alice
PASSWORD=alice-password

GRANT_RESPONSE=$(curl -X POST "https://$SSO_HOST/auth/realms/kafka-authz/protocol/openid-connect/token" -H 'Content-Type: application/x-www-form-urlencoded' -d "grant_type=password&amp;username=$USERNAME&amp;password=$PASSWORD&amp;client_id=kafka-cli&amp;scope=offline_access" -s -k)

REFRESH_TOKEN=$(echo $GRANT_RESPONSE | awk -F "refresh_token\":\"" '{printf $2}' | awk -F "\"" '{printf $1}')</code></pre>
</div>
</div>
<div class="paragraph">
<p>The refresh token is an offline token that is long-lived and does not expire.</p>
</div>
</li>
<li>
<p>Prepare a Kafka configuration file with authentication properties for the admin user <code>alice</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat &gt; /tmp/alice.properties &lt;&lt; EOF
security.protocol=SASL_SSL
ssl.truststore.location=/tmp/truststore.p12
ssl.truststore.password=$STOREPASS
ssl.truststore.type=PKCS12
sasl.mechanism=OAUTHBEARER
sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required \
  oauth.refresh.token="$REFRESH_TOKEN" \
  oauth.client.id="kafka-cli" \
  oauth.ssl.truststore.location="/tmp/truststore.p12" \
  oauth.ssl.truststore.password="$STOREPASS" \
  oauth.ssl.truststore.type="PKCS12" \
  oauth.token.endpoint.uri="https://$SSO_HOST/auth/realms/kafka-authz/protocol/openid-connect/token" ;
sasl.login.callback.handler.class=io.strimzi.kafka.oauth.client.JaasClientOauthLoginCallbackHandler
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>kafka-cli</code> public client is used for the <code>oauth.client.id</code> in the <code>sasl.jaas.config</code>.
Since it&#8217;s a public client it does not require a secret.
The client authenticates with the refresh token that was authenticated in the previous step.
The refresh token requests an access token behind the scenes, which is then sent to the Kafka broker for authentication.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Producing messages with authorized access</div>
<p>Use the <code>team-a-client</code> configuration to check that you can produce messages to topics that start with <code>a_</code> or <code>x_</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Write to topic <code>my-topic</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic my-topic \
  --producer.config=/tmp/team-a-client.properties
First message</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request returns a <code>Not authorized to access topics: [my-topic]</code> error.</p>
</div>
<div class="paragraph">
<p><code>team-a-client</code> has a <code>Dev Team A</code> role that gives it permission to perform any supported actions on topics that start with <code>a_</code>, but can only write to topics that start with <code>x_</code>.
The topic named <code>my-topic</code> matches neither of those rules.</p>
</div>
</li>
<li>
<p>Write to topic <code>a_messages</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic a_messages \
  --producer.config /tmp/team-a-client.properties
First message
Second message</code></pre>
</div>
</div>
<div class="paragraph">
<p>Messages are produced to Kafka successfully.</p>
</div>
</li>
<li>
<p>Press CTRL+C to exit the CLI application.</p>
</li>
<li>
<p>Check the Kafka container log for a debug log of <code>Authorization GRANTED</code> for the request.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl logs my-cluster-kafka-0 -f -n $NS</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Consuming messages with authorized access</div>
<p>Use the <code>team-a-client</code> configuration to consume messages from topic <code>a_messages</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Fetch messages from topic <code>a_messages</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-consumer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic a_messages \
  --from-beginning --consumer.config /tmp/team-a-client.properties</code></pre>
</div>
</div>
<div class="paragraph">
<p>The request returns an error because the <code>Dev Team A</code> role for <code>team-a-client</code> only has access to consumer groups that have names starting with <code>a_</code>.</p>
</div>
</li>
<li>
<p>Update the <code>team-a-client</code> properties to specify the custom consumer group it is permitted to use.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-consumer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic a_messages \
  --from-beginning --consumer.config /tmp/team-a-client.properties --group a_consumer_group_1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The consumer receives all the messages from the <code>a_messages</code> topic.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Administering Kafka with authorized access</div>
<p>The <code>team-a-client</code> is an account without any cluster-level access, but it can be used with some administrative operations.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>List topics.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-topics.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --command-config /tmp/team-a-client.properties --list</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>a_messages</code> topic is returned.</p>
</div>
</li>
<li>
<p>List consumer groups.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-consumer-groups.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --command-config /tmp/team-a-client.properties --list</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>a_consumer_group_1</code> consumer group is returned.</p>
</div>
<div class="paragraph">
<p>Fetch details on the cluster configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-configs.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --command-config /tmp/team-a-client.properties \
  --entity-type brokers --describe --entity-default</code></pre>
</div>
</div>
<div class="paragraph">
<p>The request returns an error because the operation requires cluster level permissions that <code>team-a-client</code> does not have.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Using clients with different permissions</div>
<p>Use the <code>team-b-client</code> configuration to produce messages to topics that start with <code>b_</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Write to topic <code>a_messages</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic a_messages \
  --producer.config /tmp/team-b-client.properties
Message 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request returns a <code>Not authorized to access topics: [a_messages]</code> error.</p>
</div>
</li>
<li>
<p>Write to topic <code>b_messages</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic b_messages \
  --producer.config /tmp/team-b-client.properties
Message 1
Message 2
Message 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Messages are produced to Kafka successfully.</p>
</div>
</li>
<li>
<p>Write to topic <code>x_messages</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic x_messages \
  --producer.config /tmp/team-b-client.properties
Message 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>Not authorized to access topics: [x_messages]</code> error is returned,
The <code>team-b-client</code> can only read from topic <code>x_messages</code>.</p>
</div>
</li>
<li>
<p>Write to topic <code>x_messages</code> using <code>team-a-client</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic x_messages \
  --producer.config /tmp/team-a-client.properties
Message 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request returns a <code>Not authorized to access topics: [x_messages]</code> error.
The <code>team-a-client</code> can write to the <code>x_messages</code> topic, but it does not have a permission to create a topic if it does not yet exist.
Before <code>team-a-client</code> can write to the <code>x_messages</code> topic, an admin <em>power user</em> must create it with the correct configuration, such as the number of partitions and replicas.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Managing Kafka with an authorized admin user</div>
<p>Use admin user <code>alice</code> to manage Kafka.
<code>alice</code> has full access to manage everything on any Kafka cluster.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the <code>x_messages</code> topic as <code>alice</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-topics.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --command-config /tmp/alice.properties \
  --topic x_messages --create --replication-factor 1 --partitions 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The topic is created successfully.</p>
</div>
</li>
<li>
<p>List all topics as <code>alice</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-topics.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --command-config /tmp/alice.properties --list
bin/kafka-topics.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --command-config /tmp/team-a-client.properties --list
bin/kafka-topics.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --command-config /tmp/team-b-client.properties --list</code></pre>
</div>
</div>
<div class="paragraph">
<p>Admin user <code>alice</code> can list all the topics, whereas <code>team-a-client</code> and <code>team-b-client</code> can only list the topics they have access to.</p>
</div>
<div class="paragraph">
<p>The <code>Dev Team A</code> and <code>Dev Team B</code> roles both have <code>Describe</code> permission on topics that start with <code>x_</code>, but they cannot see the other team&#8217;s topics because they do not have <code>Describe</code> permissions on them.</p>
</div>
</li>
<li>
<p>Use the <code>team-a-client</code> to produce messages to the <code>x_messages</code> topic:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic x_messages \
  --producer.config /tmp/team-a-client.properties
Message 1
Message 2
Message 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>As <code>alice</code> created the <code>x_messages</code> topic, messages are produced to Kafka successfully.</p>
</div>
</li>
<li>
<p>Use the <code>team-b-client</code> to produce messages to the <code>x_messages</code> topic.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic x_messages \
  --producer.config /tmp/team-b-client.properties
Message 4
Message 5</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request returns a <code>Not authorized to access topics: [x_messages]</code> error.</p>
</div>
</li>
<li>
<p>Use the <code>team-b-client</code> to consume messages from the <code>x_messages</code> topic:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-consumer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic x_messages \
  --from-beginning --consumer.config /tmp/team-b-client.properties --group x_consumer_group_b</code></pre>
</div>
</div>
<div class="paragraph">
<p>The consumer receives all the messages from the <code>x_messages</code> topic.</p>
</div>
</li>
<li>
<p>Use the <code>team-a-client</code> to consume messages from the <code>x_messages</code> topic.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-consumer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic x_messages \
  --from-beginning --consumer.config /tmp/team-a-client.properties --group x_consumer_group_a</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request returns a <code>Not authorized to access topics: [x_messages]</code> error.</p>
</div>
</li>
<li>
<p>Use the <code>team-a-client</code> to consume messages from a consumer group that begins with <code>a_</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-consumer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic x_messages \
  --from-beginning --consumer.config /tmp/team-a-client.properties --group a_consumer_group_a</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request returns a <code>Not authorized to access topics: [x_messages]</code> error.</p>
</div>
<div class="paragraph">
<p><code>Dev Team A</code> has no <code>Read</code> access on topics that start with a <code>x_</code>.</p>
</div>
</li>
<li>
<p>Use <code>alice</code> to produce messages to the <code>x_messages</code> topic.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-consumer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic x_messages \
  --from-beginning --consumer.config /tmp/alice.properties</code></pre>
</div>
</div>
<div class="paragraph">
<p>Messages are produced to Kafka successfully.</p>
</div>
<div class="paragraph">
<p><code>alice</code> can read from or write to any topic.</p>
</div>
</li>
<li>
<p>Use <code>alice</code> to read the cluster configuration.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-configs.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --command-config /tmp/alice.properties \
  --entity-type brokers --describe --entity-default</code></pre>
</div>
</div>
<div class="paragraph">
<p>The cluster configuration for this example is empty.</p>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://www.keycloak.org/operator/installation" target="_blank" rel="noopener">Installing the Keycloak Operator</a></p>
</li>
<li>
<p><a href="#con-mapping-keycloak-authz-services-to-kafka-model_authz-model">Map Keycloak Authorization Services to the Kafka authorization model</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="security-str"><a class="link" href="#security-str">14. Managing TLS certificates</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Strimzi supports TLS for encrypted communication between Kafka and Strimzi components.</p>
</div>
<div class="paragraph">
<p>Strimzi establishes encrypted TLS connections for communication between the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kafka brokers and ZooKeeper nodes</p>
</li>
<li>
<p>Kafka brokers (interbroker communication)</p>
</li>
<li>
<p>ZooKeeper nodes (internodal communication)</p>
</li>
<li>
<p>Strimzi operators and Kafka and ZooKeeper</p>
</li>
<li>
<p>Cruise Control and Kafka</p>
</li>
<li>
<p>Kafka Exporter and Kafka</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Connections between clients and brokers use listeners that you must configure to use TLS-encrypted communication.
You configure these listeners in the <code>Kafka</code> custom resource and each listener name and port number must be unique within the cluster.
Communication between Kafka brokers and Kafka clients is encrypted according to how the <code>tls</code> property is configured for the listener.
For more information, see <a href="#deploy-client-access-str">Setting up client access to a Kafka cluster</a>.</p>
</div>
<div class="paragraph">
<p>The following diagram shows the connections for secure communication.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/secure_communication.png" alt="Secure Communication">
</div>
<div class="title">Figure 4. Kafka and ZooKeeper communication secured by TLS encryption</div>
</div>
<div class="paragraph">
<p>The ports shown in the diagram are used as follows:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Control plane listener (9090)</dt>
<dd>
<p>Connections between the Kafka controller and brokers use an internal control plane listener on port 9090, facilitating interbroker communication.
This listener is not accessible to Kafka clients.</p>
</dd>
<dt class="hdlist1">Replication listener (9091)</dt>
<dd>
<p>Data replication between brokers, as well as internal connections from Strimzi operators, Cruise Control, and the Kafka Exporter, use the replication listener on port 9091.
This listener is not accessible to Kafka clients.</p>
</dd>
<dt class="hdlist1">Listeners for client connections (9092 or higher)</dt>
<dd>
<p>For TLS-encrypted communication (through configuration of the listener), internal and external clients connect to Kafka brokers.
External clients (producers and consumers) connect to the Kafka brokers through the advertised listener port.</p>
</dd>
<dt class="hdlist1">ZooKeeper Port (2181)</dt>
<dd>
<p>ZooKeeper port for connection to Kafka.</p>
</dd>
<dt class="hdlist1">ZooKeeper internodal communication port (2888)</dt>
<dd>
<p>ZooKeeper port for internodal communication between ZooKeeper nodes.</p>
</dd>
<dt class="hdlist1">ZooKeeper leader election port (3888)</dt>
<dd>
<p>ZooKeeper port for leader election among ZooKeeper nodes in a ZooKeeper cluster.</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
When configuring listeners for client access to brokers, you can use port 9092 or higher (9093, 9094, and so on), but with a few exceptions.
The listeners cannot be configured to use the ports reserved for interbroker communication (9090 and 9091), Prometheus metrics (9404), and JMX (Java Management Extensions) monitoring (9999).
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="certificate-authorities-str"><a class="link" href="#certificate-authorities-str">14.1. Internal cluster CA and clients CA</a></h3>
<div class="paragraph _abstract">
<p>To support encryption, each Strimzi component needs its own private keys and public key certificates.
All component certificates are signed by an internal CA (certificate authority) called the <em>cluster CA</em>.</p>
</div>
<div class="paragraph">
<p>CA (Certificate Authority) certificates are generated by the Cluster Operator to verify the identities of components and clients.</p>
</div>
<div class="paragraph">
<p>Similarly, each Kafka client application connecting to Strimzi using mTLS needs to use private keys and certificates.
A second internal CA, named the <em>clients CA</em>, is used to sign certificates for the Kafka clients.</p>
</div>
<div class="paragraph">
<p>Both the cluster CA and clients CA have a self-signed public key certificate.</p>
</div>
<div class="paragraph">
<p>Kafka brokers are configured to trust certificates signed by either the cluster CA or clients CA.
Components that clients do not need to connect to, such as ZooKeeper, only trust certificates signed by the cluster CA.
Unless TLS encryption for external listeners is disabled, client applications must trust certificates signed by the cluster CA.
This is also true for client applications that perform mTLS authentication.</p>
</div>
<div class="paragraph">
<p>By default, Strimzi automatically generates and renews CA certificates issued by the cluster CA or clients CA.
You can configure the management of these CA certificates using <code>Kafka.spec.clusterCa</code> and <code>Kafka.spec.clientsCa</code> properties.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you don&#8217;t want to use the CAs generated by the Cluster Operator, you can <a href="#installing-your-own-ca-certificates-str">install your own cluster and clients CA certificates</a>.
Any certificates you provide are not renewed by the Cluster Operator.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="certificates-and-secrets-str"><a class="link" href="#certificates-and-secrets-str">14.2. Secrets generated by the operators</a></h3>
<div class="paragraph _abstract">
<p>The Cluster Operator automatically sets up and renews TLS certificates to enable encryption and authentication within a cluster.
It also sets up other TLS certificates if you want to enable encryption or mTLS authentication between Kafka brokers and clients.</p>
</div>
<div class="paragraph">
<p>Secrets are created when custom resources are deployed, such as <code>Kafka</code> and <code>KafkaUser</code>.
Strimzi uses these secrets to store private and public key certificates for Kafka clusters, clients, and users.
The secrets are used for establishing TLS encrypted connections between Kafka brokers, and between brokers and clients.
They are also used for mTLS authentication.</p>
</div>
<div class="paragraph">
<p>Cluster and clients secrets are always pairs: one contains the public key and one contains the private key.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Cluster secret</dt>
<dd>
<p>A cluster secret contains the <em>cluster CA</em> to sign Kafka broker certificates.
Connecting clients use the certificate to establish a TLS encrypted connection with a Kafka cluster. The certificate verifies broker identity.</p>
</dd>
<dt class="hdlist1">Client secret</dt>
<dd>
<p>A client secret contains the <em>clients CA</em> for a user to sign its own client certificate.
This allows mutual authentication against the Kafka cluster. The broker validates a client&#8217;s identity through the certificate.</p>
</dd>
<dt class="hdlist1">User secret</dt>
<dd>
<p>A user secret contains a private key and certificate. The secret is created and signed by the clients CA when a new user is created. The key and certificate are used to authenticate and authorize the user when accessing the cluster.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You can provide <a href="#proc-installing-certs-per-listener-str"><em>Kafka listener certificates</em></a> for TLS listeners or external listeners that have TLS encryption enabled.
Use Kafka listener certificates to incorporate the security infrastructure you already have in place.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="certificates-and-secrets-formats-str"><a class="link" href="#certificates-and-secrets-formats-str">14.2.1. TLS authentication using keys and certificates in PEM or PKCS #12 format</a></h4>
<div class="paragraph">
<p>The secrets created by Strimzi provide private keys and certificates in PEM (Privacy Enhanced Mail) and PKCS #12 (Public-Key Cryptography Standards) formats.
PEM and PKCS #12 are OpenSSL-generated key formats for TLS communications using the SSL protocol.</p>
</div>
<div class="paragraph">
<p>You can configure mutual TLS (mTLS) authentication that uses the credentials contained in the secrets generated for a Kafka cluster and user.</p>
</div>
<div class="paragraph">
<p>To set up mTLS, you must first do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#con-securing-kafka-authentication-str">Configure your Kafka cluster with a listener that uses mTLS</a></p>
</li>
<li>
<p><a href="#con-securing-client-authentication-str">Create a <code>KafkaUser</code> that provides client credentials for mTLs</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you deploy a Kafka cluster, a <code>&lt;cluster_name&gt;-cluster-ca-cert</code> secret is created with public key to verify the cluster.
You use the public key to configure a truststore for the client.</p>
</div>
<div class="paragraph">
<p>When you create a <code>KafkaUser</code>, a <code>&lt;kafka_user_name&gt;</code> secret is created with the keys and certificates to verify the user (client).
Use these credentials to configure a keystore for the client.</p>
</div>
<div class="paragraph">
<p>With the Kafka cluster and client set up to use mTLS, you extract credentials from the secrets and add them to your client configuration.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">PEM keys and certificates</dt>
<dd>
<p>For PEM, you add the following to your client configuration:</p>
<div class="openblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Truststore</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>ca.crt</code> from the <code>&lt;cluster_name&gt;-cluster-ca-cert</code> secret, which is the CA certificate for the cluster.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Keystore</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>user.crt</code> from the <code>&lt;kafka_user_name&gt;</code> secret, which is the public certificate of the user.</p>
</li>
<li>
<p><code>user.key</code> from the <code>&lt;kafka_user_name&gt;</code> secret, which is the private key of the user.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">PKCS #12 keys and certificates</dt>
<dd>
<p>For PKCS #12, you add the following to your client configuration:</p>
<div class="openblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Truststore</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>ca.p12</code> from the <code>&lt;cluster_name&gt;-cluster-ca-cert</code> secret, which is the CA certificate for the cluster.</p>
</li>
<li>
<p><code>ca.password</code> from the <code>&lt;cluster_name&gt;-cluster-ca-cert</code> secret, which is the password to access the public cluster CA certificate.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Keystore</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>user.p12</code> from the <code>&lt;kafka_user_name&gt;</code> secret, which is the public key certificate of the user.</p>
</li>
<li>
<p><code>user.password</code> from the <code>&lt;kafka_user_name&gt;</code> secret, which is the password to access the public key certificate of the Kafka user.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>PKCS #12 is supported by Java, so you can add the values of the certificates directly to your Java client configuration.
You can also reference the certificates from a secure storage location.
With PEM files, you must add the certificates directly to the client configuration in single-line format.
Choose a format that&#8217;s suitable for establishing TLS connections between your Kafka cluster and client.
Use PKCS #12 if you are unfamiliar with PEM.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
All keys are 2048 bits in size and, by default, are valid for 365 days from the initial generation.
You can <a href="#con-certificate-renewal-str">change the validity period</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="con-certificates-str"><a class="link" href="#con-certificates-str">14.2.2. Secrets generated by the Cluster Operator</a></h4>
<div class="paragraph">
<p>The Cluster Operator generates the following certificates, which are saved as secrets in the Kubernetes cluster.
Strimzi uses these secrets by default.</p>
</div>
<div class="paragraph">
<p>The cluster CA and clients CA have separate secrets for the private key and public key.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code><em>&lt;cluster_name&gt;</em>-cluster-ca</code></dt>
<dd>
<p>Contains the private key of the cluster CA. Strimzi and Kafka components use the private key to sign server certificates.</p>
</dd>
<dt class="hdlist1"><code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code></dt>
<dd>
<p>Contains the public key of the cluster CA. Kafka clients use the public key to verify the identity of the Kafka brokers they are connecting to with TLS server authentication.</p>
</dd>
<dt class="hdlist1"><code><em>&lt;cluster_name&gt;</em>-clients-ca</code></dt>
<dd>
<p>Contains the private key of the clients CA. Kafka clients use the private key to sign new user certificates for mTLS authentication when connecting to Kafka brokers.</p>
</dd>
<dt class="hdlist1"><code><em>&lt;cluster_name&gt;</em>-clients-ca-cert</code></dt>
<dd>
<p>Contains the public key of the clients CA. Kafka brokers use the public key to verify the identity of clients accessing the Kafka brokers when mTLS authentication is used.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Secrets for communication between Strimzi components contain a private key and a public key certificate signed by the cluster CA.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code><em>&lt;cluster_name&gt;</em>-kafka-brokers</code></dt>
<dd>
<p>Contains the private and public keys for Kafka brokers.</p>
</dd>
<dt class="hdlist1"><code><em>&lt;cluster_name&gt;</em>-zookeeper-nodes</code></dt>
<dd>
<p>Contains the private and public keys for ZooKeeper nodes.</p>
</dd>
<dt class="hdlist1"><code><em>&lt;cluster_name&gt;</em>-cluster-operator-certs</code></dt>
<dd>
<p>Contains the private and public keys for encrypting communication between the Cluster Operator and Kafka or ZooKeeper.</p>
</dd>
<dt class="hdlist1"><code><em>&lt;cluster_name&gt;</em>-entity-topic-operator-certs</code></dt>
<dd>
<p>Contains the private and public keys for encrypting communication between the Topic Operator and Kafka or ZooKeeper.</p>
</dd>
<dt class="hdlist1"><code><em>&lt;cluster_name&gt;</em>-entity-user-operator-certs</code></dt>
<dd>
<p>Contains the private and public keys for encrypting communication between the User Operator and Kafka or ZooKeeper.</p>
</dd>
<dt class="hdlist1"><code><em>&lt;cluster_name&gt;</em>-cruise-control-certs</code></dt>
<dd>
<p>Contains the private and public keys for encrypting communication between Cruise Control and Kafka or ZooKeeper.</p>
</dd>
<dt class="hdlist1"><code><em>&lt;cluster_name&gt;</em>-kafka-exporter-certs</code></dt>
<dd>
<p>Contains the private and public keys for encrypting communication between Kafka Exporter and Kafka or ZooKeeper.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You can <a href="#proc-installing-certs-per-listener-str">provide your own server certificates and private keys</a> to connect to Kafka brokers using <em>Kafka listener certificates</em> rather than certificates signed by the cluster CA.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="cluster_ca_secrets"><a class="link" href="#cluster_ca_secrets">14.2.3. Cluster CA secrets</a></h4>
<div class="paragraph">
<p>Cluster CA secrets are managed by the Cluster Operator in a Kafka cluster.</p>
</div>
<div class="paragraph">
<p>Only the <code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code> secret is required by clients.
All other cluster secrets are accessed by Strimzi components.
You can enforce this using Kubernetes role-based access controls, if necessary.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The CA certificates in <code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code> must be trusted by Kafka client applications so that they validate the Kafka broker certificates when connecting to Kafka brokers over TLS.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 18. Fields in the <code><em>&lt;cluster_name&gt;</em>-cluster-ca</code> secret</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ca.key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The current private key for the cluster CA.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 19. Fields in the <code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code> secret</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ca.p12</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PKCS #12 store for storing certificates and keys.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ca.password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password for protecting the PKCS #12 store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ca.crt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The current certificate for the cluster CA.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 20. Fields in the <code><em>&lt;cluster_name&gt;</em>-kafka-brokers</code> secret</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>&lt;cluster_name&gt;</em>-kafka-<em>&lt;num&gt;</em>.p12</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PKCS #12 store for storing certificates and keys.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>&lt;cluster_name&gt;</em>-kafka-<em>&lt;num&gt;</em>.password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password for protecting the PKCS #12 store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>&lt;cluster_name&gt;</em>-kafka-<em>&lt;num&gt;</em>.crt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Certificate for a Kafka broker pod <em>&lt;num&gt;</em>. Signed by a current or former cluster CA private key in <code><em>&lt;cluster_name&gt;</em>-cluster-ca</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>&lt;cluster_name&gt;</em>-kafka-<em>&lt;num&gt;</em>.key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private key for a Kafka broker pod <code><em>&lt;num&gt;</em></code>.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 21. Fields in the <code><em>&lt;cluster_name&gt;</em>-zookeeper-nodes</code> secret</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>&lt;cluster_name&gt;</em>-zookeeper-<em>&lt;num&gt;</em>.p12</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PKCS #12 store for storing certificates and keys.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>&lt;cluster_name&gt;</em>-zookeeper-<em>&lt;num&gt;</em>.password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password for protecting the  PKCS #12 store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>&lt;cluster_name&gt;</em>-zookeeper-<em>&lt;num&gt;</em>.crt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Certificate for ZooKeeper node <em>&lt;num&gt;</em>. Signed by a current or former cluster CA private key in <code><em>&lt;cluster_name&gt;</em>-cluster-ca</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>&lt;cluster_name&gt;</em>-zookeeper-<em>&lt;num&gt;</em>.key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private key for ZooKeeper pod <code><em>&lt;num&gt;</em></code>.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 22. Fields in the <code><em>&lt;cluster_name&gt;</em>-cluster-operator-certs</code> secret</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cluster-operator.p12</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PKCS #12 store for storing certificates and keys.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cluster-operator.password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password for protecting the PKCS #12 store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cluster-operator.crt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Certificate for mTLS communication between the Cluster Operator and Kafka or ZooKeeper.
Signed by a current or former cluster CA private key in <code><em>&lt;cluster_name&gt;</em>-cluster-ca</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cluster-operator.key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private key for mTLS communication between the Cluster Operator and Kafka or ZooKeeper.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 23. Fields in the <code><em>&lt;cluster_name&gt;</em>-entity-topic-operator-certs</code> secret</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entity-operator.p12</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PKCS #12 store for storing certificates and keys.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entity-operator.password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password for protecting the PKCS #12 store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entity-operator.crt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Certificate for mTLS communication between the Topic Operator and Kafka or ZooKeeper.
Signed by a current or former cluster CA private key in <code><em>&lt;cluster_name&gt;</em>-cluster-ca</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entity-operator.key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private key for mTLS communication between the Topic Operator and Kafka or ZooKeeper.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 24. Fields in the <code><em>&lt;cluster_name&gt;</em>-entity-user-operator-certs</code> secret</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entity-operator.p12</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PKCS #12 store for storing certificates and keys.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entity-operator.password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password for protecting the PKCS #12 store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entity-operator.crt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Certificate for mTLS communication between the User Operator and Kafka or ZooKeeper.
Signed by a current or former cluster CA private key in <code><em>&lt;cluster_name&gt;</em>-cluster-ca</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entity-operator.key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private key for mTLS communication between the User Operator and Kafka or ZooKeeper.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 25. Fields in the <code><em>&lt;cluster_name&gt;</em>-cruise-control-certs</code> secret</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cruise-control.p12</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PKCS #12 store for storing certificates and keys.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cruise-control.password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password for protecting the PKCS #12 store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cruise-control.crt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Certificate for mTLS communication between Cruise Control and Kafka or ZooKeeper.
Signed by a current or former cluster CA private key in <code><em>&lt;cluster_name&gt;</em>-cluster-ca</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cruise-control.key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private key for mTLS communication between the Cruise Control and Kafka or ZooKeeper.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 26. Fields in the <code><em>&lt;cluster_name&gt;</em>-kafka-exporter-certs</code> secret</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-exporter.p12</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PKCS #12 store for storing certificates and keys.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-exporter.password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password for protecting the PKCS #12 store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-exporter.crt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Certificate for mTLS communication between Kafka Exporter and Kafka or ZooKeeper.
Signed by a current or former cluster CA private key in <code><em>&lt;cluster_name&gt;</em>-cluster-ca</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-exporter.key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private key for mTLS communication between the Kafka Exporter and Kafka or ZooKeeper.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="clients_ca_secrets"><a class="link" href="#clients_ca_secrets">14.2.4. Clients CA secrets</a></h4>
<div class="paragraph">
<p>Clients CA secrets are managed by the Cluster Operator in a Kafka cluster.</p>
</div>
<div class="paragraph">
<p>The certificates in <code><em>&lt;cluster_name&gt;</em>-clients-ca-cert</code> are those which the Kafka brokers trust.</p>
</div>
<div class="paragraph">
<p>The <code><em>&lt;cluster_name&gt;</em>-clients-ca</code> secret is used to sign the certificates of client applications.
This secret must be accessible to the Strimzi components and for administrative access if you are intending to issue application certificates without using the User Operator.
You can enforce this using Kubernetes role-based access controls, if necessary.</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 27. Fields in the <code><em>&lt;cluster_name&gt;</em>-clients-ca</code> secret</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ca.key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The current private key for the clients CA.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 28. Fields in the <code><em>&lt;cluster_name&gt;</em>-clients-ca-cert</code> secret</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ca.p12</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PKCS #12 store for storing certificates and keys.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ca.password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password for protecting the PKCS #12 store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ca.crt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The current certificate for the clients CA.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="user_secrets_generated_by_the_user_operator"><a class="link" href="#user_secrets_generated_by_the_user_operator">14.2.5. User secrets generated by the User Operator</a></h4>
<div class="paragraph">
<p>User secrets are managed by the User Operator.</p>
</div>
<div class="paragraph">
<p>When a user is created using the User Operator, a secret is generated using the name of the user.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 29. Fields in the <code><em>user_name</em></code> secret</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Secret name</th>
<th class="tableblock halign-left valign-top">Field within secret</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" rowspan="4"><p class="tableblock"><code><em>&lt;user_name&gt;</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>user.p12</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PKCS #12 store for storing certificates and keys.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>user.password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password for protecting the PKCS #12 store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>user.crt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Certificate for the user, signed by the clients CA</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>user.key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private key for the user</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="adding_labels_and_annotations_to_cluster_ca_secrets"><a class="link" href="#adding_labels_and_annotations_to_cluster_ca_secrets">14.2.6. Adding labels and annotations to cluster CA secrets</a></h4>
<div class="paragraph">
<p>By configuring the <code>clusterCaCert</code> template property in the <code>Kafka</code> custom resource, you can add custom labels and annotations to the Cluster CA secrets created by the Cluster Operator.
Labels and annotations are useful for identifying objects and adding contextual information.
You configure template properties in Strimzi custom resources.</p>
</div>
<div class="listingblock">
<div class="title">Example template customization to add labels and annotations to secrets</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
    template:
      clusterCaCert:
        metadata:
          labels:
            label1: value1
            label2: value2
          annotations:
            annotation1: value1
            annotation2: value2
    # ...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="disabling_ownerreference_in_the_ca_secrets"><a class="link" href="#disabling_ownerreference_in_the_ca_secrets">14.2.7. Disabling <code>ownerReference</code> in the CA secrets</a></h4>
<div class="paragraph">
<p>By default, the cluster and clients CA secrets are created with an <code>ownerReference</code> property that is set to the <code>Kafka</code> custom resource.
This means that, when the <code>Kafka</code> custom resource is deleted, the CA secrets are also deleted (garbage collected) by Kubernetes.</p>
</div>
<div class="paragraph">
<p>If you want to reuse the CA for a new cluster, you can disable the <code>ownerReference</code> by setting the <code>generateSecretOwnerReference</code> property for the cluster and clients CA secrets to <code>false</code> in the <code>Kafka</code> configuration.
When the <code>ownerReference</code> is disabled, CA secrets are not deleted by Kubernetes when the corresponding <code>Kafka</code> custom resource is deleted.</p>
</div>
<div class="listingblock">
<div class="title">Example Kafka configuration with disabled <code>ownerReference</code> for cluster and clients CAs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
# ...
spec:
# ...
  clusterCa:
    generateSecretOwnerReference: false
  clientsCa:
    generateSecretOwnerReference: false
# ...</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./configuring.html#type-CertificateAuthority-reference" target="_blank" rel="noopener"><code>CertificateAuthority</code> schema reference</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-certificate-renewal-str"><a class="link" href="#con-certificate-renewal-str">14.3. Certificate renewal and validity periods</a></h3>
<div class="paragraph _abstract">
<p>Cluster CA and clients CA certificates are only valid for a limited time period, known as the validity period.
This is usually defined as a number of days since the certificate was generated.</p>
</div>
<div class="paragraph">
<p>For CA certificates automatically created by the Cluster Operator, you can configure the validity period of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cluster CA certificates in <code>Kafka.spec.clusterCa.validityDays</code></p>
</li>
<li>
<p>Clients CA certificates in <code>Kafka.spec.clientsCa.validityDays</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The default validity period for both certificates is 365 days.
Manually-installed CA certificates should have their own validity periods defined.</p>
</div>
<div class="paragraph">
<p>When a CA certificate expires, components and clients that still trust that certificate will not accept connections from peers whose certificates were signed by the CA private key.
The components and clients need to trust the <em>new</em> CA certificate instead.</p>
</div>
<div class="paragraph">
<p>To allow the renewal of CA certificates without a loss of service, the Cluster Operator initiates certificate renewal before the old CA certificates expire.</p>
</div>
<div class="paragraph">
<p>You can configure the renewal period of the certificates created by the Cluster Operator:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cluster CA certificates in <code>Kafka.spec.clusterCa.renewalDays</code></p>
</li>
<li>
<p>Clients CA certificates in <code>Kafka.spec.clientsCa.renewalDays</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The default renewal period for both certificates is 30 days.</p>
</div>
<div class="paragraph">
<p>The renewal period is measured backwards, from the expiry date of the current certificate.</p>
</div>
<div class="listingblock">
<div class="title">Validity period against renewal period</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Not Before                                     Not After
    |                                              |
    |&lt;--------------- validityDays ---------------&gt;|
                              &lt;--- renewalDays ---&gt;|</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make a change to the validity and renewal periods after creating the Kafka cluster, you configure and apply the <code>Kafka</code> custom resource,
and <a href="#proc-renewing-ca-certs-manually-str">manually renew the CA certificates</a>.
If you do not manually renew the certificates, the new periods will be used the next time the certificate is renewed automatically.</p>
</div>
<div class="listingblock">
<div class="title">Example Kafka configuration for certificate validity and renewal periods</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
# ...
spec:
# ...
  clusterCa:
    renewalDays: 30
    validityDays: 365
    generateCertificateAuthority: true
  clientsCa:
    renewalDays: 30
    validityDays: 365
    generateCertificateAuthority: true
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The behavior of the Cluster Operator during the renewal period depends on the settings for the <code>generateCertificateAuthority</code> certificate generation properties for the cluster CA and clients CA.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>true</code></dt>
<dd>
<p>If the properties are set to <code>true</code>, a CA certificate is generated automatically by the Cluster Operator, and renewed automatically within the renewal period.</p>
</dd>
<dt class="hdlist1"><code>false</code></dt>
<dd>
<p>If the properties are set to <code>false</code>, a CA certificate is not generated by the Cluster Operator. Use this option if you are <a href="#installing-your-own-ca-certificates-str">installing your own certificates</a>.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="renewal_process_with_automatically_generated_ca_certificates"><a class="link" href="#renewal_process_with_automatically_generated_ca_certificates">14.3.1. Renewal process with automatically generated CA certificates</a></h4>
<div class="paragraph">
<p>The Cluster Operator performs the following processes in this order when renewing CA certificates:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Generates a new CA certificate, but retains the existing key.</p>
<div class="paragraph">
<p>The new certificate replaces the old one with the name <code>ca.crt</code> within the corresponding <code>Secret</code>.</p>
</div>
</li>
<li>
<p>Generates new client certificates (for ZooKeeper nodes, Kafka brokers, and the Entity Operator).</p>
<div class="paragraph">
<p>This is not strictly necessary because the signing key has not changed, but it keeps the validity period of the client certificate in sync with the CA certificate.</p>
</div>
</li>
<li>
<p>Restarts ZooKeeper nodes so that they will trust the new CA certificate and use the new client certificates.</p>
</li>
<li>
<p>Restarts Kafka brokers so that they will trust the new CA certificate and use the new client certificates.</p>
</li>
<li>
<p>Restarts the Topic and User Operators so that they will trust the new CA certificate and use the new client certificates.</p>
<div class="paragraph">
<p>User certificates are signed by the clients CA.
User certificates generated by the User Operator are renewed when the clients CA is renewed.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="client_certificate_renewal"><a class="link" href="#client_certificate_renewal">14.3.2. Client certificate renewal</a></h4>
<div class="paragraph">
<p>The Cluster Operator is not aware of the client applications using the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>When connecting to the cluster, and to ensure they operate correctly, client applications must:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Trust the cluster CA certificate published in the <em>&lt;cluster&gt;</em>-cluster-ca-cert Secret.</p>
</li>
<li>
<p>Use the credentials published in their <em>&lt;user-name&gt;</em> Secret to connect to the cluster.</p>
<div class="paragraph">
<p>The User Secret provides credentials in PEM and PKCS #12 format, or it can provide a password when using SCRAM-SHA authentication.
The User Operator creates the user credentials when a user is created.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>You must ensure clients continue to work after certificate renewal.
The renewal process depends on how the clients are configured.</p>
</div>
<div class="paragraph">
<p>If you are provisioning client certificates and keys manually, you must generate new client certificates and ensure the new certificates are used by clients within the renewal period.
Failure to do this by the end of the renewal period could result in client applications being unable to connect to the cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
For workloads running inside the same Kubernetes cluster and namespace, Secrets can be mounted as a volume so the client Pods construct their keystores and truststores from the current state of the Secrets.
For more details on this procedure, see <a href="#configuring-internal-clients-to-trust-cluster-ca-str">Configuring internal clients to trust the cluster CA</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="proc-renewing-ca-certs-manually-str"><a class="link" href="#proc-renewing-ca-certs-manually-str">14.3.3. Manually renewing Cluster Operator-managed CA certificates</a></h4>
<div class="paragraph _abstract">
<p>Cluster and clients CA certificates generated by the Cluster Operator auto-renew at the start of their respective certificate renewal periods.
However, you can use the <code>strimzi.io/force-renew</code> annotation to manually renew one or both of these certificates before the certificate renewal period starts.
You might do this for security reasons, or if you have <a href="#con-certificate-renewal-str">changed the renewal or validity periods for the certificates</a>.</p>
</div>
<div class="paragraph">
<p>A renewed certificate uses the same private key as the old certificate.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using your own CA certificates, the <code>force-renew</code> annotation cannot be used.
Instead, follow the procedure for <a href="#renewing-your-own-ca-certificates-str">renewing your own CA certificates</a>.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
<li>
<p>A Kafka cluster in which CA certificates and private keys are installed.</p>
</li>
<li>
<p>The OpenSSL TLS management tool to check the period of validity for CA certificates.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this procedure, we use a Kafka cluster named <code>my-cluster</code> within the <code>my-project</code> namespace.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Apply the <code>strimzi.io/force-renew</code> annotation to the secret that contains the CA certificate that you want to renew.</p>
<div class="listingblock">
<div class="title">Renewing the Cluster CA secret</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate secret my-cluster-cluster-ca-cert -n my-project strimzi.io/force-renew=true</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Renewing the Clients CA secret</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate secret my-cluster-clients-ca-cert -n my-project strimzi.io/force-renew=true</code></pre>
</div>
</div>
</li>
<li>
<p>At the next reconciliation, the Cluster Operator generates new certificates.</p>
<div class="paragraph">
<p>If maintenance time windows are configured, the Cluster Operator generates the new CA certificate at the first reconciliation within the next maintenance time window.</p>
</div>
</li>
<li>
<p>Check the period of validity for the new CA certificates.</p>
<div class="listingblock">
<div class="title">Checking the period of validity for the new cluster CA certificate</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret my-cluster-cluster-ca-cert -n my-project -o=jsonpath='{.data.ca\.crt}' | base64 -d | openssl x509 -noout -dates</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Checking the period of validity for the new clients CA certificate</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret my-cluster-clients-ca-cert -n my-project -o=jsonpath='{.data.ca\.crt}' | base64 -d | openssl x509 -noout -dates</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command returns a <code>notBefore</code> and <code>notAfter</code> date, which is the valid start and end date for the CA certificate.</p>
</div>
</li>
<li>
<p>Update client configurations to trust the new cluster CA certificate.</p>
<div class="paragraph">
<p>See:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><a href="#configuring-internal-clients-to-trust-cluster-ca-str">Configuring internal clients to trust the cluster CA</a></p>
</li>
<li>
<p><a href="#configuring-external-clients-to-trust-cluster-ca-str">Configuring external clients to trust the cluster CA</a></p>
</li>
</ul>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-recovering-expired-ca-certs-str"><a class="link" href="#proc-recovering-expired-ca-certs-str">14.3.4. Manually recovering from expired Cluster Operator-managed CA certificates</a></h4>
<div class="paragraph _abstract">
<p>The Cluster Operator automatically renews the cluster and clients CA certificates when their renewal periods begin.
Nevertheless, unexpected operational problems or disruptions may prevent the renewal process, such as prolonged downtime of the Cluster Operator or unavailability of the Kafka cluster.
If CA certificates expire, Kafka cluster components cannot communicate with each other and the Cluster Operator cannot renew the CA certificates without manual intervention.</p>
</div>
<div class="paragraph">
<p>To promptly perform a recovery, follow the steps outlined in this procedure in the order given.
You can recover from expired cluster and clients CA certificates.
The process involves deleting the secrets containing the expired certificates so that new ones are generated by the Cluster Operator.
For more information on the secrets managed in Strimzi, see <a href="#con-certificates-str">Secrets generated by the Cluster Operator</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using your own CA certificates and they expire, the process is similar, but you need to <a href="#renewing-your-own-ca-certificates-str">renew the CA certificates</a> rather than use certificates generated by the Cluster Operator.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
<li>
<p>A Kafka cluster in which CA certificates and private keys are installed.</p>
</li>
<li>
<p>The OpenSSL TLS management tool to check the period of validity for CA certificates.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this procedure, we use a Kafka cluster named <code>my-cluster</code> within the <code>my-project</code> namespace.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Delete the secret containing the expired CA certificate.</p>
<div class="listingblock">
<div class="title">Deleting the Cluster CA secret</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl delete secret my-cluster-cluster-ca-cert -n my-project</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Deleting the Clients CA secret</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl delete secret my-cluster-clients-ca-cert -n my-project</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the Cluster Operator to generate new certificates.</p>
<div class="ulist">
<ul>
<li>
<p>A new CA cluster certificate to verify the identity of the Kafka brokers is created in a secret of the same name (<code>my-cluster-cluster-ca-cert</code>).</p>
</li>
<li>
<p>A new CA clients certificate to verify the identity of Kafka users is created in a secret of the same name (<code>my-cluster-clients-ca-cert</code>).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Check the period of validity for the new CA certificates.</p>
<div class="listingblock">
<div class="title">Checking the period of validity for the new cluster CA certificate</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret my-cluster-cluster-ca-cert -n my-project -o=jsonpath='{.data.ca\.crt}' | base64 -d | openssl x509 -noout -dates</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Checking the period of validity for the new clients CA certificate</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret my-cluster-clients-ca-cert -n my-project -o=jsonpath='{.data.ca\.crt}' | base64 -d | openssl x509 -noout -dates</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command returns a <code>notBefore</code> and <code>notAfter</code> date, which is the valid start and end date for the CA certificate.</p>
</div>
</li>
<li>
<p>Delete the component pods and secrets that use the CA certificates.</p>
<div class="openblock">
<div class="content">
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Delete the ZooKeeper secret.</p>
</li>
<li>
<p>Wait for the Cluster Operator to detect the missing ZooKeeper secret and recreate it.</p>
</li>
<li>
<p>Delete all ZooKeeper pods.</p>
</li>
<li>
<p>Delete the Kafka secret.</p>
</li>
<li>
<p>Wait for the Cluster Operator to detect the missing Kafka secret and recreate it.</p>
</li>
<li>
<p>Delete all Kafka pods.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>If you are only recovering the clients CA certificate, you only need to delete the Kafka secret and pods.</p>
</div>
<div class="paragraph">
<p>You can use the following <code>kubectl</code> command to find resources and also verify that they have been removed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get &lt;resource_type&gt; --all-namespaces | grep &lt;kafka_cluster_name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>&lt;resource_type&gt;</code> with the type of the resource, such as <code>Pod</code> or <code>Secret</code>.</p>
</div>
</li>
<li>
<p>Wait for the Cluster Operator to detect the missing Kafka and ZooKeeper pods and recreate them with the updated CA certificates.</p>
<div class="paragraph">
<p>On reconciliation, the Cluster Operator automatically updates other components to trust the new CA certificates.</p>
</div>
</li>
<li>
<p>Verify that there are no issues related to certificate validation in the Cluster Operator log.</p>
</li>
<li>
<p>Update client configurations to trust the new cluster CA certificate.</p>
<div class="paragraph">
<p>See:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><a href="#configuring-internal-clients-to-trust-cluster-ca-str">Configuring internal clients to trust the cluster CA</a></p>
</li>
<li>
<p><a href="#configuring-external-clients-to-trust-cluster-ca-str">Configuring external clients to trust the cluster CA</a></p>
</li>
</ul>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-replacing-private-keys-str"><a class="link" href="#proc-replacing-private-keys-str">14.3.5. Replacing private keys used by Cluster Operator-managed CA certificates</a></h4>
<div class="paragraph">
<p>You can replace the private keys used by the cluster CA and clients CA certificates generated by the Cluster Operator.
When a private key is replaced, the Cluster Operator generates a new CA certificate for the new private key.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using your own CA certificates, the <code>force-replace</code> annotation cannot be used.
Instead, follow the procedure for <a href="#renewing-your-own-ca-certificates-str">renewing your own CA certificates</a>.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is running.</p>
</li>
<li>
<p>A Kafka cluster in which CA certificates and private keys are installed.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Apply the <code>strimzi.io/force-replace</code> annotation to the <code>Secret</code> that contains the private key that you want to renew.</p>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 30. Commands for replacing private keys</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Private key for</th>
<th class="tableblock halign-left valign-top">Secret</th>
<th class="tableblock halign-left valign-top">Annotate command</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster CA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>CLUSTER-NAME</em>-cluster-ca</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kubectl annotate secret <em>CLUSTER-NAME</em>-cluster-ca strimzi.io/force-replace=true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Clients CA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>CLUSTER-NAME</em>-clients-ca</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kubectl annotate secret <em>CLUSTER-NAME</em>-clients-ca strimzi.io/force-replace=true</code></p></td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
<div class="paragraph">
<p>At the next reconciliation the Cluster Operator will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Generate a new private key for the <code>Secret</code> that you annotated</p>
</li>
<li>
<p>Generate a new CA certificate</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If maintenance time windows are configured, the Cluster Operator will generate the new private key and CA certificate at the first reconciliation within the next maintenance time window.</p>
</div>
<div class="paragraph">
<p>Client applications must reload the cluster and clients CA certificates that were renewed by the Cluster Operator.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#certificates-and-secrets-str">Secrets generated by the operators</a></p>
</li>
<li>
<p><a href="#assembly-maintenance-time-windows-str">Maintenance time windows for rolling updates</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-internal-clients-to-trust-cluster-ca-str"><a class="link" href="#configuring-internal-clients-to-trust-cluster-ca-str">14.4. Configuring internal clients to trust the cluster CA</a></h3>
<div class="paragraph">
<p>This procedure describes how to configure a Kafka client that resides inside the Kubernetes cluster — connecting to a TLS listener — to trust the cluster CA certificate.</p>
</div>
<div class="paragraph">
<p>The easiest way to achieve this for an internal client is to use a volume mount to access the <code>Secrets</code> containing the necessary certificates and keys.</p>
</div>
<div class="paragraph">
<p>Follow the steps to configure trust certificates that are signed by the cluster CA for Java-based Kafka Producer, Consumer, and Streams APIs.</p>
</div>
<div class="paragraph">
<p>Choose the steps to follow according to the certificate format of the cluster CA: PKCS #12 (<code>.p12</code>) or PEM (<code>.crt</code>).</p>
</div>
<div class="paragraph">
<p>The steps describe how to mount the Cluster Secret that verifies the identity of the Kafka cluster to the client pod.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator must be running.</p>
</li>
<li>
<p>There needs to be a <code>Kafka</code> resource within the Kubernetes cluster.</p>
</li>
<li>
<p>You need a Kafka client application inside the Kubernetes cluster that will connect using TLS, and needs to trust the cluster CA certificate.</p>
</li>
<li>
<p>The client application must be running in the same namespace as the <code>Kafka</code> resource.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Using PKCS #12 format (.p12)</div>
<ol class="arabic">
<li>
<p>Mount the cluster Secret as a volume when defining the client pod.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kind: Pod
apiVersion: v1
metadata:
  name: client-pod
spec:
  containers:
  - name: client-name
    image: client-name
    volumeMounts:
    - name: secret-volume
      mountPath: /data/p12
    env:
    - name: SECRET_PASSWORD
      valueFrom:
        secretKeyRef:
          name: my-secret
          key: my-password
  volumes:
  - name: secret-volume
    secret:
      secretName: my-cluster-cluster-ca-cert</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we&#8217;re mounting the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The PKCS #12 file into an exact path, which can be configured</p>
</li>
<li>
<p>The password into an environment variable, where it can be used for Java configuration</p>
</li>
</ul>
</div>
</li>
<li>
<p>Configure the Kafka client with the following properties:</p>
<div class="ulist">
<ul>
<li>
<p>A security protocol option:</p>
<div class="ulist">
<ul>
<li>
<p><code>security.protocol: SSL</code> when using TLS for encryption (with or without mTLS authentication).</p>
</li>
<li>
<p><code>security.protocol: SASL_SSL</code> when using SCRAM-SHA authentication over TLS.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>ssl.truststore.location</code> with the truststore location where the certificates were imported.</p>
</li>
<li>
<p><code>ssl.truststore.password</code> with the password for accessing the truststore.</p>
</li>
<li>
<p><code>ssl.truststore.type=PKCS12</code> to identify the truststore type.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Using PEM format (.crt)</div>
<ol class="arabic">
<li>
<p>Mount the cluster Secret as a volume when defining the client pod.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kind: Pod
apiVersion: v1
metadata:
  name: client-pod
spec:
  containers:
  - name: client-name
    image: client-name
    volumeMounts:
    - name: secret-volume
      mountPath: /data/crt
  volumes:
  - name: secret-volume
    secret:
      secretName: my-cluster-cluster-ca-cert</code></pre>
</div>
</div>
</li>
<li>
<p>Use the extracted certificate to configure a TLS connection in clients that use certificates in X.509 format.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="configuring-external-clients-to-trust-cluster-ca-str"><a class="link" href="#configuring-external-clients-to-trust-cluster-ca-str">14.5. Configuring external clients to trust the cluster CA</a></h3>
<div class="paragraph">
<p>This procedure describes how to configure a Kafka client that resides outside the Kubernetes cluster – connecting to an <code>external</code> listener – to trust the cluster CA certificate.
Follow this procedure when setting up the client and during the renewal period, when the old clients CA certificate is replaced.</p>
</div>
<div class="paragraph">
<p>Follow the steps to configure trust certificates that are signed by the cluster CA for Java-based Kafka Producer, Consumer, and Streams APIs.</p>
</div>
<div class="paragraph">
<p>Choose the steps to follow according to the certificate format of the cluster CA: PKCS #12 (<code>.p12</code>) or PEM (<code>.crt</code>).</p>
</div>
<div class="paragraph">
<p>The steps describe how to obtain the certificate from the Cluster Secret that verifies the identity of the Kafka cluster.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The <code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code> secret contains more than one CA certificate during the CA certificate renewal period.
Clients must add <em>all</em> of them to their truststores.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator must be running.</p>
</li>
<li>
<p>There needs to be a <code>Kafka</code> resource within the Kubernetes cluster.</p>
</li>
<li>
<p>You need a Kafka client application outside the Kubernetes cluster that will connect using TLS, and needs to trust the cluster CA certificate.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Using PKCS #12 format (.p12)</div>
<ol class="arabic">
<li>
<p>Extract the cluster CA certificate and password from the <code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code> Secret of the Kafka cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>&lt;cluster_name&gt;</em>-cluster-ca-cert -o jsonpath='{.data.ca\.p12}' | base64 -d &gt; ca.p12</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>&lt;cluster_name&gt;</em>-cluster-ca-cert -o jsonpath='{.data.ca\.password}' | base64 -d &gt; ca.password</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;cluster_name&gt;</em> with the name of the Kafka cluster.</p>
</div>
</li>
<li>
<p>Configure the Kafka client with the following properties:</p>
<div class="ulist">
<ul>
<li>
<p>A security protocol option:</p>
<div class="ulist">
<ul>
<li>
<p><code>security.protocol: SSL</code> when using TLS.</p>
</li>
<li>
<p><code>security.protocol: SASL_SSL</code> when using SCRAM-SHA authentication over TLS.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>ssl.truststore.location</code> with the truststore location where the certificates were imported.</p>
</li>
<li>
<p><code>ssl.truststore.password</code> with the password for accessing the truststore. This property can be omitted if it is not needed by the truststore.</p>
</li>
<li>
<p><code>ssl.truststore.type=PKCS12</code> to identify the truststore type.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Using PEM format (.crt)</div>
<ol class="arabic">
<li>
<p>Extract the cluster CA certificate from the <code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code> secret of the Kafka cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>&lt;cluster_name&gt;</em>-cluster-ca-cert -o jsonpath='{.data.ca\.crt}' | base64 -d &gt; ca.crt</code></pre>
</div>
</div>
</li>
<li>
<p>Use the extracted certificate to configure a TLS connection in clients that use certificates in X.509 format.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="security-using-your-own-certificates-str"><a class="link" href="#security-using-your-own-certificates-str">14.6. Using your own CA certificates and private keys</a></h3>
<div class="paragraph _abstract">
<p>Install and use your own CA certificates and private keys instead of using the defaults generated by the Cluster Operator.
You can replace the cluster and clients CA certificates and private keys.</p>
</div>
<div class="paragraph">
<p>You can switch to using your own CA certificates and private keys in the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Install your own CA certificates and private keys before deploying your Kafka cluster</p>
</li>
<li>
<p>Replace the default CA certificates and private keys with your own after deploying a Kafka cluster</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The steps to replace the default CA certificates and private keys after deploying a Kafka cluster are the same as those used to renew your own CA certificates and private keys.</p>
</div>
<div class="paragraph">
<p>If you use your own certificates, they won&#8217;t be renewed automatically.
You need to renew the CA certificates and private keys before they expire.</p>
</div>
<div class="paragraph">
<p>Renewal options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Renew the CA certificates only</p>
</li>
<li>
<p>Renew CA certificates and private keys (or replace the defaults)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="installing-your-own-ca-certificates-str"><a class="link" href="#installing-your-own-ca-certificates-str">14.6.1. Installing your own CA certificates and private keys</a></h4>
<div class="paragraph _abstract">
<p>Install your own CA certificates and private keys instead of using the cluster and clients CA certificates and private keys generated by the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>By default, Strimzi uses the following <a href="#con-certificates-str">cluster CA and clients CA secrets</a>, which are renewed automatically.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cluster CA secrets</p>
<div class="ulist">
<ul>
<li>
<p><code><em>&lt;cluster_name&gt;</em>-cluster-ca</code></p>
</li>
<li>
<p><code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Clients CA secrets</p>
<div class="ulist">
<ul>
<li>
<p><code><em>&lt;cluster_name&gt;</em>-clients-ca</code></p>
</li>
<li>
<p><code><em>&lt;cluster_name&gt;</em>-clients-ca-cert</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>To install your own certificates, use the same names.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is running.</p>
</li>
<li>
<p>A Kafka cluster is not yet deployed.</p>
<div class="paragraph">
<p>If you have already deployed a Kafka cluster, you can <a href="#proc-replacing-your-own-private-keys-str">replace the default CA certificates with your own</a>.</p>
</div>
</li>
<li>
<p>Your own X.509 certificates and keys in PEM format for the cluster CA or clients CA.</p>
<div class="ulist">
<ul>
<li>
<p>If you want to use a cluster or clients CA which is not a Root CA, you have to include the whole chain in the certificate file.
The chain should be in the following order:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The cluster or clients CA</p>
</li>
<li>
<p>One or more intermediate CAs</p>
</li>
<li>
<p>The root CA</p>
</li>
</ol>
</div>
</li>
<li>
<p>All CAs in the chain should be configured using the X509v3 Basic Constraints extension. Basic Constraints limit the path length of a certificate chain.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The OpenSSL TLS management tool for converting certificates.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Before you begin</div>
<p>The Cluster Operator generates keys and certificates in PEM (Privacy Enhanced Mail) and PKCS #12 (Public-Key Cryptography Standards) formats.
You can add your own certificates in either format.</p>
</div>
<div class="paragraph">
<p>Some applications cannot use PEM certificates and support only PKCS #12 certificates.
If you don&#8217;t have a cluster certificate in PKCS #12 format, use the OpenSSL TLS management tool to generate one from your <code>ca.crt</code> file.</p>
</div>
<div class="listingblock">
<div class="title">Example certificate generation command</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">openssl pkcs12 -export -in ca.crt -nokeys -out ca.p12 -password pass:<em>&lt;P12_password&gt;</em> -caname ca.crt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;P12_password&gt;</em> with your own password.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a new secret that contains the CA certificate.</p>
<div class="listingblock">
<div class="title">Client secret creation with a certificate in PEM format only</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create secret generic <em>&lt;cluster_name&gt;</em>-clients-ca-cert --from-file=ca.crt=ca.crt</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Cluster secret creation with certificates in PEM and PKCS #12 format</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create secret generic <em>&lt;cluster_name&gt;</em>-cluster-ca-cert \
  --from-file=ca.crt=ca.crt \
  --from-file=ca.p12=ca.p12 \
  --from-literal=ca.password=<em>P12-PASSWORD</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;cluster_name&gt;</em> with the name of your Kafka cluster.</p>
</div>
</li>
<li>
<p>Create a new secret that contains the private key.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create secret generic <em>CA-KEY-SECRET</em> --from-file=ca.key=ca.key</code></pre>
</div>
</div>
</li>
<li>
<p>Label the secrets.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl label secret <em>CA-CERTIFICATE-SECRET</em> strimzi.io/kind=Kafka strimzi.io/cluster=<em>&lt;cluster_name&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl label secret <em>CA-KEY-SECRET</em> strimzi.io/kind=Kafka strimzi.io/cluster=<em>&lt;cluster_name&gt;</em></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Label <code>strimzi.io/kind=Kafka</code> identifies the Kafka custom resource.</p>
</li>
<li>
<p>Label <code>strimzi.io/cluster=<em>&lt;cluster_name&gt;</em></code> identifies the Kafka cluster.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Annotate the secrets</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate secret <em>CA-CERTIFICATE-SECRET</em> strimzi.io/ca-cert-generation=<em>CA-CERTIFICATE-GENERATION</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate secret <em>CA-KEY-SECRET</em> strimzi.io/ca-key-generation=<em>CA-KEY-GENERATION</em></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Annotation <code>strimzi.io/ca-cert-generation=<em>CA-CERTIFICATE-GENERATION</em></code> defines the generation of a new CA certificate.</p>
</li>
<li>
<p>Annotation <code>strimzi.io/ca-key-generation=<em>CA-KEY-GENERATION</em></code> defines the generation of a new CA key.</p>
<div class="paragraph">
<p>Start from 0 (zero) as the incremental value (<code>strimzi.io/ca-cert-generation=0</code>) for your own CA certificate. Set a higher incremental value when you renew the certificates.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Create the <code>Kafka</code> resource for your cluster, configuring either the <code>Kafka.spec.clusterCa</code> or the <code>Kafka.spec.clientsCa</code> object to <em>not</em> use generated CAs.</p>
<div class="listingblock">
<div class="title">Example fragment <code>Kafka</code> resource configuring the cluster CA to use certificates you supply for yourself</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: Kafka
version: kafka.strimzi.io/v1beta2
spec:
  # ...
  clusterCa:
    generateCertificateAuthority: false</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#renewing-your-own-ca-certificates-str">Renewing your own CA certificates</a></p>
</li>
<li>
<p><a href="#proc-replacing-your-own-private-keys-str">Renewing or replacing CA certificates and private keys with your own</a></p>
</li>
<li>
<p><a href="#proc-installing-certs-per-listener-str">Providing your own Kafka listener certificates for TLS encryption</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="renewing-your-own-ca-certificates-str"><a class="link" href="#renewing-your-own-ca-certificates-str">14.6.2. Renewing your own CA certificates</a></h4>
<div class="paragraph _abstract">
<p>If you are using your own CA certificates, you need to renew them manually.
The Cluster Operator will not renew them automatically.
Renew the CA certificates in the renewal period before they expire.</p>
</div>
<div class="paragraph">
<p>Perform the steps in this procedure when you are renewing CA certificates and continuing with the same private key.
If you are renewing your own CA certificates <em>and</em> private keys, see <a href="#proc-replacing-your-own-private-keys-str">Renewing or replacing CA certificates and private keys with your own</a>.</p>
</div>
<div class="paragraph">
<p>The procedure describes the renewal of CA certificates in PEM format.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is running.</p>
</li>
<li>
<p>You have new cluster or clients X.509 certificates in PEM format.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Update the <code>Secret</code> for the CA certificate.</p>
<div class="paragraph">
<p>Edit the existing secret to add the new CA certificate and update the certificate generation annotation value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit secret <em>&lt;ca_certificate_secret_name&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>&lt;ca_certificate_secret_name&gt;</em> is the name of the <code>Secret</code>, which is <code><em>&lt;kafka_cluster_name&gt;</em>-cluster-ca-cert</code> for the cluster CA certificate and <code><em>&lt;kafka_cluster_name&gt;</em>-clients-ca-cert</code> for the clients CA certificate.</p>
</div>
<div class="paragraph">
<p>The following example shows a secret for a cluster CA certificate that&#8217;s associated with a Kafka cluster named <code>my-cluster</code>.</p>
</div>
<div class="listingblock">
<div class="title">Example secret configuration for a cluster CA certificate</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
data:
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0F... <b class="conum">(1)</b>
metadata:
  annotations:
    strimzi.io/ca-cert-generation: "0" <b class="conum">(2)</b>
  labels:
    strimzi.io/cluster: my-cluster
    strimzi.io/kind: Kafka
  name: my-cluster-cluster-ca-cert
  #...
type: Opaque</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Current base64-encoded CA certificate</p>
</li>
<li>
<p>Current CA certificate generation annotation value</p>
</li>
</ol>
</div>
</li>
<li>
<p>Encode your new CA certificate into base64.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat <em>&lt;path_to_new_certificate&gt;</em> | base64</code></pre>
</div>
</div>
</li>
<li>
<p>Update the CA certificate.</p>
<div class="paragraph">
<p>Copy the base64-encoded CA certificate from the previous step as the value for the <code>ca.crt</code> property under <code>data</code>.</p>
</div>
</li>
<li>
<p>Increase the value of the CA certificate generation annotation.</p>
<div class="paragraph">
<p>Update the <code>strimzi.io/ca-cert-generation</code> annotation with a higher incremental value.
For example, change <code>strimzi.io/ca-cert-generation=0</code> to <code>strimzi.io/ca-cert-generation=1</code>.
If the <code>Secret</code> is missing the annotation, the value is treated as <code>0</code>, so add the annotation with a value of <code>1</code>.</p>
</div>
<div class="paragraph">
<p>When Strimzi generates certificates, the certificate generation annotation is automatically incremented by the Cluster Operator.
For your own CA certificates, set the annotations with a higher incremental value.
The annotation needs a higher value than the one from the current secret so that the Cluster Operator can roll the pods and update the certificates.
The <code>strimzi.io/ca-cert-generation</code> has to be incremented on each CA certificate renewal.</p>
</div>
</li>
<li>
<p>Save the secret with the new CA certificate and certificate generation annotation value.</p>
<div class="listingblock">
<div class="title">Example secret configuration updated with a new CA certificate</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
data:
  ca.crt: GCa6LS3RTHeKFiFDGBOUDYFAZ0F... <b class="conum">(1)</b>
metadata:
  annotations:
    strimzi.io/ca-cert-generation: "1" <b class="conum">(2)</b>
  labels:
    strimzi.io/cluster: my-cluster
    strimzi.io/kind: Kafka
  name: my-cluster-cluster-ca-cert
  #...
type: Opaque</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>New base64-encoded CA certificate</p>
</li>
<li>
<p>New CA certificate generation annotation value</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>On the next reconciliation, the Cluster Operator performs a rolling update of ZooKeeper, Kafka, and other components to trust the new CA certificate.</p>
</div>
<div class="paragraph">
<p>If maintenance time windows are configured, the Cluster Operator will roll the pods at the first reconciliation within the next maintenance time window.</p>
</div>
</div>
<div class="sect3">
<h4 id="proc-replacing-your-own-private-keys-str"><a class="link" href="#proc-replacing-your-own-private-keys-str">14.6.3. Renewing or replacing CA certificates and private keys with your own</a></h4>
<div class="paragraph _abstract">
<p>If you are using your own CA certificates and private keys, you need to renew them manually.
The Cluster Operator will not renew them automatically.
Renew the CA certificates in the renewal period before they expire.
You can also use the same procedure to replace the CA certificates and private keys generated by the Strimzi operators with your own.</p>
</div>
<div class="paragraph">
<p>Perform the steps in this procedure when you are renewing or replacing CA certificates and private keys.
If you are only renewing your own CA certificates, see <a href="#renewing-your-own-ca-certificates-str">Renewing your own CA certificates</a>.</p>
</div>
<div class="paragraph">
<p>The procedure describes the renewal of CA certificates and private keys in PEM format.</p>
</div>
<div class="paragraph">
<p>Before going through the following steps, make sure that the CN (Common Name) of the new CA certificate is different from the current one.
For example, when the Cluster Operator renews certificates automatically it adds a <em>v&lt;version_number&gt;</em> suffix to identify a version.
Do the same with your own CA certificate by adding a different suffix on each renewal.
By using a different key to generate a new CA certificate, you retain the current CA certificate stored in the <code>Secret</code>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is running.</p>
</li>
<li>
<p>You have new cluster or clients X.509 certificates and keys in PEM format.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Pause the reconciliation of the <code>Kafka</code> custom resource.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Annotate the custom resource in Kubernetes, setting the <code>pause-reconciliation</code> annotation to <code>true</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate Kafka <em>&lt;name_of_custom_resource&gt;</em> strimzi.io/pause-reconciliation="true"</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, for a <code>Kafka</code> custom resource named <code>my-cluster</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate Kafka my-cluster strimzi.io/pause-reconciliation="true"</code></pre>
</div>
</div>
</li>
<li>
<p>Check that the status conditions of the custom resource show a change to <code>ReconciliationPaused</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl describe Kafka <em>&lt;name_of_custom_resource&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>type</code> condition changes to <code>ReconciliationPaused</code> at the <code>lastTransitionTime</code>.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Check the settings for the <code>generateCertificateAuthority</code> properties in your <code>Kafka</code> custom resource.</p>
<div class="paragraph">
<p>If a property is set to <code>false</code>, a CA certificate is not generated by the Cluster Operator.
You require this setting if you are using your own certificates.</p>
</div>
</li>
<li>
<p>If needed, edit the existing <code>Kafka</code> custom resource and set the <code>generateCertificateAuthority</code> properties to <code>false</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit Kafka <em>&lt;name_of_custom_resource&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example shows a <code>Kafka</code> custom resource with both cluster and clients CA certificates generation delegated to the user.</p>
</div>
<div class="listingblock">
<div class="title">Example <code>Kafka</code> configuration using your own CA certificates</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
# ...
spec:
# ...
  clusterCa:
    generateCertificateAuthority: false # <b class="conum">(1)</b>
  clientsCa:
    generateCertificateAuthority: false # <b class="conum">(2)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Use your own cluster CA</p>
</li>
<li>
<p>Use your own clients CA</p>
</li>
</ol>
</div>
</li>
<li>
<p>Update the <code>Secret</code> for the CA certificate.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Edit the existing secret to add the new CA certificate and update the certificate generation annotation value.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit secret <em>&lt;ca_certificate_secret_name&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>&lt;ca_certificate_secret_name&gt;</em> is the name of the <code>Secret</code>, which is <code><em>KAFKA-CLUSTER-NAME</em>-cluster-ca-cert</code> for the cluster CA certificate and <code><em>KAFKA-CLUSTER-NAME</em>-clients-ca-cert</code> for the clients CA certificate.</p>
</div>
<div class="paragraph">
<p>The following example shows a secret for a cluster CA certificate that&#8217;s associated with a Kafka cluster named <code>my-cluster</code>.</p>
</div>
<div class="listingblock">
<div class="title">Example secret configuration for a cluster CA certificate</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
data:
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0F... # <b class="conum">(1)</b>
metadata:
  annotations:
    strimzi.io/ca-cert-generation: "0" # <b class="conum">(2)</b>
  labels:
    strimzi.io/cluster: my-cluster
    strimzi.io/kind: Kafka
  name: my-cluster-cluster-ca-cert
  #...
type: Opaque</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Current base64-encoded CA certificate</p>
</li>
<li>
<p>Current CA certificate generation annotation value</p>
</li>
</ol>
</div>
</li>
<li>
<p>Rename the current CA certificate to retain it.</p>
<div class="paragraph">
<p>Rename the current <code>ca.crt</code> property under <code>data</code> as <code>ca-<em>&lt;date&gt;</em>.crt</code>, where <em>&lt;date&gt;</em> is the certificate expiry date in the format <em>YEAR-MONTH-DAYTHOUR-MINUTE-SECONDZ</em>.
For example <code>ca-2023-01-26T17-32-00Z.crt:</code>.
Leave the value for the property as it is to retain the current CA certificate.</p>
</div>
</li>
<li>
<p>Encode your new CA certificate into base64.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat <em>&lt;path_to_new_certificate&gt;</em> | base64</code></pre>
</div>
</div>
</li>
<li>
<p>Update the CA certificate.</p>
<div class="paragraph">
<p>Create a new <code>ca.crt</code> property under <code>data</code> and copy the base64-encoded CA certificate from the previous step as the value for <code>ca.crt</code> property.</p>
</div>
</li>
<li>
<p>Increase the value of the CA certificate generation annotation.</p>
<div class="paragraph">
<p>Update the <code>strimzi.io/ca-cert-generation</code> annotation with a higher incremental value.
For example, change <code>strimzi.io/ca-cert-generation=0</code> to <code>strimzi.io/ca-cert-generation=1</code>.
If the <code>Secret</code> is missing the annotation, the value is treated as <code>0</code>, so add the annotation with a value of <code>1</code>.</p>
</div>
<div class="paragraph">
<p>When Strimzi generates certificates, the certificate generation annotation is automatically incremented by the Cluster Operator.
For your own CA certificates, set the annotations with a higher incremental value.
The annotation needs a higher value than the one from the current secret so that the Cluster Operator can roll the pods and update the certificates.
The <code>strimzi.io/ca-cert-generation</code> has to be incremented on each CA certificate renewal.</p>
</div>
</li>
<li>
<p>Save the secret with the new CA certificate and certificate generation annotation value.</p>
<div class="listingblock">
<div class="title">Example secret configuration updated with a new CA certificate</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
data:
  ca.crt: GCa6LS3RTHeKFiFDGBOUDYFAZ0F... # <b class="conum">(1)</b>
  ca-2023-01-26T17-32-00Z.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0F... # <b class="conum">(2)</b>
metadata:
  annotations:
    strimzi.io/ca-cert-generation: "1" # <b class="conum">(3)</b>
  labels:
    strimzi.io/cluster: my-cluster
    strimzi.io/kind: Kafka
  name: my-cluster-cluster-ca-cert
  #...
type: Opaque</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>New base64-encoded CA certificate</p>
</li>
<li>
<p>Old base64-encoded CA certificate</p>
</li>
<li>
<p>New CA certificate generation annotation value</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Update the <code>Secret</code> for the CA key used to sign your new CA certificate.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Edit the existing secret to add the new CA key and update the key generation annotation value.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit secret <em>&lt;ca_key_name&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>&lt;ca_key_name&gt;</em> is the name of CA key, which is <code><em>&lt;kafka_cluster_name&gt;</em>-cluster-ca</code> for the cluster CA key and <code><em>&lt;kafka_cluster_name&gt;</em>-clients-ca</code> for the clients CA key.</p>
</div>
<div class="paragraph">
<p>The following example shows a secret for a cluster CA key that&#8217;s associated with a Kafka cluster named <code>my-cluster</code>.</p>
</div>
<div class="listingblock">
<div class="title">Example secret configuration for a cluster CA key</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
data:
  ca.key: SA1cKF1GFDzOIiPOIUQBHDNFGDFS... # <b class="conum">(1)</b>
metadata:
  annotations:
    strimzi.io/ca-key-generation: "0" # <b class="conum">(2)</b>
  labels:
    strimzi.io/cluster: my-cluster
    strimzi.io/kind: Kafka
  name: my-cluster-cluster-ca
  #...
type: Opaque</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Current base64-encoded CA key</p>
</li>
<li>
<p>Current CA key generation annotation value</p>
</li>
</ol>
</div>
</li>
<li>
<p>Encode the CA key into base64.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat <em>&lt;path_to_new_key&gt;</em> | base64</code></pre>
</div>
</div>
</li>
<li>
<p>Update the CA key.</p>
<div class="paragraph">
<p>Copy the base64-encoded CA key from the previous step as the value for the <code>ca.key</code> property under <code>data</code>.</p>
</div>
</li>
<li>
<p>Increase the value of the CA key generation annotation.</p>
<div class="paragraph">
<p>Update the <code>strimzi.io/ca-key-generation</code> annotation with a higher incremental value.
For example, change <code>strimzi.io/ca-key-generation=0</code> to <code>strimzi.io/ca-key-generation=1</code>.
If the <code>Secret</code> is missing the annotation, it is treated as <code>0</code>, so add the annotation with a value of <code>1</code>.</p>
</div>
<div class="paragraph">
<p>When Strimzi generates certificates, the key generation annotation is automatically incremented by the Cluster Operator.
For your own CA certificates together with a new CA key, set the annotation with a higher incremental value.
The annotation needs a higher value than the one from the current secret so that the Cluster Operator can roll the pods and update the certificates and keys.
The <code>strimzi.io/ca-key-generation</code> has to be incremented on each CA certificate renewal.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Save the secret with the new CA key and key generation annotation value.</p>
<div class="listingblock">
<div class="title">Example secret configuration updated with a new CA key</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
data:
  ca.key: AB0cKF1GFDzOIiPOIUQWERZJQ0F... # <b class="conum">(1)</b>
metadata:
  annotations:
    strimzi.io/ca-key-generation: "1" # <b class="conum">(2)</b>
  labels:
    strimzi.io/cluster: my-cluster
    strimzi.io/kind: Kafka
  name: my-cluster-cluster-ca
  #...
type: Opaque</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>New base64-encoded CA key</p>
</li>
<li>
<p>New CA key generation annotation value</p>
</li>
</ol>
</div>
</li>
<li>
<p>Resume from the pause.</p>
<div class="paragraph">
<p>To resume the <code>Kafka</code> custom resource reconciliation, set the <code>pause-reconciliation</code> annotation to <code>false</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate --overwrite Kafka <em>&lt;name_of_custom_resource&gt;</em> strimzi.io/pause-reconciliation="false"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also do the same by removing the <code>pause-reconciliation</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate Kafka <em>&lt;name_of_custom_resource&gt;</em> strimzi.io/pause-reconciliation-</code></pre>
</div>
</div>
<div class="paragraph">
<p>On the next reconciliation, the Cluster Operator performs a rolling update of ZooKeeper, Kafka, and other components to trust the new CA certificate.
When the rolling update is complete, the Cluster Operator will start a new one to generate new server certificates signed by the new CA key.</p>
</div>
<div class="paragraph">
<p>If maintenance time windows are configured, the Cluster Operator will roll the pods at the first reconciliation within the next maintenance time window.</p>
</div>
</li>
<li>
<p>Wait until the rolling updates to move to the new CA certificate are complete.</p>
</li>
<li>
<p>Remove any outdated certificates from the secret configuration to ensure that the cluster no longer trusts them.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit secret <em>&lt;ca_certificate_secret_name&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example secret configuration with the old certificate removed</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
data:
  ca.crt: GCa6LS3RTHeKFiFDGBOUDYFAZ0F...
metadata:
  annotations:
    strimzi.io/ca-cert-generation: "1"
  labels:
    strimzi.io/cluster: my-cluster
    strimzi.io/kind: Kafka
  name: my-cluster-cluster-ca-cert
  #...
type: Opaque</code></pre>
</div>
</div>
</li>
<li>
<p>Start a manual rolling update of your cluster to pick up the changes made to the secret configuration.</p>
<div class="paragraph">
<p>See <a href="#assembly-rolling-updates-str">Starting rolling updates of Kafka and other operands using annotations</a>.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-security-providers-str"><a class="link" href="#assembly-security-providers-str">15. Applying security context to Strimzi pods and containers</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Security context defines constraints on pods and containers.
By specifying a security context, pods and containers only have the permissions they need.
For example, permissions can control runtime operations or access to resources.</p>
</div>
<div class="sect2">
<h3 id="con-config-security-providers-str"><a class="link" href="#con-config-security-providers-str">15.1. How to configure security context</a></h3>
<div class="paragraph _abstract">
<p>Use security provider plugins or template configuration to apply security context to Strimzi pods and containers.</p>
</div>
<div class="paragraph">
<p>Apply security context at the pod or container level:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Pod-level security context</dt>
<dd>
<p>Pod-level security context is applied to all containers in a specific pod.</p>
</dd>
<dt class="hdlist1">Container-level security context</dt>
<dd>
<p>Container-level security context is applied to a specific container.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>With Strimzi, security context is applied through one or both of the following methods:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Template configuration</dt>
<dd>
<p>Use <code>template</code> configuration of Strimzi custom resources to specify security context at the pod or container level.</p>
</dd>
<dt class="hdlist1">Pod security provider plugins</dt>
<dd>
<p>Use pod security provider plugins to automatically set security context across all pods and containers using preconfigured settings.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Pod security providers offer a simpler alternative to specifying security context through <code>template</code> configuration.
You can use both approaches.
The <code>template</code> approach has a higher priority.
Security context configured through <code>template</code> properties overrides the configuration set by pod security providers.
So you might use pod security providers to automatically configure the security context for most containers.
And also use <code>template</code> configuration to set container-specific security context where needed.</p>
</div>
<div class="paragraph">
<p>The <code>template</code> approach provides flexibility, but it also means you have to configure security context in numerous places to capture the security you want for all pods and containers.
For example, you&#8217;ll need to apply the configuration to each pod in a Kafka cluster, as well as the pods for deployments of other Kafka components.</p>
</div>
<div class="paragraph">
<p>To avoid repeating the same configuration, you can use the following pod security provider plugins so that the security configuration is in one place.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Baseline Provider</dt>
<dd>
<p>The Baseline Provider is based on the Kubernetes <em>baseline</em> security profile. The baseline profile prevents privilege escalations and defines other standard access controls and limitations.</p>
</dd>
<dt class="hdlist1">Restricted Provider</dt>
<dd>
<p>The Restricted Provider is based on the Kubernetes <em>restricted</em> security profile. The restricted profile is more restrictive than the baseline profile, and is used where security needs to be tighter.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For more information on the Kubernetes security profiles, see <a href="https://kubernetes.io/docs/concepts/security/pod-security-standards/" target="_blank" rel="noopener">Pod security standards</a>.</p>
</div>
<div class="sect3">
<h4 id="template_configuration_for_security_context"><a class="link" href="#template_configuration_for_security_context">15.1.1. Template configuration for security context</a></h4>
<div class="paragraph">
<p>In the following example, security context is configured for Kafka brokers in the <code>template</code> configuration of the <code>Kafka</code> resource.
Security context is specified at the pod and container level.</p>
</div>
<div class="listingblock">
<div class="title">Example <code>template</code> configuration for security context</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  # ...
  kafka:
    template:
      pod: # <b class="conum">(1)</b>
        securityContext:
          runAsUser: 1000001
          fsGroup: 0
      kafkaContainer: # <b class="conum">(2)</b>
        securityContext:
          runAsUser: 2000
  # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Pod security context</p>
</li>
<li>
<p>Container security context of the Kafka broker container</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="baseline_provider_for_pod_security"><a class="link" href="#baseline_provider_for_pod_security">15.1.2. Baseline Provider for pod security</a></h4>
<div class="paragraph">
<p>The Baseline Provider is the default pod security provider.
It configures the pods managed by Strimzi with a baseline security profile.
The baseline profile is compatible with previous versions of Strimzi.</p>
</div>
<div class="paragraph">
<p>The Baseline Provider is enabled by default if you don&#8217;t specify a provider.
Though you can enable it explicitly by setting the <code>STRIMZI_POD_SECURITY_PROVIDER_CLASS</code> environment variable to <code>baseline</code> when configuring the Cluster Operator.</p>
</div>
<div class="listingblock">
<div class="title">Configuration for the Baseline Provider</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml"># ...
env:
  # ...
  - name: STRIMZI_POD_SECURITY_PROVIDER_CLASS
    value: baseline
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of specifying <code>baseline</code> as the value, you can specify the <code>io.strimzi.plugin.security.profiles.impl.BaselinePodSecurityProvider</code> fully-qualified domain name.</p>
</div>
</div>
<div class="sect3">
<h4 id="restricted_provider_for_pod_security"><a class="link" href="#restricted_provider_for_pod_security">15.1.3. Restricted Provider for pod security</a></h4>
<div class="paragraph">
<p>The Restricted Provider provides a higher level of security than the Baseline Provider.
It configures the pods managed by Strimzi with a restricted security profile.</p>
</div>
<div class="paragraph">
<p>You enable the Restricted Provider by setting the <code>STRIMZI_POD_SECURITY_PROVIDER_CLASS</code> environment variable to <code>restricted</code> when configuring the Cluster Operator.</p>
</div>
<div class="listingblock">
<div class="title">Configuration for the Restricted Provider</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml"># ...
env:
  # ...
  - name: STRIMZI_POD_SECURITY_PROVIDER_CLASS
    value: restricted
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of specifying <code>restricted</code> as the value, you can specify the <code>io.strimzi.plugin.security.profiles.impl.RestrictedPodSecurityProvider</code> fully-qualified domain name.</p>
</div>
<div class="paragraph">
<p>If you change to the Restricted Provider from the default Baseline Provider, the following restrictions are implemented in addition to the constraints defined in the baseline security profile:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Limits allowed volume types</p>
</li>
<li>
<p>Disallows privilege escalation</p>
</li>
<li>
<p>Requires applications to run under a non-root user</p>
</li>
<li>
<p>Requires <code>seccomp</code> (secure computing mode) profiles to be set as <code>RuntimeDefault</code> or <code>Localhost</code></p>
</li>
<li>
<p>Limits container capabilities to use only the <code>NET_BIND_SERVICE</code> capability</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With the Restricted Provider enabled, containers created by the Cluster Operator are set with the following security context.</p>
</div>
<div class="listingblock">
<div class="title">Cluster Operator with restricted security context configuration</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml"># ...
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  runAsNonRoot: true
  seccompProfile:
    type: RuntimeDefault
# ...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Container capabilities and <code>seccomp</code> are Linux kernel features that support container security.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Capabilities add fine-grained privileges for processes running on a container. The <code>NET_BIND_SERVICE</code> capability allows non-root user applications to bind to ports below 1024.</p>
</li>
<li>
<p><code>seccomp</code> profiles limit the processes running in a container to only a subset of system calls.
The <code>RuntimeDefault</code> profile provides a default set of system calls.
A <code>LocalHost</code> profile uses a profile defined in a file on the node.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/" target="_blank" rel="noopener">Security context</a> on Kubernetes</p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/security/pod-security-standards/" target="_blank" rel="noopener">Pod security standards</a> on Kubernetes (including profile descriptions)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="proc-config-restricted-security-providers-str"><a class="link" href="#proc-config-restricted-security-providers-str">15.2. Enabling the Restricted Provider for the Cluster Operator</a></h3>
<div class="paragraph _abstract">
<p>Security pod providers configure the security context constraints of the pods and containers created by the Cluster Operator.
The Baseline Provider is the default pod security provider used by Strimzi.
You can switch to the Restricted Provider by changing the <code>STRIMZI_POD_SECURITY_PROVIDER_CLASS</code> environment variable in the Cluster Operator configuration.</p>
</div>
<div class="paragraph">
<p>To make the required changes, configure the <code>060-Deployment-strimzi-cluster-operator.yaml</code> Cluster Operator installation file located in <code>install/cluster-operator/</code>.</p>
</div>
<div class="paragraph">
<p>By enabling a new pod security provider, any pods or containers created by the Cluster Operator are subject to the limitations it imposes.
Pods and containers that are already running are restarted for the changes to take affect.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You need an account with permission to create and manage <code>CustomResourceDefinition</code> and RBAC (<code>ClusterRole</code>, and <code>RoleBinding</code>) resources.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Edit the <code>Deployment</code> resource that is used to deploy the Cluster Operator, which is defined in the <code>060-Deployment-strimzi-cluster-operator.yaml</code> file.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add or amend the <code>STRIMZI_POD_SECURITY_PROVIDER_CLASS</code> environment variable with a value of <code>restricted</code>.</p>
<div class="listingblock">
<div class="title">Cluster Operator configuration for the Restricted Provider</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml"># ...
env:
  # ...
  - name: STRIMZI_POD_SECURITY_PROVIDER_CLASS
    value: restricted
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or you can specify the <code>io.strimzi.plugin.security.profiles.impl.RestrictedPodSecurityProvider</code> fully-qualified domain name.</p>
</div>
</li>
<li>
<p>Deploy the Cluster Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/cluster-operator -n myproject</code></pre>
</div>
</div>
</li>
<li>
<p>(Optional) Use <code>template</code> configuration to set security context for specific components at the pod or container level.</p>
<div class="listingblock">
<div class="title">Adding security context through <code>template</code> configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">template:
  pod:
    securityContext:
      runAsUser: 1000001
      fsGroup: 0
  kafkaContainer:
    securityContext:
    runAsUser: 2000
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you apply specific security context for a component using <code>template</code> configuration, it takes priority over the general configuration provided by the pod security provider.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="con-config-custom-security-providers-str"><a class="link" href="#con-config-custom-security-providers-str">15.3. Implementing a custom pod security provider</a></h3>
<div class="paragraph _abstract">
<p>If Strimzi&#8217;s Baseline Provider and Restricted Provider don&#8217;t quite match your needs, you can develop a custom pod security provider to deliver all-encompassing pod and container security context constraints.</p>
</div>
<div class="paragraph">
<p>Implement a custom pod security provider to apply your own security context profile.
You can decide what applications and privileges to include in the profile.</p>
</div>
<div class="paragraph">
<p>Your custom pod security provider can implement the <code>PodSecurityProvider.java</code> interface that gets the security context for pods and containers; or it can extend the Baseline Provider or Restricted Provider classes.</p>
</div>
<div class="paragraph">
<p>The pod security provider plugins use the Java Service Provider Interface, so your custom pod security provider also requires a provider configuration file for service discovery.</p>
</div>
<div class="paragraph">
<p>To implement your own provider, the general steps include the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Build the JAR file for the provider.</p>
</li>
<li>
<p>Add the JAR file to the Cluster Operator image.</p>
</li>
<li>
<p>Specify the custom pod security provider when setting the Cluster Operator environment variable <code>STRIMZI_POD_SECURITY_PROVIDER_CLASS</code>.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://github.com/strimzi/strimzi-kafka-operator/blob/main/api/src/main/java/io/strimzi/plugin/security/profiles/PodSecurityProvider.java" target="_blank" rel="noopener">Pod security provider interface</a></p>
</li>
<li>
<p><a href="https://github.com/strimzi/strimzi-kafka-operator/tree/main/api/src/main/java/io/strimzi/plugin/security/profiles/impl" target="_blank" rel="noopener">Baseline Provider and Restricted Provider classes</a></p>
</li>
<li>
<p><a href="https://github.com/strimzi/strimzi-kafka-operator/blob/main/api/src/main/resources/META-INF/services/io.strimzi.plugin.security.profiles.PodSecurityProvider" target="_blank" rel="noopener">Provider configuration file</a></p>
</li>
<li>
<p><a href="https://www.baeldung.com/java-spi" target="_blank" rel="noopener">Java Service Provider Interface</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="con-config-openshift-security-providers-str"><a class="link" href="#con-config-openshift-security-providers-str">15.4. Handling of security context by Kubernetes platform</a></h3>
<div class="paragraph _abstract">
<p>Handling of security context depends on the tooling of the Kubernetes platform you are using.</p>
</div>
<div class="paragraph">
<p>For example, OpenShift uses built-in security context constraints (SCCs) to control permissions.
SCCs are the settings and strategies that control the security features a pod has access to.</p>
</div>
<div class="paragraph">
<p>By default, OpenShift injects security context configuration automatically.
In most cases, this means you don&#8217;t need to configure security context for the pods and containers created by the Cluster Operator.
Although you can still create and manage your own SCCs.</p>
</div>
<div class="paragraph">
<p>For more information, see the <a href="https://docs.openshift.com" target="_blank" rel="noopener">OpenShift documentation</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="con-scaling-kafka-clusters-str"><a class="link" href="#con-scaling-kafka-clusters-str">16. Scaling clusters by adding or removing brokers</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Scaling Kafka clusters by adding brokers can increase the performance and reliability of the cluster.
Adding more brokers increases available resources, allowing the cluster to handle larger workloads and process more messages.
It can also improve fault tolerance by providing more replicas and backups.
Conversely, removing underutilized brokers can reduce resource consumption and improve efficiency.
Scaling must be done carefully to avoid disruption or data loss.
By redistributing partitions across all brokers in the cluster, the resource utilization of each broker is reduced, which can increase the overall throughput of the cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
To increase the throughput of a Kafka topic, you can increase the number of partitions for that topic.
This allows the load of the topic to be shared between different brokers in the cluster.
However, if every broker is constrained by a specific resource (such as I/O), adding more partitions will not increase the throughput.
In this case, you need to add more brokers to the cluster.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Adjusting the <code>Kafka.spec.kafka.replicas</code> configuration affects the number of brokers in the cluster that act as replicas.
The actual replication factor for topics is determined by settings for the <code>default.replication.factor</code> and <code>min.insync.replicas</code>, and the number of available brokers.
For example, a replication factor of 3 means that each partition of a topic is replicated across three brokers, ensuring fault tolerance in the event of a broker failure.</p>
</div>
<div class="listingblock">
<div class="title">Example replica configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    replicas: 3
    # ...
  config:
      # ...
      default.replication.factor: 3
      min.insync.replicas: 2
 # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>When adding brokers through the <code>Kafka</code> configuration, node IDs start at 0 (zero) and the Cluster Operator assigns the next lowest ID to a new node.
The broker removal process starts from the broker pod with the highest ID in the cluster.</p>
</div>
<div class="paragraph">
<p>If you are managing nodes in the cluster using the the preview of the node pools feature, you adjust the <code>KafkaNodePool.spec.replicas</code> configuration to change the number of nodes in the node pool.
Additionally, when scaling existing clusters with node pools, you can <a href="#proc-managing-node-pools-ids-str">assign node IDs for the scaling operations</a>.</p>
</div>
<div class="paragraph">
<p>When you add add or remove brokers, Kafka does not automatically reassign partitions.
The best way to do this is using Cruise Control.
You can use Cruise Control&#8217;s <code>add-brokers</code> and <code>remove-brokers</code> modes when scaling a cluster up or down.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the <code>add-brokers</code> mode after scaling up a Kafka cluster to move partition replicas from existing brokers to the newly added brokers.</p>
</li>
<li>
<p>Use the <code>remove-brokers</code> mode before scaling down a Kafka cluster to move partition replicas off the brokers that are going to be removed.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="con-skipping-scale-down-checks-str"><a class="link" href="#con-skipping-scale-down-checks-str">16.1. Skipping checks on scale-down operations</a></h3>
<div class="paragraph _abstract">
<p>By default, Strimzi performs a check to ensure that there are no partition replicas on a broker before initiating a scale-down operation on a Kafka cluster.
If replicas are found, cluster operations are blocked to prevent potential data loss.
To resume cluster operations, no replicas must be left on the broker before trying to scale it down again.</p>
</div>
<div class="paragraph">
<p>However, there may be scenarios where you want to bypass this blocking mechanism.
Disabling the check might be necessary on busy clusters, for example, because new topics keep generating replicas for the broker.
This situation can indefinitely block cluster operations, even when brokers are nearly empty.
Overriding the blocking mechanism in this way has an impact:
the presence of topics on the broker being scaled down will likely cause a reconciliation failure for the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>You can bypass the blocking mechanism by annotating the <code>Kafka</code> resource for the Kafka cluster.
Annotate the resource by setting the <code>strimzi.io/skip-broker-scaledown-check</code> annotation to <code>true</code>:</p>
</div>
<div class="listingblock">
<div class="title">Adding the annotation to skip checks on scale-down operations</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate Kafka my-kafka-cluster strimzi.io/skip-broker-scaledown-check="true"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This annotation instructs Strimzi to skip the scale-down check.
Replace <code>my-kafka-cluster</code> with the name of your specific <code>Kafka</code> resource.</p>
</div>
<div class="paragraph">
<p>To restore the check for scale-down operations, remove the annotation:</p>
</div>
<div class="listingblock">
<div class="title">Removing the annotation to skip checks on scale-down operations</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate Kafka my-kafka-cluster strimzi.io/skip-broker-scaledown-check-</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cruise-control-concepts-str"><a class="link" href="#cruise-control-concepts-str">17. Rebalancing clusters using Cruise Control</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Cruise Control is an open source system that supports the following Kafka operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Monitoring cluster workload</p>
</li>
<li>
<p>Rebalancing a cluster based on predefined constraints</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The operations help with running a more balanced Kafka cluster that uses broker pods more efficiently.</p>
</div>
<div class="paragraph">
<p>A typical cluster can become unevenly loaded over time.
Partitions that handle large amounts of message traffic might not be evenly distributed across the available brokers.
To rebalance the cluster, administrators must monitor the load on brokers and manually reassign busy partitions to brokers with spare capacity.</p>
</div>
<div class="paragraph">
<p>Cruise Control automates the cluster rebalancing process.
It constructs a <em>workload model</em> of resource utilization for the cluster&#8212;&#8203;based on CPU, disk, and network load&#8212;&#8203;and generates optimization proposals (that you can approve or reject) for more balanced partition assignments.
A set of configurable optimization goals is used to calculate these proposals.</p>
</div>
<div class="paragraph">
<p>You can generate optimization proposals in specific modes.
The default <code>full</code> mode rebalances partitions across all brokers.
You can also use the <code>add-brokers</code> and <code>remove-brokers</code> modes to accommodate changes when scaling a cluster up or down.</p>
</div>
<div class="paragraph">
<p>When you approve an optimization proposal, Cruise Control applies it to your Kafka cluster.
You configure and generate optimization proposals using a <code>KafkaRebalance</code> resource.
You can configure the resource using an annotation so that optimization proposals are approved automatically or manually.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Strimzi provides <a href="#config-examples-str">example configuration files for Cruise Control</a>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="con-cruise-control-overview-str"><a class="link" href="#con-cruise-control-overview-str">17.1. Cruise Control components and features</a></h3>
<div class="paragraph _abstract">
<p>Cruise Control consists of four main components&#8212;&#8203;the Load Monitor, the Analyzer, the Anomaly Detector, and the Executor&#8212;&#8203;and a REST API for client interactions.
Strimzi utilizes the REST API to support the following Cruise Control features:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Generating optimization proposals from optimization goals.</p>
</li>
<li>
<p>Rebalancing a Kafka cluster based on an optimization proposal.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Optimization goals</dt>
<dd>
<p>An optimization goal describes a specific objective to achieve from a rebalance.
For example, a goal might be to distribute topic replicas across brokers more evenly.
You can change what goals to include through configuration.
A goal is defined as a hard goal or soft goal.
You can add hard goals through Cruise Control deployment configuration.
You also have main, default, and user-provided goals that fit into each of these categories.</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><strong>Hard goals</strong> are preset and must be satisfied for an optimization proposal to be successful.</p>
</li>
<li>
<p><strong>Soft goals</strong> do not need to be satisfied for an optimization proposal to be successful.
They can be set aside if it means that all hard goals are met.</p>
</li>
<li>
<p><strong>Main goals</strong> are inherited from Cruise Control. Some are preset as hard goals.
Main goals are used in optimization proposals by default.</p>
</li>
<li>
<p><strong>Default goals</strong> are the same as the main goals by default.
You can specify your own set of default goals.</p>
</li>
<li>
<p><strong>User-provided goals</strong> are a subset of default goals that are configured for generating a specific optimization proposal.</p>
</li>
</ul>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">Optimization proposals</dt>
<dd>
<p>Optimization proposals comprise the goals you want to achieve from a rebalance.
You generate an optimization proposal to create a summary of proposed changes and the results that are possible with the rebalance.
The goals are assessed in a specific order of priority.
You can then choose to approve or reject the proposal.
You can reject the proposal to run it again with an adjusted set of goals.</p>
<div class="paragraph">
<p>You can generate an optimization proposal in one of three modes.</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><strong><code>full</code></strong> is the default mode and runs a full rebalance.</p>
</li>
<li>
<p><strong><code>add-brokers</code></strong> is the mode you use after adding brokers when scaling up a Kafka cluster.</p>
</li>
<li>
<p><strong><code>remove-brokers</code></strong> is the mode you use before removing brokers when scaling down a Kafka cluster.</p>
</li>
</ul>
</div>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Other Cruise Control features are not currently supported, including self healing, notifications, write-your-own goals, and changing the topic replication factor.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://github.com/linkedin/cruise-control/wiki/Configurations" target="_blank" rel="noopener">Cruise Control documentation</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="con-optimization-goals-str"><a class="link" href="#con-optimization-goals-str">17.2. Optimization goals overview</a></h3>
<div class="paragraph _abstract">
<p>Optimization goals are constraints on workload redistribution and resource utilization across a Kafka cluster.
To rebalance a Kafka cluster, Cruise Control uses optimization goals to generate <a href="#con-optimization-proposals-str">optimization proposals</a>, which you can approve or reject.</p>
</div>
<div class="sect3">
<h4 id="goals_order_of_priority"><a class="link" href="#goals_order_of_priority">17.2.1. Goals order of priority</a></h4>
<div class="paragraph">
<p>Strimzi supports most of the optimization goals developed in the Cruise Control project.
The supported goals, in the default descending order of priority, are as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Rack-awareness</p>
</li>
<li>
<p>Minimum number of leader replicas per broker for a set of topics</p>
</li>
<li>
<p>Replica capacity</p>
</li>
<li>
<p>Capacity goals</p>
<div class="ulist">
<ul>
<li>
<p>Disk capacity</p>
</li>
<li>
<p>Network inbound capacity</p>
</li>
<li>
<p>Network outbound capacity</p>
</li>
<li>
<p>CPU capacity</p>
</li>
</ul>
</div>
</li>
<li>
<p>Replica distribution</p>
</li>
<li>
<p>Potential network output</p>
</li>
<li>
<p>Resource distribution goals</p>
<div class="ulist">
<ul>
<li>
<p>Disk utilization distribution</p>
</li>
<li>
<p>Network inbound utilization distribution</p>
</li>
<li>
<p>Network outbound utilization distribution</p>
</li>
<li>
<p>CPU utilization distribution</p>
</li>
</ul>
</div>
</li>
<li>
<p>Leader bytes-in rate distribution</p>
</li>
<li>
<p>Topic replica distribution</p>
</li>
<li>
<p>Leader replica distribution</p>
</li>
<li>
<p>Preferred leader election</p>
</li>
<li>
<p>Intra-broker disk capacity</p>
</li>
<li>
<p>Intra-broker disk usage distribution</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For more information on each optimization goal, see <a href="https://github.com/linkedin/cruise-control/wiki/Pluggable-Components#goals" target="_blank" rel="noopener">Goals</a> in the Cruise Control Wiki.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
"Write your own" goals and Kafka assigner goals are not yet supported.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="goals_configuration_in_strimzi_custom_resources"><a class="link" href="#goals_configuration_in_strimzi_custom_resources">17.2.2. Goals configuration in Strimzi custom resources</a></h4>
<div class="paragraph">
<p>You configure optimization goals in <code>Kafka</code> and <code>KafkaRebalance</code> custom resources.
Cruise Control has configurations for hard optimization goals that must be satisfied, as well as main, default, and user-provided optimization goals.</p>
</div>
<div class="paragraph">
<p>You can specify optimization goals in the following configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Main goals</strong>&#8201;&#8212;&#8201;<code>Kafka.spec.cruiseControl.config.goals</code></p>
</li>
<li>
<p><strong>Hard goals</strong>&#8201;&#8212;&#8201;<code>Kafka.spec.cruiseControl.config.hard.goals</code></p>
</li>
<li>
<p><strong>Default goals</strong>&#8201;&#8212;&#8201;<code>Kafka.spec.cruiseControl.config.default.goals</code></p>
</li>
<li>
<p><strong>User-provided goals</strong>&#8201;&#8212;&#8201;<code>KafkaRebalance.spec.goals</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Resource distribution goals are subject to <a href="./configuring.html#property-cruise-control-broker-capacity-reference" target="_blank" rel="noopener">capacity limits</a> on broker resources.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="hard-soft-goals"><a class="link" href="#hard-soft-goals">17.2.3. Hard and soft optimization goals</a></h4>
<div class="paragraph">
<p>Hard goals are goals that <em>must</em> be satisfied in optimization proposals.
Goals that are not configured as hard goals are known as <em>soft goals</em>.
You can think of soft goals as <em>best effort</em> goals: they do <em>not</em> need to be satisfied in optimization proposals, but are included in optimization calculations.
An optimization proposal that violates one or more soft goals, but satisfies all hard goals, is valid.</p>
</div>
<div class="paragraph">
<p>Cruise Control will calculate optimization proposals that satisfy all the hard goals and as many soft goals as possible (in their priority order).
An optimization proposal that does <em>not</em> satisfy all the hard goals is rejected by Cruise Control and not sent to the user for approval.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
For example, you might have a soft goal to distribute a topic&#8217;s replicas evenly across the cluster (the topic replica distribution goal).
Cruise Control will ignore this goal if doing so enables all the configured hard goals to be met.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In Cruise Control, the following <a href="#main-goals">main optimization goals</a> are preset as hard goals:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">RackAwareGoal; ReplicaCapacityGoal; DiskCapacityGoal; NetworkInboundCapacityGoal; NetworkOutboundCapacityGoal; CpuCapacityGoal</code></pre>
</div>
</div>
<div class="paragraph">
<p>You configure hard goals in the Cruise Control deployment configuration, by editing the <code>hard.goals</code> property in <code>Kafka.spec.cruiseControl.config</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To inherit the preset hard goals from Cruise Control, do not specify the <code>hard.goals</code> property in <code>Kafka.spec.cruiseControl.config</code></p>
</li>
<li>
<p>To change the preset hard goals, specify the desired goals in the <code>hard.goals</code> property, using their fully-qualified domain names.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example <code>Kafka</code> configuration for hard optimization goals</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
  zookeeper:
    # ...
  entityOperator:
    topicOperator: {}
    userOperator: {}
  cruiseControl:
    brokerCapacity:
      inboundNetwork: 10000KB/s
      outboundNetwork: 10000KB/s
    config:
      # Note that `default.goals` (superset) must also include all `hard.goals` (subset)
      default.goals: &gt;
        com.linkedin.kafka.cruisecontrol.analyzer.goals.NetworkInboundCapacityGoal,
        com.linkedin.kafka.cruisecontrol.analyzer.goals.NetworkOutboundCapacityGoal
      hard.goals: &gt;
        com.linkedin.kafka.cruisecontrol.analyzer.goals.NetworkInboundCapacityGoal,
        com.linkedin.kafka.cruisecontrol.analyzer.goals.NetworkOutboundCapacityGoal
      # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Increasing the number of configured hard goals will reduce the likelihood of Cruise Control generating valid optimization proposals.</p>
</div>
<div class="paragraph">
<p>If <code>skipHardGoalCheck: true</code> is specified in the <code>KafkaRebalance</code> custom resource, Cruise Control does <em>not</em> check that the list of user-provided optimization goals (in <code>KafkaRebalance.spec.goals</code>) contains <em>all</em> the configured hard goals (<code>hard.goals</code>).
Therefore, if some, but not all, of the user-provided optimization goals are in the <code>hard.goals</code> list, Cruise Control will still treat them as hard goals even if <code>skipHardGoalCheck: true</code> is specified.</p>
</div>
</div>
<div class="sect3">
<h4 id="main-goals"><a class="link" href="#main-goals">17.2.4. Main optimization goals</a></h4>
<div class="paragraph">
<p>The <em>main optimization goals</em> are available to all users.
Goals that are not listed in the main optimization goals are not available for use in Cruise Control operations.</p>
</div>
<div class="paragraph">
<p>Unless you change the Cruise Control <a href="#proc-configuring-deploying-cruise-control-str">deployment configuration</a>, Strimzi will inherit the following main optimization goals from Cruise Control, in descending priority order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">RackAwareGoal; MinTopicLeadersPerBrokerGoal; ReplicaCapacityGoal; DiskCapacityGoal; NetworkInboundCapacityGoal; NetworkOutboundCapacityGoal; CpuCapacityGoal; ReplicaDistributionGoal; PotentialNwOutGoal; DiskUsageDistributionGoal; NetworkInboundUsageDistributionGoal; NetworkOutboundUsageDistributionGoal; CpuUsageDistributionGoal; TopicReplicaDistributionGoal; LeaderReplicaDistributionGoal; LeaderBytesInDistributionGoal; PreferredLeaderElectionGoal</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some of these goals are preset as <a href="#hard-soft-goals">hard goals</a>.</p>
</div>
<div class="paragraph">
<p>To reduce complexity, we recommend that you use the inherited main optimization goals, unless you need to <em>completely</em> exclude one or more goals from use in <code>KafkaRebalance</code> resources. The priority order of the main optimization goals can be modified, if desired, in the configuration for <a href="#default-goals">default optimization goals</a>.</p>
</div>
<div class="paragraph">
<p>You configure main optimization goals, if necessary, in the Cruise Control deployment configuration: <code>Kafka.spec.cruiseControl.config.goals</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>To accept the inherited main optimization goals, do not specify the <code>goals</code> property in <code>Kafka.spec.cruiseControl.config</code>.</p>
</li>
<li>
<p>If you need to modify the inherited main optimization goals, specify a list of goals, in descending priority order, in the <code>goals</code> configuration option.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
To avoid errors when generating optimization proposals, make sure that any changes you make to the <code>goals</code> or <code>default.goals</code> in <code>Kafka.spec.cruiseControl.config</code> include all of the hard goals specified for the <code>hard.goals</code> property. To clarify, the hard goals must also be specified (as a subset) for the main optimization goals and default goals.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="default-goals"><a class="link" href="#default-goals">17.2.5. Default optimization goals</a></h4>
<div class="paragraph">
<p>Cruise Control uses the <em>default optimization goals</em> to generate the <em>cached optimization proposal</em>.
For more information about the cached optimization proposal, see <a href="#con-optimization-proposals-str">Optimization proposals overview</a>.</p>
</div>
<div class="paragraph">
<p>You can override the default optimization goals by setting <a href="#user-provided-goals">user-provided optimization goals</a> in a <code>KafkaRebalance</code> custom resource.</p>
</div>
<div class="paragraph">
<p>Unless you specify <code>default.goals</code> in the Cruise Control <a href="#proc-configuring-deploying-cruise-control-str">deployment configuration</a>, the main optimization goals are used as the default optimization goals.
In this case, the cached optimization proposal is generated using the main optimization goals.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To use the main optimization goals as the default goals, do not specify the <code>default.goals</code> property in <code>Kafka.spec.cruiseControl.config</code>.</p>
</li>
<li>
<p>To modify the default optimization goals, edit the <code>default.goals</code> property in <code>Kafka.spec.cruiseControl.config</code>.
You must use a subset of the main optimization goals.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example <code>Kafka</code> configuration for default optimization goals</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
  zookeeper:
    # ...
  entityOperator:
    topicOperator: {}
    userOperator: {}
  cruiseControl:
    brokerCapacity:
      inboundNetwork: 10000KB/s
      outboundNetwork: 10000KB/s
    config:
      # Note that `default.goals` (superset) must also include all `hard.goals` (subset)
      default.goals: &gt;
        com.linkedin.kafka.cruisecontrol.analyzer.goals.RackAwareGoal,
        com.linkedin.kafka.cruisecontrol.analyzer.goals.ReplicaCapacityGoal,
        com.linkedin.kafka.cruisecontrol.analyzer.goals.DiskCapacityGoal
      hard.goals: &gt;
        com.linkedin.kafka.cruisecontrol.analyzer.goals.RackAwareGoal
      # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>If no default optimization goals are specified, the cached proposal is generated using the main optimization goals.</p>
</div>
</div>
<div class="sect3">
<h4 id="user-provided-goals"><a class="link" href="#user-provided-goals">17.2.6. User-provided optimization goals</a></h4>
<div class="paragraph">
<p><em>User-provided optimization goals</em> narrow down the configured default goals for a particular optimization proposal.
You can set them, as required, in <code>spec.goals</code> in a <code>KafkaRebalance</code> custom resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>KafkaRebalance.spec.goals</pre>
</div>
</div>
<div class="paragraph">
<p>User-provided optimization goals can generate optimization proposals for different scenarios.
For example, you might want to optimize leader replica distribution across the Kafka cluster without considering disk capacity or disk utilization.
So, you create a <code>KafkaRebalance</code> custom resource containing a single user-provided goal for leader replica distribution.</p>
</div>
<div class="paragraph">
<p>User-provided optimization goals must:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Include all configured <a href="#hard-soft-goals">hard goals</a>, or an error occurs</p>
</li>
<li>
<p>Be a subset of the main optimization goals</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To ignore the configured hard goals when generating an optimization proposal, add the <code>skipHardGoalCheck: true</code> property to the <code>KafkaRebalance</code> custom resource. See <a href="#proc-generating-optimization-proposals-str">Generating optimization proposals</a>.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#proc-configuring-deploying-cruise-control-str">Configuring and deploying Cruise Control with Kafka</a></p>
</li>
<li>
<p><a href="https://github.com/linkedin/cruise-control/wiki/Configurations" target="_blank" rel="noopener">Configurations</a> in the Cruise Control Wiki.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-optimization-proposals-str"><a class="link" href="#con-optimization-proposals-str">17.3. Optimization proposals overview</a></h3>
<div class="paragraph _abstract">
<p>Configure a <code>KafkaRebalance</code> resource to generate optimization proposals and apply the suggested changes.
An <em>optimization proposal</em> is a summary of proposed changes that would produce a more balanced Kafka cluster, with partition workloads distributed more evenly among the brokers.</p>
</div>
<div class="paragraph">
<p>Each optimization proposal is based on the set of <a href="#con-optimization-goals-str">optimization goals</a> that was used to generate it, subject to any configured <a href="./configuring.html#property-cruise-control-broker-capacity-reference">capacity limits on broker resources</a>.</p>
</div>
<div class="paragraph">
<p>All optimization proposals are <em>estimates</em> of the impact of a proposed rebalance.
You can approve or reject a proposal.
You cannot approve a cluster rebalance without first generating the optimization proposal.</p>
</div>
<div class="paragraph">
<p>You can run optimization proposals in one of the following rebalancing modes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>full</code></p>
</li>
<li>
<p><code>add-brokers</code></p>
</li>
<li>
<p><code>remove-brokers</code></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="con-optimization-proposals-modes-str"><a class="link" href="#con-optimization-proposals-modes-str">17.3.1. Rebalancing modes</a></h4>
<div class="paragraph">
<p>You specify a rebalancing mode using the <code>spec.mode</code> property of the <code>KafkaRebalance</code> custom resource.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>full</code></dt>
<dd>
<p>The <code>full</code> mode runs a full rebalance by moving replicas across all the brokers in the cluster.
This is the default mode if the <code>spec.mode</code> property is not defined in the <code>KafkaRebalance</code> custom resource.</p>
</dd>
<dt class="hdlist1"><code>add-brokers</code></dt>
<dd>
<p>The <code>add-brokers</code> mode is used after scaling up a Kafka cluster by adding one or more brokers.
Normally, after scaling up a Kafka cluster, new brokers are used to host only the partitions of newly created topics.
If no new topics are created, the newly added brokers are not used and the existing brokers remain under the same load.
By using the <code>add-brokers</code> mode immediately after adding brokers to the cluster, the rebalancing operation moves replicas from existing brokers to the newly added brokers.
You specify the new brokers as a list using the <code>spec.brokers</code> property of the <code>KafkaRebalance</code> custom resource.</p>
</dd>
<dt class="hdlist1"><code>remove-brokers</code></dt>
<dd>
<p>The <code>remove-brokers</code> mode is used before scaling down a Kafka cluster by removing one or more brokers.
If you scale down a Kafka cluster, brokers are shut down even if they host replicas.
This can lead to under-replicated partitions and possibly result in some partitions being under their minimum ISR (in-sync replicas).
To avoid this potential problem, the <code>remove-brokers</code> mode moves replicas off the brokers that are going to be removed.
When these brokers are not hosting replicas anymore, you can safely run the scaling down operation.
You specify the brokers you&#8217;re removing as a list in the <code>spec.brokers</code> property in the <code>KafkaRebalance</code> custom resource.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In general, use the <code>full</code> rebalance mode to rebalance a Kafka cluster by spreading the load across brokers.
Use the <code>add-brokers</code> and <code>remove-brokers</code> modes only if you want to scale your cluster up or down and rebalance the replicas accordingly.</p>
</div>
<div class="paragraph">
<p>The procedure to run a rebalance is actually the same across the three different modes.
The only difference is with specifying a mode through the <code>spec.mode</code> property and, if needed, listing brokers that have been added or will be removed through the <code>spec.brokers</code> property.</p>
</div>
</div>
<div class="sect3">
<h4 id="contents-optimization-proposals"><a class="link" href="#contents-optimization-proposals">17.3.2. The results of an optimization proposal</a></h4>
<div class="paragraph">
<p>When an optimization proposal is generated, a summary and broker load is returned.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>The summary is contained in the <code>KafkaRebalance</code> resource. The summary provides an overview of the proposed cluster rebalance and indicates the scale of the changes involved.
A summary of a successfully generated optimization proposal is contained in the <code>Status.OptimizationResult</code> property of the <code>KafkaRebalance</code> resource.
The information provided is a summary of the full optimization proposal.</p>
</dd>
<dt class="hdlist1">Broker load</dt>
<dd>
<p>The broker load is stored in a ConfigMap that contains data as a JSON string. The broker load shows before and after values for the proposed rebalance, so you can see the impact on each of the brokers in the cluster.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="manually_approving_or_rejecting_an_optimization_proposal"><a class="link" href="#manually_approving_or_rejecting_an_optimization_proposal">17.3.3. Manually approving or rejecting an optimization proposal</a></h4>
<div class="paragraph">
<p>An optimization proposal summary shows the proposed scope of changes.</p>
</div>
<div class="paragraph">
<p>You can use the name of the <code>KafkaRebalance</code> resource to return a summary from the command line.</p>
</div>
<div class="listingblock">
<div class="title">Returning an optimization proposal summary</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl describe kafkarebalance <em>&lt;kafka_rebalance_resource_name&gt;</em> -n <em>&lt;namespace&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the <code>jq</code> command line JSON parser tool.</p>
</div>
<div class="listingblock">
<div class="title">Returning an optimization proposal summary using jq</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"><code>kubectl get kafkarebalance -o json | jq <em>&lt;jq_query&gt;</em></code>.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the summary to decide whether to approve or reject an optimization proposal.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Approving an optimization proposal</dt>
<dd>
<p>You approve the optimization proposal by setting the <code>strimzi.io/rebalance</code> annotation of the <code>KafkaRebalance</code> resource to <code>approve</code>.
Cruise Control applies the proposal to the Kafka cluster and starts a cluster rebalance operation.</p>
</dd>
<dt class="hdlist1">Rejecting an optimization proposal</dt>
<dd>
<p>If you choose not to approve an optimization proposal,
you can <a href="#proc-generating-optimization-proposals-str">change the optimization goals</a> or <a href="#rebalance_tuning_options">update any of the rebalance performance tuning options</a>, and then generate another proposal.
You can generate a new optimization proposal for a <code>KafkaRebalance</code> resource by setting the <code>strimzi.io/rebalance</code> annotation to <code>refresh</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Use optimization proposals to assess the movements required for a rebalance.
For example, a summary describes inter-broker and intra-broker movements.
Inter-broker rebalancing moves data between separate brokers.
Intra-broker rebalancing moves data between disks on the same broker when you are using a JBOD storage configuration.
Such information can be useful even if you don&#8217;t go ahead and approve the proposal.</p>
</div>
<div class="paragraph">
<p>You might reject an optimization proposal, or delay its approval, because of the additional load on a Kafka cluster when rebalancing.</p>
</div>
<div class="paragraph">
<p>In the following example, the proposal suggests the rebalancing of data between separate brokers.
The rebalance involves the movement of 55 partition replicas, totaling 12MB of data, across the brokers.
Though the inter-broker movement of partition replicas has a high impact on performance, the total amount of data is not large.
If the total data was much larger, you could reject the proposal, or time when to approve the rebalance to limit the impact on the performance of the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>Rebalance performance tuning options can help reduce the impact of data movement.
If you can extend the rebalance period, you can divide the rebalance into smaller batches.
Fewer data movements at a single time reduces the load on the cluster.</p>
</div>
<div class="listingblock">
<div class="title">Example optimization proposal summary</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">Name:         my-rebalance
Namespace:    myproject
Labels:       strimzi.io/cluster=my-cluster
Annotations:  API Version:  kafka.strimzi.io/v1alpha1
Kind:         KafkaRebalance
Metadata:
# ...
Status:
  Conditions:
    Last Transition Time:  2022-04-05T14:36:11.900Z
    Status:                ProposalReady
    Type:                  State
  Observed Generation:     1
  Optimization Result:
    Data To Move MB:  0
    Excluded Brokers For Leadership:
    Excluded Brokers For Replica Move:
    Excluded Topics:
    Intra Broker Data To Move MB:         12
    Monitored Partitions Percentage:      100
    Num Intra Broker Replica Movements:   0
    Num Leader Movements:                 24
    Num Replica Movements:                55
    On Demand Balancedness Score After:   82.91290759174306
    On Demand Balancedness Score Before:  78.01176356230222
    Recent Windows:                       5
  Session Id:                             a4f833bd-2055-4213-bfdd-ad21f95bf184</code></pre>
</div>
</div>
<div class="paragraph">
<p>The proposal will also move 24 partition leaders to different brokers.
This requires a change to the ZooKeeper configuration, which has a low impact on performance.</p>
</div>
<div class="paragraph">
<p>The balancedness scores are measurements of the overall balance of the Kafka cluster before and after the optimization proposal is approved.
A balancedness score is based on optimization goals.
If all goals are satisfied, the score is 100.
The score is reduced for each goal that will not be met.
Compare the balancedness scores to see whether the Kafka cluster is less balanced than it could be following a rebalance.</p>
</div>
</div>
<div class="sect3">
<h4 id="automatically_approving_an_optimization_proposal"><a class="link" href="#automatically_approving_an_optimization_proposal">17.3.4. Automatically approving an optimization proposal</a></h4>
<div class="paragraph">
<p>To save time, you can automate the process of approving optimization proposals.
With automation, when you generate an optimization proposal it goes straight into a cluster rebalance.</p>
</div>
<div class="paragraph">
<p>To enable the optimization proposal auto-approval mechanism, create the <code>KafkaRebalance</code> resource with the <code>strimzi.io/rebalance-auto-approval</code> annotation set to <code>true</code>.
If the annotation is not set or set to <code>false</code>, the optimization proposal requires manual approval.</p>
</div>
<div class="listingblock">
<div class="title">Example rebalance request with auto-approval mechanism enabled</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaRebalance
metadata:
  name: my-rebalance
  labels:
    strimzi.io/cluster: my-cluster
  annotations:
    strimzi.io/rebalance-auto-approval: "true"
spec:
  mode: # any mode
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can still check the status when automatically approving an optimization proposal.
The status of the <code>KafkaRebalance</code> resource moves to <code>Ready</code> when the rebalance is complete.</p>
</div>
</div>
<div class="sect3">
<h4 id="optimization_proposal_summary_properties"><a class="link" href="#optimization_proposal_summary_properties">17.3.5. Optimization proposal summary properties</a></h4>
<div class="paragraph">
<p>The following table explains the properties contained in the optimization proposal&#8217;s summary section.</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 31. Properties contained in an optimization proposal summary</caption>
<colgroup>
<col style="width: 35%;">
<col style="width: 65%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">JSON property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>numIntraBrokerReplicaMovements</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The total number of partition replicas that will be transferred between the disks of the cluster&#8217;s brokers.</p>
<p class="tableblock"><strong>Performance impact during rebalance operation</strong>: Relatively high, but lower than <code>numReplicaMovements</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>excludedBrokersForLeadership</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not yet supported. An empty list is returned.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>numReplicaMovements</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of partition replicas that will be moved between separate brokers.</p>
<p class="tableblock"><strong>Performance impact during rebalance operation</strong>: Relatively high.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>onDemandBalancednessScoreBefore, onDemandBalancednessScoreAfter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A measurement of the overall <em>balancedness</em> of a Kafka Cluster, before and after the optimization proposal was generated.</p>
<p class="tableblock">The score is calculated by subtracting the sum of the <code>BalancednessScore</code> of each violated soft goal from 100. Cruise Control assigns a <code>BalancednessScore</code> to every optimization goal based on several factors, including priority&#8212;&#8203;the goal&#8217;s position in the list of <code>default.goals</code> or user-provided goals.</p>
<p class="tableblock">The <code>Before</code> score is based on the current configuration of the Kafka cluster.
The <code>After</code> score is based on the generated optimization proposal.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>intraBrokerDataToMoveMB</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The sum of the size of each partition replica that will be moved between disks on the same broker (see also <code>numIntraBrokerReplicaMovements</code>).</p>
<p class="tableblock"><strong>Performance impact during rebalance operation</strong>: Variable. The larger the number, the longer the cluster rebalance will take to complete. Moving a large amount of data between disks on the same broker has less impact than between separate brokers (see <code>dataToMoveMB</code>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>recentWindows</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of metrics windows upon which the optimization proposal is based.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dataToMoveMB</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The sum of the size of each partition replica that will be moved to a separate broker (see also <code>numReplicaMovements</code>).</p>
<p class="tableblock"><strong>Performance impact during rebalance operation</strong>: Variable. The larger the number, the longer the cluster rebalance will take to complete.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>monitoredPartitionsPercentage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The percentage of partitions in the Kafka cluster covered by the optimization proposal. Affected by the number of <code>excludedTopics</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>excludedTopics</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If you specified a regular expression in the <code>spec.excludedTopicsRegex</code> property in the <code>KafkaRebalance</code> resource, all topic names matching that expression are listed here.
These topics are excluded from the calculation of partition replica/leader movements in the optimization proposal.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>numLeaderMovements</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of partitions whose leaders will be switched to different replicas. This involves a change to ZooKeeper configuration.</p>
<p class="tableblock"><strong>Performance impact during rebalance operation</strong>: Relatively low.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>excludedBrokersForReplicaMove</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not yet supported. An empty list is returned.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="broker_load_properties"><a class="link" href="#broker_load_properties">17.3.6. Broker load properties</a></h4>
<div class="paragraph">
<p>The broker load is stored in a ConfigMap (with the same name as the KafkaRebalance custom resource) as a JSON formatted string. This JSON string consists of a JSON object with keys for each broker IDs linking to a number of metrics for each broker.
Each metric consist of three values.
The first is the metric value before the optimization proposal is applied, the second is the expected value of the metric after the proposal is applied, and the third is the difference between the first two values (after minus before).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The ConfigMap appears when the KafkaRebalance resource is in the <code>ProposalReady</code> state and remains after the rebalance is complete.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can use the name of the ConfigMap to view its data from the command line.</p>
</div>
<div class="listingblock">
<div class="title">Returning ConfigMap data</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl describe configmaps <em>&lt;my_rebalance_configmap_name&gt;</em> -n <em>&lt;namespace&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the <code>jq</code> command line JSON parser tool to extract the JSON string from the ConfigMap.</p>
</div>
<div class="listingblock">
<div class="title">Extracting the JSON string from the ConfigMap using jq</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get configmaps <em>&lt;my_rebalance_configmap_name&gt;</em> -o json | jq '.["data"]["brokerLoad.json"]|fromjson|.'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following table explains the properties contained in the optimization proposal&#8217;s broker load ConfigMap:</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<colgroup>
<col style="width: 35%;">
<col style="width: 65%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">JSON property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>leaders</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of replicas on this broker that are partition leaders.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>replicas</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of replicas on this broker.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cpuPercentage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The CPU utilization as a percentage of the defined capacity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>diskUsedPercentage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The disk utilization as a percentage of the defined capacity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>diskUsedMB</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The absolute disk usage in MB.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>networkOutRate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The total network output rate for the broker.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>leaderNetworkInRate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The network input rate for all partition leader replicas on this broker.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>followerNetworkInRate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The network input rate for all follower replicas on this broker.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>potentialMaxNetworkOutRate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The hypothetical maximum network output rate that would be realized if this broker became the leader of all the replicas it currently hosts.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="cached_optimization_proposal"><a class="link" href="#cached_optimization_proposal">17.3.7. Cached optimization proposal</a></h4>
<div class="paragraph">
<p>Cruise Control maintains a <em>cached optimization proposal</em> based on the configured default optimization goals.
Generated from the workload model, the cached optimization proposal is updated every 15 minutes to reflect the current state of the Kafka cluster.
If you generate an optimization proposal using the default optimization goals, Cruise Control returns the most recent cached proposal.</p>
</div>
<div class="paragraph">
<p>To change the cached optimization proposal refresh interval, edit the <code>proposal.expiration.ms</code> setting in the Cruise Control deployment configuration.
Consider a shorter interval for fast changing clusters, although this increases the load on the Cruise Control server.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#con-optimization-goals-str">Optimization goals overview</a></p>
</li>
<li>
<p><a href="#proc-generating-optimization-proposals-str">Generating optimization proposals</a></p>
</li>
<li>
<p><a href="#proc-approving-optimization-proposal-str">Approving an optimization proposal</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-rebalance-str"><a class="link" href="#con-rebalance-str">17.4. Rebalance performance tuning overview</a></h3>
<div class="paragraph">
<p>You can adjust several performance tuning options for cluster rebalances.
These options control how partition replica and leadership movements in a rebalance are executed, as well as the bandwidth that is allocated to a rebalance operation.</p>
</div>
<div class="sect3">
<h4 id="partition_reassignment_commands"><a class="link" href="#partition_reassignment_commands">17.4.1. Partition reassignment commands</a></h4>
<div class="paragraph">
<p><a href="#con-optimization-proposals-str">Optimization proposals</a> are comprised of separate partition reassignment commands.
When you <a href="#proc-approving-optimization-proposal-str">approve</a> a proposal, the Cruise Control server applies these commands to the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>A partition reassignment command consists of either of the following types of operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Partition movement: Involves transferring the partition replica and its data to a new location. Partition movements can take one of two forms:</p>
<div class="ulist">
<ul>
<li>
<p>Inter-broker movement: The partition replica is moved to a log directory on a different broker.</p>
</li>
<li>
<p>Intra-broker movement: The partition replica is moved to a different log directory on the same broker.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Leadership movement: This involves switching the leader of the partition&#8217;s replicas.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cruise Control issues partition reassignment commands to the Kafka cluster in batches.
The performance of the cluster during the rebalance is affected by the number of each type of movement contained in each batch.</p>
</div>
</div>
<div class="sect3">
<h4 id="replica_movement_strategies"><a class="link" href="#replica_movement_strategies">17.4.2. Replica movement strategies</a></h4>
<div class="paragraph">
<p>Cluster rebalance performance is also influenced by the <em>replica movement strategy</em> that is applied to the batches of partition reassignment commands.
By default, Cruise Control uses the <code>BaseReplicaMovementStrategy</code>, which simply applies the commands in the order they were generated.
However, if there are some very large partition reassignments early in the proposal, this strategy can slow down the application of the other reassignments.</p>
</div>
<div class="paragraph">
<p>Cruise Control provides four alternative replica movement strategies that can be applied to optimization proposals:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>PrioritizeSmallReplicaMovementStrategy</code>: Order reassignments in order of ascending size.</p>
</li>
<li>
<p><code>PrioritizeLargeReplicaMovementStrategy</code>: Order reassignments in order of descending size.</p>
</li>
<li>
<p><code>PostponeUrpReplicaMovementStrategy</code>: Prioritize reassignments for replicas of partitions which have no out-of-sync replicas.</p>
</li>
<li>
<p><code>PrioritizeMinIsrWithOfflineReplicasStrategy</code>: Prioritize reassignments with (At/Under)MinISR partitions with offline replicas.  This strategy will only work if <code>cruiseControl.config.concurrency.adjuster.min.isr.check.enabled</code> is set to <code>true</code> in the <code>Kafka</code> custom resource&#8217;s spec.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These strategies can be configured as a sequence.
The first strategy attempts to compare two partition reassignments using its internal logic.
If the reassignments are equivalent, then it passes them to the next strategy in the sequence to decide the order, and so on.</p>
</div>
</div>
<div class="sect3">
<h4 id="intra_broker_disk_balancing"><a class="link" href="#intra_broker_disk_balancing">17.4.3. Intra-broker disk balancing</a></h4>
<div class="paragraph">
<p>Moving a large amount of data between disks on the same broker has less impact than between separate brokers.
If you are running a Kafka deployment that uses JBOD storage with multiple disks on the same broker, Cruise Control can balance partitions between the disks.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using JBOD storage with a single disk, intra-broker disk balancing will result in a proposal with 0 partition movements since there are no disks to balance between.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To perform an intra-broker disk balance, set <code>rebalanceDisk</code> to <code>true</code> under the <code>KafkaRebalance.spec</code>.
When setting <code>rebalanceDisk</code> to <code>true</code>, do not set a <code>goals</code> field in the <code>KafkaRebalance.spec</code>, as Cruise Control will automatically set the intra-broker goals and ignore the inter-broker goals.
Cruise Control does not perform inter-broker and intra-broker balancing at the same time.</p>
</div>
</div>
<div class="sect3">
<h4 id="rebalance_tuning_options"><a class="link" href="#rebalance_tuning_options">17.4.4. Rebalance tuning options</a></h4>
<div class="paragraph">
<p>Cruise Control provides several configuration options for tuning the rebalance parameters discussed above.
You can set these tuning options when <a href="#proc-configuring-deploying-cruise-control-str">configuring and deploying Cruise Control with Kafka</a> or <a href="#proc-generating-optimization-proposals-str">optimization proposal</a> levels:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Cruise Control server setting can be set in the Kafka custom resource under <code>Kafka.spec.cruiseControl.config</code>.</p>
</li>
<li>
<p>The individual rebalance performance configurations can be set under <code>KafkaRebalance.spec</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The relevant configurations are summarized in the following table.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 32. Rebalance performance tuning configuration</caption>
<colgroup>
<col style="width: 36.3636%;">
<col style="width: 36.3636%;">
<col style="width: 9.0909%;">
<col style="width: 18.1819%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Cruise Control properties</th>
<th class="tableblock halign-left valign-top">KafkaRebalance properties</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>num.concurrent.partition.movements.per.broker</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>concurrentPartitionMovementsPerBroker</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of inter-broker partition movements in each partition reassignment batch</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>num.concurrent.intra.broker.partition.movements</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>concurrentIntraBrokerPartitionMovements</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of intra-broker partition movements in each partition reassignment batch</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>num.concurrent.leader.movements</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>concurrentLeaderMovements</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of partition leadership changes in each partition reassignment batch</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>default.replication.throttle</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>replicationThrottle</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null (no limit)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The bandwidth (in bytes per second) to assign to partition reassignment</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>default.replica.movement.strategies</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>replicaMovementStrategies</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BaseReplicaMovementStrategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The list of strategies (in priority order) used to determine the order in which partition reassignment commands are executed for generated proposals.
  For the server setting, use a comma separated string with the fully qualified names of the strategy class (add <code>com.linkedin.kafka.cruisecontrol.executor.strategy.</code> to the start of each class name).
  For the <code>KafkaRebalance</code> resource setting use a YAML array of strategy class names.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>rebalanceDisk</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables intra-broker disk balancing, which balances disk space utilization between disks on the same broker. Only applies to Kafka deployments that use JBOD storage with multiple disks.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Changing the default settings affects the length of time that the rebalance takes to complete, as well as the load placed on the Kafka cluster during the rebalance.
Using lower values reduces the load but increases the amount of time taken, and vice versa.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./configuring.html#type-CruiseControlSpec-reference" target="_blank" rel="noopener"><code>CruiseControlSpec</code> schema reference</a></p>
</li>
<li>
<p><a href="./configuring.html#type-KafkaRebalanceSpec-reference" target="_blank" rel="noopener"><code>KafkaRebalanceSpec</code> schema reference</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="proc-configuring-deploying-cruise-control-str"><a class="link" href="#proc-configuring-deploying-cruise-control-str">17.5. Configuring and deploying Cruise Control with Kafka</a></h3>
<div class="paragraph _abstract">
<p>Configure a <code>Kafka</code> resource to deploy Cruise Control alongside a Kafka cluster.
You can use the <code>cruiseControl</code> properties of the <code>Kafka</code> resource to configure the deployment.
Deploy one instance of Cruise Control per Kafka cluster.</p>
</div>
<div class="paragraph">
<p>Use <code>goals</code> configuration in the Cruise Control <code>config</code> to specify optimization goals for generating optimization proposals.
You can use <code>brokerCapacity</code> to change the default capacity limits for goals related to resource distribution.
If brokers are running on nodes with heterogeneous network resources, you can use <code>overrides</code> to set network capacity limits for each broker.</p>
</div>
<div class="paragraph">
<p>If an empty object (<code>{}</code>) is used for the <code>cruiseControl</code> configuration, all properties use their default values.</p>
</div>
<div class="paragraph">
<p>For more information on the configuration options for Cruise Control, see the <a href="./configuring.html" target="_blank" rel="noopener">Strimzi Custom Resource API Reference</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kubernetes cluster</p>
</li>
<li>
<p>A running Cluster Operator</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <code>cruiseControl</code> property for the <code>Kafka</code> resource.</p>
<div class="paragraph">
<p>The properties you can configure are shown in this example configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  # ...
  cruiseControl:
    brokerCapacity: # <b class="conum">(1)</b>
      inboundNetwork: 10000KB/s
      outboundNetwork: 10000KB/s
      overrides: # <b class="conum">(2)</b>
      - brokers: [0]
        inboundNetwork: 20000KiB/s
        outboundNetwork: 20000KiB/s
      - brokers: [1, 2]
        inboundNetwork: 30000KiB/s
        outboundNetwork: 30000KiB/s
      # ...
    config: # <b class="conum">(3)</b>
      # Note that `default.goals` (superset) must also include all `hard.goals` (subset)
      default.goals: &gt; # <b class="conum">(4)</b>
        com.linkedin.kafka.cruisecontrol.analyzer.goals.RackAwareGoal,
        com.linkedin.kafka.cruisecontrol.analyzer.goals.ReplicaCapacityGoal,
        com.linkedin.kafka.cruisecontrol.analyzer.goals.DiskCapacityGoal
        # ...
      hard.goals: &gt;
        com.linkedin.kafka.cruisecontrol.analyzer.goals.RackAwareGoal
        # ...
      cpu.balance.threshold: 1.1
      metadata.max.age.ms: 300000
      send.buffer.bytes: 131072
      webserver.http.cors.enabled: true # <b class="conum">(5)</b>
      webserver.http.cors.origin: "*"
      webserver.http.cors.exposeheaders: "User-Task-ID,Content-Type"
      # ...
    resources: # <b class="conum">(6)</b>
      requests:
        cpu: 1
        memory: 512Mi
      limits:
        cpu: 2
        memory: 2Gi
    logging: # <b class="conum">(7)</b>
        type: inline
        loggers:
          rootLogger.level: INFO
    template: # <b class="conum">(8)</b>
      pod:
        metadata:
          labels:
            label1: value1
        securityContext:
          runAsUser: 1000001
          fsGroup: 0
        terminationGracePeriodSeconds: 120
    readinessProbe: # <b class="conum">(9)</b>
      initialDelaySeconds: 15
      timeoutSeconds: 5
    livenessProbe:
      initialDelaySeconds: 15
      timeoutSeconds: 5
    metricsConfig: # <b class="conum">(10)</b>
      type: jmxPrometheusExporter
      valueFrom:
        configMapKeyRef:
          name: cruise-control-metrics
          key: metrics-config.yml
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Capacity limits for broker resources.</p>
</li>
<li>
<p>Overrides set network capacity limits for specific brokers when running on nodes with heterogeneous network resources.</p>
</li>
<li>
<p>Cruise Control configuration. Standard Cruise Control configuration may be provided, restricted to those properties not managed directly by Strimzi.</p>
</li>
<li>
<p>Optimization goals configuration, which can include configuration for default optimization goals (<code>default.goals</code>), main optimization goals (<code>goals</code>), and hard goals (<code>hard.goals</code>).</p>
</li>
<li>
<p>CORS enabled and configured for read-only access to the Cruise Control API.</p>
</li>
<li>
<p>Requests for reservation of supported resources, currently <code>cpu</code> and <code>memory</code>, and limits to specify the maximum resources that can be consumed.</p>
</li>
<li>
<p>Cruise Control loggers and log levels added directly (<code>inline</code>) or indirectly (<code>external</code>) through a ConfigMap. A custom Log4j configuration must be placed under the <code>log4j.properties</code> key in the ConfigMap. Cruise Control has a single logger named <code>rootLogger.level</code>. You can set the log level to INFO, ERROR, WARN, TRACE, DEBUG, FATAL or OFF.</p>
</li>
<li>
<p>Template customization. Here a pod is scheduled with additional security attributes.</p>
</li>
<li>
<p>Healthchecks to know when to restart a container (liveness) and when a container can accept traffic (readiness).</p>
</li>
<li>
<p>Prometheus metrics enabled. In this example, metrics are configured for the Prometheus JMX Exporter (the default metrics exporter).</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments -n <em>&lt;my_cluster_operator_namespace&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the deployment name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                      READY  UP-TO-DATE  AVAILABLE
my-cluster-cruise-control 1/1    1           1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>my-cluster</code> is the name of the Kafka cluster.</p>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>AVAILABLE</code> output shows <code>1</code>.</p>
</div>
</li>
</ol>
</div>
<h4 id="auto_created_topics" class="discrete">Auto-created topics</h4>
<div class="paragraph">
<p>The following table shows the three topics that are automatically created when Cruise Control is deployed. These topics are required for Cruise Control to work properly and must not be deleted or changed. You can change the name of the topic using the specified configuration option.</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 33. Auto-created topics</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 50.0002%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Auto-created topic configuration</th>
<th class="tableblock halign-left valign-top">Default topic name</th>
<th class="tableblock halign-left valign-top">Created by</th>
<th class="tableblock halign-left valign-top">Function</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>metric.reporter.topic</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi.cruisecontrol.metrics</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Strimzi Metrics Reporter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stores the raw metrics from the Metrics Reporter in each Kafka broker.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>partition.metric.sample.store.topic</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi.cruisecontrol.partitionmetricsamples</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cruise Control</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stores the derived metrics for each partition. These are created by the <a href="https://github.com/linkedin/cruise-control/wiki/Overview#metric-sample-aggregator" target="_blank" rel="noopener">Metric Sample Aggregator</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>broker.metric.sample.store.topic</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi.cruisecontrol.modeltrainingsamples</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cruise Control</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stores the metrics samples used to create the <a href="https://github.com/linkedin/cruise-control/wiki/Overview#cluster-workload-model" target="_blank" rel="noopener">Cluster Workload Model</a>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To prevent the removal of records that are needed by Cruise Control, log compaction is disabled in the auto-created topics.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If the names of the auto-created topics are changed in a Kafka cluster that already has Cruise Control enabled, the old topics will not be deleted and should be manually removed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">What to do next</div>
<p>After configuring and deploying Cruise Control, you can <a href="#proc-generating-optimization-proposals-str">generate optimization proposals</a>.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#con-optimization-goals-str">Optimization goals overview</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="proc-generating-optimization-proposals-str"><a class="link" href="#proc-generating-optimization-proposals-str">17.6. Generating optimization proposals</a></h3>
<div class="paragraph _abstract">
<p>When you create or update a <code>KafkaRebalance</code> resource, Cruise Control generates an <a href="#con-optimization-proposals-str">optimization proposal</a> for the Kafka cluster based on the configured <a href="#con-optimization-goals-str">optimization goals</a>.
Analyze the information in the optimization proposal and decide whether to approve it.
You can use the results of the optimization proposal to rebalance your Kafka cluster.</p>
</div>
<div class="paragraph">
<p>You can run the optimization proposal in one of the following modes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>full</code> (default)</p>
</li>
<li>
<p><code>add-brokers</code></p>
</li>
<li>
<p><code>remove-brokers</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The mode you use depends on whether you are rebalancing across all the brokers already running in the Kafka cluster;
or you want to rebalance after scaling up or before scaling down your Kafka cluster.
For more information, see <a href="#con-optimization-proposals-modes-str">Rebalancing modes with broker scaling</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have <a href="#proc-configuring-deploying-cruise-control-str">deployed Cruise Control</a> to your Strimzi cluster.</p>
</li>
<li>
<p>You have configured optimization goals and, optionally, capacity limits on broker resources.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information on configuring Cruise Control, see <a href="#proc-configuring-deploying-cruise-control-str">Configuring and deploying Cruise Control with Kafka</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>KafkaRebalance</code> resource and specify the appropriate mode.</p>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>full</code> mode (default)</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>To use the <em>default optimization goals</em> defined in the <code>Kafka</code> resource, leave the <code>spec</code> property empty.
Cruise Control rebalances a Kafka cluster in <code>full</code> mode by default.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration with full rebalancing by default</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaRebalance
metadata:
  name: my-rebalance
  labels:
    strimzi.io/cluster: my-cluster
spec: {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also run a full rebalance by specifying the <code>full</code> mode through the <code>spec.mode</code> property.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration specifying <code>full</code> mode</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaRebalance
metadata:
  name: my-rebalance
  labels:
    strimzi.io/cluster: my-cluster
spec:
  mode: full</code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>add-brokers</code> mode</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>If you want to rebalance a Kafka cluster after scaling up, specify the <code>add-brokers</code> mode.</p>
</div>
<div class="paragraph">
<p>In this mode, existing replicas are moved to the newly added brokers.
You need to specify the brokers as a list.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration specifying <code>add-brokers</code> mode</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaRebalance
metadata:
  name: my-rebalance
  labels:
    strimzi.io/cluster: my-cluster
spec:
  mode: add-brokers
  brokers: [3, 4] <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>List of newly added brokers added by the scale up operation. This property is mandatory.</p>
</li>
</ol>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>remove-brokers</code> mode</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>If you want to rebalance a Kafka cluster before scaling down, specify the <code>remove-brokers</code> mode.</p>
</div>
<div class="paragraph">
<p>In this mode, replicas are moved off the brokers that are going to be removed.
You need to specify the brokers that are being removed as a list.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration specifying <code>remove-brokers</code> mode</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaRebalance
metadata:
  name: my-rebalance
  labels:
    strimzi.io/cluster: my-cluster
spec:
  mode: remove-brokers
  brokers: [3, 4] <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>List of brokers to be removed by the scale down operation. This property is mandatory.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The following steps and the steps to approve or stop a rebalance are the same regardless of the rebalance mode you are using.
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
</li>
<li>
<p>To configure <em>user-provided optimization goals</em> instead of using the default goals, add the <code>goals</code> property and enter one or more goals.</p>
<div class="paragraph">
<p>In the following example, rack awareness and replica capacity are configured as user-provided optimization goals:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaRebalance
metadata:
  name: my-rebalance
  labels:
    strimzi.io/cluster: my-cluster
spec:
  goals:
    - RackAwareGoal
    - ReplicaCapacityGoal</code></pre>
</div>
</div>
</li>
<li>
<p>To ignore the configured hard goals, add the <code>skipHardGoalCheck: true</code> property:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaRebalance
metadata:
  name: my-rebalance
  labels:
    strimzi.io/cluster: my-cluster
spec:
  goals:
    - RackAwareGoal
    - ReplicaCapacityGoal
  skipHardGoalCheck: true</code></pre>
</div>
</div>
</li>
<li>
<p>(Optional) To approve the optimization proposal automatically, set the <code>strimzi.io/rebalance-auto-approval</code> annotation to <code>true</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaRebalance
metadata:
  name: my-rebalance
  labels:
    strimzi.io/cluster: my-cluster
  annotations:
    strimzi.io/rebalance-auto-approval: "true"
spec:
  goals:
    - RackAwareGoal
    - ReplicaCapacityGoal
  skipHardGoalCheck: true</code></pre>
</div>
</div>
</li>
<li>
<p>Create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_rebalance_configuration_file&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Cluster Operator requests the optimization proposal from Cruise Control.
This might take a few minutes depending on the size of the Kafka cluster.</p>
</div>
</li>
<li>
<p>If you used the automatic approval mechanism, wait for the status of the optimization proposal to change to <code>Ready</code>.
If you haven&#8217;t enabled the automatic approval mechanism, wait for the status of the optimization proposal to change to <code>ProposalReady</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafkarebalance -o wide -w -n <em>&lt;namespace&gt;</em></code></pre>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1"><code>PendingProposal</code></dt>
<dd>
<p>A <code>PendingProposal</code> status means the rebalance operator is polling the Cruise Control API to check if the optimization proposal is ready.</p>
</dd>
<dt class="hdlist1"><code>ProposalReady</code></dt>
<dd>
<p>A <code>ProposalReady</code> status means the optimization proposal is ready for review and approval.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>When the status changes to <code>ProposalReady</code>, the optimization proposal is ready to approve.</p>
</div>
</li>
<li>
<p>Review the optimization proposal.</p>
<div class="paragraph">
<p>The optimization proposal is contained in the <code>Status.Optimization Result</code> property of the <code>KafkaRebalance</code> resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl describe kafkarebalance <em>&lt;kafka_rebalance_resource_name&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example optimization proposal</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Status:
  Conditions:
    Last Transition Time:  2020-05-19T13:50:12.533Z
    Status:                ProposalReady
    Type:                  State
  Observed Generation:     1
  Optimization Result:
    Data To Move MB:  0
    Excluded Brokers For Leadership:
    Excluded Brokers For Replica Move:
    Excluded Topics:
    Intra Broker Data To Move MB:         0
    Monitored Partitions Percentage:      100
    Num Intra Broker Replica Movements:   0
    Num Leader Movements:                 0
    Num Replica Movements:                26
    On Demand Balancedness Score After:   81.8666802863978
    On Demand Balancedness Score Before:  78.01176356230222
    Recent Windows:                       1
  Session Id:                             05539377-ca7b-45ef-b359-e13564f1458c</code></pre>
</div>
</div>
<div class="paragraph">
<p>The properties in the <code>Optimization Result</code> section describe the pending cluster rebalance operation.
For descriptions of each property, see <a href="#contents-optimization-proposals">Contents of optimization proposals</a>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Insufficient CPU capacity</div>
<p>If a Kafka cluster is overloaded in terms of CPU utilization, you might see an insufficient CPU capacity error in the <code>KafkaRebalance</code> status.
It&#8217;s worth noting that this utilization value is unaffected by the <code>excludedTopics</code> configuration.
Although optimization proposals will not reassign replicas of excluded topics, their load is still considered in the utilization calculation.</p>
</div>
<div class="listingblock">
<div class="title">Example CPU utilization error</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">com.linkedin.kafka.cruisecontrol.exception.OptimizationFailureException:
[CpuCapacityGoal] Insufficient capacity for cpu (Utilization 615.21, Allowed Capacity 420.00, Threshold: 0.70). Add at least 3 brokers with the same cpu capacity (100.00) as broker-0. Add at least 3 brokers with the same cpu capacity (100.00) as broker-0.</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The error shows CPU capacity as a percentage rather than the number of CPU cores.
For this reason, it does not directly map to the number of CPUs configured in the Kafka custom resource.
It is like having a single <em>virtual</em> CPU per broker, which has the cycles of the CPUs configured in <code>Kafka.spec.kafka.resources.limits.cpu</code>.
This has no effect on the rebalance behavior, since the ratio between CPU utilization and capacity remains the same.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">What to do next</div>
<p><a href="#proc-approving-optimization-proposal-str">Approving an optimization proposal</a></p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#con-optimization-proposals-str">Optimization proposals overview</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="proc-approving-optimization-proposal-str"><a class="link" href="#proc-approving-optimization-proposal-str">17.7. Approving an optimization proposal</a></h3>
<div class="paragraph">
<p>You can approve an <a href="#con-optimization-proposals-str">optimization proposal</a> generated by Cruise Control, if its status is <code>ProposalReady</code>.
Cruise Control will then apply the optimization proposal to the Kafka cluster, reassigning partitions to brokers and changing partition leadership.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph">
<p><strong>This is not a dry run.</strong> Before you approve an optimization proposal, you must:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Refresh the proposal in case it has become out of date.</p>
</li>
<li>
<p>Carefully review the <a href="#contents-optimization-proposals">contents of the proposal</a>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have <a href="#proc-generating-optimization-proposals-str">generated an optimization proposal</a> from Cruise Control.</p>
</li>
<li>
<p>The <code>KafkaRebalance</code> custom resource status is <code>ProposalReady</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Perform these steps for the optimization proposal that you want to approve.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Unless the optimization proposal is newly generated, check that it is based on current information about the state of the Kafka cluster.
To do so, refresh the optimization proposal to make sure it uses the latest cluster metrics:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Annotate the <code>KafkaRebalance</code> resource in Kubernetes with <code>strimzi.io/rebalance=refresh</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate kafkarebalance <em>&lt;kafka_rebalance_resource_name&gt;</em> strimzi.io/rebalance=refresh</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Wait for the status of the optimization proposal to change to <code>ProposalReady</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafkarebalance -o wide -w -n <em>&lt;namespace&gt;</em></code></pre>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1"><code>PendingProposal</code></dt>
<dd>
<p>A <code>PendingProposal</code> status means the rebalance operator is polling the Cruise Control API to check if the optimization proposal is ready.</p>
</dd>
<dt class="hdlist1"><code>ProposalReady</code></dt>
<dd>
<p>A <code>ProposalReady</code> status means the optimization proposal is ready for review and approval.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>When the status changes to <code>ProposalReady</code>, the optimization proposal is ready to approve.</p>
</div>
</li>
<li>
<p>Approve the optimization proposal that you want Cruise Control to apply.</p>
<div class="paragraph">
<p>Annotate the <code>KafkaRebalance</code> resource in Kubernetes with <code>strimzi.io/rebalance=approve</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate kafkarebalance <em>&lt;kafka_rebalance_resource_name&gt;</em> strimzi.io/rebalance=approve</code></pre>
</div>
</div>
</li>
<li>
<p>The Cluster Operator detects the annotated resource and instructs Cruise Control to rebalance the Kafka cluster.</p>
</li>
<li>
<p>Wait for the status of the optimization proposal to change to <code>Ready</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafkarebalance -o wide -w -n <em>&lt;namespace&gt;</em></code></pre>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1"><code>Rebalancing</code></dt>
<dd>
<p>A <code>Rebalancing</code> status means the rebalancing is in progress.</p>
</dd>
<dt class="hdlist1"><code>Ready</code></dt>
<dd>
<p>A <code>Ready</code> status means the rebalance is complete.</p>
</dd>
<dt class="hdlist1"><code>NotReady</code></dt>
<dd>
<p>A <code>NotReady</code> status means an error occurred&#8212;&#8203;see <a href="#proc-fixing-problems-with-kafkarebalance-str">Fixing problems with a <code>KafkaRebalance</code> resource</a>.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>When the status changes to <code>Ready</code>, the rebalance is complete.</p>
</div>
<div class="paragraph">
<p>To use the same <code>KafkaRebalance</code> custom resource to generate another optimization proposal, apply the <code>refresh</code> annotation to the custom resource.
This moves the custom resource to the <code>PendingProposal</code> or <code>ProposalReady</code> state. You can then review the optimization proposal and approve it, if desired.</p>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#con-optimization-proposals-str">Optimization proposals overview</a></p>
</li>
<li>
<p><a href="#proc-stopping-cluster-rebalance-str">Stopping a cluster rebalance</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="proc-stopping-cluster-rebalance-str"><a class="link" href="#proc-stopping-cluster-rebalance-str">17.8. Stopping a cluster rebalance</a></h3>
<div class="paragraph">
<p>Once started, a cluster rebalance operation might take some time to complete and affect the overall performance of the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>If you want to stop a cluster rebalance operation that is in progress, apply the <code>stop</code> annotation to the <code>KafkaRebalance</code> custom resource.
This instructs Cruise Control to finish the current batch of partition reassignments and then stop the rebalance.
When the rebalance has stopped, completed partition reassignments have already been applied; therefore, the state of the Kafka cluster is different when compared to prior to the start of the rebalance operation.
If further rebalancing is required, you should generate a new optimization proposal.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The performance of the Kafka cluster in the intermediate (stopped) state might be worse than in the initial state.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have <a href="#proc-approving-optimization-proposal-str">approved the optimization proposal</a> by annotating the <code>KafkaRebalance</code> custom resource with <code>approve</code>.</p>
</li>
<li>
<p>The status of the <code>KafkaRebalance</code> custom resource is <code>Rebalancing</code>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Annotate the <code>KafkaRebalance</code> resource in Kubernetes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate kafkarebalance <em>rebalance-cr-name</em> strimzi.io/rebalance=stop</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the <code>KafkaRebalance</code> resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl describe kafkarebalance <em>rebalance-cr-name</em></code></pre>
</div>
</div>
</li>
<li>
<p>Wait until the status changes to <code>Stopped</code>.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#con-optimization-proposals-str">Optimization proposals overview</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="proc-fixing-problems-with-kafkarebalance-str"><a class="link" href="#proc-fixing-problems-with-kafkarebalance-str">17.9. Fixing problems with a <code>KafkaRebalance</code> resource</a></h3>
<div class="paragraph">
<p>If an issue occurs when creating a <code>KafkaRebalance</code> resource or interacting with Cruise Control, the error is reported in the resource status, along with details of how to fix it.
The resource also moves to the <code>NotReady</code> state.</p>
</div>
<div class="paragraph">
<p>To continue with the cluster rebalance operation, you must fix the problem in the <code>KafkaRebalance</code> resource itself or with the overall Cruise Control deployment.
Problems might include the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A misconfigured parameter in the <code>KafkaRebalance</code> resource.</p>
</li>
<li>
<p>The <code>strimzi.io/cluster</code> label for specifying the Kafka cluster in the <code>KafkaRebalance</code> resource is missing.</p>
</li>
<li>
<p>The Cruise Control server is not deployed as the <code>cruiseControl</code> property in the <code>Kafka</code> resource is missing.</p>
</li>
<li>
<p>The Cruise Control server is not reachable.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After fixing the issue, you need to add the <code>refresh</code> annotation to the <code>KafkaRebalance</code> resource.
During a “refresh”, a new optimization proposal is requested from the Cruise Control server.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have <a href="#proc-approving-optimization-proposal-str">approved an optimization proposal</a>.</p>
</li>
<li>
<p>The status of the <code>KafkaRebalance</code> custom resource for the rebalance operation is <code>NotReady</code>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Get information about the error from the <code>KafkaRebalance</code> status:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl describe kafkarebalance <em>rebalance-cr-name</em></code></pre>
</div>
</div>
</li>
<li>
<p>Attempt to resolve the issue in the <code>KafkaRebalance</code> resource.</p>
</li>
<li>
<p>Annotate the <code>KafkaRebalance</code> resource in Kubernetes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate kafkarebalance <em>rebalance-cr-name</em> strimzi.io/rebalance=refresh</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the <code>KafkaRebalance</code> resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl describe kafkarebalance <em>rebalance-cr-name</em></code></pre>
</div>
</div>
</li>
<li>
<p>Wait until the status changes to <code>PendingProposal</code>, or directly to <code>ProposalReady</code>.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#con-optimization-proposals-str">Optimization proposals overview</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-reassign-tool-str"><a class="link" href="#assembly-reassign-tool-str">18. Using the partition reassignment tool</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>When scaling a Kafka cluster, you may need to add or remove brokers and update the distribution of partitions or the replication factor of topics.
To update partitions and topics, you can use the <code>kafka-reassign-partitions.sh</code> tool.</p>
</div>
<div class="paragraph">
<p>Neither the Strimzi Cruise Control integration nor the Topic Operator support changing the replication factor of a topic.
However, you can change the replication factor of a topic using the <code>kafka-reassign-partitions.sh</code> tool.</p>
</div>
<div class="paragraph">
<p>The tool can also be used to reassign partitions and balance the distribution of partitions across brokers to improve performance.
However, it is recommended to use <a href="#cruise-control-concepts-str">Cruise Control for automated partition reassignments and cluster rebalancing</a>.
Cruise Control can move topics from one broker to another without any downtime, and it is the most efficient way to reassign partitions.</p>
</div>
<div class="paragraph">
<p>It is recommended to run the <code>kafka-reassign-partitions.sh</code> tool as a separate interactive pod rather than within the broker container.
Running the Kafka <code>bin/</code> scripts within the broker container may cause a JVM to start with the same settings as the Kafka broker, which can potentially cause disruptions.
By running the <code>kafka-reassign-partitions.sh</code> tool in a separate pod, you can avoid this issue.
Running a pod with the <code>-ti</code> option creates an interactive pod with a terminal for running shell commands inside the pod.</p>
</div>
<div class="listingblock">
<div class="title">Running an interactive pod with a terminal</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl run helper-pod -ti --image=quay.io/strimzi/kafka:0.39.0-kafka-3.6.1 --rm=true --restart=Never -- bash</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="con-partition-reassignment-str"><a class="link" href="#con-partition-reassignment-str">18.1. Partition reassignment tool overview</a></h3>
<div class="paragraph _abstract">
<p>The partition reassignment tool provides the following capabilities for managing Kafka partitions and brokers:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Redistributing partition replicas</dt>
<dd>
<p>Scale your cluster up and down by adding or removing brokers, and move Kafka partitions from heavily loaded brokers to under-utilized brokers.
To do this, you must create a partition reassignment plan that identifies which topics and partitions to move and where to move them.
Cruise Control is recommended for this type of operation as it <a href="#cruise-control-concepts-str">automates the cluster rebalancing process</a>.</p>
</dd>
<dt class="hdlist1">Scaling topic replication factor up and down</dt>
<dd>
<p>Increase or decrease the replication factor of your Kafka topics. To do this, you must create a partition reassignment plan that identifies the existing replication assignment across partitions and an updated assignment with the replication factor changes.</p>
</dd>
<dt class="hdlist1">Changing the preferred leader</dt>
<dd>
<p>Change the preferred leader of a Kafka partition. This can be useful if the current preferred leader is unavailable or if you want to redistribute load across the brokers in the cluster. To do this, you must create a partition reassignment plan that specifies the new preferred leader for each partition by changing the order of replicas.</p>
</dd>
<dt class="hdlist1">Changing the log directories to use a specific JBOD volume</dt>
<dd>
<p>Change the log directories of your Kafka brokers to use a specific JBOD volume. This can be useful if you want to move your Kafka data to a different disk or storage device. To do this, you must create a partition reassignment plan that specifies the new log directory for each topic.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="generating_a_partition_reassignment_plan"><a class="link" href="#generating_a_partition_reassignment_plan">18.1.1. Generating a partition reassignment plan</a></h4>
<div class="paragraph">
<p>The partition reassignment tool (<code>kafka-reassign-partitions.sh</code>) works by generating a partition assignment plan that specifies which partitions should be moved from their current broker to a new broker.</p>
</div>
<div class="paragraph">
<p>If you are satisfied with the plan, you can execute it.
The tool then does the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Migrates the partition data to the new broker</p>
</li>
<li>
<p>Updates the metadata on the Kafka brokers to reflect the new partition assignments</p>
</li>
<li>
<p>Triggers a rolling restart of the Kafka brokers to ensure that the new assignments take effect</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The partition reassignment tool has three different modes:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>--generate</code></dt>
<dd>
<p>Takes a set of topics and brokers and generates a <em>reassignment JSON file</em> which will result in the partitions of those topics being assigned to those brokers.
Because this operates on whole topics, it cannot be used when you only want to reassign some partitions of some topics.</p>
</dd>
<dt class="hdlist1"><code>--execute</code></dt>
<dd>
<p>Takes a <em>reassignment JSON file</em> and applies it to the partitions and brokers in the cluster.
Brokers that gain partitions as a result become followers of the partition leader.
For a given partition, once the new broker has caught up and joined the ISR (in-sync replicas) the old broker will stop being a follower and will delete its replica.</p>
</dd>
<dt class="hdlist1"><code>--verify</code></dt>
<dd>
<p>Using the same <em>reassignment JSON file</em> as the <code>--execute</code> step, <code>--verify</code> checks whether all the partitions in the file have been moved to their intended brokers.
If the reassignment is complete, <code>--verify</code> also removes any traffic throttles (<code>--throttle</code>) that are in effect.
Unless removed, throttles will continue to affect the cluster even after the reassignment has finished.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>It is only possible to have one reassignment running in a cluster at any given time, and it is not possible to cancel a running reassignment.
If you must cancel a reassignment, wait for it to complete and then perform another reassignment to revert the effects of the first reassignment.
The <code>kafka-reassign-partitions.sh</code> will print the reassignment JSON for this reversion as part of its output.
Very large reassignments should be broken down into a number of smaller reassignments in case there is a need to stop in-progress reassignment.</p>
</div>
</div>
<div class="sect3">
<h4 id="specifying_topics_in_a_partition_reassignment_json_file"><a class="link" href="#specifying_topics_in_a_partition_reassignment_json_file">18.1.2. Specifying topics in a partition reassignment JSON file</a></h4>
<div class="paragraph">
<p>The <code>kafka-reassign-partitions.sh</code> tool uses a reassignment JSON file that specifies the topics to reassign.
You can generate a reassignment JSON file or create a file manually if you want to move specific partitions.</p>
</div>
<div class="paragraph">
<p>A basic reassignment JSON file has the structure presented in the following example, which describes three partitions belonging to two Kafka topics.
Each partition is reassigned to a new set of replicas, which are identified by their broker IDs.
The <code>version</code>, <code>topic</code>, <code>partition</code>, and <code>replicas</code> properties are all required.</p>
</div>
<div class="listingblock">
<div class="title">Example partition reassignment JSON file structure</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">{
  "version": 1, # <b class="conum">(1)</b>
  "partitions": [ # <b class="conum">(2)</b>
    {
      "topic": "example-topic-1", # <b class="conum">(3)</b>
      "partition": 0, # <b class="conum">(4)</b>
      "replicas": [1, 2, 3] # <b class="conum">(5)</b>
    },
    {
      "topic": "example-topic-1",
      "partition": 1,
      "replicas": [2, 3, 4]
    },
    {
      "topic": "example-topic-2",
      "partition": 0,
      "replicas": [3, 4, 5]
    }
  ]
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The version of the reassignment JSON file format. Currently, only version 1 is supported, so this should always be 1.</p>
</li>
<li>
<p>An array that specifies the partitions to be reassigned.</p>
</li>
<li>
<p>The name of the Kafka topic that the partition belongs to.</p>
</li>
<li>
<p>The ID of the partition being reassigned.</p>
</li>
<li>
<p>An ordered array of the IDs of the brokers that should be assigned as replicas for this partition. The first broker in the list is the leader replica.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Partitions not included in the JSON are not changed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you specify only topics using a <code>topics</code> array, the partition reassignment tool reassigns all the partitions belonging to the specified topics.</p>
</div>
<div class="listingblock">
<div class="title">Example reassignment JSON file structure for reassigning all partitions for a topic</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">{
  "version": 1,
  "topics": [
    { "topic": "my-topic"}
  ]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="reassigning_partitions_between_jbod_volumes"><a class="link" href="#reassigning_partitions_between_jbod_volumes">18.1.3. Reassigning partitions between JBOD volumes</a></h4>
<div class="paragraph">
<p>When using JBOD storage in your Kafka cluster, you can reassign the partitions between specific volumes and their log directories (each volume has a single log directory).</p>
</div>
<div class="paragraph">
<p>To reassign a partition to a specific volume, add <code>log_dirs</code> values for each partition in the reassignment JSON file.
Each <code>log_dirs</code> array contains the same number of entries as the <code>replicas</code> array, since each replica should be assigned to a specific log directory.
The <code>log_dirs</code> array contains either an absolute path to a log directory or the special value <code>any</code>.
The <code>any</code> value indicates that Kafka can choose any available log directory for that replica, which can be useful when reassigning partitions between JBOD volumes.</p>
</div>
<div class="listingblock">
<div class="title">Example reassignment JSON file structure with log directories</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">{
  "version": 1,
  "partitions": [
    {
      "topic": "example-topic-1",
      "partition": 0,
      "replicas": [1, 2, 3]
      "log_dirs": ["/var/lib/kafka/data-0/kafka-log1", "any", "/var/lib/kafka/data-1/kafka-log2"]
    },
    {
      "topic": "example-topic-1",
      "partition": 1,
      "replicas": [2, 3, 4]
      "log_dirs": ["any",  "/var/lib/kafka/data-2/kafka-log3", "/var/lib/kafka/data-3/kafka-log4"]
    },
    {
      "topic": "example-topic-2",
      "partition": 0,
      "replicas": [3, 4, 5]
      "log_dirs": ["/var/lib/kafka/data-4/kafka-log5", "any",  "/var/lib/kafka/data-5/kafka-log6"]
    }
  ]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="throttling_partition_reassignment"><a class="link" href="#throttling_partition_reassignment">18.1.4. Throttling partition reassignment</a></h4>
<div class="paragraph">
<p>Partition reassignment can be a slow process because it involves transferring large amounts of data between brokers.
To avoid a detrimental impact on clients, you can throttle the reassignment process.
Use the <code>--throttle</code> parameter with the <code>kafka-reassign-partitions.sh</code> tool to throttle a reassignment.
You specify a maximum threshold in bytes per second for the movement of partitions between brokers.
For example, <code>--throttle 5000000</code> sets a maximum threshold for moving partitions of 50 MBps.</p>
</div>
<div class="paragraph">
<p>Throttling might cause the reassignment to take longer to complete.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the throttle is too low, the newly assigned brokers will not be able to keep up with records being published and the reassignment will never complete.</p>
</li>
<li>
<p>If the throttle is too high, clients will be impacted.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, for producers, this could manifest as higher than normal latency waiting for acknowledgment.
For consumers, this could manifest as a drop in throughput caused by higher latency between polls.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="proc-generating-reassignment-json-files-str"><a class="link" href="#proc-generating-reassignment-json-files-str">18.2. Generating a reassignment JSON file to reassign partitions</a></h3>
<div class="paragraph _abstract">
<p>Generate a reassignment JSON file with the <code>kafka-reassign-partitions.sh</code> tool to reassign partitions after scaling a Kafka cluster.
Adding or removing brokers does not automatically redistribute the existing partitions.
To balance the partition distribution and take full advantage of the new brokers, you can reassign the partitions using the <code>kafka-reassign-partitions.sh</code> tool.</p>
</div>
<div class="paragraph">
<p>You run the tool from an interactive pod container connected to the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>The following procedure describes a secure reassignment process that uses mTLS.
You&#8217;ll need a Kafka cluster that uses TLS encryption and mTLS authentication.</p>
</div>
<div class="paragraph">
<p>You&#8217;ll need the following to establish a connection:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The cluster CA certificate and password generated by the Cluster Operator when the Kafka cluster is created</p>
</li>
<li>
<p>The user CA certificate and password generated by the User Operator when a user is created for client access to the Kafka cluster</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this procedure, the CA certificates and corresponding passwords are extracted from the cluster and user secrets that contain them in PKCS #12 (<code>.p12</code> and <code>.password</code>) format.
The passwords allow access to the <code>.p12</code> stores that contain the certificates.
You use the <code>.p12</code> stores to specify a truststore and keystore to authenticate connection to the Kafka cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have a running Cluster Operator.</p>
</li>
<li>
<p>You have a running Kafka cluster based on a <code>Kafka</code> resource configured with internal TLS encryption and mTLS authentication.</p>
<div class="listingblock">
<div class="title">Kafka configuration with TLS encryption and mTLS authentication</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
    listeners:
      # ...
      - name: tls
        port: 9093
        type: internal
        tls: true <b class="conum">(1)</b>
        authentication:
          type: tls <b class="conum">(2)</b>
    # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Enables TLS encryption for the internal listener.</p>
</li>
<li>
<p>Listener authentication mechanism specified as mutual <code>tls</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>The running Kafka cluster contains a set of topics and partitions to reassign.</p>
<div class="listingblock">
<div class="title">Example topic configuration for <code>my-topic</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: my-topic
  labels:
    strimzi.io/cluster: my-cluster
spec:
  partitions: 10
  replicas: 3
  config:
    retention.ms: 7200000
    segment.bytes: 1073741824
    # ...</code></pre>
</div>
</div>
</li>
<li>
<p>You have a <code>KafkaUser</code> configured with ACL rules that specify permission to produce and consume topics from the Kafka brokers.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example Kafka user configuration with ACL rules to allow operations on <code>my-topic</code> and <code>my-cluster</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster
spec:
  authentication: <b class="conum">(1)</b>
    type: tls
  authorization:
    type: simple <b class="conum">(2)</b>
    acls:
      # access to the topic
      - resource:
          type: topic
          name: my-topic
        operations:
          - Create
          - Describe
          - Read
          - AlterConfigs
        host: "*"
      # access to the cluster
      - resource:
          type: cluster
        operations:
          - Alter
          - AlterConfigs
        host: "*"
      # ...
  # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>User authentication mechanism defined as mutual <code>tls</code>.</p>
</li>
<li>
<p>Simple authorization and accompanying list of ACL rules.</p>
</li>
</ol>
</div>
</div>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Extract the cluster CA certificate and password from the <code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code> secret of the Kafka cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>&lt;cluster_name&gt;</em>-cluster-ca-cert -o jsonpath='{.data.ca\.p12}' | base64 -d &gt; ca.p12</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>&lt;cluster_name&gt;</em>-cluster-ca-cert -o jsonpath='{.data.ca\.password}' | base64 -d &gt; ca.password</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;cluster_name&gt;</em> with the name of the Kafka cluster.
When you deploy Kafka using the <code>Kafka</code> resource, a secret with the cluster CA certificate is created with the Kafka cluster name (<code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code>).
For example, <code>my-cluster-cluster-ca-cert</code>.</p>
</div>
</li>
<li>
<p>Run a new interactive pod container using the Strimzi Kafka image to connect to a running Kafka broker.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl run --restart=Never --image=quay.io/strimzi/kafka:0.39.0-kafka-3.6.1 <em>&lt;interactive_pod_name&gt;</em> -- /bin/sh -c "sleep 3600"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;interactive_pod_name&gt;</em> with the name of the pod.</p>
</div>
</li>
<li>
<p>Copy the cluster CA certificate to the interactive pod container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl cp ca.p12 <em>&lt;interactive_pod_name&gt;</em>:/tmp</code></pre>
</div>
</div>
</li>
<li>
<p>Extract the user CA certificate and password from the secret of the Kafka user that has permission to access the Kafka brokers.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>&lt;kafka_user&gt;</em> -o jsonpath='{.data.user\.p12}' | base64 -d &gt; user.p12</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>&lt;kafka_user&gt;</em> -o jsonpath='{.data.user\.password}' | base64 -d &gt; user.password</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;kafka_user&gt;</em> with the name of the Kafka user.
When you create a Kafka user using the <code>KafkaUser</code> resource, a secret with the user CA certificate is created with the Kafka user name.
For example, <code>my-user</code>.</p>
</div>
</li>
<li>
<p>Copy the user CA certificate to the interactive pod container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl cp user.p12 <em>&lt;interactive_pod_name&gt;</em>:/tmp</code></pre>
</div>
</div>
<div class="paragraph">
<p>The CA certificates allow the interactive pod container to connect to the Kafka broker using TLS.</p>
</div>
</li>
<li>
<p>Create a <code>config.properties</code> file to specify the truststore and keystore used to authenticate connection to the Kafka cluster.</p>
<div class="paragraph">
<p>Use the certificates and passwords you extracted in the previous steps.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">bootstrap.servers=<em>&lt;kafka_cluster_name&gt;</em>-kafka-bootstrap:9093 <b class="conum">(1)</b>
security.protocol=SSL <b class="conum">(2)</b>
ssl.truststore.location=/tmp/ca.p12 <b class="conum">(3)</b>
ssl.truststore.password=<em>&lt;truststore_password&gt;</em> <b class="conum">(4)</b>
ssl.keystore.location=/tmp/user.p12 <b class="conum">(5)</b>
ssl.keystore.password=<em>&lt;keystore_password&gt;</em> <b class="conum">(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The bootstrap server address to connect to the Kafka cluster. Use your own Kafka cluster name to replace <em>&lt;kafka_cluster_name&gt;</em>.</p>
</li>
<li>
<p>The security protocol option when using TLS for encryption.</p>
</li>
<li>
<p>The truststore location contains the public key certificate (<code>ca.p12</code>) for the Kafka cluster.</p>
</li>
<li>
<p>The password (<code>ca.password</code>) for accessing the truststore.</p>
</li>
<li>
<p>The keystore location contains the public key certificate (<code>user.p12</code>) for the Kafka user.</p>
</li>
<li>
<p>The password (<code>user.password</code>) for accessing the keystore.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Copy the <code>config.properties</code> file to the interactive pod container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl cp config.properties <em>&lt;interactive_pod_name&gt;</em>:/tmp/config.properties</code></pre>
</div>
</div>
</li>
<li>
<p>Prepare a JSON file named <code>topics.json</code> that specifies the topics to move.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Specify topic names as a comma-separated list.</p>
</div>
<div class="listingblock">
<div class="title">Example JSON file to reassign all the partitions of <code>my-topic</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "version": 1,
  "topics": [
    { "topic": "my-topic"}
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use this file to <a href="#proc-changing-topic-replicas-str">change the replication factor of a topic</a>.</p>
</div>
</div>
</div>
</li>
<li>
<p>Copy the <code><em>topics.json</em></code> file to the interactive pod container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl cp topics.json <em>&lt;interactive_pod_name&gt;</em>:/tmp/topics.json</code></pre>
</div>
</div>
</li>
<li>
<p>Start a shell process in the interactive pod container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl exec -n <em>&lt;namespace&gt;</em> -ti <em>&lt;interactive_pod_name&gt;</em> /bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;namespace&gt;</em> with the Kubernetes namespace where the pod is running.</p>
</div>
</li>
<li>
<p>Use the <code>kafka-reassign-partitions.sh</code> command to generate the reassignment JSON.</p>
<div class="listingblock">
<div class="title">Example command to move the partitions of <code>my-topic</code> to specified brokers</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-reassign-partitions.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 \
  --command-config /tmp/config.properties \
  --topics-to-move-json-file /tmp/topics.json \
  --broker-list 0,1,2,3,4 \
  --generate</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#con-config-kafka-str">Configuring Kafka</a></p>
</li>
<li>
<p><a href="#proc-configuring-kafka-topic-str">Configuring Kafka topics</a></p>
</li>
<li>
<p><a href="#proc-configuring-kafka-user-str">Configuring Kafka users</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="proc-scaling-up-a-kafka-cluster-str"><a class="link" href="#proc-scaling-up-a-kafka-cluster-str">18.3. Reassigning partitions after adding brokers</a></h3>
<div class="paragraph _abstract">
<p>Use a reassignment file generated by the <code>kafka-reassign-partitions.sh</code> tool to reassign partitions after increasing the number of brokers in a Kafka cluster.
The reassignment file should describe how partitions are reassigned to brokers in the enlarged Kafka cluster.
You apply the reassignment specified in the file to the brokers and then verify the new partition assignments.</p>
</div>
<div class="paragraph">
<p>This procedure describes a secure scaling process that uses TLS.
You&#8217;ll need a Kafka cluster that uses TLS encryption and mTLS authentication.</p>
</div>
<div class="paragraph">
<p>The <code>kafka-reassign-partitions.sh</code> tool can be used to reassign partitions within a Kafka cluster, regardless of whether you are managing all nodes through the cluster or using the node pools preview to manage groups of nodes within the cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Though you can use the <code>kafka-reassign-partitions.sh</code> tool, Cruise Control is recommended <a href="#cruise-control-concepts-str">for automated partition reassignments and cluster rebalancing</a>.
Cruise Control can move topics from one broker to another without any downtime, and it is the most efficient way to reassign partitions.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have a running Kafka cluster based on a <code>Kafka</code> resource configured with internal TLS encryption and mTLS authentication.</p>
</li>
<li>
<p>You have <a href="#proc-generating-reassignment-json-files-str">generated a reassignment JSON file</a> named <code>reassignment.json</code>.</p>
</li>
<li>
<p>You are running an interactive pod container that is connected to the running Kafka broker.</p>
</li>
<li>
<p>You are connected as a <code>KafkaUser</code> configured with ACL rules that specify permission to manage the Kafka cluster and its topics.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add as many new brokers as you need by increasing the <code>Kafka.spec.kafka.replicas</code> configuration option.</p>
</li>
<li>
<p>Verify that the new broker pods have started.</p>
</li>
<li>
<p>If you haven&#8217;t done so, <a href="#proc-generating-reassignment-json-files-str">run an interactive pod container to generate a reassignment JSON file</a> named <code>reassignment.json</code>.</p>
</li>
<li>
<p>Copy the <code>reassignment.json</code> file to the interactive pod container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl cp reassignment.json <em>&lt;interactive_pod_name&gt;</em>:/tmp/reassignment.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;interactive_pod_name&gt;</em> with the name of the pod.</p>
</div>
</li>
<li>
<p>Start a shell process in the interactive pod container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl exec -n <em>&lt;namespace&gt;</em> -ti <em>&lt;interactive_pod_name&gt;</em> /bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;namespace&gt;</em> with the Kubernetes namespace where the pod is running.</p>
</div>
</li>
<li>
<p>Run the partition reassignment using the <code>kafka-reassign-partitions.sh</code> script from the interactive pod container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-reassign-partitions.sh --bootstrap-server
 <em>&lt;cluster_name&gt;</em>-kafka-bootstrap:9093 \
 --command-config /tmp/config.properties \
 --reassignment-json-file /tmp/reassignment.json \
 --execute</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;cluster_name&gt;</em> with the name of your Kafka cluster.
For example, <code>my-cluster-kafka-bootstrap:9093</code></p>
</div>
<div class="paragraph">
<p>If you are going to throttle replication, you can also pass the <code>--throttle</code> option with an inter-broker throttled rate in bytes per second. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-reassign-partitions.sh --bootstrap-server
  <em>&lt;cluster_name&gt;</em>-kafka-bootstrap:9093 \
  --command-config /tmp/config.properties \
  --reassignment-json-file /tmp/reassignment.json \
  --throttle 5000000 \
  --execute</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will print out two reassignment JSON objects.
The first records the current assignment for the partitions being moved.
You should save this to a local file (not a file in the pod) in case you need to revert the reassignment later on.
The second JSON object is the target reassignment you have passed in your reassignment JSON file.</p>
</div>
<div class="paragraph">
<p>If you need to change the throttle during reassignment, you can use the same command with a different throttled rate. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-reassign-partitions.sh --bootstrap-server
  <em>&lt;cluster_name&gt;</em>-kafka-bootstrap:9093 \
  --command-config /tmp/config.properties \
  --reassignment-json-file /tmp/reassignment.json \
  --throttle 10000000 \
  --execute</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the reassignment has completed using the <code>kafka-reassign-partitions.sh</code> command line tool from any of the broker pods.
This is the same command as the previous step, but with the <code>--verify</code> option instead of the <code>--execute</code> option.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-reassign-partitions.sh --bootstrap-server
  <em>&lt;cluster_name&gt;</em>-kafka-bootstrap:9093 \
  --command-config /tmp/config.properties \
  --reassignment-json-file /tmp/reassignment.json \
  --verify</code></pre>
</div>
</div>
<div class="paragraph">
<p>The reassignment has finished when the <code>--verify</code> command reports that each of the partitions being moved has completed successfully.
This final <code>--verify</code> will also have the effect of removing any reassignment throttles.</p>
</div>
</li>
<li>
<p>You can now delete the revert file if you saved the JSON for reverting the assignment to their original brokers.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="proc-scaling-down-a-kafka-cluster-str"><a class="link" href="#proc-scaling-down-a-kafka-cluster-str">18.4. Reassigning partitions before removing brokers</a></h3>
<div class="paragraph _abstract">
<p>Use a reassignment file generated by the <code>kafka-reassign-partitions.sh</code> tool to reassign partitions before decreasing the number of brokers in a Kafka cluster.
The reassignment file must describe how partitions are reassigned to the remaining brokers in the Kafka cluster.
You apply the reassignment specified in the file to the brokers and then verify the new partition assignments.
Brokers in the highest numbered pods are removed first.</p>
</div>
<div class="paragraph">
<p>This procedure describes a secure scaling process that uses TLS.
You&#8217;ll need a Kafka cluster that uses TLS encryption and mTLS authentication.</p>
</div>
<div class="paragraph">
<p>The <code>kafka-reassign-partitions.sh</code> tool can be used to reassign partitions within a Kafka cluster, regardless of whether you are managing all nodes through the cluster or using the node pools preview to manage groups of nodes within the cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Though you can use the <code>kafka-reassign-partitions.sh</code> tool, Cruise Control is recommended <a href="#cruise-control-concepts-str">for automated partition reassignments and cluster rebalancing</a>.
Cruise Control can move topics from one broker to another without any downtime, and it is the most efficient way to reassign partitions.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have a running Kafka cluster based on a <code>Kafka</code> resource configured with internal TLS encryption and mTLS authentication.</p>
</li>
<li>
<p>You have <a href="#proc-generating-reassignment-json-files-str">generated a reassignment JSON file</a> named <code>reassignment.json</code>.</p>
</li>
<li>
<p>You are running an interactive pod container that is connected to the running Kafka broker.</p>
</li>
<li>
<p>You are connected as a <code>KafkaUser</code> configured with ACL rules that specify permission to manage the Kafka cluster and its topics.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>If you haven&#8217;t done so, <a href="#proc-generating-reassignment-json-files-str">run an interactive pod container to generate a reassignment JSON file</a> named <code>reassignment.json</code>.</p>
</li>
<li>
<p>Copy the <code>reassignment.json</code> file to the interactive pod container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl cp reassignment.json <em>&lt;interactive_pod_name&gt;</em>:/tmp/reassignment.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;interactive_pod_name&gt;</em> with the name of the pod.</p>
</div>
</li>
<li>
<p>Start a shell process in the interactive pod container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl exec -n <em>&lt;namespace&gt;</em> -ti <em>&lt;interactive_pod_name&gt;</em> /bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;namespace&gt;</em> with the Kubernetes namespace where the pod is running.</p>
</div>
</li>
<li>
<p>Run the partition reassignment using the <code>kafka-reassign-partitions.sh</code> script from the interactive pod container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-reassign-partitions.sh --bootstrap-server
 <em>&lt;cluster_name&gt;</em>-kafka-bootstrap:9093 \
 --command-config /tmp/config.properties \
 --reassignment-json-file /tmp/reassignment.json \
 --execute</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;cluster_name&gt;</em> with the name of your Kafka cluster.
For example, <code>my-cluster-kafka-bootstrap:9093</code></p>
</div>
<div class="paragraph">
<p>If you are going to throttle replication, you can also pass the <code>--throttle</code> option with an inter-broker throttled rate in bytes per second. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-reassign-partitions.sh --bootstrap-server
  <em>&lt;cluster_name&gt;</em>-kafka-bootstrap:9093 \
  --command-config /tmp/config.properties \
  --reassignment-json-file /tmp/reassignment.json \
  --throttle 5000000 \
  --execute</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will print out two reassignment JSON objects.
The first records the current assignment for the partitions being moved.
You should save this to a local file (not a file in the pod) in case you need to revert the reassignment later on.
The second JSON object is the target reassignment you have passed in your reassignment JSON file.</p>
</div>
<div class="paragraph">
<p>If you need to change the throttle during reassignment, you can use the same command with a different throttled rate. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-reassign-partitions.sh --bootstrap-server
  <em>&lt;cluster_name&gt;</em>-kafka-bootstrap:9093 \
  --command-config /tmp/config.properties \
  --reassignment-json-file /tmp/reassignment.json \
  --throttle 10000000 \
  --execute</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the reassignment has completed using the <code>kafka-reassign-partitions.sh</code> command line tool from any of the broker pods.
This is the same command as the previous step, but with the <code>--verify</code> option instead of the <code>--execute</code> option.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-reassign-partitions.sh --bootstrap-server
  <em>&lt;cluster_name&gt;</em>-kafka-bootstrap:9093 \
  --command-config /tmp/config.properties \
  --reassignment-json-file /tmp/reassignment.json \
  --verify</code></pre>
</div>
</div>
<div class="paragraph">
<p>The reassignment has finished when the <code>--verify</code> command reports that each of the partitions being moved has completed successfully.
This final <code>--verify</code> will also have the effect of removing any reassignment throttles.</p>
</div>
</li>
<li>
<p>You can now delete the revert file if you saved the JSON for reverting the assignment to their original brokers.</p>
</li>
<li>
<p>When all the partition reassignments have finished, the brokers being removed should not have responsibility for any of the partitions in the cluster.
You can verify this by checking that the broker&#8217;s data log directory does not contain any live partition logs.
If the log directory on the broker contains a directory that does not match the extended regular expression <code><span class="a-zA-Z0-9.-">\.[a-z0-9]</span>-delete$</code>, the broker still has live partitions and should not be stopped.</p>
<div class="paragraph">
<p>You can check this by executing the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl exec my-cluster-kafka-0 -c kafka -it -- \
  /bin/bash -c \
  "ls -l /var/lib/kafka/kafka-log_&lt;n&gt;_ | grep -E '^d' | grep -vE '[a-zA-Z0-9.-]+\.[a-z0-9]+-delete$'"</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <em>n</em> is the number of the pods being deleted.</p>
</div>
<div class="paragraph">
<p>If the above command prints any output then the broker still has live partitions.
In this case, either the reassignment has not finished or the reassignment JSON file was incorrect.</p>
</div>
</li>
<li>
<p>When you have confirmed that the broker has no live partitions, you can edit the <code>Kafka.spec.kafka.replicas</code> property of your <code>Kafka</code> resource to reduce the number of brokers.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="proc-changing-topic-replicas-str"><a class="link" href="#proc-changing-topic-replicas-str">18.5. Changing the replication factor of topics</a></h3>
<div class="paragraph _abstract">
<p>To change the replication factor of topics in a Kafka cluster, use the <code>kafka-reassign-partitions.sh</code> tool.
This can be done by running the tool from an interactive pod container that is connected to the Kafka cluster,
and using a reassignment file to describe how the topic replicas should be changed.</p>
</div>
<div class="paragraph">
<p>This procedure describes a secure process that uses TLS.
You&#8217;ll need a Kafka cluster that uses TLS encryption and mTLS authentication.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have a running Kafka cluster based on a <code>Kafka</code> resource configured with internal TLS encryption and mTLS authentication.</p>
</li>
<li>
<p>You are running an interactive pod container that is connected to the running Kafka broker.</p>
</li>
<li>
<p>You have generated a reassignment JSON file named <code>reassignment.json</code>.</p>
</li>
<li>
<p>You are connected as a <code>KafkaUser</code> configured with ACL rules that specify permission to manage the Kafka cluster and its topics.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See <a href="#proc-generating-reassignment-json-files-str">Generating reassignment JSON files</a>.</p>
</div>
<div class="paragraph">
<p>In this procedure, a topic called <code>my-topic</code> has 4 replicas and we want to reduce it to 3.
A JSON file named <code>topics.json</code> specifies the topic, and was used to generate the <code>reassignment.json</code> file.</p>
</div>
<div class="listingblock">
<div class="title">Example JSON file specifies <code>my-topic</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "version": 1,
  "topics": [
    { "topic": "my-topic"}
  ]
}</code></pre>
</div>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>If you haven&#8217;t done so, <a href="#proc-generating-reassignment-json-files-str">run an interactive pod container to generate a reassignment JSON file</a> named <code>reassignment.json</code>.</p>
<div class="listingblock">
<div class="title">Example reassignment JSON file showing the current and proposed replica assignment</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Current partition replica assignment
{"version":1,"partitions":[{"topic":"my-topic","partition":0,"replicas":[3,4,2,0],"log_dirs":["any","any","any","any"]},{"topic":"my-topic","partition":1,"replicas":[0,2,3,1],"log_dirs":["any","any","any","any"]},{"topic":"my-topic","partition":2,"replicas":[1,3,0,4],"log_dirs":["any","any","any","any"]}]}

Proposed partition reassignment configuration
{"version":1,"partitions":[{"topic":"my-topic","partition":0,"replicas":[0,1,2,3],"log_dirs":["any","any","any","any"]},{"topic":"my-topic","partition":1,"replicas":[1,2,3,4],"log_dirs":["any","any","any","any"]},{"topic":"my-topic","partition":2,"replicas":[2,3,4,0],"log_dirs":["any","any","any","any"]}]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Save a copy of this file locally in case you need to revert the changes later on.</p>
</div>
</li>
<li>
<p>Edit the <code>reassignment.json</code> to remove a replica from each partition.</p>
<div class="paragraph">
<p>For example use <code>jq</code> to remove the last replica in the list for each partition of the topic:</p>
</div>
<div class="listingblock">
<div class="title">Removing the last topic replica for each partition</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">jq '.partitions[].replicas |= del(.[-1])' reassignment.json &gt; reassignment.json</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example reassignment file showing the updated replicas</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">{"version":1,"partitions":[{"topic":"my-topic","partition":0,"replicas":[0,1,2],"log_dirs":["any","any","any","any"]},{"topic":"my-topic","partition":1,"replicas":[1,2,3],"log_dirs":["any","any","any","any"]},{"topic":"my-topic","partition":2,"replicas":[2,3,4],"log_dirs":["any","any","any","any"]}]}</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the <code>reassignment.json</code> file to the interactive pod container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl cp reassignment.json <em>&lt;interactive_pod_name&gt;</em>:/tmp/reassignment.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;interactive_pod_name&gt;</em> with the name of the pod.</p>
</div>
</li>
<li>
<p>Start a shell process in the interactive pod container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl exec -n <em>&lt;namespace&gt;</em> -ti <em>&lt;interactive_pod_name&gt;</em> /bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;namespace&gt;</em> with the Kubernetes namespace where the pod is running.</p>
</div>
</li>
<li>
<p>Make the topic replica change using the <code>kafka-reassign-partitions.sh</code> script from the interactive pod container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-reassign-partitions.sh --bootstrap-server
 <em>&lt;cluster_name&gt;</em>-kafka-bootstrap:9093 \
 --command-config /tmp/config.properties \
 --reassignment-json-file /tmp/reassignment.json \
 --execute</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Removing replicas from a broker does not require any inter-broker data movement, so there is no need to throttle replication.
If you are adding replicas, then you may want to change the throttle rate.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Verify that the change to the topic replicas has completed using the <code>kafka-reassign-partitions.sh</code> command line tool from any of the broker pods.
This is the same command as the previous step, but with the <code>--verify</code> option instead of the <code>--execute</code> option.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-reassign-partitions.sh --bootstrap-server
  <em>&lt;cluster_name&gt;</em>-kafka-bootstrap:9093 \
  --command-config /tmp/config.properties \
  --reassignment-json-file /tmp/reassignment.json \
  --verify</code></pre>
</div>
</div>
<div class="paragraph">
<p>The reassignment has finished when the <code>--verify</code> command reports that each of the partitions being moved has completed successfully.
This final <code>--verify</code> will also have the effect of removing any reassignment throttles.</p>
</div>
</li>
<li>
<p>Run the <code>bin/kafka-topics.sh</code> command with the <code>--describe</code> option to see the results of the change to the topics.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-topics.sh --bootstrap-server
  <em>&lt;cluster_name&gt;</em>-kafka-bootstrap:9093 \
  --command-config /tmp/config.properties \
  --describe</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results of reducing the number of replicas for a topic</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">my-topic  Partition: 0  Leader: 0  Replicas: 0,1,2 Isr: 0,1,2
my-topic  Partition: 1  Leader: 2  Replicas: 1,2,3 Isr: 1,2,3
my-topic  Partition: 2  Leader: 3  Replicas: 2,3,4 Isr: 2,3,4</code></pre>
</div>
</div>
</li>
<li>
<p>Finally, edit the <code>KafkaTopic</code> custom resource to change <code>.spec.replicas</code> to 3, and then wait the reconciliation.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: my-topic
  labels:
    strimzi.io/cluster: my-cluster
spec:
  partitions: 3
  replicas: 3</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-metrics-str"><a class="link" href="#assembly-metrics-str">19. Introducing metrics</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Collecting metrics is critical for understanding the health and performance of your Kafka deployment.
By monitoring metrics, you can actively identify issues before they become critical and make informed decisions about resource allocation and capacity planning. Without metrics, you may be left with limited visibility into the behavior of your Kafka deployment, which can make troubleshooting more difficult and time-consuming. Setting up metrics can save you time and resources in the long run, and help ensure the reliability of your Kafka deployment.</p>
</div>
<div class="paragraph">
<p>Metrics are available for each component in Strimzi, providing valuable insights into their individual performance.
While other components require configuration to expose metrics, Strimzi operators automatically expose Prometheus metrics by default.
These metrics include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reconciliation count</p>
</li>
<li>
<p>Custom Resource count being processed</p>
</li>
<li>
<p>Reconciliation duration</p>
</li>
<li>
<p>JVM metrics</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can also collect metrics specific to <code>oauth</code> authentication and <code>opa</code> or <code>keycloak</code> authorization by enabling the <code>enableMetrics</code> property in the listener or authorization configuration of the <code>Kafka</code> resource.
Similarly, you can enable metrics for <code>oauth</code> authentication in custom resources such as <code>KafkaBridge</code>, <code>KafkaConnect</code>, <code>KafkaMirrorMaker</code>, and <code>KafkaMirrorMaker2</code>.</p>
</div>
<div class="paragraph">
<p>You can use Prometheus and Grafana to monitor Strimzi.
Prometheus consumes metrics from the running pods in your cluster when configured with Prometheus rules.
Grafana visualizes these metrics on dashboards, providing an intuitive interface for monitoring.</p>
</div>
<div class="paragraph">
<p>To facilitate metrics integration, Strimzi provides example Prometheus rules and Grafana dashboards for Strimzi components.
You can customize the example Grafana dashboards to suit your specific deployment requirements.
You can use rules to define conditions that trigger alerts based on specific metrics.</p>
</div>
<div class="paragraph">
<p>Depending on your monitoring requirements, you can do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#assembly-metrics-setup-str">Set up and deploy Prometheus to expose metrics</a></p>
</li>
<li>
<p><a href="#proc-metrics-kafka-deploy-options-str">Deploy Kafka Exporter to provide additional metrics</a></p>
</li>
<li>
<p><a href="#proc-metrics-grafana-dashboard-str">Use Grafana to present the Prometheus metrics</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additionally, you can configure your deployment to track messages end-to-end by <a href="#assembly-distributed-tracing-str">setting up distributed tracing</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Strimzi provides example installation files for Prometheus and Grafana, which can serve as a starting point for monitoring your Strimzi deployment.
For further support, try engaging with the Prometheus and Grafana developer communities.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Supporting documentation for metrics and monitoring tools</div>
<p>For more information on the metrics and monitoring tools, refer to the supporting documentation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/prometheus" target="_blank" rel="noopener">Prometheus</a></p>
</li>
<li>
<p><a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration" target="_blank" rel="noopener">Prometheus configuration</a></p>
</li>
<li>
<p><a href="https://github.com/danielqsj/kafka_exporter" target="_blank" rel="noopener">Kafka Exporter</a></p>
</li>
<li>
<p><a href="https://grafana.com/" target="_blank" rel="noopener">Grafana Labs</a></p>
</li>
<li>
<p><a href="http://kafka.apache.org/documentation/#monitoring">Apache Kafka Monitoring</a> describes JMX metrics exposed by Apache Kafka</p>
</li>
<li>
<p><a href="https://zookeeper.apache.org/doc/current/zookeeperJMX.html">ZooKeeper JMX</a> describes JMX metrics exposed by Apache ZooKeeper</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="con-metrics-kafka-exporter-lag-str"><a class="link" href="#con-metrics-kafka-exporter-lag-str">19.1. Monitoring consumer lag with Kafka Exporter</a></h3>
<div class="paragraph _abstract">
<p><a href="https://github.com/danielqsj/kafka_exporter" target="_blank" rel="noopener">Kafka Exporter</a> is an open source project to enhance monitoring of Apache Kafka brokers and clients.
You can configure the <code>Kafka</code> resource to <a href="#proc-metrics-kafka-deploy-options-str">deploy Kafka Exporter with your Kafka cluster</a>.
Kafka Exporter extracts additional metrics data from Kafka brokers related to offsets, consumer groups, consumer lag, and topics.
The metrics data is used, for example, to help identify slow consumers.
Lag data is exposed as Prometheus metrics, which can then be presented in Grafana for analysis.</p>
</div>
<div class="paragraph">
<p>Kafka Exporter reads from the  <code>__consumer_offsets</code> topic, which stores information on committed offsets for consumer groups.
For Kafka Exporter to be able to work properly, consumer groups needs to be in use.</p>
</div>
<div class="paragraph">
<p>A Grafana dashboard for Kafka Exporter is one of a number of <a href="#ref-metrics-dashboards-str">example Grafana dashboards</a> provided by Strimzi.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Kafka Exporter provides only additional metrics related to consumer lag and consumer offsets.
For regular Kafka metrics, you have to configure the Prometheus metrics in <a href="#proc-metrics-kafka-deploy-options-str">Kafka brokers</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Consumer lag indicates the difference in the rate of production and consumption of messages.
Specifically, consumer lag for a given consumer group indicates the delay between the last message in the partition and the message being currently picked up by that consumer.</p>
</div>
<div class="paragraph">
<p>The lag reflects the position of the consumer offset in relation to the end of the partition log.</p>
</div>
<div class="paragraph">
<div class="title">Consumer lag between the producer and consumer offset</div>
<p><span class="image"><img src="images/consumer-lag.png" alt="Consumer lag"></span></p>
</div>
<div class="paragraph">
<p>This difference is sometimes referred to as the <em>delta</em> between the producer offset and consumer offset: the read and write positions in the Kafka broker topic partitions.</p>
</div>
<div class="paragraph">
<p>Suppose a topic streams 100 messages a second. A lag of 1000 messages between the producer offset (the topic partition head) and the last offset the consumer has read means a 10-second delay.</p>
</div>
<h4 id="the_importance_of_monitoring_consumer_lag" class="discrete">The importance of monitoring consumer lag</h4>
<div class="paragraph">
<p>For applications that rely on the processing of (near) real-time data, it is critical to monitor consumer lag to check that it does not become too big.
The greater the lag becomes, the further the process moves from the real-time processing objective.</p>
</div>
<div class="paragraph">
<p>Consumer lag, for example, might be a result of consuming too much old data that has not been purged, or through unplanned shutdowns.</p>
</div>
<h4 id="reducing_consumer_lag" class="discrete">Reducing consumer lag</h4>
<div class="paragraph">
<p>Use the Grafana charts to analyze lag and to check if actions to reduce lag are having an impact on an affected consumer group.
If, for example, Kafka brokers are adjusted to reduce lag, the dashboard will show the  <em>Lag by consumer group</em> chart going down and the <em>Messages consumed per minute</em> chart going up.</p>
</div>
<div class="paragraph">
<p>Typical actions to reduce lag include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Scaling-up consumer groups by adding new consumers</p>
</li>
<li>
<p>Increasing the retention time for a message to remain in a topic</p>
</li>
<li>
<p>Adding more disk capacity to increase the message buffer</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Actions to reduce consumer lag depend on the underlying infrastructure and the use cases Strimzi is supporting.
For instance, a lagging consumer is less likely to benefit from the broker being able to service a fetch request from its disk cache.
And in certain cases, it might be acceptable to automatically drop messages until a consumer has caught up.</p>
</div>
</div>
<div class="sect2">
<h3 id="con-metrics-cruise-control-str"><a class="link" href="#con-metrics-cruise-control-str">19.2. Monitoring Cruise Control operations</a></h3>
<div class="paragraph _abstract">
<p>Cruise Control monitors Kafka brokers in order to track the utilization of brokers, topics, and partitions.
Cruise Control also provides a set of metrics for monitoring its own performance.</p>
</div>
<div class="paragraph">
<p>The Cruise Control metrics reporter collects raw metrics data from Kafka brokers.
The data is produced to topics that are automatically created by Cruise Control.
The metrics are used to <a href="#proc-generating-optimization-proposals-str">generate optimization proposals for Kafka clusters</a>.</p>
</div>
<div class="paragraph">
<p>Cruise Control metrics are available for real-time monitoring of Cruise Control operations.
For example, you can use Cruise Control metrics to monitor the status of rebalancing operations that are running or provide alerts on any anomalies that are detected in an operation&#8217;s performance.</p>
</div>
<div class="paragraph">
<p>You expose Cruise Control metrics by <a href="#proc-metrics-kafka-deploy-options-str">enabling the <a href="https://github.com/prometheus/jmx_exporter" target="_blank" rel="noopener">Prometheus JMX Exporter</a> in the Cruise Control configuration</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
For a full list of available Cruise Control metrics, which are known as <em>sensors</em>, see the <a href="https://github.com/linkedin/cruise-control/wiki/Sensors" target="_blank" rel="noopener">Cruise Control documentation</a>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="monitoring_balancedness_scores"><a class="link" href="#monitoring_balancedness_scores">19.2.1. Monitoring balancedness scores</a></h4>
<div class="paragraph">
<p>Cruise Control metrics include a balancedness score.
Balancedness is the measure of how evenly a workload is distributed in a Kafka cluster.</p>
</div>
<div class="paragraph">
<p>The Cruise Control metric for balancedness score (<code>balancedness-score</code>) might differ from the balancedness score in the <code>KafkaRebalance</code> resource.
Cruise Control calculates each score using <code>anomaly.detection.goals</code> which might not be the same as the <code>default.goals</code> used in the <code>KafkaRebalance</code> resource.
The <code>anomaly.detection.goals</code> are specified in the <code>spec.cruiseControl.config</code> of the <code>Kafka</code> custom resource.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Refreshing the <code>KafkaRebalance</code> resource fetches an optimization proposal.
The latest cached optimization proposal is fetched if one of the following conditions applies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>KafkaRebalance <code>goals</code> match the goals configured in the <code>default.goals</code> section of the <code>Kafka</code> resource</p>
</li>
<li>
<p>KafkaRebalance <code>goals</code> are not specified</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Otherwise, Cruise Control generates a new optimization proposal based on KafkaRebalance <code>goals</code>. If new proposals are generated with each refresh, this can impact performance monitoring.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="setting_up_alerts_for_anomaly_detection"><a class="link" href="#setting_up_alerts_for_anomaly_detection">19.2.2. Setting up alerts for anomaly detection</a></h4>
<div class="paragraph">
<p>Cruise control&#8217;s <em>anomaly detector</em> provides metrics data for conditions that block the generation of optimization goals, such as broker failures.
If you want more visibility, you can use the metrics provided by the anomaly detector to set up alerts and send out notifications.
You can set up Cruise Control’s <em>anomaly notifier</em> to route alerts based on these metrics through a specified notification channel.
Alternatively, you can set up Prometheus to scrape the metrics data provided by the anomaly detector and generate alerts.
Prometheus Alertmanager can then route the alerts generated by Prometheus.</p>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/linkedin/cruise-control/wiki/Configurations" target="_blank" rel="noopener">Cruise Control documentation</a> provides information on <code>AnomalyDetector</code> metrics and the anomaly notifier.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-metrics-config-files-str"><a class="link" href="#assembly-metrics-config-files-str">19.3. Example metrics files</a></h3>
<div class="paragraph _abstract">
<p>You can find example Grafana dashboards and other metrics configuration files in the <a href="#config-examples-str">example configuration files</a> provided by Strimzi.</p>
</div>
<div class="listingblock">
<div class="title">Example metrics files provided with Strimzi</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">metrics
├── grafana-dashboards <b class="conum">(1)</b>
│   ├── strimzi-cruise-control.json
│   ├── strimzi-kafka-bridge.json
│   ├── strimzi-kafka-connect.json
│   ├── strimzi-kafka-exporter.json
│   ├── strimzi-kafka-mirror-maker-2.json
│   ├── strimzi-kafka.json
│   ├── strimzi-operators.json
│   └── strimzi-zookeeper.json
├── grafana-install
│   └── grafana.yaml <b class="conum">(2)</b>
├── prometheus-additional-properties
│   └── prometheus-additional.yaml <b class="conum">(3)</b>
├── prometheus-alertmanager-config
│   └── alert-manager-config.yaml <b class="conum">(4)</b>
├── prometheus-install
│    ├── alert-manager.yaml <b class="conum">(5)</b>
│    ├── prometheus-rules.yaml <b class="conum">(6)</b>
│    ├── prometheus.yaml <b class="conum">(7)</b>
│    └── strimzi-pod-monitor.yaml <b class="conum">(8)</b>
├── kafka-bridge-metrics.yaml <b class="conum">(9)</b>
├── kafka-connect-metrics.yaml <b class="conum">(10)</b>
├── kafka-cruise-control-metrics.yaml <b class="conum">(11)</b>
├── kafka-metrics.yaml <b class="conum">(12)</b>
└── kafka-mirror-maker-2-metrics.yaml <b class="conum">(13)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Example Grafana dashboards for the different Strimzi components.</p>
</li>
<li>
<p>Installation file for the Grafana image.</p>
</li>
<li>
<p>Additional configuration to scrape metrics for CPU, memory and disk volume usage, which comes directly from the Kubernetes cAdvisor agent and kubelet on the nodes.</p>
</li>
<li>
<p>Hook definitions for sending notifications through Alertmanager.</p>
</li>
<li>
<p>Resources for deploying and configuring Alertmanager.</p>
</li>
<li>
<p>Alerting rules examples for use with Prometheus Alertmanager (deployed with Prometheus).</p>
</li>
<li>
<p>Installation resource file for the Prometheus image.</p>
</li>
<li>
<p>PodMonitor definitions translated by the Prometheus Operator into jobs for the Prometheus server to be able to scrape metrics data directly from pods.</p>
</li>
<li>
<p>Kafka Bridge resource with metrics enabled.</p>
</li>
<li>
<p>Metrics configuration that defines Prometheus JMX Exporter relabeling rules for Kafka Connect.</p>
</li>
<li>
<p>Metrics configuration that defines Prometheus JMX Exporter relabeling rules for Cruise Control.</p>
</li>
<li>
<p>Metrics configuration that defines Prometheus JMX Exporter relabeling rules for Kafka and ZooKeeper.</p>
</li>
<li>
<p>Metrics configuration that defines Prometheus JMX Exporter relabeling rules for Kafka MirrorMaker 2.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="ref-metrics-prometheus-metrics-config-str"><a class="link" href="#ref-metrics-prometheus-metrics-config-str">19.3.1. Example Prometheus metrics configuration</a></h4>
<div class="paragraph _abstract">
<p>Strimzi uses the <a href="https://github.com/prometheus/jmx_exporter" target="_blank" rel="noopener">Prometheus JMX Exporter</a> to expose metrics through an HTTP endpoint, which can be scraped by the Prometheus server.</p>
</div>
<div class="paragraph">
<p>Grafana dashboards are dependent on Prometheus JMX Exporter relabeling rules, which are defined for Strimzi components in the custom resource configuration.</p>
</div>
<div class="paragraph">
<p>A label is a name-value pair.
Relabeling is the process of writing a label dynamically.
For example, the value of a label may be derived from the name of a Kafka server and client ID.</p>
</div>
<div class="paragraph">
<p>Strimzi provides example custom resource configuration YAML files with relabeling rules.
When deploying Prometheus metrics configuration, you can can deploy the example custom resource or copy the metrics configuration to your own custom resource definition.</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 34. Example custom resources with metrics configuration</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Custom resource</th>
<th class="tableblock halign-left valign-top">Example YAML file</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka and ZooKeeper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Kafka</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-metrics.yaml</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Connect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaConnect</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-connect-metrics.yaml</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka MirrorMaker 2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaMirrorMaker2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-mirror-maker-2-metrics.yaml</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Bridge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaBridge</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-bridge-metrics.yaml</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cruise Control</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Kafka</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-cruise-control-metrics.yaml</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="ref-metrics-alertmanager-examples-str"><a class="link" href="#ref-metrics-alertmanager-examples-str">19.3.2. Example Prometheus rules for alert notifications</a></h4>
<div class="paragraph _abstract">
<p>Example Prometheus rules for alert notifications are provided with the <a href="#assembly-metrics-config-files-str">example metrics configuration files</a> provided by Strimzi.
The rules are specified in the example <code>prometheus-rules.yaml</code> file for use in a <a href="#proc-metrics-deploying-prometheus-str">Prometheus deployment</a>.</p>
</div>
<div class="paragraph">
<p>The <code>prometheus-rules.yaml</code> file contains example rules for the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kafka</p>
</li>
<li>
<p>ZooKeeper</p>
</li>
<li>
<p>Entity Operator</p>
</li>
<li>
<p>Kafka Connect</p>
</li>
<li>
<p>Kafka Bridge</p>
</li>
<li>
<p>MirrorMaker</p>
</li>
<li>
<p>Kafka Exporter</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A description of each of the example rules is provided in the file.</p>
</div>
<div class="paragraph">
<p>Alerting rules provide notifications about specific conditions observed in metrics.
Rules are declared on the Prometheus server, but Prometheus Alertmanager is responsible for alert notifications.</p>
</div>
<div class="paragraph">
<p>Prometheus alerting rules describe conditions using <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/">PromQL</a> expressions that are continuously evaluated.</p>
</div>
<div class="paragraph">
<p>When an alert expression becomes true, the condition is met and the Prometheus server sends alert data to the Alertmanager.
Alertmanager then sends out a notification using the communication method configured for its deployment.</p>
</div>
<div class="paragraph">
<p>General points about the alerting rule definitions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>for</code> property is used with the rules to determine the period of time a condition must persist before an alert is triggered.</p>
</li>
<li>
<p>A tick is a basic ZooKeeper time unit, which is measured in milliseconds and configured using the <code>tickTime</code> parameter of <code>Kafka.spec.zookeeper.config</code>. For example, if ZooKeeper <code>tickTime=3000</code>, 3 ticks (3 x 3000) equals 9000 milliseconds.</p>
</li>
<li>
<p>The availability of the <code>ZookeeperRunningOutOfSpace</code> metric and alert is dependent on the Kubernetes configuration and storage implementation used. Storage implementations for certain platforms may not be able to supply the information on available space required for the metric to provide an alert.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Alertmanager can be configured to use email, chat messages or other notification methods.
Adapt the default configuration of the example rules according to your specific needs.</p>
</div>
</div>
<div class="sect3">
<h4 id="ref-metrics-dashboards-str"><a class="link" href="#ref-metrics-dashboards-str">19.3.3. Example Grafana dashboards</a></h4>
<div class="paragraph _abstract">
<p>If you deploy Prometheus to provide metrics,
you can use the example Grafana dashboards provided with Strimzi to monitor Strimzi components.</p>
</div>
<div class="paragraph">
<p>Example dashboards are provided in the <code>examples/metrics/grafana-dashboards</code> directory as JSON files.</p>
</div>
<div class="paragraph">
<p>All dashboards provide JVM metrics, as well as metrics specific to the component.
For example, the Grafana dashboard for Strimzi operators provides information on the number of reconciliations or custom resources they are processing.</p>
</div>
<div class="paragraph">
<p>The example dashboards don&#8217;t show all the metrics supported by Kafka.
The dashboards are populated with a representative set of metrics for monitoring.</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 35. Example Grafana dashboard files</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Example JSON file</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Strimzi operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-operators.json</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-kafka.json</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ZooKeeper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-zookeeper.json</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Connect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-kafka-connect.json</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka MirrorMaker 2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-kafka-mirror-maker-2.json</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Bridge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-kafka-bridge.json</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cruise Control</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-cruise-control.json</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Exporter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-kafka-exporter.json</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
When metrics are not available to the Kafka Exporter, because there is no traffic in the cluster yet, the Kafka Exporter Grafana dashboard will show <code>N/A</code> for numeric fields and <code>No data to show</code> for graphs.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-metrics-setup-str"><a class="link" href="#assembly-metrics-setup-str">19.4. Using Prometheus with Strimzi</a></h3>
<div class="paragraph _abstract">
<p>You can use Prometheus to provide monitoring data for the example Grafana dashboards provided with Strimzi.</p>
</div>
<div class="paragraph">
<p>To expose metrics in Prometheus format, you add configuration to a custom resource.
You must also make sure that the metrics are scraped by your monitoring stack.
Prometheus and Prometheus Alertmanager are used in the examples provided by Strimzi, but you can use also other compatible tools.</p>
</div>
<div class="paragraph">
<p>Using Prometheus with Strimzi, requires the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#proc-metrics-kafka-deploy-options-str">Enabling Prometheus metrics through configuration</a></p>
</li>
<li>
<p><a href="#assembly-metrics-prometheus-str">Setting up Prometheus</a></p>
</li>
<li>
<p><a href="#proc-metrics-deploying-prometheus-alertmanager-str">Deploying Prometheus Alertmanager</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Strimzi provides an <a href="#assembly-metrics-config-files-str">example Grafana dashboards</a> to display visualizations of metrics.
The exposed metrics provide the monitoring data when you <a href="#proc-metrics-grafana-dashboard-str">enable the Grafana dashboard</a>.</p>
</div>
<div class="sect3">
<h4 id="proc-metrics-kafka-deploy-options-str"><a class="link" href="#proc-metrics-kafka-deploy-options-str">19.4.1. Enabling Prometheus metrics through configuration</a></h4>
<div class="paragraph _abstract">
<p>To enable and expose metrics in Strimzi for Prometheus, use metrics configuration properties.</p>
</div>
<div class="paragraph">
<p>The following components require <code>metricsConfig</code> configuration to expose metrics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kafka</p>
</li>
<li>
<p>KafkaConnect</p>
</li>
<li>
<p>MirrorMaker</p>
</li>
<li>
<p>Cruise Control</p>
</li>
<li>
<p>ZooKeeper</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This configuration enables the <a href="https://github.com/prometheus/jmx_exporter" target="_blank" rel="noopener">Prometheus JMX Exporter</a> to expose metrics through an HTTP endpoint.
The port for the JMX exporter HTTP endpoint is 9404.
Prometheus scrapes this endpoint to collect Kafka metrics.</p>
</div>
<div class="paragraph">
<p>You set the <code>enableMetrics</code> property to <code>true</code> in order to expose metrics for these components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kafka Bridge</p>
</li>
<li>
<p>OAuth 2.0 authentication and authorization framework</p>
</li>
<li>
<p>Open Policy Agent (OPA) for authorization</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To deploy Prometheus metrics configuration in Strimzi, you can use your own configuration or the <a href="#ref-metrics-prometheus-metrics-config-str">example custom resource configuration files</a> provided with Strimzi:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>kafka-metrics.yaml</code></p>
</li>
<li>
<p><code>kafka-connect-metrics.yaml</code></p>
</li>
<li>
<p><code>kafka-mirror-maker-2-metrics.yaml</code></p>
</li>
<li>
<p><code>kafka-bridge-metrics.yaml</code></p>
</li>
<li>
<p><code>kafka-cruise-control-metrics.yaml</code></p>
</li>
<li>
<p><code>oauth-metrics.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These files contain the necessary relabeling rules and configuration to enable Prometheus metrics.
They are a good starting point for trying Prometheus with Strimzi.</p>
</div>
<div class="paragraph">
<p>This procedure shows how to deploy example Prometheus metrics configuration in the <code>Kafka</code> resource.
The process is the same when deploying the example files for other resources.</p>
</div>
<div class="paragraph">
<p>If you wish to include <a href="#con-metrics-kafka-exporter-lag-str">Kafka Exporter</a> metrics, add <code>kafkaExporter</code> configuration to your <code>Kafka</code> resource.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Kafka Exporter only provides additional metrics related to consumer lag and consumer offsets.
For regular Kafka metrics, you must configure the Prometheus metrics in <a href="#proc-metrics-kafka-deploy-options-str">Kafka brokers</a>.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy the example custom resource with the Prometheus configuration.</p>
<div class="paragraph">
<p>For example, for each <code>Kafka</code> resource you can apply the <code>kafka-metrics.yaml</code> file.</p>
</div>
<div class="listingblock">
<div class="title">Deploying the example configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f kafka-metrics.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can copy the example configuration in <code>kafka-metrics.yaml</code> to your own <code>Kafka</code> resource.</p>
</div>
<div class="listingblock">
<div class="title">Copying the example configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit kafka &lt;kafka_configuration_file&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the <code>metricsConfig</code> property and the <code>ConfigMap</code> it references to your <code>Kafka</code> resource.</p>
</div>
<div class="listingblock">
<div class="title">Example metrics configuration for Kafka</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
    metricsConfig: <b class="conum">(1)</b>
      type: jmxPrometheusExporter
      valueFrom:
        configMapKeyRef:
          name: kafka-metrics
          key: kafka-metrics-config.yml
---
kind: ConfigMap <b class="conum">(2)</b>
apiVersion: v1
metadata:
  name: kafka-metrics
  labels:
    app: strimzi
data:
  kafka-metrics-config.yml: |
  # <em>metrics configuration...</em></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Copy the <code>metricsConfig</code> property that references the ConfigMap that contains metrics configuration.</p>
</li>
<li>
<p>Copy the whole <code>ConfigMap</code> that specifies the metrics configuration.</p>
</li>
</ol>
</div>
</li>
<li>
<p>To deploy Kafka Exporter, add <code>kafkaExporter</code> configuration.</p>
<div class="paragraph">
<p><code>kafkaExporter</code> configuration is only specified in the <code>Kafka</code> resource.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration for deploying Kafka Exporter</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  # ...
  kafkaExporter:
    image: my-registry.io/my-org/my-exporter-cluster:latest <b class="conum">(1)</b>
    groupRegex: ".*" <b class="conum">(2)</b>
    topicRegex: ".*" <b class="conum">(3)</b>
    groupExcludeRegex: "^excluded-.*" <b class="conum">(4)</b>
    topicExcludeRegex: "^excluded-.*" <b class="conum">(5)</b>
    resources: <b class="conum">(6)</b>
      requests:
        cpu: 200m
        memory: 64Mi
      limits:
        cpu: 500m
        memory: 128Mi
    logging: debug <b class="conum">(7)</b>
    enableSaramaLogging: true <b class="conum">(8)</b>
    template: <b class="conum">(9)</b>
      pod:
        metadata:
          labels:
            label1: value1
        imagePullSecrets:
          - name: my-docker-credentials
        securityContext:
          runAsUser: 1000001
          fsGroup: 0
        terminationGracePeriodSeconds: 120
    readinessProbe: <b class="conum">(10)</b>
      initialDelaySeconds: 15
      timeoutSeconds: 5
    livenessProbe: <b class="conum">(11)</b>
      initialDelaySeconds: 15
      timeoutSeconds: 5
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>ADVANCED OPTION: Container image configuration, which is recommended only in special situations.</p>
</li>
<li>
<p>A regular expression to specify the consumer groups to include in the metrics.</p>
</li>
<li>
<p>A regular expression to specify the topics to include in the metrics.</p>
</li>
<li>
<p>A regular expression to specify the consumer groups to exclude in the metrics.</p>
</li>
<li>
<p>A regular expression to specify the topics to exclude in the metrics.</p>
</li>
<li>
<p>CPU and memory resources to reserve.</p>
</li>
<li>
<p>Logging configuration, to log messages with a given severity (debug, info, warn, error, fatal) or above.</p>
</li>
<li>
<p>Boolean to enable Sarama logging, a Go client library used by Kafka Exporter.</p>
</li>
<li>
<p>Customization of deployment templates and pods.</p>
</li>
<li>
<p>Healthcheck readiness probes.</p>
</li>
<li>
<p>Healthcheck liveness probes.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
For Kafka Exporter to be able to work properly, consumer groups need to be in use.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Enabling metrics for Kafka Bridge</div>
<p>To expose metrics for Kafka Bridge, set the <code>enableMetrics</code> property to <code>true</code> in the <code>KafkaBridge</code> resource.</p>
</div>
<div class="listingblock">
<div class="title">Example metrics configuration for Kafka Bridge</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaBridge
metadata:
  name: my-bridge
spec:
  # ...
  bootstrapServers: my-cluster-kafka:9092
  http:
    # ...
  enableMetrics: true
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Enabling metrics for OAuth 2.0 and OPA</div>
<p>To expose metrics for OAuth 2.0 or OPA, set the <code>enableMetrics</code> property to <code>true</code> in the appropriate custom resource.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">OAuth 2.0 metrics</dt>
<dd>
<p>Enable metrics for Kafka cluster authorization and Kafka listener authentication in the <code>Kafka</code> resource.</p>
<div class="paragraph">
<p>You can also enable metrics for OAuth 2.0 authentication in the custom resource of other <a href="#proc-oauth-kafka-config-str">supported components</a>.</p>
</div>
</dd>
<dt class="hdlist1">OPA metrics</dt>
<dd>
<p>Enable metrics for Kafka cluster authorization the <code>Kafka</code> resource in the same way as for OAuth 2.0.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In the following example, metrics are enabled for OAuth 2.0 listener authentication and OAuth 2.0 (<code>keycloak</code>) cluster authorization.</p>
</div>
<div class="listingblock">
<div class="title">Example cluster configuration with metrics enabled for OAuth 2.0</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
  namespace: myproject
spec:
  kafka:
    # ...
    listeners:
    - name: external3
      port: 9094
      type: loadbalancer
      tls: true
      authentication:
        type: oauth
        enableMetrics: true
      configuration:
        #...
    authorization:
      type: keycloak
      enableMetrics: true
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use the OAuth 2.0 metrics with Prometheus, you can use the <code>oauth-metrics.yaml</code> file to deploy example Prometheus metrics configuration.
Copy the <code>ConfigMap</code> configuration the <code>oauth-metrics.yaml</code> file contains to the same <code>Kafka</code> resource configuration file where you enabled metrics for OAuth 2.0.</p>
</div>
</div>
<div class="sect3">
<h4 id="assembly-metrics-prometheus-str"><a class="link" href="#assembly-metrics-prometheus-str">19.4.2. Setting up Prometheus</a></h4>
<div class="paragraph">
<p><a href="https://prometheus.io/" target="_blank" rel="noopener">Prometheus</a> provides an open source set of components for systems monitoring and alert notification.</p>
</div>
<div class="paragraph">
<p>We describe here how you can use the <a href="https://github.com/coreos/prometheus-operator" target="_blank" rel="noopener">CoreOS Prometheus Operator</a> to run and manage a Prometheus server that is suitable for use in production environments, but with the correct configuration you can run any Prometheus server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The Prometheus server configuration uses service discovery to discover the pods in the cluster from which it gets metrics.  For this feature to work correctly, the service account used for running the Prometheus service pod must have access to the API server so it can retrieve the pod list.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="https://kubernetes.io/docs/concepts/services-networking/service/#discovering-services" target="_blank" rel="noopener">Discovering services</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="con-metrics-prometheus-options-str"><a class="link" href="#con-metrics-prometheus-options-str">Prometheus configuration</a></h5>
<div class="paragraph">
<p>Strimzi provides <a href="#assembly-metrics-config-files-str">example configuration files for the Prometheus server</a>.</p>
</div>
<div class="paragraph">
<p>A Prometheus YAML file is provided for deployment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>prometheus.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additional Prometheus-related configuration is also provided in the following files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>prometheus-additional.yaml</code></p>
</li>
<li>
<p><code>prometheus-rules.yaml</code></p>
</li>
<li>
<p><code>strimzi-pod-monitor.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For Prometheus to obtain monitoring data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-metrics-deploying-prometheus-operator-str">Deploy the Prometheus Operator</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then use the configuration files to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-metrics-deploying-prometheus-operator-str">Deploy Prometheus</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Alerting rules</div>
<p>The <code>prometheus-rules.yaml</code> file provides <a href="#ref-metrics-alertmanager-examples-str">example alerting rule examples for use with Alertmanager</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="con-metrics-prometheus-resources-str"><a class="link" href="#con-metrics-prometheus-resources-str">Prometheus resources</a></h5>
<div class="paragraph">
<p>When you apply the Prometheus configuration, the following resources are created in your Kubernetes cluster and managed by the Prometheus Operator:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>ClusterRole</code> that grants permissions to Prometheus to read the health endpoints exposed by the Kafka and ZooKeeper pods, cAdvisor and the kubelet for container metrics.</p>
</li>
<li>
<p>A <code>ServiceAccount</code> for the Prometheus pods to run under.</p>
</li>
<li>
<p>A <code>ClusterRoleBinding</code> which binds the <code>ClusterRole</code> to the <code>ServiceAccount</code>.</p>
</li>
<li>
<p>A <code>Deployment</code> to manage the Prometheus Operator pod.</p>
</li>
<li>
<p>A <code>PodMonitor</code> to manage the configuration of the Prometheus pod.</p>
</li>
<li>
<p>A <code>Prometheus</code> to manage the configuration of the Prometheus pod.</p>
</li>
<li>
<p>A <code>PrometheusRule</code> to manage alerting rules for the Prometheus pod.</p>
</li>
<li>
<p>A <code>Secret</code> to manage additional Prometheus settings.</p>
</li>
<li>
<p>A <code>Service</code> to allow applications running in the cluster to connect to Prometheus (for example, Grafana using Prometheus as datasource).</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="proc-metrics-deploying-prometheus-operator-str"><a class="link" href="#proc-metrics-deploying-prometheus-operator-str">Deploying the CoreOS Prometheus Operator</a></h5>
<div class="paragraph">
<p>To deploy the Prometheus Operator to your Kafka cluster, apply the YAML bundle resources file from the <a href="https://github.com/coreos/prometheus-operator">Prometheus CoreOS repository</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Download the <code>bundle.yaml</code> resources file from the repository:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl -s https://raw.githubusercontent.com/coreos/prometheus-operator/master/bundle.yaml &gt; prometheus-operator-deployment.yaml</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the latest <code>master</code> release as shown, or choose a release that is compatible with your version of Kubernetes (see the <a href="https://github.com/coreos/kube-prometheus#kubernetes-compatibility-matrix">Kubernetes compatibility matrix</a>).
The <code>master</code> release of the Prometheus Operator works with Kubernetes 1.18+.</p>
</li>
<li>
<p>Update the namespace by replacing the example <code>my-namespace</code> with your own.</p>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">sed -E -i '/[[:space:]]*namespace: [a-zA-Z0-9-]*$/s/namespace:[[:space:]]*[a-zA-Z0-9-]*$/namespace: <em>my-namespace</em>/' prometheus-operator-deployment.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">sed -i '' -e '/[[:space:]]*namespace: [a-zA-Z0-9-]*$/s/namespace:[[:space:]]*[a-zA-Z0-9-]*$/namespace: <em>my-namespace</em>/' prometheus-operator-deployment.yaml</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If using OpenShift, specify a release of the <a href="https://github.com/openshift/prometheus-operator" target="_blank" rel="noopener">OpenShift fork</a> of the Prometheus Operator repository.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>(Optional) If it is not required, you can manually remove the <code>spec.template.spec.securityContext</code> property from the <code>prometheus-operator-deployment.yaml</code> file.</p>
</li>
<li>
<p>Deploy the Prometheus Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f prometheus-operator-deployment.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="proc-metrics-deploying-prometheus-str"><a class="link" href="#proc-metrics-deploying-prometheus-str">Deploying Prometheus</a></h5>
<div class="paragraph _abstract">
<p>Use Prometheus to obtain monitoring data in your Kafka cluster.</p>
</div>
<div class="paragraph">
<p>You can use your own Prometheus deployment or deploy Prometheus using the <a href="#assembly-metrics-config-files-str">example metrics configuration files</a> provided by Strimzi.
The example files include a configuration file for a Prometheus deployment and files for Prometheus-related resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/metrics/prometheus-install/prometheus.yaml</code></p>
</li>
<li>
<p><code>examples/metrics/prometheus-install/prometheus-rules.yaml</code></p>
</li>
<li>
<p><code>examples/metrics/prometheus-install/strimzi-pod-monitor.yaml</code></p>
</li>
<li>
<p><code>examples/metrics/prometheus-additional-properties/prometheus-additional.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The deployment process creates a <code>ClusterRoleBinding</code> and discovers an Alertmanager instance in the namespace specified for the deployment.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
By default, the Prometheus Operator only supports jobs that include an <code>endpoints</code> role for service discovery. Targets are discovered and scraped for each endpoint port address. For endpoint discovery, the port address may be derived from service (<code>role: service</code>) or pod (<code>role: pod</code>) discovery.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Check the <a href="#ref-metrics-alertmanager-examples-str">example alerting rules provided</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Modify the Prometheus installation file (<code>prometheus.yaml</code>) according to the namespace Prometheus is going to be installed into:</p>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">sed -i 's/namespace: .*/namespace: <em>my-namespace</em>/' prometheus.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">sed -i '' 's/namespace: .*/namespace: <em>my-namespace</em>/' prometheus.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>PodMonitor</code> resource in <code>strimzi-pod-monitor.yaml</code> to define Prometheus jobs that will scrape the metrics data from pods.</p>
<div class="paragraph">
<p>Update the <code>namespaceSelector.matchNames</code> property with the namespace where the pods to scrape the metrics from are running.</p>
</div>
<div class="paragraph">
<p><code>PodMonitor</code> is used to scrape data directly from pods for Apache Kafka, ZooKeeper, Operators, the Kafka Bridge and Cruise Control.</p>
</div>
</li>
<li>
<p>Edit the <code>prometheus.yaml</code> installation file to include additional configuration for scraping metrics directly from nodes.</p>
<div class="paragraph">
<p>The Grafana dashboards provided show metrics for CPU, memory and disk volume usage, which come directly from the Kubernetes cAdvisor agent and kubelet on the nodes.</p>
</div>
<div class="paragraph">
<p>The Prometheus Operator does not have a monitoring resource like <code>PodMonitor</code> for scraping the nodes, so the <code>prometheus-additional.yaml</code> file contains the additional configuration needed.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Create a <code>Secret</code> resource from the configuration file (<code>prometheus-additional.yaml</code> in the <code>examples/metrics/prometheus-additional-properties</code> directory):</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f prometheus-additional.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>additionalScrapeConfigs</code> property in the <code>prometheus.yaml</code> file to include the name of the <code>Secret</code> in the <code>prometheus-additional.yaml</code> file.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Deploy the Prometheus resources:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f strimzi-pod-monitor.yaml
kubectl apply -f prometheus-rules.yaml
kubectl apply -f prometheus.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="proc-metrics-deploying-prometheus-alertmanager-str"><a class="link" href="#proc-metrics-deploying-prometheus-alertmanager-str">19.4.3. Deploying Alertmanager</a></h4>
<div class="paragraph _abstract">
<p>Use Alertmanager to route alerts to a notification service.
<a href="https://prometheus.io/docs/alerting/alertmanager/" target="_blank" rel="noopener">Prometheus Alertmanager</a> is a component for handling alerts and routing them to a notification service.
Alertmanager supports an essential aspect of monitoring, which is to be notified of conditions that indicate potential issues based on alerting rules.</p>
</div>
<div class="paragraph">
<p>You can use the <a href="#assembly-metrics-config-files-str">example metrics configuration files</a> provided by Strimzi to deploy Alertmanager to send notifications to a Slack channel.
A configuration file defines the resources for deploying Alertmanager:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/metrics/prometheus-install/alert-manager.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An additional configuration file provides the hook definitions for sending notifications from your Kafka cluster:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/metrics/prometheus-alertmanager-config/alert-manager-config.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following resources are defined on deployment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An <code>Alertmanager</code> to manage the Alertmanager pod.</p>
</li>
<li>
<p>A <code>Secret</code> to manage the configuration of the Alertmanager.</p>
</li>
<li>
<p>A <code>Service</code> to provide an easy to reference hostname for other services to connect to Alertmanager (such as Prometheus).</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#proc-metrics-kafka-deploy-options-str">Metrics are configured for the Kafka cluster resource</a></p>
</li>
<li>
<p><a href="#assembly-metrics-prometheus-str">Prometheus is deployed</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Update the <code>alert-manager-config.yaml</code> file in the <code>examples/metrics/prometheus-alertmanager-config</code> directory to replace the following:</p>
<div class="ulist">
<ul>
<li>
<p><code>slack_api_url</code> property with the actual value of the Slack API URL related to the application for the Slack workspace</p>
</li>
<li>
<p><code>channel</code> property with the actual Slack channel on which to send notifications</p>
</li>
</ul>
</div>
</li>
<li>
<p>Create a <code>Secret</code> resource from the Alertmanager configuration file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f alert-manager-config.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy Alertmanager:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f alert-manager.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="proc-metrics-grafana-dashboard-str"><a class="link" href="#proc-metrics-grafana-dashboard-str">19.5. Enabling the example Grafana dashboards</a></h3>
<div class="paragraph _abstract">
<p>Use Grafana to provide visualizations of Prometheus metrics on customizable dashboards.</p>
</div>
<div class="paragraph">
<p>You can use your own Grafana deployment or deploy Grafana using the <a href="#assembly-metrics-config-files-str">example metrics configuration files</a> provided by Strimzi.
The example files include a configuration file for a Grafana deployment</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/metrics/grafana-install/grafana.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Strimzi also provides <a href="#ref-metrics-dashboards-str">example dashboard configuration files for Grafana</a> in JSON format.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/metrics/grafana-dashboards</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This procedure uses the example Grafana configuration file and example dashboards.</p>
</div>
<div class="paragraph">
<p>The example dashboards are a good starting point for monitoring key metrics, but they don&#8217;t show all the metrics supported by Kafka.
You can modify the example dashboards or add other metrics, depending on your infrastructure.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
No alert notification rules are defined.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When accessing a dashboard, you can use the <code>port-forward</code> command to forward traffic from the Grafana pod to the host.
The name of the Grafana pod is different for each user.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#proc-metrics-kafka-deploy-options-str">Metrics are configured for the Kafka cluster resource</a></p>
</li>
<li>
<p><a href="#assembly-metrics-prometheus-str">Prometheus and Prometheus Alertmanager are deployed</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy Grafana.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f grafana.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Get the details of the Grafana service.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get service grafana</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">NAME</th>
<th class="tableblock halign-left valign-top">TYPE</th>
<th class="tableblock halign-left valign-top">CLUSTER-IP</th>
<th class="tableblock halign-left valign-top">PORT(S)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">grafana</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ClusterIP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">172.30.123.40</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3000/TCP</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note the port number for port forwarding.</p>
</div>
</li>
<li>
<p>Use <code>port-forward</code> to redirect the Grafana user interface to <code>localhost:3000</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl port-forward svc/grafana 3000:3000</code></pre>
</div>
</div>
</li>
<li>
<p>In a web browser, access the Grafana login screen using the URL <code><a href="http://localhost:3000" class="bare">http://localhost:3000</a></code>.</p>
<div class="paragraph">
<p>The Grafana Log In page appears.</p>
</div>
</li>
<li>
<p>Enter your user name and password, and then click <strong>Log In</strong>.</p>
<div class="paragraph">
<p>The default Grafana user name and password are both <code>admin</code>. After logging in for the first time, you can change the password.</p>
</div>
</li>
<li>
<p>In <strong>Configuration &gt; Data Sources</strong>, add Prometheus as a <em>data source</em>.</p>
<div class="ulist">
<ul>
<li>
<p>Specify a name</p>
</li>
<li>
<p>Add <em>Prometheus</em> as the type</p>
</li>
<li>
<p>Specify a Prometheus server URL</p>
<div class="paragraph">
<p>The Prometheus operator service (<code>prometheus-operated</code>) is accessible internally within the Kubernetes cluster on port 9090: <code>http://prometheus-operated:9090</code>.</p>
</div>
<div class="paragraph">
<p>Save and test the connection when you have added the details.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Click the <strong>+</strong> icon and then click <strong>Import</strong>.</p>
</li>
<li>
<p>In <code>examples/metrics/grafana-dashboards</code>, copy the JSON of the dashboard to import.</p>
</li>
<li>
<p>Paste the JSON into the text box, and then click <strong>Load</strong>.</p>
</li>
<li>
<p>Repeat steps 7-9 for the other example Grafana dashboards.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The imported Grafana dashboards are available to view from the <strong>Dashboards</strong> home page.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-distributed-tracing-str"><a class="link" href="#assembly-distributed-tracing-str">20. Introducing distributed tracing</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Distributed tracing tracks the progress of transactions between applications in a distributed system.
In a microservices architecture, tracing tracks the progress of transactions between services.
Trace data is useful for monitoring application performance and investigating issues with target systems and end-user applications.</p>
</div>
<div class="paragraph">
<p>In Strimzi, tracing facilitates the end-to-end tracking of messages: from source systems to Kafka, and then from Kafka to target systems and applications.
Distributed tracing complements the monitoring of metrics in Grafana dashboards, as well as the component loggers.</p>
</div>
<div class="paragraph">
<p>Support for tracing is built in to the following Kafka components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>MirrorMaker to trace messages from a source cluster to a target cluster</p>
</li>
<li>
<p>Kafka Connect to trace messages consumed and produced by Kafka Connect</p>
</li>
<li>
<p>Kafka Bridge to trace messages between Kafka and HTTP client applications</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Tracing is not supported for Kafka brokers.</p>
</div>
<div class="paragraph">
<p>You enable and configure tracing for these components through their custom resources.
You add tracing configuration using <code>spec.template</code> properties.</p>
</div>
<div class="paragraph">
<p>You enable tracing by specifying a tracing type using the <code>spec.tracing.type</code> property:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>opentelemetry</code></dt>
<dd>
<p>Specify <code>type: opentelemetry</code> to use OpenTelemetry. By Default, OpenTelemetry uses the OTLP (OpenTelemetry Protocol) exporter and endpoint to get trace data. You can specify other tracing systems supported by OpenTelemetry, including Jaeger tracing. To do this, you change the OpenTelemetry exporter and endpoint in the tracing configuration.</p>
</dd>
</dl>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
Strimzi no longer supports OpenTracing.
If you were previously using OpenTracing with the <code>type: jaeger</code> option, we encourage you to transition to using OpenTelemetry instead.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="con-overview-tracing-str"><a class="link" href="#con-overview-tracing-str">20.1. Tracing options</a></h3>
<div class="paragraph _abstract">
<p>Use OpenTelemetry with the Jaeger tracing system.</p>
</div>
<div class="paragraph">
<p>OpenTelemetry provides an API specification that is independent from the tracing or monitoring system.</p>
</div>
<div class="paragraph">
<p>You use the APIs to instrument application code for tracing.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Instrumented applications generate <em>traces</em> for individual requests across the distributed system.</p>
</li>
<li>
<p>Traces are composed of <em>spans</em> that define specific units of work over time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Jaeger is a tracing system for microservices-based distributed systems.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Jaeger user interface allows you to query, filter, and analyze trace data.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">The Jaeger user interface showing a simple query</div>
<p><span class="image"><img src="images/image_con-overview-distributed-tracing.png" alt="The Jaeger user interface showing a simple query"></span></p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://www.jaegertracing.io/docs/" target="_blank" rel="noopener">Jaeger documentation</a></p>
</li>
<li>
<p><a href="https://opentelemetry.io/docs/" target="_blank" rel="noopener">OpenTelemetry documentation</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="ref-tracing-environment-variables-str"><a class="link" href="#ref-tracing-environment-variables-str">20.2. Environment variables for tracing</a></h3>
<div class="paragraph _abstract">
<p>Use environment variables when you are enabling tracing for Kafka components or initializing a tracer for Kafka clients.</p>
</div>
<div class="paragraph">
<p>Tracing environment variables are subject to change.
For the latest information, see the <a href="https://opentelemetry.io/docs/" target="_blank" rel="noopener">OpenTelemetry documentation</a>.</p>
</div>
<div class="paragraph">
<p>The following tables describe the key environment variables for setting up a tracer.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 36. OpenTelemetry environment variables</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 20%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OTEL_SERVICE_NAME</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the Jaeger tracing service for OpenTelemetry.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OTEL_EXPORTER_JAEGER_ENDPOINT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The exporter used for tracing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OTEL_TRACES_EXPORTER</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The exporter used for tracing.
Set to <code>otlp</code> by default. If using Jaeger tracing, you need to set this environment variable as <code>jaeger</code>.
If you are using another tracing implementation, <a href="#proc-enabling-tracing-type-str">specify the exporter used</a>.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="assembly-distributed-tracing-procedures-str"><a class="link" href="#assembly-distributed-tracing-procedures-str">20.3. Setting up distributed tracing</a></h3>
<div class="paragraph _abstract">
<p>Enable distributed tracing in Kafka components by specifying a tracing type in the custom resource.
Instrument tracers in Kafka clients for end-to-end tracking of messages.</p>
</div>
<div class="paragraph">
<p>To set up distributed tracing, follow these procedures in order:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-enabling-tracing-in-connect-mirror-maker-bridge-resources-str">Enable tracing for MirrorMaker, Kafka Connect, and the Kafka Bridge</a></p>
</li>
<li>
<p>Set up tracing for clients:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-configuring-tracers-kafka-clients-str">Initialize a Jaeger tracer for Kafka clients</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Instrument clients with tracers:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-instrumenting-producers-consumers-for-tracing-str">Instrument producers and consumers for tracing</a></p>
</li>
<li>
<p><a href="#proc-instrumenting-kafka-streams-with-tracers-str">Instrument Kafka Streams applications for tracing</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="prerequisites"><a class="link" href="#prerequisites">20.3.1. Prerequisites</a></h4>
<div class="paragraph">
<p>Before setting up distributed tracing, make sure Jaeger backend components are deployed to your Kubernetes cluster.
We recommend using the Jaeger operator for deploying Jaeger on your Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>For deployment instructions, see the <a href="https://www.jaegertracing.io/docs/" target="_blank" rel="noopener">Jaeger documentation</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Setting up tracing for applications and systems beyond Strimzi is outside the scope of this content.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="proc-enabling-tracing-in-connect-mirror-maker-bridge-resources-str"><a class="link" href="#proc-enabling-tracing-in-connect-mirror-maker-bridge-resources-str">20.3.2. Enabling tracing in MirrorMaker, Kafka Connect, and Kafka Bridge resources</a></h4>
<div class="paragraph _abstract">
<p>Distributed tracing is supported for MirrorMaker, MirrorMaker 2, Kafka Connect, and the Strimzi Kafka Bridge.
Configure the custom resource of the component to specify and enable a tracer service.</p>
</div>
<div class="paragraph">
<p>Enabling tracing in a resource triggers the following events:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Interceptor classes are updated in the integrated consumers and producers of the component.</p>
</li>
<li>
<p>For MirrorMaker, MirrorMaker 2, and Kafka Connect, the tracing agent initializes a tracer based on the tracing configuration defined in the resource.</p>
</li>
<li>
<p>For the Kafka Bridge, a tracer based on the tracing configuration defined in the resource is initialized by the Kafka Bridge itself.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can enable tracing that uses OpenTelemetry.</p>
</div>
<div class="paragraph">
<div class="title">Tracing in MirrorMaker and MirrorMaker 2</div>
<p>For MirrorMaker and MirrorMaker 2, messages are traced from the source cluster to the target cluster. The trace data records messages entering and leaving the MirrorMaker or MirrorMaker 2 component.</p>
</div>
<div class="paragraph">
<div class="title">Tracing in Kafka Connect</div>
<p>For Kafka Connect, only messages produced and consumed by Kafka Connect are traced. To trace messages sent between Kafka Connect and external systems, you must configure tracing in the connectors for those systems.</p>
</div>
<div class="paragraph">
<div class="title">Tracing in the Kafka Bridge</div>
<p>For the Kafka Bridge, messages produced and consumed by the Kafka Bridge are traced. Incoming HTTP requests from client applications to send and receive messages through the Kafka Bridge are also traced.
To have end-to-end tracing, you must configure tracing in your HTTP clients.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Perform these steps for each <code>KafkaMirrorMaker</code>, <code>KafkaMirrorMaker2</code>, <code>KafkaConnect</code>, and <code>KafkaBridge</code> resource.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the <code>spec.template</code> property, configure the tracer service.</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Use the <a href="#ref-tracing-environment-variables-str">tracing environment variables</a> as template configuration properties.</p>
</li>
<li>
<p>For OpenTelemetry, set the <code>spec.tracing.type</code> property to <code>opentelemetry</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example tracing configuration for Kafka Connect using OpenTelemetry</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect-cluster
spec:
  #...
  template:
    connectContainer:
      env:
        - name: OTEL_SERVICE_NAME
          value: my-otel-service
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "http://otlp-host:4317"
  tracing:
    type: opentelemetry
  #...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example tracing configuration for MirrorMaker using OpenTelemetry</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker
metadata:
  name: my-mirror-maker
spec:
  #...
  template:
    mirrorMakerContainer:
      env:
        - name: OTEL_SERVICE_NAME
          value: my-otel-service
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "http://otlp-host:4317"
  tracing:
    type: opentelemetry
#...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example tracing configuration for MirrorMaker 2 using OpenTelemetry</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker2
metadata:
  name: my-mm2-cluster
spec:
  #...
  template:
    connectContainer:
      env:
        - name: OTEL_SERVICE_NAME
          value: my-otel-service
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "http://otlp-host:4317"
  tracing:
    type: opentelemetry
#...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example tracing configuration for the Kafka Bridge using OpenTelemetry</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaBridge
metadata:
  name: my-bridge
spec:
  #...
  template:
    bridgeContainer:
      env:
        - name: OTEL_SERVICE_NAME
          value: my-otel-service
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "http://otlp-host:4317"
  tracing:
    type: opentelemetry
#...</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;resource_configuration_file&gt;</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-configuring-tracers-kafka-clients-str"><a class="link" href="#proc-configuring-tracers-kafka-clients-str">20.3.3. Initializing tracing for Kafka clients</a></h4>
<div class="paragraph _abstract">
<p>Initialize a tracer for OpenTelemetry, then instrument your client applications for distributed tracing.
You can instrument Kafka producer and consumer clients, and Kafka Streams API applications.</p>
</div>
<div class="paragraph">
<p>Configure and initialize a tracer using a set of <a href="#ref-tracing-environment-variables-str">tracing environment variables</a>.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>In each client application add the dependencies for the tracer:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the Maven dependencies to the <code>pom.xml</code> file for the client application:</p>
<div class="listingblock">
<div class="title">Dependencies for OpenTelemetry</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;
    &lt;artifactId&gt;opentelemetry-sdk-extension-autoconfigure&lt;/artifactId&gt;
    &lt;version&gt;1.19.0-alpha&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;io.opentelemetry.instrumentation&lt;/groupId&gt;
  &lt;artifactId&gt;opentelemetry-kafka-clients-2.6&lt;/artifactId&gt;
  &lt;version&gt;1.19.0-alpha&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;
  &lt;artifactId&gt;opentelemetry-exporter-otlp&lt;/artifactId&gt;
  &lt;version&gt;1.19.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Define the configuration of the tracer using the <a href="#ref-tracing-environment-variables-str">tracing environment variables</a>.</p>
</li>
<li>
<p>Create a tracer, which is initialized with the environment variables:</p>
<div class="listingblock">
<div class="title">Creating a tracer for OpenTelemetry</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">OpenTelemetry ot = GlobalOpenTelemetry.get();</code></pre>
</div>
</div>
</li>
<li>
<p>Register the tracer as a global tracer:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">GlobalTracer.register(tracer);</code></pre>
</div>
</div>
</li>
<li>
<p>Instrument your client:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-instrumenting-producers-consumers-for-tracing-str">Instrumenting producers and consumers for tracing</a></p>
</li>
<li>
<p><a href="#proc-instrumenting-kafka-streams-with-tracers-str">Instrumenting Kafka Streams applications for tracing</a></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-instrumenting-producers-consumers-for-tracing-str"><a class="link" href="#proc-instrumenting-producers-consumers-for-tracing-str">20.3.4. Instrumenting producers and consumers for tracing</a></h4>
<div class="paragraph _abstract">
<p>Instrument application code to enable tracing in Kafka producers and consumers.
Use a decorator pattern or interceptors to instrument your Java producer and consumer application code for tracing.
You can then record traces when messages are produced or retrieved from a topic.</p>
</div>
<div class="paragraph">
<p>OpenTelemetry instrumentation project provides classes that support instrumentation of producers and consumers.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Decorator instrumentation</dt>
<dd>
<p>For decorator instrumentation, create a modified producer or consumer instance for tracing.</p>
</dd>
<dt class="hdlist1">Interceptor instrumentation</dt>
<dd>
<p>For interceptor instrumentation, add the tracing capability to the consumer or producer configuration.</p>
</dd>
</dl>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have <a href="#proc-configuring-tracers-kafka-clients-str">initialized tracing for the client</a>.</p>
<div class="paragraph">
<p>You enable instrumentation in producer and consumer applications by adding the tracing JARs as dependencies to your project.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Perform these steps in the application code of each producer and consumer application.
Instrument your client application code using either a decorator pattern or interceptors.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To use a decorator pattern, create a modified producer or consumer instance to send or receive messages.</p>
<div class="paragraph">
<p>You pass the original <code>KafkaProducer</code> or <code>KafkaConsumer</code> class.</p>
</div>
<div class="listingblock">
<div class="title">Example decorator instrumentation for OpenTelemetry</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Producer instance
Producer &lt; String, String &gt; op = new KafkaProducer &lt; &gt; (
    configs,
    new StringSerializer(),
    new StringSerializer()
    );
    Producer &lt; String, String &gt; producer = tracing.wrap(op);
KafkaTracing tracing = KafkaTracing.create(GlobalOpenTelemetry.get());
producer.send(...);

//consumer instance
Consumer&lt;String, String&gt; oc = new KafkaConsumer&lt;&gt;(
    configs,
    new StringDeserializer(),
    new StringDeserializer()
    );
    Consumer&lt;String, String&gt; consumer = tracing.wrap(oc);
consumer.subscribe(Collections.singleton("mytopic"));
ConsumerRecords&lt;Integer, String&gt; records = consumer.poll(1000);
ConsumerRecord&lt;Integer, String&gt; record = ...
SpanContext spanContext = TracingKafkaUtils.extractSpanContext(record.headers(), tracer);</code></pre>
</div>
</div>
</li>
<li>
<p>To use interceptors, set the interceptor class in the producer or consumer configuration.</p>
<div class="paragraph">
<p>You use the <code>KafkaProducer</code> and <code>KafkaConsumer</code> classes in the usual way.
The <code>TracingProducerInterceptor</code> and <code>TracingConsumerInterceptor</code> interceptor classes take care of the tracing capability.</p>
</div>
<div class="listingblock">
<div class="title">Example producer configuration using interceptors</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">senderProps.put(ProducerConfig.INTERCEPTOR_CLASSES_CONFIG,
    TracingProducerInterceptor.class.getName());

KafkaProducer&lt;Integer, String&gt; producer = new KafkaProducer&lt;&gt;(senderProps);
producer.send(...);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example consumer configuration using interceptors</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">consumerProps.put(ConsumerConfig.INTERCEPTOR_CLASSES_CONFIG,
    TracingConsumerInterceptor.class.getName());

KafkaConsumer&lt;Integer, String&gt; consumer = new KafkaConsumer&lt;&gt;(consumerProps);
consumer.subscribe(Collections.singletonList("messages"));
ConsumerRecords&lt;Integer, String&gt; records = consumer.poll(1000);
ConsumerRecord&lt;Integer, String&gt; record = ...
SpanContext spanContext = TracingKafkaUtils.extractSpanContext(record.headers(), tracer);</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="proc-instrumenting-kafka-streams-with-tracers-str"><a class="link" href="#proc-instrumenting-kafka-streams-with-tracers-str">20.3.5. Instrumenting Kafka Streams applications for tracing</a></h4>
<div class="paragraph _abstract">
<p>Instrument application code to enable tracing in Kafka Streams API applications.
Use a decorator pattern or interceptors to instrument your Kafka Streams API applications for tracing.
You can then record traces when messages are produced or retrieved from a topic.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Decorator instrumentation</dt>
<dd>
<p>For decorator instrumentation, create a modified Kafka Streams instance for tracing.
For OpenTelemetry, you need to create a custom <code>TracingKafkaClientSupplier</code> class to provide tracing instrumentation for Kafka Streams.</p>
</dd>
<dt class="hdlist1">Interceptor instrumentation</dt>
<dd>
<p>For interceptor instrumentation, add the tracing capability to the Kafka Streams producer and consumer configuration.</p>
</dd>
</dl>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have <a href="#proc-configuring-tracers-kafka-clients-str">initialized tracing for the client</a>.</p>
<div class="paragraph">
<p>You enable instrumentation in Kafka Streams applications by adding the tracing JARs as dependencies to your project.</p>
</div>
</li>
<li>
<p>To instrument Kafka Streams with OpenTelemetry, you&#8217;ll need to write a custom <code>TracingKafkaClientSupplier</code>.</p>
</li>
<li>
<p>The custom <code>TracingKafkaClientSupplier</code> can extend Kafka&#8217;s <code>DefaultKafkaClientSupplier</code>, overriding the producer and consumer creation methods to wrap the instances with the telemetry-related code.</p>
<div class="listingblock">
<div class="title">Example custom <code>TracingKafkaClientSupplier</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private class TracingKafkaClientSupplier extends DefaultKafkaClientSupplier {
    @Override
    public Producer&lt;byte[], byte[]&gt; getProducer(Map&lt;String, Object&gt; config) {
        KafkaTelemetry telemetry = KafkaTelemetry.create(GlobalOpenTelemetry.get());
        return telemetry.wrap(super.getProducer(config));
    }

    @Override
    public Consumer&lt;byte[], byte[]&gt; getConsumer(Map&lt;String, Object&gt; config) {
        KafkaTelemetry telemetry = KafkaTelemetry.create(GlobalOpenTelemetry.get());
        return telemetry.wrap(super.getConsumer(config));
    }

    @Override
    public Consumer&lt;byte[], byte[]&gt; getRestoreConsumer(Map&lt;String, Object&gt; config) {
        return this.getConsumer(config);
    }

    @Override
    public Consumer&lt;byte[], byte[]&gt; getGlobalConsumer(Map&lt;String, Object&gt; config) {
        return this.getConsumer(config);
    }
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Perform these steps for each Kafka Streams API application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To use a decorator pattern, create an instance of the <code>TracingKafkaClientSupplier</code> supplier interface, then provide the supplier interface to <code>KafkaStreams</code>.</p>
<div class="listingblock">
<div class="title">Example decorator instrumentation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KafkaClientSupplier supplier = new TracingKafkaClientSupplier(tracer);
KafkaStreams streams = new KafkaStreams(builder.build(), new StreamsConfig(config), supplier);
streams.start();</code></pre>
</div>
</div>
</li>
<li>
<p>To use interceptors, set the interceptor class in the Kafka Streams producer and consumer configuration.</p>
<div class="paragraph">
<p>The <code>TracingProducerInterceptor</code> and <code>TracingConsumerInterceptor</code> interceptor classes take care of the tracing capability.</p>
</div>
<div class="listingblock">
<div class="title">Example producer and consumer configuration using interceptors</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">props.put(StreamsConfig.PRODUCER_PREFIX + ProducerConfig.INTERCEPTOR_CLASSES_CONFIG, TracingProducerInterceptor.class.getName());
props.put(StreamsConfig.CONSUMER_PREFIX + ConsumerConfig.INTERCEPTOR_CLASSES_CONFIG, TracingConsumerInterceptor.class.getName());</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="proc-enabling-tracing-type-str"><a class="link" href="#proc-enabling-tracing-type-str">20.3.6. Introducing a different OpenTelemetry tracing system</a></h4>
<div class="paragraph _abstract">
<p>Instead of the default OTLP system, you can specify other tracing systems that are supported by OpenTelemetry.
You do this by adding the required artifacts to the Kafka image provided with Strimzi.
Any required implementation specific environment variables must also be set.
You then enable the new tracing implementation using the <code>OTEL_TRACES_EXPORTER</code> environment variable.</p>
</div>
<div class="paragraph">
<p>This procedure shows how to implement Zipkin tracing.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the tracing artifacts to the <code>/opt/kafka/libs/</code> directory of the Strimzi Kafka image.</p>
<div class="paragraph">
<p>You can use the Kafka container image on the <a href="https://quay.io/organization/strimzi" target="_blank" rel="noopener">Container Registry</a> as a base image for creating a new custom image.</p>
</div>
<div class="listingblock">
<div class="title">OpenTelemetry artifact for Zipkin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env">io.opentelemetry:opentelemetry-exporter-zipkin</code></pre>
</div>
</div>
</li>
<li>
<p>Set the tracing exporter and endpoint for the new tracing implementation.</p>
<div class="listingblock">
<div class="title">Example Zikpin tracer configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker2
metadata:
  name: my-mm2-cluster
spec:
  #...
  template:
    connectContainer:
      env:
        - name: OTEL_SERVICE_NAME
          value: my-zipkin-service
        - name: OTEL_EXPORTER_ZIPKIN_ENDPOINT
          value: http://zipkin-exporter-host-name:9411/api/v2/spans # <b class="conum">(1)</b>
        - name: OTEL_TRACES_EXPORTER
          value: zipkin # <b class="conum">(2)</b>
  tracing:
    type: opentelemetry
#...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Specifies the Zipkin endpoint to connect to.</p>
</li>
<li>
<p>The Zipkin exporter.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="ref-tracing-span-names-str"><a class="link" href="#ref-tracing-span-names-str">20.3.7. Custom span names</a></h4>
<div class="paragraph _abstract">
<p>A tracing <em>span</em> is a logical unit of work in Jaeger, with an operation name, start time, and duration.
Spans have built-in names, but you can specify custom span names in your Kafka client instrumentation where used.</p>
</div>
<div class="paragraph">
<p>Specifying custom span names is optional and only applies when using a decorator pattern <a href="#proc-instrumenting-producers-consumers-for-tracing-str">in producer and consumer client instrumentation</a> or <a href="#proc-instrumenting-kafka-streams-with-tracers-str">Kafka Streams instrumentation</a>.</p>
</div>
<div class="sect4">
<h5 id="specifying_span_names_for_opentelemetry"><a class="link" href="#specifying_span_names_for_opentelemetry">Specifying span names for OpenTelemetry</a></h5>
<div class="paragraph">
<p>Custom span names cannot be specified directly with OpenTelemetry.
Instead, you retrieve span names by adding code to your client application to extract additional tags and attributes.</p>
</div>
<div class="listingblock">
<div class="title">Example code to extract attributes</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">//Defines attribute extraction for a producer
private static class ProducerAttribExtractor implements AttributesExtractor &lt; ProducerRecord &lt; ? , ? &gt; , Void &gt; {
    @Override
    public void onStart(AttributesBuilder attributes, ProducerRecord &lt; ? , ? &gt; producerRecord) {
        set(attributes, AttributeKey.stringKey("prod_start"), "prod1");
    }
    @Override
    public void onEnd(AttributesBuilder attributes, ProducerRecord &lt; ? , ? &gt; producerRecord, @Nullable Void unused, @Nullable Throwable error) {
        set(attributes, AttributeKey.stringKey("prod_end"), "prod2");
    }
}
//Defines attribute extraction for a consumer
private static class ConsumerAttribExtractor implements AttributesExtractor &lt; ConsumerRecord &lt; ? , ? &gt; , Void &gt; {
    @Override
    public void onStart(AttributesBuilder attributes, ConsumerRecord &lt; ? , ? &gt; producerRecord) {
        set(attributes, AttributeKey.stringKey("con_start"), "con1");
    }
    @Override
    public void onEnd(AttributesBuilder attributes, ConsumerRecord &lt; ? , ? &gt; producerRecord, @Nullable Void unused, @Nullable Throwable error) {
        set(attributes, AttributeKey.stringKey("con_end"), "con2");
    }
}
//Extracts the attributes
public static void main(String[] args) throws Exception {
        Map &lt; String, Object &gt; configs = new HashMap &lt; &gt; (Collections.singletonMap(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092"));
        System.setProperty("otel.traces.exporter", "jaeger");
        System.setProperty("otel.service.name", "myapp1");
        KafkaTracing tracing = KafkaTracing.newBuilder(GlobalOpenTelemetry.get())
            .addProducerAttributesExtractors(new ProducerAttribExtractor())
            .addConsumerAttributesExtractors(new ConsumerAttribExtractor())
            .build();</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-upgrade-str"><a class="link" href="#assembly-upgrade-str">21. Upgrading Strimzi</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Upgrade your Strimzi installation to version 0.39.0 and benefit from new features, performance improvements, and enhanced security options.
During the upgrade, Kafka is also be updated to the latest supported version, introducing additional features and bug fixes to your Strimzi deployment.</p>
</div>
<div class="paragraph">
<p>Use the same method to upgrade the Cluster Operator as the initial method of deployment.
For example, if you used the Strimzi installation files, modify those files to perform the upgrade.
After you have upgraded your Cluster Operator to 0.39.0, the next step is to upgrade all Kafka nodes to the latest supported version of Kafka.
Kafka upgrades are performed by the Cluster Operator through rolling updates of the Kafka nodes.</p>
</div>
<div class="paragraph">
<p>If you encounter any issues with the new version, Strimzi can be <a href="#assembly-downgrade-str">downgraded</a> to the previous version.</p>
</div>
<div class="paragraph">
<p>Released Strimzi versions can be found at <a href="https://github.com/strimzi/strimzi-kafka-operator/releases" target="_blank" rel="noopener">GitHub releases page</a>.</p>
</div>
<div class="paragraph">
<div class="title">Upgrade without downtime</div>
<p>For topics configured with high availability (replication factor of at least 3 and evenly distributed partitions), the upgrade process should not cause any downtime for consumers and producers.</p>
</div>
<div class="paragraph">
<p>The upgrade triggers rolling updates, where brokers are restarted one by one at different stages of the process.
During this time, overall cluster availability is temporarily reduced, which may increase the risk of message loss in the event of a broker failure.</p>
</div>
<div class="sect2">
<h3 id="con-upgrade-sequence-str"><a class="link" href="#con-upgrade-sequence-str">21.1. Required upgrade sequence</a></h3>
<div class="paragraph _abstract">
<p>To upgrade brokers and clients without downtime, you <em>must</em> complete the Strimzi upgrade procedures in the following order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure your Kubernetes cluster version is supported.</p>
<div class="paragraph">
<p>Strimzi 0.39.0 requires Kubernetes 1.21 and later.</p>
</div>
<div class="paragraph">
<p>You can <a href="#con-upgrade-cluster-str">upgrade Kubernetes with minimal downtime</a>.</p>
</div>
</li>
<li>
<p><a href="#assembly-upgrade-str">Upgrade the Cluster Operator</a>.</p>
</li>
<li>
<p>Upgrade Kafka depending on the cluster configuration:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If using Kafka in KRaft mode, update the Kafka version and <code>spec.kafka.metadataVersion</code> to <a href="#proc-upgrade-kafka-kraft-str">upgrade all Kafka brokers and client applications</a>.</p>
</li>
<li>
<p>If using ZooKeeper-based Kafka, update the Kafka version and <code>inter.broker.protocol.version</code> to <a href="#assembly-upgrade-zookeeper-str">upgrade all Kafka brokers and client applications</a>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
From Strimzi 0.39, upgrades and downgrades between KRaft-based clusters are supported.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="con-upgrade-paths-str"><a class="link" href="#con-upgrade-paths-str">21.2. Strimzi upgrade paths</a></h3>
<div class="paragraph _abstract">
<p>Two upgrade paths are available for Strimzi.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Incremental upgrade</dt>
<dd>
<p>An incremental upgrade involves upgrading Strimzi from the previous minor version to version 0.39.0.</p>
</dd>
<dt class="hdlist1">Multi-version upgrade</dt>
<dd>
<p>A multi-version upgrade involves upgrading an older version of Strimzi to version 0.39.0 within a single upgrade, skipping one or more intermediate versions.
For example, upgrading directly from Strimzi 0.30.0 to Strimzi 0.39.0 is possible.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="con-upgrade-paths-kafka-versions-str"><a class="link" href="#con-upgrade-paths-kafka-versions-str">21.2.1. Support for Kafka versions when upgrading</a></h4>
<div class="paragraph">
<p>When upgrading Strimzi, it is important to ensure compatibility with the Kafka version being used.</p>
</div>
<div class="paragraph">
<p>Multi-version upgrades are possible even if the supported Kafka versions differ between the old and new versions.
However, if you attempt to upgrade to a new Strimzi version that does not support the current Kafka version, <a href="#con-upgrade-cluster-operator-unsupported-kafka-str">an error indicating that the Kafka version is not supported is generated</a>.
In this case, you must upgrade the Kafka version as part of the Strimzi upgrade by changing the <code>spec.kafka.version</code> in the <code>Kafka</code> custom resource to the supported version for the new Strimzi version.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can review supported Kafka versions in the <a href="https://strimzi.io/downloads/" target="_blank" rel="noopener">Supported versions</a> table.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <strong>Operators</strong> column lists all released Strimzi versions (the Strimzi version is often called the "Operator version").</p>
</li>
<li>
<p>The <strong>Kafka versions</strong> column lists the supported Kafka versions for each Strimzi version.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="con-upgrade-paths-earlier-versions-str"><a class="link" href="#con-upgrade-paths-earlier-versions-str">21.2.2. Upgrading from a Strimzi version earlier than 0.22</a></h4>
<div class="paragraph">
<p>If you are upgrading to the latest version of Strimzi from a version prior to version 0.22, do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Upgrade Strimzi to version 0.22 following the <a href="#con-upgrade-sequence-str">standard sequence</a>.</p>
</li>
<li>
<p>Convert Strimzi custom resources to <code>v1beta2</code> using the <em>API conversion tool</em> provided with Strimzi.</p>
</li>
<li>
<p>Do one of the following:</p>
<div class="ulist">
<ul>
<li>
<p>Upgrade Strimzi to a version between 0.23 and 0.26 (where the <code>ControlPlaneListener</code> feature gate is disabled by default).</p>
</li>
<li>
<p>Upgrade Strimzi to a version between 0.27 and 0.31 (where the <code>ControlPlaneListener</code> feature gate is enabled by default) with the <code>ControlPlaneListener</code> feature gate disabled.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Enable the <code>ControlPlaneListener</code> feature gate.</p>
</li>
<li>
<p>Upgrade to Strimzi 0.39.0 following the <a href="#con-upgrade-sequence-str">standard sequence</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Strimzi custom resources started using the <code>v1beta2</code> API version in release 0.22.
CRDs and custom resources must be converted <strong>before</strong> upgrading to Strimzi 0.23 or newer.
For information on using the API conversion tool, see the <a href="https://strimzi.io/docs/operators/0.24.0/deploying.html#assembly-upgrade-resources-str" target="_blank" rel="noopener">Strimzi 0.24.0 upgrade documentation</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
As an alternative to first upgrading to version 0.22, you can install the custom resources from version 0.22 and then convert the resources.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>ControlPlaneListener</code> feature is now permanently enabled in Strimzi.
You must upgrade to a version of Strimzi where it is disabled, then enable it using the
<code>STRIMZI_FEATURE_GATES</code> environment variable in the Cluster Operator configuration.</p>
</div>
<div class="listingblock">
<div class="title">Disabling the <code>ControlPlaneListener</code> feature gate</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: STRIMZI_FEATURE_GATES
    value: -ControlPlaneListener</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Enabling the <code>ControlPlaneListener</code> feature gate</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: STRIMZI_FEATURE_GATES
    value: +ControlPlaneListener</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="con-versions-and-images-str"><a class="link" href="#con-versions-and-images-str">21.2.3. Kafka version and image mappings</a></h4>
<div class="paragraph">
<p>When upgrading Kafka, consider your settings for the <code>STRIMZI_KAFKA_IMAGES</code> environment variable and the <code>Kafka.spec.kafka.version</code> property.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each <code>Kafka</code> resource can be configured with a <code>Kafka.spec.kafka.version</code>, which defaults to the latest supported Kafka version (3.6.1) if not specified.</p>
</li>
<li>
<p>The Cluster Operator&#8217;s <code>STRIMZI_KAFKA_IMAGES</code> environment variable provides a mapping (&lt;kafka_version&gt;=&lt;image&gt;) between a Kafka version and the image to be used when a specific Kafka version is requested in a given <code>Kafka</code> resource. For example, 3.6.1=quay.io/strimzi/kafka:0.39.0-kafka-3.6.1.</p>
<div class="ulist">
<ul>
<li>
<p>If <code>Kafka.spec.kafka.image</code> is not configured, the default image for the given version is used.</p>
</li>
<li>
<p>If <code>Kafka.spec.kafka.image</code> is configured, the default image is overridden.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The Cluster Operator cannot validate that an image actually contains a Kafka broker of the expected version.
Take care to ensure that the given image corresponds to the given Kafka version.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-strategies-for-upgrading-clients-str"><a class="link" href="#con-strategies-for-upgrading-clients-str">21.3. Strategies for upgrading clients</a></h3>
<div class="paragraph _abstract">
<p>Upgrading Kafka clients ensures that they benefit from the features, fixes, and improvements that are introduced in new versions of Kafka.
Upgraded clients maintain compatibility with other upgraded Kafka components.
The performance and stability of the clients might also be improved.</p>
</div>
<div class="paragraph">
<p>Consider the best approach for upgrading Kafka clients and brokers to ensure a smooth transition.
The chosen upgrade strategy depends on whether you are upgrading brokers or clients first.
Since Kafka 3.0, you can upgrade brokers and client independently and in any order.
The decision to upgrade clients or brokers first depends on several factors, such as the number of applications that need to be upgraded and how much downtime is tolerable.</p>
</div>
<div class="paragraph">
<p>If you upgrade clients before brokers, some new features may not work as they are not yet supported by brokers.
However, brokers can handle producers and consumers running with different versions and supporting different log message versions.</p>
</div>
</div>
<div class="sect2">
<h3 id="con-upgrade-cluster-str"><a class="link" href="#con-upgrade-cluster-str">21.4. Upgrading Kubernetes with minimal downtime</a></h3>
<div class="paragraph _abstract">
<p>If you are upgrading Kubernetes, refer to the Kubernetes upgrade documentation to check the upgrade path and the steps to upgrade your nodes correctly.
Before upgrading Kubernetes, <a href="https://strimzi.io/downloads/" target="_blank" rel="noopener">check the supported versions for your version of Strimzi</a>.</p>
</div>
<div class="paragraph">
<p>When performing your upgrade, ensure the availability of your Kafka clusters by following these steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configure pod disruption budgets</p>
</li>
<li>
<p>Roll pods using one of these methods:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Use the AMQ Streams Drain Cleaner (recommended)</p>
</li>
<li>
<p>Apply an annotation to your pods to roll them manually</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>When using either of the methods to roll the pods, you must set a pod disruption budget of zero using the <code>maxUnavailable</code> property.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>StrimziPodSet</code> custom resources manage Kafka and ZooKeeper pods using a custom controller that cannot use the <code>maxUnavailable</code> value directly.
Instead, the <code>maxUnavailable</code> value is converted to a <code>minAvailable</code> value.
If there are three broker pods and the <code>maxUnavailable</code> property is set to <code>0</code> (zero), the <code>minAvailable</code> setting is <code>3</code>, requiring all three broker pods to be available and allowing zero pods to be unavailable.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For Kafka to stay operational, topics must also be replicated for high availability.
This requires topic configuration that specifies a replication factor of at least 3 and a minimum number of in-sync replicas to 1 less than the replication factor.</p>
</div>
<div class="listingblock">
<div class="title">Kafka topic replicated for high availability</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: my-topic
  labels:
    strimzi.io/cluster: my-cluster
spec:
  partitions: 1
  replicas: 3
  config:
    # ...
    min.insync.replicas: 2
    # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a highly available environment, the Cluster Operator maintains a minimum number of in-sync replicas for topics during the upgrade process so that there is no downtime.</p>
</div>
<div class="sect3">
<h4 id="rolling_pods_using_the_strimzi_drain_cleaner"><a class="link" href="#rolling_pods_using_the_strimzi_drain_cleaner">21.4.1. Rolling pods using the Strimzi Drain Cleaner</a></h4>
<div class="paragraph">
<p>You can use the <a href="#assembly-drain-cleaner-str">Strimzi Drain Cleaner</a> to evict nodes during an upgrade.
The Strimzi Drain Cleaner annotates pods with a rolling update pod annotation.
This informs the Cluster Operator to perform a rolling update of an evicted pod.</p>
</div>
<div class="paragraph">
<p>A pod disruption budget allows only a specified number of pods to be unavailable at a given time.
During planned maintenance of Kafka broker pods, a pod disruption budget ensures Kafka continues to run in a highly available environment.</p>
</div>
<div class="paragraph">
<p>You specify a pod disruption budget using a <code>template</code> customization for a Kafka component.
By default, pod disruption budgets allow only a single pod to be unavailable at a given time.</p>
</div>
<div class="paragraph">
<p>In order to use the Drain Cleaner to roll pods, you set <code>maxUnavailable</code> to <code>0</code> (zero).
Reducing the pod disruption budget to zero prevents voluntary disruptions, so pods must be evicted manually.</p>
</div>
<div class="listingblock">
<div class="title">Specifying a pod disruption budget</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
  namespace: myproject
spec:
  kafka:
    # ...
    template:
      podDisruptionBudget:
        maxUnavailable: 0
# ...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="rolling_pods_manually_while_keeping_topics_available"><a class="link" href="#rolling_pods_manually_while_keeping_topics_available">21.4.2. Rolling pods manually while keeping topics available</a></h4>
<div class="paragraph">
<p>During an upgrade, you can trigger a manual rolling update of pods through the Cluster Operator.
Using <code>Pod</code> resources, rolling updates restart the pods of resources with new pods.
As with using the Strimzi Drain Cleaner, you&#8217;ll need to set the <code>maxUnavailable</code> value to zero for the pod disruption budget.</p>
</div>
<div class="paragraph">
<p>You need to watch the pods that need to be drained.
You then add a pod annotation to make the update.</p>
</div>
<div class="paragraph">
<p>Here, the annotation updates a Kafka broker.</p>
</div>
<div class="listingblock">
<div class="title">Performing a manual rolling update on a Kafka broker pod</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate pod <em>&lt;cluster_name&gt;</em>-kafka-<em>&lt;index&gt;</em> strimzi.io/manual-rolling-update=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>You replace <em>&lt;cluster_name&gt;</em> with the name of the cluster.
Kafka broker pods are named <em>&lt;cluster-name&gt;</em>-kafka-<em>&lt;index&gt;</em>, where <em>&lt;index&gt;</em> starts at zero and ends at the total number of replicas minus one.
For example, <code>my-cluster-kafka-0</code>.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#assembly-drain-cleaner-str">Draining pods using the Strimzi Drain Cleaner</a></p>
</li>
<li>
<p><a href="#proc-manual-rolling-update-pods-str">Performing a rolling update using a pod annotation</a></p>
</li>
<li>
<p><a href="./configuring.html#type-PodDisruptionBudgetTemplate-reference" target="_blank" rel="noopener"><code>PodDisruptionBudgetTemplate</code> schema reference</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/home/" target="_blank" rel="noopener">Kubernetes documentation</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-upgrade-cluster-operator-str"><a class="link" href="#assembly-upgrade-cluster-operator-str">21.5. Upgrading the Cluster Operator</a></h3>
<div class="paragraph _abstract">
<p>Use the same method to upgrade the Cluster Operator as the initial method of deployment.</p>
</div>
<div class="sect3">
<h4 id="proc-upgrading-the-co-str"><a class="link" href="#proc-upgrading-the-co-str">21.5.1. Upgrading the Cluster Operator using installation files</a></h4>
<div class="paragraph _abstract">
<p>This procedure describes how to upgrade a Cluster Operator deployment to use Strimzi 0.39.0.</p>
</div>
<div class="paragraph">
<p>Follow this procedure if you deployed the Cluster Operator using the installation YAML files.</p>
</div>
<div class="paragraph">
<p>The availability of Kafka clusters managed by the Cluster Operator is not affected by the upgrade operation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Refer to the documentation supporting a specific version of Strimzi for information on how to upgrade to that version.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>An existing Cluster Operator deployment is available.</p>
</li>
<li>
<p>You have <a href="#downloads-str">downloaded the release artifacts for Strimzi 0.39.0</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Take note of any configuration changes made to the existing Cluster Operator resources (in the <code>/install/cluster-operator</code> directory).
Any changes will be <strong>overwritten</strong> by the new version of the Cluster Operator.</p>
</li>
<li>
<p>Update your custom resources to reflect the supported configuration options available for Strimzi version 0.39.0.</p>
</li>
<li>
<p>Update the Cluster Operator.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Modify the installation files for the new Cluster Operator version according to the namespace the Cluster Operator is running in.</p>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i '' 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>If you modified one or more environment variables in your existing Cluster Operator <code>Deployment</code>, edit the
<code>install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code> file to use those environment variables.</p>
</li>
</ol>
</div>
</li>
<li>
<p>When you have an updated configuration, deploy it along with the rest of the installation resources:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl replace -f install/cluster-operator</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for the rolling updates to complete.</p>
</div>
</li>
<li>
<p>If the new Operator version no longer supports the Kafka version you are upgrading from, the Cluster Operator returns an error message to say the version is not supported.
Otherwise, no error message is returned.</p>
<div class="ulist">
<ul>
<li>
<p>If the error message is returned, upgrade to a Kafka version that is supported by the new Cluster Operator version:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Edit the <code>Kafka</code> custom resource.</p>
</li>
<li>
<p>Change the <code>spec.kafka.version</code> property to a supported Kafka version.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If the error message is <em>not</em> returned, go to the next step.
You will upgrade the Kafka version later.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Get the image for the Kafka pod to ensure the upgrade was successful:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods my-cluster-kafka-0 -o jsonpath='{.spec.containers[0].image}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The image tag shows the new Strimzi version followed by the Kafka version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">quay.io/strimzi/kafka:0.39.0-kafka-3.6.1</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also <a href="#con-upgrade-status-str">check the upgrade has completed successfully from the status of the <code>Kafka</code> resource</a>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Cluster Operator is upgraded to version 0.39.0, but the version of Kafka running in the cluster it manages is unchanged.</p>
</div>
</div>
<div class="sect3">
<h4 id="upgrading_the_cluster_operator_using_the_operatorhub"><a class="link" href="#upgrading_the_cluster_operator_using_the_operatorhub">21.5.2. Upgrading the Cluster Operator using the OperatorHub</a></h4>
<div class="paragraph">
<p>If you deployed Strimzi from <a href="https://operatorhub.io/operator/strimzi-kafka-operator" target="_blank" rel="noopener">OperatorHub.io</a>, use the Operator Lifecycle Manager (OLM) to change the update channel for the Strimzi operators to a new Strimzi version.</p>
</div>
<div class="paragraph">
<p>Updating the channel starts one of the following types of upgrade, depending on your chosen upgrade strategy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An automatic upgrade is initiated</p>
</li>
<li>
<p>A manual upgrade that requires approval before installation begins</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you subscribe to the <em>stable</em> channel, you can get automatic updates without changing channels.
However, enabling automatic updates is not recommended because of the potential for missing any pre-installation upgrade steps.
Use automatic upgrades only on version-specific channels.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For more information on using OperatorHub to upgrade Operators, see the <a href="https://olm.operatorframework.io/docs/" target="_blank" rel="noopener">Operator Lifecycle Manager documentation</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="upgrading_the_cluster_operator_using_a_helm_chart"><a class="link" href="#upgrading_the_cluster_operator_using_a_helm_chart">21.5.3. Upgrading the Cluster Operator using a Helm chart</a></h4>
<div class="paragraph">
<p>If you deployed the Cluster Operator using a Helm chart, use <code>helm upgrade</code>.</p>
</div>
<div class="paragraph">
<p>The <code>helm upgrade</code> command does not upgrade the <a href="https://helm.sh/docs/chart_best_practices/custom_resource_definitions/" target="_blank" rel="noopener">Custom Resource Definitions for Helm</a>.
Install the new CRDs manually after upgrading the Cluster Operator.
You can access the CRDs from the <a href="https://github.com/strimzi/strimzi-kafka-operator/releases" target="_blank" rel="noopener">GitHub releases page</a> or find them in the <code>crd</code> subdirectory inside the Helm Chart.</p>
</div>
</div>
<div class="sect3">
<h4 id="migrating_to_unidirectional_topic_management"><a class="link" href="#migrating_to_unidirectional_topic_management">21.5.4. Migrating to unidirectional topic management</a></h4>
<div class="paragraph">
<p>When deploying the Topic Operator to manage topics, the Cluster Operator enables unidirectional topic management by default.
If you are switching from a version of Strimzi that used bidirectional topic management, there are some cleanup tasks to perform after upgrading the Cluster Operator.
For more information, see <a href="#proc-changing-topic-operator-mode-str">Switching between Topic Operator modes</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="con-upgrade-cluster-operator-unsupported-kafka-str"><a class="link" href="#con-upgrade-cluster-operator-unsupported-kafka-str">21.5.5. Upgrading the Cluster Operator returns Kafka version error</a></h4>
<div class="paragraph">
<p>If you upgrade the Cluster Operator to a version that does not support the current version of Kafka you are using, you get an <em>unsupported Kafka version</em> error.
This error applies to all installation methods and means that you must upgrade Kafka to a supported Kafka version.
Change the <code>spec.kafka.version</code> in the <code>Kafka</code> resource to the supported version.</p>
</div>
<div class="paragraph">
<p>You can use <code>kubectl</code> to check for error messages like this in the <code>status</code> of the <code>Kafka</code> resource.</p>
</div>
<div class="listingblock">
<div class="title">Checking the Kafka status for errors</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafka &lt;kafka_cluster_name&gt; -n &lt;namespace&gt; -o jsonpath='{.status.conditions}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace &lt;kafka_cluster_name&gt; with the name of your Kafka cluster and &lt;namespace&gt; with the Kubernetes namespace where the pod is running.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="proc-upgrade-kafka-kraft-str"><a class="link" href="#proc-upgrade-kafka-kraft-str">21.6. Upgrading KRaft-based Kafka clusters and client applications</a></h3>
<div class="paragraph _abstract">
<p>Upgrade a KRaft-based Strimzi Kafka cluster to a newer supported Kafka version and KRaft metadata version.</p>
</div>
<div class="paragraph">
<p>You should also choose a <a href="#con-strategies-for-upgrading-clients-str">strategy for upgrading clients</a>.
Kafka clients are upgraded in step 6 of this procedure.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Refer to the Apache Kafka documentation for the latest on support for KRaft-based upgrades.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is up and running.</p>
</li>
<li>
<p>Before you upgrade the Strimzi Kafka cluster, check that the properties of the <code>Kafka</code> resource do <em>not</em> contain configuration options that are not supported in the new Kafka version.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Update the Kafka cluster configuration:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit kafka &lt;kafka_configuration_file&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>If configured, check that the current <code>spec.kafka.metadataVersion</code> is set to a version supported by the version of Kafka you are upgrading to.</p>
<div class="paragraph">
<p>For example, the current version is 3.5-IV2 if upgrading from Kafka version 3.5.1 to 3.6.1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    replicas: 3
    metadataVersion: 3.5-IV2
    version: 3.5.1
    # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>metadataVersion</code> is not configured,
Strimzi automatically updates it to the current default after the update to the Kafka version in the next step.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The value of <code>metadataVersion</code> must be a string to prevent it from being interpreted as a floating point number.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Change the <code>Kafka.spec.kafka.version</code> to specify the new Kafka version; leave the <code>metadataVersion</code> at the default for the <em>current</em> Kafka version.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Changing the <code>kafka.version</code> ensures that all brokers in the cluster are upgraded to start using the new broker binaries.
During this process, some brokers are using the old binaries while others have already upgraded to the new ones.
Leaving the <code>metadataVersion</code> unchanged at the current setting ensures that the Kafka brokers and controllers can continue to communicate with each other throughout the upgrade.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, if upgrading from Kafka 3.5.1 to 3.6.1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    replicas: 3
    metadataVersion: 3.5-IV2 # <b class="conum">(1)</b>
    version: 3.6.1 # <b class="conum">(2)</b>
    # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Metadata version is unchanged</p>
</li>
<li>
<p>Kafka version is changed to the new version.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If the image for the Kafka cluster is defined in <code>Kafka.spec.kafka.image</code> of the <code>Kafka</code> custom resource, update the <code>image</code> to point to a container image with the new Kafka version.</p>
<div class="paragraph">
<p>See <a href="#con-versions-and-images-str">Kafka version and image mappings</a></p>
</div>
</li>
<li>
<p>Save and exit the editor, then wait for the rolling updates to upgrade the Kafka nodes to complete.</p>
<div class="paragraph">
<p>Check the progress of the rolling updates by watching the pod state transitions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods my-cluster-kafka-0 -o jsonpath='{.spec.containers[0].image}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rolling updates ensure that each pod is using the broker binaries for the new version of Kafka.</p>
</div>
</li>
<li>
<p>Depending on your chosen <a href="#con-strategies-for-upgrading-clients-str">strategy for upgrading clients</a>, upgrade all client applications to use the new version of the client binaries.</p>
<div class="paragraph">
<p>If required, set the <code>version</code> property for Kafka Connect and MirrorMaker as the new version of Kafka:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>For Kafka Connect, update <code>KafkaConnect.spec.version</code>.</p>
</li>
<li>
<p>For MirrorMaker, update <code>KafkaMirrorMaker.spec.version</code>.</p>
</li>
<li>
<p>For MirrorMaker 2, update <code>KafkaMirrorMaker2.spec.version</code>.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using custom images that are built manually, you must rebuild those images to ensure that they are up-to-date with the latest Strimzi base image.
For example, if you <a href="#creating-new-image-from-base-str">created a container image from the base Kafka Connect image</a>, update the Dockerfile to point to the latest base image and build configuration.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Verify that the upgraded client applications work correctly with the new Kafka brokers.</p>
</li>
<li>
<p>If configured, update the Kafka resource to use the new <code>metadataVersion</code> version. Otherwise, go to step 9.</p>
<div class="paragraph">
<p>For example, if upgrading to Kafka 3.6.1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    replicas: 3
    metadataVersion: 3.6-IV2
    version: 3.6.1
    # ...</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Exercise caution when changing the <code>metadataVersion</code>, as downgrading may not be possible.
You cannot downgrade Kafka if the <code>metadataVersion</code> for the new Kafka version is higher than the Kafka version you wish to downgrade to.
However, understand the potential implications on support and compatibility when maintaining an older version.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Wait for the Cluster Operator to update the cluster.</p>
<div class="paragraph">
<p>You can <a href="#con-upgrade-status-str">check the upgrade has completed successfully from the status of the <code>Kafka</code> resource</a>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="assembly-upgrade-zookeeper-str"><a class="link" href="#assembly-upgrade-zookeeper-str">21.7. Upgrading Kafka when using ZooKeeper</a></h3>
<div class="paragraph _abstract">
<p>If you are using a ZooKeeper-based Kafka cluster, an upgrade requires an update to the Kafka version and the inter-broker protocol version.</p>
</div>
<div class="sect3">
<h4 id="ref-kafka-versions-str"><a class="link" href="#ref-kafka-versions-str">21.7.1. Updating Kafka versions</a></h4>
<div class="paragraph _abstract">
<p>Upgrading Kafka when using ZooKeeper for cluster management requires updates to the Kafka version (<code>Kafka.spec.kafka.version</code>) and its inter-broker protocol version (<code>inter.broker.protocol.version</code>) in the configuration of the <code>Kafka</code> resource.
Each version of Kafka has a compatible version of the inter-broker protocol.
The inter-broker protocol is used for inter-broker communication.
The minor version of the protocol typically increases to match the minor version of Kafka, as shown in the preceding table.
The inter-broker protocol version is set cluster wide in the <code>Kafka</code> resource.
To change it, you edit the <code>inter.broker.protocol.version</code> property in <code>Kafka.spec.kafka.config</code>.</p>
</div>
<div class="paragraph">
<p>The following table shows the differences between Kafka versions:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 37. Kafka version differences</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Kafka version</th>
<th class="tableblock halign-left valign-top">Inter-broker protocol version</th>
<th class="tableblock halign-left valign-top">Log message format version</th>
<th class="tableblock halign-left valign-top">ZooKeeper version</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.5.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.6.4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.5.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.6.4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.5.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.6.4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.6.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.8.2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.6.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.8.3</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Log message format version</div>
<p>When a producer sends a message to a Kafka broker, the message is encoded using a specific format.
The format can change between Kafka releases, so messages specify which version of the message format they were encoded with.</p>
</div>
<div class="paragraph">
<p>The properties used to set a specific message format version are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>message.format.version</code> property for topics</p>
</li>
<li>
<p><code>log.message.format.version</code> property for Kafka brokers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>From Kafka 3.0.0, the message format version values are assumed to match the <code>inter.broker.protocol.version</code> and don&#8217;t need to be set.
The values reflect the Kafka version used.</p>
</div>
<div class="paragraph">
<p>When upgrading to Kafka 3.0.0 or higher, you can remove these settings when you update the <code>inter.broker.protocol.version</code>.
Otherwise, you can set the message format version based on the Kafka version you are upgrading to.</p>
</div>
<div class="paragraph">
<p>The default value of <code>message.format.version</code> for a topic is defined by the <code>log.message.format.version</code> that is set on the Kafka broker.
You can manually set the <code>message.format.version</code> of a topic by modifying its topic configuration.</p>
</div>
<div class="paragraph">
<div class="title">Rolling updates from Kafka version changes</div>
<p>The Cluster Operator initiates rolling updates to Kafka brokers when the Kafka version is updated.
Further rolling updates depend on the configuration for <code>inter.broker.protocol.version</code> and <code>log.message.format.version</code>.</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">If <code>Kafka.spec.kafka.config</code> contains&#8230;&#8203;</th>
<th class="tableblock halign-left valign-top">The Cluster Operator initiates&#8230;&#8203;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Both the <code>inter.broker.protocol.version</code> and the <code>log.message.format.version</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A single rolling update. After the update, the <code>inter.broker.protocol.version</code> must be updated manually, followed by <code>log.message.format.version</code>.
Changing each will trigger a further rolling update.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Either the <code>inter.broker.protocol.version</code> or the <code>log.message.format.version</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Two rolling updates.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">No configuration for the <code>inter.broker.protocol.version</code> or the <code>log.message.format.version</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Two rolling updates.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
From Kafka 3.0.0, when the <code>inter.broker.protocol.version</code> is set to <code>3.0</code> or higher, the <code>log.message.format.version</code> option is ignored and doesn&#8217;t need to be set.
The <code>log.message.format.version</code> property for brokers and the <code>message.format.version</code> property for topics are deprecated and will be removed in a future release of Kafka.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As part of the Kafka upgrade, the Cluster Operator initiates rolling updates for ZooKeeper.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A single rolling update occurs even if the ZooKeeper version is unchanged.</p>
</li>
<li>
<p>Additional rolling updates occur if the new version of Kafka requires a new ZooKeeper version.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="con-upgrade-older-clients-str"><a class="link" href="#con-upgrade-older-clients-str">21.7.2. Upgrading clients with older message formats</a></h4>
<div class="paragraph _abstract">
<p>Before Kafka 3.0, you could configure a specific message format for brokers using the <code>log.message.format.version</code> property (or the <code>message.format.version</code> property at the topic level).
This allowed brokers to accommodate older Kafka clients that were using an outdated message format.
Though Kafka inherently supports older clients without explicitly setting this property, brokers would then need to convert the messages from the older clients, which came with a significant performance cost.</p>
</div>
<div class="paragraph">
<p>Apache Kafka Java clients have supported the latest message format version since version 0.11.
If all of your clients are using the latest message version, you can remove the <code>log.message.format.version</code> or <code>message.format.version</code> overrides when upgrading your brokers.</p>
</div>
<div class="paragraph">
<p>However, if you still have clients that are using an older message format version, we recommend upgrading your clients first.
Start with the consumers, then upgrade the producers before removing the <code>log.message.format.version</code> or  <code>message.format.version</code> overrides when upgrading your brokers.
This will ensure that all of your clients can support the latest message format version and that the upgrade process goes smoothly.</p>
</div>
<div class="paragraph">
<p>You can track Kafka client names and versions using this metric:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>kafka.server:type=socket-server-metrics,clientSoftwareName=&lt;name&gt;,clientSoftwareVersion=&lt;version&gt;,listener=&lt;listener&gt;,networkProcessor=&lt;processor&gt;</code></p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The following Kafka broker metrics help monitor the performance of message down-conversion:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>kafka.network:type=RequestMetrics,name=MessageConversionsTimeMs,request={Produce|Fetch}</code> provides metrics on the time taken to perform message conversion.</p>
</li>
<li>
<p><code>kafka.server:type=BrokerTopicMetrics,name={Produce|Fetch}MessageConversionsPerSec,topic=([-.\w]+)</code> provides metrics on the number of messages converted over a period of time.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="proc-upgrade-kafka-zookeeper-str"><a class="link" href="#proc-upgrade-kafka-zookeeper-str">21.7.3. Upgrading ZooKeeper-based Kafka clusters and client applications</a></h4>
<div class="paragraph _abstract">
<p>Upgrade a ZooKeeper-based Strimzi Kafka cluster to a newer supported Kafka version and inter-broker protocol version.</p>
</div>
<div class="paragraph">
<p>You should also choose a <a href="#con-strategies-for-upgrading-clients-str">strategy for upgrading clients</a>.
Kafka clients are upgraded in step 6 of this procedure.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is up and running.</p>
</li>
<li>
<p>Before you upgrade the Strimzi Kafka cluster, check that the properties of the <code>Kafka</code> resource do <em>not</em> contain configuration options that are not supported in the new Kafka version.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Update the Kafka cluster configuration:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit kafka &lt;kafka_configuration_file&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>If configured, check that the <code>inter.broker.protocol.version</code> and <code>log.message.format.version</code> properties are set to the <em>current</em> version.</p>
<div class="paragraph">
<p>For example, the current version is 3.5 if upgrading from Kafka version 3.5.1 to 3.6.1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: Kafka
spec:
  # ...
  kafka:
    version: 3.5.1
    config:
      log.message.format.version: "3.5"
      inter.broker.protocol.version: "3.5"
      # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>log.message.format.version</code> and <code>inter.broker.protocol.version</code> are not configured,
Strimzi automatically updates these versions to the current defaults after the update to the Kafka version in the next step.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The value of <code>log.message.format.version</code> and <code>inter.broker.protocol.version</code> must be strings to prevent them from being interpreted as floating point numbers.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Change the <code>Kafka.spec.kafka.version</code> to specify the new Kafka version; leave the <code>log.message.format.version</code> and <code>inter.broker.protocol.version</code> at the defaults for the <em>current</em> Kafka version.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Changing the <code>kafka.version</code> ensures that all brokers in the cluster are upgraded to start using the new broker binaries.
During this process, some brokers are using the old binaries while others have already upgraded to the new ones.
Leaving the <code>inter.broker.protocol.version</code> unchanged at the current setting ensures that the brokers can continue to communicate with each other throughout the upgrade.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, if upgrading from Kafka 3.5.1 to 3.6.1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  # ...
  kafka:
    version: 3.6.1 <b class="conum">(1)</b>
    config:
      log.message.format.version: "3.5" <b class="conum">(2)</b>
      inter.broker.protocol.version: "3.5" <b class="conum">(3)</b>
      # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Kafka version is changed to the new version.</p>
</li>
<li>
<p>Message format version is unchanged.</p>
</li>
<li>
<p>Inter-broker protocol version is unchanged.</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
You cannot downgrade Kafka if the <code>inter.broker.protocol.version</code> for the new Kafka version changes. The inter-broker protocol version determines the schemas used for persistent metadata stored by the broker, including messages written to <code>__consumer_offsets</code>. The downgraded cluster will not understand the messages.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If the image for the Kafka cluster is defined in <code>Kafka.spec.kafka.image</code> of the <code>Kafka</code> custom resource, update the <code>image</code> to point to a container image with the new Kafka version.</p>
<div class="paragraph">
<p>See <a href="#con-versions-and-images-str">Kafka version and image mappings</a></p>
</div>
</li>
<li>
<p>Save and exit the editor, then wait for rolling updates to complete.</p>
<div class="paragraph">
<p>Check the progress of the rolling updates by watching the pod state transitions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods my-cluster-kafka-0 -o jsonpath='{.spec.containers[0].image}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rolling updates ensure that each pod is using the broker binaries for the new version of Kafka.</p>
</div>
</li>
<li>
<p>Depending on your chosen <a href="#con-strategies-for-upgrading-clients-str">strategy for upgrading clients</a>, upgrade all client applications to use the new version of the client binaries.</p>
<div class="paragraph">
<p>If required, set the <code>version</code> property for Kafka Connect and MirrorMaker as the new version of Kafka:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>For Kafka Connect, update <code>KafkaConnect.spec.version</code>.</p>
</li>
<li>
<p>For MirrorMaker, update <code>KafkaMirrorMaker.spec.version</code>.</p>
</li>
<li>
<p>For MirrorMaker 2, update <code>KafkaMirrorMaker2.spec.version</code>.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using custom images that are built manually, you must rebuild those images to ensure that they are up-to-date with the latest Strimzi base image.
For example, if you <a href="#creating-new-image-from-base-str">created a container image from the base Kafka Connect image</a>, update the Dockerfile to point to the latest base image and build configuration.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Verify that the upgraded client applications work correctly with the new Kafka brokers.</p>
</li>
<li>
<p>If configured, update the Kafka resource to use the new <code>inter.broker.protocol.version</code> version. Otherwise, go to step 9.</p>
<div class="paragraph">
<p>For example, if upgrading to Kafka 3.6.1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  # ...
  kafka:
    version: 3.6.1
    config:
      log.message.format.version: "3.5"
      inter.broker.protocol.version: "3.6"
      # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the Cluster Operator to update the cluster.</p>
</li>
<li>
<p>If configured, update the Kafka resource to use the new <code>log.message.format.version</code> version. Otherwise, go to step 10.</p>
<div class="paragraph">
<p>For example, if upgrading to Kafka 3.6.1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  # ...
  kafka:
    version: 3.6.1
    config:
      log.message.format.version: "3.6"
      inter.broker.protocol.version: "3.6"
      # ...</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
From Kafka 3.0.0, when the <code>inter.broker.protocol.version</code> is set to <code>3.0</code> or higher, the <code>log.message.format.version</code> option is ignored and doesn&#8217;t need to be set.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Wait for the Cluster Operator to update the cluster.</p>
<div class="paragraph">
<p>You can <a href="#con-upgrade-status-str">check the upgrade has completed successfully from the status of the <code>Kafka</code> resource</a>.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-upgrade-status-str"><a class="link" href="#con-upgrade-status-str">21.8. Checking the status of an upgrade</a></h3>
<div class="paragraph _abstract">
<p>When performing an upgrade (or downgrade), you can check it completed successfully in the status of the <code>Kafka</code> custom resource.
The status provides information on the Strimzi and Kafka versions being used.</p>
</div>
<div class="paragraph">
<p>To ensure that you have the correct versions after completing an upgrade, verify the <code>kafkaVersion</code> and <code>operatorLastSuccessfulVersion</code> values in the Kafka status.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>operatorLastSuccessfulVersion</code> is the version of the Strimzi operator that last performed a successful reconciliation.</p>
</li>
<li>
<p><code>kafkaVersion</code> is the the version of Kafka being used by the Kafka cluster.</p>
</li>
<li>
<p><code>kafkaMetadataVersion</code> is the metadata version used by KRaft-based Kafka clusters</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use these values to check an upgrade of Strimzi or Kafka has completed.</p>
</div>
<div class="listingblock">
<div class="title">Checking an upgrade from the Kafka status</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
spec:
  # ...
status:
  # ...
  kafkaVersion: 3.6.1
  operatorLastSuccessfulVersion: 0.39.0
  kafkaMetadataVersion: 3.6</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="proc-reenabling-FIPS-mode-str"><a class="link" href="#proc-reenabling-FIPS-mode-str">21.9. Switching to FIPS mode when upgrading Strimzi</a></h3>
<div class="paragraph _abstract">
<p>Upgrade Strimzi to run in FIPS mode on FIPS-enabled Kubernetes clusters.
Until Strimzi 0.33, running on FIPS-enabled Kubernetes clusters was possible only by disabling FIPS mode using the <code>FIPS_MODE</code> environment variable.
From release 0.33, Strimzi supports FIPS mode.
If you run Strimzi on a FIPS-enabled Kubernetes cluster with the <code>FIPS_MODE</code> set to <code>disabled</code>, you can enable it by following this procedure.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>FIPS-enabled Kubernetes cluster</p>
</li>
<li>
<p>An existing Cluster Operator deployment with the <code>FIPS_MODE</code> environment variable set to <code>disabled</code></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Upgrade the Cluster Operator to version 0.33 or newer but keep the <code>FIPS_MODE</code> environment variable set to <code>disabled</code>.</p>
</li>
<li>
<p>If you initially deployed a Strimzi version older than 0.30, it might use old encryption and digest algorithms in its PKCS #12 stores, which are not supported with FIPS enabled.
To recreate the certificates with updated algorithms, renew the cluster and clients CA certificates.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>To renew the CAs generated by the Cluster Operator, <a href="#proc-renewing-ca-certs-manually-str">add the <code>force-renew</code> annotation to the CA secrets to trigger a renewal</a>.</p>
</li>
<li>
<p>To renew your own CAs, <a href="#renewing-your-own-ca-certificates-str">add the new certificate to the CA secret and update the <code>ca-cert-generation</code> annotation with a higher incremental value to capture the update</a>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If you use SCRAM-SHA-512 authentication, check the password length of your users.
If they are less than 32 characters long, generate a new password in one of the following ways:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Delete the user secret so that the User Operator generates a new one with a new password of sufficient length.</p>
</li>
<li>
<p>If you provided your password using the <code>.spec.authentication.password</code> properties of the <code>KafkaUser</code> custom resource, update the password in the Kubernetes secret referenced in the same password configuration.
Don&#8217;t forget to update your clients to use the new passwords.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Ensure that the CA certificates are using the correct algorithms and the SCRAM-SHA-512 passwords are of sufficient length.
You can then enable the FIPS mode.</p>
</li>
<li>
<p>Remove the <code>FIPS_MODE</code> environment variable from the Cluster Operator deployment.
This restarts the Cluster Operator and rolls all the operands to enable the FIPS mode.
After the restart is complete, all Kafka clusters now run with FIPS mode enabled.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-downgrade-str"><a class="link" href="#assembly-downgrade-str">22. Downgrading Strimzi</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>If you are encountering issues with the version of Strimzi you upgraded to,
you can revert your installation to the previous version.</p>
</div>
<div class="paragraph">
<p>If you used the YAML installation files to install Strimzi, you can use the YAML installation files from the previous release to perform the downgrade procedures.
You can downgrade Strimzi by updating the Cluster Operator and the version of Kafka you are using.
Kafka version downgrades are performed by the Cluster Operator.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The following downgrade instructions are only suitable if you installed Strimzi using the installation files.
If you installed Strimzi using another method, like <a href="https://operatorhub.io/operator/strimzi-kafka-operator" target="_blank" rel="noopener">OperatorHub.io</a>, downgrade may not be supported by that method unless specified in their documentation.
To ensure a successful downgrade process, it is essential to use a supported approach.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="proc-downgrade-cluster-operator-str"><a class="link" href="#proc-downgrade-cluster-operator-str">22.1. Downgrading the Cluster Operator to a previous version</a></h3>
<div class="paragraph">
<p>If you are encountering issues with Strimzi,
you can revert your installation.</p>
</div>
<div class="paragraph">
<p>This procedure describes how to downgrade a Cluster Operator deployment to a previous version.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>An existing Cluster Operator deployment is available.</p>
</li>
<li>
<p>You have <a href="#downloads-str">downloaded the installation files for the previous version</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Before you begin</div>
<p>Check the downgrade requirements of the <a href="#ref-operator-cluster-feature-gates-str">Strimzi feature gates</a>.
If a feature gate is permanently enabled, you may need to downgrade to a version that allows you to disable it before downgrading to your target version.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Take note of any configuration changes made to the existing Cluster Operator resources (in the <code>/install/cluster-operator</code> directory).
Any changes will be <strong>overwritten</strong> by the previous version of the Cluster Operator.</p>
</li>
<li>
<p>Revert your custom resources to reflect the supported configuration options available for the version of Strimzi you are downgrading to.</p>
</li>
<li>
<p>Update the Cluster Operator.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Modify the installation files for the previous version according to the namespace the Cluster Operator is running in.</p>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i '' 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>If you modified one or more environment variables in your existing Cluster Operator <code>Deployment</code>, edit the
<code>install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code> file to use those environment variables.</p>
</li>
</ol>
</div>
</li>
<li>
<p>When you have an updated configuration, deploy it along with the rest of the installation resources:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl replace -f install/cluster-operator</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for the rolling updates to complete.</p>
</div>
</li>
<li>
<p>Get the image for the Kafka pod to ensure the downgrade was successful:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pod my-cluster-kafka-0 -o jsonpath='{.spec.containers[0].image}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The image tag shows the new Strimzi version followed by the Kafka version.
For example, <code>&lt;strimzi_version&gt;-kafka-&lt;kafka_version&gt;</code>.</p>
</div>
<div class="paragraph">
<p>You can also <a href="#con-upgrade-status-str">check the downgrade has completed successfully from the status of the <code>Kafka</code> resource</a>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="proc-downgrade-kafka-kraft-str"><a class="link" href="#proc-downgrade-kafka-kraft-str">22.2. Downgrading KRaft-based Kafka clusters and client applications</a></h3>
<div class="paragraph _abstract">
<p>Downgrade a KRaft-based Strimzi Kafka cluster to an earlier version.
When downgrading a KRaft-based Strimzi Kafka cluster to a lower version, like moving from 3.6.1 to 3.5.1, ensure that the metadata version used by the Kafka cluster is a version supported by the Kafka version you want to downgrade to.
The metadata version for the Kafka version you are downgrading from must not be higher than the version you are downgrading to.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Consult the Apache Kafka documentation for information regarding the support and limitations associated with KRaft-based downgrades.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is up and running.</p>
</li>
<li>
<p>Before you downgrade the Strimzi Kafka cluster, check the following for the <code>Kafka</code> resource:</p>
<div class="ulist">
<ul>
<li>
<p>The <code>Kafka</code> custom resource does not contain options that are not supported by the Kafka version being downgraded to.</p>
</li>
<li>
<p><code>spec.kafka.metadataVersion</code> is set to a version that is supported by the Kafka version being downgraded to.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Update the Kafka cluster configuration.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit kafka &lt;kafka_configuration_file&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Change the <code>metadataVersion</code> version to a version supported by the Kafka version you are downgrading to; leave the <code>Kafka.spec.kafka.version</code> unchanged at the <em>current</em> Kafka version.</p>
<div class="paragraph">
<p>For example, if downgrading from Kafka 3.6.1 to 3.5.1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    replicas: 3
    metadataVersion: 3.5-IV2 # <b class="conum">(1)</b>
    version: 3.6.1 # <b class="conum">(2)</b>
    # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Metadata version is changed to a version supported by the earlier Kafka version.</p>
</li>
<li>
<p>Kafka version is unchanged.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The value of <code>metadataVersion</code> must be a string to prevent it from being interpreted as a floating point number.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Save the change, and wait for Cluster Operator to update <code>.status.kafkaMetadataVersion</code> for the <code>Kafka</code> resource.</p>
</li>
<li>
<p>Change the <code>Kafka.spec.kafka.version</code> to the previous version.</p>
<div class="paragraph">
<p>For example, if downgrading from Kafka 3.6.1 to 3.5.1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    replicas: 3
    metadataVersion: 3.5-IV2 # <b class="conum">(1)</b>
    version: 3.5.1 # <b class="conum">(2)</b>
    # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Metadata version is supported by the Kafka version.</p>
</li>
<li>
<p>Kafka version is changed to the new version.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If the image for the Kafka version is different from the image defined in <code>STRIMZI_KAFKA_IMAGES</code> for the Cluster Operator, update <code>Kafka.spec.kafka.image</code>.</p>
<div class="paragraph">
<p>See <a href="#con-versions-and-images-str">Kafka version and image mappings</a>.</p>
</div>
</li>
<li>
<p>Wait for the Cluster Operator to update the cluster.</p>
<div class="paragraph">
<p>You can <a href="#con-upgrade-status-str">check the downgrade has completed successfully from the status of the <code>Kafka</code> resource</a>.</p>
</div>
</li>
<li>
<p>Downgrade all client applications (consumers) to use the previous version of the client binaries.</p>
<div class="paragraph">
<p>The Kafka cluster and clients are now using the previous Kafka version.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="assembly-downgrade-kafka-versions-str"><a class="link" href="#assembly-downgrade-kafka-versions-str">22.3. Downgrading Kafka when using ZooKeeper</a></h3>
<div class="paragraph">
<p>If you are using Kafka in ZooKeeper mode, the downgrade process involves changing the Kafka version and the related <code>log.message.format.version</code> and <code>inter.broker.protocol.version</code> properties.</p>
</div>
<div class="sect3">
<h4 id="con-target-downgrade-version-str"><a class="link" href="#con-target-downgrade-version-str">22.3.1. Kafka version compatibility for downgrades</a></h4>
<div class="paragraph">
<p>Kafka downgrades are dependent on compatible current and target <a href="#ref-kafka-versions-str">Kafka versions</a>,
and the state at which messages have been logged.</p>
</div>
<div class="paragraph">
<p>You cannot revert to the previous Kafka version if that version does not support any of the <code>inter.broker.protocol.version</code> settings which have <em>ever been used</em> in that cluster,
or messages have been added to message logs that use a newer <code>log.message.format.version</code>.</p>
</div>
<div class="paragraph">
<p>The <code>inter.broker.protocol.version</code> determines the schemas used for persistent metadata stored by the broker, such as the schema for messages written to <code>__consumer_offsets</code>.
If you downgrade to a version of Kafka that does not understand an <code>inter.broker.protocol.version</code> that has ever been previously used in the cluster the broker will encounter data it cannot understand.</p>
</div>
<div class="paragraph">
<p>If the target downgrade version of Kafka has:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <em>same</em> <code>log.message.format.version</code> as the current version, the Cluster Operator downgrades by performing a single rolling restart of the brokers.</p>
</li>
<li>
<p>A <em>different</em> <code>log.message.format.version</code>, downgrading is only possible if the running cluster has <em>always</em> had <code>log.message.format.version</code> set to the version used by the downgraded version.
This is typically only the case if the upgrade procedure was aborted before the <code>log.message.format.version</code> was changed.
In this case, the downgrade requires:</p>
<div class="ulist">
<ul>
<li>
<p>Two rolling restarts of the brokers if the interbroker protocol of the two versions is different</p>
</li>
<li>
<p>A single rolling restart if they are the same</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Downgrading is <em>not possible</em> if the new version has ever used a <code>log.message.format.version</code> that is not supported by the previous version, including when the default value for <code>log.message.format.version</code> is used. For example, this resource can be downgraded to Kafka version 3.5.1 because the <code>log.message.format.version</code> has not been changed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  # ...
  kafka:
    version: 3.6.1
    config:
      log.message.format.version: "3.5"
      # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The downgrade would not be possible if the <code>log.message.format.version</code> was set at <code>"3.6"</code> or a value was absent, so that the parameter took the default value for a 3.6.1 broker of 3.6.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
From Kafka 3.0.0, when the <code>inter.broker.protocol.version</code> is set to <code>3.0</code> or higher, the <code>log.message.format.version</code> option is ignored and doesn&#8217;t need to be set.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="proc-downgrade-kafka-zookeeper-str"><a class="link" href="#proc-downgrade-kafka-zookeeper-str">22.3.2. Downgrading ZooKeeper-based Kafka clusters and client applications</a></h4>
<div class="paragraph _abstract">
<p>Downgrade a ZooKeeper-based Strimzi Kafka cluster to an earlier version.
When downgrading a ZooKeeper-based Strimzi Kafka cluster to a lower version, like moving from 3.6.1 to 3.5.1, ensure that the inter-broker protocol version used by the Kafka cluster is a version supported by the Kafka version you want to downgrade to.
The inter-broker protocol version for the Kafka version you are downgrading from must not be higher than the version you are downgrading to.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Consult the Apache Kafka documentation for information regarding the support and limitations associated with ZooKeeper-based downgrades.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is up and running.</p>
</li>
<li>
<p>Before you downgrade the Strimzi Kafka cluster, check the following for the <code>Kafka</code> resource:</p>
<div class="ulist">
<ul>
<li>
<p>IMPORTANT: <a href="#con-target-downgrade-version-str">Compatibility of Kafka versions</a>.</p>
</li>
<li>
<p>The <code>Kafka</code> custom resource does not contain options that are not supported by the Kafka version being downgraded to.</p>
</li>
<li>
<p><code>Kafka.spec.kafka.config</code> has a <code>log.message.format.version</code> and <code>inter.broker.protocol.version</code> that is supported by the Kafka version being downgraded to.</p>
<div class="paragraph">
<p>From Kafka 3.0.0, when the <code>inter.broker.protocol.version</code> is set to <code>3.0</code> or higher, the <code>log.message.format.version</code> option is ignored and doesn&#8217;t need to be set.</p>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Update the Kafka cluster configuration.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit kafka &lt;kafka_configuration_file&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Change the <code>inter.broker.protocol.version</code> version (and <code>log.message.format.version</code>, if applicable) to a version supported by the Kafka version you are downgrading to; leave the <code>Kafka.spec.kafka.version</code> unchanged at the <em>current</em> Kafka version.</p>
<div class="paragraph">
<p>For example, if downgrading from Kafka 3.6.1 to 3.5.1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  # ...
  kafka:
    version: 3.6.1 <b class="conum">(1)</b>
    config:
      inter.broker.protocol.version: "3.5" <b class="conum">(2)</b>
      log.message.format.version: "3.5"
      # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Kafka version is unchanged.</p>
</li>
<li>
<p>Inter-broker protocol version is changed to a version supported by the earlier Kafka version.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The value of <code>log.message.format.version</code> and <code>inter.broker.protocol.version</code> must be strings to prevent them from being interpreted as floating point numbers.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Save and exit the editor, then wait for rolling updates to complete.</p>
<div class="paragraph">
<p>Check the progress of the rolling updates by watching the pod state transitions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods my-cluster-kafka-0 -o jsonpath='{.spec.containers[0].image}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rolling updates ensure that each pod is using the specified Kafka inter-broker protocol version.</p>
</div>
</li>
<li>
<p>Change the <code>Kafka.spec.kafka.version</code> to the previous version.</p>
<div class="paragraph">
<p>For example, if downgrading from Kafka 3.6.1 to 3.5.1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  # ...
  kafka:
    version: 3.5.1 <b class="conum">(1)</b>
    config:
      inter.broker.protocol.version: "3.5" <b class="conum">(2)</b>
      log.message.format.version: "3.5"
      # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Kafka version is changed to the new version.</p>
</li>
<li>
<p>Inter-broker protocol version is supported by the Kafka version.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If the image for the Kafka version is different from the image defined in <code>STRIMZI_KAFKA_IMAGES</code> for the Cluster Operator, update <code>Kafka.spec.kafka.image</code>.</p>
<div class="paragraph">
<p>See <a href="#con-versions-and-images-str">Kafka version and image mappings</a>.</p>
</div>
</li>
<li>
<p>Wait for the Cluster Operator to update the cluster.</p>
<div class="paragraph">
<p>You can <a href="#con-upgrade-status-str">check the downgrade has completed successfully from the status of the <code>Kafka</code> resource</a>.</p>
</div>
</li>
<li>
<p>Downgrade all client applications (consumers) to use the previous version of the client binaries.</p>
<div class="paragraph">
<p>The Kafka cluster and clients are now using the previous Kafka version.</p>
</div>
</li>
<li>
<p>If you are reverting back to a version of Strimzi earlier than 0.22, which uses ZooKeeper for the storage of topic metadata, delete the internal topic store topics from the Kafka cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl run kafka-admin -ti --image=quay.io/strimzi/kafka:0.39.0-kafka-3.6.1 --rm=true --restart=Never -- ./bin/kafka-topics.sh --bootstrap-server localhost:9092 --topic __strimzi-topic-operator-kstreams-topic-store-changelog --delete &amp;&amp; ./bin/kafka-topics.sh --bootstrap-server localhost:9092 --topic __strimzi_store_topic --delete</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-deploy-restart-events-str"><a class="link" href="#assembly-deploy-restart-events-str">23. Finding information on Kafka restarts</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>After the Cluster Operator restarts a Kafka pod in a Kubernetes cluster, it emits a Kubernetes event into the pod&#8217;s namespace explaining why the pod restarted.
For help in understanding cluster behavior, you can check restart events from the command line.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You can export and monitor restart events using metrics collection tools like Prometheus. Use the metrics tool with an <em>event exporter</em> that can export the output in a suitable format.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="ref-operator-restart-events-reasons-str"><a class="link" href="#ref-operator-restart-events-reasons-str">23.1. Reasons for a restart event</a></h3>
<div class="paragraph _abstract">
<p>The Cluster Operator initiates a restart event for a specific reason.
You can check the reason by fetching information on the restart event.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 38. Restart reasons</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Event</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>CaCertHasOldGeneration</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The pod is still using a server certificate signed with an old CA, so needs to be restarted as part of the certificate update.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>CaCertRemoved</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expired CA certificates have been removed, and the pod is restarted to run with the current certificates.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>CaCertRenewed</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CA certificates have been renewed, and the pod is restarted to run with the updated certificates.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>ClientCaCertKeyReplaced</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The key used to sign clients CA certificates has been replaced, and the pod is being restarted as part of the CA renewal process.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>ClusterCaCertKeyReplaced</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The key used to sign the cluster&#8217;s CA certificates has been replaced, and the pod is being restarted as part of the CA renewal process.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>ConfigChangeRequiresRestart</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Some Kafka configuration properties are changed dynamically, but others require that the broker be restarted.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>FileSystemResizeNeeded</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The file system size has been increased, and a restart is needed to apply it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>KafkaCertificatesChanged</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One or more TLS certificates used by the Kafka broker have been updated, and a restart is needed to use them.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>ManualRollingUpdate</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A user annotated the pod, or the <code>StrimziPodSet</code> set it belongs to, to trigger a restart.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>PodForceRestartOnError</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An error occurred that requires a pod restart to rectify.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>PodHasOldRevision</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A disk was added or removed from the Kafka volumes, and a restart is needed to apply the change. When using <code>StrimziPodSet</code> resources, the same reason is given if the pod needs to be recreated.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>PodHasOldRevision</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>StrimziPodSet</code> that the pod is a member of has been updated, so the pod needs to be recreated. When using <code>StrimziPodSet</code> resources, the same reason is given if a disk was added or removed from the Kafka volumes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>PodStuck</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The pod is still pending, and is not scheduled or cannot be scheduled, so the operator has restarted the pod in a final attempt to get it running.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>PodUnresponsive</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Strimzi was unable to connect to the pod, which can indicate a broker not starting correctly, so the operator restarted it in an attempt to resolve the issue.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="ref-operator-restart-events-fields-str"><a class="link" href="#ref-operator-restart-events-fields-str">23.2. Restart event filters</a></h3>
<div class="paragraph _abstract">
<p>When checking restart events from the command line, you can specify a <code>field-selector</code> to filter on Kubernetes event fields.</p>
</div>
<div class="paragraph">
<p>The following fields are available when filtering events with <code>field-selector</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>regardingObject.kind</code></dt>
<dd>
<p>The object that was restarted, and for restart events, the kind is always <code>Pod</code>.</p>
</dd>
<dt class="hdlist1"><code>regarding.namespace</code></dt>
<dd>
<p>The namespace that the pod belongs to.</p>
</dd>
<dt class="hdlist1"><code>regardingObject.name</code></dt>
<dd>
<p>The pod&#8217;s name, for example, <code>strimzi-cluster-kafka-0</code>.</p>
</dd>
<dt class="hdlist1"><code>regardingObject.uid</code></dt>
<dd>
<p>The unique ID of the pod.</p>
</dd>
<dt class="hdlist1"><code>reason</code></dt>
<dd>
<p>The reason the pod was restarted, for example, <code>JbodVolumesChanged</code>.</p>
</dd>
<dt class="hdlist1"><code>reportingController</code></dt>
<dd>
<p>The reporting component is always <code>strimzi.io/cluster-operator</code> for Strimzi restart events.</p>
</dd>
<dt class="hdlist1"><code>source</code></dt>
<dd>
<p><code>source</code> is an older version of <code>reportingController</code>. The reporting component is always <code>strimzi.io/cluster-operator</code> for Strimzi restart events.</p>
</dd>
<dt class="hdlist1"><code>type</code></dt>
<dd>
<p>The event type, which is either <code>Warning</code> or <code>Normal</code>. For Strimzi restart events, the type is <code>Normal</code>.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In older versions of Kubernetes, the fields using the <code>regarding</code> prefix might use an <code>involvedObject</code> prefix instead. <code>reportingController</code> was previously called <code>reportingComponent</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="proc-operator-restart-events-str"><a class="link" href="#proc-operator-restart-events-str">23.3. Checking Kafka restarts</a></h3>
<div class="paragraph _abstract">
<p>Use a <code>kubectl</code> command to list restart events initiated by the Cluster Operator.
Filter restart events emitted by the Cluster Operator by setting the Cluster Operator as the reporting component using the <code>reportingController</code> or <code>source</code> event fields.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is running in the Kubernetes cluster.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Get all restart events emitted by the Cluster Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl -n kafka get events --field-selector reportingController=strimzi.io/cluster-operator</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example showing events returned</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">LAST SEEN   TYPE     REASON                   OBJECT                        MESSAGE
2m          Normal   CaCertRenewed            pod/strimzi-cluster-kafka-0   CA certificate renewed
58m         Normal   PodForceRestartOnError   pod/strimzi-cluster-kafka-1   Pod needs to be forcibly restarted due to an error
5m47s       Normal   ManualRollingUpdate      pod/strimzi-cluster-kafka-2   Pod was manually annotated to be rolled</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify a <code>reason</code> or other <code>field-selector</code> options to constrain the events returned.</p>
</div>
<div class="paragraph">
<p>Here, a specific reason is added:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl -n kafka get events --field-selector reportingController=strimzi.io/cluster-operator,reason=PodForceRestartOnError</code></pre>
</div>
</div>
</li>
<li>
<p>Use an output format, such as YAML, to return more detailed information about one or more events.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell-session hljs" data-lang="shell-session">kubectl -n kafka get events --field-selector reportingController=strimzi.io/cluster-operator,reason=PodForceRestartOnError -o yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example showing detailed events output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
items:
- action: StrimziInitiatedPodRestart
  apiVersion: v1
  eventTime: "2022-05-13T00:22:34.168086Z"
  firstTimestamp: null
  involvedObject:
      kind: Pod
      name: strimzi-cluster-kafka-1
      namespace: kafka
  kind: Event
  lastTimestamp: null
  message: Pod needs to be forcibly restarted due to an error
  metadata:
      creationTimestamp: "2022-05-13T00:22:34Z"
      generateName: strimzi-event
      name: strimzi-eventwppk6
      namespace: kafka
      resourceVersion: "432961"
      uid: 29fcdb9e-f2cf-4c95-a165-a5efcd48edfc
  reason: PodForceRestartOnError
  reportingController: strimzi.io/cluster-operator
  reportingInstance: strimzi-cluster-operator-6458cfb4c6-6bpdp
  source: {}
  type: Normal
kind: List
metadata:
  resourceVersion: ""
  selfLink: ""</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following fields are deprecated, so they are not populated for these events:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>firstTimestamp</code></p>
</li>
<li>
<p><code>lastTimestamp</code></p>
</li>
<li>
<p><code>source</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-tuning-config-str"><a class="link" href="#assembly-tuning-config-str">24. Tuning Kafka configuration</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Use configuration properties to optimize the performance of Kafka brokers, producers and consumers.</p>
</div>
<div class="paragraph">
<p>A minimum set of configuration properties is required,
but you can add or adjust properties to change how producers and consumers interact with Kafka brokers.
For example, you can tune latency and throughput of messages so that clients can respond to data in real time.</p>
</div>
<div class="paragraph">
<p>You might start by analyzing metrics to gauge where to make your initial configurations,
then make incremental changes and further comparisons of metrics until you have the configuration you need.</p>
</div>
<div class="paragraph">
<p>For more information about Apache Kafka configuration properties, see the <a href="https://kafka.apache.org/documentation/" target="_blank" rel="noopener">Apache Kafka documentation</a>.</p>
</div>
<div class="sect2">
<h3 id="tools_that_help_with_tuning"><a class="link" href="#tools_that_help_with_tuning">24.1. Tools that help with tuning</a></h3>
<div class="paragraph">
<p>The following tools help with Kafka tuning:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cruise Control generates optimization proposals that you can use to assess and implement a cluster rebalance</p>
</li>
<li>
<p>Kafka Static Quota plugin sets limits on brokers</p>
</li>
<li>
<p>Rack configuration spreads broker partitions across racks and allows consumers to fetch data from the nearest replica</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="con-managed-broker-config-properties-str"><a class="link" href="#con-managed-broker-config-properties-str">24.2. Managed broker configurations</a></h3>
<div class="paragraph _abstract">
<p>When you deploy Strimzi on Kubernetes, you can specify broker configuration through the <code>config</code> property of the <code>Kafka</code> custom resource.
However, certain broker configuration options are managed directly by Strimzi.</p>
</div>
<div class="paragraph">
<p>As such, you cannot configure the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>broker.id</code> to specify the ID of the Kafka broker</p>
</li>
<li>
<p><code>log.dirs</code> directories for log data</p>
</li>
<li>
<p><code>zookeeper.connect</code> configuration to connect Kafka with ZooKeeper</p>
</li>
<li>
<p><code>listeners</code> to expose the Kafka cluster to clients</p>
</li>
<li>
<p><code>authorization</code> mechanisms to allow or decline actions executed by users</p>
</li>
<li>
<p><code>authentication</code> mechanisms to prove the identity of users requiring access to Kafka</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Broker IDs start from 0 (zero) and correspond to the number of broker replicas.
Log directories are mounted to <code>/var/lib/kafka/data/kafka-log<em>IDX</em></code> based on the <code>spec.kafka.storage</code> configuration in the <code>Kafka</code> custom resource.
<em>IDX</em> is the Kafka broker pod index.</p>
</div>
<div class="paragraph">
<p>For a list of exclusions, see the <a href="./configuring.html#type-KafkaClusterSpec-reference"><code>KafkaClusterSpec</code> schema reference</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="con-broker-config-properties-str"><a class="link" href="#con-broker-config-properties-str">24.3. Kafka broker configuration tuning</a></h3>
<div class="paragraph _abstract">
<p>Use configuration properties to optimize the performance of Kafka brokers.
You can use standard Kafka broker configuration options, except for properties managed directly by Strimzi.</p>
</div>
<div class="sect3">
<h4 id="basic_broker_configuration"><a class="link" href="#basic_broker_configuration">24.3.1. Basic broker configuration</a></h4>
<div class="paragraph">
<p>A typical broker configuration will include settings for properties related to topics, threads and logs.</p>
</div>
<div class="listingblock">
<div class="title">Basic broker configuration properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
num.partitions=1
default.replication.factor=3
offsets.topic.replication.factor=3
transaction.state.log.replication.factor=3
transaction.state.log.min.isr=2
log.retention.hours=168
log.segment.bytes=1073741824
log.retention.check.interval.ms=300000
num.network.threads=3
num.io.threads=8
num.recovery.threads.per.data.dir=1
socket.send.buffer.bytes=102400
socket.receive.buffer.bytes=102400
socket.request.max.bytes=104857600
group.initial.rebalance.delay.ms=0
zookeeper.connection.timeout.ms=6000
# ...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="replicating_topics_for_high_availability"><a class="link" href="#replicating_topics_for_high_availability">24.3.2. Replicating topics for high availability</a></h4>
<div class="paragraph">
<p>Basic topic properties set the default number of partitions and replication factor for topics, which will apply to topics that are created without these properties being explicitly set, including when topics are created automatically.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
num.partitions=1
auto.create.topics.enable=false
default.replication.factor=3
min.insync.replicas=2
replica.fetch.max.bytes=1048576
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>For high availability environments, it is advisable to increase the replication factor to at least 3 for topics and set the minimum number of in-sync replicas required to 1 less than the replication factor.</p>
</div>
<div class="paragraph">
<p>The <code>auto.create.topics.enable</code> property is enabled by default so that topics that do not already exist are created automatically when needed by producers and consumers.
If you are using automatic topic creation, you can set the default number of partitions for topics using <code>num.partitions</code>.
Generally, however, this property is disabled so that more control is provided over topics through explicit topic creation.</p>
</div>
<div class="paragraph">
<p>For <a href="#data_durability">data durability</a>, you should also set <code>min.insync.replicas</code> in your <em>topic</em> configuration and message delivery acknowledgments using <code>acks=all</code> in your <em>producer</em> configuration.</p>
</div>
<div class="paragraph">
<p>Use <code>replica.fetch.max.bytes</code> to set the maximum size, in bytes, of messages fetched by each follower that replicates the leader partition.
Change this value according to the average message size and throughput. When considering the total memory allocation required for read/write buffering, the memory available must also be able to accommodate the maximum replicated message size when multiplied by all followers.</p>
</div>
<div class="paragraph">
<p>The <code>delete.topic.enable</code> property is enabled by default to allow topics to be deleted.
In a production environment, you should disable this property to avoid accidental topic deletion, resulting in data loss.
You can, however, temporarily enable it and delete topics and then disable it again.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
When running Strimzi on Kubernetes, the Topic Operator can provide operator-style topic management. You can use the <code>KafkaTopic</code> resource to create topics.
For topics created using the <code>KafkaTopic</code> resource, the replication factor is set using <code>spec.replicas</code>.
If <code>delete.topic.enable</code> is enabled, you can also delete topics using the <code>KafkaTopic</code> resource.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
auto.create.topics.enable=false
delete.topic.enable=true
# ...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="internal_topic_settings_for_transactions_and_commits"><a class="link" href="#internal_topic_settings_for_transactions_and_commits">24.3.3. Internal topic settings for transactions and commits</a></h4>
<div class="paragraph">
<p>If you are <a href="#reliability_guarantees">using transactions</a> to enable atomic writes to partitions from producers, the state of the transactions is stored in the internal <code>__transaction_state</code> topic.
By default, the brokers are configured with a replication factor of 3 and a minimum of 2 in-sync replicas for this topic, which means that a minimum of three brokers are required in your Kafka cluster.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
transaction.state.log.replication.factor=3
transaction.state.log.min.isr=2
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, the internal <code>__consumer_offsets</code> topic, which stores consumer state, has default settings for the number of partitions and replication factor.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
offsets.topic.num.partitions=50
offsets.topic.replication.factor=3
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Do not reduce these settings in production.</strong>
You can increase the settings in a <em>production</em> environment.
As an exception, you might want to reduce the settings in a single-broker <em>test</em> environment.</p>
</div>
</div>
<div class="sect3">
<h4 id="improving_request_handling_throughput_by_increasing_io_threads"><a class="link" href="#improving_request_handling_throughput_by_increasing_io_threads">24.3.4. Improving request handling throughput by increasing I/O threads</a></h4>
<div class="paragraph">
<p>Network threads handle requests to the Kafka cluster, such as produce and fetch requests from client applications.
Produce requests are placed in a request queue. Responses are placed in a response queue.</p>
</div>
<div class="paragraph">
<p>The number of network threads per listener should reflect the replication factor and the levels of activity from client producers and consumers interacting with the Kafka cluster.
If you are going to have a lot of requests, you can increase the number of threads, using the amount of time threads are idle to determine when to add more threads.</p>
</div>
<div class="paragraph">
<p>To reduce congestion and regulate the request traffic, you can limit the number of requests allowed in the request queue.
When the request queue is full, all incoming traffic is blocked.</p>
</div>
<div class="paragraph">
<p>I/O threads pick up requests from the request queue to process them.
Adding more threads can improve throughput, but the number of CPU cores and disk bandwidth imposes a practical upper limit.
At a minimum, the number of I/O threads should equal the number of storage volumes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
num.network.threads=3 <b class="conum">(1)</b>
queued.max.requests=500 <b class="conum">(2)</b>
num.io.threads=8 <b class="conum">(3)</b>
num.recovery.threads.per.data.dir=4 <b class="conum">(4)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The number of network threads for the Kafka cluster.</p>
</li>
<li>
<p>The number of requests allowed in the request queue.</p>
</li>
<li>
<p>The number of I/O  threads for a Kafka broker.</p>
</li>
<li>
<p>The number of threads used for log loading at startup and flushing at shutdown. Try setting to a value of at least the number of cores.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Configuration updates to the thread pools for all brokers might occur dynamically at the cluster level.
These updates are restricted to between half the current size and twice the current size.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The following Kafka broker metrics can help with working out the number of threads required:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>kafka.network:type=SocketServer,name=NetworkProcessorAvgIdlePercent</code> provides metrics on the average time network threads are idle as a percentage.</p>
</li>
<li>
<p><code>kafka.server:type=KafkaRequestHandlerPool,name=RequestHandlerAvgIdlePercent</code> provides metrics on the average time I/O threads are idle as a percentage.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If there is 0% idle time, all resources are in use, which means that adding more threads might be beneficial.
When idle time goes below 30%, performance may start to suffer.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If threads are slow or limited due to the number of disks, you can try increasing the size of the buffers for network requests to improve throughput:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
replica.socket.receive.buffer.bytes=65536
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>And also increase the maximum number of bytes Kafka can receive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
socket.request.max.bytes=104857600
# ...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="increasing_bandwidth_for_high_latency_connections"><a class="link" href="#increasing_bandwidth_for_high_latency_connections">24.3.5. Increasing bandwidth for high latency connections</a></h4>
<div class="paragraph">
<p>Kafka batches data to achieve reasonable throughput over high-latency connections from Kafka to clients, such as connections between datacenters.
However, if high latency is a problem, you can increase the size of the buffers for sending and receiving messages.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
socket.send.buffer.bytes=1048576
socket.receive.buffer.bytes=1048576
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can estimate the optimal size of your buffers using a <em>bandwidth-delay product</em> calculation,
which multiplies the maximum bandwidth of the link (in bytes/s) with the round-trip delay (in seconds) to give an estimate of how large a buffer is required to sustain maximum throughput.</p>
</div>
</div>
<div class="sect3">
<h4 id="managing_kafka_logs_with_delete_and_compact_policies"><a class="link" href="#managing_kafka_logs_with_delete_and_compact_policies">24.3.6. Managing Kafka logs with delete and compact policies</a></h4>
<div class="paragraph">
<p>Kafka relies on logs to store message data.
A log consists of a series of segments, where each segment is associated with offset-based and timestamp-based indexes.
New messages are written to an <em>active</em> segment and are never subsequently modified.
When serving fetch requests from consumers, the segments are read.
Periodically, the active segment is <em>rolled</em> to become read-only, and a new active segment is created to replace it.
There is only one active segment per topic-partition per broker.
Older segments are retained until they become eligible for deletion.</p>
</div>
<div class="paragraph">
<p>Configuration at the broker level determines the maximum size in bytes of a log segment and the time in milliseconds before an active segment is rolled:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
log.segment.bytes=1073741824
log.roll.ms=604800000
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>These settings can be overridden at the topic level using <code>segment.bytes</code> and <code>segment.ms</code>.
The choice to lower or raise these values depends on the policy for segment deletion.
A larger size means the active segment contains more messages and is rolled less often.
Segments also become eligible for deletion less frequently.</p>
</div>
<div class="paragraph">
<p>In Kafka, log cleanup policies determine how log data is managed.
In most cases, you won&#8217;t need to change the default configuration at the cluster level, which specifies the <code>delete</code> cleanup policy and enables the log cleaner used by the <code>compact</code> cleanup policy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
log.cleanup.policy=delete
log.cleaner.enable=true
# ...</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Delete cleanup policy</dt>
<dd>
<p>Delete cleanup policy is the default cluster-wide policy for all topics.
The policy is applied to topics that do not have a specific topic-level policy configured.
Kafka removes older segments based on time-based or size-based log retention limits.</p>
</dd>
<dt class="hdlist1">Compact cleanup policy</dt>
<dd>
<p>Compact cleanup policy is generally configured as a topic-level policy (<code>cleanup.policy=compact</code>).
Kafka&#8217;s log cleaner applies compaction on specific topics, retaining only the most recent value for a key in the topic.
You can also configure topics to use both policies (<code>cleanup.policy=compact,delete</code>).</p>
</dd>
</dl>
</div>
<div class="paragraph">
<div class="title">Setting up retention limits for the delete policy</div>
<p>Delete cleanup policy corresponds to managing logs with data retention.
The policy is suitable when data does not need to be retained forever.
You can establish time-based or size-based log retention and cleanup policies to keep logs bounded.</p>
</div>
<div class="paragraph">
<p>When log retention policies are employed, non-active log segments are removed when retention limits are reached.
Deletion of old segments helps to prevent exceeding disk capacity.</p>
</div>
<div class="paragraph">
<p>For time-based log retention, you set a retention period based on hours, minutes, or milliseconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
log.retention.ms=1680000
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The retention period is based on the time messages were appended to the segment.
Kafka uses the timestamp of the latest message within a segment to determine if that segment has expired or not.
The milliseconds configuration has priority over minutes, which has priority over hours.
The minutes and milliseconds configurations are null by default, but the three options provide a substantial level of control over the data you wish to retain.
Preference should be given to the milliseconds configuration, as it is the only one of the three properties that is dynamically updateable.</p>
</div>
<div class="paragraph">
<p>If <code>log.retention.ms</code> is set to -1, no time limit is applied to log retention, and all logs are retained.
However, this setting is not generally recommended as it can lead to issues with full disks that are difficult to rectify.</p>
</div>
<div class="paragraph">
<p>For size-based log retention, you specify a minimum log size (in bytes):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
log.retention.bytes=1073741824
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that Kafka will ensure there is always at least the specified amount of log data available.</p>
</div>
<div class="paragraph">
<p>For example, if you set <code>log.retention.bytes</code> to 1000 and <code>log.segment.bytes</code> to 300, Kafka will keep 4 segments plus the active segment, ensuring a minimum of 1000 bytes are available.
When the active segment becomes full and a new segment is created, the oldest segment is deleted.
At this point, the size on disk may exceed the specified 1000 bytes, potentially ranging between 1200 and 1500 bytes (excluding index files).</p>
</div>
<div class="paragraph">
<p>A potential issue with using a log size is that it does not take into account the time messages were appended to a segment.
You can use time-based and size-based log retention for your cleanup policy to get the balance you need.
Whichever threshold is reached first triggers the cleanup.</p>
</div>
<div class="paragraph">
<p>To add a time delay before a segment file is deleted from the system, you can use <code>log.segment.delete.delay.ms</code> at the broker level for all topics:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
log.segment.delete.delay.ms=60000
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or configure <code>file.delete.delay.ms</code> at the topic level.</p>
</div>
<div class="paragraph">
<p>You set the frequency at which the log is checked for cleanup in milliseconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
log.retention.check.interval.ms=300000
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Adjust the log retention check interval in relation to the log retention settings.
Smaller retention sizes might require more frequent checks.
The frequency of cleanup should be often enough to manage the disk space but not so often it affects performance on a broker.</p>
</div>
<div class="paragraph">
<div class="title">Retaining the most recent messages using compact policy</div>
<p>When you enable log compaction for a topic by setting <code>cleanup.policy=compact</code>, Kafka uses the log cleaner as a background thread to perform the compaction.
The compact policy guarantees that the most recent message for each message key is retained, effectively cleaning up older versions of records.
The policy is suitable when message values are changeable, and you want to retain the latest update.</p>
</div>
<div class="paragraph">
<p>If a cleanup policy is set for log compaction, the <em>head</em> of the log operates as a standard Kafka log, with writes for new messages appended in order.
In the <em>tail</em> of a compacted log, where the log cleaner operates, records are deleted if another record with the same key occurs later in the log.
Messages with null values are also deleted.
To use compaction, you must have keys to identify related messages because Kafka guarantees that the latest messages for each key will be retained, but it does not guarantee that the whole compacted log will not contain duplicates.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/tuning/broker-tuning-compaction-before.png" alt="Image of compaction showing key value writes">
</div>
<div class="title">Figure 5. Log showing key value writes with offset positions before compaction</div>
</div>
<div class="paragraph">
<p>Using keys to identify messages, Kafka compaction keeps the latest message (with the highest offset) that is present in the log tail for a specific message key, eventually discarding earlier messages that have the same key.
The message in its latest state is always available, and any out-of-date records of that particular message are eventually removed when the log cleaner runs.
You can restore a message back to a previous state.
Records retain their original offsets even when surrounding records get deleted.
Consequently, the tail can have non-contiguous offsets.
When consuming an offset that&#8217;s no longer available in the tail, the record with the next higher offset is found.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/tuning/broker-tuning-compaction-after.png" alt="Image of compaction after log cleanup">
</div>
<div class="title">Figure 6. Log after compaction</div>
</div>
<div class="paragraph">
<p>If appropriate, you can add a delay to the compaction process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
log.cleaner.delete.retention.ms=86400000
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The deleted data retention period gives time to notice the data is gone before it is irretrievably deleted.</p>
</div>
<div class="paragraph">
<p>To delete all messages related to a specific key, a producer can send a <em>tombstone</em> message.
A tombstone has a null value and acts as a marker to inform consumers that the corresponding message for that key has been deleted.
After some time, only the tombstone marker is retained.
Assuming new messages continue to come in, the marker is retained for a duration specified by <code>log.cleaner.delete.retention.ms</code> to allow consumers enough time to recognize the deletion.</p>
</div>
<div class="paragraph">
<p>You can also set a time in milliseconds to put the cleaner on standby if there are no logs to clean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
log.cleaner.backoff.ms=15000
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Using combined compact and delete policies</div>
<p>If you choose only a compact policy, your log can still become arbitrarily large.
In such cases, you can set the cleanup policy for a topic to compact and delete logs.
Kafka applies log compaction, removing older versions of records and retaining only the latest version of each key.
Kafka also deletes records based on the specified time-based or size-based log retention settings.</p>
</div>
<div class="paragraph">
<p>For example, in the following diagram only the latest message (with the highest offset) for a specific message key is retained up to the compaction point.
If there are any records remaining up to the retention point they are deleted.
In this case, the compaction process would remove all duplicates.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/tuning/broker-tuning-compaction-retention.png" alt="Image of compaction with retention point">
</div>
<div class="title">Figure 7. Log retention point and compaction point</div>
</div>
</div>
<div class="sect3">
<h4 id="managing_efficient_disk_utilization_for_compaction"><a class="link" href="#managing_efficient_disk_utilization_for_compaction">24.3.7. Managing efficient disk utilization for compaction</a></h4>
<div class="paragraph">
<p>When employing the compact policy and log cleaner to handle topic logs in Kafka, consider optimizing memory allocation.</p>
</div>
<div class="paragraph">
<p>You can fine-tune memory allocation using the deduplication property (<code>dedupe.buffer.size</code>), which determines the total memory allocated for cleanup tasks across all log cleaner threads.
Additionally, you can establish a maximum memory usage limit by defining a percentage through the <code>buffer.load.factor</code> property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
log.cleaner.dedupe.buffer.size=134217728
log.cleaner.io.buffer.load.factor=0.9
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each log entry uses exactly 24 bytes, so you can work out how many log entries the buffer can handle in a single run and adjust the setting accordingly.</p>
</div>
<div class="paragraph">
<p>If possible, consider increasing the number of log cleaner threads if you are looking to reduce the log cleaning time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
log.cleaner.threads=8
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are experiencing issues with 100% disk bandwidth usage, you can throttle the log cleaner I/O so that the sum of the read/write operations is less than a specified double value based on the capabilities of the disks performing the operations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
log.cleaner.io.max.bytes.per.second=1.7976931348623157E308
# ...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="handling_large_message_sizes"><a class="link" href="#handling_large_message_sizes">24.3.8. Handling large message sizes</a></h4>
<div class="paragraph">
<p>The default batch size for messages is 1MB, which is optimal for maximum throughput in most use cases.
Kafka can accommodate larger batches at a reduced throughput, assuming adequate disk capacity.</p>
</div>
<div class="paragraph">
<p>Large message sizes are handled in four ways:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#con-producer-config-properties-throughput-str">Producer-side message compression</a> writes compressed messages to the log.</p>
</li>
<li>
<p>Reference-based messaging sends only a reference to data stored in some other system in the message’s value.</p>
</li>
<li>
<p>Inline messaging splits messages into chunks that use the same key, which are then combined on output using a stream-processor like Kafka Streams.</p>
</li>
<li>
<p>Broker and producer/consumer client application configuration built to handle larger message sizes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The reference-based messaging and message compression options are recommended and cover most situations.
With any of these options, care must be take to avoid introducing performance issues.</p>
</div>
<div class="paragraph">
<div class="title">Producer-side compression</div>
<p>For producer configuration, you specify a <code>compression.type</code>, such as Gzip, which is then applied to batches of data generated by the producer.
Using the broker configuration <code>compression.type=producer</code>, the broker retains whatever compression the producer used.
Whenever producer and topic compression do not match, the broker has to compress batches again prior to appending them to the log, which impacts broker performance.</p>
</div>
<div class="paragraph">
<p>Compression also adds additional processing overhead on the producer and decompression overhead on the consumer,
but includes more data in a batch, so is often beneficial to throughput when message data compresses well.</p>
</div>
<div class="paragraph">
<p>Combine producer-side compression with fine-tuning of the batch size to facilitate optimum throughput.
Using metrics helps to gauge the average batch size needed.</p>
</div>
<div class="paragraph">
<div class="title">Reference-based messaging</div>
<p>Reference-based messaging is useful for data replication when you do not know how big a message will be.
The external data store must be fast, durable, and highly available for this configuration to work.
Data is written to the data store and a reference to the data is returned.
The producer sends a message containing the reference to Kafka.
The consumer gets the reference from the message and uses it to fetch the data from the data store.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/tuning/broker-tuning-messaging-reference.png" alt="Image of reference-based messaging flow">
</div>
<div class="title">Figure 8. Reference-based messaging flow</div>
</div>
<div class="paragraph">
<p>As the message passing requires more trips, end-to-end latency will increase.
Another significant drawback of this approach is there is no automatic clean up of the data in the external system when the Kafka message gets cleaned up.
A hybrid approach would be to only send large messages to the data store and process standard-sized messages directly.</p>
</div>
<div class="paragraph">
<div class="title">Inline messaging</div>
<p>Inline messaging is complex, but it does not have the overhead of depending on external systems like reference-based messaging.</p>
</div>
<div class="paragraph">
<p>The producing client application has to serialize and then chunk the data if the message is too big.
The producer then uses the Kafka <code>ByteArraySerializer</code> or similar to serialize each chunk again before sending it.
The consumer tracks messages and buffers chunks until it has a complete message.
The consuming client application receives the chunks, which are assembled before deserialization.
Complete messages are delivered to the rest of the consuming application in order according to the offset of the first or last chunk for each set of chunked messages.
Successful delivery of the complete message is checked against offset metadata to avoid duplicates during a rebalance.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/tuning/broker-tuning-messaging-inline.png" alt="Image of inline messaging flow">
</div>
<div class="title">Figure 9. Inline messaging flow</div>
</div>
<div class="paragraph">
<p>Inline messaging has a performance overhead on the consumer side because of the buffering required, particularly when handling a series of large messages in parallel.
The chunks of large messages can become interleaved, so that it  is not always possible to commit when all the chunks of a message have been consumed if the chunks of another large message in the buffer are incomplete.
For this reason, the buffering is usually supported by persisting message chunks or by implementing commit logic.</p>
</div>
<div class="paragraph">
<div class="title">Configuration to handle larger messages</div>
<p>If larger messages cannot be avoided, and to avoid blocks at any point of the message flow, you can increase message limits.
To do this, configure <code>message.max.bytes</code> at the topic level to set the maximum record batch size for individual topics.
If you set <code>message.max.bytes</code> at the broker level, larger messages are allowed for all topics.</p>
</div>
<div class="paragraph">
<p>The broker will reject any message that is greater than the limit set with <code>message.max.bytes</code>.
The buffer size for the producers (<code>max.request.size</code>) and consumers (<code>message.max.bytes</code>) must be able to accommodate the larger messages.</p>
</div>
</div>
<div class="sect3">
<h4 id="controlling_the_log_flush_of_message_data"><a class="link" href="#controlling_the_log_flush_of_message_data">24.3.9. Controlling the log flush of message data</a></h4>
<div class="paragraph">
<p>Generally, the recommendation is to not set explicit flush thresholds and let the operating system perform background flush using its default settings.
Partition replication provides greater data durability than writes to any single disk, as a failed broker can recover from its in-sync replicas.</p>
</div>
<div class="paragraph">
<p>Log flush properties control the periodic writes of cached message data to disk.
The scheduler specifies the frequency of checks on the log cache in milliseconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
log.flush.scheduler.interval.ms=2000
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can control the frequency of the flush based on the maximum amount of time that a message is kept in-memory and the maximum number of messages in the log before writing to disk:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
log.flush.interval.ms=50000
log.flush.interval.messages=100000
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The wait between flushes includes the time to make the check and the specified interval before the flush is carried out.
Increasing the frequency of flushes can affect throughput.</p>
</div>
<div class="paragraph">
<p>If you are using application flush management, setting lower flush thresholds might be appropriate if you are using faster disks.</p>
</div>
</div>
<div class="sect3">
<h4 id="partition_rebalancing_for_availability"><a class="link" href="#partition_rebalancing_for_availability">24.3.10. Partition rebalancing for availability</a></h4>
<div class="paragraph">
<p>Partitions can be replicated across brokers for fault tolerance.
For a given partition, one broker is elected leader and handles all produce requests (writes to the log).
Partition followers on other brokers replicate the partition data of the partition leader for data reliability in the event of the leader failing.</p>
</div>
<div class="paragraph">
<p>Followers do not normally serve clients, though <code>rack</code> configuration allows a consumer to consume messages from the closest replica when a Kafka cluster spans multiple datacenters.
Followers operate only to replicate messages from the partition leader and allow recovery should the leader fail.
Recovery requires an in-sync follower. Followers stay in sync by sending fetch requests to the leader, which returns messages to the follower in order.
The follower is considered to be in sync if it has caught up with the most recently committed message on the leader.
The leader checks this by looking at the last offset requested by the follower.
An out-of-sync follower is usually not eligible as a leader should the current leader fail, unless <a href="#con-broker-config-properties-unclean-str">unclean leader election is allowed</a>.</p>
</div>
<div class="paragraph">
<p>You can adjust the lag time before a follower is considered out of sync:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
replica.lag.time.max.ms=30000
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lag time puts an upper limit on the time to replicate a message to all in-sync replicas and how long a producer has to wait for an acknowledgment.
If a follower fails to make a fetch request and catch up with the latest message within the specified lag time, it is removed from in-sync replicas.
You can reduce the lag time to detect failed replicas sooner, but by doing so you might increase the number of followers that fall out of sync needlessly.
The right lag time value depends on both network latency and broker disk bandwidth.</p>
</div>
<div class="paragraph">
<p>When a leader partition is no longer available, one of the in-sync replicas is chosen as the new leader.
The first broker in a partition’s list of replicas is known as the <em>preferred</em> leader.
By default, Kafka is enabled for automatic partition leader rebalancing based on a periodic check of leader distribution.
That is, Kafka checks to see if the preferred leader is the <em>current</em> leader.
A rebalance ensures that leaders are evenly distributed across brokers and brokers are not overloaded.</p>
</div>
<div class="paragraph">
<p>You can use Cruise Control for Strimzi to figure out replica assignments to brokers that balance load evenly across the cluster.
Its calculation takes into account the differing load experienced by leaders and followers.
A failed leader affects the balance of a Kafka cluster because the remaining brokers get the extra work of leading additional partitions.</p>
</div>
<div class="paragraph">
<p>For the assignment found by Cruise Control to actually be balanced it is necessary that partitions are lead by the preferred leader. Kafka can automatically ensure that the preferred leader is being used (where possible), changing the current leader if necessary. This ensures that the cluster remains in the balanced state found by Cruise Control.</p>
</div>
<div class="paragraph">
<p>You can control the frequency, in seconds, of the rebalance check and the maximum percentage of imbalance allowed for a broker before a rebalance is triggered.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env">#...
auto.leader.rebalance.enable=true
leader.imbalance.check.interval.seconds=300
leader.imbalance.per.broker.percentage=10
#...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The percentage leader imbalance for a broker is the ratio between the current number of partitions for which the broker is the current leader and the number of partitions for which it is the preferred leader.
You can set the percentage to zero to ensure that preferred leaders are always elected, assuming they are in sync.</p>
</div>
<div class="paragraph">
<p>If the checks for rebalances need more control, you can disable automated rebalances. You can then choose when to trigger a rebalance using the <code>kafka-leader-election.sh</code> command line tool.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The Grafana dashboards provided with Strimzi show metrics for under-replicated partitions and partitions that do not have an active leader.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="con-broker-config-properties-unclean-str"><a class="link" href="#con-broker-config-properties-unclean-str">24.3.11. Unclean leader election</a></h4>
<div class="paragraph">
<p>Leader election to an in-sync replica is considered clean because it guarantees no loss of data. And this is what happens by default.
But what if there is no in-sync replica to take on leadership? Perhaps the ISR (in-sync replica) only contained the leader when the leader&#8217;s disk died. If a minimum number of in-sync replicas is not set, and there are no followers in sync with the partition leader when its hard drive fails irrevocably, data is already lost.
Not only that, but <em>a new leader cannot be elected</em> because there are no in-sync followers.</p>
</div>
<div class="paragraph">
<p>You can configure how Kafka handles leader failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
unclean.leader.election.enable=false
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unclean leader election is disabled by default, which means that out-of-sync replicas cannot become leaders.
With clean leader election, if no other broker was in the ISR when the old leader was lost, Kafka waits until that leader is back online before messages can be written or read.
Unclean leader election means out-of-sync replicas can become leaders, but you risk losing messages.
The choice you make depends on whether your requirements favor availability or durability.</p>
</div>
<div class="paragraph">
<p>You can override the default configuration for specific topics at the topic level.
If you cannot afford the risk of data loss, then leave the default configuration.</p>
</div>
</div>
<div class="sect3">
<h4 id="avoiding_unnecessary_consumer_group_rebalances"><a class="link" href="#avoiding_unnecessary_consumer_group_rebalances">24.3.12. Avoiding unnecessary consumer group rebalances</a></h4>
<div class="paragraph">
<p>For consumers joining a new consumer group, you can add a delay so that unnecessary rebalances to the broker are avoided:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
group.initial.rebalance.delay.ms=3000
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The delay is the amount of time that the coordinator waits for members to join. The longer the delay,
the more likely it is that all the members will join in time and avoid a rebalance.
But the delay also prevents the group from consuming until the period has ended.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-producer-config-properties-str"><a class="link" href="#con-producer-config-properties-str">24.4. Kafka producer configuration tuning</a></h3>
<div class="paragraph _abstract">
<p>Use a basic producer configuration with optional properties that are tailored to specific use cases.</p>
</div>
<div class="paragraph">
<p>Adjusting your configuration to maximize throughput might increase latency or vice versa.
You will need to experiment and tune your producer configuration to get the balance you need.</p>
</div>
<div class="sect3">
<h4 id="basic_producer_configuration"><a class="link" href="#basic_producer_configuration">24.4.1. Basic producer configuration</a></h4>
<div class="paragraph">
<p>Connection and serializer properties are required for every producer.
Generally, it is good practice to add a client id for tracking,
and use compression on the producer to reduce batch sizes in requests.</p>
</div>
<div class="paragraph">
<p>In a basic producer configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The order of messages in a partition is not guaranteed.</p>
</li>
<li>
<p>The acknowledgment of messages reaching the broker does not guarantee durability.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Basic producer configuration properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
bootstrap.servers=localhost:9092 <b class="conum">(1)</b>
key.serializer=org.apache.kafka.common.serialization.StringSerializer <b class="conum">(2)</b>
value.serializer=org.apache.kafka.common.serialization.StringSerializer <b class="conum">(3)</b>
client.id=my-client <b class="conum">(4)</b>
compression.type=gzip <b class="conum">(5)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>(Required) Tells the producer to connect to a Kafka cluster using a <em>host:port</em> bootstrap server address for a Kafka broker.
The producer uses the address to discover and connect to all brokers in the cluster.
Use a comma-separated list to specify two or three addresses in case a server is down, but it’s not necessary to provide a list of all the brokers in the cluster.</p>
</li>
<li>
<p>(Required) Serializer to transform the key of each message to bytes prior to them being sent to a broker.</p>
</li>
<li>
<p>(Required) Serializer to transform the value of each message to bytes prior to them being sent to a broker.</p>
</li>
<li>
<p>(Optional) The logical name for the client, which is used in logs and metrics to identify the source of a request.</p>
</li>
<li>
<p>(Optional) The codec for compressing messages, which are sent and might be stored in compressed format and then decompressed when reaching a consumer.
Compression is useful for improving throughput and reducing the load on storage, but might not be suitable for low latency applications where the cost of compression or decompression could be prohibitive.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="data_durability"><a class="link" href="#data_durability">24.4.2. Data durability</a></h4>
<div class="paragraph">
<p>Message delivery acknowledgments minimize the likelihood that messages are lost.
Acknowledgments are enabled by default with the <code>acks</code> property set at <code>acks=all</code>.</p>
</div>
<div class="listingblock">
<div class="title">Acknowledging message delivery</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
acks=all <b class="conum">(1)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>acks=all</code> forces a leader replica to replicate messages to a certain number of followers before
acknowledging that the message request was successfully received.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <code>acks=all</code> setting offers the strongest guarantee of delivery, but it will increase the latency between the producer sending a message and receiving acknowledgment.
If you don&#8217;t require such strong guarantees, a setting of <code>acks=0</code> or <code>acks=1</code> provides either no delivery guarantees or only acknowledgment that the leader replica has written the record to its log.</p>
</div>
<div class="paragraph">
<p>With <code>acks=all</code>, the leader waits for all in-sync replicas to acknowledge message delivery.
A topic&#8217;s <code>min.insync.replicas</code> configuration sets the minimum required number of in-sync replica acknowledgements.
The number of acknowledgements include that of the leader and followers.</p>
</div>
<div class="paragraph">
<p>A typical starting point is to use the following configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Producer configuration:</p>
<div class="ulist">
<ul>
<li>
<p><code>acks=all</code> (default)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Broker configuration for topic replication:</p>
<div class="ulist">
<ul>
<li>
<p><code>default.replication.factor=3</code> (default = <code>1</code>)</p>
</li>
<li>
<p><code>min.insync.replicas=2</code> (default = <code>1</code>)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you create a topic, you can override the default replication factor.
You can also override <code>min.insync.replicas</code> at the topic level in the topic configuration.</p>
</div>
<div class="paragraph">
<p>Strimzi uses this configuration in the example configuration files for multi-node deployment of Kafka.</p>
</div>
<div class="paragraph">
<p>The following table describes how this configuration operates depending on the availability of followers that replicate the leader replica.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 39. Follower availability</caption>
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 28.5715%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Number of followers available and in-sync</th>
<th class="tableblock halign-left valign-top">Acknowledgements</th>
<th class="tableblock halign-left valign-top">Producer can send messages?</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The leader waits for 2 follower acknowledgements</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The leader waits for 1 follower acknowledgement</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The leader raises an exception</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A topic replication factor of 3 creates one leader replica and two followers.
In this configuration, the producer can continue if a single follower is unavailable.
Some delay can occur whilst removing a failed broker from the in-sync replicas or a creating a new leader.
If the second follower is also unavailable, message delivery will not be successful.
Instead of acknowledging successful message delivery, the leader sends an error (<em>not enough replicas</em>) to the producer.
The producer raises an equivalent exception.
With <code>retries</code> configuration, the producer can resend the failed message request.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If the system fails, there is a risk of unsent data in the buffer being lost.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ordered_delivery"><a class="link" href="#ordered_delivery">24.4.3. Ordered delivery</a></h4>
<div class="paragraph">
<p>Idempotent producers avoid duplicates as messages are delivered exactly once.
IDs and sequence numbers are assigned to messages to ensure the order of delivery, even in the event of failure.
If you are using <code>acks=all</code> for data consistency, using idempotency makes sense for ordered delivery.
Idempotency is enabled for producers by default.
With idempotency enabled, you can set the number of concurrent in-flight requests to a maximum of 5 for message ordering to be preserved.</p>
</div>
<div class="listingblock">
<div class="title">Ordered delivery with idempotency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
enable.idempotence=true <b class="conum">(1)</b>
max.in.flight.requests.per.connection=5 <b class="conum">(2)</b>
acks=all <b class="conum">(3)</b>
retries=2147483647 <b class="conum">(4)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Set to <code>true</code> to enable the idempotent producer.</p>
</li>
<li>
<p>With idempotent delivery the number of in-flight requests may be greater than 1 while still providing the message ordering guarantee. The default is 5 in-flight requests.</p>
</li>
<li>
<p>Set <code>acks</code> to <code>all</code>.</p>
</li>
<li>
<p>Set the number of attempts to resend a failed message request.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you choose not to use <code>acks=all</code> and disable idempotency because of the performance cost,
set the number of in-flight (unacknowledged) requests to 1 to preserve ordering.
Otherwise, a situation is possible where <em>Message-A</em> fails only to succeed after <em>Message-B</em> was already written to the broker.</p>
</div>
<div class="listingblock">
<div class="title">Ordered delivery without idempotency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
enable.idempotence=false <b class="conum">(1)</b>
max.in.flight.requests.per.connection=1 <b class="conum">(2)</b>
retries=2147483647
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Set to <code>false</code> to disable the idempotent producer.</p>
</li>
<li>
<p>Set the number of in-flight requests to exactly <code>1</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="reliability_guarantees"><a class="link" href="#reliability_guarantees">24.4.4. Reliability guarantees</a></h4>
<div class="paragraph">
<p>Idempotence is useful for exactly once writes to a single partition.
Transactions, when used with idempotence, allow exactly once writes across multiple partitions.</p>
</div>
<div class="paragraph">
<p>Transactions guarantee that messages using the same transactional ID are produced once,
and either <em>all</em> are successfully written to the respective logs or <em>none</em> of them are.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
enable.idempotence=true
max.in.flight.requests.per.connection=5
acks=all
retries=2147483647
transactional.id=<em>UNIQUE-ID</em> <b class="conum">(1)</b>
transaction.timeout.ms=900000 <b class="conum">(2)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Specify a unique transactional ID.</p>
</li>
<li>
<p>Set the maximum allowed time for transactions in milliseconds before a timeout error is returned.
The default is <code>900000</code> or 15 minutes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The choice of <code>transactional.id</code> is important in order that the transactional guarantee is maintained.
Each transactional id should be used for a unique set of topic partitions.
For example, this can be achieved using an external mapping of topic partition names to transactional ids,
or by computing the transactional id from the topic partition names using a function that avoids collisions.</p>
</div>
</div>
<div class="sect3">
<h4 id="con-producer-config-properties-throughput-str"><a class="link" href="#con-producer-config-properties-throughput-str">24.4.5. Optimizing producers for throughput and latency</a></h4>
<div class="paragraph">
<p>Usually, the requirement of a system is to satisfy a particular throughput target for a proportion of messages within a given latency.
For example, targeting 500,000 messages per second with 95% of messages being acknowledged within 2 seconds.</p>
</div>
<div class="paragraph">
<p>It’s likely that the messaging semantics (message ordering and durability) of your producer are defined by the requirements for your application.
For instance, it’s possible that you don’t have the option of using <code>acks=0</code> or <code>acks=1</code> without breaking some important property or guarantee provided by your application.</p>
</div>
<div class="paragraph">
<p>Broker restarts have a significant impact on high percentile statistics.
For example, over a long period the 99th percentile latency is dominated by behavior around broker restarts.
This is worth considering when designing benchmarks or comparing performance numbers from benchmarking with performance numbers seen in production.</p>
</div>
<div class="paragraph">
<p>Depending on your objective, Kafka offers a number of configuration parameters and techniques for tuning producer performance for throughput and latency.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Message batching (<code>linger.ms</code> and <code>batch.size</code>)</dt>
<dd>
<p>Message batching delays sending messages in the hope that more messages destined for the same broker will be sent,
allowing them to be batched into a single produce request.
Batching is a compromise between higher latency in return for higher throughput.
Time-based batching is configured using <code>linger.ms</code>, and size-based batching is configured using <code>batch.size</code>.</p>
</dd>
<dt class="hdlist1">Compression (<code>compression.type</code>)</dt>
<dd>
<p>Message compression adds latency in the producer (CPU time spent compressing the messages),
but makes requests (and potentially disk writes) smaller, which can increase throughput.
Whether compression is worthwhile, and the best compression to use, will depend on the messages being sent.
Compression happens on the thread which calls <code>KafkaProducer.send()</code>,
so if the latency of this method matters for your application you should consider using more threads.</p>
</dd>
<dt class="hdlist1">Pipelining (<code>max.in.flight.requests.per.connection</code>)</dt>
<dd>
<p>Pipelining means sending more requests before the response to a previous request has been received.
In general more pipelining means better throughput, up to a threshold at which other effects,
such as worse batching, start to counteract the effect on throughput.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<div class="title">Lowering latency</div>
<p>When your application calls <code>KafkaProducer.send()</code> the messages are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Processed by any interceptors</p>
</li>
<li>
<p>Serialized</p>
</li>
<li>
<p>Assigned to a partition</p>
</li>
<li>
<p>Compressed</p>
</li>
<li>
<p>Added to a batch of messages in a per-partition queue</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At which point the <code>send()</code> method returns.
So the time <code>send()</code> is blocked is determined by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The time spent in the interceptors, serializers and partitioner</p>
</li>
<li>
<p>The compression algorithm used</p>
</li>
<li>
<p>The time spent waiting for a buffer to use for compression</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Batches will remain in the queue until one of the following occurs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The batch is full (according to <code>batch.size</code>)</p>
</li>
<li>
<p>The delay introduced by <code>linger.ms</code> has passed</p>
</li>
<li>
<p>The sender is about to send message batches for other partitions to the same broker, and it is possible to add this batch too</p>
</li>
<li>
<p>The producer is being flushed or closed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Look at the configuration for batching and buffering to mitigate the impact of <code>send()</code> blocking on latency.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
linger.ms=100 <b class="conum">(1)</b>
batch.size=16384 <b class="conum">(2)</b>
buffer.memory=33554432 <b class="conum">(3)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>linger</code> property adds a delay in milliseconds so that larger batches of messages are accumulated and sent in a request. The default is <code>0'.</code></p>
</li>
<li>
<p>If a maximum <code>batch.size</code> in bytes is used, a request is sent when the maximum is reached, or messages have been queued for longer than <code>linger.ms</code> (whichever comes sooner).
Adding the delay allows batches to accumulate messages up to the batch size.</p>
</li>
<li>
<p>The buffer size must be at least as big as the batch size, and be able to accommodate buffering, compression and in-flight requests.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Increasing throughput</div>
<p>Improve throughput of your message requests by adjusting the maximum time to wait before a message is delivered and completes a send request.</p>
</div>
<div class="paragraph">
<p>You can also direct messages to a specified partition by writing a custom partitioner to replace the default.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
delivery.timeout.ms=120000 <b class="conum">(1)</b>
partitioner.class=my-custom-partitioner <b class="conum">(2)</b>

# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The maximum time in milliseconds to wait for a complete send request. You can set the value to <code>MAX_LONG</code> to delegate to Kafka an indefinite number of retries.
The default is <code>120000</code> or 2 minutes.</p>
</li>
<li>
<p>Specify the class name of the custom partitioner.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-consumer-config-properties-str"><a class="link" href="#con-consumer-config-properties-str">24.5. Kafka consumer configuration tuning</a></h3>
<div class="paragraph _abstract">
<p>Use a basic consumer configuration with optional properties that are tailored to specific use cases.</p>
</div>
<div class="paragraph">
<p>When tuning your consumers your primary concern will be ensuring that they cope efficiently with the amount of data ingested.
As with the producer tuning, be prepared to make incremental changes until the consumers operate as expected.</p>
</div>
<div class="sect3">
<h4 id="basic_consumer_configuration"><a class="link" href="#basic_consumer_configuration">24.5.1. Basic consumer configuration</a></h4>
<div class="paragraph">
<p>Connection and deserializer properties are required for every consumer.
Generally, it is good practice to add a client id for tracking.</p>
</div>
<div class="paragraph">
<p>In a consumer configuration, irrespective of any subsequent configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The consumer fetches from a given offset and consumes the messages in order, unless the offset is changed to skip or re-read messages.</p>
</li>
<li>
<p>The broker does not know if the consumer processed the responses, even when committing offsets to Kafka, because the offsets might be sent to a different broker in the cluster.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Basic consumer configuration properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
bootstrap.servers=localhost:9092 <b class="conum">(1)</b>
key.deserializer=org.apache.kafka.common.serialization.StringDeserializer  <b class="conum">(2)</b>
value.deserializer=org.apache.kafka.common.serialization.StringDeserializer  <b class="conum">(3)</b>
client.id=my-client <b class="conum">(4)</b>
group.id=my-group-id <b class="conum">(5)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>(Required) Tells the consumer to connect to a Kafka cluster using a <em>host:port</em> bootstrap server address for a Kafka broker.
The consumer uses the address to discover and connect to all brokers in the cluster.
Use a comma-separated list to specify two or three addresses in case a server is down, but it is not necessary to provide a list of all the brokers in the cluster.
If you are using a loadbalancer service to expose the Kafka cluster, you only need the address for the service because the availability is handled by the loadbalancer.</p>
</li>
<li>
<p>(Required) Deserializer to transform the bytes fetched from the Kafka broker into message keys.</p>
</li>
<li>
<p>(Required) Deserializer to transform the bytes fetched from the Kafka broker into message values.</p>
</li>
<li>
<p>(Optional) The logical name for the client, which is used in logs and metrics to identify the source of a request. The id can also be used to throttle consumers based on processing time quotas.</p>
</li>
<li>
<p>(Conditional) A group id is <em>required</em> for a consumer to be able to join a consumer group.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="scaling_data_consumption_using_consumer_groups"><a class="link" href="#scaling_data_consumption_using_consumer_groups">24.5.2. Scaling data consumption using consumer groups</a></h4>
<div class="paragraph">
<p>Consumer groups share a typically large data stream generated by one or multiple producers from a given topic.
Consumers are grouped using a <code>group.id</code> property, allowing messages to be spread across the members.
One of the consumers in the group is elected leader and decides how the partitions are assigned to the consumers in the group.
Each partition can only be assigned to a single consumer.</p>
</div>
<div class="paragraph">
<p>If you do not already have as many consumers as partitions,
you can scale data consumption by adding more consumer instances with the same <code>group.id</code>.
Adding more consumers to a group than there are partitions will not help throughput,
but it does mean that there are consumers on standby should one stop functioning.
If you can meet throughput goals with fewer consumers, you save on resources.</p>
</div>
<div class="paragraph">
<p>Consumers within the same consumer group send offset commits and heartbeats to the same broker.
So the greater the number of consumers in the group, the higher the request load on the broker.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
group.id=my-group-id <b class="conum">(1)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Add a consumer to a consumer group using a group id.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="message_ordering_guarantees"><a class="link" href="#message_ordering_guarantees">24.5.3. Message ordering guarantees</a></h4>
<div class="paragraph">
<p>Kafka brokers receive fetch requests from consumers that ask the broker to send messages from a list of topics, partitions and offset positions.</p>
</div>
<div class="paragraph">
<p>A consumer observes messages in a single partition in the same order that they were committed to the broker,
which means that Kafka <strong>only</strong> provides ordering guarantees for messages in a single partition.
Conversely, if a consumer is consuming messages from multiple partitions, the order of messages in different partitions as observed by the consumer does not necessarily reflect the order in which they were sent.</p>
</div>
<div class="paragraph">
<p>If you want a strict ordering of messages from one topic, use one partition per consumer.</p>
</div>
</div>
<div class="sect3">
<h4 id="con-consumer-config-properties-throughput-str"><a class="link" href="#con-consumer-config-properties-throughput-str">24.5.4. Optimizing consumers for throughput and latency</a></h4>
<div class="paragraph">
<p>Control the number of messages returned when your client application calls <code>KafkaConsumer.poll()</code>.</p>
</div>
<div class="paragraph">
<p>Use the <code>fetch.max.wait.ms</code> and <code>fetch.min.bytes</code> properties to increase the minimum amount of data fetched by the consumer from the Kafka broker.
Time-based batching is configured using <code>fetch.max.wait.ms</code>, and size-based batching is configured using <code>fetch.min.bytes</code>.</p>
</div>
<div class="paragraph">
<p>If CPU utilization in the consumer or broker is high, it might be because there are too many requests from the consumer.
You can adjust <code>fetch.max.wait.ms</code> and <code>fetch.min.bytes</code> properties higher so that there are fewer requests and messages are delivered in bigger batches.
By adjusting higher, throughput is improved with some cost to latency.
You can also adjust higher if the amount of data being produced is low.</p>
</div>
<div class="paragraph">
<p>For example, if you set <code>fetch.max.wait.ms</code> to 500ms and <code>fetch.min.bytes</code> to 16384 bytes,
when Kafka receives a fetch request from the consumer it will respond when the first of either threshold is reached.</p>
</div>
<div class="paragraph">
<p>Conversely, you can adjust the <code>fetch.max.wait.ms</code> and <code>fetch.min.bytes</code> properties lower to improve end-to-end latency.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
fetch.max.wait.ms=500 <b class="conum">(1)</b>
fetch.min.bytes=16384 <b class="conum">(2)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The maximum time in milliseconds the broker will wait before completing fetch requests.
The default is <code>500</code> milliseconds.</p>
</li>
<li>
<p>If a minimum batch size in bytes is used, a request is sent when the minimum is reached, or messages have been queued for longer than <code>fetch.max.wait.ms</code> (whichever comes sooner).
Adding the delay allows batches to accumulate messages up to the batch size.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Lowering latency by increasing the fetch request size</div>
<p>Use the <code>fetch.max.bytes</code> and <code>max.partition.fetch.bytes</code> properties to increase the maximum amount of data fetched by the consumer from the Kafka broker.</p>
</div>
<div class="paragraph">
<p>The <code>fetch.max.bytes</code> property sets a maximum limit in bytes on the amount of data fetched from the broker at one time.</p>
</div>
<div class="paragraph">
<p>The <code>max.partition.fetch.bytes</code> sets a maximum limit in bytes on how much data is returned for each partition,
which must always be larger than the number of bytes set in the broker or topic configuration for <code>max.message.bytes</code>.</p>
</div>
<div class="paragraph">
<p>The maximum amount of memory a client can consume is calculated approximately as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"><em>NUMBER-OF-BROKERS</em> * fetch.max.bytes and <em>NUMBER-OF-PARTITIONS</em> * max.partition.fetch.bytes</code></pre>
</div>
</div>
<div class="paragraph">
<p>If memory usage can accommodate it, you can increase the values of these two properties.
By allowing more data in each request, latency is improved as there are fewer fetch requests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
fetch.max.bytes=52428800 <b class="conum">(1)</b>
max.partition.fetch.bytes=1048576 <b class="conum">(2)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The maximum amount of data in bytes returned for a fetch request.</p>
</li>
<li>
<p>The maximum amount of data in bytes returned for each partition.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="avoiding_data_loss_or_duplication_when_committing_offsets"><a class="link" href="#avoiding_data_loss_or_duplication_when_committing_offsets">24.5.5. Avoiding data loss or duplication when committing offsets</a></h4>
<div class="paragraph">
<p>The Kafka <em>auto-commit mechanism</em> allows a consumer to commit the offsets of messages automatically.
If enabled, the consumer will commit offsets received from polling the broker at 5000ms intervals.</p>
</div>
<div class="paragraph">
<p>The auto-commit mechanism is convenient, but it introduces a risk of data loss and duplication.
If a consumer has fetched and transformed a number of messages, but the system crashes with processed messages in the consumer buffer when performing an auto-commit, that data is lost.
If the system crashes after processing the messages, but before performing the auto-commit, the data is duplicated on another consumer instance after rebalancing.</p>
</div>
<div class="paragraph">
<p>Auto-committing can avoid data loss only when all messages are processed before the next poll to the broker,
or the consumer closes.</p>
</div>
<div class="paragraph">
<p>To minimize the likelihood of data loss or duplication, you can set <code>enable.auto.commit</code> to <code>false</code> and develop your client application to have more control over committing offsets.
Or you can use <code>auto.commit.interval.ms</code> to decrease the intervals between commits.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
enable.auto.commit=false <b class="conum">(1)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Auto commit is set to false to provide more control over committing offsets.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>By setting to <code>enable.auto.commit</code> to <code>false</code>, you can commit offsets after <strong>all</strong> processing has been performed and the message has been consumed.
For example, you can set up your application to call the Kafka <code>commitSync</code> and <code>commitAsync</code> commit APIs.</p>
</div>
<div class="paragraph">
<p>The <code>commitSync</code> API commits the offsets in a message batch returned from polling.
You call the API when you are finished processing all the messages in the batch.
If you use the <code>commitSync</code> API, the application will not poll for new messages until the last offset in the batch is committed.
If this negatively affects throughput, you can commit less frequently,
or you can use the <code>commitAsync</code> API.
The <code>commitAsync</code> API does not wait for the broker to respond to a commit request,
but risks creating more duplicates when rebalancing.
A common approach is to combine both commit APIs in an application, with the <code>commitSync</code> API used just before shutting the consumer down or rebalancing to make sure the final commit is successful.</p>
</div>
<div class="sect4">
<h5 id="controlling_transactional_messages"><a class="link" href="#controlling_transactional_messages">Controlling transactional messages</a></h5>
<div class="paragraph">
<p>Consider using transactional ids and enabling idempotence (<code>enable.idempotence=true</code>) on the producer side to guarantee exactly-once delivery.
On the consumer side, you can then use the <code>isolation.level</code> property to control how transactional messages are read by the consumer.</p>
</div>
<div class="paragraph">
<p>The <code>isolation.level</code> property has two valid values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>read_committed</code></p>
</li>
<li>
<p><code>read_uncommitted</code> (default)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Use <code>read_committed</code> to ensure that only transactional messages that have been committed are read by the consumer.
However, this will cause an increase in end-to-end latency, because the consumer will not be able to return a message until the brokers have written the transaction markers that record the result of the transaction (<em>committed</em> or <em>aborted</em>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
enable.auto.commit=false
isolation.level=read_committed <b class="conum">(1)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Set to <code>read_committed</code> so that only committed messages are read by the consumer.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="recovering_from_failure_to_avoid_data_loss"><a class="link" href="#recovering_from_failure_to_avoid_data_loss">24.5.6. Recovering from failure to avoid data loss</a></h4>
<div class="paragraph">
<p>Use the <code>session.timeout.ms</code> and <code>heartbeat.interval.ms</code> properties to configure the time taken to check and recover from consumer failure within a consumer group.</p>
</div>
<div class="paragraph">
<p>The <code>session.timeout.ms</code> property specifies the maximum amount of time in milliseconds a consumer within a consumer group can be out of contact with a broker before being considered inactive and a <em>rebalancing</em> is triggered between the active consumers in the group.
When the group rebalances, the partitions are reassigned to the members of the group.</p>
</div>
<div class="paragraph">
<p>The <code>heartbeat.interval.ms</code> property specifies the interval in milliseconds between <em>heartbeat</em> checks to the consumer group coordinator to indicate that the consumer is active and connected.
The heartbeat interval must be lower, usually by a third, than the session timeout interval.</p>
</div>
<div class="paragraph">
<p>If you set the <code>session.timeout.ms</code> property lower, failing consumers are detected earlier, and rebalancing can take place quicker.
However, take care not to set the timeout so low that the broker fails to receive a heartbeat in time and triggers an unnecessary rebalance.</p>
</div>
<div class="paragraph">
<p>Decreasing the heartbeat interval reduces the chance of accidental rebalancing, but more frequent heartbeats increases the overhead on broker resources.</p>
</div>
</div>
<div class="sect3">
<h4 id="managing_offset_policy"><a class="link" href="#managing_offset_policy">24.5.7. Managing offset policy</a></h4>
<div class="paragraph">
<p>Use the <code>auto.offset.reset</code> property to control how a consumer behaves when no offsets have been committed,
or a committed offset is no longer valid or deleted.</p>
</div>
<div class="paragraph">
<p>Suppose you deploy a consumer application for the first time, and it reads messages from an existing topic.
Because this is the first time the <code>group.id</code> is used, the <code>__consumer_offsets</code> topic does not contain any offset information for this application.
The new application can start processing all existing messages from the start of the log or only new messages.
The default reset value is <code>latest</code>, which starts at the end of the partition, and consequently means some messages are missed.
To avoid data loss, but increase the amount of processing, set <code>auto.offset.reset</code> to <code>earliest</code> to start at the beginning of the partition.</p>
</div>
<div class="paragraph">
<p>Also consider using the <code>earliest</code> option to avoid messages being lost when the offsets retention period (<code>offsets.retention.minutes</code>) configured for a broker has ended.
If a consumer group or standalone consumer is inactive and commits no offsets during the retention period, previously committed offsets are deleted from <code>__consumer_offsets</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env"># ...
heartbeat.interval.ms=3000 <b class="conum">(1)</b>
session.timeout.ms=45000 <b class="conum">(2)</b>
auto.offset.reset=earliest <b class="conum">(3)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Adjust the heartbeat interval lower according to anticipated rebalances.</p>
</li>
<li>
<p>If no heartbeats are received by the Kafka broker before the timeout duration expires, the consumer is removed from the consumer group and a rebalance is initiated.
If the broker configuration has a <code>group.min.session.timeout.ms</code> and <code>group.max.session.timeout.ms</code>, the session timeout value must be within that range.</p>
</li>
<li>
<p>Set to <code>earliest</code> to return to the start of a partition and avoid data loss if offsets were not committed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If the amount of data returned in a single fetch request is large,
a timeout might occur before the consumer has processed it.
In this case, you can lower <code>max.partition.fetch.bytes</code> or increase <code>session.timeout.ms</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="minimizing_the_impact_of_rebalances"><a class="link" href="#minimizing_the_impact_of_rebalances">24.5.8. Minimizing the impact of rebalances</a></h4>
<div class="paragraph">
<p>The rebalancing of a partition between active consumers in a group is the time it takes for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Consumers to commit their offsets</p>
</li>
<li>
<p>The new consumer group to be formed</p>
</li>
<li>
<p>The group leader to assign partitions to group members</p>
</li>
<li>
<p>The consumers in the group to receive their assignments and start fetching</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Clearly, the process increases the downtime of a service, particularly when it happens repeatedly during a rolling restart of a consumer group cluster.</p>
</div>
<div class="paragraph">
<p>In this situation, you can use the concept of <em>static membership</em> to reduce the number of rebalances.
Rebalancing assigns topic partitions evenly among consumer group members.
Static membership uses persistence so that a consumer instance is recognized during a restart after a session timeout.</p>
</div>
<div class="paragraph">
<p>The consumer group coordinator can identify a new consumer instance using a unique id that is specified using the <code>group.instance.id</code> property.
During a restart, the consumer is assigned a new member id, but as a static member it continues with the same instance id,
and the same assignment of topic partitions is made.</p>
</div>
<div class="paragraph">
<p>If the consumer application does not make a call to poll at least every <code>max.poll.interval.ms</code> milliseconds, the consumer is considered to be failed, causing a rebalance.
If the application cannot process all the records returned from poll in time, you can avoid a rebalance by using the <code>max.poll.interval.ms</code> property to specify the interval in milliseconds between polls for new messages from a consumer.
Or you can use the <code>max.poll.records</code> property to set a maximum limit on the number of records returned from the consumer buffer, allowing your application to process fewer records within the <code>max.poll.interval.ms</code> limit.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># ...
group.instance.id=<em>UNIQUE-ID</em> <b class="conum">(1)</b>
max.poll.interval.ms=300000 <b class="conum">(2)</b>
max.poll.records=500 <b class="conum">(3)</b>
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The unique instance id ensures that a new consumer instance receives the same assignment of topic partitions.</p>
</li>
<li>
<p>Set the interval to check the consumer is continuing to process messages.</p>
</li>
<li>
<p>Sets the number of processed records returned from the consumer.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-high-volume-config-properties-str"><a class="link" href="#con-high-volume-config-properties-str">24.6. Handling high volumes of messages</a></h3>
<div class="paragraph _abstract">
<p>If your Strimzi deployment needs to handle a high volume of messages, you can use configuration options to optimize for throughput and latency.</p>
</div>
<div class="paragraph">
<p>Producer and consumer configuration can help control the size and frequency of requests to Kafka brokers.
For more information on the configuration options, see the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://kafka.apache.org/documentation/#producerconfigs" target="_blank" rel="noopener">Apache Kafka configuration documentation for producers</a></p>
</li>
<li>
<p><a href="https://kafka.apache.org/documentation/#consumerconfigs" target="_blank" rel="noopener">Apache Kafka configuration documentation for consumers</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can also use the same configuration options with the producers and consumers used by the Kafka Connect runtime source connectors (including MirrorMaker 2) and sink connectors.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Source connectors</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Producers from the Kafka Connect runtime send messages to the Kafka cluster.</p>
</li>
<li>
<p>For MirrorMaker 2, since the source system is Kafka, consumers retrieve messages from a source Kafka cluster.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Sink connectors</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Consumers from the Kafka Connect runtime retrieve messages from the Kafka cluster.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For consumers, you might increase the amount of data fetched in a single fetch request to reduce latency.
You increase the fetch request size using the <code>fetch.max.bytes</code> and <code>max.partition.fetch.bytes</code> properties.
You can also set a maximum limit on the number of messages returned from the consumer buffer using the <code>max.poll.records</code> property.</p>
</div>
<div class="paragraph">
<p>For MirrorMaker 2, configure the <code>fetch.max.bytes</code>, <code>max.partition.fetch.bytes</code>, and <code>max.poll.records</code> values at the source connector level (<code>consumer.*</code>), as they relate to the specific consumer that fetches messages from the source.</p>
</div>
<div class="paragraph">
<p>For producers, you might increase the size of the message batches sent in a single produce request.
You increase the batch size using the <code>batch.size</code> property.
A larger batch size reduces the number of outstanding messages ready to be sent and the size of the backlog in the message queue.
Messages being sent to the same partition are batched together.
A produce request is sent to the target cluster when the batch size is reached.
By increasing the batch size, produce requests are delayed and more messages are added to the batch and sent to brokers at the same time.
This can improve throughput when you have just a few topic partitions that handle large numbers of messages.</p>
</div>
<div class="paragraph">
<p>Consider the number and size of the records that the producer handles for a suitable producer batch size.</p>
</div>
<div class="paragraph">
<p>Use <code>linger.ms</code> to add a wait time in milliseconds to delay produce requests when producer load decreases.
The delay means that more records can be added to batches if they are under the maximum batch size.</p>
</div>
<div class="paragraph">
<p>Configure the <code>batch.size</code> and <code>linger.ms</code> values at the source connector level (<code>producer.override.*</code>), as they relate to the specific producer that sends messages to the target Kafka cluster.</p>
</div>
<div class="paragraph">
<p>For Kafka Connect source connectors, the data streaming pipeline to the target Kafka cluster is as follows:</p>
</div>
<div class="paragraph">
<div class="title">Data streaming pipeline for Kafka Connect source connector</div>
<p><strong>external data source &#8594; (Kafka Connect tasks) source message queue &#8594; producer buffer &#8594; target Kafka topic</strong></p>
</div>
<div class="paragraph">
<p>For Kafka Connect sink connectors, the data streaming pipeline to the target external data source is as follows:</p>
</div>
<div class="paragraph">
<div class="title">Data streaming pipeline for Kafka Connect sink connector</div>
<p><strong>source Kafka topic &#8594; (Kafka Connect tasks) sink message queue &#8594; consumer buffer &#8594; external data source</strong></p>
</div>
<div class="paragraph">
<p>For MirrorMaker 2, the data mirroring pipeline to the target Kafka cluster is as follows:</p>
</div>
<div class="paragraph">
<div class="title">Data mirroring pipeline for MirrorMaker 2</div>
<p><strong>source Kafka topic &#8594; (Kafka Connect tasks) source message queue &#8594; producer buffer &#8594; target Kafka topic</strong></p>
</div>
<div class="paragraph">
<p>The producer sends messages in its buffer to topics in the target Kafka cluster.
While this is happening, Kafka Connect tasks continue to poll the data source to add messages to the source message queue.</p>
</div>
<div class="paragraph">
<p>The size of the producer buffer for the source connector is set using the <code>producer.override.buffer.memory</code> property.
Tasks wait for a specified timeout period (<code>offset.flush.timeout.ms</code>) before the buffer is flushed.
This should be enough time for the sent messages to be acknowledged by the brokers and offset data committed.
The source task does not wait for the producer to empty the message queue before committing offsets, except during shutdown.</p>
</div>
<div class="paragraph">
<p>If the producer is unable to keep up with the throughput of messages in the source message queue, buffering is blocked until there is space available in the buffer within a time period bounded by <code>max.block.ms</code>.
Any unacknowledged messages still in the buffer are sent during this period.
New messages are not added to the buffer until these messages are acknowledged and flushed.</p>
</div>
<div class="paragraph">
<p>You can try the following configuration changes to keep the underlying source message queue of outstanding messages at a manageable size:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Increasing the default value in milliseconds of the <code>offset.flush.timeout.ms</code></p>
</li>
<li>
<p>Ensuring that there are enough CPU and memory resources</p>
</li>
<li>
<p>Increasing the number of tasks that run in parallel by doing the following:</p>
<div class="ulist">
<ul>
<li>
<p>Increasing the number of tasks that run in parallel using the <code>tasksMax</code> property</p>
</li>
<li>
<p>Increasing the number of worker nodes that run tasks using the <code>replicas</code> property</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Consider the number of tasks that can run in parallel according to the available CPU and memory resources and number of worker nodes.
You might need to keep adjusting the configuration values until they have the desired effect.</p>
</div>
<div class="sect3">
<h4 id="configuring_kafka_connect_for_high_volume_messages"><a class="link" href="#configuring_kafka_connect_for_high_volume_messages">24.6.1. Configuring Kafka Connect for high-volume messages</a></h4>
<div class="paragraph">
<p>Kafka Connect fetches data from the source external data system and hands it to the Kafka Connect runtime producers so that it&#8217;s replicated to the target cluster.</p>
</div>
<div class="paragraph">
<p>The following example shows configuration for Kafka Connect using the <code>KafkaConnect</code> custom resource.</p>
</div>
<div class="listingblock">
<div class="title">Example Kafka Connect configuration for handling high volumes of messages</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect-cluster
  annotations:
    strimzi.io/use-connector-resources: "true"
spec:
  replicas: 3
  config:
    offset.flush.timeout.ms: 10000
    # ...
  resources:
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "2"
      memory: 2Gi
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Producer configuration is added for the source connector, which is managed using the <code>KafkaConnector</code> custom resource.</p>
</div>
<div class="listingblock">
<div class="title">Example source connector configuration for handling high volumes of messages</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: my-source-connector
  labels:
    strimzi.io/cluster: my-connect-cluster
spec:
  class: org.apache.kafka.connect.file.FileStreamSourceConnector
  tasksMax: 2
  config:
    producer.override.batch.size: 327680
    producer.override.linger.ms: 100
    # ...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>FileStreamSourceConnector</code> and <code>FileStreamSinkConnector</code> are provided as example connectors.
For information on deploying them as <code>KafkaConnector</code> resources, see <a href="#proc-deploying-kafkaconnector-str">Deploying KafkaConnector resources</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Consumer configuration is added for the sink connector.</p>
</div>
<div class="listingblock">
<div class="title">Example sink connector configuration for handling high volumes of messages</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: my-sink-connector
  labels:
    strimzi.io/cluster: my-connect-cluster
spec:
  class: org.apache.kafka.connect.file.FileStreamSinkConnector
  tasksMax: 2
  config:
    consumer.fetch.max.bytes: 52428800
    consumer.max.partition.fetch.bytes: 1048576
    consumer.max.poll.records: 500
    # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are using the Kafka Connect API instead of the <code>KafkaConnector</code> custom resource to manage your connectors, you can add the connector configuration as a JSON object.</p>
</div>
<div class="listingblock">
<div class="title">Example curl request to add source connector configuration for handling high volumes of messages</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-curl hljs" data-lang="curl">curl -X POST \
  http://my-connect-cluster-connect-api:8083/connectors \
  -H 'Content-Type: application/json' \
  -d '{ "name": "my-source-connector",
    "config":
    {
      "connector.class":"org.apache.kafka.connect.file.FileStreamSourceConnector",
      "file": "/opt/kafka/LICENSE",
      "topic":"my-topic",
      "tasksMax": "4",
      "type": "source"
      "producer.override.batch.size": 327680
      "producer.override.linger.ms": 100
    }
}'</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuring_mirrormaker_2_for_high_volume_messages"><a class="link" href="#configuring_mirrormaker_2_for_high_volume_messages">24.6.2. Configuring MirrorMaker 2 for high-volume messages</a></h4>
<div class="paragraph">
<p>MirrorMaker 2 fetches data from the source cluster and hands it to the Kafka Connect runtime producers so that it&#8217;s replicated to the target cluster.</p>
</div>
<div class="paragraph">
<p>The following example shows the configuration for MirrorMaker 2 using the <code>KafkaMirrorMaker2</code> custom resource.</p>
</div>
<div class="listingblock">
<div class="title">Example MirrorMaker 2 configuration for handling high volumes of messages</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker2
metadata:
  name: my-mirror-maker2
spec:
  version: 3.6.1
  replicas: 1
  connectCluster: "my-cluster-target"
  clusters:
  - alias: "my-cluster-source"
    bootstrapServers: my-cluster-source-kafka-bootstrap:9092
  - alias: "my-cluster-target"
    config:
      offset.flush.timeout.ms: 10000
    bootstrapServers: my-cluster-target-kafka-bootstrap:9092
  mirrors:
  - sourceCluster: "my-cluster-source"
    targetCluster: "my-cluster-target"
    sourceConnector:
      tasksMax: 2
      config:
        producer.override.batch.size: 327680
        producer.override.linger.ms: 100
        consumer.fetch.max.bytes: 52428800
        consumer.max.partition.fetch.bytes: 1048576
        consumer.max.poll.records: 500
    # ...
  resources:
    requests:
      cpu: "1"
      memory: Gi
    limits:
      cpu: "2"
      memory: 4Gi</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="checking_the_mirrormaker_2_message_flow"><a class="link" href="#checking_the_mirrormaker_2_message_flow">24.6.3. Checking the MirrorMaker 2 message flow</a></h4>
<div class="paragraph">
<p>If you are using Prometheus and Grafana to monitor your deployment, you can check the MirrorMaker 2 message flow.</p>
</div>
<div class="paragraph">
<p>The example MirrorMaker 2 Grafana dashboards provided with Strimzi show the following metrics related to the flush pipeline.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The number of messages in Kafka Connect&#8217;s outstanding messages queue</p>
</li>
<li>
<p>The available bytes of the producer buffer</p>
</li>
<li>
<p>The offset commit timeout in milliseconds</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use these metrics to gauge whether or not you need to tune your configuration based on the volume of messages.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#assembly-metrics-str">Introducing metrics</a></p>
</li>
<li>
<p><a href="#using-kafka-connect-with-plug-ins-str">Adding Kafka Connect connectors</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="management-tasks-str"><a class="link" href="#management-tasks-str">25. Managing Strimzi</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Managing Strimzi requires performing various tasks to keep the Kafka clusters and associated resources running smoothly.
Use <code>kubectl</code> commands to check the status of resources, configure maintenance windows for rolling updates, and leverage tools such as the Strimzi Drain Cleaner and Kafka Static Quota plugin to manage your deployment effectively.</p>
</div>
<div class="sect2">
<h3 id="working-with-resources-str"><a class="link" href="#working-with-resources-str">25.1. Working with custom resources</a></h3>
<div class="paragraph">
<p>You can use <code>kubectl</code> commands to retrieve information and perform other operations on Strimzi custom resources.</p>
</div>
<div class="paragraph">
<p>Using <code>kubectl</code> with the <code>status</code> subresource of a custom resource allows you to get the information about the resource.</p>
</div>
<div class="sect3">
<h4 id="con-custom-resources-info-str"><a class="link" href="#con-custom-resources-info-str">25.1.1. Performing <code>kubectl</code> operations on custom resources</a></h4>
<div class="paragraph">
<p>Use <code>kubectl</code> commands, such as <code>get</code>, <code>describe</code>, <code>edit</code>, or <code>delete</code>, to perform operations on resource types.
For example, <code>kubectl get kafkatopics</code> retrieves a list of all Kafka topics and <code>kubectl get kafkas</code> retrieves all deployed Kafka clusters.</p>
</div>
<div class="paragraph">
<p>When referencing resource types, you can use both singular and plural names:
<code>kubectl get kafkas</code> gets the same results as <code>kubectl get kafka</code>.</p>
</div>
<div class="paragraph">
<p>You can also use the <em>short name</em> of the resource.
Learning short names can save you time when managing Strimzi.
The short name for <code>Kafka</code> is <code>k</code>, so you can also run <code>kubectl get k</code> to list all Kafka clusters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get k

NAME         DESIRED KAFKA REPLICAS   DESIRED ZK REPLICAS
my-cluster   3                        3</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 40. Long and short names for each Strimzi resource</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Strimzi resource</th>
<th class="tableblock halign-left valign-top">Long name</th>
<th class="tableblock halign-left valign-top">Short name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafka</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">k</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Node Pool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafkanodepool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">knp</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Topic</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafkatopic</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kt</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka User</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafkauser</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ku</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Connect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafkaconnect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kc</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Connector</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafkaconnector</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kctr</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Mirror Maker</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafkamirrormaker</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kmm</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Mirror Maker 2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafkamirrormaker2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kmm2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Bridge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafkabridge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kb</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Rebalance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafkarebalance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kr</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="resource_categories"><a class="link" href="#resource_categories">Resource categories</a></h5>
<div class="paragraph">
<p>Categories of custom resources can also be used in <code>kubectl</code> commands.</p>
</div>
<div class="paragraph">
<p>All Strimzi custom resources belong to the category <code>strimzi</code>, so you can use <code>strimzi</code> to get all the Strimzi resources with one command.</p>
</div>
<div class="paragraph">
<p>For example, running <code>kubectl get strimzi</code> lists all Strimzi custom resources in a given namespace.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get strimzi

NAME                                   DESIRED KAFKA REPLICAS DESIRED ZK REPLICAS
kafka.kafka.strimzi.io/my-cluster      3                      3

NAME                                   PARTITIONS REPLICATION FACTOR
kafkatopic.kafka.strimzi.io/kafka-apps 3          3

NAME                                   AUTHENTICATION AUTHORIZATION
kafkauser.kafka.strimzi.io/my-user     tls            simple</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>kubectl get strimzi -o name</code> command returns all resource types and resource names.
The <code>-o name</code> option fetches the output in the <em>type/name</em> format</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get strimzi -o name

kafka.kafka.strimzi.io/my-cluster
kafkatopic.kafka.strimzi.io/kafka-apps
kafkauser.kafka.strimzi.io/my-user</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can combine this <code>strimzi</code> command with other commands.
For example, you can pass it into a <code>kubectl delete</code> command to delete all resources in a single command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl delete $(kubectl get strimzi -o name)

kafka.kafka.strimzi.io "my-cluster" deleted
kafkatopic.kafka.strimzi.io "kafka-apps" deleted
kafkauser.kafka.strimzi.io "my-user" deleted</code></pre>
</div>
</div>
<div class="paragraph">
<p>Deleting all resources in a single operation might be useful, for example,
when you are testing new Strimzi features.</p>
</div>
</div>
<div class="sect4">
<h5 id="querying_the_status_of_sub_resources"><a class="link" href="#querying_the_status_of_sub_resources">Querying the status of sub-resources</a></h5>
<div class="paragraph">
<p>There are other values you can pass to the <code>-o</code> option.
For example, by using <code>-o yaml</code> you get the output in YAML format.
Using <code>-o json</code> will return it as JSON.</p>
</div>
<div class="paragraph">
<p>You can see all the options in <code>kubectl get --help</code>.</p>
</div>
<div class="paragraph">
<p>One of the most useful options is the <a href="https://kubernetes.io/docs/reference/kubectl/jsonpath/" target="_blank" rel="noopener">JSONPath support</a>, which allows you to pass JSONPath expressions to query the Kubernetes API.
A JSONPath expression can extract or navigate specific parts of any resource.</p>
</div>
<div class="paragraph">
<p>For example, you can use the JSONPath expression <code>{.status.listeners[?(@.name=="tls")].bootstrapServers}</code>
to get the bootstrap address from the status of the Kafka custom resource and use it in your Kafka clients.</p>
</div>
<div class="paragraph">
<p>Here, the command finds the <code>bootstrapServers</code> value of the listener named <code>tls</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafka my-cluster -o=jsonpath='{.status.listeners[?(@.name=="tls")].bootstrapServers}{"\n"}'

my-cluster-kafka-bootstrap.myproject.svc:9093</code></pre>
</div>
</div>
<div class="paragraph">
<p>By changing the name condition you can also get the address of the other Kafka listeners.</p>
</div>
<div class="paragraph">
<p>You can use <code>jsonpath</code> to extract any other property or group of properties from any custom resource.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="con-custom-resources-status-str"><a class="link" href="#con-custom-resources-status-str">25.1.2. Strimzi custom resource status information</a></h4>
<div class="paragraph _abstract">
<p>Status properties provide status information for certain custom resources.</p>
</div>
<div class="paragraph">
<p>The following table lists the custom resources that provide status information (when deployed) and the schemas that define the status properties.</p>
</div>
<div class="paragraph">
<p>For more information on the schemas, see the <a href="./configuring.html" target="_blank" rel="noopener">Strimzi Custom Resource API Reference</a>.</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 41. Custom resources that provide status information</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Strimzi resource</th>
<th class="tableblock halign-left valign-top">Schema reference</th>
<th class="tableblock halign-left valign-top">Publishes status information on&#8230;&#8203;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Kafka</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaStatus</code> schema reference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Kafka cluster</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaTopic</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaTopicStatus</code> schema reference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka topics in the Kafka cluster</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaUser</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaUserStatus</code> schema reference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka users in the Kafka cluster</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaConnect</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaConnectStatus</code> schema reference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Kafka Connect cluster</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaConnector</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaConnectorStatus</code> schema reference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaConnector</code> resources</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaMirrorMaker2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaMirrorMaker2Status</code> schema reference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Kafka MirrorMaker 2 cluster</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaMirrorMaker</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaMirrorMakerStatus</code> schema reference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Kafka MirrorMaker cluster</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaBridge</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaBridgeStatus</code> schema reference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Strimzi Kafka Bridge</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaRebalance</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaRebalance</code> schema reference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The status and results of a rebalance</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>status</code> property of a resource provides information on the state of the resource.
The <code>status.conditions</code> and <code>status.observedGeneration</code> properties are common to all resources.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>status.conditions</code></dt>
<dd>
<p>Status conditions describe the <em>current state</em> of a resource. Status condition properties are useful for tracking progress related to the resource achieving its <em>desired state</em>, as defined by the configuration specified in its <code>spec</code>. Status condition properties provide the time and reason the state of the resource changed, and details of events preventing or delaying the operator from realizing the desired state.</p>
</dd>
<dt class="hdlist1"><code>status.observedGeneration</code></dt>
<dd>
<p>Last observed generation denotes the latest reconciliation of the resource by the Cluster Operator. If the value of <code>observedGeneration</code> is different from the value of <code>metadata.generation</code> (the current version of the deployment), the operator has not yet processed the latest update to the resource. If these values are the same, the status information reflects the most recent changes to the resource.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The <code>status</code> properties also provide resource-specific information.
For example, <code>KafkaStatus</code> provides information on listener addresses, and the ID of the Kafka cluster.</p>
</div>
<div class="paragraph">
<p><code>KafkaStatus</code> also provides information on the Kafka and Strimzi versions being used.
You can check the values of <code>operatorLastSuccessfulVersion</code> and <code>kafkaVersion</code> to determine whether an upgrade of Strimzi or Kafka has completed</p>
</div>
<div class="paragraph">
<p>Strimzi creates and maintains the status of custom resources, periodically evaluating the current state of the custom resource and updating its status accordingly.
When performing an update on a custom resource using <code>kubectl edit</code>, for example, its <code>status</code> is not editable. Moreover, changing the <code>status</code> would not affect the configuration of the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>Here we see the <code>status</code> properties for a <code>Kafka</code> custom resource.</p>
</div>
<div class="listingblock">
<div class="title">Kafka custom resource status</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
spec:
  # ...
status:
  clusterId: XP9FP2P-RByvEy0W4cOEUA # <b class="conum">(1)</b>
  conditions: # <b class="conum">(2)</b>
    - lastTransitionTime: '2023-01-20T17:56:29.396588Z'
      status: 'True'
      type: Ready # <b class="conum">(3)</b>
  kafkaVersion: 3.6.1 # <b class="conum">(4)</b>
  listeners: # <b class="conum">(5)</b>
    - addresses:
        - host: my-cluster-kafka-bootstrap.prm-project.svc
          port: 9092
      bootstrapServers: 'my-cluster-kafka-bootstrap.prm-project.svc:9092'
      name: plain
    - addresses:
        - host: my-cluster-kafka-bootstrap.prm-project.svc
          port: 9093
      bootstrapServers: 'my-cluster-kafka-bootstrap.prm-project.svc:9093'
      certificates:
        - |
          -----BEGIN CERTIFICATE-----

          -----END CERTIFICATE-----
      name: tls
    - addresses:
        - host: &gt;-
            2054284155.us-east-2.elb.amazonaws.com
          port: 9095
      bootstrapServers: &gt;-
        2054284155.us-east-2.elb.amazonaws.com:9095
      certificates:
        - |
          -----BEGIN CERTIFICATE-----

          -----END CERTIFICATE-----
      name: external3
    - addresses:
        - host: ip-10-0-172-202.us-east-2.compute.internal
          port: 31644
      bootstrapServers: 'ip-10-0-172-202.us-east-2.compute.internal:31644'
      certificates:
        - |
          -----BEGIN CERTIFICATE-----

          -----END CERTIFICATE-----
      name: external4
  observedGeneration: 3 # <b class="conum">(6)</b>
  operatorLastSuccessfulVersion: 0.39.0 # <b class="conum">(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Kafka cluster ID.</p>
</li>
<li>
<p>Status <code>conditions</code> describe the current state of the Kafka cluster.</p>
</li>
<li>
<p>The <code>Ready</code> condition indicates that the Cluster Operator considers the Kafka cluster able to handle traffic.</p>
</li>
<li>
<p>The version of Kafka being used by the Kafka cluster.</p>
</li>
<li>
<p>The <code>listeners</code> describe Kafka bootstrap addresses by type.</p>
</li>
<li>
<p>The <code>observedGeneration</code> value indicates the last reconciliation of the <code>Kafka</code> custom resource by the Cluster Operator.</p>
</li>
<li>
<p>The version of the operator that successfully completed the last reconciliation.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The Kafka bootstrap addresses listed in the status do not signify that those endpoints or the Kafka cluster is in a <code>Ready</code> state.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Accessing status information</div>
<p>You can access status information for a resource from the command line. For more information, see <a href="#proc-accessing-resource-status-str">Finding the status of a custom resource</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="proc-accessing-resource-status-str"><a class="link" href="#proc-accessing-resource-status-str">25.1.3. Finding the status of a custom resource</a></h4>
<div class="paragraph">
<p>This procedure describes how to find the status of a custom resource.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kubernetes cluster.</p>
</li>
<li>
<p>The Cluster Operator is running.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Specify the custom resource and use the <code>-o jsonpath</code> option to apply a standard JSONPath expression to select the <code>status</code> property:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafka <em>&lt;kafka_resource_name&gt;</em> -o jsonpath='{.status}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This expression returns all the status information for the specified custom resource. You can use dot notation, such as <code>status.listeners</code> or <code>status.observedGeneration</code>, to fine-tune the status information you wish to see.</p>
</div>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#con-custom-resources-status-str">Strimzi custom resource status information</a></p>
</li>
<li>
<p>For more information about using JSONPath, see <a href="https://kubernetes.io/docs/reference/kubectl/jsonpath/" target="_blank" rel="noopener">JSONPath support</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="proc-add-service-discovery-str"><a class="link" href="#proc-add-service-discovery-str">25.2. Discovering services using labels and annotations</a></h3>
<div class="paragraph">
<p>Service discovery makes it easier for client applications running in the same Kubernetes cluster as Strimzi to interact with a Kafka cluster.</p>
</div>
<div class="paragraph">
<p>A <em>service discovery</em> label and annotation is generated for services used to access the Kafka cluster:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Internal Kafka bootstrap service</p>
</li>
<li>
<p>HTTP Bridge service</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The label helps to make the service discoverable, and the annotation provides connection details that a client application can use to make the connection.</p>
</div>
<div class="paragraph">
<p>The service discovery label, <code>strimzi.io/discovery</code>, is set as <code>true</code> for the <code>Service</code> resources.
The service discovery annotation has the same key, providing connection details in JSON format for each service.</p>
</div>
<h4 id="example_internal_kafka_bootstrap_service" class="discrete">Example internal Kafka bootstrap service</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Service
metadata:
  annotations:
    strimzi.io/discovery: |-
      [ {
        "port" : 9092,
        "tls" : false,
        "protocol" : "kafka",
        "auth" : "scram-sha-512"
      }, {
        "port" : 9093,
        "tls" : true,
        "protocol" : "kafka",
        "auth" : "tls"
      } ]
  labels:
    strimzi.io/cluster: my-cluster
    strimzi.io/discovery: "true"
    strimzi.io/kind: Kafka
    strimzi.io/name: my-cluster-kafka-bootstrap
  name: my-cluster-kafka-bootstrap
spec:
  #...</code></pre>
</div>
</div>
<h4 id="example_http_bridge_service" class="discrete">Example HTTP Bridge service</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Service
metadata:
  annotations:
    strimzi.io/discovery: |-
      [ {
        "port" : 8080,
        "tls" : false,
        "auth" : "none",
        "protocol" : "http"
      } ]
  labels:
    strimzi.io/cluster: my-bridge
    strimzi.io/discovery: "true"
    strimzi.io/kind: KafkaBridge
    strimzi.io/name: my-bridge-bridge-service</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="returning_connection_details_on_services"><a class="link" href="#returning_connection_details_on_services">25.2.1. Returning connection details on services</a></h4>
<div class="paragraph">
<p>You can find the services by specifying the discovery label when fetching services from the command line or a corresponding API call.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kubectl get service -l strimzi.io/discovery=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The connection details are returned when retrieving the service discovery label.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="proc-connnecting-to-zookeeper-str"><a class="link" href="#proc-connnecting-to-zookeeper-str">25.3. Connecting to ZooKeeper from a terminal</a></h3>
<div class="paragraph">
<p>ZooKeeper services are secured with encryption and authentication and are not intended to be used by external applications that are not part of Strimzi.</p>
</div>
<div class="paragraph">
<p>However, if you want to use CLI tools that require a connection to ZooKeeper, you can use a terminal inside a ZooKeeper pod and connect to <code>localhost:12181</code> as the ZooKeeper address.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kubernetes cluster is available.</p>
</li>
<li>
<p>A Kafka cluster is running.</p>
</li>
<li>
<p>The Cluster Operator is running.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open the terminal using the Kubernetes console or run the <code>exec</code> command from your CLI.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl exec -ti <em>my-cluster</em>-zookeeper-0 -- bin/zookeeper-shell.sh localhost:12181 ls /</code></pre>
</div>
</div>
<div class="paragraph">
<p>Be sure to use <code>localhost:12181</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="proc-pausing-reconciliation-str"><a class="link" href="#proc-pausing-reconciliation-str">25.4. Pausing reconciliation of custom resources</a></h3>
<div class="paragraph">
<p>Sometimes it is useful to pause the reconciliation of custom resources managed by Strimzi Operators,
so that you can perform fixes or make updates.
If reconciliations are paused, any changes made to custom resources are ignored by the Operators until the pause ends.</p>
</div>
<div class="paragraph">
<p>If you want to pause reconciliation of a custom resource, set the <code>strimzi.io/pause-reconciliation</code> annotation to <code>true</code> in its configuration.
This instructs the appropriate Operator to pause reconciliation of the custom resource.
For example, you can apply the annotation to the <code>KafkaConnect</code> resource so that reconciliation by the Cluster Operator is paused.</p>
</div>
<div class="paragraph">
<p>You can also create a custom resource with the pause annotation enabled.
The custom resource is created, but it is ignored.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Strimzi Operator that manages the custom resource is running.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Annotate the custom resource in Kubernetes, setting <code>pause-reconciliation</code> to <code>true</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate <em>&lt;kind_of_custom_resource&gt;</em> <em>&lt;name_of_custom_resource&gt;</em> strimzi.io/pause-reconciliation="true"</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, for the <code>KafkaConnect</code> custom resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate KafkaConnect my-connect strimzi.io/pause-reconciliation="true"</code></pre>
</div>
</div>
</li>
<li>
<p>Check that the status conditions of the custom resource show a change to <code>ReconciliationPaused</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl describe <em>&lt;kind_of_custom_resource&gt;</em> <em>&lt;name_of_custom_resource&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>type</code> condition changes to <code>ReconciliationPaused</code> at the <code>lastTransitionTime</code>.</p>
</div>
<div class="listingblock">
<div class="title">Example custom resource with a paused reconciliation condition type</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  annotations:
    strimzi.io/pause-reconciliation: "true"
    strimzi.io/use-connector-resources: "true"
  creationTimestamp: 2021-03-12T10:47:11Z
  #...
spec:
  # ...
status:
  conditions:
  - lastTransitionTime: 2021-03-12T10:47:41.689249Z
    status: "True"
    type: ReconciliationPaused</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Resuming from pause</div>
<ul>
<li>
<p>To resume reconciliation, you can set the annotation to <code>false</code>, or remove the annotation.</p>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#con-custom-resources-status-str">Finding the status of a custom resource</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="assembly-maintenance-time-windows-str"><a class="link" href="#assembly-maintenance-time-windows-str">25.5. Maintenance time windows for rolling updates</a></h3>
<div class="paragraph">
<p>Maintenance time windows allow you to schedule certain rolling updates of your Kafka and ZooKeeper clusters to start at a convenient time.</p>
</div>
<div class="sect3">
<h4 id="con-maintenance-time-windows-overview-str"><a class="link" href="#con-maintenance-time-windows-overview-str">25.5.1. Maintenance time windows overview</a></h4>
<div class="paragraph">
<p>In most cases, the Cluster Operator only updates your Kafka or ZooKeeper clusters in response to changes to the corresponding <code>Kafka</code> resource.
This enables you to plan when to apply changes to a <code>Kafka</code> resource to minimize the impact on Kafka client applications.</p>
</div>
<div class="paragraph">
<p>However, some updates to your Kafka and ZooKeeper clusters can happen without any corresponding change to the <code>Kafka</code> resource.
For example, the Cluster Operator will need to perform a rolling restart if a CA (certificate authority) certificate that it manages is close to expiry.</p>
</div>
<div class="paragraph">
<p>While a rolling restart of the pods should not affect <em>availability</em> of the service (assuming correct broker and topic configurations), it could affect <em>performance</em> of the Kafka client applications.
Maintenance time windows allow you to schedule such spontaneous rolling updates of your Kafka and ZooKeeper clusters to start at a convenient time.
If maintenance time windows are not configured for a cluster then it is possible that such spontaneous rolling updates will happen at an inconvenient time, such as during a predictable period of high load.</p>
</div>
</div>
<div class="sect3">
<h4 id="con-maintenance-time-window-definition-str"><a class="link" href="#con-maintenance-time-window-definition-str">25.5.2. Maintenance time window definition</a></h4>
<div class="paragraph">
<p>You configure maintenance time windows by entering an array of strings in the <code>Kafka.spec.maintenanceTimeWindows</code> property.
Each string is a <a href="http://www.quartz-scheduler.org/documentation/quartz-2.3.0/tutorials/tutorial-lesson-06.html" target="_blank" rel="noopener">cron expression</a> interpreted as being in UTC (Coordinated Universal Time, which for practical purposes is the same as Greenwich Mean Time).</p>
</div>
<div class="paragraph">
<p>The following example configures a single maintenance time window that starts at midnight and ends at 01:59am (UTC), on Sundays, Mondays, Tuesdays, Wednesdays, and Thursdays:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
maintenanceTimeWindows:
  - "* * 0-1 ? * SUN,MON,TUE,WED,THU *"
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>In practice, maintenance windows should be set in conjunction with the <code>Kafka.spec.clusterCa.renewalDays</code> and <code>Kafka.spec.clientsCa.renewalDays</code> properties of the <code>Kafka</code> resource, to ensure that the necessary CA certificate renewal can be completed in the configured maintenance time windows.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Strimzi does not schedule maintenance operations exactly according to the given windows. Instead, for each reconciliation, it checks whether a maintenance window is currently "open".
This means that the start of maintenance operations within a given time window can be delayed by up to the Cluster Operator reconciliation interval.
Maintenance time windows must therefore be at least this long.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="proc-configuring-maintenance-time-windows-str"><a class="link" href="#proc-configuring-maintenance-time-windows-str">25.5.3. Configuring a maintenance time window</a></h4>
<div class="paragraph">
<p>You can configure a maintenance time window for rolling updates triggered by supported processes.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kubernetes cluster.</p>
</li>
<li>
<p>The Cluster Operator is running.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add or edit the <code>maintenanceTimeWindows</code> property in the <code>Kafka</code> resource.
For example to allow maintenance between 0800 and 1059 and between 1400 and 1559 you would set the <code>maintenanceTimeWindows</code> as shown below:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
  zookeeper:
    # ...
  maintenanceTimeWindows:
    - "* * 8-10 * * ?"
    - "* * 14-15 * * ?"</code></pre>
</div>
</div>
</li>
<li>
<p>Create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#proc-manual-rolling-update-strimzipodset-str">Performing a rolling update using a pod management annotation</a></p>
</li>
<li>
<p><a href="#proc-manual-rolling-update-pods-str">Performing a rolling update using a pod annotation</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-drain-cleaner-str"><a class="link" href="#assembly-drain-cleaner-str">25.6. Evicting pods with the Strimzi Drain Cleaner</a></h3>
<div class="paragraph _abstract">
<p>Kafka and ZooKeeper pods might be evicted during Kubernetes upgrades, maintenance, or pod rescheduling.
If your Kafka broker and ZooKeeper pods were deployed by Strimzi, you can use the Strimzi Drain Cleaner tool to handle the pod evictions.
The Strimzi Drain Cleaner handles the eviction instead of Kubernetes.
You must set the <code>podDisruptionBudget</code> for your Kafka deployment to <code>0</code> (zero).
Kubernetes will then no longer be allowed to evict the pod automatically.</p>
</div>
<div class="paragraph">
<p>By deploying the Strimzi Drain Cleaner, you can use the Cluster Operator to move Kafka pods instead of Kubernetes.
The Cluster Operator ensures that topics are never under-replicated.
Kafka can remain operational during the eviction process.
The Cluster Operator waits for topics to synchronize, as the Kubernetes worker nodes drain consecutively.</p>
</div>
<div class="paragraph">
<p>An admission webhook notifies the Strimzi Drain Cleaner of pod eviction requests to the Kubernetes API.
The Strimzi Drain Cleaner then adds a rolling update annotation to the pods to be drained.
This informs the Cluster Operator to perform a rolling update of an evicted pod.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are not using the Strimzi Drain Cleaner, you can <a href="#proc-manual-rolling-update-pods-str">add pod annotations to perform rolling updates manually</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Webhook configuration</div>
<p>The Strimzi Drain Cleaner deployment files include a <code>ValidatingWebhookConfiguration</code> resource file.
The resource provides the configuration for registering the webhook with the Kubernetes API.</p>
</div>
<div class="paragraph">
<p>The configuration defines the <code>rules</code> for the Kubernetes API to follow in the event of a pod eviction request.
The rules specify that only <code>CREATE</code> operations related to <code>pods/eviction</code> sub-resources are intercepted.
If these rules are met, the API forwards the notification.</p>
</div>
<div class="paragraph">
<p>The <code>clientConfig</code> points to the Strimzi Drain Cleaner service and <code>/drainer</code> endpoint that exposes the webhook.
The webhook uses a secure TLS connection, which requires authentication.
The <code>caBundle</code> property specifies the certificate chain to validate HTTPS communication.
Certificates are encoded in Base64.</p>
</div>
<div class="listingblock">
<div class="title">Webhook configuration for pod eviction notifications</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
# ...
webhooks:
  - name: strimzi-drain-cleaner.strimzi.io
    rules:
      - apiGroups:   [""]
        apiVersions: ["v1"]
        operations:  ["CREATE"]
        resources:   ["pods/eviction"]
        scope:       "Namespaced"
    clientConfig:
      service:
        namespace: "strimzi-drain-cleaner"
        name: "strimzi-drain-cleaner"
        path: /drainer
        port: 443
        caBundle: Cg==
    # ...</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="drain-cleaner-prereqs-str"><a class="link" href="#drain-cleaner-prereqs-str">25.6.1. Downloading the Strimzi Drain Cleaner deployment files</a></h4>
<div class="paragraph">
<p>To deploy and use the Strimzi Drain Cleaner, you need to download the deployment files.</p>
</div>
<div class="paragraph">
<p>The Strimzi Drain Cleaner deployment files are available from the <a href="https://github.com/strimzi/strimzi-kafka-operator/releases" target="_blank" rel="noopener">GitHub releases page</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="proc-drain-cleaner-deploying-str"><a class="link" href="#proc-drain-cleaner-deploying-str">25.6.2. Deploying the Strimzi Drain Cleaner using installation files</a></h4>
<div class="paragraph _abstract">
<p>Deploy the Strimzi Drain Cleaner to the Kubernetes cluster where the Cluster Operator and Kafka cluster are running.</p>
</div>
<div class="paragraph">
<p>Strimzi sets a default <code>PodDisruptionBudget</code> (PDB) that allows only one Kafka or ZooKeeper pod to be unavailable at any given time.
To use the Drain Cleaner for planned maintenance or upgrades, you must set a PDB of zero.
This is to prevent voluntary evictions of pods, and ensure that the Kafka or ZooKeeper cluster remains available.
You do this by setting the <code>maxUnavailable</code> value to zero in the <code>Kafka</code> or <code>ZooKeeper</code> template.
<code>StrimziPodSet</code> custom resources manage Kafka and ZooKeeper pods using a custom controller that cannot use the <code>maxUnavailable</code> value directly.
Instead, the <code>maxUnavailable</code> value is converted to a <code>minAvailable</code> value.
For example, if there are three broker pods and the <code>maxUnavailable</code> property is set to <code>0</code> (zero), the <code>minAvailable</code> setting is <code>3</code>, requiring all three broker pods to be available and allowing zero pods to be unavailable.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have <a href="#drain-cleaner-prereqs-str">downloaded the Strimzi Drain Cleaner deployment files</a>.</p>
</li>
<li>
<p>You have a highly available Kafka cluster deployment running with Kubernetes worker nodes that you would like to update.</p>
</li>
<li>
<p>Topics are replicated for high availability.</p>
<div class="paragraph">
<p>Topic configuration specifies a replication factor of at least 3 and a minimum number of in-sync replicas to 1 less than the replication factor.</p>
</div>
<div class="listingblock">
<div class="title">Kafka topic replicated for high availability</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: my-topic
  labels:
    strimzi.io/cluster: my-cluster
spec:
  partitions: 1
  replicas: 3
  config:
    # ...
    min.insync.replicas: 2
    # ...</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Excluding Kafka or ZooKeeper</div>
<p>If you don&#8217;t want to include Kafka or ZooKeeper pods in Drain Cleaner operations, change the default environment variables in the Drain Cleaner <code>Deployment</code> configuration file.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set <code>STRIMZI_DRAIN_KAFKA</code> to <code>false</code> to exclude Kafka pods</p>
</li>
<li>
<p>Set <code>STRIMZI_DRAIN_ZOOKEEPER</code> to <code>false</code> to exclude ZooKeeper pods</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example configuration to exclude ZooKeeper pods</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
spec:
  # ...
  template:
    spec:
      serviceAccountName: strimzi-drain-cleaner
      containers:
        - name: strimzi-drain-cleaner
          # ...
          env:
            - name: STRIMZI_DRAIN_KAFKA
              value: "true"
            - name: STRIMZI_DRAIN_ZOOKEEPER
              value: "false"
          # ...</code></pre>
</div>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Set <code>maxUnavailable</code> to <code>0</code> (zero) in the Kafka and ZooKeeper sections of the <code>Kafka</code> resource using <code>template</code> settings.</p>
<div class="listingblock">
<div class="title">Specifying a pod disruption budget</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
  namespace: myproject
spec:
  kafka:
    template:
      podDisruptionBudget:
        maxUnavailable: 0

  # ...
  zookeeper:
    template:
      podDisruptionBudget:
        maxUnavailable: 0
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This setting prevents the automatic eviction of pods in case of planned disruptions,
leaving the Strimzi Drain Cleaner and Cluster Operator to roll the pods on different worker nodes.</p>
</div>
<div class="paragraph">
<p>Add the same configuration for ZooKeeper if you want to use Strimzi Drain Cleaner to drain ZooKeeper nodes.</p>
</div>
</li>
<li>
<p>Update the <code>Kafka</code> resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f &lt;kafka_configuration_file&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the Strimzi Drain Cleaner.</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>If you are using <code>cert-manager</code> with Kubernetes, apply the resources in the <code>/install/drain-cleaner/certmanager</code> directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f ./install/drain-cleaner/certmanager</code></pre>
</div>
</div>
<div class="paragraph">
<p>The TLS certificates for the webhook are generated automatically and injected into the webhook configuration.</p>
</div>
</li>
<li>
<p>If you are not using <code>cert-manager</code> with Kubernetes, do the following:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><a href="#proc-drain-cleaner-certs-str">Add TLS certificates to use in the deployment</a>.</p>
<div class="paragraph">
<p>Any certificates you add must be renewed before they expire.</p>
</div>
</li>
<li>
<p>Apply the resources in the <code>/install/drain-cleaner/kubernetes</code> directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f ./install/drain-cleaner/kubernetes</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>To run the Drain Cleaner on OpenShift, apply the resources in the <code>/install/drain-cleaner/openshift</code> directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f ./install/drain-cleaner/openshift</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="deploying-drain-cleaner-helm-chart-str"><a class="link" href="#deploying-drain-cleaner-helm-chart-str">25.6.3. Deploying the Strimzi Drain Cleaner using Helm</a></h4>
<div class="paragraph _abstract">
<p><a href="https://helm.sh/">Helm</a> charts are used to package, configure, and deploy Kubernetes resources.
Strimzi provides a Helm chart to deploy the Strimzi Drain Cleaner.</p>
</div>
<div class="paragraph">
<p>The Drain Cleaner is deployed on the Kubernetes cluster with the default chart configuration, which assumes that <code>cert-manager</code> issues the TLS certificates required by the Drain Cleaner.</p>
</div>
<div class="paragraph">
<p>You can install the Drain Cleaner with <code>cert-manager</code> support or provide your own TLS certificates.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Helm client must be installed on a local machine.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Default configuration values</div>
<p>Default configuration values are passed into the chart using parameters defined in a <code>values.yaml</code> file.
If you don&#8217;t want to use the default configuration, you can override the defaults when you install the chart using the <code>--set</code> argument.
You specify values in the format <code>--set key=value[,key=value]</code>.
The <code>values.yaml</code> file supplied with the Helm deployment files describes the available configuration parameters, including those shown in the following table.</p>
</div>
<div class="paragraph">
<p>You can override the default image settings.
You can also set <code>secret.create</code> as <code>true</code> and add your own TLS certificates instead of using <code>cert-manager</code> to generate the certificates.
For information on using OpenSSL to generate certificates, see <a href="#proc-drain-cleaner-certs-str">Adding or renewing the TLS certificates used by the Strimzi Drain Cleaner</a>.</p>
</div>
<div class="paragraph">
<p>Any certificates you add must be renewed before they expire.
You can use the configuration to control how certificates are watched for updates using environment variables.
For more information on how the environment variables work, see <a href="#proc-drain-cleaner-certs-renewing-str">Watching the TLS certificates used by the Strimzi Drain Cleaner</a>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 42. Chart configuration options</caption>
<colgroup>
<col style="width: 45.4545%;">
<col style="width: 36.3636%;">
<col style="width: 18.1819%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>replicaCount</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of replicas of the Drain Cleaner webhook</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>image.registry</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Drain Cleaner image registry</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>quay.io</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>image.repository</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Drain Cleaner image repository</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>image.name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Drain Cleaner image name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>drain-cleaner</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>image.tag</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Drain Cleaner image tag</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>latest</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>image.imagePullPolicy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Image pull policy for all pods deployed by the Drain Cleaner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nil</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>secret.create</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set to <code>true</code> and add certificates when not using <code>cert-manager</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>namespace.name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default namespace for the Drain Cleaner deployment.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-drain-cleaner</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resources</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures resources for the Drain Cleaner pod</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[]</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nodeSelector</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add a node selector to the Drain Cleaner pod</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tolerations</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add tolerations to the Drain Cleaner pod</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[]</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>topologySpreadConstraints</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add topology spread constraints to the Drain Cleaner pod</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>affinity</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add affinities to the Drain Cleaner pod</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{}</code></p></td>
</tr>
</tbody>
</table>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy the Drain Cleaner:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">helm install strimzi-drain-cleaner oci://quay.io/strimzi-helm/strimzi-drain-cleaner</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can use parameter values to install a specific version of the Drain Cleaner or specify any changes to the default configuration.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration that installs a specific version of the Drain Cleaner and changes the number of replicas</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">helm install strimzi-drain-cleaner --set replicaCount=2 --version 1.0.0 oci://quay.io/strimzi-helm/strimzi-drain-cleaner</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the Drain Cleaner has been deployed successfully:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">helm ls</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-drain-cleaner-using-str"><a class="link" href="#proc-drain-cleaner-using-str">25.6.4. Using the Strimzi Drain Cleaner</a></h4>
<div class="paragraph _abstract">
<p>Use the Strimzi Drain Cleaner in combination with the Cluster Operator to move Kafka broker or ZooKeeper pods from nodes that are being drained.
When you run the Strimzi Drain Cleaner, it annotates pods with a rolling update pod annotation.
The Cluster Operator performs rolling updates based on the annotation.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have <a href="#proc-drain-cleaner-deploying-str">deployed the Strimzi Drain Cleaner</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Drain a specified Kubernetes node hosting the Kafka broker or ZooKeeper pods.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get nodes
kubectl drain <em>&lt;name-of-node&gt;</em> --delete-emptydir-data --ignore-daemonsets --timeout=6000s --force</code></pre>
</div>
</div>
</li>
<li>
<p>Check the eviction events in the Strimzi Drain Cleaner log to verify that the pods have been annotated for restart.</p>
<div class="listingblock">
<div class="title">Strimzi Drain Cleaner log show annotations of pods</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">INFO ... Received eviction webhook for Pod my-cluster-zookeeper-2 in namespace my-project
INFO ... Pod my-cluster-zookeeper-2 in namespace my-project will be annotated for restart
INFO ... Pod my-cluster-zookeeper-2 in namespace my-project found and annotated for restart

INFO ... Received eviction webhook for Pod my-cluster-kafka-0 in namespace my-project
INFO ... Pod my-cluster-kafka-0 in namespace my-project will be annotated for restart
INFO ... Pod my-cluster-kafka-0 in namespace my-project found and annotated for restart</code></pre>
</div>
</div>
</li>
<li>
<p>Check the reconciliation events in the Cluster Operator log to verify the rolling updates.</p>
<div class="listingblock">
<div class="title">Cluster Operator log shows rolling updates</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">INFO  PodOperator:68 - Reconciliation #13(timer) Kafka(my-project/my-cluster): Rolling Pod my-cluster-zookeeper-2
INFO  PodOperator:68 - Reconciliation #13(timer) Kafka(my-project/my-cluster): Rolling Pod my-cluster-kafka-0
INFO  AbstractOperator:500 - Reconciliation #13(timer) Kafka(my-project/my-cluster): reconciled</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-drain-cleaner-certs-str"><a class="link" href="#proc-drain-cleaner-certs-str">25.6.5. Adding or renewing the TLS certificates used by the Strimzi Drain Cleaner</a></h4>
<div class="paragraph _abstract">
<p>The Drain Cleaner uses a webhook to receive eviction notifications from the Kubernetes API.
The webhook uses a secure TLS connection and authenticates using TLS certificates.
If you are not deploying the Drain Cleaner using the <code>cert-manager</code> or on Openshift, you must create and renew the TLS certificates.
You must then add them to the files used to deploy the Drain Cleaner.
The certificates must also be renewed before they expire.
To renew the certificates, you repeat the steps used to generate and add the certificates to the initial deployment of the Drain Cleaner.</p>
</div>
<div class="paragraph">
<p>Generate and add certificates to the standard installation files or your Helm configuration when deploying the Drain Cleaner on Kubernetes without <code>cert-manager</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using <code>cert-manager</code> to deploy the Drain Cleaner, you don&#8217;t need to add or renew TLS certificates. The same applies when deploying the Drain Cleaner on OpenShift, as OpenShift injects the certificates. In both cases, TLS certificates are added and renewed automatically.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The <a href="https://www.openssl.org/">OpenSSL</a> TLS management tool for generating certificates.</p>
<div class="paragraph">
<p>Use <code>openssl help</code> for command-line descriptions of the options used.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Generating and renewing TLS certificates</div>
<ol class="arabic">
<li>
<p>From the command line, create a directory called <code>tls-certificate</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">mkdir tls-certificate
cd tls-certificate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now use OpenSSL to create the certificates in the <code>tls-certificate</code> directory.</p>
</div>
</li>
<li>
<p>Generate a CA (Certificate Authority) public certificate and private key:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">openssl req -nodes -new -x509 -keyout ca.key -out ca.crt -subj "/CN=Strimzi Drain Cleaner CA"</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>ca.crt</code> and <code>ca.key</code> file are created.</p>
</div>
</li>
<li>
<p>Generate a private key for the Drain Cleaner:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">openssl genrsa -out tls.key 2048</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>tls.key</code> file is created.</p>
</div>
</li>
<li>
<p>Generate a CSR (Certificate Signing Request) and sign it by adding the CA public certificate (<code>ca.crt</code>) you generated:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">openssl req -new -key tls.key -subj "/CN=strimzi-drain-cleaner.strimzi-drain-cleaner.svc" \
  | openssl x509 -req -CA ca.crt -CAkey ca.key -CAcreateserial -extfile &lt;(printf "subjectAltName=DNS:strimzi-drain-cleaner.strimzi-drain-cleaner.svc") -out tls.crt</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>tls.crt</code> file is created.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you change the name of the Strimzi Drain Cleaner service or install it into a different namespace, you must change the SAN (Subject Alternative Name) of the certificate, following the format <code>&lt;service_name&gt;.&lt;namespace_name&gt;.svc</code>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Encode the CA public certificate into base64.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">base64 tls-certificate/ca.crt</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the certificates generated, add them to the installation files or to your Helm configuration depending on your deployment method.</p>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Adding the TLS certificates to the Drain Cleaner installation files</div>
<ol class="arabic">
<li>
<p>Copy the base64-encoded CA public certificate as the value for the <code>caBundle</code> property of the <code>070-ValidatingWebhookConfiguration.yaml</code> installation file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
clientConfig:
  service:
    namespace: "strimzi-drain-cleaner"
    name: "strimzi-drain-cleaner"
    path: /drainer
    port: 443
  caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0...
# ...</code></pre>
</div>
</div>
</li>
<li>
<p>Create a namespace called <code>strimzi-drain-cleaner</code> in your Kubernetes cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create ns strimzi-drain-cleaner</code></pre>
</div>
</div>
</li>
<li>
<p>Create a secret named <code>strimzi-drain-cleaner</code> with the <code>tls.crt</code> and <code>tls.key</code> files you generated:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create secret tls strimzi-drain-cleaner \
  -n strimzi-drain-cleaner  \
  --cert=tls-certificate/tls.crt \
  --key=tls-certificate/tls.key</code></pre>
</div>
</div>
<div class="paragraph">
<p>The secret is used in the Drain Cleaner deployment.</p>
</div>
<div class="listingblock">
<div class="title">Example secret for the Drain Cleaner deployment</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  # ...
  name: strimzi-drain-cleaner
  namespace: strimzi-drain-cleaner
# ...
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS...
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLR...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now use the certificates and updated installation files <a href="#proc-drain-cleaner-deploying-str">to deploy the Drain Cleaner using installation files</a>.</p>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Adding the TLS certificates to a Helm deployment</div>
<ol class="arabic">
<li>
<p>Edit the <code>values.yaml</code> configuration file used in the Helm deployment.</p>
</li>
<li>
<p>Set the <code>certManager.create</code> parameter to <code>false</code>.</p>
</li>
<li>
<p>Set the <code>secret.create</code> parameter to <code>true</code>.</p>
</li>
<li>
<p>Copy the certificates as <code>secret</code> parameters.</p>
<div class="listingblock">
<div class="title">Example secret configuration for the Drain Cleaner deployment</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
certManager:
  create: false

secret:
  create: true
  tls_crt: "Cg==" # <b class="conum">(1)</b>
  tls_key: "Cg==" # <b class="conum">(2)</b>
  ca_bundle: "Cg==" # <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The public key (<code>tls.crt</code>) signed by the CA public certificate.</p>
</li>
<li>
<p>The private key (<code>tls.key</code>).</p>
</li>
<li>
<p>The base-64 encoded CA public certificate (<code>ca.crt</code>).</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can now use the certificates and updated configuration file <a href="#deploying-cluster-operator-helm-chart-str">to deploy the Drain Cleaner using Helm</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="proc-drain-cleaner-certs-renewing-str"><a class="link" href="#proc-drain-cleaner-certs-renewing-str">25.6.6. Watching the TLS certificates used by the Strimzi Drain Cleaner</a></h4>
<div class="paragraph _abstract">
<p>By default, the Drain Cleaner deployment watches the secret containing the TLS certificates its uses for authentication.
The Drain Cleaner watches for changes, such as certificate renewals.
If it detects a change, it restarts to reload the TLS certificates.
The Drain Cleaner installation files enable this behavior by default.
But you can disable the watching of certificates by setting the <code>STRIMZI_CERTIFICATE_WATCH_ENABLED</code> environment variable to <code>false</code> in the <code>Deployment</code> configuration (<code>060-Deployment.yaml</code>) of the Drain Cleaner installation files.</p>
</div>
<div class="paragraph">
<p>With <code>STRIMZI_CERTIFICATE_WATCH_ENABLED</code> enabled, you can also use the following environment variables for watching TLS certificates.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 43. Drain Cleaner environment variables for watching TLS certificates</caption>
<colgroup>
<col style="width: 45.4545%;">
<col style="width: 36.3636%;">
<col style="width: 18.1819%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Environment Variable</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>STRIMZI_CERTIFICATE_WATCH_ENABLED</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables or disables the certificate watch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>STRIMZI_CERTIFICATE_WATCH_NAMESPACE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The namespace where the Drain Cleaner is deployed and where the certificate secret exists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-drain-cleaner</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>STRIMZI_CERTIFICATE_WATCH_POD_NAME</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Drain Cleaner pod name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>STRIMZI_CERTIFICATE_WATCH_SECRET_NAME</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the secret containing TLS certificates</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-drain-cleaner</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>STRIMZI_CERTIFICATE_WATCH_SECRET_KEYS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The list of fields inside the secret that contain the TLS certificates</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tls.crt, tls.key</code></p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example environment variable configuration to control watch operations</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: strimzi-drain-cleaner
  labels:
    app: strimzi-drain-cleaner
  namespace: strimzi-drain-cleaner
spec:
  # ...
    spec:
      serviceAccountName: strimzi-drain-cleaner
      containers:
        - name: strimzi-drain-cleaner
          # ...
          env:
            - name: STRIMZI_DRAIN_KAFKA
              value: "true"
            - name: STRIMZI_DRAIN_ZOOKEEPER
              value: "true"
            - name: STRIMZI_CERTIFICATE_WATCH_ENABLED
              value: "true"
            - name: STRIMZI_CERTIFICATE_WATCH_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: STRIMZI_CERTIFICATE_WATCH_POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
              # ...</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Use the <a href="https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/#the-downward-api" target="_blank" rel="noopener">Downward API</a> mechanism to configure <code>STRIMZI_CERTIFICATE_WATCH_NAMESPACE</code> and <code>STRIMZI_CERTIFICATE_WATCH_POD_NAME</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="proc-manual-delete-pod-pvc-kafka-str"><a class="link" href="#proc-manual-delete-pod-pvc-kafka-str">25.7. Deleting Kafka nodes using annotations</a></h3>
<div class="paragraph">
<p>This procedure describes how to delete an existing Kafka node by using a Kubernetes annotation.
Deleting a Kafka node consists of deleting both the <code>Pod</code> on which the Kafka broker is running and the related <code>PersistentVolumeClaim</code> (if the cluster was deployed with persistent storage).
After deletion, the <code>Pod</code> and its related <code>PersistentVolumeClaim</code> are recreated automatically.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Deleting a <code>PersistentVolumeClaim</code> can cause permanent data loss and the availability of your cluster cannot be guaranteed.
The following procedure should only be performed if you have encountered storage issues.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A running Cluster Operator</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Find the name of the <code>Pod</code> that you want to delete.</p>
<div class="paragraph">
<p>Kafka broker pods are named <code>&lt;cluster_name&gt;-kafka-&lt;index_number&gt;</code>, where <code>&lt;index_number&gt;</code> starts at zero and ends at the total number of replicas minus one.
For example, <code>my-cluster-kafka-0</code>.</p>
</div>
</li>
<li>
<p>Use <code>kubectl annotate</code> to annotate the <code>Pod</code> resource in Kubernetes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate pod &lt;cluster_name&gt;-kafka-&lt;index_number&gt; strimzi.io/delete-pod-and-pvc=true</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the next reconciliation, when the annotated pod with the underlying persistent volume claim will be deleted and then recreated.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="proc-manual-delete-pod-pvc-zookeeper-str"><a class="link" href="#proc-manual-delete-pod-pvc-zookeeper-str">25.8. Deleting ZooKeeper nodes using annotations</a></h3>
<div class="paragraph">
<p>This procedure describes how to delete an existing ZooKeeper node by using a Kubernetes annotation.
Deleting a ZooKeeper node consists of deleting both the <code>Pod</code> on which ZooKeeper is running and the related <code>PersistentVolumeClaim</code> (if the cluster was deployed with persistent storage).
After deletion, the <code>Pod</code> and its related <code>PersistentVolumeClaim</code> are recreated automatically.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Deleting a <code>PersistentVolumeClaim</code> can cause permanent data loss and the availability of your cluster cannot be guaranteed.
The following procedure should only be performed if you have encountered storage issues.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A running Cluster Operator</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Find the name of the <code>Pod</code> that you want to delete.</p>
<div class="paragraph">
<p>ZooKeeper pods are named <code>&lt;cluster_name&gt;-zookeeper-&lt;index_number&gt;</code>, where <code>&lt;index_number&gt;</code> starts at zero and ends at the total number of replicas minus one.
For example, <code>my-cluster-zookeeper-0</code>.</p>
</div>
</li>
<li>
<p>Use <code>kubectl annotate</code> to annotate the <code>Pod</code> resource in Kubernetes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate pod &lt;cluster_name&gt;-zookeeper-&lt;index_number&gt; strimzi.io/delete-pod-and-pvc=true</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the next reconciliation, when the annotated pod with the underlying persistent volume claim will be deleted and then recreated.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="assembly-rolling-updates-str"><a class="link" href="#assembly-rolling-updates-str">25.9. Starting rolling updates of Kafka and other operands using annotations</a></h3>
<div class="paragraph">
<p>Strimzi supports the use of annotations to manually trigger a rolling update of Kafka and other operands through the Cluster Operator.
Use annotations to initiate rolling updates of Kafka, Kafka Connect, MirrorMaker 2, and ZooKeeper clusters.</p>
</div>
<div class="paragraph">
<p>Manually performing a rolling update on a specific pod or set of pods is usually only required in exceptional circumstances.
However, rather than deleting the pods directly, if you perform the rolling update through the Cluster Operator you ensure the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The manual deletion of the pod does not conflict with simultaneous Cluster Operator operations, such as deleting other pods in parallel.</p>
</li>
<li>
<p>The Cluster Operator logic handles the Kafka configuration specifications, such as the number of in-sync replicas.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="proc-manual-rolling-update-strimzipodset-str"><a class="link" href="#proc-manual-rolling-update-strimzipodset-str">25.9.1. Performing a rolling update using a pod management annotation</a></h4>
<div class="paragraph _abstract">
<p>This procedure describes how to trigger a rolling update of Kafka, Kafka Connect, MirrorMaker 2, or ZooKeeper clusters.
To trigger the update, you add an annotation to the <code>StrimziPodSet</code> that manages the pods running on the cluster.</p>
</div>
<div class="paragraph">
<div class="title">Prerequisites</div>
<p>To perform a manual rolling update, you need a running Cluster Operator.
The cluster for the component you are updating, whether it&#8217;s Kafka, Kafka Connect, MirrorMaker 2, or ZooKeeper, must also be running.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Find the name of the resource that controls the pods you want to manually update.</p>
<div class="paragraph">
<p>For example, if your Kafka cluster is named <em>my-cluster</em>, the corresponding names are <em>my-cluster-kafka</em> and <em>my-cluster-zookeeper</em>.
For a Kafka Connect cluster named <em>my-connect-cluster</em>, the corresponding name is <em>my-connect-cluster-connect</em>.
And for a MirrorMaker 2 cluster named <em>my-mm2-cluster</em>, the corresponding name is <em>my-mm2-cluster-mirrormaker2</em>.</p>
</div>
</li>
<li>
<p>Use <code>kubectl annotate</code> to annotate the appropriate resource in Kubernetes.</p>
<div class="listingblock">
<div class="title">Annotating a StrimziPodSet</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate strimzipodset &lt;cluster_name&gt;-kafka strimzi.io/manual-rolling-update=true

kubectl annotate strimzipodset &lt;cluster_name&gt;-zookeeper strimzi.io/manual-rolling-update=true

kubectl annotate strimzipodset &lt;cluster_name&gt;-connect strimzi.io/manual-rolling-update=true

kubectl annotate strimzipodset &lt;cluster_name&gt;-mirrormaker2 strimzi.io/manual-rolling-update=true</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the next reconciliation to occur (every two minutes by default).
A rolling update of all pods within the annotated resource is triggered, as long as the annotation was detected by the reconciliation process.
When the rolling update of all the pods is complete, the annotation is automatically removed from the resource.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-manual-rolling-update-pods-str"><a class="link" href="#proc-manual-rolling-update-pods-str">25.9.2. Performing a rolling update using a pod annotation</a></h4>
<div class="paragraph">
<p>This procedure describes how to manually trigger a rolling update of existing Kafka, Kafka Connect, MirrorMaker 2, or ZooKeeper clusters using a Kubernetes <code>Pod</code> annotation.
When multiple pods are annotated, consecutive rolling updates are performed within the same reconciliation run.</p>
</div>
<div class="paragraph">
<div class="title">Prerequisites</div>
<p>To perform a manual rolling update, you need a running Cluster Operator.
The cluster for the component you are updating, whether it&#8217;s Kafka, Kafka Connect, MirrorMaker 2, or ZooKeeper, must also be running.</p>
</div>
<div class="paragraph">
<p>You can perform a rolling update on a Kafka cluster regardless of the topic replication factor used.
But for Kafka to stay operational during the update, you&#8217;ll need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A highly available Kafka cluster deployment running with nodes that you wish to update.</p>
</li>
<li>
<p>Topics replicated for high availability.</p>
<div class="paragraph">
<p>Topic configuration specifies a replication factor of at least 3 and a minimum number of in-sync replicas to 1 less than the replication factor.</p>
</div>
<div class="listingblock">
<div class="title">Kafka topic replicated for high availability</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: my-topic
  labels:
    strimzi.io/cluster: my-cluster
spec:
  partitions: 1
  replicas: 3
  config:
    # ...
    min.insync.replicas: 2
    # ...</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Find the name of the <code>Pod</code> you want to manually update.</p>
<div class="paragraph">
<p>Pod naming conventions are as follows:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>&lt;cluster_name&gt;-kafka-&lt;index_number&gt;</code> for a Kafka cluster</p>
</li>
<li>
<p><code>&lt;cluster_name&gt;-zookeeper-&lt;index_number&gt;</code> for a ZooKeeper cluster</p>
</li>
<li>
<p><code>&lt;cluster_name&gt;-connect-&lt;index_number&gt;</code> for a Kafka Connect cluster</p>
</li>
<li>
<p><code>&lt;cluster_name&gt;-mirrormaker2-&lt;index_number&gt;</code> for a MirrorMaker 2 cluster</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>&lt;index_number&gt;</code> assigned to a pod starts at zero and ends at the total number of replicas minus one.</p>
</div>
</li>
<li>
<p>Use <code>kubectl annotate</code> to annotate the <code>Pod</code> resource in Kubernetes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate pod &lt;cluster_name&gt;-kafka-&lt;index_number&gt; strimzi.io/manual-rolling-update=true

kubectl annotate pod &lt;cluster_name&gt;-zookeeper-&lt;index_number&gt; strimzi.io/manual-rolling-update=true

kubectl annotate pod &lt;cluster_name&gt;-connect-&lt;index_number&gt; strimzi.io/manual-rolling-update=true

kubectl annotate pod &lt;cluster_name&gt;-mirrormaker2-&lt;index_number&gt; strimzi.io/manual-rolling-update=true</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the next reconciliation to occur (every two minutes by default).
A rolling update of the annotated <code>Pod</code> is triggered, as long as the annotation was detected by the reconciliation process.
When the rolling update of a pod is complete, the annotation is automatically removed from the <code>Pod</code>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cluster-recovery-str"><a class="link" href="#cluster-recovery-str">25.10. Recovering a cluster from persistent volumes</a></h3>
<div class="paragraph">
<p>You can recover a Kafka cluster from persistent volumes (PVs) if they are still present.</p>
</div>
<div class="paragraph">
<p>You might want to do this, for example, after:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A namespace was deleted unintentionally</p>
</li>
<li>
<p>A whole Kubernetes cluster is lost, but the PVs remain in the infrastructure</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="namespace-deletion_str"><a class="link" href="#namespace-deletion_str">25.10.1. Recovery from namespace deletion</a></h4>
<div class="paragraph">
<p>Recovery from namespace deletion is possible because of the relationship between persistent volumes and namespaces.
A <code>PersistentVolume</code> (PV) is a storage resource that lives outside of a namespace.
A PV is mounted into a Kafka pod using a <code>PersistentVolumeClaim</code> (PVC), which lives inside a namespace.</p>
</div>
<div class="paragraph">
<p>The reclaim policy for a PV tells a cluster how to act when a namespace is deleted.
If the reclaim policy is set as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Delete</em> (default), PVs are deleted when PVCs are deleted within a namespace</p>
</li>
<li>
<p><em>Retain</em>, PVs are not deleted when a namespace is deleted</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To ensure that you can recover from a PV if a namespace is deleted unintentionally, the policy must be reset from <em>Delete</em> to <em>Retain</em> in the PV specification using the <code>persistentVolumeReclaimPolicy</code> property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: v1
kind: PersistentVolume
# ...
spec:
  # ...
  <strong>persistentVolumeReclaimPolicy: Retain</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, PVs can inherit the reclaim policy of an associated storage class.
Storage classes are used for dynamic volume allocation.</p>
</div>
<div class="paragraph">
<p>By configuring the <code>reclaimPolicy</code> property for the storage class, PVs that use the storage class are created with the appropriate reclaim policy.
The storage class is configured for the PV using the <code>storageClassName</code> property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: v1
kind: StorageClass
metadata:
  <strong>name: gp2-retain</strong>
parameters:
  # ...
# ...
<strong>reclaimPolicy: Retain</strong></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: v1
kind: PersistentVolume
# ...
spec:
  # ...
  <strong>storageClassName: gp2-retain</strong></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using <em>Retain</em> as the reclaim policy, but you want to delete an entire cluster, you need to delete the PVs manually.
Otherwise they will not be deleted, and may cause unnecessary expenditure on resources.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="cluster-loss_str"><a class="link" href="#cluster-loss_str">25.10.2. Recovery from loss of a Kubernetes cluster</a></h4>
<div class="paragraph">
<p>When a cluster is lost, you can use the data from disks/volumes to recover the cluster if they were preserved within the infrastructure.
The recovery procedure is the same as with namespace deletion, assuming PVs can be recovered and they were created manually.</p>
</div>
</div>
<div class="sect3">
<h4 id="cluster-recovery-volume_str"><a class="link" href="#cluster-recovery-volume_str">25.10.3. Recovering a deleted cluster from persistent volumes</a></h4>
<div class="paragraph _abstract">
<p>This procedure describes how to recover a deleted cluster from persistent volumes (PVs).</p>
</div>
<div class="paragraph">
<p>In this situation, the Topic Operator identifies that topics exist in Kafka, but the <code>KafkaTopic</code> resources do not exist.</p>
</div>
<div class="paragraph">
<p>When you get to the step to recreate your cluster, you have two options:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use <em>Option 1</em> when you can recover all <code>KafkaTopic</code> resources.</p>
<div class="paragraph">
<p>The <code>KafkaTopic</code> resources must therefore be recovered before the cluster is started so that the corresponding topics are not deleted by the Topic Operator.</p>
</div>
</li>
<li>
<p>Use <em>Option 2</em> when you are unable to recover all <code>KafkaTopic</code> resources.</p>
<div class="paragraph">
<p>In this case, you deploy your cluster without the Topic Operator, delete the Topic Operator topic store metadata, and then redeploy the Kafka cluster with the Topic Operator so it can recreate the <code>KafkaTopic</code> resources from the corresponding topics.</p>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If the Topic Operator is not deployed, you only need to recover the <code>PersistentVolumeClaim</code> (PVC) resources.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Before you begin</div>
<p>In this procedure, it is essential that PVs are mounted into the correct PVC to avoid data corruption.
A <code>volumeName</code> is specified for the PVC and this must match the name of the PV.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#ref-persistent-storage-str">Persistent storage</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The procedure does not include recovery of <code>KafkaUser</code> resources, which must be recreated manually.
If passwords and certificates need to be retained, secrets must be recreated before creating the <code>KafkaUser</code> resources.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Check information on the PVs in the cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pv</code></pre>
</div>
</div>
<div class="paragraph">
<p>Information is presented for PVs with data.</p>
</div>
<div class="paragraph">
<p>Example output showing columns important to this procedure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                                         RECLAIMPOLICY CLAIM
pvc-5e9c5c7f-3317-11ea-a650-06e1eadd9a4c ... Retain ...    myproject/data-my-cluster-zookeeper-1
pvc-5e9cc72d-3317-11ea-97b0-0aef8816c7ea ... Retain ...    myproject/data-my-cluster-zookeeper-0
pvc-5ead43d1-3317-11ea-97b0-0aef8816c7ea ... Retain ...    myproject/data-my-cluster-zookeeper-2
pvc-7e1f67f9-3317-11ea-a650-06e1eadd9a4c ... Retain ...    myproject/data-0-my-cluster-kafka-0
pvc-7e21042e-3317-11ea-9786-02deaf9aa87e ... Retain ...    myproject/data-0-my-cluster-kafka-1
pvc-7e226978-3317-11ea-97b0-0aef8816c7ea ... Retain ...    myproject/data-0-my-cluster-kafka-2</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><em>NAME</em> shows the name of each PV.</p>
</li>
<li>
<p><em>RECLAIM POLICY</em> shows that PVs are <em>retained</em>.</p>
</li>
<li>
<p><em>CLAIM</em> shows the link to the original PVCs.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Recreate the original namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create namespace <em>myproject</em></code></pre>
</div>
</div>
</li>
<li>
<p>Recreate the original PVC resource specifications, linking the PVCs to the appropriate PV:</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: data-0-my-cluster-kafka-0
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: gp2-retain
  volumeMode: Filesystem
  volumeName: <strong>pvc-7e1f67f9-3317-11ea-a650-06e1eadd9a4c</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Edit the PV specifications to delete the <code>claimRef</code> properties that bound the original PVC.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: v1
kind: PersistentVolume
metadata:
  annotations:
    kubernetes.io/createdby: aws-ebs-dynamic-provisioner
    pv.kubernetes.io/bound-by-controller: "yes"
    pv.kubernetes.io/provisioned-by: kubernetes.io/aws-ebs
  creationTimestamp: "&lt;date&gt;"
  finalizers:
  - kubernetes.io/pv-protection
  labels:
    failure-domain.beta.kubernetes.io/region: eu-west-1
    failure-domain.beta.kubernetes.io/zone: eu-west-1c
  name: pvc-7e226978-3317-11ea-97b0-0aef8816c7ea
  resourceVersion: "39431"
  selfLink: /api/v1/persistentvolumes/pvc-7e226978-3317-11ea-97b0-0aef8816c7ea
  uid: 7efe6b0d-3317-11ea-a650-06e1eadd9a4c
spec:
  accessModes:
  - ReadWriteOnce
  awsElasticBlockStore:
    fsType: xfs
    volumeID: aws://eu-west-1c/vol-09db3141656d1c258
  capacity:
    storage: 100Gi
  <strong>claimRef:</strong>
    <strong>apiVersion: v1</strong>
    <strong>kind: PersistentVolumeClaim</strong>
    <strong>name: data-0-my-cluster-kafka-2</strong>
    <strong>namespace: myproject</strong>
    <strong>resourceVersion: "39113"</strong>
    <strong>uid: 54be1c60-3319-11ea-97b0-0aef8816c7ea</strong>
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: failure-domain.beta.kubernetes.io/zone
          operator: In
          values:
          - eu-west-1c
        - key: failure-domain.beta.kubernetes.io/region
          operator: In
          values:
          - eu-west-1
  persistentVolumeReclaimPolicy: Retain
  storageClassName: gp2-retain
  volumeMode: Filesystem</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example, the following properties are deleted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">claimRef:
  apiVersion: v1
  kind: PersistentVolumeClaim
  name: data-0-my-cluster-kafka-2
  namespace: myproject
  resourceVersion: "39113"
  uid: 54be1c60-3319-11ea-97b0-0aef8816c7ea</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the Cluster Operator.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/cluster-operator -n <em>my-project</em></code></pre>
</div>
</div>
</li>
<li>
<p>Recreate your cluster.</p>
<div class="paragraph">
<p>Follow the steps depending on whether or not you have all the <code>KafkaTopic</code> resources needed to recreate your cluster.</p>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><strong><em>Option 1</em></strong>: If you have <strong>all</strong> the <code>KafkaTopic</code> resources that existed before you lost your cluster, including internal topics such as committed offsets from <code>__consumer_offsets</code>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Recreate all <code>KafkaTopic</code> resources.</p>
<div class="paragraph">
<p>It is essential that you recreate the resources before deploying the cluster, or the Topic Operator will delete the topics.</p>
</div>
</li>
<li>
<p>Deploy the Kafka cluster.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>kafka.yaml</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><strong><em>Option 2</em></strong>: If you do not have all the <code>KafkaTopic</code> resources that existed before you lost your cluster:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Deploy the Kafka cluster, as with the first option, but without the Topic Operator by removing the <code>topicOperator</code> property from the Kafka resource before deploying.</p>
<div class="paragraph">
<p>If you include the Topic Operator in the deployment, the Topic Operator will delete all the topics.</p>
</div>
</li>
<li>
<p>Delete the internal topic store topics from the Kafka cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl run kafka-admin -ti --image=quay.io/strimzi/kafka:0.39.0-kafka-3.6.1 --rm=true --restart=Never -- ./bin/kafka-topics.sh --bootstrap-server localhost:9092 --topic __strimzi-topic-operator-kstreams-topic-store-changelog --delete &amp;&amp; ./bin/kafka-topics.sh --bootstrap-server localhost:9092 --topic __strimzi_store_topic --delete</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command must correspond to the type of listener and authentication used to access the Kafka cluster.</p>
</div>
</li>
<li>
<p>Enable the Topic Operator by redeploying the Kafka cluster with the <code>topicOperator</code> property to recreate the <code>KafkaTopic</code> resources.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  #...
  entityOperator:
    <strong>topicOperator: {}</strong> <b class="conum">(1)</b>
    #...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Here we show the default configuration, which has no additional properties.
You specify the required configuration using the properties described in the <a href="./configuring.html#type-EntityTopicOperatorSpec-reference" target="_blank" rel="noopener"><code>EntityTopicOperatorSpec</code> schema reference</a>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Verify the recovery by listing the <code>KafkaTopic</code> resources:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get KafkaTopic</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-uninstalling-str"><a class="link" href="#assembly-uninstalling-str">25.11. Uninstalling Strimzi</a></h3>
<div class="paragraph _abstract">
<p>You can uninstall Strimzi using the CLI or by unsubscribing from OperatorHub.io.</p>
</div>
<div class="paragraph">
<p>Use the same approach you used to install Strimzi.</p>
</div>
<div class="paragraph">
<p>When you uninstall Strimzi, you will need to identify resources created specifically for a deployment and referenced from the Strimzi resource.</p>
</div>
<div class="paragraph">
<p>Such resources include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Secrets (Custom CAs and certificates, Kafka Connect secrets, and other Kafka secrets)</p>
</li>
<li>
<p>Logging <code>ConfigMaps</code> (of type <code>external</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are resources referenced by <code>Kafka</code>, <code>KafkaConnect</code>, <code>KafkaMirrorMaker</code>, or <code>KafkaBridge</code> configuration.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Deleting CRDs and related custom resources</strong></p>
</div>
<div class="paragraph">
<p>When a <code>CustomResourceDefinition</code> is deleted, custom resources of that type are also deleted.
This includes the <code>Kafka</code>, <code>KafkaConnect</code>, <code>KafkaMirrorMaker</code>, and <code>KafkaBridge</code> resources managed by Strimzi, as well as the <code>StrimziPodSet</code> resource Strimzi uses to manage the pods of the Kafka components.
In addition, any Kubernetes resources created by these custom resources, such as <code>Deployment</code>, <code>Pod</code>, <code>Service</code>, and <code>ConfigMap</code> resources, are also removed.
Always exercise caution when deleting these resources to avoid unintended data loss.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="uninstalling-str"><a class="link" href="#uninstalling-str">25.11.1. Uninstalling Strimzi using the CLI</a></h4>
<div class="paragraph _abstract">
<p>This procedure describes how to use the <code>kubectl</code> command-line tool to uninstall Strimzi and remove resources related to the deployment.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Access to a Kubernetes cluster using an account with <code>cluster-admin</code> or <code>strimzi-admin</code> permissions.</p>
</li>
<li>
<p>You have identified the resources to be deleted.</p>
<div class="paragraph">
<p>You can use the following <code>kubectl</code> CLI command to find resources and also verify that they have been removed when you have uninstalled Strimzi.</p>
</div>
<div class="listingblock">
<div class="title">Command to find resources related to a Strimzi deployment</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get <em>&lt;resource_type&gt;</em> --all-namespaces | grep <em>&lt;kafka_cluster_name&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;resource_type&gt;</em> with the type of the resource you are checking, such as <code>secret</code> or <code>configmap</code>.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Delete the Cluster Operator <code>Deployment</code>, related <code>CustomResourceDefinitions</code>, and <code>RBAC</code> resources.</p>
<div class="paragraph">
<p>Specify the installation files used to deploy the Cluster Operator.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl delete -f install/cluster-operator</code></pre>
</div>
</div>
</li>
<li>
<p>Delete the resources you identified in the prerequisites.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl delete <em>&lt;resource_type&gt;</em> <em>&lt;resource_name&gt;</em> -n <em>&lt;namespace&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;resource_type&gt;</em> with the type of resource you are deleting and <em>&lt;resource_name&gt;</em> with the name of the resource.</p>
</div>
<div class="listingblock">
<div class="title">Example to delete a secret</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl delete secret my-cluster-clients-ca-cert -n my-project</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="uninstalling-operator-hub-str"><a class="link" href="#uninstalling-operator-hub-str">25.11.2. Uninstalling Strimzi from OperatorHub.io</a></h4>
<div class="paragraph _abstract">
<p>This procedure describes how to uninstall Strimzi from OperatorHub.io and remove resources related to the deployment.</p>
</div>
<div class="paragraph">
<p>You perform the steps using the <code>kubectl</code> command-line tool.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Access to a Kubernetes cluster using an account with <code>cluster-admin</code> or <code>strimzi-admin</code> permissions.</p>
</li>
<li>
<p>You have identified the resources to be deleted.</p>
<div class="paragraph">
<p>You can use the following <code>kubectl</code> CLI command to find resources and also verify that they have been removed when you have uninstalled Strimzi.</p>
</div>
<div class="listingblock">
<div class="title">Command to find resources related to a Strimzi deployment</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get <em>&lt;resource_type&gt;</em> --all-namespaces | grep <em>&lt;kafka_cluster_name&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;resource_type&gt;</em> with the type of the resource you are checking, such as <code>secret</code> or <code>configmap</code>.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Delete the Strimzi subscription.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl delete subscription strimzi-cluster-operator -n <em>&lt;namespace&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>Delete the cluster service version (CSV).</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl delete csv strimzi-cluster-operator.<em>&lt;version&gt;</em>  -n <em>&lt;namespace&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>Remove related CRDs.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get crd -l app=strimzi -o name | xargs kubectl delete</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-cluster-operator-faqs-str"><a class="link" href="#con-cluster-operator-faqs-str">25.12. Frequently asked questions</a></h3>
<div class="sect3">
<h4 id="questions_related_to_the_cluster_operator"><a class="link" href="#questions_related_to_the_cluster_operator">25.12.1. Questions related to the Cluster Operator</a></h4>
<div class="sect4">
<h5 id="co-faq-admin-privileges_str"><a class="link" href="#co-faq-admin-privileges_str">Why do I need cluster administrator privileges to install Strimzi?</a></h5>
<div class="paragraph">
<p>To install Strimzi, you need to be able to create the following cluster-scoped resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Custom Resource Definitions (CRDs) to instruct Kubernetes about resources that are specific to Strimzi, such as <code>Kafka</code> and <code>KafkaConnect</code></p>
</li>
<li>
<p><code>ClusterRoles</code> and <code>ClusterRoleBindings</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cluster-scoped resources, which are not scoped to a particular Kubernetes namespace, typically require <em>cluster administrator</em> privileges to install.</p>
</div>
<div class="paragraph">
<p>As a cluster administrator, you can inspect all the resources being installed (in the <code>/install/</code> directory) to ensure that the <code>ClusterRoles</code> do not grant unnecessary privileges.</p>
</div>
<div class="paragraph">
<p>After installation, the Cluster Operator runs as a regular <code>Deployment</code>, so any standard (non-admin) Kubernetes user with privileges to access the <code>Deployment</code> can configure it.
The cluster administrator can grant standard users the privileges necessary to manage <code>Kafka</code> custom resources.</p>
</div>
<div class="paragraph">
<p>See also:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#co-faq-cluster-role-bindings_str">Why does the Cluster Operator need to create <code>ClusterRoleBindings</code>?</a></p>
</li>
<li>
<p><a href="#co-faq-standard-users_str">Can standard Kubernetes users create Kafka custom resources?</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="co-faq-cluster-role-bindings_str"><a class="link" href="#co-faq-cluster-role-bindings_str">Why does the Cluster Operator need to create <code>ClusterRoleBindings</code>?</a></h5>
<div class="paragraph">
<p>Kubernetes has built-in <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping" target="_blank" rel="noopener">privilege escalation prevention</a>,
which means that the Cluster Operator cannot grant privileges it does not have itself, specifically, it cannot grant such privileges in a namespace it cannot access.
Therefore, the Cluster Operator must have the privileges necessary for <em>all</em> the components it orchestrates.</p>
</div>
<div class="paragraph">
<p>The Cluster Operator needs to be able to grant access so that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Topic Operator can manage  <code>KafkaTopics</code>, by creating <code>Roles</code> and <code>RoleBindings</code> in the namespace that the operator runs in</p>
</li>
<li>
<p>The User Operator can manage <code>KafkaUsers</code>, by creating <code>Roles</code> and <code>RoleBindings</code> in the namespace that the operator runs in</p>
</li>
<li>
<p>The failure domain of a <code>Node</code> is discovered by Strimzi, by creating a <code>ClusterRoleBinding</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When using rack-aware partition assignment, the broker pod needs to be able to get information about the <code>Node</code> it is running on,
for example, the Availability Zone in Amazon AWS.
A <code>Node</code> is a cluster-scoped resource, so access to it can only be granted through a <code>ClusterRoleBinding</code>, not a namespace-scoped <code>RoleBinding</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="co-faq-standard-users_str"><a class="link" href="#co-faq-standard-users_str">Can standard Kubernetes users create Kafka custom resources?</a></h5>
<div class="paragraph">
<p>By default, standard Kubernetes users will not have the privileges necessary to manage the custom resources handled by the Cluster Operator.
The cluster administrator can grant a user the necessary privileges using Kubernetes RBAC resources.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#adding-users-the-strimzi-admin-role-str">Designating Strimzi administrators</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="what_do_the_failed_to_acquire_lock_warnings_in_the_log_mean"><a class="link" href="#what_do_the_failed_to_acquire_lock_warnings_in_the_log_mean">What do the <em>failed to acquire lock</em> warnings in the log mean?</a></h5>
<div class="paragraph">
<p>For each cluster, the Cluster Operator executes only one operation at a time.
The Cluster Operator uses locks to make sure that there are never two parallel operations running for the same cluster.
Other operations must wait until the current operation completes before the lock is released.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">INFO</dt>
<dd>
<p>Examples of cluster operations include <em>cluster creation</em>, <em>rolling update</em>, <em>scale down</em> , and <em>scale up</em>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If the waiting time for the lock takes too long, the operation times out and the following warning message is printed to
the log:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">2018-03-04 17:09:24 WARNING AbstractClusterOperations:290 - Failed to acquire lock for kafka cluster lock::kafka::myproject::my-cluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>Depending on the exact configuration of <code>STRIMZI_FULL_RECONCILIATION_INTERVAL_MS</code> and <code>STRIMZI_OPERATION_TIMEOUT_MS</code>, this
warning message might appear occasionally without indicating any underlying issues.
Operations that time out are picked up in the next periodic reconciliation, so that the operation can acquire the lock and execute again.</p>
</div>
<div class="paragraph">
<p>Should this message appear periodically, even in situations when there should be no other operations running for a given
cluster, it might indicate that the lock was not properly released due to an error.
If this is the case, try restarting the Cluster Operator.</p>
</div>
</div>
<div class="sect4">
<h5 id="why_is_hostname_verification_failing_when_connecting_to_nodeports_using_tls"><a class="link" href="#why_is_hostname_verification_failing_when_connecting_to_nodeports_using_tls">Why is hostname verification failing when connecting to NodePorts using TLS?</a></h5>
<div class="paragraph">
<p>Currently, off-cluster access using NodePorts with TLS encryption enabled does not support TLS hostname verification.
As a result, the clients that verify the hostname will fail to connect.
For example, the Java client will fail with the following exception:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Caused by: java.security.cert.CertificateException: No subject alternative names matching IP address 168.72.15.231 found
 at sun.security.util.HostnameChecker.matchIP(HostnameChecker.java:168)
 at sun.security.util.HostnameChecker.match(HostnameChecker.java:94)
 at sun.security.ssl.X509TrustManagerImpl.checkIdentity(X509TrustManagerImpl.java:455)
 at sun.security.ssl.X509TrustManagerImpl.checkIdentity(X509TrustManagerImpl.java:436)
 at sun.security.ssl.X509TrustManagerImpl.checkTrusted(X509TrustManagerImpl.java:252)
 at sun.security.ssl.X509TrustManagerImpl.checkServerTrusted(X509TrustManagerImpl.java:136)
 at sun.security.ssl.ClientHandshaker.serverCertificate(ClientHandshaker.java:1501)
 ... 17 more</code></pre>
</div>
</div>
<div class="paragraph">
<p>To connect, you must disable hostname verification.
In the Java client, you can do this by setting the configuration option <code>ssl.endpoint.identification.algorithm</code> to an empty string.</p>
</div>
<div class="paragraph">
<p>When configuring the client using a properties file, you can do it this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">ssl.endpoint.identification.algorithm=</code></pre>
</div>
</div>
<div class="paragraph">
<p>When configuring the client directly in Java, set the configuration option to an empty string:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">props.put("ssl.endpoint.identification.algorithm", "");</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-12-20 17:13:30 UTC
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
</body>
</html>